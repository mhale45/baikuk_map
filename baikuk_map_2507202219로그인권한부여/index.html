<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ë°±ì–µì§€ë„ </title>
    <link rel="icon" type="image/png" href="https://github.com/mhale45/image/raw/main/map/%EB%B0%B1%EC%96%B5%20%EC%8B%AC%EB%B3%BC.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f605c7b72dc7f3083f36483e55e2bc77&libraries=clusterer"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --header-height: 50px; --infopanel-left: 450px;}
        body { margin: 0; padding: 0; }
        header { position: fixed; top: 0; left: 0; right: 0; height: var(--header-height); z-index: 10000; background: #fff; }
        #map { position: absolute; top: var(--header-height); left: var(--infopanel-left); right: 0; bottom: 0; z-index: 0; }
        #info-panel { position: absolute; top: var(--header-height); left: 0; width: var(--infopanel-left); bottom: 0; z-index: 50; background: #fff; }
        #detail-panel { position: absolute; top: var(--header-height); left: var(--infopanel-left); width: 500px; bottom: 0; z-index: 9999; border-left: 5px solid #e5e7eb;}
        #filter-bar { display: flex; flex-direction: column; gap: 2px; margin-top: 0; }
    </style>
</head>
<body class="m-0 p-0">
    <!-- í—¤ë”/í•„í„° ë°” -->
    <header class="flex items-center gap-4 w-full h-[50px] px-6 py-4 bg-white shadow-md border-b border-gray-200 fixed top-0 left-0 z-[10000]">
        <img src="https://github.com/mhale45/image/raw/main/map/%EB%B0%B1%EC%96%B5%EA%B3%B5%EC%9D%B8%EC%A4%91%EA%B0%9C%EC%82%AC%EC%82%AC%EB%AC%B4%EC%86%8C%20%EA%B8%80%EC%94%A8%EB%A7%8C.png"
            alt="ê¸€ì”¨ë¡œê³ " class="h-12 w-auto cursor-pointer" onclick="showLogin()" />
        <div class="relative">
            <button id="filter-btn-init" data-default-label="ì´ˆê¸°í™”" onclick="resetFilters()"
                class="ml-[100px] px-3 py-1.5 border border-gray-200 bg-red-100 text-red-600 rounded-md shadow-sm text-sm font-bold hover:bg-red-200 transition">ì´ˆê¸°í™”</button>
        </div>
        <div id="filter-bar" class="flex flex-row gap-2 items-start mt-2 relative z-[1000]">
            <div id="btn-wrap" class="flex flex-row gap-2"></div>
        </div>

        <!-- í•„í„°ë§ë²„íŠ¼ë“¤ -->
        <div id="filter-btns-wrap" class="flex gap-1"></div>

        <div style="flex:1"></div> <!-- ì´ ì¤„ì´ í—¤ë”ì—ì„œ ì˜¤ë¥¸ìª½ ì •ë ¬ ì—­í•  -->

        <!-- í—¤ë” ì˜¤ë¥¸ìª½ì— ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
        <button id="logout-btn"
                onclick="logout()"
                class="hidden text-sm text-gray-600 hover:text-black border px-3 py-1 rounded">
            ë¡œê·¸ì•„ì›ƒ
        </button>

    </header>
    
    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="login-modal"
        class="fixed inset-0 z-[20000] bg-black/40 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-lg p-8 w-80">
            <h2 class="font-bold text-xl mb-4 text-center">ì§ì› ë¡œê·¸ì¸</h2>
            <input id="login-email" type="email" placeholder="ì´ë©”ì¼"
                class="w-full border border-gray-300 rounded px-3 py-2 mb-3" />
            <input id="login-password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"
                class="w-full border border-gray-300 rounded px-3 py-2 mb-4" />
            <button onclick="login()"
                    class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-semibold">
            ë¡œê·¸ì¸
            </button>
            <button onclick="hideLogin()"
                    class="w-full text-gray-500 mt-2">ë‹«ê¸°</button>
            <div id="login-error" class="text-red-600 text-sm mt-2 hidden"></div>
        </div>
    </div>
    <!-- âœ… ë¡œê·¸ì¸ ì¤‘ ë¡œë”© ì˜¤ë²„ë ˆì´ ì¶”ê°€ -->
    <div id="loading-overlay"
        class="fixed inset-0 z-[30000] bg-black bg-opacity-40 flex items-center justify-center hidden">
    <div class="text-white text-xl font-bold">ë¡œê·¸ì¸ ì¤‘ì…ë‹ˆë‹¤...</div>
    </div>
    <div id="map" class="absolute top-0 bottom-0 right-0 left-[340px] z-0 gap-0"></div>
    <!-- ì§€ë„ ìš°ì¸¡ í•˜ë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
    <div id="map-controls" class="fixed z-[11000] flex flex-col items-center bottom-10  right-5">
        <!-- ìƒˆë¡œ ì¶”ê°€í•˜ëŠ” ë²„íŠ¼ (ë§¨ ìœ„) -->
        <button id="btn-naver-map"
            class="w-[40px] h-10 shadow rounded-lg flex items-center justify-center border border-gray-300 bg-[#00de5a] hover:bg-[#00b74a] transition mb-3 text-white text-[50] font-[black]"
            style="text-shadow: 0 1px 2px #ffffff, 0 0 1px #ffffff;"
            title="ë„¤ì´ë²„ì§€ë„">
            N
        </button>
        <!-- í˜„ì¬ìœ„ì¹˜ ë²„íŠ¼ -->
        <button id="btn-current-location"
            class="w-[40px] h-10 shadow rounded-lg flex items-center justify-center border border-gray-300 hover:bg-yellow-200 transition mb-5"
            style="background-color: #ffffff;"
            title="í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™">
            <span class="text-xl text-black font-bold">â—‰</span>
        </button>
        <div class="flex flex-col gap-0">
            <button id="btn-zoom-in"
                class="w-[40px] h-10 shadow rounded-lg flex items-center justify-center border border-gray-300 hover:bg-yellow-200 transition"
                style="background-color: #ffffff;"
                title="í™•ëŒ€">
                <span class="text-2xl text-black font-bold">ï¼‹</span>
            </button>
            <button id="btn-zoom-out"
                class="w-[40px] h-10 shadow rounded-lg flex items-center justify-center border border-gray-300 hover:bg-yellow-200 transition"
                style="background-color: #ffffff;"
                title="ì¶•ì†Œ">
                <span class="text-2xl text-black font-bold">ï¼</span>
            </button>
        </div>
    </div>

    <div id="info-panel" class="absolute top-0 bottom-0 left-0 w-[340px] overflow-y-auto bg-white shadow-xl p-3 text-sm hidden z-50">
        <div id="info-content" class="text-xs text-gray-700"></div>
    </div>

    <!-- âœ… ìƒì„¸ ì •ë³´ íŒ¨ë„ ì¶”ê°€ -->
    <div id="detail-panel" class="absolute top-[70px] left-[340px] w-[400px] bottom-0 bg-white/90 backdrop-blur-sm shadow-xl text-sm hidden z-[1000] overflow-y-auto">
    <div id="detail-content" class="text-gray-800 text-sm whitespace-pre-line overflow-y-auto h-full"></div>
    </div>

    <!-- ë²„íŠ¼ì€ íŒ¨ë„ ë°”ë¡œ ë‹«ê¸° ë²„íŠ¼ -->
    <button 
        id="close-detail-btn"
        onclick="hideDetailPanel()"
        class="fixed z-[1001] w-10 h-10 bg-white text-gray-600 border border-gray-300 hover:border-black hover:text-black shadow-md flex items-center justify-center font-bold text-lg hidden"
        style="top: 60px; left: 949px; display: none;">
        âœ•
    </button>      

  <script>
    const supabaseUrl = 'https://sfinbtiqlfnaaarziixu.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaW5idGlxbGZuYWFhcnppaXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MDkxNjEsImV4cCI6MjA2ODA4NTE2MX0.4-7vnIjbF-biWWuv9-vTxK9Y99gMm-vS6oaRMdRL5fA';
    const client = supabase.createClient(supabaseUrl, supabaseKey);

    const HIGHLIGHT_COLOR = "#F2C130";
    const HIGHLIGHT_TEXT_COLOR = "#111";  // ì„ íƒ ì‹œ í…ìŠ¤íŠ¸ ìƒ‰ìƒ
    const DEFAULT_BTN_BG = "#f3f4f6";     // bg-gray-100
    const DEFAULT_BTN_TEXT = "#374151";   // text-gray-700

    const PAGE_SIZE = 15;
    const allDealTypes = ['ì›”ì„¸', 'ë§¤ë§¤'];
    const allCategories = ['ìƒê°€', 'ê³µì¥Â·ì°½ê³ ']; // ì¹´í…Œê³ ë¦¬ ì¢…ë¥˜ (ê³ ì •)
    const infoPanel = document.getElementById('info-panel');
    const infoContent = document.getElementById('info-content');
    const filterTypes = ['floor','sale','deposit','rent','total_deposit','total_rent','area_py'];

    const filterDefs = [
        { id: 'deposit',   label: 'ë³´ì¦ê¸ˆ',    width: 300 },
        { id: 'rent',      label: 'ì›”ì„¸',      width: 280 },
        { id: 'floor',     label: 'ì¸µ',        width: 280 },
        { id: 'area_py',   label: 'ì „ìš©í‰ìˆ˜',  width: 280 },
        { id: 'sale',      label: 'ë§¤ë§¤ê°€',    width: 300 },
        { id: 'total_deposit', label: 'ì´ë³´ì¦ê¸ˆ', width: 300 },
        { id: 'total_rent', label: 'ì´ì›”ì„¸',   width: 280 },
    ];

    let selectedDealTypes = ['ì›”ì„¸'];
    let selectedCategories = ['ìƒê°€']; // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ (ì—¬ëŸ¬ê°œ ê°€ëŠ¥)
    
    let allListings = {};
    let isLoading = false;  

    let allMarkers = {};
    let map, customImage;   // ì¹´ì¹´ì˜¤ë§µ ê°ì²´
    let clusterer, mapIdleTimer = null;
    let selectedClusterEl = null;  // í´ëŸ¬ìŠ¤í„° ìƒ‰ ë°˜ì „ ìœ„í•¨
    let isLoggedIn = false; // í˜ì´ì§€ ìµœìƒë‹¨ ìŠ¤í¬ë¦½íŠ¸ ì˜ì—­ì— ì„ ì–¸

    map = new kakao.maps.Map(document.getElementById('map'), {
      center: new kakao.maps.LatLng(37.7151, 126.7341),
      level: 3
    });

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            map.setCenter(new kakao.maps.LatLng(lat, lng));
        }, function(error) {
            console.log("ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", error);
        });
    } else {
        console.log("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }

    infoPanel.style.display = 'block';

    clusterer = new kakao.maps.MarkerClusterer({
        map: map,
        averageCenter: true,
        minLevel: 1,
        minClusterSize: 1, // âœ… ë§ˆì»¤ê°€ 1ê°œì—¬ë„ í´ëŸ¬ìŠ¤í„° ì²˜ë¦¬
        disableClickZoom: true,
        gridSize: 30,
        styles: [
            {
                width: '40px',
                height: '40px',
                background: HIGHLIGHT_COLOR,
                border: 'none',
                borderRadius: '50%',
                color: '#fff', // âœ… ê¸€ììƒ‰ í°ìƒ‰ìœ¼ë¡œ ë³€ê²½
                fontWeight: 'bold',
                textAlign: 'center',
                lineHeight: '40px'
            }
            ]
    });


    customImage = new kakao.maps.MarkerImage(
      'https://raw.githubusercontent.com/mhale45/image/2d7ce4379b14d095d2f0b7f1d0057987548a37bf/2.png',
      new kakao.maps.Size(36, 36),
      { offset: new kakao.maps.Point(18, 36) }
    );

    function renderFilterButtons() {
        const wrap = document.getElementById('filter-btns-wrap');
        wrap.innerHTML = '';

        filterDefs.forEach(def => {
            // í•„í„°ë§ ë²„íŠ¼
            const btn = document.createElement('button');
            btn.id = `filter-btn-${def.id}`;
            btn.setAttribute('data-default-label', def.label + ' â–¼');
            btn.className = "px-2 py-2 border border-gray-300 bg-white rounded-md shadow-sm text-[14px] text-gray-800 font-medium hover:bg-gray-100";
            btn.innerText = def.label + ' â–¼';
            btn.onclick = () => toggleFilterPanel(def.id);

            // ë“œë¡­ë‹¤ìš´ íŒ¨ë„
            const panel = document.createElement('div');
            panel.id = `filter-panel-${def.id}`;
            panel.className = "hidden absolute left-0 mt-1 bg-white border rounded shadow z-50";
            panel.style.width = `${def.width}px`;

            const inner = document.createElement('div');
            inner.className = "flex items-center gap-2 p-3";
            inner.innerHTML = `
                <input id="${def.id}_min" type="number" placeholder="ì´ìƒ" class="w-20 px-2 py-1 border rounded text-sm" />
                <span class="text-gray-500">~</span>
                <input id="${def.id}_max" type="number" placeholder="ì´í•˜" class="w-20 px-2 py-1 border rounded text-sm" />
            `;
            panel.appendChild(inner);

            // ë²„íŠ¼ê³¼ íŒ¨ë„ì„ í•˜ë‚˜ì˜ divë¡œ ë¬¶ê¸°
            const box = document.createElement('div');
            box.className = 'relative';
            box.appendChild(btn);
            box.appendChild(panel);

            wrap.appendChild(box);

            // â­â­â­ [ì—¬ê¸°!] ì´ë²¤íŠ¸ ì—°ê²°ì€ DOMì— ì¶”ê°€ëœ ë’¤ì— í•´ì•¼í•¨ â­â­â­
            setTimeout(() => {
                const minInput = document.getElementById(`${def.id}_min`);
                const maxInput = document.getElementById(`${def.id}_max`);
                if (minInput) minInput.addEventListener('input', () => {
                    updateFilterButtonText(def.id);
                    updateFilteredListings();
                });
                if (maxInput) maxInput.addEventListener('input', () => {
                    updateFilterButtonText(def.id);
                    updateFilteredListings();
                });
            }, 0);
        });
    }


    // í´ëŸ¬ìŠ¤í„° ë ˆë²¨ë³„ ë­‰ì³ì§€ê²Œ
    function createClusterer(gridSize) {
        if (clusterer) clusterer.clear();
        clusterer = new kakao.maps.MarkerClusterer({
            map: map,
            averageCenter: true,
            minLevel: 1,
            minClusterSize: 1,
            disableClickZoom: true,
            gridSize: gridSize,
            styles: [
                {
                    width: '40px',
                    height: '40px',
                    background: HIGHLIGHT_COLOR,
                    border: 'none',
                    borderRadius: '50%',
                    color: '#fff',
                    fontWeight: 'bold',
                    textAlign: 'center',
                    lineHeight: '40px'
                }
            ]
        });
        
        // í´ëŸ¬ìŠ¤í„° í´ë¦­ ì‹œ
        kakao.maps.event.addListener(clusterer, 'clusterclick', function(cluster) {
            const clusterOverlay = cluster.getClusterMarker(); // í´ëŸ¬ìŠ¤í„° ë§ˆì»¤ ê°ì²´
            if (selectedClusterEl) {
                selectedClusterEl.style.border = "none";
                selectedClusterEl.style.borderRadius = "50%";
                const prevInner = selectedClusterEl.querySelector('div');
                if (prevInner) {
                    prevInner.style.background = HIGHLIGHT_COLOR; // ì›ë˜ ë°°ê²½
                    prevInner.style.color = "#fff";               // ì›ë˜ ìˆ«ììƒ‰
                }
                selectedClusterEl = null;
            }

            // ìƒˆë¡œ í´ë¦­ëœ í´ëŸ¬ìŠ¤í„° DOM
            const clusterEl = cluster.getClusterMarker().getContent().parentNode;
            if (clusterEl) {
                // ì™¸ê³½ í…Œë‘ë¦¬ë§Œ ë‚¨ê¹€
                clusterEl.style.background = "transparent";
                clusterEl.style.border = "2px solid #F2C130";
                clusterEl.style.borderRadius = "50%";

                // ë‚´ë¶€ ìˆ«ì div ë°°ê²½ í°ìƒ‰ + í…ìŠ¤íŠ¸ ë…¸ë€ìƒ‰
                const inner = clusterEl.querySelector('div');
                if (inner) {
                    inner.style.background = "#ffffff";
                    inner.style.color = "#F2C130";
                    inner.style.borderRadius = "50%";  // í˜¹ì‹œ ë‚´ë¶€ë„ ëª¨ì„œë¦¬ê°€ êº¾ì´ë©´ ì¶”ê°€
                }

                selectedClusterEl = clusterEl;
            }


            // ì¸í¬íŒ¨ë„ ë‚´ìš© í‘œì‹œ
            const markerList = cluster.getMarkers();
            const listings = markerList.map(mk => allListings[mk.listing_id]).filter(Boolean);
            showListingsInPanel(listings);
        });
    }



    function renderDealAndCategoryButtons() {
        const btnWrap = document.getElementById('btn-wrap');
        btnWrap.innerHTML = '';

        // ê±°ë˜ìœ í˜•(ì›”ì„¸, ë§¤ë§¤) ë²„íŠ¼
        allDealTypes.forEach(type => {
            const btn = document.createElement('button');
            btn.textContent = selectedDealTypes.includes(type) ? 'âœ“ ' + type : type;
            btn.className = "px-3 py-2 rounded-full border border-gray-300 text-[13px] font-medium transition mr-0";
            btn.onclick = function() { toggleDealType(type); };
            if (selectedDealTypes.includes(type)) {
                btn.style.backgroundColor = HIGHLIGHT_COLOR;
                btn.style.color = HIGHLIGHT_TEXT_COLOR;
                btn.style.fontWeight = 'bold';
                btn.style.borderColor = "#eab308";
            } else {
                btn.style.backgroundColor = DEFAULT_BTN_BG;
                btn.style.color = DEFAULT_BTN_TEXT;
                btn.style.fontWeight = 'normal';
                btn.style.borderColor = "#d1d5db";
            }
            btnWrap.appendChild(btn);
        });

        // ì¹´í…Œê³ ë¦¬(ìƒê°€, ê³µì¥ì°½ê³ ) ë²„íŠ¼
        allCategories.forEach(cat => {
            const btn = document.createElement('button');
            btn.textContent = selectedCategories.includes(cat) ? 'âœ“ ' + cat : cat;
            btn.className = "px-3 py-2 rounded-full border border-gray-300 text-[13px] font-medium transition mr-0";
            btn.onclick = function () {
                if (selectedCategories.includes(cat)) {
                    selectedCategories = selectedCategories.filter(c => c !== cat);
                } else {
                    selectedCategories.push(cat);
                }
                renderDealAndCategoryButtons();
                updateFilteredListings();
            };
            if (selectedCategories.includes(cat)) {
                btn.style.backgroundColor = HIGHLIGHT_COLOR;
                btn.style.color = HIGHLIGHT_TEXT_COLOR;
                btn.style.fontWeight = 'bold';
                btn.style.borderColor = "#eab308";
            } else {
                btn.style.backgroundColor = DEFAULT_BTN_BG;
                btn.style.color = DEFAULT_BTN_TEXT;
                btn.style.fontWeight = 'normal';
                btn.style.borderColor = "#d1d5db";
            }
            btnWrap.appendChild(btn);
        });
    }

    // ê±°ë˜ìœ í˜• ë²„íŠ¼ í´ë¦­ ì‹œ í•´ë‹¹ ìœ í˜• ì„ íƒ/í•´ì œ ë° UI, ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    function toggleDealType(type) {
        if (selectedDealTypes.includes(type)) {
            if (selectedDealTypes.length > 1) {
                selectedDealTypes = selectedDealTypes.filter(x => x !== type);
            }
        } else {
            selectedDealTypes.push(type);
        }
        renderDealAndCategoryButtons();
        updateFilteredListings();
    }


    // ë§¤ë¬¼ ì¹´ë“œ í´ë¦­ ì‹œ ìƒì„¸ íŒ¨ë„ì„ ì—´ê³  ìƒì„¸ ë‚´ìš©ì„ í‘œì‹œ
    function showDetailPanel(listingId) {
        window.currentDetailListingId = listingId;
        renderMatchedListings(); // â­ í•˜ì´ë¼ì´íŠ¸ ì ìš© ìœ„í•´ ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ë Œë”

        const listing = allListings[listingId];
        if (!listing) return;

        const detailContent = `
            <div class="sticky top-0 z-10 bg-white shadow-sm p-2 rounded transition cursor-pointer whitespace-normal" onclick="showDetailPanel(${listing.listing_id})">
                <div class="flex items-start gap-2">
                    <div class="w-[61px] h-[26px] flex justify-center items-center border-[2px] border-[rgb(242,193,48)] text-[rgb(0,0,0)] px-1 py-0 rounded text-base font-bold">
                        ${listing.listing_id}
                    </div>
                    <div class="flex-1 text-left font-semibold text-[rgb(80,152,233)] text-base translate-y-[-2px] translate-y-[3px] leading-tight">
                        ${listing.deal_type}
                        ${listing.deal_type === "ë§¤ë§¤"
                            ? ` ${formatKoreanMoney(listing.sale_price)}`
                            : listing.deal_type === "ì›”ì„¸"
                            ? ` ${formatKoreanMoney(listing.deposit_price)} / ${formatKoreanMoney(listing.monthly_rent)}`
                            : ""
                        }
                        <span class="text-[13px] text-gray-700 ml-2">
                            ì „ìš© <strong class="font-semibold">${Number(listing.area_py).toFixed(1)}</strong>í‰,
                            <strong class="font-semibold">${formatFloor(listing.floor, listing.floor_type)}</strong>ì¸µ
                        </span>
                    </div>
                </div>
            </div>
            <div class="mb-2 px-4">
                <span class="font-medium whitespace-pre-line">${listing.description}</span>
            </div>
        `;




        const panel = document.getElementById('detail-panel');
        const content = document.getElementById('detail-content');
        const closeBtn = document.getElementById('close-detail-btn');

        // âœ… íŒ¨ë„ ë‚´ìš© ì±„ìš°ê¸°
        content.innerHTML = detailContent;

        // âœ… ìŠ¤í¬ë¡¤ ë§¨ ìœ„ë¡œ ì´ë™
        content.scrollTop = 0;

        // âœ… íŒ¨ë„ ë³´ì´ê¸°
        panel.classList.remove('hidden');
        panel.style.display = 'block';
                
        // âœ… ë²„íŠ¼ë„ ê°™ì´ show
        closeBtn.classList.remove('hidden');
        closeBtn.style.display = 'block';
    }
    
    //ìƒì„¸ íŒ¨ë„ê³¼ ë‹«ê¸° ë²„íŠ¼, ëª¨ë“  í•„í„° íŒ¨ë„ ìˆ¨ê¹€ ì²˜ë¦¬
    function hideDetailPanel() { 
        const detailPanel = document.getElementById('detail-panel');
        const closeBtn = document.getElementById('close-detail-btn');
        detailPanel.classList.add('hidden');
        detailPanel.style.display = 'none';

        // âœ… ë²„íŠ¼ë„ ê°™ì´ hide
        closeBtn.classList.add('hidden');
        closeBtn.style.display = 'none';
        
        // íŒ¨ë„ ì „ë¶€ ë‹«ê¸°
        document.querySelectorAll('[id^="filter-panel-"]').forEach(p => p.classList.add('hidden'));
    }
    
    // ê°€ê²© ìˆ«ìë¥¼ 'ì–µ', 'ë§Œ' ë“± í•œêµ­ì‹ ë‹¨ìœ„ë¡œ í¬ë§·íŒ…
    function formatKoreanMoney(value) {
        if (!value && value !== 0) return '-';
        const num = Number(value);
        if (num >= 10000) {
            const eok = Math.floor(num / 10000);
            const man = num % 10000;
            const manStr = man > 0 ? `${man.toLocaleString()}` : '';
            return `${eok}ì–µ${manStr ? ' ' + manStr : ''}`;
        } else {
            return `${num.toLocaleString()}`;
        }
    }

    // íƒ€ì…(ë§¤ë§¤ê°€, ë³´ì¦ê¸ˆ ë“±)ì— ë”°ë¼ ìˆ«ìë¥¼ 'ì–µ/ë§Œ/í‰/ì¸µ' ë“±ìœ¼ë¡œ ë³´ê¸° ì¢‹ê²Œ í¬ë§·íŒ…
    function formatValue(type, val) {
        if (val === "" || val === undefined || val === null) return '-';
        const num = Number(val);

        // 'ë§Œ' ë‹¨ìœ„(ì–µ, ë§Œ ë³€í™˜)
        if (['sale', 'deposit', 'rent', 'total_deposit', 'total_rent'].includes(type)) {
            if (isNaN(num)) return '-';
            if (num >= 10000) {
                const eok = Math.floor(num / 10000);
                const man = num % 10000;
                const manStr = man > 0 ? `${man.toLocaleString()}` : '';
                return `${eok}ì–µ${manStr ? ' ' + manStr : ''}`;
            } else {
                return num.toLocaleString() + 'ë§Œ';
            }
        }

        // 'ì¸µ', 'ì „ìš©í‰ìˆ˜' ë“± ìˆ«ì + ë‹¨ìœ„ ë¶™ì´ê¸°
        if (['floor', 'area_py'].includes(type)) {
            if (isNaN(num)) return '-';
            return num + filterUnits[type];
        }

        // ë‚˜ë¨¸ì§€ ê·¸ëƒ¥ ë°˜í™˜
        return val;
    }

    //ê° í•„í„° ë²„íŠ¼ì— input ê°’(ìµœì†Œ~ìµœëŒ€ ë“±)ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë˜ë„ë¡ ë¼ë²¨ ì—…ë°ì´íŠ¸ + ê°•ì¡° ìŠ¤íƒ€ì¼ ì ìš©
    function updateFilterButtonText(type) {
        let min = document.getElementById(`${type}_min`)?.value;
        let max = document.getElementById(`${type}_max`)?.value;
        let btn = document.getElementById(`filter-btn-${type}`);
        let label = "";

        if (min && max) label = `${formatValue(type, min)}~${formatValue(type, max)}`;
        else if (min) label = `${formatValue(type, min)}~`;
        else if (max) label = `~${formatValue(type, max)}`;
        else label = btn ? btn.getAttribute('data-default-label') || 'â–¼' : 'â–¼';

        if (btn) {
            btn.textContent = label;
            // ê°•ì¡° ìŠ¤íƒ€ì¼
            if (label !== btn.getAttribute('data-default-label')) {
                btn.style.backgroundColor = HIGHLIGHT_COLOR;
                btn.style.color = "#111";
                btn.style.borderColor = "#eab308";
                btn.style.fontWeight = "bold";
            } else {
                btn.style.backgroundColor = "#fff";
                btn.style.color = "#374151";
                btn.style.borderColor = "#d1d5db";
                btn.style.fontWeight = "normal";
            }
        }
    }


    // ì¸µìˆ˜ í‘œì‹œ ì‹œ ì§€í•˜ëŠ” 'B', ì¼ë°˜ì¸µì€ ìˆ«ìë¡œ í‘œê¸°
    function formatFloor(floor, floor_type) {
        const abs = Math.abs(floor);
        if (floor_type === 'ì§€í•˜' || floor < 0) {
            return `B${abs}`;
        }
        return `${floor}`;
    }
    
    // í´ëŸ¬ìŠ¤í„° ë“±ì—ì„œ ë§¤ë¬¼ ë¦¬ìŠ¤íŠ¸ íŒ¨ë„ ì—´ê³ , ë§¤ë¬¼ ëª©ë¡ì„ info-panelì— ì¶œë ¥
    function showListingsInPanel(listings) {
        matchedListingsCache = listings;
        matchedListingsPage = 1;
        if (typeof renderMatchedListings === "function") renderMatchedListings();
        infoPanel.classList.remove("hidden");
        infoPanel.style.display = 'block';
        setTimeout(() => {
            infoPanel.scrollTop = 0;
        }, 0);
    }

    // í‰ìˆ˜ ê°’ì´ ë¹„ì—ˆê±°ë‚˜ ì´ìƒí•  ë•Œ '-'ë¡œ, ì•„ë‹ˆë©´ ì†Œìˆ˜ 1ìë¦¬ë¡œ í‘œì‹œ
    function formatArea(area_py) {
        const value = String(area_py).trim();
        if (
            area_py === undefined ||
            area_py === null ||
            value === "" ||
            value === "-" ||
            value.toLowerCase() === "nan" || // 'NaN', 'nan' ëª¨ë‘ ëŒ€ì‘
            isNaN(Number(area_py))
        ) return '-';
        return Number(area_py).toFixed(1);
    }

    // ë¡œê·¸ì¸ ëª¨ë‹¬ ë‹«ê¸°
    function hideLogin() {
        document.getElementById('login-modal').classList.add('hidden');
    }

    // ë¡œê·¸ì¸ ëª¨ë‹¬ ì—´ê¸°
    function showLogin() {
        document.getElementById('login-modal').classList.remove('hidden');
    }
        
    async function login() {
        showLoadingOverlay();  // ë¡œê·¸ì¸ ì‹œì‘ ì‹œ ì˜¤ë²„ë ˆì´ ë³´ì—¬ì£¼ê¸°

        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value.trim();
        const errorDiv = document.getElementById('login-error');
        errorDiv.classList.add('hidden');

        if (!email || !password) {
            errorDiv.textContent = 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
            errorDiv.classList.remove('hidden');
            hideLoadingOverlay();  // ì‹¤íŒ¨ ì‹œ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
            return;
        }

        const { data, error } = await client.auth.signInWithPassword({ email, password });
        if (error) {
            errorDiv.textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message;
            errorDiv.classList.remove('hidden');
            hideLoadingOverlay();  // ì‹¤íŒ¨ ì‹œ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
            return;
        }

        isLoggedIn = true;
        hideLogin();
        document.getElementById('logout-btn')?.classList.remove('hidden');

        // ğŸ”½ ì§€ë„ í´ëŸ¬ìŠ¤í„°/ë§ˆì»¤ ì´ˆê¸°í™”
        clusterer.clear();  // ê¸°ì¡´ í´ëŸ¬ìŠ¤í„° ì œê±°
        allListings = {};   // ë§¤ë¬¼ ë°ì´í„° ì´ˆê¸°í™”
        allMarkers = {};    // ë§ˆì»¤ ì´ˆê¸°í™”

        await loadListingsInBounds();  // ë¡œê·¸ì¸ í›„ ë°ì´í„° ìƒˆë¡œ ë¡œë”©
        hideLoadingOverlay();  // ì™„ë£Œ í›„ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
    }


    function showLoadingOverlay() {
        document.getElementById('loading-overlay').classList.remove('hidden');
    }

    function hideLoadingOverlay() {
        document.getElementById('loading-overlay').classList.add('hidden');
    }

    async function logout() {
        await client.auth.signOut();
        location.reload();  // ì™„ì „ ì´ˆê¸°í™”
    }

    // í•„í„°ë§ í•¨ìˆ˜
    function getFilterValues() {
        return {
            floor_min: parseFloat(document.getElementById('floor_min').value),
            floor_max: parseFloat(document.getElementById('floor_max').value),
            sale_price_min: parseFloat(document.getElementById('sale_min').value),
            sale_price_max: parseFloat(document.getElementById('sale_max').value),
            deposit_price_min: parseFloat(document.getElementById('deposit_min').value),
            deposit_price_max: parseFloat(document.getElementById('deposit_max').value),
            monthly_rent_min: parseFloat(document.getElementById('rent_min').value),
            monthly_rent_max: parseFloat(document.getElementById('rent_max').value),
            total_deposit_min: parseFloat(document.getElementById('total_deposit_min').value),
            total_deposit_max: parseFloat(document.getElementById('total_deposit_max').value),
            total_rent_min: parseFloat(document.getElementById('total_rent_min').value),
            total_rent_max: parseFloat(document.getElementById('total_rent_max').value),
            area_py_min: parseFloat(document.getElementById('area_py_min').value),
            area_py_max: parseFloat(document.getElementById('area_py_max').value),
        };
    }

    // ì‹¤ì œë¡œ allListingsì—ì„œ ì¡°ê±´ì— ë§ëŠ” ê²ƒë§Œ ë°˜í™˜
    function filterListings(listings) {
        const f = getFilterValues();
        return listings.filter(l => {
            if (!selectedDealTypes.includes(l.deal_type)) return false; // ì¹´í…Œê³ ë¦¬ ë§¤ë§¤, ì›”ì„¸
            if (selectedCategories.length > 0 && !selectedCategories.includes(l.category)) return false;// ì¹´í…Œê³ ë¦¬ ìƒê°€, ì£¼íƒ, ê³µì¥ì°½ê³ 
            // ì¸µ
            if (!isNaN(f.floor_min) && l.floor < f.floor_min) return false;
            if (!isNaN(f.floor_max) && l.floor > f.floor_max) return false;
            // ë§¤ë§¤ê°€
            if (!isNaN(f.sale_price_min) && l.sale_price < f.sale_price_min) return false;
            if (!isNaN(f.sale_price_max) && l.sale_price > f.sale_price_max) return false;
            // ë³´ì¦ê¸ˆ
            if (!isNaN(f.deposit_price_min) && l.deposit_price < f.deposit_price_min) return false;
            if (!isNaN(f.deposit_price_max) && l.deposit_price > f.deposit_price_max) return false;
            // ì›”ì„¸
            if (!isNaN(f.monthly_rent_min) && l.monthly_rent < f.monthly_rent_min) return false;
            if (!isNaN(f.monthly_rent_max) && l.monthly_rent > f.monthly_rent_max) return false;
            // ì´ë³´ì¦ê¸ˆ
            if (!isNaN(f.total_deposit_min) && l.total_deposit < f.total_deposit_min) return false;
            if (!isNaN(f.total_deposit_max) && l.total_deposit > f.total_deposit_max) return false;
            // ì´ì›”ì„¸
            if (!isNaN(f.total_rent_min) && l.total_rent < f.total_rent_min) return false;
            if (!isNaN(f.total_rent_max) && l.total_rent > f.total_rent_max) return false;
            // ì „ìš©í‰ìˆ˜
            if (!isNaN(f.area_py_min) && l.area_py < f.area_py_min) return false;
            if (!isNaN(f.area_py_max) && l.area_py > f.area_py_max) return false;
            return true;
        });
    }

    // ìƒë‹¨ í•„í„°ë§ ë²„íŠ¼ ëˆŒë €ì„ ë•Œ íŒ¨ë„
    function toggleFilterPanel(type) {
        const panelIds = ['floor', 'sale', 'deposit', 'rent', 'total_deposit', 'total_rent', 'area_py', 'init'];
        panelIds.forEach(id => {
            const panel = document.getElementById(`filter-panel-${id}`);
            if (panel) {
            if (id === type) {
                panel.classList.toggle('hidden');
            } else {
                panel.classList.add('hidden');
            }
            }
        });
    }

    // ì§€ë„/ë¦¬ìŠ¤íŠ¸ë¥¼ í•„í„°ê°’ì— ë§ê²Œ ìƒˆë¡œ ê·¸ë¦¼
    function updateFilteredListings() {
        const filtered = filterListings(Object.values(allListings)); // âœ…

        clusterer.clear();
        const markers = [];
        filtered.forEach(listing => {
            // ìºì‹œëœ ë§ˆì»¤ê°€ ìˆìœ¼ë©´ ê·¸ê±¸, ì—†ìœ¼ë©´ ìƒˆë¡œ ë§Œë“ ë‹¤
            if (!allMarkers[listing.listing_id]) {
                const marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(listing.lat, listing.lng),
                    image: customImage
                });
                if (!listing || !listing.listing_id || !listing.lat || !listing.lng) return;
                allMarkers[listing.listing_id] = marker;
            }
            markers.push(allMarkers[listing.listing_id]);
        });
        clusterer.addMarkers(markers);     

        // infoPanelì˜ ë¦¬ìŠ¤íŠ¸ë„ ê°±ì‹ 
        matchedListingsCache = filtered;
        matchedListingsPage = 1;
        if (typeof renderMatchedListings === "function") renderMatchedListings();
    }

    // ë§¤ë¬¼ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ í•¨ìˆ˜
    function renderMatchedListings() {
        if (!Array.isArray(matchedListingsCache)) return;
        const start = 0;
        const end = matchedListingsPage * PAGE_SIZE;
        const listingsToShow = matchedListingsCache.slice(start, end);            

        const listText = listingsToShow.map(l => {
            // ê¸°ì¡´ í…œí”Œë¦¿(ì¹´ë“œ) ë³µì‚¬
            const statusRaw = l.transaction_status || '-';
            const status = statusRaw.trim().split(' ')[0];

            let bgStyle = 'background-color: #e5e7eb; color: #374151;';
            if (status === 'ì§„í–‰ì¤‘') {
                bgStyle = 'background-color: rgba(250,230,172); color: black;';
            } else if (status === 'ê³„ì•½ì™„ë£Œ') {
                bgStyle = 'background-color: rgba(255,237,237); color: rgba(247,63,87); font-weight: 900;';
            }

            const normalize = (val) => String(val || '').replace(/\s+/g, '');
            const isActive = String(window.currentDetailListingId).trim() === String(l.listing_id).trim();
            const highlightStyle = isActive
            ? 'background-color: rgba(243,244,246);'
            : '';

            return `
                <div class="mb-5 pb-2 border-b border-gray-300 text-left" style="${highlightStyle};">
                    <div onclick="showDetailPanel(${l.listing_id})" class="cursor-pointer hover:bg-gray-100 transition">
                        ${
                            isLoggedIn
                                ? `
                            <!-- âœ… ë¡œê·¸ì¸ í›„ ë‚´ë¶€ìš© ë ˆì´ì•„ì›ƒ -->
                            <div class="flex flex-row items-center gap-3">
                                <div class="relative w-[120px] h-[100px]">
                                    <!-- ìƒíƒœ ë±ƒì§€ -->
                                    <div class="absolute top-1 left-1 w-[61px] h-[22px] flex items-center justify-center text-xs px-1 rounded-sm font-semibold z-10"
                                        style="${bgStyle}">
                                        ${status}
                                    </div>
                                    <!-- ì¸ë„¤ì¼ ì´ë¯¸ì§€ -->
                                    <img src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/biakuk-images//baikuk-simbol.png"
                                        alt="ì¸ë„¤ì¼"
                                        class="w-full h-full object-cover rounded border" />
                                </div>                                
                                <div class="flex-1 flex flex-col gap-1">                                    
                                    <div class="flex items-center gap-2">
                                        <div class="flex flex-row items-center">
                                            <div class="w-[56px] h-[24px] flex justify-center items-center border-[1px] border-[rgb(242,193,48)] text-[rgb(0,0,0)] px-1 py-0 rounded text-sm font-bold">
                                                ${l.listing_id}
                                            </div>
                                            </div>
                                        <div class="flex-1 text-sm">
                                            ì „ìš© <strong class="font-semibold">${Number(l.area_py).toFixed(1)}</strong>í‰,
                                            <strong class="font-semibold">${formatFloor(l.floor, l.floor_type)}</strong>/${l.total_floors}ì¸µ
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <strong class="text-base text-gray-800 max-w-[280px] truncate whitespace-nowrap overflow-hidden" title="${l.listing_title}">
                                            ${l.listing_title.length > 20 ? l.listing_title.slice(0, 20) + 'â‹¯' : l.listing_title}
                                        </strong>
                                    </div>
                                    <div class="flex flex-col gap-[2px] leading-[1.4]">
                                        <div class="flex flex-row justify-between items-start">
                                            <div class="flex items-start gap-2">
                                                <div class="flex-1 text-left font-bold text-[rgb(80,152,233)] text-base">
                                                    ${l.deal_type}
                                                    ${
                                                        l.deal_type === "ë§¤ë§¤"
                                                            ? ` ${formatKoreanMoney(l.sale_price)}`
                                                            : l.deal_type === "ì›”ì„¸"
                                                            ? ` ${formatKoreanMoney(l.deposit_price)} / ${formatKoreanMoney(l.monthly_rent)}`
                                                            : ""
                                                    }
                                                </div>
                                            </div>
                                            <div class="text-right font-bold text-[rgb(248,63,87)] text-base whitespace-nowrap">
                                                ${
                                                    l.premium_price === "0"
                                                        ? `ë¬´ê¶Œë¦¬`
                                                        : `${formatKoreanMoney(l.premium_price)}`
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            `
                                : `
                            <!-- âœ… ë¹„ë¡œê·¸ì¸ ì‹œ ê³µê°œìš© ë ˆì´ì•„ì›ƒ -->
                            <div class="flex flex-row items-center gap-3">
                                <img src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/biakuk-images//baikuk-simbol.png"
                                    alt="ì¸ë„¤ì¼"
                                    class="w-[120px] h-[100px] object-cover rounded border flex-shrink-0" />

                                <div class="flex-1 flex flex-col gap-1">
                                    <div class="flex items-start gap-2">
                                        <div class="flex-1 text-left font-bold text-[rgb(80,152,233)] text-base">
                                            ${l.deal_type}
                                            ${
                                                l.deal_type === "ë§¤ë§¤"
                                                    ? ` ${formatKoreanMoney(l.sale_price)}`
                                                    : l.deal_type === "ì›”ì„¸"
                                                    ? ` ${formatKoreanMoney(l.deposit_price)} / ${formatKoreanMoney(l.monthly_rent)}`
                                                    : ""
                                            }
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="flex-1 text-sm">
                                            ì „ìš© <strong class="font-semibold">${Number(l.area_py).toFixed(1)}</strong>í‰,
                                            <strong class="font-semibold">${formatFloor(l.floor, l.floor_type)}</strong>/${l.total_floors}ì¸µ
                                        </div>
                                    </div>
                                    <div class="flex justify-between mt-1">
                                        <span class="inline-block text-[14px] text-[rgb(85,85,85)] leading-[1.4]">
                                            ${
                                                l.deal_type === "ì›”ì„¸" && Number(l.premium_price) === 0
                                                    ? `<span style="
                                                            background-color:rgb(0,222,90,0.07);
                                                            color:rgb(16,177,120);
                                                            font-weight:bold;
                                                            border-radius:4px;
                                                            padding:1px 6px;
                                                            margin-right:4px;
                                                            font-size:12px;
                                                            vertical-align: 0.5px;
                                                        ">ë¬´ê¶Œë¦¬</span>`
                                                    : ""
                                            }
                                            ${l.title}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            `
                        }
                    </div>
                </div>
            `;
        }).join('');

        infoContent.innerHTML = listText;
    }
    
    async function loadListingsInBounds() {
        if (isLoading) {
            return;
        }
        isLoading = true;

        const bounds = map.getBounds();
        const sw = bounds.getSouthWest();
        const ne = bounds.getNorthEast();

        // í™•ì¥ëœ ë²”ìœ„
        const extSwLat = sw.getLat(); // ê¸°ì¡´ sw ê·¸ëŒ€ë¡œ
        const extSwLng = sw.getLng();
        const extNeLat = ne.getLat(); // ê¸°ì¡´ ne ê·¸ëŒ€ë¡œ
        const extNeLng = ne.getLng();
        const tableToQuery = isLoggedIn ? 'baikukdbtest' : 'public_baikuk_view';

        // âœ… ë¹„ë¡œê·¸ì¸ ì‹œ ë‚´ë¶€ í…Œì´ë¸” ì ‘ê·¼ ë°©ì§€
        if (!isLoggedIn && tableToQuery === 'baikukdbtest') {
            console.warn("ë¹„ë¡œê·¸ì¸ ìƒíƒœì—ì„œ ë‚´ë¶€ í…Œì´ë¸” ì ‘ê·¼ ì‹œë„ ì°¨ë‹¨ë¨");
            isLoading = false;
            return;
        }

        // 1. í™•ì¥ëœ ì˜ì—­ ë‚´ ë§¤ë¬¼ID ì¡°íšŒ
        const { data: idData, error: idError } = await client
            .from(tableToQuery)
            .select('listing_id, lat, lng')
            .gte('lat', extSwLat)
            .lte('lat', extNeLat)
            .gte('lng', extSwLng)
            .lte('lng', extNeLng)
            .limit(1000); 

        if (idError) {
            alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + idError.message);
            isLoading = false;
            return;
        }

        // 2. ìƒì„¸ ë°ì´í„° fetch (ìºì‹œëœ ê²ƒ ì œì™¸)
        const neededIds = idData.map(d => d.listing_id);
        const toFetch = neededIds.filter(id => !(id in allListings));
        if (toFetch.length > 0) {
            const { data: detailData, error: detailError } = await client
                .from(tableToQuery)
                .select('*')
                .in('listing_id', toFetch);
            if (detailError) {
                alert("ìƒì„¸ ë°ì´í„° ì˜¤ë¥˜: " + detailError.message);
                isLoading = false;
                return;
            }
            detailData.forEach(l => { allListings[l.listing_id] = l; });
        }

        // 3. info-panel/ë§ˆì»¤ ëª¨ë‘ "í•„í„°ëœ ë§¤ë¬¼ë§Œ" ë°˜ì˜!
        const listArr = neededIds.map(id => allListings[id]).filter(v => !!v);

        // í•„í„°ë§
        const filtered = filterListings(listArr) || [];  // â† undefined ë°©ì§€
        
        // âœ… ì—¬ê¸°ì— ì¤Œ ë ˆë²¨ ë³„ gridSize ì¡°ì ˆ (ì•„ë˜ ì½”ë“œ ì¶”ê°€!)
        const level = map.getLevel();
        let gridSize;
        if (level <= 2) {
            gridSize = 10;
        } else if (level === 3) {
            gridSize = 30;
        } else if (level === 4) {
            gridSize = 40;
        } else {
            gridSize = 50;  // â† ì´ê²Œ 'ë™' ë‹¨ìœ„ë¡œ í´ëŸ¬ìŠ¤í„°ë§ì˜ ê·¼ì‚¬ê°’. (100~300px ì‚¬ì´ë¡œ ì¡°ì ˆ)
        }
        createClusterer(gridSize);

        // ë§ˆì»¤ í´ë¦¬ì–´ ë° ìƒˆë¡œ ì¶”ê°€
        clusterer.clear();
        const markers = [];
        filtered.forEach(l => {
            if (!l.lat || !l.lng) return;
            if (!allMarkers[l.listing_id]) {
                const marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(l.lat, l.lng),
                    image: customImage
                });
                marker.listing_id = l.listing_id;
                allMarkers[l.listing_id] = marker;
            }
            markers.push(allMarkers[l.listing_id]);
        });
        clusterer.addMarkers(markers);

        // ë¦¬ìŠ¤íŠ¸ íŒ¨ë„
        matchedListingsCache = Array.isArray(filtered) ? filtered : [];
        matchedListingsPage = 1;
        if (typeof renderMatchedListings === "function") {
            renderMatchedListings();
        }

        isLoading = false;
    }

    // ìµœì´ˆ í•œ ë²ˆ ë¡œë”©
    loadListingsInBounds();
    
    // (1) í˜„ì¬ ì§€ë„ ì˜ì—­ì˜ ë§¤ë¬¼ì„ ê°€ì ¸ì˜´ (ì´ë¯¸ allListingsì— ìˆìŒ)
    matchedListingsCache = Object.values(allListings); // ì „ì²´ ë¦¬ìŠ¤íŠ¸ ì €ì¥
    matchedListingsPage = 1;            // ì²« í˜ì´ì§€ë¡œ ì´ˆê¸°í™”

    // (2) ë¦¬ìŠ¤íŠ¸ 15ê°œë§Œ info-panelì— ê·¸ë ¤ì¤Œ
    if (typeof renderMatchedListings === "function") renderMatchedListings();

    const filterUnits = {
        floor: 'ì¸µ',
        sale: 'ë§Œ',
        deposit: 'ë§Œ',
        rent: 'ë§Œ',
        total_deposit: 'ë§Œ',
        total_rent: 'ë§Œ',
        area_py: 'í‰'
    };


    function resetFilters() {
        // ëª¨ë“  input ì´ˆê¸°í™”
        filterTypes.forEach(type => {
            const minEl = document.getElementById(`${type}_min`);
            const maxEl = document.getElementById(`${type}_max`);
            if (minEl) minEl.value = "";
            if (maxEl) maxEl.value = "";
            updateFilterButtonText(type);
        });
        selectedCategories = ['ìƒê°€'];
        selectedDealTypes = ['ì›”ì„¸'];        
        renderDealAndCategoryButtons(); // 3. UI ë‹¤ì‹œ ê·¸ë¦¼ âœ… ì´ê²Œ í•µì‹¬!
        loadListingsInBounds();
    }

    // ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ ë‘ ë²ˆì§¸ íŒ¨ë„ ë‹«ê¸°
    kakao.maps.event.addListener(map, 'click', function () {
        hideDetailPanel();
        loadListingsInBounds();
    });

    // 1. ì§€ë„ idle ë¦¬ìŠ¤ë„ˆëŠ” ë”± ì´ê²ƒë§Œ!
    kakao.maps.event.addListener(map, 'idle', () => {
        if (mapIdleTimer) clearTimeout(mapIdleTimer);
        mapIdleTimer = setTimeout(() => {
            loadListingsInBounds();
        }, 200);
    });


    
    // í˜ì´ì§€ ë¡œë”© ì‹œ í•„í„° ë²„íŠ¼ í‘œì‹œ
    document.addEventListener('DOMContentLoaded', async () => {
        renderDealAndCategoryButtons();
        renderFilterButtons();

        const { data: { session } } = await client.auth.getSession();
        if (session) {
            isLoggedIn = true;
            document.getElementById('logout-btn')?.classList.remove('hidden');
            console.log('âœ… ë¡œê·¸ì¸ ì„¸ì…˜ ìœ ì§€ë¨');
        } else {
            isLoggedIn = false;
            document.getElementById('logout-btn')?.classList.add('hidden');
            console.log('ğŸ”’ ë¡œê·¸ì¸ í•„ìš”');
        }

        await loadListingsInBounds();
    });


    // í™•ëŒ€/ì¶•ì†Œ/í˜„ì¬ìœ„ì¹˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
    document.getElementById('btn-zoom-in').onclick = function() {
    map.setLevel(map.getLevel() - 1); // ë” í™•ëŒ€ (ë ˆë²¨ ë‚®ì„ìˆ˜ë¡ í™•ëŒ€)
    };
    document.getElementById('btn-zoom-out').onclick = function() {
    map.setLevel(map.getLevel() + 1); // ë” ì¶•ì†Œ
    };
    document.getElementById('btn-current-location').onclick = function() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        map.setCenter(new kakao.maps.LatLng(lat, lng));
        });
    } else {
        alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }
    };

    // info-panel ë¬´í•œ ìŠ¤í¬ë¡¤(ì•„ë˜ë¡œ ëê¹Œì§€ ë‚´ë¦¬ë©´ ë‹¤ìŒ í˜ì´ì§€)
    document.getElementById('info-panel').addEventListener('scroll', function () {
        const el = this;
        if (el.scrollTop + el.clientHeight >= el.scrollHeight - 50) {
            if (matchedListingsPage * PAGE_SIZE < matchedListingsCache.length) {
                matchedListingsPage++;
                renderMatchedListings();
            }
        }
    });

    document.getElementById('btn-naver-map').onclick = function () {
        let lat, lng;

        // ìƒì„¸ íŒ¨ë„ì´ ì—´ë ¤ ìˆê³ , ë§¤ë¬¼ ë°ì´í„°ê°€ ìˆìœ¼ë©´ â†’ ê·¸ ë§¤ë¬¼ì˜ ì¢Œí‘œ ì‚¬ìš©
        const detailPanel = document.getElementById('detail-panel');
        if (!detailPanel.classList.contains('hidden')) {
            // ìƒì„¸ ë§¤ë¬¼ IDëŠ” showDetailPanel()ì—ì„œ ì–´ë”˜ê°€ ì €ì¥ í•„ìš”
            // ì˜ˆì‹œ: window.currentDetailListingIdì— ë³´ê´€
            if (window.currentDetailListingId && allListings[window.currentDetailListingId]) {
                lat = allListings[window.currentDetailListingId].lat;
                lng = allListings[window.currentDetailListingId].lng;
            }
        }

        // ìƒì„¸ íŒ¨ë„ì´ ì•ˆ ì—´ë ¸ê±°ë‚˜, ë§¤ë¬¼ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì§€ë„ ì¤‘ì‹¬ ì‚¬ìš©
        if (!lat || !lng) {
            const center = map.getCenter();
            lat = center.getLat();
            lng = center.getLng();
        }

        const naverUrl = `https://map.naver.com/v5/?c=${lng},${lat},17,0,0,0,d`;
        window.open(naverUrl, '_blank');
    };



    window.resetFilters = resetFilters;
  </script>
</body>
</html>
