<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë§¤ë§¤ì¶”ì²œ</title>
  <link rel="icon" type="image/png" href="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/pabicon-baikuk-simbol.png" />
  <link rel="preconnect" href="https://sfinbtiqlfnaaarziixu.supabase.co" crossorigin>
  <link rel="dns-prefetch" href="//sfinbtiqlfnaaarziixu.supabase.co">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .shadow-right {
      box-shadow: 8px 0 12px -4px rgba(0, 0, 0, 0.08);
    }
    th.resizable {
      position: relative;
      min-width: 40px;
      white-space: nowrap;
    }
    .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      width: 0.4rem;
      height: 100%;
      cursor: col-resize;
      z-index: 10;
      background-color: transparent;
    }
  </style>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://sfinbtiqlfnaaarziixu.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaW5idGlxbGZuYWFhcnppaXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MDkxNjEsImV4cCI6MjA2ODA4NTE2MX0.4-7vnIjbF-biWWuv9-vTxK9Y99gMm-vS6oaRMdRL5fA'
    );

    window.supabase = supabase; // ì „ì—­ìœ¼ë¡œ ì ‘ê·¼
    
    (async () => {
      try {
        // 1) ë¡œê·¸ì¸ ì„¸ì…˜ í™•ì¸ (ì—†ìœ¼ë©´ ì´ë™)
        const { data, error } = await supabase.auth.getSession();
        if (error) console.warn("ì„¸ì…˜ ì¡°íšŒ ì—ëŸ¬:", error);
        if (!data?.session) {
          console.warn("ë¡œê·¸ì¸ ì„¸ì…˜ ì—†ìŒ â†’ /map ìœ¼ë¡œ ì´ë™");
          location.replace("https://baikuk-map.netlify.app/admin/listings/");
          return;
        }

        // 2) ê¶Œí•œ ê¸°ë°˜ìœ¼ë¡œ 'ì •ì‚°' íƒ­ í‘œì‹œ/ìˆ¨ê¹€
        const guardClick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          alert('ì§ì› ê¶Œí•œì€ ì •ì‚° ë©”ë‰´ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        };

        const showOrHideSettlementTab = async () => {
          const tab = document.getElementById('settlement-tab');
          if (!tab) return;

          const { data: { user } } = await supabase.auth.getUser();
          if (!user?.id) return;

          const { data: me, error: authErr } = await supabase
            .from('staff_profiles')
            .select('authority')
            .eq('user_id', user.id)
            .maybeSingle();

          if (authErr) {
            console.warn('authority ì¡°íšŒ ì‹¤íŒ¨:', authErr);
            return; // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ìˆ¨ê¹€ ìœ ì§€
          }

          const role = (me?.authority || '').trim();
          if (role === 'ì§ì›') {
            // ì§ì›: ìˆ¨ê¹€(ê¸°ë³¸ê°’ ìœ ì§€) + ì•ˆì „ ê°€ë“œ
            tab.style.display = 'none';
            tab.addEventListener('click', guardClick, { once: true });
          } else {
            // ê´€ë¦¬ì/ì§€ì ì¥: í‘œì‹œ
            tab.style.removeProperty('display');
          }
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', showOrHideSettlementTab, { once: true });
        } else {
          showOrHideSettlementTab();
        }
      } catch (e) {
        console.warn('ì„¸ì…˜/ì •ì‚° íƒ­ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸:', e);
      }
    })();

  </script>
</head>
<body class="w-screen">
  <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-[9999] hidden">ë©”ì‹œì§€ ì˜ì—­</div>

  <div class="absolute top-0 left-0 z-[9998] bg-white w-[13rem] h-[60px] rounded-xl">
    <img src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/logotype-baikuk.png"
      alt="ê¸€ì”¨ë¡œê³ "
      class="absolute h-11 w-auto cursor-pointer top-2 left-2 z-[9999]"
      onclick="location.reload()"/>
  </div>

  <div class="flex min-h-screen">
    <div class="w-[6%] pt-[5rem] shadow-right text-center bg-white">
      <a href="https://baikuk.com/map" target="_blank">
        <div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">ë°±ì–µì§€ë„</div>
      </a>
      <a href="/admin/listings/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë§¤ë¬¼ì¥ë¶€</div></a>
      <a href="/admin/recommend_imDae/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ì„ëŒ€ì¶”ì²œ</div></a>
      <a href="/admin/recommend_maeMae/"><div class="bg-gray-100 border-l-4 border-gray-500 text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë§¤ë§¤ì¶”ì²œ</div></a>
      <a href="/admin/customer_manage/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">ëª¨ë“ ê³ ê°</div></a>
      <a href="/admin/ad_censorship/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ê´‘ê³ ê´€ë¦¬</div></a>
      <a href="/admin/staff_manage/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ì§ì›ì •ë³´</div></a>
      <a href="/admin/performance/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë§¤ì¶œ</div></a>
      <a href="/admin/cost_management/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë¹„ìš©ê´€ë¦¬</div></a>
      <a id="settlement-tab" href="/admin/settlement/" style="display:none">
        <div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">ì •ì‚°</div>
      </a>
    </div>
    <div class="w-[91%] flex flex-col bg-gray-100">
      <div class="mt-[3rem] flex px-3 bg-gray-100 gap-2">
        <!-- ì™¼ìª½: ë§¤ë¬¼ë²ˆí˜¸ ì…ë ¥ -->
        <div class="px-2 py-2 mt-[4rem] bg-white border border-gray-300 rounded-md self-start">
          <div class="mb-2 text-right">
            <button id="toggle-edit-btn" class="h-[2rem] bg-blue-500 hover:bg-blue-600 text-white text-sm px-4 py-1 rounded">ì €ì¥</button>
          </div>
          <div id="table-container" class="border rounded-md">
            <table class="w-[7rem] text-sm text-left">
              <thead class="bg-gray-100 sticky top-0 z-10">
                <tr id="header-row"><th class="p-1 font-bold text-base text-center">ë§¤ë¬¼ë²ˆí˜¸</th></tr>
              </thead>
              <tbody id="left-tbody" class="bg-white"></tbody>
            </table>
          </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì¶”ì²œí‘œ -->
        <div class="ml-[1rem] px-4 py-4 bg-white border border-gray-300 rounded-md self-start">
          <div id="table-container" class="custom-scroll bg-white rounded-md">
            <div>
              <div class="flex items-end mb-2 gap-3">
                <img src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/biakuk-images//baikuk-logo-yellow_simbol_name.png" alt="ë°±ì–µë¡œê³ " class="w-[25rem]" />
                <div class="justify-between items-end mb-2">
                  <!-- ë‚ ì§œ -->
                  <div id="today-date" class="text-gray-600 text-sm font-semibold"></div>
                  <!-- ë‹´ë‹¹ì: ì½ê¸° í…ìŠ¤íŠ¸ / í¸ì§‘ ì…€ë ‰íŠ¸ -->
                  <div class="text-gray-800 text-lg font-semibold">
                    <div id="staff-info"></div>
                    <select id="staff-select" class="hidden mt-1 border border-gray-300 rounded px-2 py-1 text-base"></select>
                  </div>
                </div>
              </div>

              <table class="w-[50rem] text-sm text-left bg-white" style="table-layout: fixed;">
                <thead class="bg-gray-100 sticky top-0 z-10">
                  <tr id="header-row">
                    <th class="resizable p-1 border-r text-base text-center" style="width: 1.5rem;"><div class="resize-handle"></div></th>
                    <th class="resizable p-1 border-r text-base text-center" style="width: 10rem;">ë§¤ë¬¼ëª…<div class="resize-handle"></div></th>
                    <th class="resizable p-1 border-r text-base text-center" style="width: 8rem;">ì£¼ì†Œ<div class="resize-handle"></div></th>
                    <th class="resizable p-1 border-r text-base text-center" style="width: 8rem;">ê±´ë¬¼ì •ë³´<div class="resize-handle"></div></th>
                    <th class="resizable p-1 border-r text-base text-center" style="width: 5.5rem;">ë§¤ë§¤ê°€<div class="resize-handle"></div></th>
                    <th class="resizable p-1 border-r text-base text-center" style="width: 5.5rem;">ì´ë³´ì¦ê¸ˆ<div class="resize-handle"></div></th>
                    <th class="resizable p-1 border-r text-base text-center" style="width: 4rem;">ì´ì›”ì„¸<div class="resize-handle"></div></th>
                    <th class="resizable p-1 border-r text-base text-center" style="width: 4.7rem;">ì „ìš©(í‰)<div class="resize-handle"></div></th>
                    <th class="resizable p-1 border-r text-base text-center" style="width: 15rem;">ë‚´ìš©<div class="resize-handle"></div></th>
                  </tr>
                </thead>
                <tbody id="listings-body" class="odd:bg-white even:bg-gray-50"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div> <!-- /row -->
    </div>
  </div>

  <script>
    let __selectedStaffId = null; // ì„ íƒëœ ë‹´ë‹¹ì ID ê¸°ì–µìš©

    /* ==============================
       ê³µí†µ ìœ í‹¸ / ê¶Œí•œ ì»¨í…ìŠ¤íŠ¸
    ===============================*/
    function showToast(msg, duration=3000){
      const t=document.getElementById('toast');
      t.textContent=msg; t.style.backgroundColor='#F2C130'; t.style.color='black'; t.style.fontWeight='bold';
      t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), duration);
    }

    async function getAuthContext() {
      const { data:{ user }, error:userError } = await supabase.auth.getUser();
      if (userError || !user) return { me:null, myAuth:null, myAff:null };

      const { data: me } = await supabase
        .from('staff_profiles')
        .select('id, authority, affiliation')
        .eq('user_id', user.id)
        .maybeSingle();

      return {
        me,
        myAuth: (me?.authority ?? '').trim(),   // 'ê´€ë¦¬ì' | 'ì§€ì ì¥' | 'ì§ì›'
        myAff: (me?.affiliation ?? '').trim()
      };
    }

    // ê¶Œí•œë³„(ì§ì›=í‡´ì‚¬ì ì œì™¸) ì§ì› ë¦¬ìŠ¤íŠ¸ ë¡œë”©
    async function loadStaffOptions(currentStaffId = null) {
      const staffSelect = document.getElementById('staff-select');
      if (!staffSelect) return;
      staffSelect.innerHTML = '';

      const { me, myAuth, myAff } = await getAuthContext();
      if (!me) return;

      let q = supabase
        .from('staff_profiles')
        .select('id, name, affiliation, leave_date')
        .order('affiliation', { ascending:true })
        .order('name', { ascending:true });

      if (myAuth === 'ì§ì›') q = q.is('leave_date', null);

      const { data: staffList, error } = await q;
      if (error || !staffList) return;

      const grouped = staffList.reduce((acc, s) => {
        (acc[s.affiliation || 'ë¯¸ì§€ì •'] ??= []).push(s); return acc;
      }, {});

      const appendGroup = (label, members) => {
        if (!members?.length) return;
        const og = document.createElement('optgroup'); og.label = label;
        members.forEach(s=>{
          const opt=document.createElement('option');
          opt.value=s.id;
          const retiredTag = (myAuth !== 'ì§ì›' && s.leave_date) ? ' (í‡´ì‚¬)' : '';
          opt.textContent=`${s.name}${retiredTag}`;
          if (currentStaffId && s.id===currentStaffId) opt.selected = true;
          og.appendChild(opt);
        });
        staffSelect.appendChild(og);
      };

      if (myAff && grouped[myAff]) { appendGroup(`ğŸ“Œ ${myAff} (ê°™ì€ ì†Œì†)`, grouped[myAff]); delete grouped[myAff]; }
      Object.entries(grouped).forEach(([aff, members])=>appendGroup(aff, members));
    }

    /* ==============================
       í…Œì´ë¸”/í–‰ ì²˜ë¦¬
    ===============================*/
    function applyRowStriping(){
      const rows=document.querySelectorAll('#listings-body tr');
      rows.forEach((row,i)=>{ row.classList.remove('bg-white','bg-gray-50'); row.classList.add(i%2===0?'bg-white':'bg-gray-50'); });
    }

    function updateListingsTableByInputs(){
      const listingsBody=document.getElementById('listings-body');
      const allInputs=document.querySelectorAll('input[data-index]');
      let maxIndex=0;
      allInputs.forEach(input=>{
        const val=input.value.trim(); const idx=parseInt(input.dataset.index);
        if(val!=='' && !isNaN(idx)) maxIndex=Math.max(maxIndex, idx);
      });
      const currentRows=listingsBody.children.length;
      for(let i=currentRows+1;i<=maxIndex;i++){
        const row=document.createElement('tr');
        row.innerHTML=`
          <td class="p-1 border text-center">${i}</td>
          <td class="p-1 border text-center"><textarea rows="2" class="w-full box-border text-center text-base border rounded bg-white outline-none resize-none" data-field="listing_title_${i}"></textarea></td>
          <td class="p-1 border text-center"><textarea rows="2" class="w-full box-border text-center text-base border rounded bg-white outline-none resize-none" data-field="full_address_${i}"></textarea></td>
          <td class="p-1 border text-center"><input type="text" class="w-full box-border text-center text-base border rounded bg-white outline-none" data-field="combined_unit_${i}" /></td>
          <td class="p-1 border text-center"><input type="text" class="w-full box-border text-center text-base border rounded bg-white outline-none" data-field="sale_price_${i}" /></td>
          <td class="p-1 border text-center"><input type="text" class="w-full box-border text-center text-base border rounded bg-white outline-none" data-field="total_deposit_${i}" /></td>
          <td class="p-1 border text-center"><input type="text" class="w-full box-border text-center text-base border rounded bg-white outline-none" data-field="total_rent_${i}" /></td>
          <td class="p-1 border text-center"><input type="text" class="w-full box-border text-center text-base border rounded bg-white outline-none" data-field="area_py_${i}" /></td>
          <td class="p-1 border text-center"><textarea rows="2" class="w-full box-border text-left text-base border rounded bg-white outline-none resize-none" data-field="description_${i}"></textarea></td>`;
        listingsBody.appendChild(row); applyRowStriping();
      }
      while(listingsBody.children.length>maxIndex){ listingsBody.removeChild(listingsBody.lastChild); }
    }

    function switchSpansToInputs(){
      document.querySelectorAll('#listings-body tr').forEach(row=>{
        row.querySelectorAll('span[data-field]').forEach(span=>{
          const field=span.dataset.field, value=span.textContent||'';
          let inputEl;
          if(field.startsWith('listing_title_')||field.startsWith('full_address_')||field.startsWith('description_')){
            inputEl=document.createElement('textarea'); inputEl.rows=2; inputEl.className='w-full text-center text-base border rounded bg-white outline-none resize-none';
          }else{
            inputEl=document.createElement('input'); inputEl.type='text'; inputEl.className='w-full text-center text-base border rounded bg-white outline-none';
          }
          inputEl.value=value; inputEl.dataset.field=field; span.parentElement.replaceChild(inputEl, span);
        });
      });
    }
    function switchInputsToSpans(){
      document.querySelectorAll('#listings-body tr').forEach(row=>{
        row.querySelectorAll('input[data-field], textarea[data-field]').forEach(el=>{
          const value=el.value||'', field=el.dataset.field;
          const span=document.createElement('span'); span.className='text-base block whitespace-pre-wrap'; span.dataset.field=field; span.textContent=value;
          el.parentElement.replaceChild(span, el);
        });
      });
    }

    function syncRowHeights(){
      const rightRows=document.querySelectorAll('#listings-body tr');
      const leftRows=document.querySelectorAll('#left-tbody tr');
      for(let i=0;i<leftRows.length;i++){ const r=rightRows[i], l=leftRows[i]; if(r&&l){ l.style.height = r.offsetHeight+'px'; } }
    }

    function clearListingRow(index){
      ['listing_title','full_address','combined_unit','total_deposit','total_rent','sale_price','area_py','description']
        .forEach(field=>{
          const el=document.querySelector(`[data-field="${field}_${index}"]`);
          if(!el) return;
          if(el.tagName==='INPUT' || el.tagName==='TEXTAREA'){ el.value=''; } else { el.textContent=''; }
        });
      syncRowHeights?.();
    }

    function formatKoreanMoney(v){ if(!v&&v!==0)return'-'; const n=Number(v); if(isNaN(n))return'-'; if(n>=10000){ const eok=Math.floor(n/10000), man=n%10000; return `${eok}ì–µ${man>0?' '+man.toLocaleString():''}`; } return n.toLocaleString(); }

    async function preloadBuildingInfo(){
      const { data: buildings, error } = await supabase.from('building_info').select('addr_compare, building_name');
      if(!error && buildings){ window.buildingMap=new Map(buildings.map(b=>[b.addr_compare, b.building_name])); } else { console.warn('building_info ë¡œë”© ì‹¤íŒ¨', error); }
    }
    function combineUnitInfo(buildingName, floor, unitInfo){
      const parts=[]; if(buildingName && buildingName!=='-') parts.push(buildingName);
      if(floor && floor!=='-'){ const fs=String(floor); parts.push(fs.endsWith('ì¸µ')?fs:fs+'ì¸µ'); }
      if(unitInfo && unitInfo!=='-'){ const u=String(unitInfo).trim(); const out=(u.endsWith('í˜¸')||u.endsWith('ì¼ë¶€')||u.includes('ì „ì²´'))?u:(u+'í˜¸'); parts.push(out); }
      return parts.join(' ');
    }

    async function fetchListingInfo(listingId, rowIndex){
      const cleanedId=listingId.replace(/[^\d]/g,''); if(!cleanedId) return;
      const numericId=Number(cleanedId.replaceAll(',','')); if(isNaN(numericId)){ alert('ìœ íš¨í•œ ìˆ«ì ë§¤ë¬¼ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

      const { data: listing, error } = await supabase
        .from('baikukdbtest')
        .select('listing_title, full_address, addr_compare, unit_info, floor, sale_price, total_deposit, total_rent, area_py')
        .eq('listing_id', numericId).single();

      if(error || !listing){ showToast(`ë§¤ë¬¼ë²ˆí˜¸ ${listingId} ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`); return; }

      const buildingName = (window.buildingMap||new Map()).get(listing.addr_compare) ?? '-';
      const combinedUnit = combineUnitInfo(buildingName, listing.floor, listing.unit_info);

      const dataToDisplay = {
        listing_title: listing.listing_title,
        full_address: listing.full_address,
        combined_unit: combinedUnit,
        total_deposit: listing.total_deposit,
        total_rent: listing.total_rent,
        sale_price: listing.sale_price,
        area_py: listing.area_py
      };

      updateListingsTableByInputs();

      if(!window.isEditMode){
        const row = document.querySelectorAll('#listings-body tr')[rowIndex-1];
        if(row){
          row.querySelectorAll('input[data-field], textarea[data-field]').forEach(el=>{
            const span=document.createElement('span'); span.className='text-base block whitespace-pre-wrap'; span.dataset.field=el.dataset.field; span.textContent=el.value||'';
            el.parentElement.replaceChild(span, el);
          });
        }
      }

      Object.entries(dataToDisplay).forEach(([field,value])=>{
        const el=document.querySelector(`[data-field="${field}_${rowIndex}"]`);
        if(!el) return;
        const isMoney = ['sale_price','total_deposit','total_rent'].includes(field);
        const formatted = isMoney ? formatKoreanMoney(value)
                      : field==='area_py' ? (isNaN(Number(value))?'-':Number(value).toFixed(1))
                      : field==='full_address' ? (typeof value==='string'? value.split(' ').slice(1).join(' '):'-')
                      : (value ?? '-');
        if(el.tagName==='INPUT' || el.tagName==='TEXTAREA') el.value=formatted; else el.textContent=formatted;
      });

      syncRowHeights(); applyRowStriping();
    }

    function displayTodayDate(){
      const d=new Date(), yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      const el=document.getElementById('today-date'); if(el) el.textContent=`${yyyy}-${mm}-${dd}`;
    }

    // âœ… ë¡œê·¸ì¸í•œ ë³¸ì¸ ì •ë³´ í…ìŠ¤íŠ¸
    async function displayStaffInfo(){
      const { data:{ user }, error:userError } = await supabase.auth.getUser();
      if(userError || !user) return;
      const { data: staff, error: staffError } = await supabase
        .from('staff_profiles')
        .select('id, position, name, phone_num')
        .eq('user_id', user.id)   /* â† user_id ê¸°ì¤€ìœ¼ë¡œ ìˆ˜ì • */
        .maybeSingle();

      if(staffError || !staff) return;
      __selectedStaffId = staff.id; // â† í˜„ì¬ ë¡œê·¸ì¸í•œ ë‹´ë‹¹ì ID ì €ì¥
      const el=document.getElementById('staff-info');
      if(el) el.textContent = `${staff.position} ${staff.name} ${staff.phone_num}`;
    }

    /* ==============================
       ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸
    ===============================*/
    // ì™¼ìª½ ë²ˆí˜¸ ì…ë ¥ì¹¸ 50ê°œ
    const leftTbody=document.getElementById('left-tbody');
    for(let i=1;i<=50;i++){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td class="border-b text-right pr-2">
        <input type="text" placeholder="ì…ë ¥ ${i}" class="w-[5rem] border px-2 rounded text-base ml-auto block" data-index="${i}" />
      </td>`;
      leftTbody.appendChild(tr);
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      displayTodayDate();
      displayStaffInfo();
      preloadBuildingInfo();

      document.querySelectorAll('input[data-index]').forEach(input=>{
        const index=parseInt(input.dataset.index);
        input.addEventListener('change', e=>{
          const v=e.target.value.trim();
          if(v==='') clearListingRow(index); else fetchListingInfo(v, index);
        });
        input.addEventListener('keydown', e=>{
          if(e.key==='Enter'){
            const v=e.target.value.trim();
            if(v==='') clearListingRow(index); else fetchListingInfo(v, index);
            const next=document.querySelector(`input[data-index="${index+1}"]`); if(next) next.focus();
            e.preventDefault();
          }
        });
        input.addEventListener('paste', e=>{
          e.preventDefault();
          const paste=(e.clipboardData||window.clipboardData).getData('text');
          paste.split(/[\s,\n]+/).map(s=>s.trim()).filter(Boolean).forEach((val,off)=>{
            const t=document.querySelector(`input[data-index="${index+off}"]`);
            if(t){ t.value=val; t.dispatchEvent(new Event('change')); }
          });
        });
      });

      // ì»¬ëŸ¼ ë¦¬ì‚¬ì´ì¦ˆ
      let startX,startWidth,resizableTh;
      document.querySelectorAll('.resize-handle').forEach(h=>{
        h.addEventListener('mousedown', e=>{
          resizableTh=e.target.closest('th');
          startX=e.clientX; startWidth=resizableTh.offsetWidth;
          document.addEventListener('mousemove', resizeColumn);
          document.addEventListener('mouseup', stopResize);
        });
      });
      function resizeColumn(e){ if(!resizableTh) return; resizableTh.style.width = (startWidth + (e.clientX-startX))+'px'; }
      function stopResize(){ document.removeEventListener('mousemove', resizeColumn); document.removeEventListener('mouseup', stopResize); resizableTh=null; }

      // í¬ì»¤ìŠ¤ì‹œ ì „ì²´ ì„ íƒ
      document.addEventListener('focusin', e=>{ if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') e.target.select(); });

      // í¸ì§‘/ì½ê¸° í† ê¸€ + ë‹´ë‹¹ì select í‘œì‹œ/ìˆ¨ê¹€
      window.isEditMode = false; // ì‹œì‘ì€ ì½ê¸°
      
      // âœ… ì²« ë¡œë“œ ì‹œ: ì½ê¸°ëª¨ë“œ í˜•íƒœë¡œ ë²„íŠ¼/í‘œ ì„¸íŒ…
      const toggleButton = document.getElementById('toggle-edit-btn');
      toggleButton.textContent = 'ìˆ˜ì •';
      toggleButton.classList.remove('bg-blue-500','hover:bg-blue-600');
      toggleButton.classList.add('bg-neutral-500','hover:bg-neutral-600');
      const staffInfoEl=document.getElementById('staff-info');
      const staffSelectEl=document.getElementById('staff-select');

      toggleButton.addEventListener('click', async ()=>{
        window.isEditMode = !window.isEditMode;
        toggleButton.textContent = window.isEditMode ? 'ì €ì¥' : 'ìˆ˜ì •';

        if(window.isEditMode){
          // í¸ì§‘ëª¨ë“œ
          switchSpansToInputs();
          staffInfoEl.classList.add('hidden');
          staffSelectEl.classList.remove('hidden');
          await loadStaffOptions(__selectedStaffId);
          showToast('í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
          // ë¶ˆí•„ìš”í•œ ë¹ˆ í–‰ ì •ë¦¬
          const listingsBody=document.getElementById('listings-body');
          const rows=listingsBody.querySelectorAll('tr');
          let lastFilled=-1;
          rows.forEach((row,i)=>{
            const idx=i+1;
            const keys=[`listing_title_${idx}`,`full_address_${idx}`,`total_deposit_${idx}`,`total_rent_${idx}`,`area_py_${idx}`];
            const has = keys.some(f=>{ const el=row.querySelector(`[data-field="${f}"]`); if(!el) return false; const v=(el.tagName==='SPAN'?el.textContent:el.value)||''; return v.trim()!==''; });
            if(has) lastFilled=i;
          });
          for(let i=rows.length-1;i>lastFilled;i--){ listingsBody.removeChild(rows[i]); }
          syncRowHeights?.();
          return;
        } else {
          // ì €ì¥(ì½ê¸°)ëª¨ë“œ
          switchInputsToSpans();
          // ì…€ë ‰íŠ¸ê°€ ìˆë‹¤ë©´ ì„ íƒëœ ë‹´ë‹¹ì í…ìŠ¤íŠ¸ í‘œê¸°ë§Œ (DBì €ì¥ì€ í˜„ì¬ í˜ì´ì§€ ìŠ¤í™ìƒ ìƒëµ)
          const selectedId = staffSelectEl.value;
          if(selectedId){
            const { data: staff } = await supabase.from('staff_profiles').select('position, name, phone_num').eq('id', selectedId).maybeSingle();
            if(staff) staffInfoEl.textContent = `${staff.position} ${staff.name} ${staff.phone_num}`;
          }
          staffSelectEl.classList.add('hidden');
          staffInfoEl.classList.remove('hidden');
          showToast('ì½ê¸° ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì—¬ê¸°ì„œë¶€í„°ëŠ” ì €ì¥ ë¡œì§ì´ í•„ìš”í•˜ë©´ ì¶”ê°€(í˜„ì¬ í˜ì´ì§€ ìš”êµ¬ì‚¬í•­ì—” ë‹´ë‹¹ì ì…€ë ‰íŠ¸ í•„í„°ê°€ í•µì‹¬ì´ë¼ DB ì—…ë°ì´íŠ¸ëŠ” ìƒëµ)
      });

      // ì´ˆê¸° span ëª¨ë“œë¡œ ì „í™˜í•˜ì§€ ì•Šê³ , ì´ í˜ì´ì§€ëŠ” ê¸°ë³¸ í¸ì§‘ ì‹œì‘ â†’ í•„ìš” ì‹œ ì•„ë˜ ì£¼ì„ í•´ì œ
      // switchInputsToSpans();

      // ResizeObserverë¡œ ë†’ì´ ë™ê¸°í™”
      const listingsBody=document.getElementById('listings-body');
      new ResizeObserver(()=>syncRowHeights()).observe(listingsBody);

    });

    window.addEventListener('resize', syncRowHeights);
  </script>
</body>
</html>