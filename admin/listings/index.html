<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë§¤ë¬¼ì¥ë¶€</title>
  <link rel="icon" type="image/png" href="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/pabicon-baikuk-simbol.png" />
  <link rel="preconnect" href="https://sfinbtiqlfnaaarziixu.supabase.co" crossorigin>
  <link rel="dns-prefetch" href="//sfinbtiqlfnaaarziixu.supabase.co">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .custom-scroll::-webkit-scrollbar {
      width: 20px;
      height: 20px;
    }
    .custom-scroll::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    .custom-scroll::-webkit-scrollbar-thumb {
      background-color: #c1c1c1;
      border-radius: 6px;
      border: 2px solid #f1f1f1;
    }
    .custom-scroll::-webkit-scrollbar-thumb:hover {
      background-color: #999;
    }
    th.resizable {
      position: relative;
    }
    .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      width: 6px;
      height: 100%;
      cursor: col-resize;
      z-index: 10;
    }
    th.resizing {
      cursor: col-resize;
    }
    .filter-popup {
      position: absolute;
      background: white;
      border: 1px solid #d1d5db; /* gray-300 */
      border-radius: 0.375rem; /* rounded-md */
      padding: 0.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 50;
    }    
    .shadow-right {
      box-shadow: 8px 0 12px -4px rgba(0, 0, 0, 0.08);
    }
  </style>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const client = createClient(
      'https://sfinbtiqlfnaaarziixu.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaW5idGlxbGZuYWFhcnppaXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MDkxNjEsImV4cCI6MjA2ODA4NTE2MX0.4-7vnIjbF-biWWuv9-vTxK9Y99gMm-vS6oaRMdRL5fA'
    );

    // âœ… ì„¸ì…˜ ì²´í¬: ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í¼ì„ 'í•­ìƒ' ë„ìš°ê³ , ì„±ê³µ ì‹œ ì´ í˜ì´ì§€ ë¡œë“œ
    (async () => {
      try {
        const { data: { session } } = await client.auth.getSession();

        if (!session) {
          // ì•± ë³¸ì²´ ë¡œì§ ì¤‘ë‹¨ í”Œë˜ê·¸
          window.__BLOCK_APP__ = true;

          const $screen = document.getElementById('auth-screen');
          const $email  = document.getElementById('auth-email');
          const $pw     = document.getElementById('auth-password');
          const $login  = document.getElementById('auth-login');
          const $close  = document.getElementById('auth-close');
          const $err    = document.getElementById('auth-error');

          // ë¡œê·¸ì¸ í™”ë©´ ë³´ì´ê¸°
          $screen?.classList.remove('hidden');

          const showError = (msg) => {
            if ($err) {
              $err.textContent = String(msg || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
              $err.classList.remove('hidden');
            }
          };

          // ğŸ” ë¡œê·¸ì¸ ì²˜ë¦¬ í•¨ìˆ˜
          const doLogin = async () => {
            try {
              $login.disabled = true;
              $login.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
              $err?.classList.add('hidden');

              // 1) ì´ë©”ì¼/ë¹„ë²ˆ ë¡œê·¸ì¸
              const { error } = await client.auth.signInWithPassword({
                email: ($email?.value || '').trim(),
                password: ($pw?.value || '').trim()
              });
              if (error) throw error;

              // 2) (ì„ íƒ) ì„¸ì…˜ ë“±ë¡ / í—ˆìš© ê²€ì‚¬  ğŸ‘‰ ì²´ì´ë‹ .catch ì œê±° & try/catch ì‚¬ìš©
              try {
                await client.rpc('register_session', {
                  device_label: (navigator.platform + ' ' + (navigator.vendor || '')).trim(),
                  user_agent: navigator.userAgent
                });
              } catch (_) { /* ignore */ }

              let allowed = true;
              try {
                const { data } = await client.rpc('is_session_allowed');
                if (data === false) allowed = false;
              } catch (_) { /* ì„œë²„ í•¨ìˆ˜ ì—†ìœ¼ë©´ í†µê³¼ */ }

              if (!allowed) {
                await client.auth.signOut();
                throw new Error('í—ˆìš©ëœ ê¸°ê¸° ìˆ˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ë¡œê·¸ì•„ì›ƒ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
              }

              // 3) âœ… ë¦¬ë‹¤ì´ë ‰íŠ¸ë§Œ! (reload ì œê±°)
              location.replace('https://baikuk-map.netlify.app/admin/listings/');

            } catch (e) {
              $err.textContent = e?.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
              $err.classList.remove('hidden');
              $login.disabled = false;
              $login.textContent = 'ë¡œê·¸ì¸';
            }
          };

          // ì´ë²¤íŠ¸ ë°”ì¸ë”©
          $login && ($login.onclick = doLogin);
          $close && ($close.onclick = () => location.replace('https://baikuk.com/map'));
          [$email, $pw].forEach(inp => {
            inp && inp.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') doLogin();
            });
          });

          // ì„¸ì…˜ ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ì¢…ë£Œ (ì•± ë¡œì§ ì‹¤í–‰ ì•ˆ í•¨)
          return;
        }

        // ì„¸ì…˜ì´ ìˆìœ¼ë©´ ì•± ë¡œì§ ì‹¤í–‰ í—ˆìš©
        window.__BLOCK_APP__ = false;
      } catch (e) {
        console.warn('ì„¸ì…˜ í™•ì¸ ì¤‘ ì˜ˆì™¸:', e);
        // ì˜ˆì™¸ ì‹œì—ë„ ë¡œê·¸ì¸ í™”ë©´ ë„ì›Œì„œ ì‚¬ìš©ì ë™ì‘ í—ˆìš©
        window.__BLOCK_APP__ = true;
        document.getElementById('auth-screen')?.classList.remove('hidden');
      }
    })();

    // âœ… ëŒ€ì²´ì•ˆ: 'SIGNED_IN'ì—ì„œë§Œ 1íšŒ ë™ì‘
    client.auth.onAuthStateChange((evt, session) => {
      if (evt === 'SIGNED_IN' && session && !window.__did_redirect__) {
        window.__did_redirect__ = true; // ì¤‘ë³µ ë°©ì§€
        // í•„ìš” ì—†ìœ¼ë©´ ì´ ì¤„ë„ ìƒëµ ê°€ëŠ¥ (ìš°ë¦¬ëŠ” Bì—ì„œ ëª…ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸)
        // location.replace('https://baikuk-map.netlify.app/admin/listings/');
      }
    });

    const formatNumber = val => val != null ? Number(val).toLocaleString('ko-KR') : '-';
    const filterInputs = [
      { key: 'deposit_price', min: 'filter-deposit-min', max: 'filter-deposit-max' },
      { key: 'monthly_rent', min: 'filter-rent-min', max: 'filter-rent-max' },
      { key: 'premium_price', min: 'filter-premium-min', max: 'filter-premium-max' },
      { key: 'area_py', min: 'filter-area-min', max: 'filter-area-max' },
      { key: 'sale_price', min: 'filter-sale-min', max: 'filter-sale-max' },
      { key: 'roi', min: 'filter-roi-min', max: 'filter-roi-max' }
    ];

    // ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ë¶€ë¶„
    // âœ… admin URLì„ í•­ìƒ '/admin' í˜•íƒœë¡œ ë§Œë“¤ì–´ ì£¼ëŠ” í—¬í¼
    function makeAdminUrl(params = {}) {
      const u = new URL('/admin', location.origin);
      Object.entries(params).forEach(([k, v]) => {
        if (v !== undefined && v !== null && v !== '') u.searchParams.set(k, v);
      });
      return u.pathname + u.search + u.hash; // '/admin?id=123' í˜•íƒœ ë°˜í™˜
    }

    // âœ… í˜¹ì‹œ '/admin.html?...'ë¡œ ì§„ì…í•´ë„ í•œ ë²ˆë§Œ '/admin?...'ë¡œ ì •ê·œí™”
    (function normalizeAdminHtmlOnce() {
      if (location.pathname === '/admin.html') {
        const u = new URL(location.href);
        // /admin.html â†’ /admin ë¡œ êµì²´ (ì¿¼ë¦¬/í•´ì‹œ ìœ ì§€)
        const clean = '/admin' + u.search + u.hash;
        // replace: íˆìŠ¤í† ë¦¬ ë‚¨ê¸°ì§€ ì•ŠìŒ, ë¬´í•œë£¨í”„ ë°©ì§€
        location.replace(clean);
      }
    })();


    function bindNumericFilterInputs() {
      filterInputs.forEach(({ key, min, max }) => {
        const minInput = document.getElementById(min);
        const maxInput = document.getElementById(max);
        if (!minInput || !maxInput) {
          console.warn(`í•„í„° ì…ë ¥ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ${min}, ${max}`);
          return;
        }
        const updateFilter = () => {
          let minVal = parseFloat(minInput.value);
          let maxVal = parseFloat(maxInput.value);
          if (key === 'roi') {
            if (!Number.isNaN(minVal)) minVal = minVal / 100; // % â†’ ì†Œìˆ˜
            if (!Number.isNaN(maxVal)) maxVal = maxVal / 100;
          }
          filterConditions[key] = {
            min: Number.isNaN(minVal) ? null : minVal,
            max: Number.isNaN(maxVal) ? null : maxVal
          };
        };
        minInput.addEventListener('blur', updateFilter);
        maxInput.addEventListener('blur', updateFilter);
      });
    }


    filterInputs.forEach(({ key, min, max }) => {
      const minInput = document.getElementById(min);
      const maxInput = document.getElementById(max);

      const updateFilter = () => {
        let minVal = parseFloat(minInput.value);
        let maxVal = parseFloat(maxInput.value);

        // ROIëŠ” % ë‹¨ìœ„ ì…ë ¥ â†’ ì†Œìˆ˜ë¡œ ë³€í™˜
        if (key === 'roi') {
          if (!Number.isNaN(minVal)) minVal = minVal / 100;
          if (!Number.isNaN(maxVal)) maxVal = maxVal / 100;
        }

        filterConditions[key] = {
          min: Number.isNaN(minVal) ? null : minVal,
          max: Number.isNaN(maxVal) ? null : maxVal
        };

        // ëª©ë¡ ì¦‰ì‹œ ë°˜ì˜ (ì›í•˜ë©´ ì£¼ì„ í•´ì œ)
        // const final = applyAllFilters(listings);
        // rerender(final);
      };

      minInput.addEventListener('blur', updateFilter);
      maxInput.addEventListener('blur', updateFilter);
    });

    let listings = [], offset = 0, limit = 300, isLoading = false, hasMore = true;
    let filterConditions = {
      deposit_price: { min: null, max: null }, // âœ… ë³´ì¦ê¸ˆ í•„í„° ì¶”ê°€
      premium_price: { min: null, max: null },
      monthly_rent: { min: null, max: null },
      area_py: { min: null, max: null },
      sale_price: { min: null, max: null },
      roi: { min: null, max: null } // âœ… ROIëŠ” ì†Œìˆ˜ ë‹¨ìœ„
    };


    // ì •ë ¬ ê´€ë ¨ í•¨ìˆ˜
    function sortListingsDefault(list) {
      return list.slice().sort((a, b) => {
        const addrA = (a.full_address || '').trim();
        const addrB = (b.full_address || '').trim();

        if (addrA < addrB) return -1;
        if (addrA > addrB) return 1;

        const floorA = Number(a.floor) || 0;
        const floorB = Number(b.floor) || 0;

        if (floorA < floorB) return -1;
        if (floorA > floorB) return 1;

        const unitA = (a.unit_info || '').trim();
        const unitB = (b.unit_info || '').trim();

        if (unitA < unitB) return -1;
        if (unitA > unitB) return 1;

        return 0;
      });
    }
    
    async function fetchMoreListings() {
      if (isLoading || !hasMore) return;
      isLoading = true;

      const { data: listingsData, error } = await client
        .from('baikukdbtest').select('*')
        .order('created_at', { ascending: false })
        .range(offset, offset + limit - 1);

      if (error) return console.error('âŒ ì˜¤ë¥˜:', error);

      const { data: buildingsData, error: buildingsError } = await client
        .from('building_info').select('addr_compare, building_name');

      if (buildingsError) return console.error('âŒ building_info ì˜¤ë¥˜:', buildingsError);

      const buildingMap = new Map(buildingsData.map(b => [b.addr_compare, b.building_name]));
      const enrichedListings = listingsData.map(listing => ({
        ...listing,
        building_name: buildingMap.get(listing.addr_compare) || '-'
      }));

      listings.push(...enrichedListings);
      if (listingsData.length < limit) hasMore = false;
      offset += listingsData.length;
      renderListings(sortListingsDefault(enrichedListings));
      isLoading = false;
    }

    // í•„í„° ì ìš©í•¨ìˆ˜
    function applyAllFilters(dataToFilter) {
      const selectedDealTypes  = getCheckedValues("deal-type-checkbox");
      const selectedStatuses   = getCheckedValues("transaction-status-checkbox");
      const selectedCategories = getCheckedValues("category-checkbox");

      const normalizeStatus = (raw) => {
        const s = (raw || '').trim();
        if (!s) return '-';
        if (s.includes('ì§„í–‰ì¤‘'))   return 'ì§„í–‰ì¤‘';
        if (s.includes('ë³´ë¥˜'))     return 'ë³´ë¥˜';
        if (s.includes('ê³„ì•½ì™„ë£Œ')) return 'ê³„ì•½ì™„ë£Œ';
        return '-';
      };

      return dataToFilter.filter(listing => {
        // ìˆ«ì í•„í„°
        const numericMatch = Object.entries(filterConditions).every(([key, { min, max }]) => {
          const value = parseFloat(listing[key]);
          if (Number.isNaN(value)) return true;
          if (min != null && value < min) return false;
          if (max != null && value > max) return false;
          return true;
        });

        // ì²´í¬ë°•ìŠ¤ í•„í„°
        const matchDealType = selectedDealTypes.length === 0 
          || selectedDealTypes.includes(listing.deal_type);

        const normStatus = normalizeStatus(listing.transaction_status);
        const matchStatus = selectedStatuses.length === 0 
          || selectedStatuses.includes(normStatus);

        const matchCategory = selectedCategories.length === 0 
          || selectedCategories.includes(listing.category || '-');

        return numericMatch && matchDealType && matchStatus && matchCategory;
      });
    }

    // ì¹´í…Œê³ ë¦¬ ì„ íƒì‹œ íœ  ì—†ì–´ì§€ë©´ ì¶”ê°€ë¡œ ë§¤ë¬¼ë¡œë”© ê´€ë ¨í•¨ìˆ˜
    function checkAndFetchIfNoScroll() {
      const container = document.getElementById('table-container');
      // ìŠ¤í¬ë¡¤ì´ ìƒê¸°ì§€ ì•Šì„ ê²½ìš° ìë™ìœ¼ë¡œ fetchMoreListings í˜¸ì¶œ
      if (container.scrollHeight <= container.clientHeight && hasMore) {
        fetchMoreListings();
      }
    }

    const headerRow = document.getElementById('header-row');

    async function serverSearch(idTerm, titleTerm, addressTerm, buildingTerm) {
      console.log("ğŸ” ê²€ìƒ‰ ì‹¤í–‰ë¨:", { idTerm, titleTerm, addressTerm, buildingTerm });

      listings = [];
      offset = 0;
      hasMore = false;

      // Step 1: ê±´ë¬¼ëª… â†’ addr_compare ë§¤í•‘
      let matchedAddresses = [];
      if (buildingTerm) {
        const { data: matchedBuildings, error: buildingError } = await client
          .from('building_info')
          .select('addr_compare')
          .ilike('building_name', `%${buildingTerm}%`);
        if (buildingError) {
          console.error('âŒ building_name ê²€ìƒ‰ ì˜¤ë¥˜:', buildingError);
          return;
        }
        matchedAddresses = matchedBuildings.map(b => b.addr_compare);
      }

      // Step 2: ë§¤ë¬¼ í…Œì´ë¸” ì¡°ê±´ë³„ ê²€ìƒ‰
      let query = client.from('baikukdbtest').select('*').limit(1000);

      if (idTerm && !isNaN(parseInt(idTerm))) {
        query = query.eq('listing_id', parseInt(idTerm));
      }
      if (titleTerm) query = query.ilike('listing_title', `%${titleTerm}%`);
      if (addressTerm) query = query.ilike('full_address', `%${addressTerm}%`);
      if (buildingTerm && matchedAddresses.length > 0) {
        query = query.in('addr_compare', matchedAddresses);
      }

      const { data: listingsData, error: listingsError } = await query;
      if (listingsError) {
        console.error('âŒ ë§¤ë¬¼ ê²€ìƒ‰ ì˜¤ë¥˜:', listingsError);
        return;
      }

      // Step 3: building_name ë³‘í•©
      const { data: buildingsData, error: buildingsAllError } = await client
        .from('building_info')
        .select('addr_compare, building_name');
      if (buildingsAllError) {
        console.error('âŒ ë³‘í•©ìš© building_info ì˜¤ë¥˜:', buildingsAllError);
        return;
      }

      const buildingMap = new Map(buildingsData.map(b => [b.addr_compare, b.building_name]));
      const enrichedData = listingsData.map(listing => ({
        ...listing,
        building_name: buildingMap.get(listing.addr_compare) || '-'
      }));

      listings = enrichedData;
      document.getElementById('listings-body').innerHTML = '';
      renderListings(sortListingsDefault(enrichedData));
      return enrichedData;
    }

    function renderListings(data) {
      const tbody = document.getElementById('listings-body');
      data.forEach(listing => {
        const row = document.createElement('tr');
        row.dataset.listingId = listing.listing_id; // âœ… í´ë¦­ìš© ID ì €ì¥
        row.className = 'border-b border-gray-300 bg-white hover:bg-gray-50 cursor-pointer';

        row.innerHTML = `
          <td class="p-2 text-base font-bold whitespace-normal w-[4rem] ">
            <span>${listing.listing_id}</span>
          </td>
          <td class="flex flex-col p-2 text-base text-right whitespace-nowrap">
            <div style="
              ${(listing.transaction_status || '').includes('ì§„í–‰ì¤‘') 
                ? 'background-color: #d9fae6; color: #00b74a; font-weight: bold;' 
                : (listing.transaction_status || '').includes('ë³´ë¥˜') 
                  ? 'background-color: #e5e7eb; color: #000000; font-weight: bold;'
                  : (listing.transaction_status || '').includes('ê³„ì•½ì™„ë£Œ') 
                    ? 'background-color: rgba(255,237,237); color: rgba(247,63,87); font-weight: 900;' 
                    : 'background-color: #e5e7eb; color: #374151;'}
              padding: 2px 8px; 
              border-radius: 8px; 
              display: inline-block;
              font-size: 0.8rem;
              text-align: center;
              margin-top: 0.25rem;
            ">
              ${(listing.transaction_status || '').includes('ì§„í–‰ì¤‘') 
                ? 'ì§„í–‰ì¤‘' 
                : (listing.transaction_status || '').includes('ë³´ë¥˜') 
                  ? 'ë³´ë¥˜' 
                  : (listing.transaction_status || '').includes('ê³„ì•½ì™„ë£Œ') 
                    ? 'ê³„ì•½ì™„ë£Œ' 
                    : '-'}
            </div>
            <div style="
              ${listing.is_public 
                ? 'background-color: #ffffff; color: #00b74a; font-weight: bold; border: 1.5px solid #00b74a; border-radius: 9999px;'   /* ê³µê°œ: ì´ˆë¡ pill */
                : 'background-color: #ffffff; color: rgba(247,63,87); font-weight: 900; border: 1.5px solid rgba(247,63,87); border-radius: 9999px;' /* ë¹„ê³µê°œ: ë¹¨ê°• pill */
              }
              padding: 2px 12px; 
              display: inline-block;
              font-size: 0.8rem;
              text-align: center;
              margin-top: 0.25rem;
            ">
              ${listing.is_public ? 'ê³µê°œ' : 'ë¹„ê³µê°œ'}
            </div>
          </td>
          <td class="p-2 font-bold text-lg whitespace-normal break-words">
            <span>${listing.listing_title || '-'}</span>
          </td>
          <td class="p-2 text-left text-base w-[10rem]">${listing.province} ${listing.city} ${listing.district} ${listing.detail_address}</td>
          <td class="p-2 text-left text-[1.05rem] w-[12rem] overflow-x-auto whitespace-nowrap">${listing.building_name}</td>
          <td class="p-2 text-base"><div id="scroll-cell-${listing.listing_id}" class="max-w-[6rem] overflow-x-auto whitespace-nowrap">${listing.unit_info || '-'}</div></td>
          <td class="p-2 text-right text-base">${formatNumber(listing.floor)}ì¸µ</td>
          <td class="p-2 text-right text-lg whitespace-nowrap">${formatNumber(listing.deposit_price)}</td>
          <td class="p-2 text-right text-lg whitespace-nowrap">${formatNumber(listing.monthly_rent)}</td>
          <td class="p-2 text-right text-lg whitespace-nowrap">${formatNumber(listing.premium_price)}</td>
          <td class="p-2 text-right text-lg whitespace-nowrap">${listing.area_py != null ? Number(listing.area_py).toFixed(0) : '-'}í‰</td>
          <td class="p-2 text-right text-base"><div>${listing.supply_area_m2 != null ? Number(listing.supply_area_m2).toFixed(2) : '-'}ã¡</div><div>${listing.area_m2 != null ? Number(listing.area_m2).toFixed(2) : '-'}ã¡</div></td>
          <td class="p-2 text-right text-lg">${formatNumber(listing.sale_price)}</td>
          <td class="p-2 text-right text-lg">${formatNumber(listing.total_deposit)}</td>
          <td class="p-2 text-right text-lg">${formatNumber(listing.total_rent)}</td>
          <td class="p-2 text-right text-lg">${listing.roi != null ? (Number(listing.roi) * 100).toFixed(1) + '%' : '-'}</td>
          <td class="p-2">${listing.store_category || '-'}</td>`;
        tbody.appendChild(row);

        requestAnimationFrame(() => {
          const scrollDiv = document.getElementById(`scroll-cell-${listing.listing_id}`);
          if (scrollDiv) scrollDiv.scrollLeft = scrollDiv.scrollWidth;
        });
      });

      // âœ… ë Œë”ë§ í›„, ìŠ¤í¬ë¡¤ ë¶€ì¡± ì‹œ ìë™ ë¡œë”©
      checkAndFetchIfNoScroll();
    }

    function setupScrollTrigger() {
      const tableContainer = document.getElementById('table-container');
      tableContainer.addEventListener('scroll', () => {
        const nearBottom = tableContainer.scrollTop + tableContainer.clientHeight >= tableContainer.scrollHeight - 100;
        if (nearBottom) fetchMoreListings();
      });
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      if (window.__BLOCK_APP__) return; // ğŸ”’ ë¡œê·¸ì¸ ì „ì—ëŠ” ì•± ë¡œì§ ì°¨ë‹¨
      fetchMoreListings();
      setupScrollTrigger();
      bindNumericFilterInputs(); 

      // âœ… í•„í„° UI ì´ˆê¸°ê°’ ì„¤ì •
      document.querySelector('input.deal-type-checkbox[value="ì›”ì„¸"]').checked = true;
      document.querySelector('input.category-checkbox[value="ìƒê°€"]').checked = true;

      // ê²€ìƒ‰ ì…ë ¥ ìš”ì†Œë“¤
      const searchButton = document.getElementById('search-button');
      const idInput = document.getElementById('id-input');
      const titleInput = document.getElementById('title-input');
      const addressInput = document.getElementById('address-input');
      const buildingInput = document.getElementById('building-input');

      // âœ… ìš”ì†Œê°€ ëª¨ë‘ ìˆëŠ” ê²½ìš°ì—ë§Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      if (searchButton && idInput && titleInput && addressInput && buildingInput) {
        searchButton.addEventListener('click', async () => {
          // âœ… ìˆ«ì ì¡°ê±´ ìµœì‹ í™”
          filterInputs.forEach(({ key, min, max }) => {
            const minVal = parseFloat(document.getElementById(min).value);
            const maxVal = parseFloat(document.getElementById(max).value);
            filterConditions[key] = {
              min: isNaN(minVal) ? null : minVal,
              max: isNaN(maxVal) ? null : maxVal
            };
          });

          const idTerm = idInput.value.trim();
          const titleTerm = titleInput.value.trim();
          const addressTerm = addressInput.value.trim();
          const buildingTerm = buildingInput.value.trim();

          const baseFiltered = await serverSearch(idTerm, titleTerm, addressTerm, buildingTerm);
          const finalFiltered = applyAllFilters(baseFiltered);

          document.getElementById('listings-body').innerHTML = '';
          renderListings(sortListingsDefault(finalFiltered));
        });

        // âœ… Enter í‚¤ ëˆŒë €ì„ ë•Œ ê²€ìƒ‰
        [idInput, titleInput, addressInput, buildingInput].forEach(input => {
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') searchButton.click();
          });
        });
      } else {
        console.error('âŒ ê²€ìƒ‰ ì…ë ¥ í•„ë“œ ì¤‘ í•˜ë‚˜ ì´ìƒì´ DOMì— ì—†ìŠµë‹ˆë‹¤.');
      }

      // âœ… í…Œì´ë¸” í—¤ë” ì—´ í¬ê¸° ì¡°ì ˆ
      const table = document.querySelector('table');
      if (table) {
        const headers = table.querySelectorAll('th');
        headers.forEach(th => {
          th.classList.add('resizable');

          const handle = document.createElement('div');
          handle.classList.add('resize-handle');
          th.appendChild(handle);

          handle.addEventListener('mousedown', function (e) {
            e.preventDefault();
            const startX = e.pageX;
            const startWidth = th.offsetWidth;
            th.classList.add('resizing');

            const onMouseMove = e => {
              th.style.width = `${startWidth + (e.pageX - startX)}px`;
            };

            const onMouseUp = () => {
              th.classList.remove('resizing');
              document.removeEventListener('mousemove', onMouseMove);
              document.removeEventListener('mouseup', onMouseUp);
            };

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
          });
        });
      }

      // âœ… í–‰ í´ë¦­ â†’ /<ë§¤ë¬¼ë²ˆí˜¸> ë¡œ ì´ë™ (Ctrl/âŒ˜-í´ë¦­ ë˜ëŠ” íœ í´ë¦­ì€ ìƒˆ íƒ­)
      const tbody = document.getElementById('listings-body');

      // function goToListing(id) { ë‚˜ì¤‘ì— ì´ë™ë§í¬ ìˆ˜ì •
      //   const href = makeAdminUrl({ id: String(id) }); // âœ… '/admin?id=24873'
      //   window.open(href, '_blank', 'noopener,noreferrer');
      // }

      function goToListing(id) {
        const href = `https://baikuk.com/item/view/${id}`;
        window.open(href, '_blank', 'noopener,noreferrer');
      }

      tbody.addEventListener('click', (e) => {
        // ì¸í„°ë™í‹°ë¸Œ ìš”ì†Œ í´ë¦­ ì‹œì—” í–‰ ë„¤ë¹„ê²Œì´ì…˜ ë§‰ê¸°
        if (e.target.closest('input, button, label, a, select, textarea')) return;

        const tr = e.target.closest('tr[data-listing-id]');
        if (!tr) return;

        goToListing(tr.dataset.listingId);
      });

      // (ì„ íƒ) ì¤‘í´ë¦­ í•¸ë“¤ëŸ¬ê°€ ìˆë‹¤ë©´, ì•„ë˜ì²˜ëŸ¼ ì¸í„°ë™í‹°ë¸Œ ìš”ì†ŒëŠ” ë¬´ì‹œí•˜ë„ë¡ ë³´ì •
      tbody.addEventListener('auxclick', (e) => {
        if (e.button !== 1) return;
        if (e.target.closest('input, button, label, a, select, textarea')) return; // âœ… aì—ì„œì˜ ì¤‘í´ë¦­ ì¤‘ë³µë°©ì§€
        const tr = e.target.closest('tr[data-listing-id]');
        if (!tr) return;
        goToListing(tr.dataset.listingId);
      });

      // âœ… ê³„ì •ì •ë³´ í‘œì‹œ + 'ì •ì‚°' íƒ­ ê¶Œí•œ ì œì–´(ê´€ë¦¬ì/ì§€ì ì¥ë§Œ ë…¸ì¶œ)
      (async () => {
        try {
          const { data: { user } } = await client.auth.getUser();
          if (!user?.id) return;

          // 1) ê³„ì •ì •ë³´(public_staff_view) & ê¶Œí•œ(staff_profiles) ë³‘ë ¬ ì¡°íšŒ
          const email = user.email || '';
          const [staffRes, authRes] = await Promise.all([
            client.from('public_staff_view')
                  .select('name,email,affiliation,position,extension')
                  .eq('email', email)
                  .maybeSingle(),
            client.from('staff_profiles')
                  .select('authority')
                  .eq('user_id', user.id)
                  .maybeSingle()
          ]);

          // 2) ìƒë‹¨ ê³„ì •ì •ë³´ ë Œë” (ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ì´ë©”ì¼ë§Œ í‘œì‹œ)
          const staff = staffRes?.data;
          const hasStaff = !!staff && !staffRes.error;

          const $name        = document.getElementById('account-name');
          const $email       = document.getElementById('account-email');
          const $affiliation = document.getElementById('account-affiliation');
          const $position    = document.getElementById('account-position');
          const $extension   = document.getElementById('account-extension');

          if ($name)        $name.textContent        = hasStaff ? (staff.name || '') : (user.email || '');
          if ($email)       $email.textContent       = hasStaff ? (staff.email || email || '') : (user.email || '');
          if ($affiliation) $affiliation.textContent = hasStaff ? (staff.affiliation || '') : '';
          if ($position)    $position.textContent    = hasStaff ? (staff.position || '') : '';
          if ($extension)   $extension.textContent   = hasStaff ? (staff.extension || '') : '';

          // 3) 'ì •ì‚°' íƒ­ ê¶Œí•œ ì œì–´
          const authority = (authRes?.data?.authority || '').trim();
          const tab = document.getElementById('settlement-tab');
          if (!tab) return;

          // ì§ì› í´ë¦­ ê°€ë“œ
          const guardClick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            alert('ì§ì› ê¶Œí•œì€ ì •ì‚° ë©”ë‰´ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          };

          if (authority === 'ì§ì›') {
            // ì§ì›: ìˆ¨ê¹€ + í´ë¦­ ê°€ë“œ(í˜¹ì‹œ ë³´ì´ë”ë¼ë„ ì ‘ê·¼ ì°¨ë‹¨)
            tab.style.display = 'none';
            tab.removeEventListener('click', guardClick);
            tab.addEventListener('click', guardClick);
          } else {
            // ê´€ë¦¬ì/ì§€ì ì¥: ë…¸ì¶œ + ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”(ê°€ë“œ ì œê±°)
            tab.style.removeProperty('display');
            const clean = tab.cloneNode(true);
            tab.replaceWith(clean);
          }
        } catch (e) {
          console.warn('ê³„ì •/ê¶Œí•œ ì¡°íšŒ ì¤‘ ì˜ˆì™¸:', e);
          // ì‹¤íŒ¨í•´ë„ ì•± ì§„í–‰ì€ ë§‰ì§€ ì•ŠìŒ
        }
      })();

      document.getElementById('logout-btn')?.addEventListener('click', async () => {
        await client.auth.signOut();
        // ë¡œê·¸ì•„ì›ƒ í›„ ë¡œê·¸ì¸ í™”ë©´(ë˜ëŠ” ë©”ì¸ ì§€ë„)ìœ¼ë¡œ ì´ë™
        location.replace('/admin/listings/');
      });
      // ë¡œê·¸ì¸ ê³„ì •ì •ë³´ í‘œì‹œ ë° ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ 
    });

    document.getElementById('open-admin-listing-btn')?.addEventListener('click', () => {
      const href = makeAdminUrl({ autoclick: 'open-listing' });
      window.open(href, '_blank', 'noopener,noreferrer');
    });

    function getCheckedValues(className) {
      return Array.from(document.querySelectorAll(`.${className}:checked`)).map(el => el.value);
    }

  </script>
</head>
<body class="h-screen w-screen">
  <!-- ğŸ” ë¡œê·¸ì¸ ì „ì²´ í™”ë©´ -->
  <div id="auth-screen" class="fixed inset-0 z-[99999] hidden">
    <div class="w-full h-full flex items-center justify-center bg-gray-100">
      <div class="bg-white w-[22rem] rounded-xl shadow-xl p-6">
        <h2 class="text-xl font-bold text-center mb-4">ì§ì› ë¡œê·¸ì¸</h2>
        <input id="auth-email" type="email" placeholder="ì´ë©”ì¼"
               class="w-full border border-gray-300 rounded px-3 py-2 mb-2" />
        <input id="auth-password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"
               class="w-full border border-gray-300 rounded px-3 py-2 mb-3" />
        <button id="auth-login"
                class="w-full bg-blue-600 text-white py-2 rounded font-semibold hover:bg-blue-700">
          ë¡œê·¸ì¸
        </button>
        <button id="auth-close"
                class="w-full mt-2 border border-gray-300 text-gray-600 py-2 rounded hover:bg-gray-50">
          ë‹«ê¸°
        </button>
        <div id="auth-error" class="text-red-600 text-sm mt-3 hidden"></div>
      </div>
    </div>
  </div>
  <div class="absolute top-0 left-0 z-[9998] bg-white w-[13rem] h-[60px] rounded-xl">
    <img src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/logotype-baikuk.png"
        alt="ê¸€ì”¨ë¡œê³ "
        class="absolute h-11 w-auto cursor-pointer top-2 left-2 z-[9999]"
        onclick="location.reload()"/>
  </div>
  <div class="flex h-full">    
    <div class="w-[6%] pt-[5rem] shadow-right text-center bg-white">
      <a href="https://baikuk.com/map" target="_blank">
        <div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">ë°±ì–µì§€ë„</div>
      </a>
      <a href="/admin/listings/"><div class="bg-gray-100 border-l-4 border-gray-500 text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë§¤ë¬¼ì¥ë¶€</div></a>
      <a href="/admin/recommend_imDae/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ì„ëŒ€ì¶”ì²œ</div></a>
      <a href="/admin/recommend_maeMae/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë§¤ë§¤ì¶”ì²œ</div></a>
      <a href="/admin/customer_manage/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">ëª¨ë“ ê³ ê°</div></a>
      <a href="/admin/ad_censorship/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ê´‘ê³ ê´€ë¦¬</div></a>
      <a href="/admin/staff_manage/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ì§ì›ì •ë³´</div></a>
      <a href="/admin/performance/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë§¤ì¶œ</div></a>
      <a href="/admin/cost_management/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë¹„ìš©ê´€ë¦¬</div></a>
      <a id="settlement-tab" href="/admin/settlement/" style="display:none">
        <div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">ì •ì‚°</div>
      </a>
    </div>
    <div class="w-[94%] flex flex-col bg-gray-50">
      <div class="flex gap-4 items-start bg-gray-100"> <!-- í•„í„° ì˜ì—­ (ìƒë‹¨ 10%) -->
        <div class="flex flex-col w-[37%] mt-2">
          <div class="flex ml-[6.7rem] gap-3">
            <!-- ê³„ì •ì •ë³´ + ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
            <div id="account-info" class="flex items-center justify-between bg-gray-200 rounded px-3 py-2 mb-2 text-sm text-gray-700 gap-4">
              <div class="flex flex-row flex-wrap items-center gap-2 text-sm text-gray-700">
                <span id="account-affiliation" class="text-xs text-gray-600"></span>
                <span id="account-position" class="text-xs text-gray-600"></span>
                <span id="account-name" class="font-semibold"></span>
                <span id="account-extension" class="text-xs text-gray-600"></span>
                <span id="account-email" class="text-xs text-gray-600"></span>
              </div>
              <button id="logout-btn" class="text-xs text-red-600 hover:underline">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <button id="open-admin-listing-btn" class="hidden text-sm bg-blue-400 text-white rounded hover:bg-blue-600 rounded ml-auto px-3 py-1 leading-none h-[1.7rem]">ğŸ¢ ë§¤ë¬¼ë“±ë¡</button>  
          </div>      
          <div class="w-[100%] p-4 bg-gray-100 flex items-center gap-2">
            <input type="text" id="id-input" placeholder="ë§¤ë¬¼ë²ˆí˜¸" class="border px-1.5 py-1 rounded w-[14%]" />
            <input type="text" id="title-input" placeholder="ë§¤ë¬¼ëª…" class="border px-1.5 py-1 rounded w-[27%]" />
            <input type="text" id="address-input" placeholder="ì£¼ì†Œ" class="border px-1.5 py-1 rounded w-[23%]" />
            <input type="text" id="building-input" placeholder="ê±´ë¬¼ëª…" class="border px-1.5 py-1 rounded w-[22%]" />
            <button id="search-button" class="bg-blue-400 text-white px-3 py-1 rounded hover:bg-blue-600 w-[10%]">ê²€ìƒ‰</button>
          </div>
        </div>
        <!-- í•„í„° ì…ë ¥ì°½ ì˜ì—­ -->
        <div id="fixed-filter-box2" class="bg-gray-100 px-4 pt-2 pb-4">
          <!-- ì œëª©ì¤„ -->
          <div class="flex gap-4 font-semibold text-sm text-gray-700 mb-1">
            <div class="w-[6rem] text-center">ë³´ì¦ê¸ˆ</div>
            <div class="w-[5rem] text-center">ì›”ì„¸</div>
            <div class="w-[6rem] text-center">ê¶Œë¦¬ê¸ˆ</div>
            <div class="w-[4rem] text-center">ì „ìš©(í‰)</div>
            <div class="w-[6rem] text-center">ë§¤ë§¤ê°€</div>
            <div class="w-[4rem] text-center">ìˆ˜ìµë¥ </div>
          </div>

          <!-- ì´ìƒ ì…ë ¥ì°½ -->
          <div class="flex gap-4 mb-1">
            <input id="filter-deposit-min" type="number" placeholder="ì´ìƒ" class="border rounded px-2 py-1 w-[6rem]" />
            <input id="filter-rent-min" type="number" placeholder="ì´ìƒ" class="border rounded px-2 py-1 w-[5rem]" />
            <input id="filter-premium-min" type="number" placeholder="ì´ìƒ" class="border rounded px-2 py-1 w-[6rem]" />
            <input id="filter-area-min" type="number" placeholder="ì´ìƒ" class="border rounded px-2 py-1 w-[4rem]" />
            <input id="filter-sale-min" type="number" placeholder="ì´ìƒ" class="border rounded px-2 py-1 w-[6rem]" />
            <input id="filter-roi-min" type="number" placeholder="ì´ìƒ" class="border rounded px-2 py-1 w-[4rem]" />
          </div>

          <!-- ì´í•˜ ì…ë ¥ì°½ -->
          <div class="flex gap-4">
            <input id="filter-deposit-max" type="number" placeholder="ì´í•˜" class="border rounded px-2 py-1 w-[6rem]" />
            <input id="filter-rent-max" type="number" placeholder="ì´í•˜" class="border rounded px-2 py-1 w-[5rem]" />
            <input id="filter-premium-max" type="number" placeholder="ì´í•˜" class="border rounded px-2 py-1 w-[6rem]" />
            <input id="filter-area-max" type="number" placeholder="ì´í•˜" class="border rounded px-2 py-1 w-[4rem]" />
            <input id="filter-sale-max" type="number" placeholder="ì´í•˜" class="border rounded px-2 py-1 w-[6rem]" />
            <input id="filter-roi-max" type="number" placeholder="ì´í•˜" class="border rounded px-2 py-1 w-[4rem]" />
          </div>
        </div>
          <!-- í•„í„° ì…ë ¥ì°½ ì˜ì—­ -->
          <div id="fixed-filter-box" class="h-[3.45rem] bg-gray-100 px-4 pt-2 pb-4 flex gap-7">
            <!-- ê±°ë˜ìœ í˜• -->
            <div>
              <div class="font-semibold mb-1">ê±°ë˜ìœ í˜•</div>
              <label class="block"><input type="checkbox" class="deal-type-checkbox" value="ì›”ì„¸" /> ì›”ì„¸</label>
              <label class="block"><input type="checkbox" class="deal-type-checkbox" value="ë§¤ë§¤" /> ë§¤ë§¤</label>
            </div>

            <!-- ê±°ë˜ì™„ë£Œ -->
            <div>
              <div class="font-semibold mb-1">ê±°ë˜ìƒíƒœ</div>
              <label class="block"><input type="checkbox" class="transaction-status-checkbox" value="ì§„í–‰ì¤‘" /> ì§„í–‰ì¤‘</label>
              <label class="block"><input type="checkbox" class="transaction-status-checkbox" value="ë³´ë¥˜" /> ë³´ë¥˜</label>
              <label class="block"><input type="checkbox" class="transaction-status-checkbox" value="ê³„ì•½ì™„ë£Œ" /> ê³„ì•½ì™„ë£Œ</label>
            </div>

            <!-- ëŒ€ë¶„ë¥˜ -->
            <div class="flex flex-col items-center">
              <div class="font-semibold mb-1">ëŒ€ë¶„ë¥˜</div>
              <div>
                <div class="flex gap-2">
                  <div>
                    <label class="block"><input type="checkbox" class="category-checkbox" value="ìƒê°€" /> ìƒê°€</label>
                    <label class="block"><input type="checkbox" class="category-checkbox" value="ë¹Œë”©" /> ë¹Œë”©</label>
                  </div>
                  <div>
                    <label class="block"><input type="checkbox" class="category-checkbox" value="ì£¼íƒ" /> ì£¼íƒ</label>
                    <label class="block"><input type="checkbox" class="category-checkbox" value="í† ì§€" /> í† ì§€</label>
                  </div>
                </div>
                <label class="block"><input type="checkbox" class="category-checkbox" value="ê³µì¥Â·ì°½ê³ " /> ê³µì¥Â·ì°½ê³ </label>
              </div>
            </div>
          </div>
      </div>
      <div class="px-4 bg-gray-100">
        <div class="px-4 py-4 bg-white border border-gray-300 rounded-md">
          <div id="table-container" class="h-[83vh] overflow-y-auto custom-scroll bg-whiteborderrounded-md">
            <table class="w-full table-fixed text-sm text-left bg-white">
              <thead class="bg-gray-100 sticky top-0 z-10">
                <tr id="header-row">
                  <th class="p-2 border-r text-sm text-center w-[4.54rem]">ë§¤ë¬¼ë²ˆí˜¸</th>
                  <th class="p-2 border-r text-sm text-center w-[5rem]">ìƒíƒœ</th>
                  <th class="resizable p-2 border-r text-sm text-center w-[16rem]">ë§¤ë¬¼ëª…<div class="resize-handle"></div></th>
                  <th class="p-2 border-r text-sm text-center w-[10.5rem]">ì£¼ì†Œ</th>
                  <th class="p-2 border-r text-sm text-center w-[9rem]">ê±´ë¬¼ì •ë³´</th>
                  <th class="p-2 border-r text-sm text-center">í˜¸ìˆ˜</th>
                  <th class="p-2 border-r text-sm text-center w-[3rem]">ì¸µ</th>
                  <th class="p-2 border-r text-sm text-center">ë³´ì¦ê¸ˆ</th>
                  <th class="p-2 border-r text-sm text-center">ì›”ì„¸</th>
                  <th class="p-2 border-r text-sm text-center">ê¶Œë¦¬ê¸ˆ</th>
                  <th class="p-2 border-r text-sm text-center min-w-[4.5rem]">ì „ìš©(í‰)</th>
                  <th class="p-2 border-r text-sm text-center w-[6.5rem]">ê³µê¸‰/ì „ìš©(ã¡)</th>
                  <th class="p-2 border-r text-sm text-center">ë§¤ë§¤ê°€</th>
                  <th class="p-2 border-r text-sm text-center min-w-[1rem]">ì´ë³´ì¦ê¸ˆ</th>
                  <th class="p-2 border-r text-sm text-center">ì´ì›”ì„¸</th>
                  <th class="p-2 border-r text-sm text-center">ìˆ˜ìµë¥ </th>
                  <th class="p-2 border-r text-sm text-center">ìƒê°€íƒ€ì…</th>
                </tr>
              </thead>
              <tbody id="listings-body" class="bg-white"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
