<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ëª¨ë“ ê³ ê°</title>
  <link rel="icon" type="image/png" href="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/pabicon-baikuk-simbol.png" />
  <link rel="preconnect" href="https://sfinbtiqlfnaaarziixu.supabase.co" crossorigin>
  <link rel="dns-prefetch" href="//sfinbtiqlfnaaarziixu.supabase.co">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .shadow-right { box-shadow: 8px 0 12px -4px rgba(0, 0, 0, 0.08); }
    .slide-panel { transition: transform 0.3s ease-in-out; }
    .slide-panel.hidden { transform: translateX(100%); }
    .slide-panel.visible { transform: translateX(0%); }
  </style>

  <script type="module">
    // ================== ì „ì—­ ìƒíƒœ ==================
    let currentSortField = null;
    let currentSortOrder = 'desc';
    let selectedCustomerId = null;
    let currentStaffId = null;
    let selectedIsOwner = false;
    let myAuth = '';   // 'ê´€ë¦¬ì' | 'ì§€ì ì¥' | 'ì§ì›' | ''
    let myAff  = '';
    let selectedCanEdit = false;
    let __toastTimer = null;

    // ë‹´ë‹¹ì(ëŒ€í‘œ/ë³´ì¡°)
    let selectedAssigneeId  = null; // ëŒ€í‘œ
    let selectedAssigneeId2 = null; // ë³´ì¡°

    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(
      'https://sfinbtiqlfnaaarziixu.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaW5idGlxbGZuYWFhcnppaXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MDkxNjEsImV4cCI6MjA2ODA4NTE2MX0.4-7vnIjbF-biWWuv9-vTxK9Y99gMm-vS6oaRMdRL5fA'
    );

    // ================== ê¶Œí•œë³„ 'ì´ë¦„ ê°€ë¦¼' ê·œì¹™ ==================
    // member: { id, name, affiliation, leave_date }
    function shouldHideStaffName(member, viewerRole, viewerAff) {
      if (!member) return false;
      const isLeaver = !!member.leave_date;           // leave_dateê°€ NULL ì•„ë‹Œ ê²½ìš° â†’ í‡´ì‚¬ì
      if (viewerRole === 'ê´€ë¦¬ì') return false;      // ê´€ë¦¬ìëŠ” ëª¨ë‘ í‘œì‹œ
      if (viewerRole === 'ì§ì›') return isLeaver;     // ì§ì›ì€ í‡´ì‚¬ì ëª¨ë‘ ìˆ¨ê¹€
      if (viewerRole === 'ì§€ì ì¥') {
        const sameBranch = (member.affiliation || '').trim() === (viewerAff || '').trim();
        // ì§€ì ì¥ì€ ë³¸ì¸ì§€ì ì€ ì „ë¶€ í‘œì‹œ, íƒ€ì§€ì ì€ í‡´ì‚¬ìë§Œ ìˆ¨ê¹€
        return !sameBranch && isLeaver;
      }
      return false;
    }
    function maskNameForViewer(member, viewerRole, viewerAff) {
      if (!member) return '-';
      return shouldHideStaffName(member, viewerRole, viewerAff) ? '-' : (member.name || '-');
    }

    // ================== ìœ í‹¸/í† ìŠ¤íŠ¸ ==================
    function calcToastDuration(message, base = 5000) {
      return Math.max(base, Math.min(12000, 1000 + message.length * 80));
    }
    function showToast(message, duration = 3000) {
      const toast = document.getElementById('toast');
      if (!toast) return;
      if (__toastTimer) { clearTimeout(__toastTimer); __toastTimer = null; }
      toast.textContent = message;
      toast.className =
        'fixed top-5 left-1/2 transform -translate-x-1/2 ' +
        'px-4 py-2 rounded shadow-lg z-[9999] ' +
        'max-w-[80vw] min-w-[16rem] text-center break-words whitespace-pre-line ' +
        'bg-yellow-300 text-black font-bold';
      toast.classList.remove('hidden');
      const autoDuration = Math.max(duration, Math.min(12000, 1000 + message.length * 80));
      __toastTimer = setTimeout(() => { toast.classList.add('hidden'); __toastTimer = null; }, autoDuration);
    }
    function setPhoneInputMode(isOwner) {
      const el = document.getElementById('customer-phone');
      if (!el) return;
      if (isOwner) { el.placeholder = 'ì „í™”ë²ˆí˜¸(ì „ì²´)'; el.removeAttribute('maxLength'); }
      else { el.placeholder = 'ì „í™”ë²ˆí˜¸(ë 4ìë¦¬ë§Œ)'; el.maxLength = 4; el.value = (el.value || '').replace(/\D/g,'').slice(-4); }
    }
    function formatPhoneForView(value) {
      const s = (value || '').replace(/\D/g, '');
      if (s.length === 11) return `${s.slice(0,3)}-${s.slice(3,7)}-${s.slice(7)}`;
      if (s.length === 10) { if (s.startsWith('02')) return `02-${s.slice(2,6)}-${s.slice(6)}`; return `${s.slice(0,3)}-${s.slice(3,6)}-${s.slice(6)}`; }
      if (s.length === 9 && s.startsWith('02')) return `02-${s.slice(2,5)}-${s.slice(5)}`;
      return value || '-';
    }
    function buildOption(el, value, label, selected=false, disabled=false) {
      const opt = document.createElement('option');
      opt.value = value;
      opt.textContent = label;
      if (selected) opt.selected = true;
      if (disabled) opt.disabled = true;
      el.appendChild(opt);
    }
    // ì§€ì (affiliation)ë³„ë¡œ ë¬¶ê¸° + ì •ë ¬ (ë‚´ ì§€ì  ìš°ì„ )
    function groupStaffByAffiliation(rows, myAff) {
      const groups = new Map();
      for (const r of rows) {
        const key = (r.affiliation || '(ì†Œì†ì—†ìŒ)').trim();
        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push(r);
      }
      // ê·¸ë£¹ ìˆœì„œ: ë‚´ ì§€ì  ë¨¼ì €, ê·¸ ë‹¤ìŒ ê°€ë‚˜ë‹¤
      const ordered = Array.from(groups.entries()).sort((a, b) => {
        const aKey = a[0], bKey = b[0];
        const aPri = (aKey === myAff) ? 0 : 1;
        const bPri = (bKey === myAff) ? 0 : 1;
        if (aPri !== bPri) return aPri - bPri;
        return aKey.localeCompare(bKey, 'ko-KR', { sensitivity: 'base', numeric: true });
      });
      // ê° ê·¸ë£¹ ë‚´ë¶€ëŠ” ì´ë¦„ìˆœ
      for (const [, arr] of ordered) {
        arr.sort((x, y) => (x.name || '').localeCompare(y.name || '', 'ko-KR', { sensitivity: 'base', numeric: true }));
      }
      return ordered; // [ [aff, rows], [aff, rows], ... ]
    }

    // <select> ì— optgroupìœ¼ë¡œ ë Œë” (ì´ë¦„ì€ ë“¤ì—¬ì“°ê¸°)
    function buildGroupedSelect(selectEl, rows, {
      preselectId = null,
      disabled = false,
      excludeId = null,
      includeNone = true,   // "(ì„ íƒ ì—†ìŒ)" ë§¨ ìœ„ì—
      myAff = ''
    } = {}) {
      selectEl.innerHTML = '';
      selectEl.disabled = !!disabled;

      if (includeNone) {
        const none = document.createElement('option');
        none.value = '';
        none.textContent = '(ì„ íƒ ì—†ìŒ)';
        selectEl.appendChild(none);
      }

      const grouped = groupStaffByAffiliation(rows, myAff);

      for (const [aff, members] of grouped) {
        const og = document.createElement('optgroup');
        og.label = aff; // âœ… ì§€ì ëª…ì´ ê·¸ë£¹ í—¤ë”ë¡œ í‘œì‹œ
        for (const m of members) {
          if (excludeId && String(m.id) === String(excludeId)) continue;
          const opt = document.createElement('option');
          opt.value = String(m.id);
          // âœ… ì‚´ì§ ë“¤ì—¬ì“°ê¸°: nbsp 2ê°œ + ì´ë¦„
          opt.textContent = '\u00A0\u00A0' + (m.name || '-');
          if (preselectId && String(preselectId) === String(m.id)) opt.selected = true;
          og.appendChild(opt);
        }
        selectEl.appendChild(og);
      }
    }

    async function getStaffLabelById(staffId) {
      if (!staffId) return '(ì„ íƒ ì—†ìŒ)';
      const { data, error } = await supabase
        .from('staff_profiles')
        .select('id, name, affiliation, leave_date') // â† leave_date í¬í•¨
        .eq('id', staffId)
        .maybeSingle();
      if (error || !data) return '(ì•Œ ìˆ˜ ì—†ìŒ)';
      // ê¶Œí•œë³„ ê°€ë¦¼ ì ìš©
      const masked = maskNameForViewer(data, myAuth, myAff); // '-' ë˜ëŠ” ì´ë¦„
      return `${masked}${data.affiliation ? ' Â· ' + data.affiliation : ''}`;
    }

    async function showCurrentAssigneeOnly(selectEl, staffId) {
      selectEl.innerHTML = '';
      const label = await getStaffLabelById(staffId);
      buildOption(selectEl, String(staffId || ''), label, true, false);
      selectEl.disabled = true;
    }

    // ================== ì¸ì¦/í”„ë¡œí•„ ==================
    async function resolveCurrentStaffId() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return null;
        const candidateCols = ['user_id', 'auth_user_id', 'uid'];
        for (const col of candidateCols) {
          try {
            const { data, error } = await supabase.from('staff_profiles').select('id').eq(col, user.id).single();
            if (!error && data?.id) return String(data.id);
          } catch {}
        }
        if (user.email) {
          try {
            const { data, error } = await supabase.from('staff_profiles').select('id').eq('email', user.email).single();
            if (!error && data?.id) return String(data.id);
          } catch {}
        }
        return null;
      } catch (e) { console.warn('resolveCurrentStaffId ì‹¤íŒ¨:', e); return null; }
    }
    async function resolveMyAuthAff() {
      if (!currentStaffId) return { authority: '', affiliation: '' };
      const { data, error } = await supabase
        .from('staff_profiles')
        .select('authority, affiliation')
        .eq('id', currentStaffId)
        .single();
      if (error) { console.warn('resolveMyAuthAff ì‹¤íŒ¨:', error); return { authority: '', affiliation: '' }; }
      return { authority: (data?.authority || '').trim(), affiliation: (data?.affiliation || '').trim() };
    }

    // ================== ê¶Œí•œë³„ ì§ì› ëª©ë¡ ë¡œë“œ (ì…€ë ‰íŠ¸ ì˜µì…˜ìš©) ==================
    async function fetchStaffRowsForRole() {
      // ëª¨ë“  ê²½ìš° leave_dateê¹Œì§€ ë°›ì•„ì•¼ ê·œì¹™ ì ìš© ê°€ëŠ¥
      if (myAuth === 'ê´€ë¦¬ì') {
        const { data: rows } = await supabase
          .from('staff_profiles')
          .select('id, name, affiliation, leave_date');
        // ë‚´ ì§€ì  ìš°ì„  â†’ ì´ë¦„ìˆœ
        return (rows || []).sort((a,b) => {
          const ap = (a.affiliation||'') === myAff ? 0 : 1;
          const bp = (b.affiliation||'') === myAff ? 0 : 1;
          if (ap !== bp) return ap - bp;
          return (a.name||'').localeCompare(b.name||'', 'ko-KR', { sensitivity: 'base', numeric: true });
        });
      }

      // ì§ì›/ì§€ì ì¥: ì „ ì§€ì  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ë˜, í”„ë¡ íŠ¸ì—ì„œ ê·œì¹™ìœ¼ë¡œ í•„í„°ë§
      const { data: all } = await supabase
        .from('staff_profiles')
        .select('id, name, affiliation, leave_date');

      const rows = (all || []).filter(m => !shouldHideStaffName(m, myAuth, myAff));

      // ë‚´ ì§€ì  ìš°ì„  â†’ ì´ë¦„ìˆœ
      rows.sort((a,b) => {
        const ap = (a.affiliation||'') === myAff ? 0 : 1;
        const bp = (b.affiliation||'') === myAff ? 0 : 1;
        if (ap !== bp) return ap - bp;
        return (a.name||'').localeCompare(b.name||'', 'ko-KR', { sensitivity: 'base', numeric: true });
      });

      return rows;
    }

    // âœ… ì‹ ê·œ ì…ë ¥(ì„ íƒ ì „) ê¸°ë³¸ ì…‹ì—…: ë‹´ë‹¹ì=ë³¸ì¸, ë‹´ë‹¹ì2=ê·œì¹™ëŒ€ë¡œ(ë‹´ë‹¹ì1 ì œì™¸)
    async function setupNewEntryAssigneeSelects() {
      const sel1 = document.getElementById('starr_name');
      const sel2 = document.getElementById('starr_name2');
      if (!sel1 || !sel2) return;

      const rows = await fetchStaffRowsForRole();

      // ë‹´ë‹¹ì1: ë³¸ì¸ ë¯¸ë¦¬ ì„ íƒ
      buildGroupedSelect(sel1, rows, {
        preselectId: currentStaffId || null,
        disabled: false,
        myAff
      });

      // ë‹´ë‹¹ì2: ë‹´ë‹¹ì1ê³¼ ì¤‘ë³µ ê¸ˆì§€
      buildGroupedSelect(sel2, rows, {
        preselectId: null,
        disabled: false,
        excludeId: currentStaffId || null,
        myAff
      });

      selectedAssigneeId  = sel1.value || null;
      selectedAssigneeId2 = sel2.value || null;

      // ë³€ê²½ ì‹œ ì„œë¡œ ì¤‘ë³µ ê¸ˆì§€ + ë‹´ë‹¹ì2 ì˜µì…˜ì„ ë™ì ìœ¼ë¡œ ê°±ì‹ 
      sel1.onchange = async () => {
        selectedAssigneeId = sel1.value || null;
        // sel2ë¥¼ ë‹¤ì‹œ ê·¸ë¦¬ë˜ sel1 ì„ íƒê°’ì€ ì œì™¸
        buildGroupedSelect(sel2, rows, {
          preselectId: (sel2.value && sel2.value !== sel1.value) ? sel2.value : null,
          disabled: false,
          excludeId: sel1.value || null,
          myAff
        });
        // ê°™ì€ ê°’ì´ë©´ sel2 ë¹„ìš°ê¸°
        if (sel2.value && sel2.value === sel1.value) sel2.value = '';
        selectedAssigneeId2 = sel2.value || null;
      };
      sel2.onchange = () => {
        if (sel2.value && sel2.value === sel1.value) sel2.value = '';
        selectedAssigneeId2 = sel2.value || null;
      };
    }

    // ================== ê³ ê°-ë‹´ë‹¹ì(2ëª…) ë¡œë”© ==================
    async function loadAssigneesForCustomer(customerId) {
      const { data: links } = await supabase
        .from('customer_assignees')
        .select('staff_profiles_id, is_primary')
        .eq('customer_id', customerId);
      const primary = (links || []).find(l => l.is_primary);
      const others  = (links || []).filter(l => !l.is_primary);
      const id1 = primary?.staff_profiles_id || null;
      const id2 = others[0]?.staff_profiles_id || null;
      return { id1, id2 };
    }

    // ================== ì´ˆê¸° ì§„ì… ==================
    document.addEventListener('DOMContentLoaded', async () => {
      let viewRows = [];
      currentStaffId = await resolveCurrentStaffId();
      const ctx = await resolveMyAuthAff();
      myAuth = ctx.authority;  myAff  = ctx.affiliation;

      const fm = sessionStorage.getItem('flashMessage');
      const fd = +(sessionStorage.getItem('flashDuration') || '0');
      if (fm) { showToast(fm, fd || 5000); sessionStorage.removeItem('flashMessage'); sessionStorage.removeItem('flashDuration'); }

      if (!currentStaffId) { showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }

      function setFormEditable(enable) {
        const ids = ['top-row-input','customer-phone','customer-grade','starr_name','starr_name2','memo-textarea','save-button'];
        ids.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          if (id === 'save-button') {
            el.disabled = !enable;
            el.classList.toggle('opacity-50', !enable);
            el.classList.toggle('cursor-not-allowed', !enable);
          } else { el.disabled = !enable; }
        });
      }
      async function clearForm() {
        selectedCustomerId = null;
        selectedIsOwner = false;
        selectedAssigneeId = null;
        selectedAssigneeId2 = null;
        document.getElementById('top-row-input').value = '';
        const phoneEl = document.getElementById('customer-phone');
        phoneEl.value = ''; phoneEl.placeholder = 'ì „í™”ë²ˆí˜¸'; phoneEl.maxLength = 4;
        document.getElementById('customer-grade').value = 'F';
        document.getElementById('memo-textarea').value = '';
        const sel1 = document.getElementById('starr_name');
        const sel2 = document.getElementById('starr_name2');
        sel1.innerHTML = ''; sel2.innerHTML = '';

        // âœ… ì‹ ê·œ ìƒíƒœë¡œ ë‹¤ì‹œ ì±„ìš°ê¸°: ë‹´ë‹¹ì=ë³¸ì¸, ë‹´ë‹¹ì2=ê·œì¹™ëŒ€ë¡œ
        await setupNewEntryAssigneeSelects();
      }

      // 1) ê³ ê° + ë‹´ë‹¹ì(ì¡°ì¸) ë¡œë“œ ... (ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ)
      const { data, error } = await supabase
        .from('customers')
        .select(`
          id, grade, customer_name, customer_phone_number, phone_last4,
          registered_at, memo, staff_profiles_id,
          staff_profiles:customers_staff_profiles_id_fkey ( id, name, affiliation )
        `)
        .order('name', { ascending: true, foreignTable: 'staff_profiles', nullsFirst: false })
        .order('affiliation', { ascending: true, foreignTable: 'staff_profiles', nullsFirst: false })
        .order('grade', { ascending: true, nullsFirst: false });
      if (error) { console.error('âŒ ê³ ê° ë¡œë“œ ì‹¤íŒ¨:', error); showToast('ê³ ê° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); return; }

      // ğŸ”¹ ê³ ê°ë“¤ì˜ ëŒ€í‘œ/ë³´ì¡° ë‹´ë‹¹ì idë¥¼ ëª¨ë‘ ëª¨ì•„ì„œ í•œ ë²ˆì— staff_profiles ì¡°íšŒ
      //   - customer_assigneesì—ì„œ ì „ì²´ ê³ ê°ì˜ (id1, id2)ë¥¼ í•œ ë²ˆì— ê°€ì ¸ì˜¤ë©´ ë” íš¨ìœ¨ì 
      const customerIds = (data || []).map(r => r.id);
      let assignees = [];
      if (customerIds.length) {
        const { data: links } = await supabase
          .from('customer_assignees')
          .select('customer_id, staff_profiles_id, is_primary')
          .in('customer_id', customerIds);
        assignees = links || [];
      }

      // ëª¨ë“  í•„ìš” staff id ìˆ˜ì§‘
      const staffIds = new Set();
      for (const r of data) {
        if (r.staff_profiles_id) staffIds.add(String(r.staff_profiles_id));
      }
      for (const l of assignees) {
        if (l.staff_profiles_id) staffIds.add(String(l.staff_profiles_id));
      }

      // staffMap ì¡°íšŒ
      let staffMap = new Map();
      if (staffIds.size) {
        const { data: staffRows } = await supabase
          .from('staff_profiles')
          .select('id, name, affiliation, leave_date')
          .in('id', Array.from(staffIds));
        for (const s of (staffRows || [])) {
          staffMap.set(String(s.id), s);
        }
      }

      // ë³´ì¡° ë‹´ë‹¹ì ì´ë¦„ ì±„ìš°ê¸°(ê·œì¹™ ë°˜ì˜)
      const byCust = new Map();
      for (const l of assignees) {
        if (!byCust.has(l.customer_id)) byCust.set(l.customer_id, []);
        byCust.get(l.customer_id).push(l);
      }
      for (const row of data) {
        const links = byCust.get(row.id) || [];
        const primary = links.find(x => x.is_primary);
        const other   = links.find(x => !x.is_primary);
        const id1 = primary?.staff_profiles_id || row.staff_profiles_id || null;
        const id2 = other?.staff_profiles_id || null;

        // í‘œì‹œì— ì“¸ ì´ë¦„ì„ ê·œì¹™ëŒ€ë¡œ ê³„ì‚°í•´ì„œ ë„£ì–´ë‘ 
        const m1 = id1 ? staffMap.get(String(id1)) : null;
        const m2 = id2 ? staffMap.get(String(id2)) : null;
        row.__displayStaff1 = maskNameForViewer(m1, myAuth, myAff);
        // ğŸ”¹ ë‹´ë‹¹ì2 ì¶”ê°€ ê·œì¹™
        if (myAuth === 'ì§ì›' && m2 && m2.leave_date) {
          row.__displayStaff2 = '-';
        } else {
          row.__displayStaff2 = maskNameForViewer(m2, myAuth, myAff);
        }
        row.__displayAff    = (m1?.affiliation) || (row.staff_profiles?.affiliation) || '-';
        // ğŸ”¹ ì¶”ê°€: ëŒ€í‘œë‹´ë‹¹ì id/í‡´ì‚¬ ì—¬ë¶€ ê¸°ë¡ (id1ì€ ì—†ìœ¼ë©´ staff_profiles_idë¡œ ë³´ì •ë˜ì–´ ìˆìŒ)
        row.__primaryStaffId   = id1 || null;
        row.__primaryIsLeaver  = !!(m1 && m1.leave_date);
      }

      setPhoneInputMode(true); // ì „ì²´ ë²ˆí˜¸ ì…ë ¥ ëª¨ë“œ

      // ê¶Œí•œë³„ ë² ì´ìŠ¤ ëª©ë¡ êµ¬ì„±: ê´€ë¦¬ì=ëª¨ë‘, ê·¸ ì™¸(ì§€ì ì¥/ì§ì›)=ëŒ€í‘œë‹´ë‹¹ìê°€ í‡´ì‚¬ì¸ ê³ ê° ì œì™¸
      const BASE = (myAuth === 'ê´€ë¦¬ì')
        ? data
        : data.filter(r => !r.__primaryIsLeaver);

      // 2) í…Œì´ë¸” ë Œë”
      const tbody = document.getElementById('customer-body');
      function cmpStrNullsLast(a, b) {
        const A = (a ?? '').trim(); const B = (b ?? '').trim();
        const aEmpty = A === ''; const bEmpty = B === '';
        if (aEmpty && bEmpty) return 0; if (aEmpty) return 1; if (bEmpty) return -1;
        return A.localeCompare(B, 'ko-KR', { sensitivity: 'base', numeric: true });
      }
      const gradeRank = { A: 0, B: 1, C: 2, F: 3 };
      function defaultSort(rows) {
        const gradeRank = { A: 0, B: 1, C: 2, F: 3 };

        const norm = (v) => {
          const s = (v ?? '').toString().trim();
          return (s === '-' || s === '') ? '\uFFFF' : s.toLowerCase();
        };

        return [...rows].sort((a, b) => {
          // 1) ë‹´ë‹¹ì ì†Œì†
          const affA = norm(a.__displayAff);
          const affB = norm(b.__displayAff);
          if (affA < affB) return -1;
          if (affA > affB) return 1;

          // 2) ë‹´ë‹¹ì1
          const n1a = norm(a.__displayStaff1);
          const n1b = norm(b.__displayStaff1);
          if (n1a < n1b) return -1;
          if (n1a > n1b) return 1;

          // 3) ë“±ê¸‰
          const gA = gradeRank[a.grade] ?? 999;
          const gB = gradeRank[b.grade] ?? 999;
          return gA - gB;
        });
      }

      function renderRows(rows) {
        tbody.innerHTML = '';
        rows.forEach((row) => {
          const staff = row.staff_profiles || {};
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-yellow-200 border-b text-center text-sm bg-white h-[2rem] cursor-pointer';

          const rowStaffId = row.staff_profiles_id ?? staff.id;
          const isOwner = currentStaffId && rowStaffId && String(rowStaffId) === String(currentStaffId);
          const phoneCell = isOwner
            ? (row.customer_phone_number ? formatPhoneForView(row.customer_phone_number) : (row.phone_last4 ?? '-'))
            : (row.phone_last4 ?? '-');

          const staffNameDisplay = row.__displayStaff1 ?? maskNameForViewer(
            row.staff_profiles ? { ...row.staff_profiles, leave_date: null } : null,
            myAuth, myAff
          );
          const staff2NameDisplay = row.__displayStaff2 ?? '-';
          const affDisplay        = row.__displayAff ?? (row.staff_profiles?.affiliation || '-');

          tr.innerHTML = `
            <td>${row.grade ?? '-'}</td>
            <td class="text-left">${row.customer_name ?? '-'}</td>
            <td>${phoneCell}</td>
            <td>${row.registered_at ? new Date(row.registered_at).toLocaleDateString() : '-'}</td>
            <td>${staffNameDisplay}</td>
            <td>${staff2NameDisplay}</td>
            <td>${affDisplay}</td>
          `;

          tr.addEventListener('click', async () => {
            const rowStaffId = row.staff_profiles_id ?? staff.id;
            const isOwner = currentStaffId && rowStaffId && String(rowStaffId) === String(currentStaffId);
            const rowAff  = (row.staff_profiles?.affiliation || '').trim();
            const sameAff = myAff && rowAff && (rowAff === myAff);

            // ì¼ë°˜ ìˆ˜ì • ê°€ëŠ¥(ì´ë¦„/ì „í™”/ë“±ê¸‰/ë©”ëª¨)
            const canEdit =
              (myAuth === 'ê´€ë¦¬ì') ||
              (myAuth === 'ì§€ì ì¥' && sameAff) ||
              (myAuth === 'ì§ì›' && isOwner);

            // ë‹´ë‹¹ì ì¬ë°°ì • ê°€ëŠ¥
            const canReassign =
              (myAuth === 'ê´€ë¦¬ì') ||
              (myAuth === 'ì§€ì ì¥' && sameAff) ||
              (myAuth === 'ì§ì›' && isOwner);

            selectedIsOwner = !!isOwner;
            selectedCanEdit = !!canEdit;
            selectedCustomerId = row.id;

            const sel1 = document.getElementById('starr_name');
            const sel2 = document.getElementById('starr_name2');

            if (!canEdit) {
              clearForm();
              setFormEditable(false);
              setPhoneInputMode(false);
              // ë‹´ë‹¹ìëŠ” ë³´ê¸°ë§Œ
              const { id1, id2 } = await loadAssigneesForCustomer(row.id);
              await showCurrentAssigneeOnly(sel1, id1 ?? rowStaffId ?? null);
              await showCurrentAssigneeOnly(sel2, id2 ?? null);
              showToast((myAuth === 'ì§€ì ì¥') ? 'ë³¸ì¸ ì†Œì† ì§ì›ì˜ ê³ ê°ë§Œ ì—´ëŒÂ·ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' : 'ë³¸ì¸ì˜ ê³ ê°ë§Œ ì—´ëŒÂ·ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
              return;
            }

            // í¸ì§‘ ê°€ëŠ¥
            setFormEditable(true);
            setPhoneInputMode(true);

            document.getElementById('top-row-input').value = row.customer_name || '';
            const phoneInputEl = document.getElementById('customer-phone');
            phoneInputEl.value = row.customer_phone_number ? formatPhoneForView(row.customer_phone_number) : (row.phone_last4 || '');
            phoneInputEl.placeholder = 'ì „í™”ë²ˆí˜¸(ì „ì²´)'; phoneInputEl.removeAttribute('maxLength');
            document.getElementById('customer-grade').value = row.grade || 'F';
            document.getElementById('memo-textarea').value = row.memo || '';

            // ë‹´ë‹¹ì 2ëª… êµ¬ì„±
            let { id1, id2 } = await loadAssigneesForCustomer(row.id);
            if (!id1) id1 = rowStaffId ?? currentStaffId ?? null;

            const rows = await fetchStaffRowsForRole();
            // ëŒ€í‘œ ë‹´ë‹¹ì´ ì—†ìœ¼ë©´ ë‹¨ì¼ì»¬ëŸ¼(ê¸°ì¡´)ì—ì„œ ë³´ì •
            if (!id1) id1 = rowStaffId ?? currentStaffId ?? null;

            buildGroupedSelect(sel1, rows, {
              preselectId: id1 || null,
              disabled: !canReassign,
              myAff
            });
            buildGroupedSelect(sel2, rows, {
              preselectId: id2 || null,
              disabled: !canReassign,
              excludeId: id1 || null, // 1ë‹´ë‹¹ê³¼ ì¤‘ë³µ ë°©ì§€
              myAff
            });

            selectedAssigneeId  = sel1.value || null;
            selectedAssigneeId2 = sel2.value || null;

            sel1.onchange = () => {
              if (sel1.value && sel1.value === sel2.value) sel2.value = '';
              selectedAssigneeId = sel1.value || null;
            };
            sel2.onchange = () => {
              if (sel2.value && sel2.value === sel1.value) sel2.value = '';
              selectedAssigneeId2 = sel2.value || null;
            };
          });

          tbody.appendChild(tr);
        });
      }

      viewRows = defaultSort(BASE);
      renderRows(viewRows);

      // 3) í•„í„°
      function applyFilters() {
        const freeVal = document.getElementById('filter-free').value.trim().toLowerCase();
        const nameVal = document.getElementById('filter-name').value.trim().toLowerCase();
        const affVal  = document.getElementById('filter-aff').value.trim().toLowerCase();

        const filtered = BASE.filter(row => {
          // 1) ììœ  ê²€ìƒ‰: ê³ ê°ëª…, ì „ì²´ì „í™”/ë4ìë¦¬, ë©”ëª¨ ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨í•˜ë©´ í†µê³¼
          const hay = [
            row.customer_name || '',
            row.customer_phone_number || '',
            row.phone_last4 || '',
            row.memo || ''
          ].join(' ').toLowerCase();
          const freeMatch = !freeVal || hay.includes(freeVal);

          // 2) ë‹´ë‹¹ìëª…/ì†Œì† í•„í„° (í‘œì‹œê°’ ê¸°ì¤€)
          const staffNameShown = (row.__displayStaff1 || '').toLowerCase();
          const affShown       = (row.__displayAff   || '').toLowerCase();
          const staffNameMatch = !nameVal || staffNameShown.includes(nameVal);
          const affMatch       = !affVal  || affShown.includes(affVal);

          return freeMatch && staffNameMatch && affMatch;
        });

        let next = defaultSort(filtered);
        if (currentSortField) next = sortData(next, currentSortField, currentSortOrder);
        viewRows = next;
        renderRows(viewRows);
      }

      document.getElementById('filter-name').addEventListener('input', applyFilters);
      document.getElementById('filter-aff').addEventListener('input', applyFilters);
      document.getElementById('filter-free').addEventListener('input', applyFilters);

      // 4) ì •ë ¬
      function sortData(rows, field, order) {
        const dir = (order === 'asc') ? 1 : -1;
        const gradeRank = { A: 0, B: 1, C: 2, F: 3 };
        return [...rows].sort((a, b) => {
          let va, vb;
          switch (field) {
            case 'grade': va = gradeRank[a.grade] ?? 99; vb = gradeRank[b.grade] ?? 99; break;
            case 'customer_name': va = (a.customer_name || '').toLowerCase(); vb = (b.customer_name || '').toLowerCase(); break;
            case 'phone_last4': va = +(a.phone_last4 || 0); vb = +(b.phone_last4 || 0); break;
            case 'registered_at': va = a.registered_at ? new Date(a.registered_at).getTime() : 0; vb = b.registered_at ? new Date(b.registered_at).getTime() : 0; break;
            case 'staff_profiles_id':
              va = (a.__displayStaff1 || '').toLowerCase();
              vb = (b.__displayStaff1 || '').toLowerCase();
              break;
            default: va = (a[field] ?? '').toString().toLowerCase(); vb = (b[field] ?? '').toString().toLowerCase();
          }
          if (va < vb) return -1 * dir; if (va > vb) return  1 * dir; return 0;
        });
      }
      document.querySelectorAll('th[data-field]').forEach((th) => {
        th.addEventListener('click', () => {
          const field = th.dataset.field;
          if (currentSortField === field) currentSortOrder = (currentSortOrder === 'asc') ? 'desc' : 'asc';
          else { currentSortField = field; currentSortOrder = 'desc'; }
          viewRows = sortData(viewRows, currentSortField, currentSortOrder);
          renderRows(viewRows);
        });
      });

      // 5) ì‹ ê·œ ì…ë ¥ ê¸°ë³¸ ì…‹ì—…(ì„ íƒ ì „)
      await setupNewEntryAssigneeSelects();

      // 6) ì €ì¥
      document.getElementById('save-button').addEventListener('click', async () => {
        try {
          const name  = document.getElementById('top-row-input')?.value.trim();
          const grade = document.getElementById('customer-grade')?.value;
          const memo  = document.getElementById('memo-textarea')?.value.trim();
          const raw   = document.getElementById('customer-phone').value.trim();
          const digits = raw.replace(/\D/g, '');
          if (!name) return showToast('ê³ ê° ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

          if (selectedCustomerId && !selectedCanEdit) {
            const msg = (myAuth === 'ì§€ì ì¥')
              ? 'ë³¸ì¸ ì†Œì† ì§ì›ì˜ ê³ ê°ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
              : (myAuth === 'ê´€ë¦¬ì' ? 'ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨ë¡œ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' : 'ë³¸ì¸ì˜ ê³ ê°ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            showToast(msg); return;
          }

          const sel1 = document.getElementById('starr_name');
          const sel2 = document.getElementById('starr_name2');
          const id1  = (sel1 && !sel1.disabled && sel1.value) ? sel1.value : (selectedAssigneeId  || null);
          const id2  = (sel2 && !sel2.disabled && sel2.value) ? sel2.value : (selectedAssigneeId2 || null);
          const distinctIds = [id1, id2].filter(Boolean);
          const uniq = [...new Set(distinctIds)];
          if (uniq.length !== distinctIds.length) return showToast('ë‹´ë‹¹ì 2ëª…ì€ ì„œë¡œ ë‹¬ë¼ì•¼ í•©ë‹ˆë‹¤.');

          const base = {
            customer_name: name,
            customer_phone_number: raw || null,
            phone_last4: digits ? digits.slice(-4) : null,
            grade, memo,
            staff_profiles_id: id1 || null, // í•˜ìœ„í˜¸í™˜: ëŒ€í‘œë‹´ë‹¹
          };

          // 1) ê³ ê° ì €ì¥/ìˆ˜ì •
          let cid = selectedCustomerId;
          if (cid) {
            const { error: updateError } = await supabase.from('customers').update(base).eq('id', cid);
            if (updateError) { console.error(updateError); return showToast('ê¸°ì¡´ ê³ ê° ìˆ˜ì • ì‹¤íŒ¨'); }
          } else {
            const insertPayload = { ...base, registered_at: new Date().toISOString().split('T')[0] };
            const { data: inserted, error: insertError } = await supabase.from('customers').insert([insertPayload]).select('id').single();
            if (insertError) { console.error(insertError); return showToast('ì‹ ê·œ ì €ì¥ ì‹¤íŒ¨'); }
            cid = inserted.id;
          }

          // 2) ë‹´ë‹¹ì ì—°ê²° ì¬ì‘ì„±(ê°„ë‹¨Â·ëª…í™•): ì „ì²´ ì‚­ì œ â†’ ìƒˆë¡œ ì‚½ì…
          const { error: delErr } = await supabase.from('customer_assignees').delete().eq('customer_id', cid);
          if (delErr) { console.error(delErr); return showToast('ë‹´ë‹¹ì ì—°ê²° ì´ˆê¸°í™” ì‹¤íŒ¨'); }

          const rowsToInsert = [];
          if (id1) rowsToInsert.push({ customer_id: cid, staff_profiles_id: id1, is_primary: true  });
          if (id2) rowsToInsert.push({ customer_id: cid, staff_profiles_id: id2, is_primary: false });
          if (rowsToInsert.length) {
            const { error: linkErr } = await supabase.from('customer_assignees').insert(rowsToInsert);
            if (linkErr) { console.error(linkErr); return showToast('ë‹´ë‹¹ì ì—°ê²° ì €ì¥ ì‹¤íŒ¨'); }
          }

          const msg = selectedCustomerId ? 'ê¸°ì¡´ ê³ ê° ì •ë³´ ìˆ˜ì • ì™„ë£Œ' : 'ì‹ ê·œ ê³ ê° ì €ì¥ ì™„ë£Œ';
          const dur = calcToastDuration(msg);
          sessionStorage.setItem('flashMessage', msg);
          sessionStorage.setItem('flashDuration', String(dur));
          location.reload();
        } catch (err) { console.error(err); showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
      });
    });
  </script>
</head>

<body class="w-screen bg-gray-100">
  <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-[9999] hidden">ë©”ì‹œì§€ ì˜ì—­</div>

  <div class="absolute top-0 left-0 z-[9998] bg-white w-[13rem] h-[60px] rounded-xl">
    <img src="https://github.com/mhale45/image/raw/main/map/%EB%B0%B1%EC%96%B5%EA%B3%B5%EC%9D%B8%EC%A4%91%EA%B0%9C%EC%82%AC%EC%82%AC%EB%AC%B4%EC%86%8C%20%EA%B8%80%EC%94%A8%EB%A7%8C.png"
         alt="ê¸€ì”¨ë¡œê³ "
         class="absolute h-11 w-auto cursor-pointer top-2 left-2 z-[9999]" onclick="location.reload()" />
  </div>

  <div class="flex min-h-screen">
    <!-- ì¢Œì¸¡ ë©”ë‰´ -->
    <div class="w-[6%] pt-[5rem] shadow-right text-center bg-white">
      <a href="/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë°±ì–µì§€ë„</div></a>
      <a href="/admin/listings/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë§¤ë¬¼ì¥ë¶€</div></a>
      <a href="/admin/recommend_imDae/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ì„ëŒ€ì¶”ì²œ</div></a>
      <a href="/admin/recommend_maeMae/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë§¤ë§¤ì¶”ì²œ</div></a>
      <a href="/admin/customer_manage/"><div class="bg-gray-100 border-l-4 border-gray-500 text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">ëª¨ë“ ê³ ê°</div></a>
      <a href="/admin/staff_manage/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ì§ì›ì •ë³´</div></a>
    </div>

    <!-- ë³¸ë¬¸ -->
    <div class="flex pt-[5rem] p-6 gap-3">
      <div class="flex flex-col">
        <!-- í•„í„°ì°½ -->
         <div class="flex">
          <div class="flex gap-2 mb-2">
            <input id="filter-free" placeholder="ê³ ê°ëª… / ê³ ê° ì „í™” / ë©”ëª¨" class="border border-gray-300 px-2 py-1 rounded w-[15rem]" />
          </div>
          <div class="flex gap-2 ml-auto mb-2 justify-end">
            <input id="filter-name" placeholder="ë‹´ë‹¹ì í•„í„°" class="border border-gray-300 px-2 py-1 rounded w-[6.8rem]" />
            <input id="filter-aff"  placeholder="ì†Œì† í•„í„°"   class="border border-gray-300 px-2 py-1 rounded w-[6.8rem]" />
          </div>
         </div>

        <!-- í…Œì´ë¸” -->
        <div class="overflow-auto rounded-lg shadow">
          <table class="w-[50rem]">
            <thead class="bg-gray-200 text-sm text-gray-700">
              <tr class="text-center">
                <th class="w-[2rem]  pt-1 pb-1 cursor-pointer" data-field="grade">ë“±ê¸‰</th>
                <th class="w-[15rem] pt-1 pb-1 cursor-pointer" data-field="customer_name">ê³ ê°ëª…</th>
                <th class="w-[10rem] pt-1 pb-1 cursor-pointer" data-field="phone_last4">ê³ ê° ì „í™”</th>
                <th class="w-[6rem]  pt-1 pb-1 cursor-pointer" data-field="registered_at">ë“±ë¡ì¼</th>
                <th class="w-[7rem]  pt-1 pb-1 cursor-pointer" data-field="staff_profiles_id">ë‹´ë‹¹ì1</th>
                <th class="w-[7rem]  pt-1 pb-1">ë‹´ë‹¹ì2</th>
                <th class="w-[6rem]  pt-1 pb-1">ë‹´ë‹¹ì ì†Œì†</th>
              </tr>
            </thead>
            <tbody id="customer-body"></tbody>
          </table>
        </div>
      </div>

      <!-- ìš°ì¸¡ í¼ -->
      <div>
        <button id="save-button" class="ml-[1rem] mt-1 px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">ì €ì¥</button>

        <div id="customer-form" class="mt-[0.5rem] w-[30rem] text-left text-base rounded">
          <input id="top-row-input" placeholder="ê³ ê°ì´ë¦„"
                 class="border border-gray-300 px-2 rounded ml-[1rem] w-[23.7rem] text-left text-base h-[2rem]" />

          <div class="flex mt-[0.5rem]">
            <div class="flex">
              <div class="ml-5 mt-1">êµ¬ë¶„:</div>
              <select id="customer-grade" class="ml-[0.5rem] px-1 h-[2rem] box-border border border-gray-300 rounded text-base">
                <option>A</option><option>B</option><option>C</option><option>F</option>
              </select>
            </div>
            <input id="customer-phone" placeholder="ì „í™”ë²ˆí˜¸"
                   class="w-[15rem] ml-[3rem] px-1 h-[2rem] text-left box-border border border-gray-300 rounded text-base">
          </div>
          <div class="flex">
            <div class="flex mt-[0.5rem] items-center">
              <div class="ml-5 mt-1">ë‹´ë‹¹ì:</div>
              <select id="starr_name" class="ml-[0.5rem] px-1 h-[2rem] box-border border border-gray-300 rounded text-base"></select>
            </div>
            <div class="flex mt-[0.5rem] items-center">
              <div class="ml-5 mt-1">ë‹´ë‹¹ì2:</div>
              <select id="starr_name2" class="ml-[0.5rem] px-1 h-[2rem] box-border border border-gray-300 rounded text-base"></select>
            </div>
          </div>
          
          <textarea id="memo-textarea" placeholder="ë©”ëª¨"
                    class="mt-[0.5rem] ml-[1rem] px-1 pt-1 w-[23.7rem] h-[40rem] box-border text-left text-base border border-gray-300 rounded bg-white outline-none resize-none"></textarea>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
