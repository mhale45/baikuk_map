<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë§¤ì¶œ</title>
  <link rel="icon" type="image/png" href="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/pabicon-baikuk-simbol.png" />
  <link rel="preconnect" href="https://sfinbtiqlfnaaarziixu.supabase.co" crossorigin>
  <link rel="dns-prefetch" href="//sfinbtiqlfnaaarziixu.supabase.co">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    let currentCustomerId = null; // ì „ì—­ ë³€ìˆ˜ë¡œ ì¶”ê°€
  </script>
  <style>
    /* === print ì „ìš© ì„¤ì • === */
    @media print {
      @page { size: A4 landscape; margin: 12mm; }
      html, body { margin:0 !important; padding:0 !important; }

      /* body ì§ê³„/í›„ì† ì „ë¶€ ìˆ¨ê¹€ */
      body > * { display: none !important; }

      /* ì¸ì‡„ í¬í„¸ë§Œ í‘œì‹œ */
      #print-portal { 
        display: block !important; 
        position: static !important;
        width: 100% !important; 
        margin: 0 !important; 
        padding: 0 !important;
      }
      #print-portal table { width: 100% !important; table-layout: fixed; border-collapse: collapse; }
      #print-portal th, #print-portal td { border: 1px solid #ccc; padding: 4px; font-size: 12px; text-align: center; }
      #print-portal thead { background: #f3f4f6; position: static !important; }

      /* ìƒ‰/ë°°ê²½ ì¶œë ¥ */
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
  <style>
    .shadow-right {
      box-shadow: 8px 0 12px -4px rgba(0, 0, 0, 0.08);
    }
    th.resizable {
      position: relative;
      min-width: 40px;
      white-space: nowrap;
    }
    .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      width: 0.4rem;
      height: 100%;
      cursor: col-resize;
      z-index: 10;
      background-color: transparent;
    }
    .customer-item {
      position: relative;
      padding: 0.5rem 0.5rem; /* ìœ„ì•„ë˜/ì¢Œìš° ì—¬ë°± ì¦ê°€ */
      margin-bottom: 0.25rem;  /* í•­ëª© ì‚¬ì´ ê°„ê²© */
      border-radius: 0.25rem;  /* ëª¨ì„œë¦¬ ì‚´ì§ ë‘¥ê¸€ê²Œ (ì„ íƒ) */
    }
    .customer-item:hover .customer-delete-btn {
      display: block;
    }
    .customer-item:active { background-color: #fde68a; } /* ëˆŒë €ì„ ë•Œ ì‚´ì§ ë” ì§„í•˜ê²Œ */
    .grade-header {
      background-color: #e5e7eb; /* bg-yellow-100 ê°™ì€ íš¨ê³¼ */
      color: #000000;           /* ì§„í•œ ì£¼í™©ìƒ‰ ê¸€ì”¨ */
      font-weight: bold;
      padding: 0.5rem;
      border-radius: 0.25rem;
      margin-top: 0.5rem;
    }
    .name-item {
      font-size: 0.9rem;
      color: #374151;           /* text-gray-700 */
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      cursor: pointer;
      margin-bottom: 0.4rem;
    }
    .name-item:hover {
      background-color: #fef9c3; /* hover:bg-yellow-100 */
    }

  </style>
  <style>
    /* í…Œì´ë¸” ì „ì²´ + ì…€ í…Œë‘ë¦¬ */
    table {
      border-collapse: collapse; /* í…Œë‘ë¦¬ ê²¹ì¹¨ ì œê±° */
      width: 50rem;
      table-layout: fixed;
    }

    table, th, td {
      border: 1px solid #ccc; /* ì—°í•œ íšŒìƒ‰ í…Œë‘ë¦¬ */
    }

    th, td {
      padding: 0.25rem; /* p-1 ì •ë„ */
      text-align: center;
      font-size: 0.875rem; /* text-sm */
    }

    /* í—¤ë” ìŠ¤íƒ€ì¼ */
    thead {
      background-color: #f3f4f6; /* bg-gray-100 */
      position: sticky;
      top: 0;
      z-index: 10;
    }

    /* ì§ìˆ˜/í™€ìˆ˜ ì¤„ ë°°ê²½ */
    tbody tr:nth-child(odd) {
      background-color: white;
    }
    tbody tr:nth-child(even) {
      background-color: #f9fafb; /* bg-gray-50 */
    }
  </style>
</head>
<body class="w-screen overflow-x-hidden">
  <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-[9999] hidden">
    ë©”ì‹œì§€ ì˜ì—­
  </div>
  <div class="absolute top-0 left-0 z-[9998] bg-white w-[13rem] h-[60px] rounded-xl">
    <img src="https://github.com/mhale45/image/raw/main/map/%EB%B0%B1%EC%96%B5%EA%B3%B5%EC%9D%B8%EC%A4%91%EA%B0%9C%EC%82%AC%EC%82%AC%EB%AC%B4%EC%86%8C%20%EA%B8%80%EC%94%A8%EB%A7%8C.png"
        alt="ê¸€ì”¨ë¡œê³ "
        class="absolute h-11 w-auto cursor-pointer top-2 left-2 z-[9999]"
        onclick="location.reload()" />
  </div>
  <div class="flex min-h-screen">
    <div class="w-[6%] pt-[5rem] shadow-right text-center bg-white">
      <a href="/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë°±ì–µì§€ë„</div></a>
      <a href="/admin/listings/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë§¤ë¬¼ì¥ë¶€</div></a>
      <a href="/admin/recommend_imDae/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ì„ëŒ€ì¶”ì²œ</div></a>
      <a href="/admin/recommend_maeMae/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë§¤ë§¤ì¶”ì²œ</div></a>
      <a href="/admin/customer_manage/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">ëª¨ë“ ê³ ê°</div></a>
      <a href="/admin/performance/"><div class="bg-gray-100 border-l-4 border-gray-500 text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë§¤ì¶œ</div></a>
      <a href="/admin/staff_manage/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ì§ì›ì •ë³´</div></a>
    </div>
    <div id="staff-col" class="bg-gray-100 w-[9.5%] pt-[5rem] shadow-right relative z-[10] text-left">
      <div id="staff-list" class="overflow-y-auto">
        <!-- ì—¬ê¸°ì— ì§ì› ì´ë¦„ë“¤ì´ í‘œì‹œë©ë‹ˆë‹¤ -->
      </div>
    </div>
    <div class="w-[84%] flex flex-col bg-gray-100">
      <div class="sticky top-0 z-20 bg-gray-100/80 backdrop-blur px-4 py-3 flex items-center justify-between border-b border-gray-200">
        <div class="flex items-center gap-2">
          <button id="open-sales-drawer" class="px-4 py-2 rounded-lg bg-[#5098e9] text-white font-semibold hover:brightness-110 active:brightness-90">
            ë§¤ì¶œë“±ë¡
          </button>
        </div>
      </div>
    </div>
    <!-- ì˜¤ë¥¸ìª½ ìŠ¬ë¼ì´ë“œ íŒ¨ë„ -->
    <div id="sales-drawer"
        class="fixed inset-y-0 right-0 w-[90rem] bg-white shadow-2xl border-l border-gray-200 translate-x-full transition-transform duration-300 ease-out z-[1000] flex flex-col">
      <!-- í—¤ë” -->
      <div class="px-5 py-4 border-b border-gray-200 flex items-center">
        <h2 class="text-lg font-bold">ë§¤ì¶œ ë“±ë¡</h2>
        <button id="f_status" class="ml-[10rem] px-4 py-2 rounded-lg border hover:bg-gray-100">ë§¤ì¶œí™•ì •</button>
        <button id="close-sales-drawer" class="ml-auto px-3 py-1 rounded hover:bg-gray-100">âœ•</button>
      </div>

      <!-- í¼ -->
      <div class="flex-1 overflow-y-auto p-5 space-y-6">
        <!-- ê¸°ë³¸ì •ë³´ -->
        <section class="space-y-3">
          <h3 class="text-base font-semibold text-gray-700">ê¸°ë³¸ ì •ë³´</h3>
          <div class="flex gap-3">
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">ë§¤ë¬¼ë²ˆí˜¸</span>
              <input id="f_listing_id" type="number" step="1" class="border rounded px-3 py-2 w-[8rem]">
            </label>
            <label class="col-span-2 flex flex-col gap-1">
              <span class="text-sm text-gray-600">ë§¤ë¬¼ëª…</span>
              <input id="f_listing_title" type="text" class="border rounded px-3 py-2 w-[20rem] mr-3">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">ì‹œ/ë„</span>
              <select id="f_province" class="border rounded px-3 py-2"></select>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">ì‹œ/êµ°/êµ¬</span>
              <select id="f_city" class="border rounded px-3 py-2"></select>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">ì/ë©´/ë™</span>
              <select id="f_district" class="border rounded px-3 py-2"></select>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">ë²ˆì§€</span>
              <input id="f_detail_address" type="text" class="border rounded px-3 py-2 !w-[7rem]">
            </label>            
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">ì¸µ</span>
              <input id="f_floor" type="number" step="1" class="border rounded px-3 py-2 !w-[5rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">í˜¸ìˆ˜</span>
              <input id="f_unit_info"
                type="text"
                class="border rounded px-3 py-2 !w-auto min-w-[6ch] max-w-[40rem]"
                data-autowidth
                placeholder="í˜¸ìˆ˜">
            </label>
          </div>
        </section>

        <!-- ê¸ˆì•¡/ë©´ì /ì¸µ/í˜¸ìˆ˜ -->
        <section class="space-y-3">
          <h3 class="text-base font-semibold text-gray-700">ê¸ˆì•¡</h3>
          <div class="flex gap-3">
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">ê±°ë˜ìœ í˜•</span>
              <select id="f_deal_type" class="border rounded px-3 py-2">
                <option value="">ê±°ë˜ìœ í˜• ì„ íƒ</option>
                <option value="ì›”ì„¸">ì›”ì„¸</option>
                <option value="ë§¤ë§¤">ë§¤ë§¤</option>
              </select>
            </label>
            <label class="flex flex-col gap-1 mr-5">
              <span class="text-sm text-gray-600">ë§¤ë§¤ê°€</span>
              <input id="f_sale_price" type="text" step="any" class="border rounded px-3 py-2 w-[10rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">ë³´ì¦ê¸ˆ</span>
              <input id="f_deposit_price" type="text" step="any" class="border rounded px-3 py-2 w-[10rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">ì›”ì„¸</span>
              <input id="f_monthly_rent" type="text" step="any" class="border rounded px-3 py-2 w-[10rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">ê¶Œë¦¬ê¸ˆ</span>
              <input id="f_premium_price" type="text" step="any" class="border rounded px-3 py-2 w-[10rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">ë©´ì (í‰)</span>
              <input id="f_area_py" type="number" step="any" class="border rounded px-3 py-2 w-[7rem]">
            </label>
          </div>
        </section>

        <!-- ë‚ ì§œ / ì¤‘ë„ê¸ˆ -->
        <section class="space-y-3">
          <h3 class="text-base font-semibold text-gray-700">ì¼ì •</h3>
          <div class="flex gap-3 justify-start">
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">ê³„ì•½ì¼</span>
              <input id="f_contract_date" type="date" class="border rounded px-3 py-2 w-[10rem]">
            </label>
            <label class="flex flex-col gap-1 mr-8">
              <span class="text-sm text-gray-600">ì”ê¸ˆì¼</span>
              <input id="f_balance_date" type="date" class="border rounded px-3 py-2 w-[10rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">ì¤‘ë„ê¸ˆ1 (ê¸ˆì•¡)</span>
              <input id="f_interim_payment1" type="number" step="any" class="border rounded px-3 py-2 w-[8rem]">
            </label>
            <label class="flex flex-col gap-1 mr-8">
              <span class="text-sm text-gray-600">1ì°¨ ì…ê¸ˆì¼</span>
              <input id="f_interim_payment1_date" type="date" class="border rounded px-3 py-2 w-[10rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">ì¤‘ë„ê¸ˆ2 (ê¸ˆì•¡)</span>
              <input id="f_interim_payment2" type="number" step="any" class="border rounded px-3 py-2 w-[8rem]">
            </label>
            <label class="flex flex-col gap-1 mr-8">
              <span class="text-sm text-gray-600">2ì°¨ ì…ê¸ˆì¼</span>
              <input id="f_interim_payment2_date" type="date" class="border rounded px-3 py-2 w-[10rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">ì¤‘ë„ê¸ˆ3 (ê¸ˆì•¡)</span>
              <input id="f_interim_payment3" type="number" step="any" class="border rounded px-3 py-2 w-[8rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">3ì°¨ ì…ê¸ˆì¼</span>
              <input id="f_interim_payment3_date" type="date" class="border rounded px-3 py-2 w-[10rem]">
            </label>
          </div>
        </section>

        <!-- ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ/ë§¤ì¶œ/ë¹„ê³  -->
        <section class="space-y-3">
          <h3 class="text-base font-semibold text-gray-700">ë§¤ì¶œ</h3>
          <div class="flex gap-3 mr-8">
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">ë§¤ìˆ˜ì¸ ìˆ˜ìˆ˜ë£Œ</span>
              <input id="f_buyer_fee" type="text" step="any" class="border rounded px-3 py-2 w-[8rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">ë§¤ìˆ˜ì¸ ì„¸ê¸ˆê³„ì‚°ì„œ</span>
              <input id="f_buyer_tax" type="text" step="any" class="border rounded px-3 py-2 w-[8rem]">
            </label>
            <label class="flex flex-col gap-1 mr-20">
              <span class="text-sm text-gray-600">ë§¤ìˆ˜ì¸ ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ì¼</span>
              <input id="f_buyer_tax_date" type="date" class="border rounded px-3 py-2">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">ë§¤ë„ì¸ ìˆ˜ìˆ˜ë£Œ</span>
              <input id="f_seller_fee" type="text" step="any" class="border rounded px-3 py-2 w-[8rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">ë§¤ë„ì¸ ì„¸ê¸ˆê³„ì‚°ì„œ</span>
              <input id="f_seller_tax" type="text" step="any" class="border rounded px-3 py-2 w-[8rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">ë§¤ë„ì¸ ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ì¼</span>
              <input id="f_seller_tax_date" type="date" class="border rounded px-3 py-2">
            </label>
          </div>
        </section>
        <div class="flex gap-3">
          <section class="space-y-3">
            <div class="flex items-center">
              <h3 class="text-base font-semibold text-gray-700 mr-10">ë¶„ë°°</h3>
              <span class="text-sm text-gray-600 mr-2">ë¬¼ê±´ë¶„: ë§¤ë„ì¸ ìˆ˜ìˆ˜ë£Œì˜</span>
              <input id="f_seller_distribution_rate" type="number" step="any" value="30" class="border rounded px-3 py-2 w-[6rem]">
              <span class="text-sm text-gray-600">%</span>
            </div>
            <div class="flex gap-3">
              <label class="flex flex-col gap-1">
                <span class="text-sm text-gray-600">í´ë¡œì§• ë§¤ì¶œ</span>
                <input id="f_buyer_performance" type="text" step="any" class="border rounded px-3 py-2 w-[8rem]" readonly>
              </label>
              <label class="flex flex-col gap-1">
                <span class="text-sm text-gray-600">ë¬¼ê±´ ë§¤ì¶œ</span>
                <input id="f_seller_performance" type="text" step="any" class="border rounded px-3 py-2 w-[8rem]" readonly>
              </label>
              <label class="flex flex-col gap-1 mr-20">
                <span class="text-sm text-gray-600">ê±°ë˜ê´€ë ¨ ì‚¬ìš©ë¹„ìš©</span>
                <input id="f_expense" type="text" step="any" class="border rounded px-3 py-2 w-[8rem]">
              </label>
            </div>
          </section>
          <div class="grid grid-cols-2 gap-x-6 gap-y-4">
            <template id="allocation-template">
              <div class="flex flex-col gap-2">
                <select class="border rounded px-3 py-2 staff-select"></select>
                <label class="flex gap-1 items-center">
                  <span class="text-sm text-gray-600">í´ë¡œì§•</span>
                  <input type="number" step="any" class="border rounded px-2 py-1 w-[5rem] buyer-weight">
                  <span class="text-sm text-gray-600">%</span>
                </label>
                <label class="flex gap-1 items-center">
                  <span class="text-sm text-gray-600">ë§¤ë¬¼í™•ë³´</span>
                  <input type="number" step="any" class="border rounded px-2 py-1 w-[5rem] seller-weight">
                  <span class="text-sm text-gray-600">%</span>
                </label>
              </div>
            </template>
          </div>
        </div>
        <section class="space-y-3">
          <h3 class="text-base font-semibold text-gray-700">íŠ¹ì•½ì‚¬í•­</h3>
          <textarea id="f_special_contract" rows="3" class="border rounded px-3 py-2 w-[70rem] overflow-hidden resize-none"></textarea>
        </section>

      </div>

      <!-- í‘¸í„° -->
      <div class="px-5 py-4 border-t border-gray-200 flex items-center justify-end gap-2">
        <button id="save-sales" class="px-5 py-2 rounded-lg bg-[#00b74a] text-white font-semibold hover:brightness-95 active:brightness-80">ì €ì¥</button>
      </div>
    </div>

    <!-- ì–´ë‘ìš´ ì˜¤ë²„ë ˆì´ -->
    <div id="sales-overlay" class="fixed inset-0 bg-black/30 z-[900] hidden"></div>
  </div>  
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
        'https://sfinbtiqlfnaaarziixu.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaW5idGlxbGZuYWFhcnppaXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MDkxNjEsImV4cCI6MjA2ODA4NTE2MX0.4-7vnIjbF-biWWuv9-vTxK9Y99gMm-vS6oaRMdRL5fA'
    );

    // ë¡œê·¸ì¸ ì„¸ì…˜ í™•ì¸
    (async () => {
        const { data } = await supabase.auth.getSession();
        if (!data?.session) {
            location.replace("/");
        }
    })();

    // ì§ì› ë°ì´í„° ë¡œë”© ë° í‘œì‹œ
    (async () => {
        const { data, error } = await supabase
            .from('staff_profiles')
            .select('name, affiliation, leave_date')
            .order('affiliation', { ascending: true });

        if (error) {
            console.error('ì§ì› ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
            return;
        }

        const container = document.getElementById('staff-list');
        const grouped = {};

        data.forEach(({ name, affiliation, leave_date }) => {
            if (!grouped[affiliation]) {
            grouped[affiliation] = { active: [], inactive: [] };
            }
            if (leave_date === null) {
            grouped[affiliation].active.push(name);
            } else {
            grouped[affiliation].inactive.push(name);
            }
        });

        Object.entries(grouped).forEach(([aff, { active, inactive }], idx) => {
            // ì§€ì  í—¤ë”
            const header = document.createElement('div');
            header.className = 'grade-header';
            header.textContent = aff;
            container.appendChild(header);

            // ì¬ì§ì ì´ë¦„ í‘œì‹œ
            active.forEach(name => {
            const nameDiv = document.createElement('div');
            nameDiv.className = 'name-item';
            nameDiv.textContent = name;
            container.appendChild(nameDiv);
            });

            // í‡´ì‚¬ì ìˆìœ¼ë©´ ë²„íŠ¼ ë° ëª©ë¡ ì¶”ê°€
            if (inactive.length > 0) {
                // â–¼ ë²„íŠ¼
                const toggleBtn = document.createElement('button');
                toggleBtn.textContent = 'â–¼ í‡´ì‚¬ì ë³´ê¸°';
                toggleBtn.className = 'text-sm text-blue-600 hover:underline ml-2 mb-1';
                toggleBtn.style.marginLeft = '1rem'; // ë“¤ì—¬ì“°ê¸° ì•½ê°„

                // í† ê¸€í•  í‡´ì‚¬ì div
                const collapseDiv = document.createElement('div');
                collapseDiv.className = 'pl-4 mt-1 hidden';
                collapseDiv.id = `inactive-group-${idx}`;

                // í‡´ì‚¬ì ì´ë¦„ ì‚½ì…
                inactive.forEach(name => {
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'name-item text-gray-400 italic';
                    nameDiv.textContent = name + ' (í‡´ì‚¬)';
                    collapseDiv.appendChild(nameDiv);
                });

                // ë²„íŠ¼ í´ë¦­ ì‹œ í† ê¸€
                let expanded = false;
                toggleBtn.addEventListener('click', () => {
                    expanded = !expanded;
                    collapseDiv.classList.toggle('hidden', !expanded);
                    toggleBtn.textContent = expanded ? 'â–² í‡´ì‚¬ì ìˆ¨ê¸°ê¸°' : 'â–¼ í‡´ì‚¬ì ë³´ê¸°';
                });

                // ë²„íŠ¼ê³¼ ì ‘íŒ div ì¶”ê°€ (ì¬ì§ì ë‹¤ìŒì—)
                container.appendChild(toggleBtn);
                container.appendChild(collapseDiv);
            }
        });
    })();

    // ì§ì›ì€ ë¶„ë°°ìœ¨ ë§Œì§€ì§€ ëª»í•˜ê²Œ
    (async () => {
      // 1) ì‚¬ìš©ì ì •ë³´
      const { data: userRes } = await supabase.auth.getUser();
      const user = userRes?.user;

      // 2) ë©”íƒ€ë°ì´í„°ì—ì„œ ê¶Œí•œ í™•ì¸
      let role = user?.user_metadata?.role || user?.app_metadata?.role || null;

      // 3) ë©”íƒ€ë°ì´í„°ì— roleì´ ì—†ìœ¼ë©´ profilesì—ì„œ ì‹œë„ (ì»¬ëŸ¼ëª…/í‚¤ëŠ” í™˜ê²½ì— ë§ê²Œ ì¡°ì •)
      if (!role && user?.id) {
        const { data: prof } = await supabase
          .from('staff_profiles')
          .select('role')                // â† staff_profilesì— role ì»¬ëŸ¼ì´ ìˆì„ ë•Œë§Œ ë™ì‘
          .eq('auth_user_id', user.id)   // â† ì‚¬ìš©ì-í”„ë¡œí•„ ë§¤í•‘ í‚¤(í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •)
          .maybeSingle();
        role = prof?.role || null;
      }

      // ì „ì—­ ë³´ê´€
      window.__userRole = role;
      window.__isStaff = role === 'ì§ì›';

      // 4) ì§ì›ì´ë©´ ë¶„ë°°ìœ¨ ì…ë ¥ ì ê¸ˆ
      const distEl = document.getElementById('f_seller_distribution_rate');
      if (distEl) {
        if (window.__isStaff) {
          if (!distEl.value) distEl.value = 30;      // ì´ˆê¸°ê°’ ë³´ì¥
          distEl.readOnly = true;                    // íƒ€ì´í•‘ ë°©ì§€
          distEl.classList.add('bg-gray-100', 'cursor-not-allowed');
          // ë¶™ì—¬ë„£ê¸°/í‚¤ì…ë ¥ ë“± ëª¨ë“  ì…ë ¥ ì°¨ë‹¨
          ['keydown','beforeinput','paste','drop'].forEach(ev =>
            distEl.addEventListener(ev, e => e.preventDefault())
          );
          // í˜¹ì‹œ í”„ë¡œê·¸ë¨ì ìœ¼ë¡œ ë°”ê¿”ë„ ì¦‰ì‹œ ë˜ëŒë¦¼
          distEl.addEventListener('input', () => { distEl.value = 30; });
          // ì•ˆë‚´ í† ìŠ¤íŠ¸ (ì„ íƒ)
          distEl.title = 'ì§ì› ê¶Œí•œì€ ë¶„ë°°ìœ¨ì„ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        } else {
          // ê´€ë¦¬ì/ë§¤ë‹ˆì € ë“±ì€ ììœ ë¡­ê²Œ ìˆ˜ì • ê°€ëŠ¥
          distEl.readOnly = false;
          distEl.classList.remove('bg-gray-100', 'cursor-not-allowed');
        }
      }
    })();

    window.supabase = supabase;
    document.dispatchEvent(new Event('supabase-ready'));
  </script>
  <script>
    // ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
    let _pcdCache = null;

    // ë¶„ë°°ë¹„ìœ¨ ì ê²€ í•¨ìˆ˜
    function validateTotalWeight() {
      let totalBuyer = 0;
      let totalSeller = 0;

      for (let i = 1; i <= 4; i++) {
        totalBuyer += numOrNull(document.getElementById(`f_buyer_weight${i}`)?.value) || 0;
        totalSeller += numOrNull(document.getElementById(`f_seller_weight${i}`)?.value) || 0;
      }

      const buyerOk = totalBuyer === 100;
      const sellerOk = totalSeller === 100;

      if (!buyerOk && !sellerOk) {
        showToast('í´ë¡œì§•ê³¼ ë§¤ë¬¼í™•ë³´ ë¹„ìœ¨ì˜ í•©ì´ ê°ê° 100%ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return false;
      }

      if (!buyerOk) {
        showToast('í´ë¡œì§•(ë§¤ìˆ˜) ë¹„ìœ¨ì˜ í•©ì´ 100%ê°€ ì•„ë‹™ë‹ˆë‹¤.');
        return false;
      }

      if (!sellerOk) {
        showToast('ë§¤ë¬¼í™•ë³´(ë§¤ë„) ë¹„ìœ¨ì˜ í•©ì´ 100%ê°€ ì•„ë‹™ë‹ˆë‹¤.');
        return false;
      }

      return true;
    }

    // í˜¸ìˆ˜ ì˜¤í†  ë¦¬ì‚¬ì´ì¦ˆ
    function autosizeInputByCh(el, { min=6, max=40 } = {}) {
      if (!el) return;
      if (el._autowidthInit) { apply(); return; }  // ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€

      function apply() {
        const len = Math.max(min, Math.min((el.value || el.placeholder || '').length, max));
        el.style.width = `${len}ch`;
      }
      el.addEventListener('input', apply);
      el.addEventListener('change', apply);
      el._autowidthInit = true;
      apply();
    }

    // ì´ˆê¸°í™”: í˜ì´ì§€ ë¡œë“œ í›„
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll('input[data-autowidth]').forEach(el => autosizeInputByCh(el));
      const container = document.querySelector(".grid.grid-cols-2");
      const template = document.getElementById("allocation-template");

      for (let i = 1; i <= 4; i++) {
        const clone = template.content.cloneNode(true);
        const select = clone.querySelector("select");
        select.id = `select_staff${i}`;
        clone.querySelector(".buyer-weight").id = `f_buyer_weight${i}`;
        clone.querySelector(".seller-weight").id = `f_seller_weight${i}`;
        container.appendChild(clone);
      }
    });


    // íŠ¹ì•½ì‚¬í•­ ì˜¤í†  ë¦¬ì‚¬ì´ì¦ˆ í•¨ìˆ˜ + ë°”ì¸ë”©
    function enableAutoGrowTextArea(el) {
      if (!el) return;
      const grow = () => {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
      };
      // ì…ë ¥/ë¶™ì—¬ë„£ê¸°/ê°’ ë³€ê²½ ì‹œ ëŠ˜ì–´ë‚˜ê²Œ
      el.addEventListener('input', grow);
      el.addEventListener('change', grow);
      // ì²˜ìŒ ë¡œë“œë  ë•Œë„ í•œ ë²ˆ ë§ì¶¤
      requestAnimationFrame(grow);
      // ë ˆì´ì•„ì›ƒ/í­ì´ ë°”ë€” ë•Œ ì¬ê³„ì‚°(ì„ íƒ)
      window.addEventListener('resize', grow);
    }

    // í˜ì´ì§€ ë¡œë“œ í›„ ë°”ë¡œ í™œì„±í™”
    document.addEventListener('DOMContentLoaded', () => {
      enableAutoGrowTextArea(document.getElementById('f_special_contract'));
    });

    // ë“œë¡œì–´ ì—´ë¦´ ë•Œ(ë³´ì´ê¸° ì‹œì‘í•  ë•Œ) ë‹¤ì‹œ í•œ ë²ˆ ë§ì¶”ë©´ ê¹”ë”
    const _openDrawerOrig = openDrawer;
    openDrawer = function () {
      _openDrawerOrig();
      requestAnimationFrame(() => {
        const ta = document.getElementById('f_special_contract');
        if (ta) {
          ta.style.height = 'auto';
          ta.style.height = ta.scrollHeight + 'px';
        }
      });
    };


    // --- supabase ì¤€ë¹„ ëŒ€ê¸° ---
    function waitForSupabase(timeoutMs = 5000) {
      const start = Date.now();
      return new Promise((resolve, reject) => {
        if (window.supabase) return resolve(window.supabase);
        function onReady() { document.removeEventListener('supabase-ready', onReady); resolve(window.supabase); }
        document.addEventListener('supabase-ready', onReady);
        const iv = setInterval(() => {
          if (window.supabase) {
            clearInterval(iv);
            document.removeEventListener('supabase-ready', onReady);
            resolve(window.supabase);
          } else if (Date.now() - start > timeoutMs) {
            clearInterval(iv);
            document.removeEventListener('supabase-ready', onReady);
            reject(new Error('Supabase not ready'));
          }
        }, 50);
      });
    }
    // ===== í† ìŠ¤íŠ¸ =====
    function showToast(msg, { ok=false } = {}) {
      const el = document.getElementById('toast');
      if (!el) return alert(msg);
      el.textContent = msg;
      el.classList.remove('hidden');
      el.style.background = ok ? '#10b981' : '#ef4444';
      clearTimeout(el._t);
      el._t = setTimeout(() => el.classList.add('hidden'), 2200);
    }

    // ===== ìˆ«ì/ì •ìˆ˜/ë‚ ì§œ ì •ê·œí™” =====
    const numOrNull = v => {
      if (v === undefined || v === null) return null;
      const s = String(v).trim();
      if (!s) return null;
      const n = Number(s.replaceAll(',', ''));
      return Number.isFinite(n) ? n : null;
    };
    const intOrNull = v => {
      const n = numOrNull(v);
      return Number.isFinite(n) ? Math.trunc(n) : null;
    };
    const dateOrNull = v => {
      const s = (v ?? '').trim();
      return s ? s : null; // YYYY-MM-DD ê·¸ëŒ€ë¡œ ì €ì¥ (date ì»¬ëŸ¼)
    };

    // ===== íŒ¨ë„ ì—´ê³  ë‹«ê¸° =====
    const drawer = document.getElementById('sales-drawer');
    const overlay = document.getElementById('sales-overlay');

    function openDrawer() {
      overlay.classList.remove('hidden');
      requestAnimationFrame(() => {
        drawer.classList.remove('translate-x-full');
      });
      initSalesLocationSelects();
    }
    function closeDrawer() {
      drawer.classList.add('translate-x-full');
      overlay.classList.add('hidden');
    }

    document.getElementById('open-sales-drawer')?.addEventListener('click', openDrawer);
    document.getElementById('close-sales-drawer')?.addEventListener('click', closeDrawer);
    overlay?.addEventListener('click', closeDrawer);

    // ===== ì…ë ¥ê°’ ìˆ˜ì§‘ =====
    function collectPerformancePayload() {
      return {
        listing_id: intOrNull(document.getElementById('f_listing_id')?.value),
        deal_type: (document.getElementById('f_deal_type')?.value ?? '').trim() || null,
        listing_title: (document.getElementById('f_listing_title')?.value ?? '').trim() || null,
        province: (document.getElementById('f_province')?.value ?? '').trim() || null,
        city: (document.getElementById('f_city')?.value ?? '').trim() || null,
        district: (document.getElementById('f_district')?.value ?? '').trim() || null,
        detail_address: (document.getElementById('f_detail_address')?.value ?? '').trim() || null,

        contract_date: dateOrNull(document.getElementById('f_contract_date')?.value),

        interim_payment1: numOrNull(document.getElementById('f_interim_payment1')?.value),
        interim_payment2: numOrNull(document.getElementById('f_interim_payment2')?.value),
        interim_payment3: numOrNull(document.getElementById('f_interim_payment3')?.value),
        // âœ… ìƒˆë¡œ ì¶”ê°€ëœ ë‚ ì§œ 3ê°œ
        interim_payment1_date: dateOrNull(document.getElementById('f_interim_payment1_date')?.value),
        interim_payment2_date: dateOrNull(document.getElementById('f_interim_payment2_date')?.value),
        interim_payment3_date: dateOrNull(document.getElementById('f_interim_payment3_date')?.value),

        balance_date: dateOrNull(document.getElementById('f_balance_date')?.value),

        deposit_price: numOrNull(document.getElementById('f_deposit_price')?.value),
        monthly_rent: numOrNull(document.getElementById('f_monthly_rent')?.value),
        sale_price: numOrNull(document.getElementById('f_sale_price')?.value),
        area_py: numOrNull(document.getElementById('f_area_py')?.value),
        unit_info: (document.getElementById('f_unit_info')?.value ?? '').trim() || null,
        floor: intOrNull(document.getElementById('f_floor')?.value),

        premium_price: numOrNull(document.getElementById('f_premium_price')?.value),
        expense: numOrNull(document.getElementById('f_expense')?.value),

        buyer_fee: numOrNull(document.getElementById('f_buyer_fee')?.value),
        buyer_tax: numOrNull(document.getElementById('f_buyer_tax')?.value),
        buyer_tax_date: dateOrNull(document.getElementById('f_buyer_tax_date')?.value),

        seller_fee: numOrNull(document.getElementById('f_seller_fee')?.value),
        seller_tax: numOrNull(document.getElementById('f_seller_tax')?.value),
        seller_tax_date: dateOrNull(document.getElementById('f_seller_tax_date')?.value),

        seller_performance: numOrNull(document.getElementById('f_seller_performance')?.value),
        buyer_performance: numOrNull(document.getElementById('f_buyer_performance')?.value),

        special_contract: (document.getElementById('f_special_contract')?.value ?? '').trim() || null,
      };
    }

    function collectAllocationPayload(performance_id) {
      const result = [];

      for (let i = 1; i <= 4; i++) {
        const staffId = document.getElementById(`select_staff${i}`)?.value;
        const buyerWeight = numOrNull(document.getElementById(`f_buyer_weight${i}`)?.value) * 0.01 || 0;
        const sellerWeight = numOrNull(document.getElementById(`f_seller_weight${i}`)?.value) * 0.01 || 0;

        if (staffId && (buyerWeight > 0 || sellerWeight > 0)) {
          result.push({
            performance_id,
            staff_id: staffId,
            buyer_weight: buyerWeight,
            seller_weight: sellerWeight
          });
        }
      }

      return result;
    }

    function resetForm() {
      document.querySelectorAll('#sales-drawer input, #sales-drawer textarea, #sales-drawer select')
        .forEach(el => {
          if (el.id === 'f_seller_distribution_rate') { el.value = 30; return; }
          if (el.tagName === 'SELECT') el.value = '';
          else el.value = '';
        });
    }

    // ===== ì €ì¥ ì²˜ë¦¬ =====
    document.getElementById('save-sales')?.addEventListener('click', async () => {
      try {
        // supabase í´ë¼ì´ì–¸íŠ¸ëŠ” type="module" ë¸”ë¡ì—ì„œ ìƒì„±ë¨.
        if (!window.supabase) { showToast('Supabase í´ë¼ì´ì–¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

        // ì €ì¥ ì§ì „ ë¶„ë°°ìœ¨ ë³´ì • (ì§ì›ì€ 30 ê³ ì •)
        const distEl = document.getElementById('f_seller_distribution_rate');
        if (window.__isStaff && distEl) {
          distEl.value = 30;
          // ìˆ˜ìˆ˜ë£Œ/ë§¤ì¶œ ê°’ë„ 30 ê¸°ì¤€ìœ¼ë¡œ ì¬ê³„ì‚°
          if (typeof calculateFees === 'function') calculateFees();
        }

        if (!validateTotalWeight()) return; // ë¹„ìœ¨ ì˜ëª»ì…ë ¥ì‹œ ë¦¬í„´

        const payload = collectPerformancePayload();

        // ê°„ë‹¨ í•„ìˆ˜ ì²´í¬(ì›í•˜ë©´ ê°•í™” ê°€ëŠ¥)
        if (!payload.deal_type && !payload.listing_title) {
          showToast('ê±°ë˜ìœ í˜• ë˜ëŠ” ë§¤ë¬¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
          return;
        }

        // 1) performance insert
        const { data: perfInsert, error: perfErr } = await window.supabase
          .from('performance')
          .insert(payload)
          .select('id')
          .single();

        if (perfErr) {
          console.error(perfErr);
          showToast('ë§¤ì¶œ ì €ì¥ ì‹¤íŒ¨: ' + (perfErr.message || ''));
          return;
        }
        const perfId = perfInsert?.id;
        if (!perfId) {
          showToast('ìƒì„±ëœ ë§¤ì¶œ IDë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // 2) performance_allocations insert (ì˜µì…˜: ë‘˜ ë‹¤ ë¹„ì–´ìˆìœ¼ë©´ ê±´ë„ˆëœ€)
        const allocPayloads = collectAllocationPayload(perfId);
        if (allocPayloads.length > 0) {
          const { error: allocErr } = await window.supabase
            .from('performance_allocations')
            .insert(allocPayloads);

          if (allocErr) {
            await window.supabase.from('performance').delete().eq('id', perfId);
            showToast('ê¸°ì—¬ë„ ì €ì¥ ì‹¤íŒ¨. ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤: ' + (allocErr.message || ''));
            return;
          }
        }


        showToast('ì €ì¥ ì™„ë£Œ!', { ok: true });
        resetForm();
        closeDrawer();
        // TODO: í•„ìš” ì‹œ ëª©ë¡ ë¦¬í”„ë ˆì‹œ í•¨ìˆ˜ í˜¸ì¶œ
      } catch (e) {
        console.error(e);
        showToast('ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // ===== window.supabase ë…¸ì¶œ (type="module" ë¸”ë¡ì—ì„œ ë§Œë“  ì¸ìŠ¤í„´ìŠ¤ ê³µìœ ) =====
    // ìœ„ìª½ module ìŠ¤í¬ë¦½íŠ¸ê°€ ëë‚œ ë’¤ ì‹¤í–‰ë˜ëŠ” ì´ ë¸”ë¡ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ íŠ¸ë¦­:
    (function exposeSupabase() {
      try {
        // ì „ì—­ window ê°ì²´ì— ì´ë¯¸ ìˆìœ¼ë©´ íŒ¨ìŠ¤
        if (!window.supabase && typeof window.createClient === 'undefined') {
          // ëª¨ë“ˆ ìŠ¤ì½”í”„ì— ìˆìœ¼ë‚˜ ì „ì—­ìœ¼ë¡œ ì•ˆ ë³´ì¼ ìˆ˜ ìˆì–´ì„œ, ì´ë¯¸ ë§Œë“¤ì–´ì§„ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë‹¤ì‹œ ì°¸ì¡°
          // í˜„ì¬ íŒŒì¼ì—ì„œëŠ” module ë¸”ë¡ ë‚´ ë³€ìˆ˜ëª… 'supabase' ë¥¼ ì§ì ‘ ì ‘ê·¼í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ,
          // ê°„ë‹¨í•œ ë°©ë²•: module ë¸”ë¡ í•˜ë‹¨ì— window.supabase = supabase; í•œ ì¤„ì„ ì¶”ê°€í•˜ëŠ” í¸ì´ ê°€ì¥ ì•ˆì „.
        }
      } catch {}
    })();

    // ===== f_managerì— select box êµ¬ì„± =====
    document.addEventListener("supabase-ready", async () => {
      const supabase = window.supabase;

      const { data: sessionRes } = await supabase.auth.getSession();
      const user = sessionRes?.session?.user;

      if (!user?.id) return;

      // ë¡œê·¸ì¸ ìœ ì € ì •ë³´
      const { data: myProfile, error: myErr } = await supabase
        .from("staff_profiles")
        .select("affiliation")
        .eq("user_id", user.id)
        .maybeSingle();

      if (myErr || !myProfile) {
        console.error("ë¡œê·¸ì¸ ìœ ì € ì†Œì† ì¡°íšŒ ì‹¤íŒ¨", myErr);
        return;
      }

      const myAffiliation = myProfile.affiliation;

      // ëª¨ë“  ì¬ì§ì ë¶ˆëŸ¬ì˜¤ê¸°
      const { data: allStaff, error } = await supabase
        .from("staff_profiles")
        .select("id, name, affiliation")
        .is("leave_date", null)
        .order("affiliation", { ascending: true });

      if (error || !allStaff) {
        console.error("ì§ì› ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", error);
        return;
      }

      // ì†Œì† ê¸°ì¤€ ë¶„ë¥˜
      const grouped = {};
      for (const row of allStaff) {
        const { id, name, affiliation } = row;
        if (!grouped[affiliation]) grouped[affiliation] = [];
        grouped[affiliation].push({ id, name });
      }

      const select = document.getElementById("select_staff1");
      if (!select) return;
      select.innerHTML = `<option value="">ì§ì› ì„ íƒ</option>`; // ì´ˆê¸°í™”


      // 1. ë³¸ì¸ ì†Œì† ë¨¼ì € ì¶”ê°€
      if (grouped[myAffiliation]) {
        const optGroup = document.createElement("optgroup");
        optGroup.label = myAffiliation;
        grouped[myAffiliation].forEach(({ id, name }) => {
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = name;
          optGroup.appendChild(opt);
        });
        select.appendChild(optGroup);
        delete grouped[myAffiliation]; // ì¤‘ë³µ ë°©ì§€
      }

      // 2. ë‚˜ë¨¸ì§€ ì†Œì† ì¶”ê°€ (ì •ë ¬ í¬í•¨)
      Object.entries(grouped)
        .sort(([a], [b]) => a.localeCompare(b, "ko"))
        .forEach(([aff, list]) => {
          const optGroup = document.createElement("optgroup");
          optGroup.label = aff;
          list.forEach(({ id, name }) => {
            const opt = document.createElement("option");
            opt.value = id;
            opt.textContent = name;
            optGroup.appendChild(opt);
          });
          select.appendChild(optGroup);
        });
    });

    // ë§¤ë¬¼ë²ˆí˜¸ ì…ë ¥ì‹œ ì •ë³´ ìë™ìœ¼ë¡œ ì±„ìš°ê¸°
    // ====== ë§¤ë¬¼ë²ˆí˜¸ë¡œ ìë™ ì±„ìš°ê¸° (public_baikuk_view ë²„ì „) ======

    // 1) í¼ í•„ë“œ ë§¤í•‘ (viewì— ìˆëŠ” ì»¬ëŸ¼ë§Œ)
    const FIELD_MAP = {
      deal_type:       'f_deal_type',
      listing_title:   'f_listing_title',
      province:        'f_province',
      city:            'f_city',
      district:        'f_district',
      deposit_price:   'f_deposit_price',
      monthly_rent:    'f_monthly_rent',
      sale_price:      'f_sale_price',
      area_py:         'f_area_py',
      floor:           'f_floor',
      // detail_address, unit_info, premium_priceëŠ” viewì— ì—†ìœ¼ë¯€ë¡œ ì œì™¸
    };

    // 2) ê°’ ì±„ìš°ê¸° í—¬í¼
    function setInputValue(id, value) {
      const el = document.getElementById(id);
      if (!el) return;
      const v = (value == null) ? '' : String(value);

      if (el.tagName === 'SELECT') {
        const exists = Array.from(el.options).some(o => o.value === v);
        if (v && !exists) {
          const opt = document.createElement('option');
          opt.value = v; opt.textContent = v;
          el.appendChild(opt);
        }
        el.value = v;
      } else {
        el.value = v;
      }

      // ğŸ”½ í˜¸ìˆ˜ ìë™í­ ê°±ì‹ 
      if (id === 'f_unit_info' && el.hasAttribute('data-autowidth')) {
        autosizeInputByCh(el);
      }
    }

    const MONEY_FIELD_IDS = new Set([
      "f_sale_price","f_deposit_price","f_monthly_rent","f_premium_price",
      "f_buyer_fee","f_buyer_tax","f_seller_fee","f_seller_tax",
      "f_buyer_performance","f_seller_performance","f_expense"
    ]);

    function fillFormFromRow(row) {
      Object.entries(FIELD_MAP).forEach(([col, inputId]) => {
        let val = row?.[col] ?? '';

        // 10,000 ë°° ë³€í™˜ (ë§Œì› â†’ ì›)
        if (["deposit_price","monthly_rent","sale_price","premium_price"].includes(col)) {
          if (val != null && val !== '') val = Number(val) * 10000;
        }

        setInputValue(inputId, val);

        // ğŸ’¡ ê¸ˆì•¡ í•„ë“œëŠ” ë°”ë¡œ ì½¤ë§ˆë¡œ ë³´ì´ë„ë¡
        if (MONEY_FIELD_IDS.has(inputId)) {
          const el = document.getElementById(inputId);
          if (el) el.value = formatNumberWithCommas(el.value);
        }
      });
    }

    // 3) ì¡°íšŒ í•¨ìˆ˜
    async function fetchListingAndFill(listingId) {
      try { await waitForSupabase(); } 
      catch { showToast('Supabase ì´ˆê¸°í™” ì§€ì—°'); return; }

      const n = intOrNull(listingId);
      if (n === null) return; // ìˆ«ì ì•„ë‹ ë•Œ ì¢…ë£Œ

      const selectCols = Object.keys(FIELD_MAP).join(', ');

      // 1) ì§€ì • ì»¬ëŸ¼ìœ¼ë¡œ ì¡°íšŒ
      let { data, error } = await window.supabase
        .from('public_baikuk_view')
        .select(selectCols)
        .eq('listing_id', n)
        .maybeSingle();

      if (error) {
        const msg = (error.message || '').toLowerCase();

        // ì»¬ëŸ¼ ë¬¸ì œ â†’ ì „ì²´(*) ì¬ì¡°íšŒ í›„ êµì°¨ ë§¤í•‘
        if (msg.includes('does not exist') || msg.includes('column')) {
          const retry = await window.supabase
            .from('public_baikuk_view')
            .select('*')
            .eq('listing_id', n)
            .maybeSingle();

          if (retry.error) {
            showToast('ë§¤ë¬¼ ì¡°íšŒ ì‹¤íŒ¨: ' + (retry.error.message || ''));
            return;
          }
          if (!retry.data) { showToast('í•´ë‹¹ ë§¤ë¬¼ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

          const row = retry.data;
          fillFormFromRow(row);
          calculateFees();

          // ì„ íƒê°’ê³¼ ë¬´ê´€í•˜ê²Œ ë“œë¡­ë‹¤ìš´ì„ ê°•ì œë¡œ ë§ì¶¤
          initSalesLocationSelects({
            province: row.province, city: row.city, district: row.district
          });
          showToast('ë§¤ë¬¼ ì •ë³´ ìë™ ì±„ì›€ ì™„ë£Œ(êµì°¨ ë§¤í•‘)', { ok: true });
          return;
        }

        if (msg.includes('relation') && msg.includes('does not exist')) {
          showToast('ë·°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. public ìŠ¤í‚¤ë§ˆì˜ public_baikuk_view í™•ì¸ í•„ìš”');
        }
        return;
      }

      // 2) ì •ìƒ ì±„ì›€
      fillFormFromRow(data);
      calculateFees();

      // ì„ íƒê°’ê³¼ ìƒê´€ì—†ì´ ë“œë¡­ë‹¤ìš´ì„ í•´ë‹¹ ê°’ìœ¼ë¡œ ì¬êµ¬ì„±+ì„ íƒ
      initSalesLocationSelects({
        province: data.province, city: data.city, district: data.district
      });

      showToast('ë§¤ë¬¼ ì •ë³´ ìë™ ì±„ì›€ ì™„ë£Œ', { ok: true });
    }

    // 4) ë””ë°”ìš´ìŠ¤ & ì´ë²¤íŠ¸ ë°”ì¸ë”©
    function debounce(fn, ms=300) {
      let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
    }

    const listingIdEl = document.getElementById('f_listing_id');
    if (listingIdEl) {
      const debounced = debounce(() => fetchListingAndFill(listingIdEl.value), 400);
      listingIdEl.addEventListener('input', debounced);
      listingIdEl.addEventListener('change', () => fetchListingAndFill(listingIdEl.value));
      listingIdEl.addEventListener('blur',   () => fetchListingAndFill(listingIdEl.value));
      listingIdEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          fetchListingAndFill(listingIdEl.value);
        }
      });
    }

    // ì£¼ì†Œ ì„ íƒ ê´€ë ¨ í•¨ìˆ˜ë“¤
    async function fetchAllPCD(batchSize = 1000) {
      if (_pcdCache) return _pcdCache;

      await waitForSupabase();
      const supa = window.supabase;

      let from = 0;
      const all = [];

      while (true) {
        const to = from + batchSize - 1;  // rangeëŠ” ì–‘ë í¬í•¨
        const { data, error } = await supa
          .from('province_city_district')             // âœ… í…Œì´ë¸”
          .select('province, city, district')
          .order('province', { ascending: true })     // âœ… í˜ì´ì§€ ê°„ ì •ë ¬ ê³ ì •
          .order('city', { ascending: true })
          .order('district', { ascending: true })
          .range(from, to);

        if (error) throw error;

        const chunk = data || [];
        all.push(...chunk);

        // âœ… ë” ì´ìƒ ë°›ì•„ì˜¬ ê²Œ ì—†ìœ¼ë©´ ì¢…ë£Œ
        if (chunk.length === 0) break;

        // ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™ (ì‹¤ì œ ë°›ì€ ê°œìˆ˜ë§Œí¼ ì „ì§„)
        from += chunk.length;
      }

      console.log('[PCD] loaded rows:', all.length);
      _pcdCache = all;
      return all;
    }

    // ===== ì§€ì—­(ì‹œ/ë„-ì‹œ/êµ°/êµ¬-ì/ë©´/ë™) ì˜ì¡´í˜• ë“œë¡­ë‹¤ìš´ (sales í¼ìš©) =====
    async function initSalesLocationSelects(preset = {}) {
      const provinceEl = document.getElementById('f_province');
      const cityEl     = document.getElementById('f_city');
      const districtEl = document.getElementById('f_district');
      if (!provinceEl || !cityEl || !districtEl) return;

      // í˜„ì¬ ê°’(ìë™ì±„ì›€ìœ¼ë¡œ ë¯¸ë¦¬ ë“¤ì–´ì˜¨ ê°’ì´ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©)
      const selected = {
        province: preset.province ?? provinceEl.value ?? '',
        city:     preset.city     ?? cityEl.value     ?? '',
        district: preset.district ?? districtEl.value ?? '',
      };

      const setPlaceholder = () => {
        provinceEl.innerHTML = `<option value="">ì‹œ/ë„</option>`;
        cityEl.innerHTML     = `<option value="">ì‹œ/êµ°/êµ¬</option>`;
        districtEl.innerHTML = `<option value="">ì/ë©´/ë™</option>`;
      };
      setPlaceholder();

      // ì •ë ¬/ìœ í‹¸
      const collate = new Intl.Collator('ko-KR');
      const uniq = arr => Array.from(new Set(arr));
      const sortKo = arr => arr.sort((a,b)=>collate.compare(a,b));

      const fillSelect = (selectEl, values, selectedVal) => {
        // placeholder ìœ ì§€ í›„ ê°’ ì±„ìš°ê¸°
        const ph = selectEl.querySelector('option[value=""]');
        selectEl.innerHTML = '';
        if (ph) selectEl.appendChild(ph);

        let list = [...values];
        if (selectedVal && !values.includes(selectedVal)) list = [selectedVal, ...values];

        for (const v of list) {
          const opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          if (selectedVal && v === selectedVal) opt.selected = true;
          selectEl.appendChild(opt);
        }
      };

      // ë°ì´í„° ë¡œë“œ
      let rows = [];
      try {
        if (typeof fetchAllPCD !== 'function') throw new Error('fetchAllPCDê°€ ì •ì˜ë˜ì–´ ìˆì§€ ì•ŠìŒ');
        rows = await fetchAllPCD(); // í•„ìš”ì‹œ ìƒí•œ ì¡°ì •
      } catch (e) {
        console.error('ì§€ì—­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        // ì‹¤íŒ¨ ì‹œì—ë„ í˜„ì¬ ì„ íƒê°’ë§Œì´ë¼ë„ ë³´ì´ë„ë¡
        fillSelect(provinceEl, selected.province ? [selected.province] : [], selected.province);
        fillSelect(cityEl,     selected.city     ? [selected.city]     : [], selected.city);
        fillSelect(districtEl, selected.district ? [selected.district] : [], selected.district);
        return;
      }

      // ë§µ êµ¬ì„±
      const citiesByProv = new Map();            // province -> Set(cities)
      const distsByProvCity = new Map();         // `${province}|${city}` -> Set(districts)
      for (const { province, city, district } of rows) {
        if (!province || !city || !district) continue;
        if (!citiesByProv.has(province)) citiesByProv.set(province, new Set());
        citiesByProv.get(province).add(city);

        const key = `${province}|${city}`;
        if (!distsByProvCity.has(key)) distsByProvCity.set(key, new Set());
        distsByProvCity.get(key).add(district);
      }

      const provinces = sortKo(uniq(rows.map(r => r.province).filter(Boolean)));

      // 1) province
      fillSelect(provinceEl, provinces, selected.province);

      // 2) city (provinceì— ì¢…ì†)
      const selProvince = provinceEl.value || selected.province || '';
      const cities = selProvince ? sortKo(uniq([...(citiesByProv.get(selProvince) || [])])) : [];
      fillSelect(cityEl, cities, selected.city);

      // 3) district (province+cityì— ì¢…ì†)
      const selCity = cityEl.value || selected.city || '';
      const key = `${selProvince}|${selCity}`;
      const districts = (selProvince && selCity) ? sortKo(uniq([...(distsByProvCity.get(key) || [])])) : [];
      fillSelect(districtEl, districts, selected.district);

      // ì´ë²¤íŠ¸ ë°”ì¸ë”©
      provinceEl.onchange = () => {
        const p = provinceEl.value;
        const cities2 = p ? sortKo(uniq([...(citiesByProv.get(p) || [])])) : [];
        fillSelect(cityEl, cities2, '');
        fillSelect(districtEl, [], '');
      };

      cityEl.onchange = () => {
        const p = provinceEl.value;
        const c = cityEl.value;
        const k = `${p}|${c}`;
        const d2 = (p && c) ? sortKo(uniq([...(distsByProvCity.get(k) || [])])) : [];
        fillSelect(districtEl, d2, '');
      };
    }

    function recalcPerformanceFromFees() {
      const buyerFee = numOrNull(document.getElementById("f_buyer_fee")?.value) || 0;
      const sellerFee = numOrNull(document.getElementById("f_seller_fee")?.value) || 0;
      const distRate  = numOrNull(document.getElementById("f_seller_distribution_rate")?.value) || 0;

      const sellerPerformance = sellerFee * distRate * 0.01;
      const buyerPerformance  = (buyerFee + sellerFee) - sellerPerformance;

      document.getElementById("f_seller_performance").value = formatNumberWithCommas(Math.round(sellerPerformance));
      document.getElementById("f_buyer_performance").value  = formatNumberWithCommas(Math.round(buyerPerformance));
    }

    // ìˆ˜ìˆ˜ë£Œ í•„ë“œ ë³€ê²½ ì‹œ ë§¤ì¶œë§Œ ê°±ì‹ 
    ["f_buyer_fee","f_seller_fee"].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("input",  recalcPerformanceFromFees);
        el.addEventListener("change", recalcPerformanceFromFees);
      }
    });


    // ===== ìˆ˜ìˆ˜ë£Œ + ë§¤ì¶œ ìë™ ê³„ì‚° =====
    function calculateFees() {
      const dealType = document.getElementById("f_deal_type")?.value;
      const salePrice = numOrNull(document.getElementById("f_sale_price")?.value) || 0;
      const deposit = numOrNull(document.getElementById("f_deposit_price")?.value) || 0;
      const monthlyRent = numOrNull(document.getElementById("f_monthly_rent")?.value) || 0;

      let ê¸°ì¤€ê¸ˆì•¡ = 0;
      if (dealType === "ë§¤ë§¤") {
        ê¸°ì¤€ê¸ˆì•¡ = salePrice;
      } else if (dealType === "ì›”ì„¸") {
        ê¸°ì¤€ê¸ˆì•¡ = monthlyRent * 100 + deposit;
      } else {
        return; // ê±°ë˜ìœ í˜• ì—†ìœ¼ë©´ ê³„ì‚° ì•ˆí•¨
      }

      // ===== ìˆ˜ìˆ˜ë£Œ ê³„ì‚° (5ì²œë§Œ ê¸°ì¤€ 0.9% / 0.7%) =====
      const fee = ê¸°ì¤€ê¸ˆì•¡ >= 50_000_000 ? ê¸°ì¤€ê¸ˆì•¡ * 0.009 : ê¸°ì¤€ê¸ˆì•¡ * 0.007;

      const buyerFeeEl = document.getElementById("f_buyer_fee");
      const sellerFeeEl = document.getElementById("f_seller_fee");
      const distRateEl  = document.getElementById("f_seller_distribution_rate");

      // ìˆ˜ìˆ˜ë£Œ ê°’ ì…ë ¥ (ì½¤ë§ˆ)
      buyerFeeEl.value  = formatNumberWithCommas(Math.round(fee));
      sellerFeeEl.value = formatNumberWithCommas(Math.round(fee));

      // ===== ë§¤ì¶œ ê³„ì‚° =====
      const buyerFee = numOrNull(buyerFeeEl.value) || 0;
      const sellerFee = numOrNull(sellerFeeEl.value) || 0;
      const distRate = numOrNull(distRateEl.value) || 0;

      const sellerPerformance = sellerFee * distRate * 0.01;
      const buyerPerformance  = (buyerFee + sellerFee) - sellerPerformance;

      document.getElementById("f_seller_performance").value = formatNumberWithCommas(Math.round(sellerPerformance));
      document.getElementById("f_buyer_performance").value  = formatNumberWithCommas(Math.round(buyerPerformance));
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”© (ê°’ì´ ë³€í•  ë•Œë§ˆë‹¤ ìë™ê³„ì‚°)
    ["f_deal_type","f_sale_price","f_deposit_price","f_monthly_rent"].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("input", calculateFees);
        el.addEventListener("change", calculateFees);
      }
    });
    document.getElementById("f_seller_distribution_rate")?.addEventListener("input",  calculateFees);
    document.getElementById("f_seller_distribution_rate")?.addEventListener("change", calculateFees);

    // ===== ìˆ«ì ì…ë ¥ì— ì½¤ë§ˆ í‘œì‹œ =====
    function formatNumberWithCommas(value) {
      if (value === null || value === undefined || value === '') return '';
      const num = Number(String(value).replace(/,/g, ''));
      return Number.isFinite(num) ? num.toLocaleString('ko-KR') : value;
    }

    function attachCommaFormatter(id) {
      const el = document.getElementById(id);
      if (!el) return;

      // ì…ë ¥í•  ë•Œë§ˆë‹¤ ìˆ«ì ë³€í™˜ + ì½¤ë§ˆ í‘œì‹œ
      el.addEventListener("input", () => {
        const cursor = el.selectionStart;
        const raw = el.value.replace(/,/g, '');
        if (!raw) { el.value = ''; return; }
        const num = Number(raw);
        if (!isNaN(num)) {
          el.value = formatNumberWithCommas(num);
          // ì»¤ì„œ ìœ„ì¹˜ ë³´ì • (ì„ íƒì‚¬í•­)
          el.setSelectionRange(cursor, cursor);
        }
      });

      // í¬ì»¤ìŠ¤ ìƒì—ˆì„ ë•Œë„ í¬ë§· ì ìš©
      el.addEventListener("blur", () => {
        el.value = formatNumberWithCommas(el.value);
      });
    }

    // ===== í¬ë§· ì ìš©í•  í•„ë“œë“¤ =====
    [
      "f_sale_price",
      "f_deposit_price",
      "f_monthly_rent",
      "f_premium_price",
      "f_buyer_fee",
      "f_buyer_tax",
      "f_seller_fee",
      "f_seller_tax",
      "f_buyer_performance",
      "f_seller_performance",
      "f_expense"
    ].forEach(attachCommaFormatter);


  </script>

</body>
</html>
