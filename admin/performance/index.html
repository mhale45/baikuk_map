<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>매출</title>
  <link rel="icon" type="image/png" href="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/pabicon-baikuk-simbol.png" />
  <link rel="preconnect" href="https://sfinbtiqlfnaaarziixu.supabase.co" crossorigin>
  <link rel="dns-prefetch" href="//sfinbtiqlfnaaarziixu.supabase.co">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    let currentCustomerId = null; // 전역 변수로 추가
  </script>
  <style>
    /* === print 전용 설정 === */
    @media print {
      @page { size: A4 landscape; margin: 12mm; }
      html, body { margin:0 !important; padding:0 !important; }

      /* body 직계/후손 전부 숨김 */
      body > * { display: none !important; }

      /* 인쇄 포털만 표시 */
      #print-portal { 
        display: block !important; 
        position: static !important;
        width: 100% !important; 
        margin: 0 !important; 
        padding: 0 !important;
      }
      #print-portal table { width: 100% !important; table-layout: fixed; border-collapse: collapse; }
      #print-portal th, #print-portal td { border: 1px solid #ccc; padding: 4px; font-size: 12px; text-align: center; }
      #performance-table tbody tr:hover td {
        background-color: #f3f4f6; /* Tailwind의 bg-gray-100 */
        cursor: pointer;
      }
      #print-portal thead { background: #f3f4f6; position: static !important; }

      /* 색/배경 출력 */
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
  <style>
    .shadow-right {
      box-shadow: 8px 0 12px -4px rgba(0, 0, 0, 0.08);
    }
    th.resizable {
      position: relative;
      min-width: 40px;
      white-space: nowrap;
    }
    .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      width: 0.4rem;
      height: 100%;
      cursor: col-resize;
      z-index: 10;
      background-color: transparent;
    }
    .customer-item {
      position: relative;
      padding: 0.5rem 0.5rem; /* 위아래/좌우 여백 증가 */
      margin-bottom: 0.25rem;  /* 항목 사이 간격 */
      border-radius: 0.25rem;  /* 모서리 살짝 둥글게 (선택) */
    }
    .customer-item:hover .customer-delete-btn {
      display: block;
    }
    .customer-item:active { background-color: #fde68a; } /* 눌렀을 때 살짝 더 진하게 */
    .grade-header {
      background-color: #e5e7eb; /* bg-yellow-100 같은 효과 */
      color: #000000;           /* 진한 주황색 글씨 */
      font-weight: bold;
      padding: 0.5rem;
      border-radius: 0.25rem;
      margin-top: 0.5rem;
    }
    .name-item {
      font-size: 0.9rem;
      color: #374151;           /* text-gray-700 */
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      cursor: pointer;
      margin-bottom: 0.4rem;
    }
    .name-item:hover {
      background-color: #fef9c3; /* hover:bg-yellow-100 */
    }

  </style>
  <style>
    /* 테이블 전체 + 셀 테두리 */
    table {
      border-collapse: collapse; /* 테두리 겹침 제거 */
      width: 50rem;
      table-layout: fixed;
    }

    table, th, td {
      border: 1px solid #ccc; /* 연한 회색 테두리 */
    }

    th, td {
      padding: 0.25rem; /* p-1 정도 */
      text-align: center;
      font-size: 0.875rem; /* text-sm */
    }

    /* 헤더 스타일 */
    thead {
      background-color: #f3f4f6; /* bg-gray-100 */
      position: sticky;
      top: 0;
      z-index: 10;
    }

    /* 짝수/홀수 줄 배경 */
    tbody tr:nth-child(odd) {
      background-color: white;
    }
    tbody tr:nth-child(even) {
      background-color: #f9fafb; /* bg-gray-50 */
    }
  </style>
</head>
<body class="w-screen overflow-x-hidden">
  <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-[9999] hidden">
    메시지 영역
  </div>
  <div class="absolute top-0 left-0 z-[9998] bg-white w-[13rem] h-[60px] rounded-xl">
    <img src="https://github.com/mhale45/image/raw/main/map/%EB%B0%B1%EC%96%B5%EA%B3%B5%EC%9D%B8%EC%A4%91%EA%B0%9C%EC%82%AC%EC%82%AC%EB%AC%B4%EC%86%8C%20%EA%B8%80%EC%94%A8%EB%A7%8C.png"
        alt="글씨로고"
        class="absolute h-11 w-auto cursor-pointer top-2 left-2 z-[9999]"
        onclick="location.reload()" />
  </div>
  <div class="flex min-h-screen">
    <div class="w-[6%] pt-[5rem] shadow-right text-center bg-white">
      <a href="/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">백억지도</div></a>
      <a href="/admin/listings/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">매물장부</div></a>
      <a href="/admin/recommend_imDae/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">임대추천</div></a>
      <a href="/admin/recommend_maeMae/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">매매추천</div></a>
      <a href="/admin/customer_manage/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">모든고객</div></a>
      <a href="/admin/performance/"><div class="bg-gray-100 border-l-4 border-gray-500 text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">매출</div></a>
      <a href="/admin/staff_manage/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">직원정보</div></a>
    </div>
    <div id="staff-col" class="bg-gray-100 w-[9.5%] pt-[5rem] shadow-right relative z-[10] text-left">
      <div id="staff-list" class="overflow-y-auto">
        <!-- 여기에 직원 이름들이 표시됩니다 -->
      </div>
    </div>
    <div class="w-[84%] flex flex-col bg-gray-100">
      <div class="sticky top-0 z-20 bg-gray-100/80 backdrop-blur px-4 py-3 flex items-center justify-between border-b border-gray-200">
        <div class="flex items-center gap-2">
          <button id="open-sales-drawer" class="px-4 py-2 rounded-lg bg-[#5098e9] text-white font-semibold hover:brightness-110 active:brightness-90">
            매출등록
          </button>
        </div>
      </div>
      <section class="p-5">
        <h3 class="text-base font-semibold text-gray-700 mb-3">매출 조회</h3>
        <div class="overflow-x-auto">
          <table id="performance-table" class="table-auto border-collapse w-full text-sm">
            <thead class="bg-gray-100">
              <tr>
                <th class="border px-2 py-1 min-w-[3rem]">매물명</th>
                <th class="border px-2 py-1 min-w-[3rem]">주소</th>
                <th class="border px-2 py-1 min-w-[3rem]">구분</th>
                <th class="border px-2 py-1 min-w-[9rem]">가격</th>
                <th class="border px-2 py-1 min-w-[3rem]">면적</th>
                <th class="border px-2 py-1 min-w-[10rem]">계약일/잔금일</th>
                <th class="border px-2 py-1 min-w-[3rem]">매수인</th>
                <th class="border px-2 py-1 min-w-[6rem]">세금계산서</th>
                <th class="border px-2 py-1 min-w-[4rem]">발행일</th>
                <th class="border px-2 py-1 min-w-[3rem]">매도인</th>
                <th class="border px-2 py-1 min-w-[6rem]">세금계산서</th>
                <th class="border px-2 py-1 min-w-[4rem]">발행일</th>
                <th class="border px-2 py-1 min-w-[5rem]">사용비용</th>
                <th class="border px-2 py-1 min-w-[5rem]">직원이름</th>
                <th class="border px-2 py-1 min-w-[5rem]">클로징</th>
                <th class="border px-2 py-1 min-w-[5rem]">매물확보</th>
              </tr>
            </thead>
            <tbody>
              <!-- 데이터 행이 JS로 채워질 자리 -->
            </tbody>
          </table>
        </div>
      </section>
    </div>
    <!-- 오른쪽 슬라이드 패널 -->
    <div id="sales-drawer"
        class="fixed inset-y-0 right-0 w-[87rem] bg-white shadow-2xl border-l border-gray-200 translate-x-full transition-transform duration-300 ease-out z-[1000] flex flex-col">
      <!-- 헤더 -->
      <div class="px-3 py-2 border-b border-gray-200 flex items-center">
        <h2 class="text-lg font-bold">매출 등록</h2>
        <button id="f_status" class="ml-[5rem] px-4 py-2 rounded-lg border bg-red-500 text-white hover:bg-red-600">매출확정</button>
        <button id="close-sales-drawer" class="ml-auto px-3 py-1 rounded hover:bg-gray-100">✕</button>
      </div>

      <!-- 폼 -->
      <div class="flex-1 overflow-y-auto p-5 space-y-6">
        <!-- 기본정보 -->
        <section class="space-y-3">
          <h3 class="text-base font-semibold text-gray-700">기본 정보</h3>
          <div class="flex gap-3">
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">매물번호</span>
              <input id="f_listing_id" type="number" step="1" class="border rounded px-3 py-2 w-[8rem]">
            </label>
            <label class="col-span-2 flex flex-col gap-1">
              <span class="text-sm text-red-600">매물명*</span>
              <input id="f_listing_title" type="text" class="border rounded px-3 py-2 w-[20rem] mr-3">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-red-600">시/도*</span>
              <select id="f_province" class="border rounded px-3 py-2"></select>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-red-600">시/군/구*</span>
              <select id="f_city" class="border rounded px-3 py-2"></select>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-red-600">읍/면/동*</span>
              <select id="f_district" class="border rounded px-3 py-2"></select>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-red-600">번지*</span>
              <input id="f_detail_address" type="text" class="border rounded px-3 py-2 !w-[7rem]">
            </label>            
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">층</span>
              <input id="f_floor" type="number" step="1" class="border rounded px-3 py-2 !w-[5rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">호수</span>
              <input id="f_unit_info"
                type="text"
                class="border rounded px-3 py-2 !w-auto min-w-[6ch] max-w-[40rem]"
                data-autowidth
                placeholder="호수">
            </label>
          </div>
        </section>

        <!-- 금액/면적/층/호수 -->
        <section class="space-y-3">
          <h3 class="text-base font-semibold text-gray-700">금액</h3>
          <div class="flex gap-3">
            <label class="flex flex-col gap-1">
              <span class="text-sm text-red-600">거래유형*</span>
              <select id="f_deal_type" class="border rounded px-3 py-2">
                <option value="">거래유형 선택</option>
                <option value="월세">월세</option>
                <option value="매매">매매</option>
              </select>
            </label>
            <label class="flex flex-col gap-1 mr-5">
              <span class="text-sm text-gray-600">매매가</span>
              <input id="f_sale_price" type="text" step="any" class="border rounded px-3 py-2 w-[10rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">보증금</span>
              <input id="f_deposit_price" type="text" step="any" class="border rounded px-3 py-2 w-[10rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">월세</span>
              <input id="f_monthly_rent" type="text" step="any" class="border rounded px-3 py-2 w-[10rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">권리금</span>
              <input id="f_premium_price" type="text" step="any" class="border rounded px-3 py-2 w-[10rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">면적(평)</span>
              <input id="f_area_py" type="number" step="any" class="border rounded px-3 py-2 w-[7rem]">
            </label>
          </div>
        </section>

        <!-- 날짜 / 중도금 -->
        <section class="space-y-3">
          <h3 class="text-base font-semibold text-gray-700">일정</h3>
          <div class="flex gap-3 justify-start">
            <label class="flex flex-col gap-1">
              <span class="text-sm text-red-600">계약일*</span>
              <input id="f_contract_date" type="date" class="border rounded px-3 py-2 w-[10rem]">
              <input id="f_down_payment" type="text" step="any" class="border rounded px-3 py-2 w-[10rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">중도금1</span>
              <input id="f_interim_payment1_date" type="date" class="border rounded px-3 py-2 w-[10rem]">
              <input id="f_interim_payment1" type="number" step="any" class="border rounded px-3 py-2 w-[10rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">중도금2</span>
              <input id="f_interim_payment2_date" type="date" class="border rounded px-3 py-2 w-[10rem]">
              <input id="f_interim_payment2" type="number" step="any" class="border rounded px-3 py-2 w-[10rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">중도금3</span>
              <input id="f_interim_payment3_date" type="date" class="border rounded px-3 py-2 w-[10rem]">
              <input id="f_interim_payment3" type="number" step="any" class="border rounded px-3 py-2 w-[10rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-red-600">잔금일*</span>
              <input id="f_balance_date" type="date" class="border rounded px-3 py-2 w-[10rem]">
              <input id="f_balance" type="text" step="any" readonly class="border rounded px-3 py-2 bg-gray-50 text-gray-500 w-[10rem]">
            </label>
          </div>
        </section>

        <!-- 수수료/세금/매출/비고 -->
        <section class="space-y-3">
          <h3 class="text-base font-semibold text-gray-700">매출</h3>
          <div class="flex gap-3 mr-8">
            <label class="flex flex-col gap-1">
              <span class="text-sm text-red-600">매수인 수수료*</span>
              <input id="f_buyer_fee" type="text" step="any" class="border rounded px-3 py-2 w-[8rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">매수인 세금계산서</span>
              <input id="f_buyer_tax" type="text" step="any" class="border rounded px-3 py-2 w-[8rem]">
            </label>
            <label class="flex flex-col gap-1 mr-20">
              <span class="text-sm text-gray-600">매수인 세금계산서 발행일</span>
              <input id="f_buyer_tax_date" type="date" class="border rounded px-3 py-2">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-red-600">매도인 수수료*</span>
              <input id="f_seller_fee" type="text" step="any" class="border rounded px-3 py-2 w-[8rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">매도인 세금계산서</span>
              <input id="f_seller_tax" type="text" step="any" class="border rounded px-3 py-2 w-[8rem]">
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm text-gray-600">매도인 세금계산서 발행일</span>
              <input id="f_seller_tax_date" type="date" class="border rounded px-3 py-2">
            </label>
          </div>
        </section>
        <div class="flex gap-3">
          <section class="space-y-3">
            <div class="flex items-center">
              <h3 class="text-base font-semibold text-gray-700 mr-10">분배</h3>
              <span class="text-sm text-gray-600 mr-2">물건분: 매도인 수수료의</span>
              <input id="f_seller_distribution_rate" type="number" step="any" value="30" class="border rounded px-2 py-1 w-[5rem]">
              <span class="text-sm text-gray-600">%</span>
            </div>
            <div class="flex gap-3">
              <label class="flex flex-col gap-1">
                <span class="text-sm text-red-600">클로징 매출*</span>
                <input id="f_buyer_performance" type="text" step="any" readonly class="border rounded px-3 py-2 w-[8rem] bg-gray-50 text-gray-500">
              </label>
              <label class="flex flex-col gap-1">
                <span class="text-sm text-red-600">물건 매출*</span>
                <input id="f_seller_performance" type="text" step="any" readonly class="border rounded px-3 py-2 w-[8rem] bg-gray-50 text-gray-500">
              </label>
              <label class="flex flex-col gap-1 mr-20">
                <span class="text-sm text-gray-600">거래관련 사용비용</span>
                <input id="f_expense" type="text" step="any" class="border rounded px-3 py-2 w-[8rem]">
              </label>
            </div>
          </section>
          <div class="grid grid-cols-4 gap-x-6 gap-y-4">
            <template id="allocation-template">
              <div class="flex flex-col gap-2">
                <select class="border rounded px-3 py-1 staff-select"></select>
                <label class="flex gap-1 items-center">
                  <span class="text-sm text-gray-600 mr-3">클로징</span>
                  <input type="number" step="any" class="border rounded px-2 py-1 w-[5rem] buyer-weight">
                  <span class="text-sm text-gray-600">%</span>
                </label>
                <label class="flex gap-1 items-center">
                  <span class="text-sm text-gray-600">매물확보</span>
                  <input type="number" step="any" class="border rounded px-2 py-1 w-[5rem] seller-weight">
                  <span class="text-sm text-gray-600">%</span>
                </label>
                <label class="flex gap-1 items-center">
                  <span class="text-sm text-gray-600 mr-3">매출</span>
                  <input type="number" step="any" readonly class="border rounded px-2 py-1 w-[7rem] performance-output">
                </label>
              </div>
            </template>
          </div>
        </div>
        <section class="space-y-3">
          <h3 class="text-base font-semibold text-gray-700">특약사항</h3>
          <textarea id="f_special_contract" rows="3" class="border rounded px-3 py-2 w-[70rem] overflow-hidden resize-none"></textarea>
        </section>

      </div>

      <!-- 푸터 -->
      <div class="px-5 py-4 border-t border-gray-200 flex items-center justify-end gap-2">
        <button id="save-sales" type="button" class="px-5 py-2 rounded-lg bg-[#00b74a] text-white font-semibold hover:brightness-95 active:brightness-80">저장</button>
      </div>
    </div>

    <!-- 어두운 오버레이 -->
    <div id="sales-overlay" class="fixed inset-0 bg-black/30 z-[900] hidden"></div>
  </div>  
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
        'https://sfinbtiqlfnaaarziixu.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaW5idGlxbGZuYWFhcnppaXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MDkxNjEsImV4cCI6MjA2ODA4NTE2MX0.4-7vnIjbF-biWWuv9-vTxK9Y99gMm-vS6oaRMdRL5fA'
    );

    // 로그인 세션 확인
    (async () => {
        const { data } = await supabase.auth.getSession();
        if (!data?.session) {
            location.replace("/");
        }
    })();

    // 직원 데이터 로딩 및 표시
    (async () => {
        const { data, error } = await supabase
            .from('staff_profiles')
            .select('name, affiliation, leave_date')
            .order('affiliation', { ascending: true });

        if (error) {
            console.error('직원 정보 가져오기 실패:', error);
            return;
        }

        const container = document.getElementById('staff-list');
        const grouped = {};

        data.forEach(({ name, affiliation, leave_date }) => {
            if (!grouped[affiliation]) {
            grouped[affiliation] = { active: [], inactive: [] };
            }
            if (leave_date === null) {
            grouped[affiliation].active.push(name);
            } else {
            grouped[affiliation].inactive.push(name);
            }
        });

        Object.entries(grouped).forEach(([aff, { active, inactive }], idx) => {
          // 지점 헤더
          const header = document.createElement('div');
          header.className = 'grade-header';
          header.textContent = aff;
          container.appendChild(header);

          // 재직자 이름 표시
          active.forEach(name => {
          const nameDiv = document.createElement('div');
          nameDiv.className = 'name-item';
          nameDiv.textContent = name;
          container.appendChild(nameDiv);
          });

          // 퇴사자 있으면 버튼 및 목록 추가
          if (inactive.length > 0) {
              // ▼ 버튼
              const toggleBtn = document.createElement('button');
              toggleBtn.textContent = '▼ 퇴사자 보기';
              toggleBtn.className = 'text-sm text-blue-600 hover:underline ml-2 mb-1';
              toggleBtn.style.marginLeft = '1rem'; // 들여쓰기 약간

              // 토글할 퇴사자 div
              const collapseDiv = document.createElement('div');
              collapseDiv.className = 'pl-4 mt-1 hidden';
              collapseDiv.id = `inactive-group-${idx}`;

              // 퇴사자 이름 삽입
              inactive.forEach(name => {
                  const nameDiv = document.createElement('div');
                  nameDiv.className = 'name-item text-gray-400 italic';
                  nameDiv.textContent = name + ' (퇴사)';
                  collapseDiv.appendChild(nameDiv);
              });

              // 버튼 클릭 시 토글
              let expanded = false;
              toggleBtn.addEventListener('click', () => {
                  expanded = !expanded;
                  collapseDiv.classList.toggle('hidden', !expanded);
                  toggleBtn.textContent = expanded ? '▲ 퇴사자 숨기기' : '▼ 퇴사자 보기';
              });

              // 버튼과 접힌 div 추가 (재직자 다음에)
              container.appendChild(toggleBtn);
              container.appendChild(collapseDiv);
          }
        });
    })();

    // 분배 입력용 select box에 직원 옵션 채우기
    (async () => {
      const { data, error } = await supabase
        .from('staff_profiles')
        .select('id, name, affiliation, leave_date')
        .order('affiliation', { ascending: true });

      if (error) {
        console.error('직원 목록 불러오기 실패:', error);
        return;
      }

      // 재직자만 필터링
      const activeStaff = data.filter(staff => staff.leave_date === null);

      // affiliation(지점)별로 그룹화
      const grouped = {};
      activeStaff.forEach(({ id, name, affiliation }) => {
        if (!grouped[affiliation]) grouped[affiliation] = [];
        grouped[affiliation].push({ id, name });
      });

      // select_staff1~4에 동일하게 옵션 삽입
      for (let i = 1; i <= 4; i++) {
        const select = document.getElementById(`select_staff${i}`);
        if (!select) continue;

        // 기본 안내 옵션
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- 직원 선택 --';
        select.appendChild(defaultOption);

        // 지점별 optgroup 삽입
        Object.entries(grouped).forEach(([affiliation, staffList]) => {
          const group = document.createElement('optgroup');
          group.label = affiliation;

          staffList.forEach(({ id, name }) => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = name;
            group.appendChild(option);
          });

          select.appendChild(group);
        });
      }
    })();

    // 직원은 분배율 만지지 못하게
    (async () => {
      // 1) 사용자 정보
      const { data: userRes } = await supabase.auth.getUser();
      const user = userRes?.user;

      // 2) 메타데이터에서 권한 확인
      let role = user?.user_metadata?.role || user?.app_metadata?.role || null;

      // 3) 메타데이터에 role이 없으면 profiles에서 시도 (컬럼명/키는 환경에 맞게 조정)
      if (!role && user?.id) {
        const { data: prof } = await supabase
          .from('staff_profiles')
          .select('role')                // ← staff_profiles에 role 컬럼이 있을 때만 동작
          .eq('auth_user_id', user.id)   // ← 사용자-프로필 매핑 키(환경에 맞게 수정)
          .maybeSingle();
        role = prof?.role || null;
      }

      // 전역 보관
      window.__userRole = role;
      window.__isStaff = role === '직원';

      // 4) 직원이면 분배율 입력 잠금
      const distEl = document.getElementById('f_seller_distribution_rate');
      if (distEl) {
        if (window.__isStaff) {
          if (!distEl.value) distEl.value = 30;      // 초기값 보장
          distEl.readOnly = true;                    // 타이핑 방지
          distEl.classList.add('bg-gray-100', 'cursor-not-allowed');
          // 붙여넣기/키입력 등 모든 입력 차단
          ['keydown','beforeinput','paste','drop'].forEach(ev =>
            distEl.addEventListener(ev, e => e.preventDefault())
          );
          // 혹시 프로그램적으로 바꿔도 즉시 되돌림
          distEl.addEventListener('input', () => { distEl.value = 30; });
          // 안내 토스트 (선택)
          distEl.title = '직원 권한은 분배율을 변경할 수 없습니다.';
        } else {
          // 관리자/매니저 등은 자유롭게 수정 가능
          distEl.readOnly = false;
          distEl.classList.remove('bg-gray-100', 'cursor-not-allowed');
        }
      }
    })();

    window.supabase = supabase;
    document.dispatchEvent(new Event('supabase-ready'));
  </script>
  <script>
    // 스크립트 추가
    let _pcdCache = null;
    let currentPerformanceId = null;   // ← 추가: 열람/수정 중인 매출 ID
    let __saving = false; // 중복 저장 방지 플래그
    let isDownPaymentAutoFilled = false;
    let STAFF_NAME_BY_ID = new Map();

    // 클로징, 매물확보 비율에 따라 직원 총 매출 자동계산
    function createAllocationItem(index) {
      const template = document.getElementById("allocation-template");
      const clone = template.content.cloneNode(true);
      const root = clone.querySelector("div");

      const select = root.querySelector("select");
      const buyerInput = root.querySelector(".buyer-weight");
      const sellerInput = root.querySelector(".seller-weight");
      const resultInput = root.querySelector(".performance-output"); // ← 안전하게 수정

      if (!resultInput) {
        console.warn("⚠️ performance-output input not found in allocation template.");
        return root;
      }

      // ID 설정
      select.id = `select_staff${index}`;
      buyerInput.id = `f_buyer_weight${index}`;
      sellerInput.id = `f_seller_weight${index}`;

      function calculatePerformance() {
        const buyerPerf = numOrNull(document.getElementById('f_buyer_performance')?.value) || 0;
        const sellerPerf = numOrNull(document.getElementById('f_seller_performance')?.value) || 0;

        const bw = parseFloat(buyerInput.value) || 0;
        const sw = parseFloat(sellerInput.value) || 0;

        const result = (buyerPerf * bw * 0.01) + (sellerPerf * sw * 0.01);
        resultInput.value = Math.round(result);
      }

      buyerInput.addEventListener('input', calculatePerformance);
      sellerInput.addEventListener('input', calculatePerformance);

      return root;
    }

    function calculateDownPaymentAndBalance({ forceDownPaymentUpdate = false } = {}) {
      const deposit = numOrNull(document.getElementById('f_deposit_price')?.value) || 0;

      const downPaymentInput = document.getElementById('f_down_payment');

      // ✅ 계약금 자동계산 조건: 초기 1회 or 보증금 변경 시 강제 업데이트
      if (!isDownPaymentAutoFilled || forceDownPaymentUpdate) {
        const downPayment = Math.round(deposit * 0.1);
        downPaymentInput.value = formatNumberWithCommas(downPayment);
        isDownPaymentAutoFilled = true;
      }

      const downPayment = numOrNull(downPaymentInput?.value) || 0;
      const i1 = numOrNull(document.getElementById('f_interim_payment1')?.value) || 0;
      const i2 = numOrNull(document.getElementById('f_interim_payment2')?.value) || 0;
      const i3 = numOrNull(document.getElementById('f_interim_payment3')?.value) || 0;

      const balance = deposit - (downPayment + i1 + i2 + i3);
      document.getElementById('f_balance').value = formatNumberWithCommas(Math.max(balance, 0));
    }

    async function ensureStaffNameMap() {
      if (STAFF_NAME_BY_ID.size > 0) return;
      await waitForSupabase();
      const { data, error } = await window.supabase
        .from('staff_profiles')
        .select('id, name')
        .is('leave_date', null);
      if (!error && data) {
        STAFF_NAME_BY_ID.clear();
        data.forEach(({id, name}) => STAFF_NAME_BY_ID.set(id, name));
      }
    }

    async function populateAllStaffSelects(myAffiliation=null) {
      try {
        await waitForSupabase();
        const { data, error } = await window.supabase
          .from('staff_profiles')
          .select('id, name, affiliation')
          .is('leave_date', null)
          .order('affiliation', { ascending: true });

        if (error) { console.error('직원 목록 불러오기 실패:', error); return; }

        // 이름맵 업데이트
        STAFF_NAME_BY_ID.clear();
        for (const r of data) STAFF_NAME_BY_ID.set(r.id, r.name);

        // 지점별 그룹화 + select 채우기 (기존 로직 동일)
        const grouped = {};
        for (const { id, name, affiliation } of data) {
          (grouped[affiliation] ||= []).push({ id, name });
        }
        const entries = Object.entries(grouped);
        const ordered = myAffiliation
          ? entries.sort(([a],[b]) => (a===myAffiliation?-1:b===myAffiliation?1:a.localeCompare(b,'ko')))
          : entries.sort(([a],[b]) => a.localeCompare(b,'ko'));

        for (let i=1; i<=4; i++) {
          const select = document.getElementById(`select_staff${i}`);
          if (!select) continue;
          select.innerHTML = `<option value="">-- 직원 선택 --</option>`;
          for (const [aff, list] of ordered) {
            const group = document.createElement('optgroup');
            group.label = aff;
            list.forEach(({id, name}) => {
              const opt = document.createElement('option');
              opt.value = id; opt.textContent = name;
              group.appendChild(opt);
            });
            select.appendChild(group);
          }
        }
      } catch (e) { console.error(e); }
    }

    // (선택) 내 소속 가져오기
    async function getMyAffiliation() {
      try {
        await waitForSupabase();
        const { data: sessionRes } = await window.supabase.auth.getSession();
        const user = sessionRes?.session?.user;
        if (!user?.id) return null;
        const { data: prof } = await window.supabase
          .from('staff_profiles')
          .select('affiliation')
          .eq('auth_user_id', user.id)   // ← 위쪽 코드랑 키 통일! (user_id → auth_user_id)
          .maybeSingle();
        return prof?.affiliation ?? null;
      } catch { return null; }
    }
    
    function buildListingTitle(row) {
      const id = row.listing_id ? `[${String(row.listing_id).trim()}]` : '';
      const title = row.listing_title ? String(row.listing_title).trim() : '';
      return [id, title].filter(Boolean).join(' ');
    }

    // 헬퍼: 주소 합치기 (공백으로 연결, 빈 값은 자동 제거)
    function buildAddress(row) {
      const floor = row.floor != null && row.floor !== ''
        ? `${row.floor}층`
        : '';
      const unit = row.unit_info != null && row.unit_info !== ''
        ? `${row.unit_info}호`
        : '';

      const parts = [
        row.province,
        row.city,
        row.district,
        row.detail_address, // 번지
        floor,
        unit
      ].map(v => (v == null ? '' : String(v).trim()))
      .filter(Boolean);

      return parts.join(' ');
    }

    function buildDateBlock(row) {
      const parts = [];

      if (row.contract_date) parts.push(`계약 ${row.contract_date}`);
      if (row.balance_date)  parts.push(`잔금 ${row.balance_date}`);

      // 중도금 1~3
      if (row.interim_payment1_date) {
        const amt = row.interim_payment1 ? formatNumberWithCommas(row.interim_payment1) : '';
        parts.push(`중도금1 ${row.interim_payment1_date}`);
      }
      if (row.interim_payment2_date) {
        const amt = row.interim_payment2 ? formatNumberWithCommas(row.interim_payment2) : '';
        parts.push(`중도금2 ${row.interim_payment2_date}`);
      }
      if (row.interim_payment3_date) {
        const amt = row.interim_payment3 ? formatNumberWithCommas(row.interim_payment3) : '';
        parts.push(`중도금3 ${row.interim_payment3_date}`);
      }

      return parts.join('<br>'); // 줄바꿈
    }

    function buildPriceBlock(row) {
      const parts = [];
      const pushIf = (label, v) => {
        const n = Number(v || 0);
        if (n > 0) parts.push(`${label} ${formatNumberWithCommas(n)}`);
      };

      pushIf('매매가',  row.sale_price);
      pushIf('보증금',  row.deposit_price);
      pushIf('월세',    row.monthly_rent);
      pushIf('권리금',  row.premium_price);

      return parts.join('<br>'); // 줄바꿈으로 구분
    }

    // 헬퍼: 면적 소수점 1자리
    function formatArea1(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n.toFixed(1) : '';
    }

    async function loadPerformanceTable() {
      await ensureStaffNameMap();
      try {
        await waitForSupabase();
        const { data, error } = await window.supabase
          .from('performance')
          .select(`
            id, listing_id, listing_title, province, city, district, detail_address,
            floor, unit_info, deal_type, sale_price, deposit_price, monthly_rent, premium_price, area_py,
            contract_date, balance_date,
            down_payment, balance,
            interim_payment1, interim_payment1_date,
            interim_payment2, interim_payment2_date,
            interim_payment3, interim_payment3_date,
            buyer_fee, buyer_tax, buyer_tax_date,
            seller_fee, seller_tax, seller_tax_date,
            expense,
            special_contract,
            performance_allocations:performance_allocations!performance_allocations_performance_id_fkey(
              staff_id1, staff_id2, staff_id3, staff_id4,
              buyer_weight1, buyer_weight2, buyer_weight3, buyer_weight4,
              seller_weight1, seller_weight2, seller_weight3, seller_weight4,
              buyer_amount1, buyer_amount2, buyer_amount3, buyer_amount4,
              seller_amount1, seller_amount2, seller_amount3, seller_amount4
            )
          `)
          .order('contract_date', { ascending: false });

        if (error) {
          console.error('테이블 조회 실패:', error);
          showToast('조회 실패: ' + error.message);
          return;
        }

        const tbody = document.querySelector('#performance-table tbody');
        tbody.innerHTML = '';

        data.forEach(row => {
          // 관계가 1:1이라도 PostgREST가 배열로 줄 수 있으니 방어적으로 처리
          const pa = Array.isArray(row.performance_allocations)
            ? row.performance_allocations[0]
            : row.performance_allocations;

          // 1) 직원/비율 텍스트를 한 셀용으로 준비
          const names  = [];
          const buyerP = [];
          const sellerP= [];
          if (pa) {
            for (let i = 1; i <= 4; i++) {
              const sid = pa[`staff_id${i}`];
              const bw  = pa[`buyer_weight${i}`];   // 0~1
              const sw  = pa[`seller_weight${i}`];  // 0~1
              if (sid && ((bw ?? 0) > 0 || (sw ?? 0) > 0)) {
                names.push(STAFF_NAME_BY_ID.get(sid) || '-');
                buyerP.push(((bw ?? 0) * 100).toFixed(0) + '%');
                sellerP.push(((sw ?? 0) * 100).toFixed(0) + '%');
              }
            }
          }
          if (names.length === 0) { names.push('-'); buyerP.push('-'); sellerP.push('-'); }

          const addr = buildAddress(row);
          const areaDisp = formatArea1(row.area_py);

          // 2) 한 행만 만들어서 넣기
          const tr = document.createElement('tr');
          tr.classList.add('cursor-pointer', 'hover:bg-gray-100');

          // 간단 헬퍼
          const tdHTML = (html) => {
            const td = document.createElement('td');
            td.className = 'border px-2 py-1';
            td.innerHTML = html ?? '';
            return td;
          };
          const tdMulti = (text) => {
            const td = document.createElement('td');
            td.className = 'border px-2 py-1 whitespace-pre-line'; // \n을 줄바꿈으로
            td.textContent = text ?? '';
            return td;
          };

          // 컬럼 추가 (헤더 순서 그대로)
          tr.appendChild(tdHTML(buildListingTitle(row)));
          tr.appendChild(tdHTML(addr));
          tr.appendChild(tdHTML(row.deal_type ?? ''));
          tr.appendChild(tdHTML(buildPriceBlock(row)));
          tr.appendChild(tdHTML(areaDisp));
          tr.appendChild(tdHTML(buildDateBlock(row)));
          tr.appendChild(tdHTML(formatNumberWithCommas(row.buyer_fee) ?? ''));
          tr.appendChild(tdHTML(formatNumberWithCommas(row.buyer_tax) ?? ''));
          tr.appendChild(tdHTML(row.buyer_tax_date ?? ''));
          tr.appendChild(tdHTML(formatNumberWithCommas(row.seller_fee) ?? ''));
          tr.appendChild(tdHTML(formatNumberWithCommas(row.seller_tax) ?? ''));
          tr.appendChild(tdHTML(row.seller_tax_date ?? ''));
          tr.appendChild(tdHTML(formatNumberWithCommas(row.expense) ?? ''));

          // ★ 여기 3칸이 다중라인 셀
          tr.appendChild(tdMulti(names.join('\n')));     // 직원이름
          tr.appendChild(tdMulti(buyerP.join('\n')));    // 클로징
          tr.appendChild(tdMulti(sellerP.join('\n')));   // 매물확보

          tr.addEventListener('click', () => {
            currentPerformanceId = row.id;
            isDownPaymentAutoFilled = false;
            openDrawer();
            fillFormWithPerformance(row);
            fillAllocations(pa || null);
            updateHighlight();
          });

          tbody.appendChild(tr);
        });
      } catch (e) {
        console.error(e);
        showToast('예상치 못한 오류');
      }
    }

    // 페이지 로드 시 자동 실행
    document.addEventListener("DOMContentLoaded", loadPerformanceTable);

    // 매물등록) 거래유형에 따라 매매가 / 보증금,월세 빨갛게 - 비교 전에 trim
    function updateHighlight() {
      const dealTypeEl = document.getElementById("f_deal_type");

      // ✅ 더 견고한 라벨 선택
      const saleLabel    = document.querySelector("#f_sale_price")?.closest("label")?.querySelector("span");
      const depositLabel = document.querySelector("#f_deposit_price")?.closest("label")?.querySelector("span");
      const monthlyLabel = document.querySelector("#f_monthly_rent")?.closest("label")?.querySelector("span");

      if (!dealTypeEl) return;
      const type = (dealTypeEl.value || '').trim();

      // reset
      if (saleLabel)    { saleLabel.textContent    = "매매가"; saleLabel.classList.remove("text-red-600"); saleLabel.classList.add("text-gray-600"); }
      if (depositLabel) { depositLabel.textContent = "보증금"; depositLabel.classList.remove("text-red-600"); depositLabel.classList.add("text-gray-600"); }
      if (monthlyLabel) { monthlyLabel.textContent = "월세";   monthlyLabel.classList.remove("text-red-600"); monthlyLabel.classList.add("text-gray-600"); }

      if (type === "월세") {
        if (depositLabel) { depositLabel.textContent = "보증금*"; depositLabel.classList.replace("text-gray-600","text-red-600"); }
        if (monthlyLabel) { monthlyLabel.textContent = "월세*";   monthlyLabel.classList.replace("text-gray-600","text-red-600"); }
      } else if (type === "매매") {
        if (saleLabel) { saleLabel.textContent = "매매가*"; saleLabel.classList.replace("text-gray-600","text-red-600"); }
      }
    }

    // 전역 노출
    window.updateHighlight = updateHighlight;

    // 분배비율 점검 함수
    function validateTotalWeight() {
      let totalBuyer = 0;
      let totalSeller = 0;

      for (let i = 1; i <= 4; i++) {
        totalBuyer += numOrNull(document.getElementById(`f_buyer_weight${i}`)?.value) || 0;
        totalSeller += numOrNull(document.getElementById(`f_seller_weight${i}`)?.value) || 0;
      }

      const buyerOk = totalBuyer === 100;
      const sellerOk = totalSeller === 100;

      if (!buyerOk && !sellerOk) {
        showToast('클로징과 매물확보 비율의 합이 각각 100%이어야 합니다.');
        return false;
      }

      if (!buyerOk) {
        showToast('클로징(매수) 비율의 합이 100%가 아닙니다.');
        return false;
      }

      if (!sellerOk) {
        showToast('매물확보(매도) 비율의 합이 100%가 아닙니다.');
        return false;
      }

      return true;
    }

    // 호수 오토 리사이즈
    function autosizeInputByCh(el, { min=6, max=40 } = {}) {
      if (!el) return;
      if (el._autowidthInit) { apply(); return; }  // 중복 바인딩 방지

      function apply() {
        const len = Math.max(min, Math.min((el.value || el.placeholder || '').length, max));
        el.style.width = `${len}ch`;
      }
      el.addEventListener('input', apply);
      el.addEventListener('change', apply);
      el._autowidthInit = true;
      apply();
    }

    // 초기화: 페이지 로드 후
    document.addEventListener("DOMContentLoaded", async () => {
      document.querySelectorAll('input[data-autowidth]').forEach(el => autosizeInputByCh(el));
      const container = document.querySelector(".grid.grid-cols-4");

      for (let i = 1; i <= 4; i++) {
        const item = createAllocationItem(i); // ✅ 바뀐 부분
        container.appendChild(item);
      }

      // ★ 내 소속 먼저 보이게
      const myAff = await getMyAffiliation();
      await populateAllStaffSelects(myAff);

      ["f_buyer_performance", "f_seller_performance"].forEach(id => {
        const el = document.getElementById(id);
        if (!el) {
          console.warn(`⚠️ ${id} 엘리먼트를 찾을 수 없습니다.`);
          return;
        }

        el.addEventListener("input", () => {
          document.querySelectorAll(".buyer-weight, .seller-weight").forEach(input => {
            input.dispatchEvent(new Event("input"));
          });
        });
      });
    });


    // 특약사항 오토 리사이즈 함수 + 바인딩
    function enableAutoGrowTextArea(el) {
      if (!el) return;
      const grow = () => {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
      };
      // 입력/붙여넣기/값 변경 시 늘어나게
      el.addEventListener('input', grow);
      el.addEventListener('change', grow);
      // 처음 로드될 때도 한 번 맞춤
      requestAnimationFrame(grow);
      // 레이아웃/폭이 바뀔 때 재계산(선택)
      window.addEventListener('resize', grow);
    }

    // 페이지 로드 후 바로 활성화
    document.addEventListener('DOMContentLoaded', () => {
      enableAutoGrowTextArea(document.getElementById('f_special_contract'));
    });

    // 매출등록) 거래유형에 따라 매매가 / 보증금,월세 빨갛게 표시
    document.addEventListener("DOMContentLoaded", () => {
      updateHighlight();
      document.getElementById("f_deal_type")?.addEventListener("change", updateHighlight);

      ["f_deposit_price", "f_down_payment", "f_interim_payment1", "f_interim_payment2", "f_interim_payment3"].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener("input", () => {
            const isDeposit = id === "f_deposit_price";
            calculateDownPaymentAndBalance({ forceDownPaymentUpdate: isDeposit });
          });
          el.addEventListener("change", () => {
            const isDeposit = id === "f_deposit_price";
            calculateDownPaymentAndBalance({ forceDownPaymentUpdate: isDeposit });
          });
        }
      });
    });

    // 드로어 열릴 때(보이기 시작할 때) 다시 한 번 맞추면 깔끔
    const _openDrawerOrig = openDrawer;
    openDrawer = function () {
      _openDrawerOrig();

      requestAnimationFrame(() => {
        const ta = document.getElementById('f_special_contract');
        if (ta) {
          ta.style.height = 'auto';
          ta.style.height = ta.scrollHeight + 'px';
        }

        // 🔧 자동계산 바인딩 보장 (드로어 열릴 때마다)
        ["f_buyer_performance", "f_seller_performance"].forEach(id => {
          const el = document.getElementById(id);
          if (el && !el._listenerAttached) {
            el.addEventListener("input", () => {
              document.querySelectorAll(".buyer-weight, .seller-weight").forEach(input => {
                input.dispatchEvent(new Event("input"));
              });
            });
            el._listenerAttached = true;
          }
        });
      });
    };

    // --- supabase 준비 대기 ---
    function waitForSupabase(timeoutMs = 5000) {
      const start = Date.now();
      return new Promise((resolve, reject) => {
        if (window.supabase) return resolve(window.supabase);
        function onReady() { document.removeEventListener('supabase-ready', onReady); resolve(window.supabase); }
        document.addEventListener('supabase-ready', onReady);
        const iv = setInterval(() => {
          if (window.supabase) {
            clearInterval(iv);
            document.removeEventListener('supabase-ready', onReady);
            resolve(window.supabase);
          } else if (Date.now() - start > timeoutMs) {
            clearInterval(iv);
            document.removeEventListener('supabase-ready', onReady);
            reject(new Error('Supabase not ready'));
          }
        }, 50);
      });
    }
    // ===== 토스트 =====
    function showToast(msg, { ok=false } = {}) {
      const el = document.getElementById('toast');
      if (!el) return alert(msg);
      el.textContent = msg;
      el.classList.remove('hidden');
      el.style.background = ok ? '#10b981' : '#ef4444';
      clearTimeout(el._t);
      el._t = setTimeout(() => el.classList.add('hidden'), 2200);
    }

    // ===== 숫자/정수/날짜 정규화 =====
    const numOrNull = v => {
      if (v === undefined || v === null) return null;
      const s = String(v).trim();
      if (!s) return null;
      const n = Number(s.replaceAll(',', ''));
      return Number.isFinite(n) ? n : null;
    };
    const intOrNull = v => {
      const n = numOrNull(v);
      return Number.isFinite(n) ? Math.trunc(n) : null;
    };
    const dateOrNull = v => {
      const s = (v ?? '').trim();
      return s ? s : null; // YYYY-MM-DD 그대로 저장 (date 컬럼)
    };

    // ===== 패널 열고 닫기 =====
    const drawer = document.getElementById('sales-drawer');
    const overlay = document.getElementById('sales-overlay');

    function openDrawer() {
      overlay.classList.remove('hidden');
      requestAnimationFrame(() => {
        drawer.classList.remove('translate-x-full');
      });
      initSalesLocationSelects();
    }
    function closeDrawer() {
      drawer.classList.add('translate-x-full');
      overlay.classList.add('hidden');
      currentPerformanceId = null;
    }

    document.getElementById('open-sales-drawer')?.addEventListener('click', openDrawer);
    document.getElementById('close-sales-drawer')?.addEventListener('click', closeDrawer);
    overlay?.addEventListener('click', closeDrawer);

    // ===== 입력값 수집 =====
    function collectPerformancePayload() {
      return {
        listing_id: intOrNull(document.getElementById('f_listing_id')?.value),
        deal_type: (document.getElementById('f_deal_type')?.value ?? '').trim() || null,
        listing_title: (document.getElementById('f_listing_title')?.value ?? '').trim() || null,
        province: (document.getElementById('f_province')?.value ?? '').trim() || null,
        city: (document.getElementById('f_city')?.value ?? '').trim() || null,
        district: (document.getElementById('f_district')?.value ?? '').trim() || null,
        detail_address: (document.getElementById('f_detail_address')?.value ?? '').trim() || null,

        contract_date: dateOrNull(document.getElementById('f_contract_date')?.value),

        down_payment: numOrNull(document.getElementById('f_down_payment')?.value),
        balance: numOrNull(document.getElementById('f_balance')?.value),
        interim_payment1: numOrNull(document.getElementById('f_interim_payment1')?.value),
        interim_payment2: numOrNull(document.getElementById('f_interim_payment2')?.value),
        interim_payment3: numOrNull(document.getElementById('f_interim_payment3')?.value),
        // ✅ 새로 추가된 날짜 3개
        interim_payment1_date: dateOrNull(document.getElementById('f_interim_payment1_date')?.value),
        interim_payment2_date: dateOrNull(document.getElementById('f_interim_payment2_date')?.value),
        interim_payment3_date: dateOrNull(document.getElementById('f_interim_payment3_date')?.value),

        balance_date: dateOrNull(document.getElementById('f_balance_date')?.value),

        deposit_price: numOrNull(document.getElementById('f_deposit_price')?.value),
        monthly_rent: numOrNull(document.getElementById('f_monthly_rent')?.value),
        sale_price: numOrNull(document.getElementById('f_sale_price')?.value),
        area_py: numOrNull(document.getElementById('f_area_py')?.value),
        unit_info: (document.getElementById('f_unit_info')?.value ?? '').trim() || null,
        floor: intOrNull(document.getElementById('f_floor')?.value),

        premium_price: numOrNull(document.getElementById('f_premium_price')?.value),
        expense: numOrNull(document.getElementById('f_expense')?.value),

        buyer_fee: numOrNull(document.getElementById('f_buyer_fee')?.value),
        buyer_tax: numOrNull(document.getElementById('f_buyer_tax')?.value),
        buyer_tax_date: dateOrNull(document.getElementById('f_buyer_tax_date')?.value),

        seller_fee: numOrNull(document.getElementById('f_seller_fee')?.value),
        seller_tax: numOrNull(document.getElementById('f_seller_tax')?.value),
        seller_tax_date: dateOrNull(document.getElementById('f_seller_tax_date')?.value),

        seller_distribution_rate: numOrNull(document.getElementById('f_seller_distribution_rate')?.value),
        seller_performance: numOrNull(document.getElementById('f_seller_performance')?.value),
        buyer_performance: numOrNull(document.getElementById('f_buyer_performance')?.value),

        special_contract: (document.getElementById('f_special_contract')?.value ?? '').trim() || null,
      };
    }

    // ✅ 새 함수: 단일 행(upsert) + 금액 자동 계산
    function collectAllocationPayloadRow(performance_id) {
      const buyerPerf  = numOrNull(document.getElementById('f_buyer_performance')?.value) || 0;
      const sellerPerf = numOrNull(document.getElementById('f_seller_performance')?.value) || 0;

      const row = { performance_id };

      for (let i = 1; i <= 4; i++) {
        const sid = document.getElementById(`select_staff${i}`)?.value || null;
        const bwP = numOrNull(document.getElementById(`f_buyer_weight${i}`)?.value) || 0;   // % 단위
        const swP = numOrNull(document.getElementById(`f_seller_weight${i}`)?.value) || 0;

        const bw = bwP * 0.01; // 0~1
        const sw = swP * 0.01;

        row[`staff_id${i}`]       = sid || null;
        row[`buyer_weight${i}`]   = sid ? bw : 0;
        row[`seller_weight${i}`]  = sid ? sw : 0;
        row[`buyer_amount${i}`]   = sid ? Math.round(buyerPerf  * bw) : 0;
        row[`seller_amount${i}`]  = sid ? Math.round(sellerPerf * sw) : 0;
      }

      return row;
    }


    function resetForm() {
      document.querySelectorAll('#sales-drawer input, #sales-drawer textarea, #sales-drawer select')
        .forEach(el => {
          if (el.id === 'f_seller_distribution_rate') { el.value = 30; return; }
          if (el.tagName === 'SELECT') el.value = '';
          else el.value = '';
        });
    }

    // ===== 저장 처리 =====
    document.getElementById('save-sales')?.addEventListener('click', async (evt) => {
      // evt.preventDefault();  // type="button"이면 불필요
      if (__saving) return;
      __saving = true;
      try {
        if (!window.supabase) { showToast('Supabase 클라이언트를 찾을 수 없습니다.'); return; }

        // 직원은 분배율 30 고정
        const distEl = document.getElementById('f_seller_distribution_rate');
        if (window.__isStaff && distEl) {
          distEl.value = 30;
          if (typeof calculateFees === 'function') calculateFees();
        }

        if (!validateTotalWeight()) return;

        const payload = collectPerformancePayload();
        if (!payload.deal_type && !payload.listing_title) {
          showToast('거래유형 또는 매물명을 입력하세요.');
          return;
        }

        let perfId = currentPerformanceId;

        if (perfId) {
          // === UPDATE ===
          const { error: upErr } = await window.supabase
            .from('performance')
            .update(payload)
            .eq('id', perfId);
          if (upErr) { showToast('매출 수정 실패: ' + upErr.message); return; }

          const allocRow = collectAllocationPayloadRow(perfId);
          const anySelected = [1,2,3,4].some(i => !!allocRow[`staff_id${i}`]);
          if (!anySelected) {
            const { error: delErr } = await window.supabase
              .from('performance_allocations')
              .delete()
              .eq('performance_id', perfId);
            if (delErr) { showToast('분배 삭제 실패: ' + delErr.message); return; }
          } else {
            const { error: upsertErr } = await window.supabase
              .from('performance_allocations')
              .upsert(allocRow, { onConflict: 'performance_id', ignoreDuplicates: false });
            if (upsertErr) { showToast('분배 저장 실패: ' + upsertErr.message); return; }
          }

          showToast('수정 완료!', { ok: true });
        } else {
          // === INSERT ===
          const { data: perfInsert, error: perfErr } = await window.supabase
            .from('performance')
            .insert(payload)
            .select('id')
            .single();
          if (perfErr) { showToast('매출 저장 실패: ' + perfErr.message); return; }

          perfId = perfInsert?.id;
          if (!perfId) { showToast('생성된 매출 ID를 확인할 수 없습니다.'); return; }

          const allocRow = collectAllocationPayloadRow(perfId);
          const anySelected = [1,2,3,4].some(i => !!allocRow[`staff_id${i}`]);
          if (anySelected) {
            const { error: upsertErr } = await window.supabase
              .from('performance_allocations')
              .upsert(allocRow, { onConflict: 'performance_id', ignoreDuplicates: false });
            if (upsertErr) {
              await window.supabase.from('performance').delete().eq('id', perfId); // 롤백
              showToast('분배 저장 실패. 작업이 취소되었습니다: ' + upsertErr.message);
              return;
            }
          }

          showToast('저장 완료!', { ok: true });
        }

        currentPerformanceId = null;
        resetForm();
        closeDrawer();
        loadPerformanceTable();
      } catch (err) {
        console.error(err);
        showToast('예상치 못한 오류가 발생했습니다.');
      } finally {
        __saving = false;
      }
    });

    // ===== window.supabase 노출 (type="module" 블록에서 만든 인스턴스 공유) =====
    // 위쪽 module 스크립트가 끝난 뒤 실행되는 이 블록에서 접근 가능하도록 트릭:
    (function exposeSupabase() {
      try {
        // 전역 window 객체에 이미 있으면 패스
        if (!window.supabase && typeof window.createClient === 'undefined') {
          // 모듈 스코프에 있으나 전역으로 안 보일 수 있어서, 이미 만들어진 인스턴스를 다시 참조
          // 현재 파일에서는 module 블록 내 변수명 'supabase' 를 직접 접근할 수 없으므로,
          // 간단한 방법: module 블록 하단에 window.supabase = supabase; 한 줄을 추가하는 편이 가장 안전.
        }
      } catch {}
    })();

    // ===== f_manager에 select box 구성 =====
    document.addEventListener("supabase-ready", async () => {
      const supabase = window.supabase;

      const { data: sessionRes } = await supabase.auth.getSession();
      const user = sessionRes?.session?.user;

      if (!user?.id) return;

      // 로그인 유저 정보
      const { data: myProfile, error: myErr } = await supabase
        .from("staff_profiles")
        .select("affiliation")
        .eq("user_id", user.id)
        .maybeSingle();

      if (myErr || !myProfile) {
        console.error("로그인 유저 소속 조회 실패", myErr);
        return;
      }

      const myAffiliation = myProfile.affiliation;

      // 모든 재직자 불러오기
      const { data: allStaff, error } = await supabase
        .from("staff_profiles")
        .select("id, name, affiliation")
        .is("leave_date", null)
        .order("affiliation", { ascending: true });

      if (error || !allStaff) {
        console.error("직원 목록 불러오기 실패", error);
        return;
      }

      // 소속 기준 분류
      const grouped = {};
      for (const row of allStaff) {
        const { id, name, affiliation } = row;
        if (!grouped[affiliation]) grouped[affiliation] = [];
        grouped[affiliation].push({ id, name });
      }

      const select = document.getElementById("select_staff1");
      if (!select) return;
      select.innerHTML = `<option value="">-- 직원 선택 --</option>`; // 초기화


      // 1. 본인 소속 먼저 추가
      if (grouped[myAffiliation]) {
        const optGroup = document.createElement("optgroup");
        optGroup.label = myAffiliation;
        grouped[myAffiliation].forEach(({ id, name }) => {
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = name;
          optGroup.appendChild(opt);
        });
        select.appendChild(optGroup);
        delete grouped[myAffiliation]; // 중복 방지
      }

      // 2. 나머지 소속 추가 (정렬 포함)
      Object.entries(grouped)
        .sort(([a], [b]) => a.localeCompare(b, "ko"))
        .forEach(([aff, list]) => {
          const optGroup = document.createElement("optgroup");
          optGroup.label = aff;
          list.forEach(({ id, name }) => {
            const opt = document.createElement("option");
            opt.value = id;
            opt.textContent = name;
            optGroup.appendChild(opt);
          });
          select.appendChild(optGroup);
        });
    });

    // 매물번호 입력시 정보 자동으로 채우기
    // ====== 매물번호로 자동 채우기 (public_baikuk_view 버전) ======

    // 1) 폼 필드 매핑 (view에 있는 컬럼만)
    const FIELD_MAP = {
      deal_type:       'f_deal_type',
      listing_title:   'f_listing_title',
      province:        'f_province',
      city:            'f_city',
      district:        'f_district',
      deposit_price:   'f_deposit_price',
      monthly_rent:    'f_monthly_rent',
      sale_price:      'f_sale_price',
      area_py:         'f_area_py',
      floor:           'f_floor',
    };

    // 2) 값 채우기 헬퍼 - select에 넣을 때 trim
    function setInputValue(id, value) {
      const el = document.getElementById(id);
      if (!el) return;
      const vRaw = (value == null) ? '' : String(value);
      const v = vRaw.trim();

      if (el.tagName === 'SELECT') {
        const exists = Array.from(el.options).some(o => o.value === v);
        if (v && !exists) {
          const opt = document.createElement('option');
          opt.value = v; opt.textContent = v;
          el.appendChild(opt);
        }
        el.value = v;

        // ✅ 거래유형이 프로그램적으로 바뀐 경우, 이벤트 트리거 + 즉시 반영
        if (id === 'f_deal_type') {
          el.dispatchEvent(new Event('change', { bubbles: true })); // 바인딩된 핸들러 호출
          if (typeof updateHighlight === 'function') updateHighlight(); // 라벨 즉시 갱신
          if (typeof calculateFees === 'function') calculateFees();     // 수수료/매출 즉시 갱신
          if (typeof calculateDownPaymentAndBalance === 'function') calculateDownPaymentAndBalance();
        }
      } else {
        el.value = vRaw;
      }

      if (id === 'f_unit_info' && el.hasAttribute('data-autowidth')) {
        autosizeInputByCh(el);
      }
    }

    const MONEY_FIELD_IDS = new Set([
      "f_sale_price","f_deposit_price","f_monthly_rent","f_premium_price",
      "f_buyer_fee","f_buyer_tax","f_seller_fee","f_seller_tax",
      "f_buyer_performance","f_seller_performance","f_expense"
    ]);

    function fillFormFromRow(row) {
      Object.entries(FIELD_MAP).forEach(([col, inputId]) => {
        let val = row?.[col] ?? '';

        // 10,000 배 변환 (만원 → 원)
        if (["deposit_price","monthly_rent","sale_price","premium_price"].includes(col)) {
          if (val != null && val !== '') val = Number(val) * 10000;
        }

        setInputValue(inputId, val);

        // 💡 금액 필드는 바로 콤마로 보이도록
        if (MONEY_FIELD_IDS.has(inputId)) {
          const el = document.getElementById(inputId);
          if (el) el.value = formatNumberWithCommas(el.value);
        }
      });
    }

    // 3) 조회 함수
    async function fetchListingAndFill(listingId) {
      try { await waitForSupabase(); } 
      catch { showToast('Supabase 초기화 지연'); return; }

      const n = intOrNull(listingId);
      if (n === null) return; // 숫자 아닐 때 종료

      const selectCols = Object.keys(FIELD_MAP).join(', ');

      // 1) 지정 컬럼으로 조회
      let { data, error } = await window.supabase
        .from('public_baikuk_view')
        .select(selectCols)
        .eq('listing_id', n)
        .maybeSingle();

      if (error) {
        const msg = (error.message || '').toLowerCase();

        // 컬럼 문제 → 전체(*) 재조회 후 교차 매핑
        if (msg.includes('does not exist') || msg.includes('column')) {
          const retry = await window.supabase
            .from('public_baikuk_view')
            .select('*')
            .eq('listing_id', n)
            .maybeSingle();

          if (retry.error) {
            showToast('매물 조회 실패: ' + (retry.error.message || ''));
            return;
          }
          if (!retry.data) { showToast('해당 매물번호를 찾을 수 없습니다.'); return; }

          const row = retry.data;
          fillFormFromRow(row);
          calculateFees();
          calculateDownPaymentAndBalance();

          // 선택값과 무관하게 드롭다운을 강제로 맞춤
          initSalesLocationSelects({
            province: row.province, city: row.city, district: row.district
          });
          showToast('매물 정보 자동 채움 완료(교차 매핑)', { ok: true });
          return;
        }

        if (msg.includes('relation') && msg.includes('does not exist')) {
          showToast('뷰를 찾을 수 없습니다. public 스키마의 public_baikuk_view 확인 필요');
        }
        return;
      }

      // 2) 정상 채움
      fillFormFromRow(data);
      calculateFees();
      calculateDownPaymentAndBalance();

      // 선택값과 상관없이 드롭다운을 해당 값으로 재구성+선택
      initSalesLocationSelects({
        province: data.province, city: data.city, district: data.district
      });

      // ✅ 거래유형에 맞춰 라벨/색 즉시 갱신
      if (typeof updateHighlight === "function") updateHighlight();
      showToast('매물 정보 자동 채움 완료', { ok: true });
    }
    
    // 4) 매물번호 입력 필드 바인딩 (blur 시 1회성 조회)
    (function bindListingIdOnBlur() {
      const listingIdEl = document.getElementById('f_listing_id');
      if (!listingIdEl) return;

      let lastFetched = null; // 마지막으로 조회한 값 저장

      listingIdEl.addEventListener('blur', () => {
        const val = (listingIdEl.value || '').trim();
        if (!val) return;

        // 이전에 같은 값으로 조회했다면 패스
        if (val === lastFetched) return;

        fetchListingAndFill(val);
        lastFetched = val;
      });

      // 선택: 드로어 닫힐 때 lastFetched 초기화
      const drawer = document.getElementById('sales-drawer');
      if (drawer) {
        drawer.addEventListener('transitionend', () => {
          if (drawer.classList.contains('translate-x-full')) {
            lastFetched = null;
          }
        });
      }
    })();

    // 주소 선택 관련 함수들
    async function fetchAllPCD(batchSize = 1000) {
      if (_pcdCache) return _pcdCache;

      await waitForSupabase();
      const supa = window.supabase;

      let from = 0;
      const all = [];

      while (true) {
        const to = from + batchSize - 1;  // range는 양끝 포함
        const { data, error } = await supa
          .from('province_city_district')             // ✅ 테이블
          .select('province, city, district')
          .order('province', { ascending: true })     // ✅ 페이지 간 정렬 고정
          .order('city', { ascending: true })
          .order('district', { ascending: true })
          .range(from, to);

        if (error) throw error;

        const chunk = data || [];
        all.push(...chunk);

        // ✅ 더 이상 받아올 게 없으면 종료
        if (chunk.length === 0) break;

        // 다음 페이지로 이동 (실제 받은 개수만큼 전진)
        from += chunk.length;
      }

      console.log('[PCD] loaded rows:', all.length);
      _pcdCache = all;
      return all;
    }

    // ===== 지역(시/도-시/군/구-읍/면/동) 의존형 드롭다운 (sales 폼용) =====
    async function initSalesLocationSelects(preset = {}) {
      const provinceEl = document.getElementById('f_province');
      const cityEl     = document.getElementById('f_city');
      const districtEl = document.getElementById('f_district');
      if (!provinceEl || !cityEl || !districtEl) return;

      // 현재 값(자동채움으로 미리 들어온 값이 있으면 우선 사용)
      const selected = {
        province: preset.province ?? provinceEl.value ?? '',
        city:     preset.city     ?? cityEl.value     ?? '',
        district: preset.district ?? districtEl.value ?? '',
      };

      const setPlaceholder = () => {
        provinceEl.innerHTML = `<option value="">시/도</option>`;
        cityEl.innerHTML     = `<option value="">시/군/구</option>`;
        districtEl.innerHTML = `<option value="">읍/면/동</option>`;
      };
      setPlaceholder();

      // 정렬/유틸
      const collate = new Intl.Collator('ko-KR');
      const uniq = arr => Array.from(new Set(arr));
      const sortKo = arr => arr.sort((a,b)=>collate.compare(a,b));

      const fillSelect = (selectEl, values, selectedVal) => {
        // placeholder 유지 후 값 채우기
        const ph = selectEl.querySelector('option[value=""]');
        selectEl.innerHTML = '';
        if (ph) selectEl.appendChild(ph);

        let list = [...values];
        if (selectedVal && !values.includes(selectedVal)) list = [selectedVal, ...values];

        for (const v of list) {
          const opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          if (selectedVal && v === selectedVal) opt.selected = true;
          selectEl.appendChild(opt);
        }
      };

      // 데이터 로드
      let rows = [];
      try {
        if (typeof fetchAllPCD !== 'function') throw new Error('fetchAllPCD가 정의되어 있지 않음');
        rows = await fetchAllPCD(); // 필요시 상한 조정
      } catch (e) {
        console.error('지역 데이터 로드 실패:', e);
        // 실패 시에도 현재 선택값만이라도 보이도록
        fillSelect(provinceEl, selected.province ? [selected.province] : [], selected.province);
        fillSelect(cityEl,     selected.city     ? [selected.city]     : [], selected.city);
        fillSelect(districtEl, selected.district ? [selected.district] : [], selected.district);
        return;
      }

      // 맵 구성
      const citiesByProv = new Map();            // province -> Set(cities)
      const distsByProvCity = new Map();         // `${province}|${city}` -> Set(districts)
      for (const { province, city, district } of rows) {
        if (!province || !city || !district) continue;
        if (!citiesByProv.has(province)) citiesByProv.set(province, new Set());
        citiesByProv.get(province).add(city);

        const key = `${province}|${city}`;
        if (!distsByProvCity.has(key)) distsByProvCity.set(key, new Set());
        distsByProvCity.get(key).add(district);
      }

      const provinces = sortKo(uniq(rows.map(r => r.province).filter(Boolean)));

      // 1) province
      fillSelect(provinceEl, provinces, selected.province);

      // 2) city (province에 종속)
      const selProvince = provinceEl.value || selected.province || '';
      const cities = selProvince ? sortKo(uniq([...(citiesByProv.get(selProvince) || [])])) : [];
      fillSelect(cityEl, cities, selected.city);

      // 3) district (province+city에 종속)
      const selCity = cityEl.value || selected.city || '';
      const key = `${selProvince}|${selCity}`;
      const districts = (selProvince && selCity) ? sortKo(uniq([...(distsByProvCity.get(key) || [])])) : [];
      fillSelect(districtEl, districts, selected.district);

      // 이벤트 바인딩
      provinceEl.onchange = () => {
        const p = provinceEl.value;
        const cities2 = p ? sortKo(uniq([...(citiesByProv.get(p) || [])])) : [];
        fillSelect(cityEl, cities2, '');
        fillSelect(districtEl, [], '');
      };

      cityEl.onchange = () => {
        const p = provinceEl.value;
        const c = cityEl.value;
        const k = `${p}|${c}`;
        const d2 = (p && c) ? sortKo(uniq([...(distsByProvCity.get(k) || [])])) : [];
        fillSelect(districtEl, d2, '');
      };
    }

    function recalcPerformanceFromFees() {
      const buyerFee = numOrNull(document.getElementById("f_buyer_fee")?.value) || 0;
      const sellerFee = numOrNull(document.getElementById("f_seller_fee")?.value) || 0;
      const distRate  = numOrNull(document.getElementById("f_seller_distribution_rate")?.value) || 0;

      const sellerPerformance = sellerFee * distRate * 0.01;
      const buyerPerformance  = (buyerFee + sellerFee) - sellerPerformance;

      document.getElementById("f_seller_performance").value = formatNumberWithCommas(Math.round(sellerPerformance));
      document.getElementById("f_buyer_performance").value  = formatNumberWithCommas(Math.round(buyerPerformance));
    }

    // 수수료 필드 변경 시 매출만 갱신
    ["f_buyer_fee","f_seller_fee"].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("input",  recalcPerformanceFromFees);
        el.addEventListener("change", recalcPerformanceFromFees);
      }
    });

    // ===== 수수료 + 매출 자동 계산 ===== trim 적용
    function calculateFees() {
      const type = (document.getElementById("f_deal_type")?.value || '').trim(); // ✅
      const salePrice   = numOrNull(document.getElementById("f_sale_price")?.value) || 0;
      const deposit     = numOrNull(document.getElementById("f_deposit_price")?.value) || 0;
      const monthlyRent = numOrNull(document.getElementById("f_monthly_rent")?.value) || 0;

      let 기준금액 = 0;
      if (type === "매매") 기준금액 = salePrice;
      else if (type === "월세") 기준금액 = monthlyRent * 100 + deposit;
      else return;

      const fee = 기준금액 >= 50_000_000 ? 기준금액 * 0.009 : 기준금액 * 0.007;
      const buyerFeeEl = document.getElementById("f_buyer_fee");
      const sellerFeeEl = document.getElementById("f_seller_fee");
      const distRateEl  = document.getElementById("f_seller_distribution_rate");

      buyerFeeEl.value  = formatNumberWithCommas(Math.round(fee));
      sellerFeeEl.value = formatNumberWithCommas(Math.round(fee));

      const buyerFee = numOrNull(buyerFeeEl.value) || 0;
      const sellerFee = numOrNull(sellerFeeEl.value) || 0;
      const distRate = numOrNull(distRateEl.value) || 0;

      const sellerPerformance = sellerFee * distRate * 0.01;
      const buyerPerformance  = (buyerFee + sellerFee) - sellerPerformance;

      document.getElementById("f_seller_performance").value = formatNumberWithCommas(Math.round(sellerPerformance));
      document.getElementById("f_buyer_performance").value  = formatNumberWithCommas(Math.round(buyerPerformance));
    }

    // 이벤트 바인딩 (값이 변할 때마다 자동계산)
    ["f_deal_type","f_sale_price","f_deposit_price","f_monthly_rent"].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("input", calculateFees);
        el.addEventListener("change", calculateFees);
      }
    });
    document.getElementById("f_seller_distribution_rate")?.addEventListener("input",  calculateFees);
    document.getElementById("f_seller_distribution_rate")?.addEventListener("change", calculateFees);

    // ===== 숫자 입력에 콤마 표시 =====
    function formatNumberWithCommas(value) {
      if (value === null || value === undefined || value === '') return '';
      const num = Number(String(value).replace(/,/g, ''));
      return Number.isFinite(num) ? num.toLocaleString('ko-KR') : value;
    }

    function attachCommaFormatter(id) {
      const el = document.getElementById(id);
      if (!el) return;

      // 입력할 때마다 숫자 변환 + 콤마 표시
      el.addEventListener("input", () => {
        const cursor = el.selectionStart;
        const raw = el.value.replace(/,/g, '');
        if (!raw) { el.value = ''; return; }
        const num = Number(raw);
        if (!isNaN(num)) {
          el.value = formatNumberWithCommas(num);
          // 커서 위치 보정 (선택사항)
          el.setSelectionRange(cursor, cursor);
        }
      });

      // 포커스 잃었을 때도 포맷 적용
      el.addEventListener("blur", () => {
        el.value = formatNumberWithCommas(el.value);
      });
    }

    // ===== 포맷 적용할 필드들 =====
    [
      "f_sale_price",
      "f_deposit_price",
      "f_monthly_rent",
      "f_premium_price",
      "f_down_payment",
      "f_balance",
      "f_buyer_fee",
      "f_buyer_tax",
      "f_seller_fee",
      "f_seller_tax",
      "f_buyer_performance",
      "f_seller_performance",
      "f_expense"
    ].forEach(attachCommaFormatter);

    // 매출내역 수정창에 띄우기
    function setField(id, v, {comma=false} = {}) {
      const el = document.getElementById(id);
      if (!el) return;
      if (comma) {
        el.value = formatNumberWithCommas(v ?? '');
      } else {
        el.value = (v ?? '') === null ? '' : String(v ?? '');
      }
      // select의 경우 값이 없으면 그대로(옵션은 init에서 채워짐)
    }

    function fillFormWithPerformance(row) {
      // 기본 정보
      setField('f_listing_id', row.listing_id);
      setField('f_listing_title', row.listing_title);
      // 지역 선택은 드롭다운 의존 → 값을 먼저 저장해두고 initSalesLocationSelects로 세팅
      initSalesLocationSelects({
        province: row.province, city: row.city, district: row.district
      });
      setField('f_detail_address', row.detail_address);
      setField('f_floor', row.floor);
      setField('f_unit_info', row.unit_info);

      // 금액/면적/거래유형
      setField('f_deal_type', row.deal_type);
      // toLocale 콤마 표시
      setField('f_sale_price', row.sale_price, {comma:true});
      setField('f_deposit_price', row.deposit_price, {comma:true});
      setField('f_monthly_rent', row.monthly_rent, {comma:true});
      setField('f_premium_price', row.premium_price, {comma:true});
      setField('f_area_py', row.area_py);

      // 일정
      setField('f_down_payment', row.down_payment, {comma:true});
      setField('f_balance', row.balance, {comma:true});
      setField('f_contract_date', row.contract_date);
      setField('f_balance_date',  row.balance_date);
      setField('f_interim_payment1', row.interim_payment1);
      setField('f_interim_payment1_date', row.interim_payment1_date);
      setField('f_interim_payment2', row.interim_payment2);
      setField('f_interim_payment2_date', row.interim_payment2_date);
      setField('f_interim_payment3', row.interim_payment3);
      setField('f_interim_payment3_date', row.interim_payment3_date);

      // 수수료/세금/매출
      setField('f_buyer_fee', row.buyer_fee, {comma:true});
      setField('f_buyer_tax', row.buyer_tax, {comma:true});
      setField('f_buyer_tax_date', row.buyer_tax_date);
      setField('f_seller_fee', row.seller_fee, {comma:true});
      setField('f_seller_tax', row.seller_tax, {comma:true});
      setField('f_seller_tax_date', row.seller_tax_date);

      // 매출 자동계산 필드(표시만)
      // 분배율은 현재 정책(직원은 30 고정)이 있으므로 값 그대로 두거나 필요 시 조정
      recalcPerformanceFromFees();

      // 특약사항
      setField('f_special_contract', row.special_contract);
    }

    function fillAllocations(pa) {
      // 초기화
      for (let i=1;i<=4;i++){
        const sel = document.getElementById(`select_staff${i}`);
        const bw  = document.getElementById(`f_buyer_weight${i}`);
        const sw  = document.getElementById(`f_seller_weight${i}`);
        if (sel) sel.value = '';
        if (bw)  bw.value  = '';
        if (sw)  sw.value  = '';
      }
      if (!pa) return;

      for (let i=1;i<=4;i++){
        const sel = document.getElementById(`select_staff${i}`);
        const bw  = document.getElementById(`f_buyer_weight${i}`);
        const sw  = document.getElementById(`f_seller_weight${i}`);

        const sid = pa[`staff_id${i}`];
        const wB  = pa[`buyer_weight${i}`];
        const wS  = pa[`seller_weight${i}`];

        if (sel && sid) sel.value = sid;
        if (bw && wB != null) bw.value = Math.round(wB * 100);
        if (sw && wS != null) sw.value = Math.round(wS * 100);
      }
    }

  </script>

</body>
</html>
