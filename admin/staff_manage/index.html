<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì§ì›ì •ë³´</title>
  <link rel="icon" type="image/png" href="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/pabicon-baikuk-simbol.png" />
  <link rel="preconnect" href="https://sfinbtiqlfnaaarziixu.supabase.co" crossorigin>
  <link rel="dns-prefetch" href="//sfinbtiqlfnaaarziixu.supabase.co">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    window.MY_AUTHORITY = null;
    window.IS_STAFF = false;
  </script>
  <style>
    .shadow-right {
      box-shadow: 8px 0 12px -4px rgba(0, 0, 0, 0.08);
    }
    th.resizable {
      position: relative;
      min-width: 40px;
      white-space: nowrap;
    }
    .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      width: 0.4rem;
      height: 100%;
      cursor: col-resize;
      z-index: 10;
      background-color: transparent;
    }
    .input-error {
      border-color: #ef4444 !important;
      box-shadow: 0 0 0 1px #ef4444 inset;
    }
  </style>
  <script>
    window.STAFF_BASE_ROWS = [];
  </script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://sfinbtiqlfnaaarziixu.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaW5idGlxbGZuYWFhcnppaXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MDkxNjEsImV4cCI6MjA2ODA4NTE2MX0.4-7vnIjbF-biWWuv9-vTxK9Y99gMm-vS6oaRMdRL5fA'
    );

    window.supabase = supabase; // ì „ì—­ìœ¼ë¡œ ì ‘ê·¼
    window.FORM_MODE = 'create';
    window.CURRENT_EDIT_USER_ID = null;
    
    // âœ… ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸ í›„ ì—†ìœ¼ë©´ /index.htmlë¡œ ì´ë™
    (async () => {
      const { data, error } = await supabase.auth.getSession();
      if (!data?.session) {
        console.warn("ë¡œê·¸ì¸ ì„¸ì…˜ ì—†ìŒ â†’ /index.htmlë¡œ ì´ë™");
        location.replace("/");
      }
    })();

  </script>
</head>
<body class="w-screen">
  <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-[9999] hidden">
    ë©”ì‹œì§€ ì˜ì—­
  </div>
  <div class="absolute top-0 left-0 z-[9998] bg-white w-[13rem] h-[60px] rounded-xl">
    <img src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/logotype-baikuk.png"
        alt="ê¸€ì”¨ë¡œê³ "
        class="absolute h-11 w-auto cursor-pointer top-2 left-2 z-[9999]"
        onclick="location.reload()"/>
  </div>
  <div class="flex min-h-screen">
    <div class="w-[6%] pt-[5rem] shadow-right text-center bg-white">
      <a href="https://baikuk.com/map" target="_blank">
        <div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">ë°±ì–µì§€ë„</div>
      </a>
      <a href="/admin/listings/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë§¤ë¬¼ì¥ë¶€</div></a>
      <a href="/admin/recommend_imDae/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ì„ëŒ€ì¶”ì²œ</div></a>
      <a href="/admin/recommend_maeMae/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë§¤ë§¤ì¶”ì²œ</div></a>
      <a href="/admin/customer_manage/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">ëª¨ë“ ê³ ê°</div></a>
      <a href="/admin/ad_censorship/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ê´‘ê³ ê´€ë¦¬</div></a>
      <a href="/admin/performance/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë§¤ì¶œ</div></a>
      <a href="/admin/staff_manage/"><div class="bg-gray-100 border-l-4 border-gray-500 text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">ì§ì›ì •ë³´</div></a>
      <a id="settlement-tab" href="/admin/settlement/" style="display:none">
        <div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">ì •ì‚°</div>
      </a>
    </div>
    <div class="w-[93%] flex flex-col bg-gray-100 p-6 overflow-x-auto">
      <div class="mt-[4rem]">
        <div class="w-[70rem]">
          <div class="flex">
            <button id="toggle-edit-btn" onclick="openSignupPanel()" class="mr-10 mb-[0.5rem] h-[2rem] bg-blue-500 hover:bg-blue-600 text-white text-sm px-2 py-1 rounded">
              íšŒì›ê°€ì…
            </button>
            <!-- ğŸ‘‡ ë¶€ì„œ í•„í„° ì…ë ¥ì°½ -->
            <input id="filter-aff" type="text"
                  placeholder="ë¶€ì„œ í•„í„°"
                  class="mb-2 h-[2rem] px-2 py-1 border rounded text-sm w-[7rem]" />
          </div>
          <table id="staffTable" class="bg-white rounded shadow overflow-hidden">
            <thead>
              <tr class="bg-gray-200 text-center text-sm font-semibold text-gray-700">
                <th class="px-1 py-1 w-[5rem]">ì´ë¦„</th>
                <th class="px-1 py-1 w-[6.5rem]">ë¶€ì„œ</th>
                <th class="px-1 py-1 w-[4rem]">ì§ê¸‰</th>
                <th class="px-1 py-1 w-[5rem]">ê¶Œí•œ</th>
                <th class="px-1 py-1 w-[4rem]">ì„±ë³„</th>
                <th class="px-1 py-1 w-[7rem]">ìƒì¼</th>
                <th class="px-1 py-1 w-[7rem]">ì…ì‚¬ì¼</th>
                <th id="th-leave-date" class="px-1 py-1 w-[7rem]">í‡´ì‚¬ì¼</th>
                <th class="px-1 py-1 w-[9rem]">ì „í™”ë²ˆí˜¸</th>
                <th class="px-1 py-1 w-[8rem]">ë‚´ì„ ë²ˆí˜¸</th>
                <th id="th-max-sessions" class="px-1 py-1 w-[6rem]">ë¡œê·¸ì¸ê¸°ê¸°</th>
              </tr>
            </thead>
            <tbody id="staffTableBody" class="text-sm text-gray-800">
              <!-- ì—¬ê¸°ì— ë°ì´í„°ê°€ ì±„ì›Œì§ˆ ì˜ˆì • -->
            </tbody>
          </table>
        </div>        
        <!-- íšŒì›ê°€ì… íŒ¨ë„ -->
        <div id="signupPanel" class="fixed top-0 right-0 h-full w-[28rem] bg-white shadow-lg transform translate-x-full transition-transform duration-300 z-[9999]">
          <div class="flex items-center justify-between px-4 py-3 border-b">
            <h2 class="text-lg font-bold">ê³„ì •ì •ë³´</h2>
            <button onclick="closeSignupPanel()" class="text-gray-500 hover:text-red-500">âœ–</button>
          </div>
          <div class="p-4 space-y-4 text-sm">
            <input type="text" id="signup-name" placeholder="ì´ë¦„" class="w-[16rem] border p-2 rounded" />
            <input type="email" id="signup-email" placeholder="ì´ë©”ì¼" class="w-[16rem] border p-2 rounded" />
            <div>
              <input type="password" id="signup-password"
                placeholder="ë¹„ë°€ë²ˆí˜¸"
                class="flex-1 w-[16rem] border p-2 rounded" />
              <button id="reset-password-btn" class="font-bold w-[16rem] bg-gray-100 text-gray-700 py-2 rounded border hover:bg-gray-200" onclick="sendResetPasswordEmail()">
                ì´ë©”ì¼ë¡œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
              </button>
            </div>
            <!-- ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ + ë³€ê²½ ë²„íŠ¼ (í¸ì§‘ëª¨ë“œ ì „ìš©) -->
            <div id="pw-row" class="mt-2 space-y-2 hidden">
              <input type="password" id="new-password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸"
                    class="w-[16rem] border p-2 rounded" />
              <button id="btn-change-password"
                      class="w-[16rem] bg-red-500 text-white py-2 rounded hover:bg-red-600">
                ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
              </button>
              <p class="text-xs text-gray-500">
                * ê´€ë¦¬ì: ëª¨ë‘ ë³€ê²½ ê°€ëŠ¥ / ì§€ì ì¥: ê°™ì€ ë¶€ì„œë§Œ / ì§ì›: ë¶ˆê°€
              </p>
            </div>
            <!-- â¬‡ï¸â¬‡ï¸ ê´‘ê³  ê³„ì • ì •ë³´ (í¸ì§‘/ê°€ì… ê³µìš©) â¬‡ï¸â¬‡ï¸ -->
            <div id="ad-rows" class="mt-3 space-y-2">
              <div class="flex items-center gap-2">
                <label for="signup-ad-channel" class="w-[6rem] text-gray-600">ê´‘ê³ ì±„ë„</label>
                <input id="signup-ad-channel" type="text" class="w-[16rem] border p-2 rounded"
                      placeholder="ì˜ˆ: í•œê²½, ë§¤ê²½, ë±…í¬ .." />
              </div>
              <div class="flex items-center gap-2">
                <label for="signup-ad-account-id" class="w-[6rem] text-gray-600">ê´‘ê³ ê³„ì • ID</label>
                <input id="signup-ad-account-id" type="text" class="w-[16rem] border p-2 rounded"
                      placeholder="hh9222580, choinho7, kk9222580 .." autocomplete="off" />
              </div>
              <div class="flex items-center gap-2">
                <label for="signup-ad-account-pw" class="w-[6rem] text-gray-600">ê´‘ê³ ê³„ì • PW</label>
                <div class="flex items-center gap-2">
                  <input id="signup-ad-account-pw" type="password" class="w-[16rem] border p-2 rounded"
                        placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="new-password" />
                  <button type="button" id="toggle-ad-pw" class="text-xs px-2 py-1 border rounded">ë³´ê¸°</button>
                </div>
              </div>
              <p class="text-xs text-gray-500">
                * ì—¬ëŸ¬ ì±„ë„ ê´€ë¦¬ ì‹œ ì±„ë„ëª…, ID, PWë¥¼ ì½¤ë§ˆ(,)ë¡œ êµ¬ë¶„í•´ ì…ë ¥í•˜ì„¸ìš”.<br>
              </p>
            </div>
            <div class="flex gap-5">
              <div class="flex">
                <div class="mr-[0.5rem] p-1">
                  ì§ê¸‰: 
                </div>
                <select id="signup-position" class="w-[7.5rem] border rounded">
                  <option value="">ì„ íƒ</option>
                  <option value="ì‹¤ì¥">ì‹¤ì¥</option>
                  <option value="íŒ€ì¥">íŒ€ì¥</option>
                  <option value="ë¶€ì¥">ë¶€ì¥</option>
                  <option value="ëŒ€í‘œ">ëŒ€í‘œ</option>
                </select>
              </div>
              <div class="flex">
                <div class="mr-[0.5rem] p-1 mr-[1.5rem]">
                  ë¶€ì„œ: 
                </div>
                <select id="signup-affiliation" class="w-[7.5rem] border rounded">
                  <option value="">ì„ íƒ</option>
                  <option value="ì¼ì‚°ë³¸ì ">ì¼ì‚°ë³¸ì </option>
                  <option value="íŒŒì£¼ëª©ë™ì ">íŒŒì£¼ëª©ë™ì </option>
                  <option value="íŒŒì£¼ì•¼ë‹¹ì ">íŒŒì£¼ì•¼ë‹¹ì </option>
                </select>
              </div>
            </div>
            <div class="flex gap-5">
              <div class="flex">
                <div class="mr-[0.5rem] p-1">
                  ê¶Œí•œ: 
                </div>
                <select id="signup-authority" class="w-[7.5rem] border rounded">
                  <option value="">ì„ íƒ</option>
                  <option value="ì§ì›">ì§ì›</option>
                  <option value="ì§€ì ì¥">ì§€ì ì¥</option>
                  <option value="ê´€ë¦¬ì">ê´€ë¦¬ì</option>
                </select>
              </div>
              <div class="flex">
                <div class="mr-[0.5rem] p-1 mr-[1.5rem]">
                  ì„±ë³„: 
                </div>
                <select id="signup-gender" class="w-[7.5rem] border rounded">
                  <option value="">ì„ íƒ</option>
                  <option value="ë‚¨">ë‚¨</option>
                  <option value="ì—¬">ì—¬</option>
                </select>
              </div>
            </div>
            <div class="flex gap-5">
              <div class="flex">
                <div class="mr-[0.5rem] p-1">
                  ìƒì¼: 
                </div>
                <input type="date" id="signup-birth" placeholder="ìƒì¼" class="border p-1 rounded" />
              </div>
            </div>
            <div class="flex gap-5">
              <div class="flex">
                <div class="mr-[0.5rem] p-1">
                  ì…ì‚¬ì¼: 
                </div>
                <input type="date" id="signup-join" placeholder="ì…ì‚¬ì¼" class="border p-1 rounded" />
              </div>
              <div id="row-leave-date" class="flex">
                <div class="mr-[0.5rem] p-1">
                  í‡´ì‚¬ì¼:
                </div>
                <input type="date" id="signup-leave" placeholder="í‡´ì‚¬ì¼" class="border p-1 rounded" />
              </div>
            </div>
            <!-- ë¡œê·¸ì¸ê¸°ê¸°(ìµœëŒ€) -->
            <div class="flex items-center gap-3">
              <label for="signup-max-sessions" class="w-[5rem]">ë¡œê·¸ì¸ê¸°ê¸°:</label>
              <input
                type="number"
                id="signup-max-sessions"
                placeholder="ì˜ˆ: 2"
                class="border p-1 rounded w-[3rem]"
                min="1" max="10" step="1"
              />
              <span class="text-xs text-gray-500">ìµœëŒ€ ë™ì‹œ ë¡œê·¸ì¸ ê¸°ê¸° ìˆ˜</span>
            </div>
            <input type="text" id="signup-phone" placeholder="010-9199-1944" class="w-full border p-1 rounded" />
            <input type="text" id="signup-extension" placeholder="031-988-8555" class="w-full border p-1 rounded" />
            <button data-role="submit" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
              ê°€ì…í•˜ê¸°
            </button>
          </div>
        </div>
      </div>      
    </div>
  </div>  
  <script>
    window.openSignupPanel = function () {
      window.FORM_MODE = 'create';
      window.CURRENT_EDIT_USER_ID = null;
      document.getElementById('signup-email').disabled = false;
      document.getElementById('signupPanel').classList.remove('translate-x-full');
      document.getElementById('signup-password')?.classList.remove('hidden');
      document.getElementById('reset-password-btn')?.classList.add('hidden');

      // ë²„íŠ¼ ë¼ë²¨/í•¸ë“¤ëŸ¬ ì „í™˜
      const btn = document.querySelector('#signupPanel button[data-role="submit"]');
      btn.textContent = 'ê°€ì…í•˜ê¸°';
      btn.onclick = submitSignup;  // ê¸°ì¡´ ê°€ì… í•¨ìˆ˜
      resetSignupForm();
      applyUiByAuthority();
      prepareSignupValidation(); 
    };

    window.openEditPanel = function (staff) {
      prepareSignupValidation();
      window.FORM_MODE = 'edit';
      window.CURRENT_EDIT_USER_ID = staff.user_id;
      document.getElementById('signup-password')?.classList.add('hidden'); // ë˜ëŠ” disabled = true
      document.getElementById('reset-password-btn')?.classList.remove('hidden');
      document.getElementById('signupPanel').classList.remove('translate-x-full');

      // ê°’ ì±„ìš°ê¸°
      document.getElementById('signup-name').value        = staff.name || '';
      document.getElementById('signup-email').value       = staff.email || '';
      document.getElementById('signup-password').value    = ''; // ë³´ì•ˆìƒ ë¹„ì›€
      document.getElementById('signup-position').value    = staff.position || '';
      document.getElementById('signup-affiliation').value = staff.affiliation || '';
      document.getElementById('signup-authority').value   = staff.authority || '';
      document.getElementById('signup-gender').value      = staff.gender || '';
      document.getElementById('signup-birth').value       = toDateInputValue(staff.birth_date);
      document.getElementById('signup-join').value        = toDateInputValue(staff.join_date);
      document.getElementById('signup-leave').value       = toDateInputValue(staff.leave_date);
      document.getElementById('signup-phone').value       = staff.phone_num || '';
      document.getElementById('signup-extension').value   = staff.extension || '';
      document.getElementById('signup-max-sessions').value = (staff.max_sessions ?? '');
      document.getElementById('signup-ad-channel').value     = staff.ad_channel || '';
      document.getElementById('signup-ad-account-id').value  = staff.ad_account_id || '';
      document.getElementById('signup-ad-account-pw').value  = staff.ad_account_pw || '';

      // ì´ë©”ì¼ì€ Authì™€ ì—°ê²°ë˜ë‹ˆ ìˆ˜ì • ê¸ˆì§€(ê¶Œì¥)
      document.getElementById('signup-email').disabled = true;

      // ë²„íŠ¼ ë¼ë²¨/í•¸ë“¤ëŸ¬ ì „í™˜
      const btn = document.querySelector('#signupPanel button[data-role="submit"]');
      btn.textContent = 'ì €ì¥í•˜ê¸°';
      btn.onclick = updateStaff;  // ì•„ë˜ ìƒˆ í•¨ìˆ˜
      applyUiByAuthority();

      // ì´ë©”ì¼ ë¹„í™œì„±í™” ë“± ê¸°ì¡´ ì½”ë“œë“¤...
      const allowed = canChangePasswordFor(staff);
      const row = document.getElementById('pw-row');
      row?.classList.toggle('hidden', !allowed);

      // í´ë¦­ í•¸ë“¤ëŸ¬ ë°”ì¸ë”©(ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€ìš©ìœ¼ë¡œ ë¨¼ì € ê¸°ì¡´ í•¸ë“¤ëŸ¬ ì œê±°)
      const btn_change_password = document.getElementById('btn-change-password');
      if (btn_change_password) {
        const newBtn = btn_change_password.cloneNode(true);
        btn_change_password.parentNode.replaceChild(newBtn, btn_change_password);
        newBtn.addEventListener('click', () => changePasswordForCurrentEditUser(staff));
      }

      applyUiByAuthority();
    };
    
    // ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘

    // YYYY-MM-DD ë˜ëŠ” YYYY-MM-DDTHH:mm:ss í˜•íƒœë¥¼ ì•ˆì „í•˜ê²Œ ì˜ë¼ì„œ ë°˜í™˜
    function toDateInputValue(v) {
      if (!v) return '';
      const s = String(v);
      // ISO ê°™ì€ ê²½ìš° "YYYY-MM-DD"ë§Œ ì˜ë¼ ì“°ë©´ íƒ€ì„ì¡´ ë¬¸ì œ ì—†ìŒ
      return s.slice(0, 10);
    }
    window.toDateInputValue = toDateInputValue;

    // ê´€ë¦¬ì, ì§€ì ì¥ ë‹¤ë¥¸ ì§ì› ë¹„ë²ˆ ë³€ê²½
    async function changePasswordForCurrentEditUser(staff) {
      const allowed = canChangePasswordFor(staff);
      if (!allowed) { showToast('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
      
      // ì„¸ì…˜ ë§Œë£Œ ë°©ì§€: í˜¸ì¶œ ì§ì „ì— í™•ì¸
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { showToast('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í›„ ì‹œë„í•´ì£¼ì„¸ìš”.'); return; }

      const newPwInput = document.getElementById('new-password');
      const newPw = (newPwInput?.value || '').trim();
      if (!newPw || newPw.length < 6) { showToast('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.'); return; }

      // â›”ï¸ ë²„íŠ¼ ì—°íƒ€ ë°©ì§€
      const btn = document.getElementById('btn-change-password');
      btn.disabled = true;
      const prev = btn.textContent;
      btn.textContent = 'ë³€ê²½ ì¤‘...';

      try {
        // âœ… ì—£ì§€ í•¨ìˆ˜ í˜¸ì¶œ (supabase-js v2)
        const { data, error } = await supabase.functions.invoke('admin-update-password', {
          body: { user_id: staff.user_id, new_password: newPw }
          // invokeëŠ” í˜„ì¬ ë¡œê·¸ì¸ ì„¸ì…˜ì˜ access tokenì„ ìë™ìœ¼ë¡œ Authorization í—¤ë”ì— ë„£ì–´ì¤ë‹ˆë‹¤.
        });

        if (error) throw error;
        showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        newPwInput.value = '';
      } catch (e) {
        console.error(e);
        const msg = (typeof e?.message === 'string' && e.message) || 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨';
        showToast(msg);
      } finally {
        btn.disabled = false;
        btn.textContent = prev;
      }
    }

    // ë¹„ë²ˆ ë³€ê²½ í—ˆìš© ì—¬ë¶€ í•¨ìˆ˜
    function canChangePasswordFor(staff) {
      const myAuth = window.MY_AUTHORITY;
      const myAff  = window.MY_AFFILIATION;

      if (myAuth === 'ê´€ë¦¬ì') return true;
      if (myAuth === 'ì§€ì ì¥') return staff.affiliation === myAff; // ê°™ì€ ë¶€ì„œë§Œ
      return false; // ì§ì›ì€ ë¶ˆê°€ (í˜„ì¬ UIì—ì„œ íŒ¨ë„ ìì²´ê°€ ì•ˆ ì—´ë¦¼)
    }

    // ë¦¬ìŠ¤íŠ¸ ì •ë ¬ ê´€ë ¨
    // ê¶Œí•œ ìš°ì„ ìˆœìœ„(ì›í•˜ë©´ ììœ ë¡­ê²Œ ë°”ê¾¸ì„¸ìš”)
    const AUTH_RANK = { 'ê´€ë¦¬ì': 1, 'ì§€ì ì¥': 0, 'ì§ì›': 2 };
    const collateKo = new Intl.Collator('ko-KR', { numeric: true, sensitivity: 'base' });

    function dateMs(d) {
      if (!d) return Number.MAX_SAFE_INTEGER; // ë‚ ì§œ ì—†ìœ¼ë©´ ë§¨ ë’¤ë¡œ
      const t = new Date(d).getTime();
      return Number.isFinite(t) ? t : Number.MAX_SAFE_INTEGER;
    }

    // ë¶€ì„œ â†’ ê¶Œí•œ â†’ ì…ì‚¬ì¼(ì˜¤ë˜ëœ ìˆœ) ì •ë ¬
    function sortStaff(rows = []) {
      return [...rows].sort((a, b) => {
        // âœ… 1) í‡´ì‚¬ ì—¬ë¶€ ë¨¼ì € ë¹„êµ (í‡´ì‚¬ìëŠ” í•­ìƒ ì•„ë˜)
        const aResigned = String(a.leave_date ?? '').trim() !== '';
        const bResigned = String(b.leave_date ?? '').trim() !== '';
        if (aResigned !== bResigned) {
          return aResigned ? 1 : -1;  // aê°€ í‡´ì‚¬ë©´ ì•„ë˜ë¡œ
        }

        // âœ… 2) ê¸°ì¡´ ì •ë ¬ ìœ ì§€
        const aAff = a.affiliation || '';
        const bAff = b.affiliation || '';
        const byAff = collateKo.compare(aAff, bAff);
        if (byAff !== 0) return byAff;

        const ar = AUTH_RANK[a.authority] ?? 99;
        const br = AUTH_RANK[b.authority] ?? 99;
        if (ar !== br) return ar - br;

        const at = dateMs(a.join_date);
        const bt = dateMs(b.join_date);
        return at - bt;
      });
    }


    // í‘œ ë Œë”
    function renderStaffTable(rows) {
      const tbody = document.getElementById('staffTableBody');
      tbody.innerHTML = '';

      (rows || []).forEach(staff => {
        const row = document.createElement('tr');

        const isResigned = String(staff.leave_date ?? '').trim() !== '';
        row.classList.add('hover:bg-gray-100');

        if (isResigned) {
          row.classList.add('bg-gray-100', 'opacity-80');
          row.classList.remove('hover:bg-gray-100');
          row.classList.add('hover:bg-gray-200');
        }

        // â¬‡ï¸ ê¶Œí•œì— ë”°ë¥¸ í´ë¦­ í—ˆìš©/ì°¨ë‹¨ í‘œì‹œ
        const permitted = canOpenEditFor(staff);
        row.style.cursor = permitted ? 'pointer' : 'not-allowed';
        if (!permitted) row.classList.add('opacity-70');

        row.innerHTML = `
          <td class="px-4 py-2" data-col="name">${staff.name ?? ''}</td>
          <td class="px-4 py-2" data-col="affiliation">${staff.affiliation ?? ''}</td>
          <td class="px-4 py-2" data-col="position">${staff.position ?? ''}</td>
          <td class="px-4 py-2" data-col="authority">${staff.authority ?? ''}</td>
          <td class="px-4 py-2" data-col="gender">${staff.gender ?? ''}</td>
          <td class="px-4 py-2" data-col="birth_date">${staff.birth_date ?? ''}</td>
          <td class="px-4 py-2" data-col="join_date">${staff.join_date ?? ''}</td>
          <td class="px-4 py-2 td-leave-date" data-col="leave_date">${staff.leave_date ?? ''}</td>
          <td class="px-4 py-2" data-col="phone_num">${staff.phone_num ?? ''}</td>
          <td class="px-4 py-2" data-col="extension">${staff.extension ?? ''}</td>
          <td class="px-4 py-2 td-max-sessions" data-col="max_sessions">${staff.max_sessions ?? ''}</td>
        `;

        // â¬‡ï¸ í´ë¦­ ê°€ë“œ: ê¶Œí•œ ë¶ˆê°€ë©´ í† ìŠ¤íŠ¸ë§Œ, í—ˆìš©ì´ë©´ íŒ¨ë„ ì˜¤í”ˆ
        row.addEventListener('click', () => {
          if (!canOpenEditFor(staff)) {
            showToast(denyReason(staff));
            return;
          }
          openEditPanel(staff);
        });

        tbody.appendChild(row);
      });

      applyUiByAuthority();
    }

    // ë¶€ì„œ í•„í„° ì ìš©
    function applyAffFilter() {
      const q = (document.getElementById('filter-aff')?.value || '').trim().toLowerCase();
      if (!q) { renderStaffTable(window.STAFF_BASE_ROWS); return; }

      // ìŠ¤í˜ì´ìŠ¤/ì½¤ë§ˆë¡œ ë‹¤ì¤‘ í‚¤ì›Œë“œ ì§€ì› (ëª¨ë‘ í¬í•¨ ì¡°ê±´: AND)
      const tokens = q.split(/[,\s]+/).filter(Boolean);
      const filtered = window.STAFF_BASE_ROWS.filter(r => {
        const aff = (r.affiliation ?? '').toString().toLowerCase();
        return tokens.every(t => aff.includes(t));
      });
      renderStaffTable(sortStaff(filtered));
    }
    
    // ê¶Œí•œì— ë”°ë¼ UI ìˆ¨ê¹€/ë¹„í™œì„±í™” ì ìš©
    function applyUiByAuthority() {
      const myAuth = window.MY_AUTHORITY;
      const isStaff = (myAuth === 'ì§ì›');
      const canSeeSensitive = (myAuth === 'ê´€ë¦¬ì' || myAuth === 'ì§€ì ì¥');

      // ë¡œê·¸ì¸ê¸°ê¸° í† ê¸€ (ê¸°ì¡´)
      document.getElementById('th-max-sessions')?.classList.toggle('hidden', isStaff);
      document.querySelectorAll('.td-max-sessions').forEach(td => td.classList.toggle('hidden', isStaff));

      // âœ… í‡´ì‚¬ì¼ í–‰(íŒ¨ë„) í† ê¸€ (ê¸°ì¡´)
      document.getElementById('row-leave-date')?.classList.toggle('hidden', !canSeeSensitive);
      const leaveInput = document.getElementById('signup-leave');
      if (leaveInput) leaveInput.disabled = !canSeeSensitive;

      // âœ… í…Œì´ë¸”ì˜ í‡´ì‚¬ì¼ í—¤ë”/ì…€ í† ê¸€ (ìƒˆë¡œ ì¶”ê°€)
      document.getElementById('th-leave-date')?.classList.toggle('hidden', !canSeeSensitive);
      document.querySelectorAll('.td-leave-date').forEach(td => td.classList.toggle('hidden', !canSeeSensitive));

      // ì§ì›ì´ë©´ íšŒì›ê°€ì… ë²„íŠ¼ ìˆ¨ê¹€ (ê¸°ì¡´)
      document.getElementById('toggle-edit-btn')?.classList.toggle('hidden', isStaff);
    }

    // ë‚´ ê¶Œí•œ ë¶ˆëŸ¬ì™€ì„œ í”Œë˜ê·¸ ì„¤ì • + UI ì ìš©
    async function initAuthorityUi() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data: me } = await supabase
        .from('staff_profiles')
        .select('authority, affiliation')  // â¬…ï¸ affiliation ì¶”ê°€
        .eq('user_id', user.id)
        .maybeSingle();

      window.MY_AUTHORITY   = me?.authority ?? null;
      window.MY_AFFILIATION = me?.affiliation ?? null; // â¬…ï¸ ì¶”ê°€
      window.IS_STAFF = (window.MY_AUTHORITY === 'ì§ì›');
      applyUiByAuthority();
    }

    // 
    function canOpenEditFor(staff) {
      const myAuth = window.MY_AUTHORITY;
      const myAff  = window.MY_AFFILIATION;

      if (myAuth === 'ê´€ë¦¬ì') return true;                  // ëª¨ë‘ í—ˆìš©
      if (myAuth === 'ì§€ì ì¥') return staff.affiliation === myAff; // ê°™ì€ ë¶€ì„œë§Œ
      if (myAuth === 'ì§ì›')   return false;                 // ëª¨ë‘ ê¸ˆì§€
      return false; // ê·¸ ì™¸ ë¶ˆëª…í™•í•œ ê¶Œí•œì€ ë³´ìˆ˜ì ìœ¼ë¡œ ì°¨ë‹¨
    }

    // ê¶Œí•œ ì•ˆë‚´ë©”ì„¸ì§€
    function denyReason(staff) {
      const myAuth = window.MY_AUTHORITY;
      const myAff  = window.MY_AFFILIATION;
      if (myAuth === 'ì§ì›') return 'ì§ì› ê¶Œí•œì€ ê³„ì •ì •ë³´ ì°½ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      if (myAuth === 'ì§€ì ì¥' && staff.affiliation !== myAff)
        return `ì§€ì ì¥ì€ ë³¸ì¸ ë¶€ì„œ(${myAff}) ì§ì›ë§Œ ì—´ëŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
      return 'ì—´ëŒ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
    }



    async function updateStaff() {
      if (window.FORM_MODE !== 'edit' || !CURRENT_EDIT_USER_ID) {
        showToast('ìˆ˜ì •í•  ëŒ€ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const myAuth = window.MY_AUTHORITY;
      const canSeeSensitive = (myAuth === 'ê´€ë¦¬ì' || myAuth === 'ì§€ì ì¥');
      const isStaff = (myAuth === 'ì§ì›');

      // âœ… ì§ì›ì€ ì €ì¥ ë¶ˆê°€ (ì„œë²„ ìš”ì²­ ìì²´ ì°¨ë‹¨)
      if (isStaff) {
        showToast('ì§ì› ê¶Œí•œì€ ê³„ì •ì •ë³´ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const emptyToNull = v => (v === '' || v === undefined ? null : v);

      // max_sessions ì •ìˆ˜ ì²˜ë¦¬
      const maxRaw = (document.getElementById('signup-max-sessions').value || '').trim();
      const maxParsed = maxRaw === '' ? null : Number.parseInt(maxRaw, 10);
      if (maxParsed !== null && (!Number.isInteger(maxParsed) || maxParsed < 1 || maxParsed > 10)) {
        showToast('ë¡œê·¸ì¸ê¸°ê¸° ìˆ˜ëŠ” 1~10 ì‚¬ì´ì˜ ì •ìˆ˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // âœ… payload ë¨¼ì € ë§Œë“¤ê¸°
      const payload = {
        name:        document.getElementById('signup-name').value.trim(),
        position:    emptyToNull(document.getElementById('signup-position').value),
        affiliation: emptyToNull(document.getElementById('signup-affiliation').value),
        authority:   emptyToNull(document.getElementById('signup-authority').value),
        gender:      emptyToNull(document.getElementById('signup-gender').value),
        birth_date:  emptyToNull(document.getElementById('signup-birth').value),
        join_date:   emptyToNull(document.getElementById('signup-join').value),
        phone_num:   emptyToNull(document.getElementById('signup-phone').value),
        extension:   emptyToNull(document.getElementById('signup-extension').value),
        max_sessions: maxParsed,
        // í‡´ì‚¬ì¼ì€ ì…ë ¥ê°’ë§Œ ì¼ë‹¨ ì‹£ê³ , ì•„ë˜ì—ì„œ ê¶Œí•œë³„ë¡œ ìµœì¢… ë°˜ì˜
        leave_date:  emptyToNull(document.getElementById('signup-leave')?.value || null),
        ad_channel:      emptyToNull(document.getElementById('signup-ad-channel').value),
        ad_account_id:   emptyToNull(document.getElementById('signup-ad-account-id').value),
        ad_account_pw:   emptyToNull(document.getElementById('signup-ad-account-pw').value),
      };

      // ì§ì›ì€ ë¡œê·¸ì¸ê¸°ê¸°/í‡´ì‚¬ì¼ ë³€ê²½ ë¶ˆê°€
      if (isStaff) {
        delete payload.max_sessions;
        delete payload.leave_date;
      } else {
        // ê´€ë¦¬ì/ì§€ì ì¥ ì™¸ì—ëŠ” í‡´ì‚¬ì¼ ë¶ˆê°€
        if (!canSeeSensitive) delete payload.leave_date;
      }

      const { error } = await supabase
        .from('staff_profiles')
        .update(payload)
        .eq('user_id', window.CURRENT_EDIT_USER_ID);

      if (error) {
        console.error(error);
        showToast(`ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
        return;
      }

      showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      closeSignupPanel();
      fetchStaffProfiles();
      FORM_MODE = 'create';
      CURRENT_EDIT_USER_ID = null;
    }

    // ì—ëŸ¬ í‘œì‹œ/í•´ì œ
    function markInvalid(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.add('input-error');
      // ì²« ë²ˆì§¸ ì—ëŸ¬ì— í¬ì»¤ìŠ¤
      if (!markInvalid._focusedOnce) {
        try { el.focus(); } catch(_) {}
        markInvalid._focusedOnce = true;
      }
    }
    function clearInvalid(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.remove('input-error');
    }

    // ê°’ ë³€í™” ì‹œ ì—ëŸ¬ í…Œë‘ë¦¬ ìë™ ì œê±°
    function bindClearOnInput(ids) {
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el || el.dataset.clearBound === '1') return; // ì´ë¯¸ ë°”ì¸ë”©ë¨ ë°©ì§€
        const handler = () => clearInvalid(id);
        el.addEventListener('input', handler);
        el.addEventListener('change', handler);
        el.dataset.clearBound = '1';
      });
    }

    // íšŒì›ê°€ì… íŒ¨ë„ ì—´ ë•Œ í˜¸ì¶œ: ê¸°ì¡´ resetSignupForm ë’¤ì— í˜¸ì¶œí•´ì£¼ë©´ ê¹”ë”
    function prepareSignupValidation() {
      markInvalid._focusedOnce = false;
      // ê¸°ì¡´ ì—ëŸ¬ í…Œë‘ë¦¬ ëª¨ë‘ ì œê±°
      [
        'signup-name','signup-email','signup-password',
        'signup-affiliation','signup-authority','signup-max-sessions'
      ].forEach(clearInvalid);

      // ê°’ ë°”ë€Œë©´ ì—ëŸ¬ í…Œë‘ë¦¬ ì œê±°
      bindClearOnInput([
        'signup-name','signup-email','signup-password',
        'signup-affiliation','signup-authority','signup-max-sessions'
      ]);
    }


    window.closeSignupPanel = function () {
      document.getElementById('signupPanel').classList.add('translate-x-full');
    };

    window.showToast = function (message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;

      // ìŠ¤íƒ€ì¼ ì§ì ‘ ì§€ì •
      toast.style.backgroundColor = '#F2C130';
      toast.style.color = 'black';
      toast.style.fontWeight = 'bold';
      toast.className = 'fixed top-5 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded shadow-lg z-[9999]';

      toast.classList.remove('hidden');

      setTimeout(() => toast.classList.add('hidden'), 3000);
    };

    window.submitSignup = async function () {
      const name        = document.getElementById('signup-name').value.trim();
      const email       = document.getElementById('signup-email').value.trim();
      const password    = document.getElementById('signup-password').value;
      const position    = document.getElementById('signup-position').value;
      const affiliation = document.getElementById('signup-affiliation').value;
      const authority   = document.getElementById('signup-authority').value;
      const gender      = document.getElementById('signup-gender').value;
      const birth_date  = document.getElementById('signup-birth').value;
      const join_date   = document.getElementById('signup-join').value;
      const phone_num   = document.getElementById('signup-phone').value;
      const extension   = document.getElementById('signup-extension').value;

      // ë¡œê·¸ì¸ê¸°ê¸° ìˆ˜ ì›ì‹œê°’
      const maxRaw = (document.getElementById('signup-max-sessions').value || '').trim();

      // === [í•„ìˆ˜ê°’ ê²€ì¦] ===
      markInvalid._focusedOnce = false; // í¬ì»¤ìŠ¤ ì´ˆê¸°í™”
      let errors = [];

      if (!name)        { markInvalid('signup-name');        errors.push('ì´ë¦„'); }
      if (!email)       { markInvalid('signup-email');       errors.push('ì´ë©”ì¼'); }
      if (!password)    { markInvalid('signup-password');    errors.push('ë¹„ë°€ë²ˆí˜¸'); }
      if (!affiliation) { markInvalid('signup-affiliation'); errors.push('ë¶€ì„œ'); }
      if (!authority)   { markInvalid('signup-authority');   errors.push('ê¶Œí•œ'); }
      if (!maxRaw)      { markInvalid('signup-max-sessions');errors.push('ë¡œê·¸ì¸ê¸°ê¸°'); }

      if (errors.length > 0) {
        showToast(`í•„ìˆ˜ í•­ëª©ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤: ${errors.join(', ')}`);
        return;
      }

      // === [ë¡œê·¸ì¸ê¸°ê¸° ìˆ˜ í˜•ì‹ ê²€ì¦] 1~10 ì •ìˆ˜ ===
      const maxParsed = Number.parseInt(maxRaw, 10);
      if (!Number.isInteger(maxParsed) || maxParsed < 1 || maxParsed > 10) {
        markInvalid('signup-max-sessions');
        showToast('ë¡œê·¸ì¸ê¸°ê¸° ìˆ˜ëŠ” 1~10 ì‚¬ì´ì˜ ì •ìˆ˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // 0) í˜„ì¬ ë¡œê·¸ì¸/ë‚´ í”„ë¡œí•„ (ê¶Œí•œ í™•ì¸ìš©)
      const { data: { user: sessionUser } } = await supabase.auth.getUser();
      if (!sessionUser) { showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }

      const { data: me, error: meErr } = await supabase
        .from('staff_profiles')
        .select('authority, affiliation')
        .eq('user_id', sessionUser.id)
        .single();
      if (meErr || !me) { showToast('ë‚´ ê¶Œí•œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); return; }

      // 1) í”„ë¡ íŠ¸ê¶Œí•œ ê²€ì¦ (ì„œë²„ì—ì„œë„ ë‹¤ì‹œ ê²€ì¦í•˜ì§€ë§Œ UX ìœ„í•´ ìœ ì§€)
      const isAdmin   = me.authority === 'ê´€ë¦¬ì';
      const isManager = me.authority === 'ì§€ì ì¥';

      if (!isAdmin) {
        if (isManager) {
          if (authority !== 'ì§ì›') {
            showToast('ì§€ì ì¥ì€ "ì§ì›" ê¶Œí•œë§Œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            return;
          }
          if (affiliation !== me.affiliation) {
            showToast(`ì§€ì ì¥ì€ ë³¸ì¸ ë¶€ì„œ(${me.affiliation})ë§Œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
            return;
          }
        } else {
          showToast('ì§ì› ê¶Œí•œì€ ë‹¤ë¥¸ ê³„ì •ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
      }

      // 2) (ì„ íƒ) ì´ë©”ì¼ ì¤‘ë³µ ì‚¬ì „ ì²´í¬ - UXìš©
      const { data: dup, error: dupErr } = await supabase
        .from('staff_profiles')
        .select('user_id')
        .eq('email', email)
        .maybeSingle();
      if (dupErr) {
        console.error(dupErr);
        showToast('ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        return;
      }
      if (dup) {
        showToast('ì´ë¯¸ ë“±ë¡ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }

      // helper: ë¹ˆ ë¬¸ìì—´ -> null
      const emptyToNull = v => (v === '' || v === undefined ? null : v);

      // 3) ğŸ”´ ê¸°ì¡´ì˜ auth.signUp + profiles.insert ë¥¼ ì—†ì• ê³ 
      //    Edge Function(ì„œë¹„ìŠ¤ ë¡¤) í˜¸ì¶œë¡œ í•œë²ˆì— ì²˜ë¦¬
      //    í•¨ìˆ˜ ì´ë¦„: admin-create-staff  (ì›í•˜ëŠ” ì´ë¦„ì„ ì“°ë˜ ì„œë²„ì™€ ì¼ì¹˜)
      const payload = {
        email,
        password,
        profile: {
          name: name.trim(),
          email,
          position:    emptyToNull(position),
          affiliation: emptyToNull(affiliation),
          authority:   emptyToNull(authority),
          gender:      emptyToNull(gender),
          birth_date:  emptyToNull(birth_date),
          join_date:   emptyToNull(join_date),
          phone_num:   emptyToNull(phone_num),
          extension:   emptyToNull(extension),
          max_sessions: maxParsed,
          ad_channel:    emptyToNull(document.getElementById('signup-ad-channel').value),
          ad_account_id: emptyToNull(document.getElementById('signup-ad-account-id').value),
          ad_account_pw: emptyToNull(document.getElementById('signup-ad-account-pw').value),
        }
      };

      // ë²„íŠ¼ ì¤‘ë³µ í´ë¦­ ë°©ì§€ UX
      const btn = document.querySelector('#signupPanel button[data-role="submit"]');
      const prevLabel = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'ìƒì„± ì¤‘...';

      try {
        const { data, error } = await supabase.functions.invoke('admin-create-staff', {
          body: payload,
        });

        if (error) {
          // supabase-js v2: error.context?.response ì— ì‹¤ì œ Response ë“¤ì–´ìˆìŒ
          let extra = '';
          const resp = error?.context?.response;
          if (resp) {
            try {
              const txt = await resp.text();
              extra = ` [${resp.status}] ${txt?.slice(0, 300)}`;
            } catch (_) {}
          }
          console.error('invoke error:', error, resp);
          showToast(`Edge Function í˜¸ì¶œ ì‹¤íŒ¨: ${error.message}${extra}`);
          return;
        }

        if (data?.error) { showToast(data.error); return; }

        showToast('íšŒì›ê°€ì… ì™„ë£Œ!');
        closeSignupPanel();
        fetchStaffProfiles();
        resetSignupForm();
      } catch (e) {
        console.error(e);
        showToast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ í•¨ìˆ˜ í˜¸ì¶œ ì‹¤íŒ¨');
      } finally {
        btn.disabled = false;
        btn.textContent = prevLabel;
      }
    };

    window.resetSignupForm = function () {
      ['signup-name','signup-email','signup-password',
      'signup-position','signup-affiliation','signup-authority',
      'signup-gender','signup-birth','signup-join',
      'signup-phone','signup-extension',
      'signup-max-sessions',
      'signup-ad-channel','signup-ad-account-id','signup-ad-account-pw'
      ].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
    };

    // ìœ„ì—ì„œ ì„¤ì •í•œ supabase ê°ì²´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    async function fetchStaffProfiles() {
      const isStaff = (window.MY_AUTHORITY === 'ì§ì›');
      const canSeeSensitive = (window.MY_AUTHORITY === 'ê´€ë¦¬ì' || window.MY_AUTHORITY === 'ì§€ì ì¥');

      const selectCols = `
        user_id,name,email,affiliation,position,authority,gender,
        birth_date,join_date,leave_date,phone_num,extension,max_sessions
        ${canSeeSensitive ? ',ad_channel,ad_account_id,ad_account_pw' : ''}
      `.replace(/\s+/g, ''); // ê³µë°± ì •ë¦¬

      const { data, error } = await supabase
        .from('staff_profiles')
        .select(selectCols)
        .order('name', { ascending: true });

      if (error) {
        console.error('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
        showToast('ì§ì› ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      // ì§ì›ì´ë©´ í‡´ì‚¬ì ì œì™¸(leave_date null/ê³µë°±ë§Œ í‘œì‹œ)
      const base = isStaff
        ? (data || []).filter(r => (r.leave_date ?? '').toString().trim() === '')
        : (data || []);

      window.STAFF_BASE_ROWS = sortStaff(base); // ê¸°ë³¸ì •ë ¬

      // ì²« ë Œë”ëŠ” í˜„ì¬ ì…ë ¥ê°’ ë°˜ì˜í•´ì„œ
      applyAffFilter();
    }

    window.addEventListener('DOMContentLoaded', async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }

      await initAuthorityUi();
      await fetchStaffProfiles();
      applyUiByAuthority();
      resetSignupForm();

      // ë¶€ì„œ í•„í„° ì‹¤ì‹œê°„ ë°˜ì˜
      document.getElementById('filter-aff')?.addEventListener('input', applyAffFilter);

      document.getElementById('toggle-ad-pw')?.addEventListener('click', () => {
        const el = document.getElementById('signup-ad-account-pw');
        el.type = (el.type === 'password') ? 'text' : 'password';
      });

    });

    // ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë™ì‘
    window.sendResetPasswordEmail = async function () {
      const email = (document.getElementById('signup-email')?.value || '').trim();
      if (!email) { showToast('ì´ë©”ì¼ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }

      // ğŸ”§ Supabase Auth â†’ ë¹„ë²ˆ ì¬ì„¤ì • ë©”ì¼ ë°œì†¡
      // Auth ì„¤ì •ì˜ Site URL / Redirect URL í—ˆìš© ëª©ë¡ì— ì•„ë˜ redirectToë¥¼ ë“±ë¡í•´ ë‘ì„¸ìš”.
      const redirectTo = location.origin + '/index.html'; // ì›í•˜ëŠ” í˜ì´ì§€ë¡œ êµì²´ ê°€ëŠ¥
      const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo });

      if (error) {
        showToast('ì¬ì„¤ì • ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨: ' + error.message);
      } else {
        showToast('ì¬ì„¤ì • ë©”ì¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.');
      }
    };

  </script>

</body>
</html>
