<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì„ëŒ€ì¶”ì²œ</title>
  <link rel="icon" type="image/png" href="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/pabicon-baikuk-simbol.png" />
  <link rel="preconnect" href="https://sfinbtiqlfnaaarziixu.supabase.co" crossorigin>
  <link rel="dns-prefetch" href="//sfinbtiqlfnaaarziixu.supabase.co">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    let currentCustomerId = null; // ì „ì—­ ë³€ìˆ˜ë¡œ ì¶”ê°€
    let whiteBoxExtraGap = 0; // white-box ì˜¤ë¥¸ìª½ ì—¬ë°± ì €ì¥
  </script>
  <style>
    /* === print ì „ìš© ì„¤ì • === */
    @media print {
      @page { size: A4 portrait; margin: 12mm; }
      html, body { margin:0 !important; padding:0 !important; }

      /* body ì§ê³„/í›„ì† ì „ë¶€ ìˆ¨ê¹€ */
      body > * { display: none !important; }

      /* ì¸ì‡„ í¬í„¸ë§Œ í‘œì‹œ */
      #print-portal { 
        display: block !important; 
        position: static !important;
        width: 100% !important; 
        margin: 0 !important; 
        padding: 0 !important;
      }
      #print-portal table { 
        width: auto !important;
        table-layout: fixed; 
        border-collapse: collapse; 
      }

      /* í…Œë‘ë¦¬ ìƒ‰ìƒ ì§„í•˜ê²Œ */
      #print-portal th, #print-portal td { 
        border: 1px solid #999; 
        padding: 4px; 
        font-size: 12px; 
        text-align: center; 
      }

      /* í—¤ë” ìŒì˜ ì§„í•˜ê²Œ */
      #print-portal thead { 
        background: #d1d5db !important;  /* ì§„í•œ íšŒìƒ‰ */
        color: #000 !important;
        position: static !important; 
        font-weight: bold;
      }

      /* ì‚¬ìš©ì ì§€ì • í–‰ ìƒ‰ìƒì„ ìœ ì§€í•˜ë„ë¡ ì„¤ì • */
      #print-portal tbody tr {
        background-color: inherit !important;   /* inline ìƒ‰ìƒ ê·¸ëŒ€ë¡œ ì¶œë ¥ */
      }

      /* â€» í˜¹ì‹œ inline ì´ ì—†ì„ ë•Œë§Œ ê¸°ë³¸ ì¤„ë¬´ëŠ¬ */
      #print-portal tbody tr:not([data-usercolor]):nth-child(odd) {
        background-color: #ffffff !important;
      }
      #print-portal tbody tr:not([data-usercolor]):nth-child(even) {
        background-color: #f2f2f2 !important;
      }

      /* ìƒ‰/ë°°ê²½ ì¶œë ¥ */
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
  <style>
    .shadow-right {
      box-shadow: 8px 0 12px -4px rgba(0, 0, 0, 0.08);
    }
    /* === ì—´ ë¦¬ì‚¬ì´ì¦ˆ: ë§¤ë§¤ì¶”ì²œ í˜ì´ì§€ì™€ ë™ì¼ ìŠ¤íƒ€ì¼ === */
    th.resizable {
      position: relative;
      min-width: 40px;
      white-space: nowrap;
    }
    .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      width: 0.4rem;
      height: 100%;
      cursor: col-resize;
      z-index: 10;
      background-color: transparent;
    }
    .customer-item {
      position: relative;
      padding: 0.5rem 0.5rem; /* ìœ„ì•„ë˜/ì¢Œìš° ì—¬ë°± ì¦ê°€ */
      margin-bottom: 0.25rem;  /* í•­ëª© ì‚¬ì´ ê°„ê²© */
      border-radius: 0.25rem;  /* ëª¨ì„œë¦¬ ì‚´ì§ ë‘¥ê¸€ê²Œ (ì„ íƒ) */
    }
    .customer-item:hover .customer-delete-btn {
      display: block;
    }
    .customer-item:active { background-color: #fde68a; } /* ëˆŒë €ì„ ë•Œ ì‚´ì§ ë” ì§„í•˜ê²Œ */
    .grade-header {
      background-color: #e5e7eb; /* bg-yellow-100 ê°™ì€ íš¨ê³¼ */
      color: #000000;           /* ì§„í•œ ì£¼í™©ìƒ‰ ê¸€ì”¨ */
      font-weight: bold;
      padding: 0.5rem;
      border-radius: 0.25rem;
      margin-top: 0.5rem;
    }
    .name-item {
      font-size: 0.9rem;
      color: #374151;           /* text-gray-700 */
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      cursor: pointer;
      margin-bottom: 0.4rem;
    }
    .name-item:hover {
      background-color: #fef9c3; /* hover:bg-yellow-100 */
    }

  </style>
  <style>
    /* í…Œì´ë¸” ì „ì²´ + ì…€ í…Œë‘ë¦¬ */
    table {
      border-collapse: collapse; /* í…Œë‘ë¦¬ ê²¹ì¹¨ ì œê±° */
      width: 50rem;
      table-layout: fixed;
    }

    table, th, td {
      border: 1px solid #ccc; /* ì—°í•œ íšŒìƒ‰ í…Œë‘ë¦¬ */
    }

    th, td {
      padding: 0.25rem; /* p-1 ì •ë„ */
      text-align: center;
      font-size: 0.875rem; /* text-sm */
    }
    
    /* ë‹¨ì–´ ê¸°ì¤€ ì¤„ë°”ê¿ˆ ì„¤ì • */
    td, th, textarea, span[data-field] {
      white-space: normal !important;      /* nowrap ì œê±° */
      word-break: keep-all !important;     /* ë‹¨ì–´ ë‹¨ìœ„ë¡œ ì¤„ë°”ê¿ˆ */
      overflow-wrap: break-word !important;/* ë„ˆë¬´ ê¸´ ë‹¨ì–´ëŠ” ìë™ ì¤„ë°”ê¿ˆ */
    }
    td [data-field^="description_"], td [data-field^="listing_title_"] {
        white-space: pre-wrap !important;
        word-break: break-word;
        text-align: center !important;
      }
    /* í—¤ë” ìŠ¤íƒ€ì¼ */
    thead {
      background-color: #f3f4f6; /* bg-gray-100 */
      position: sticky;
      top: 0;
      z-index: 10;
    }

    /* ì§ìˆ˜/í™€ìˆ˜ ì¤„ ë°°ê²½ */
    tbody tr:nth-child(odd) {
      background-color: white;
    }
    tbody tr:nth-child(even) {
      background-color: #f9fafb; /* bg-gray-50 */
    }
  </style>
  <style>
    #staff-dropdown {
      max-height: 520px;   /* ê¸°ì¡´ë³´ë‹¤ í›¨ì”¬ ê¸¸ê²Œ */
      overflow-y: auto;    /* ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
    }
    /* ë²„íŠ¼ ìì²´ëŠ” ìˆ¨ê¸°ë˜ ìƒ‰ìƒí‘œëŠ” ìœ ì§€ */
    .color-picker-btn {
      visibility: hidden;   /* display:none ëŒ€ì‹  visibility ì‚¬ìš©! */
    }
    .color-option {
      border: 1px solid #ccc;
    }

  </style>
</head>
<body class="w-screen overflow-y-hidden min-h-screen overflow-x-auto">
  <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-[9999] hidden">
    ë©”ì‹œì§€ ì˜ì—­
  </div>
  <div class="absolute top-0 left-0 z-[9998] bg-white w-[13rem] h-[60px] rounded-xl">
    <img src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/logotype-baikuk.png"
        alt="ê¸€ì”¨ë¡œê³ "
        class="absolute h-11 w-auto cursor-pointer top-2 left-2 z-[9999]"
        onclick="location.reload()" />
  </div>
  <div id="page-title" class="absolute top-[1.5rem] left-[15rem] text-2xl font-bold">
    ì„ëŒ€ì¶”ì²œ <span id="selected-customer" class="text-blue-600"></span>
  </div>
  <div class="flex min-h-screen">
    <div class="w-[6%] pt-[5rem] shadow-right text-center bg-white">
      <a href="https://baikuk.com/map"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë°±ì–µì§€ë„</div></a>
      <a href="/admin/mmap/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">ë°±ì–µì§€ë„</div></a>
      <a href="/admin/listings/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë§¤ë¬¼ì¥ë¶€</div></a>
      <a href="/admin/recommend_imDae/"><div class="bg-gray-100 border-l-4 border-gray-500 text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ì„ëŒ€ì¶”ì²œ</div></a>
      <a href="/admin/recommend_maeMae/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë§¤ë§¤ì¶”ì²œ</div></a>
      <a href="/admin/customer_manage/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">ëª¨ë“ ê³ ê°</div></a>
      <a href="/admin/ad_censorship/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ê´‘ê³ ê´€ë¦¬</div></a>
      <a href="/admin/staff_manage/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ì§ì›ì •ë³´</div></a>
      <a href="/admin/performance/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë§¤ì¶œ</div></a>
      <a href="/admin/cost_management/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë¹„ìš©</div></a>
      <a id="settlement-tab" href="/admin/settlement/" style="display:none">
        <div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">ì •ì‚°</div>
      </a>
    </div>
    <div id="customer-col" class="bg-gray-100 w-[14%] pt-[2rem] shadow-right relative z-[10] text-left">
      <!-- â­ ì‹ ê·œ ê³ ê° ë²„íŠ¼ (ì˜¤ë¥¸ìª½ ì •ë ¬) -->
      <div class="flex justify-end px-2 mb-2">
        <button id="new-customer-btn"
          class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm font-semibold">
          ìƒˆ ê³ ê°
        </button>
      </div>
      <div id="customer-list" class="overflow-y-auto max-h-[calc(100vh-5rem)]">
        <!-- ì—¬ê¸°ì— ê³ ê° ì´ë¦„ë“¤ì´ í‘œì‹œë©ë‹ˆë‹¤ -->
      </div>
    </div>
    <div class="w-[84%] flex flex-col bg-gray-100 overflow-y-auto min-h-0 h-screen">
      <div class="mt-[2rem] flex px-3 bg-gray-100">
        <div class="text-left text-base rounded outline-none resize-none">
          <!-- [ADD] ë§¤ë¬¼ íŒ¨ë„ ìƒë‹¨:  ì—…ë°ì´íŠ¸ í‘œì‹œì¤„ -->
          <div class="flex items-center gap-2 text-sm mb-2">
            <span id="employee-listings-meta" class="font-medium">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</span>
          </div>
          <textarea
            placeholder="ê³ ê°ì´ë¦„"
            class="border border-gray-300 px-2 rounded ml-1 w-full text-left text-base resize-none"
            id="top-row-input"
            rows="2"
          ></textarea>
            <input
                id="customer-division"
                type="text"
                placeholder="ì†Œë¶„ë¥˜"
                class="border border-gray-300 px-2 rounded ml-1 w-full text-left text-base h-[2.2rem] mt-[0.4rem]"
            /> 
          <div class="flex mt-[0.5rem]">
            <button id="delete-customer" class="ml-1 h-[2.3rem] bg-rose-500 hover:bg-rose-600 text-white text-sm px-4 py-1 rounded font-bold">
              ì†ë‹˜ì‚­ì œ
            </button>
            <button id="save-new-customer" class="ml-auto h-[2rem] bg-blue-500 hover:bg-blue-600 text-white text-sm px-4 py-1 rounded font-bold">
              ì €ì¥
            </button>
          </div>
          <div class="flex mt-[0.5rem]">
            <div class="flex">
              <div class="ml-1 mt-1">êµ¬ë¶„:</div>
              <select id="customer-grade" class="ml-1 px-1 h-[2rem] text-left box-border border border-gray-300 rounded text-base">
                <option >A</option>
                <option >B</option>
                <option >C</option>
                <option >F</option>
                <option>ê³„ì•½</option>
              </select>
            </div>
            <input id="customer-phone" placeholder="ì „í™”ë²ˆí˜¸" class="w-[10rem] ml-auto px-1 h-[2rem] text-left box-border border border-gray-300 rounded text-base">
          </div>
          <textarea id="memo-textarea" placeholder="ë©”ëª¨" class="mt-[0.5rem] ml-1 px-1 pt-1 w-[17rem] h-[40rem] box-border text-left text-base border border-gray-300 rounded bg-white outline-none resize-none"></textarea>
          <!-- ğŸ”½ ì—¬ê¸°ì— ìƒˆ í•„í„° ì˜ì—­ ì¶”ê°€ -->
          <div class="ml-1 mt-4 p-3 bg-white border border-gray-300 rounded text-sm w-[17rem]">
            <!-- ì¸µ -->
            <div class="flex flex-row items-center mb-3">
            <div class="font-semibold w-[9rem]">ì¸µ</div>
            <div class="flex gap-2 w-full">
                <input type="number" placeholder="ì´ìƒ" class="w-full px-2 py-1 border rounded" id="floor-min">
                <input type="number" placeholder="ì´í•˜" class="w-full px-2 py-1 border rounded" id="floor-max">
            </div>
            </div>

            <!-- ì „ìš©ë©´ì  -->
            <div class="flex flex-row items-center mb-3">
            <div class="font-semibold w-[9rem]">ë©´ì (í‰)</div>
            <div class="flex gap-2 w-full">
                <input type="number" placeholder="ì´ìƒ" class="w-full px-2 py-1 border rounded" id="area-min">
                <input type="number" placeholder="ì´í•˜" class="w-full px-2 py-1 border rounded" id="area-max">
            </div>
            </div>

            <!-- ë³´ì¦ê¸ˆ -->
            <div class="flex flex-row items-center mb-3">
            <div class="font-semibold w-[9rem]">ë³´ì¦ê¸ˆ</div>
            <div class="flex gap-2 w-full">
                <input type="number" placeholder="ì´ìƒ" class="w-full px-2 py-1 border rounded" id="deposit-min">
                <input type="number" placeholder="ì´í•˜" class="w-full px-2 py-1 border rounded" id="deposit-max">
            </div>
            </div>

            <!-- ì›”ì„¸ -->
            <div class="flex flex-row items-center mb-3">
            <div class="font-semibold w-[9rem]">ì›”ì„¸</div>
            <div class="flex gap-2 w-full">
                <input type="number" placeholder="ì´ìƒ" class="w-full px-2 py-1 border rounded" id="rent-min">
                <input type="number" placeholder="ì´í•˜" class="w-full px-2 py-1 border rounded" id="rent-max">
            </div>
            </div>

            <!-- í‰ë‹¹ ì›”ì„¸ -->
            <div class="flex flex-row items-center mb-3">
            <div class="font-semibold w-[9rem]">í‰ì›”ì„¸</div>
            <div class="flex gap-2 w-full">
                <input type="number" placeholder="ì´ìƒ" class="w-full px-2 py-1 border rounded" id="rent-per-py-min">
                <input type="number" placeholder="ì´í•˜" class="w-full px-2 py-1 border rounded" id="rent-per-py-max">
            </div>
            </div>

            <!-- ê¶Œë¦¬ê¸ˆ -->
            <div class="flex flex-row items-center mb-3">
            <div class="font-semibold w-[9rem]">ê¶Œë¦¬ê¸ˆ</div>
            <div class="flex gap-2 w-full">
                <input type="number" placeholder="ì´ìƒ" class="w-full px-2 py-1 border rounded" id="premium-min">
                <input type="number" placeholder="ì´í•˜" class="w-full px-2 py-1 border rounded" id="premium-max">
            </div>
            </div>

            <!-- ë§¤ë§¤ê°€ -->
            <div class="flex flex-row items-center mb-3">
            <div class="font-semibold w-[9rem]">ë§¤ë§¤ê°€</div>
            <div class="flex gap-2 w-full">
                <input type="number" placeholder="ì´ìƒ" class="w-full px-2 py-1 border rounded" id="sale-min">
                <input type="number" placeholder="ì´í•˜" class="w-full px-2 py-1 border rounded" id="sale-max">
            </div>
            </div>

            <!-- ì´ë³´ì¦ê¸ˆ -->
            <div class="flex flex-row items-center mb-3">
            <div class="font-semibold w-[9rem]">ì´ë³´ì¦ê¸ˆ</div>
            <div class="flex gap-2 w-full">
                <input type="number" placeholder="ì´ìƒ" class="w-full px-2 py-1 border rounded" id="total-deposit-min">
                <input type="number" placeholder="ì´í•˜" class="w-full px-2 py-1 border rounded" id="total-deposit-max">
            </div>
            </div>

            <!-- ì´ì›”ì„¸ -->
            <div class="flex flex-row items-center mb-3">
            <div class="font-semibold w-[9rem]">ì´ì›”ì„¸</div>
            <div class="flex gap-2 w-full">
                <input type="number" placeholder="ì´ìƒ" class="w-full px-2 py-1 border rounded" id="total-rent-min">
                <input type="number" placeholder="ì´í•˜" class="w-full px-2 py-1 border rounded" id="total-rent-max">
            </div>
            </div>

            <!-- ìˆ˜ìµë¥  -->
            <div class="flex flex-row items-center mb-3">
            <div class="font-semibold w-[9rem]">ìˆ˜ìµë¥ (%)</div>
            <div class="flex gap-2 w-full">
                <input type="number" placeholder="ì´ìƒ" class="w-full px-2 py-1 border rounded" id="roi-min">
                <input type="number" placeholder="ì´í•˜" class="w-full px-2 py-1 border rounded" id="roi-max">
            </div>
            </div>

          </div>
          <!-- ğŸ”¼ í•„í„° ì˜ì—­ ë -->

        </div>
        <div class="ml-3 mt-[1rem] flex flex-col">
          <div class="mb-2 px-2 text-right flex gap-2">
            <button id="print-btn" class="h-[2rem] bg-gray-500 hover:bg-gray-600 text-white text-sm px-4 py-1 rounded">
              ğŸ–¨ï¸
            </button>
            <button id="print-btn2" class="h-[2rem] bg-neutral-400 hover:bg-neutral-500 text-white text-sm px-4 py-1 rounded">
              ğŸ–¨ï¸
            </button>
          </div>
          <div class="pt-2 px-2 py-2bg-white border border-gray-300 rounded-md"> <!-- ë§¤ë¬¼ë²ˆí˜¸ í…Œì´ë¸” ì „ì²´ -->
            <div class="mb-2 justify-center flex gap-2">
              <button id="clear-left-btn" class="h-[2rem] w-[3.5rem] bg-rose-500 hover:bg-rose-600 text-white font-bold text-sm px-1 py-1 rounded">
                ì§€ìš°ê¸°
              </button>
              <button id="copy-link-btn" class="h-[2rem] w-[3rem] bg-[#F2C130] hover:bg-[#E0B120] text-black font-bold px-1 py-1 rounded mr-2">
                ë§í¬
              </button>
            </div>
            <div id="table-container" class="border rounded-md">
              <table class="w-[7rem] text-sm text-left">
                <thead class="bg-gray-100 sticky top-0 z-10">
                  <tr id="header-row">
                    <th class="p-1 font-bold text-base text-center">ë§¤ë¬¼ë²ˆí˜¸</th>
                  </tr>
                </thead>
                <tbody id="left-tbody" class="bg-white">
                </tbody>
              </table>
            </div>
          </div>
        </div>        
        <div id="white-box" class="ml-1 px-4 py-4 bg-white rounded-md self-start relative flex-shrink-0">
          <div id="table-container" class="custom-scroll bg-white rounded-md">
            <div id="print-block">              
              <div class="flex items-end mb-2 gap-3">
                <img
                  src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/biakuk-images//baikuk-logo-yellow_simbol_name.png"
                  alt="ë°±ì–µë¡œê³ "
                  class="w-[25rem]"
                />
                <div class="justify-between items-end mb-2">
                  <!-- ë‚ ì§œ -->
                  <div id="today-date" class="text-gray-600 text-sm font-semibold"></div>
                  <!-- ë‹´ë‹¹ì -->
                  <div id="staff-info-container" class="text-gray-800 text-lg font-semibold relative">
                    <!-- ì§ì› ì •ë³´ í‘œì‹œë¶€ -->
                    <div id="staff-info"
                        class="cursor-pointer px-2 py-1 rounded hover:bg-gray-200 select-none">
                    </div>
                    <!-- ë“œë¡­ë‹¤ìš´ -->
                    <div id="staff-dropdown"
                      class="hidden fixed bg-white border rounded shadow-lg z-[9999] max-h-60 overflow-y-auto">
                  </div>
                  </div>
                </div>
              </div>
              <table>
                <thead>
                  <tr id="header-row">
                    <th class="resizable" style="width: 1.6rem;">
                      <div class="resize-handle"></div>
                    </th>
                    <th class="resizable" style="width: 14rem;">
                      ë§¤ë¬¼ëª… <div class="resize-handle"></div>
                    </th>
                    <th class="resizable" style="width: 11rem;">
                      ì£¼ì†Œ <div class="resize-handle"></div>
                    </th>
                    <th class="resizable" style="width: 5rem;">
                      ë³´ì¦ê¸ˆ <div class="resize-handle"></div>
                    </th>
                    <th class="resizable" style="width: 3.5rem;">
                      ì›”ì„¸ <div class="resize-handle"></div>
                    </th>
                    <th class="resizable" style="width: 5rem;">
                      ê¶Œë¦¬ê¸ˆ <div class="resize-handle"></div>
                    </th>
                    <th class="resizable" style="width: 4.3rem;">
                      ì „ìš©(í‰) <div class="resize-handle"></div>
                    </th>
                    <th class="resizable" style="width: 13rem;">
                      ë‚´ìš© <div class="resize-handle"></div>
                    </th>
                  </tr>
                </thead>
                <tbody id="listings-body"></tbody>
              </table>
            </div>  
          </div>
          <!-- ì˜¤ë¥¸ìª½ ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ -->
          <div id="whitebox-resize-handle"
              style="
                  position: absolute;
                  top: 0;
                  right: -4px;
                  width: 8px;
                  height: 100%;
                  cursor: ew-resize;
                  z-index: 50;
              ">
          </div>
        </div>
        <div class="ml-3 mt-[6.2rem] flex flex-col">
          <div class="pt-2 px-2 py-2 bg-white border border-gray-300 rounded-md">
            <!-- ì˜¤ë¥¸ìª½(ìŠ¤í¬ë¦°ìƒ· ì œì™¸) ë©”ëª¨ í‘œ -->
            <div id="memo-panel" class="print:hidden sticky top-2">
              <table class="w-[20rem] border-collapse">
                <thead>
                  <tr>
                    <td class="p-1 border-b border-gray-200 align-top">
                      ë©”ëª¨
                    </th>
                  </tr>
                </thead>
                <tbody id="memo-body"></tbody>
              </table>
            </div>
          </div>
        </div>          
      </div>
    </div>
  </div>  
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://sfinbtiqlfnaaarziixu.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaW5idGlxbGZuYWFhcnppaXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MDkxNjEsImV4cCI6MjA2ODA4NTE2MX0.4-7vnIjbF-biWWuv9-vTxK9Y99gMm-vS6oaRMdRL5fA'
    );

    (() => {
      const box = document.getElementById('white-box');
      const handle = document.getElementById('whitebox-resize-handle');

      let isResizing = false;
      let startX = 0;
      let startWidth = 0;

      handle.addEventListener('mousedown', (e) => {
        isResizing = true;
        startX = e.clientX;
        startWidth = box.offsetWidth;
        document.body.style.userSelect = 'none';
      });

      window.addEventListener('mousemove', (e) => {
        if (!isResizing) return;

        const delta = e.clientX - startX;
        const newWidth = startWidth + delta;

        // === rem ë‹¨ìœ„ ì‚¬ìš©: 3remì„ pxë¡œ ê³„ì‚° ===
        const remPx = parseFloat(getComputedStyle(document.documentElement).fontSize); 
        const extraGap = remPx * 2; // 3rem

        const table = document.querySelector('#white-box table');
        const tableWidth = table ? table.offsetWidth : 0;

        const minWidth = tableWidth + extraGap;  // table + 3rem

        if (newWidth >= minWidth) {
          box.style.width = newWidth + 'px';
        }
      });

      window.addEventListener('mouseup', () => {
        if (isResizing) {
          // ìˆ˜ë™ ë¦¬ì‚¬ì´ì¦ˆ ì¢…ë£Œ ì‹œ white-box ì˜¤ë¥¸ìª½ ì—¬ë°± ì €ì¥
          const table = document.querySelector('#white-box table');
          const box = document.getElementById('white-box');

          const tableWidth = table.offsetWidth;
          const boxWidth = box.offsetWidth;

          whiteBoxExtraGap = boxWidth - tableWidth; 
        }

        isResizing = false;
        document.body.style.userSelect = '';
      });
    })();

    // ì´ˆê¸°ì— white-box í­ì„ table í¬ê¸°ì— ë§ì¶° ì •í™•íˆ ì„¤ì •
    function initializeWhiteBoxWidth() {
      const box = document.getElementById('white-box');
      const table = document.querySelector('#white-box table');
      if (!box || !table) return;

      // ìµœì´ˆ tableê³¼ box ê°„ì˜ ì—¬ë°± ê³„ì‚°
      const tableWidth = table.offsetWidth;
      const boxWidth = box.offsetWidth;

      whiteBoxExtraGap = boxWidth - tableWidth;

      // white-box ì´ˆê¸° ë„ˆë¹„ë¥¼ í…Œì´ë¸”+ì—¬ë°±ìœ¼ë¡œ ê°•ì œë¡œ í†µì¼
      box.style.width = (tableWidth + whiteBoxExtraGap) + 'px';
    }

    window.addEventListener("load", initializeWhiteBoxWidth);
    
    (async () => {
      try {
        // 1) ë¡œê·¸ì¸ ì„¸ì…˜ í™•ì¸ (ì—†ìœ¼ë©´ ì´ë™)
        const { data, error } = await supabase.auth.getSession();
        if (error) console.warn("ì„¸ì…˜ ì¡°íšŒ ì—ëŸ¬:", error);
        if (!data?.session) {
          console.warn("ë¡œê·¸ì¸ ì„¸ì…˜ ì—†ìŒ â†’ /map ìœ¼ë¡œ ì´ë™");
          location.replace("https://baikuk-map.netlify.app/admin/listings/");
          return;
        }

        // 2) ê¶Œí•œ ê¸°ë°˜ìœ¼ë¡œ 'ì •ì‚°' íƒ­ í‘œì‹œ/ìˆ¨ê¹€
        const guardClick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          alert('ì§ì› ê¶Œí•œì€ ì •ì‚° ë©”ë‰´ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        };

        const showOrHideSettlementTab = async () => {
          const tab = document.getElementById('settlement-tab');
          if (!tab) return;

          const { data: { user } } = await supabase.auth.getUser();
          if (!user?.id) return;

          const { data: me, error: authErr } = await supabase
            .from('staff_profiles')
            .select('authority')
            .eq('user_id', user.id)
            .maybeSingle();

          if (authErr) {
            console.warn('authority ì¡°íšŒ ì‹¤íŒ¨:', authErr);
            return; // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ìˆ¨ê¹€ ìœ ì§€
          }

          const role = (me?.authority || '').trim();
          if (role === 'ì§ì›') {
            // ì§ì›: ìˆ¨ê¹€(ê¸°ë³¸ê°’ ìœ ì§€) + ì•ˆì „ ê°€ë“œ
            tab.style.display = 'none';
            tab.addEventListener('click', guardClick, { once: true });
          } else {
            // ê´€ë¦¬ì/ì§€ì ì¥: í‘œì‹œ
            tab.style.removeProperty('display');
          }
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', showOrHideSettlementTab, { once: true });
        } else {
          showOrHideSettlementTab();
        }
      } catch (e) {
        console.warn('ì„¸ì…˜/ì •ì‚° íƒ­ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸:', e);
      }
    })();

    window.supabase = supabase; // ì „ì—­ìœ¼ë¡œ ì ‘ê·¼
  </script>
  <script>
    // === í–‰ ê´€ì°°ìš© ì „ì—­ ===
    let listingsBody;          // tbody ìºì‹œ
    let rowObserver;           // ResizeObserver ì¸ìŠ¤í„´ìŠ¤
    // ì§ì› ì„ íƒ ì €ì¥ìš© ì „ì—­ ë³€ìˆ˜
    let selectedStaffId = null;

    /* ----------------------------------------------------
      [ë§¤ë¬¼ ì €ì¥ ê¸°ëŠ¥]
      í˜„ì¬ ì„ íƒëœ ê³ ê°(currentCustomerId)ì˜ ë§¤ë¬¼ì •ë³´ë¥¼
      Supabase í…Œì´ë¸” customers_recommendations ì— ì €ì¥
    ---------------------------------------------------- */
    async function saveListingsForCurrentCustomer() {
      if (!currentCustomerId) {
        showToast("ë¨¼ì € ê³ ê°ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return false;
      }

      // ê¶Œí•œ í™•ì¸(ëŒ€í‘œ/ë³´ì¡°ë§Œ ê°€ëŠ¥)
      if (!(await isMyAssignedCustomer(currentCustomerId))) {
        showToast("ë‹´ë‹¹ìê°€ ì•„ë‹Œ ê³ ê°ì˜ ë§¤ë¬¼ì€ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return false;
      }

      const rows = document.querySelectorAll("#listings-body tr");
      const result = [];

      rows.forEach((tr, i) => {
        const index = i + 1;

        const listing_title  = getFieldValue("listing_title", index);
        const full_address   = getFieldValue("full_address", index);
        const deposit_price  = getFieldValue("deposit_price", index);
        const monthly_rent   = getFieldValue("monthly_rent", index);
        const premium_price  = getFieldValue("premium_price", index);
        const area_py        = getFieldValue("area_py", index);
        const contents       = getFieldValue("description", index);
        const listing_id     = getListingNumber(index);
        const color = getFieldValue("color", index);

        // ì™„ì „íˆ ë¹„ì–´ ìˆìœ¼ë©´ ìŠ¤í‚µ
        if (
          !listing_title &&
          !full_address &&
          !deposit_price &&
          !monthly_rent &&
          !premium_price &&
          !area_py &&
          !contents &&
          !listing_id
        ) return;

        result.push({
          customers_id   : String(currentCustomerId), 
          order          : index,
          listing_id     : listing_id || null,
          listing_title  : listing_title || null,
          full_address   : full_address || null,
          deposit_price  : Number(String(deposit_price).replace(/[^\d]/g, "")) || 0,
          monthly_rent   : Number(String(monthly_rent).replace(/[^\d]/g, "")) || 0,
          premium_price  : Number(String(premium_price).replace(/[^\d]/g, "")) || 0,
          area_py        : Number(area_py) || null,
          contents       : contents || null,
          memo          : getMemoValue(index) || null,
          color          : color || null,
          row_properties: {
            strike: getFieldValue("strike", index) === "1" ? 1 : null
          }
        });
      });

      try {
        // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
        const { error: delErr } = await supabase
          .from("customers_recommendations")
          .delete()
          .eq("customers_id", String(currentCustomerId));

        if (delErr) {
          console.error(delErr);
          showToast("ê¸°ì¡´ ë§¤ë¬¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜.");
          return false;
        }

        // ì‹ ê·œ ë°ì´í„° ì‚½ì…
        const { error: insertErr } = await supabase
          .from("customers_recommendations")
          .insert(result);

        if (insertErr) {
          console.error(insertErr);
          showToast("ë§¤ë¬¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          return false;
        }

        return true;
      } catch (e) {
        console.error(e);
        showToast("ë§¤ë¬¼ ì €ì¥ ì¤‘ ì˜ˆì™¸ ë°œìƒ");
        return false;
      }
    }

    // === [ADD] 'ì—…ë°ì´íŠ¸(ë§¤ë¬¼ì¥)' í‘œê¸° ìœ í‹¸ ===
    // ISO ë˜ëŠ” Date â†’ "YYYY. M. D. HH:mm" (KST)
    function formatDate(input) {
      const d = (input instanceof Date) ? input : new Date(input);
      if (isNaN(d)) return '';
      const parts = new Intl.DateTimeFormat('ko-KR', {
        timeZone: 'Asia/Seoul',
        year: 'numeric',
        month: 'numeric',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false,
      }).formatToParts(d);
      const get = (type) => parts.find(p => p.type === type)?.value || '';
      const y  = get('year');
      const m  = Number(get('month'));
      const day = Number(get('day'));
      const hh = get('hour').padStart(2, '0');
      const mm = get('minute').padStart(2, '0');
      return `${y}. ${m}. ${day}. ${hh}:${mm}`;
    }

    // timetz ë¬¸ìì—´ì„ KST ì˜¤ëŠ˜ ë‚ ì§œì™€ ê²°í•©í•´ Dateë¡œ ë³€í™˜ (ì˜¤ì „/ì˜¤í›„, +09 ì§€ì›)
    function _timetzToTodayISO(tzStr) {
      if (!tzStr) return null;
      let raw = String(tzStr).trim();

      const ampm = raw.match(/^(ì˜¤ì „|ì˜¤í›„)\s*(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
      if (ampm) {
        const isPM = ampm[1] === 'ì˜¤í›„';
        let hh = parseInt(ampm[2], 10);
        const mm = ampm[3];
        const ss = ampm[4] || '00';
        if (isPM && hh < 12) hh += 12;
        if (!isPM && hh === 12) hh = 0;
        raw = `${String(hh).padStart(2,'0')}:${mm}:${ss}`;
      }

      const datePart = new Intl.DateTimeFormat('en-CA', {
        timeZone: 'Asia/Seoul', year: 'numeric', month: '2-digit', day: '2-digit',
      }).format(new Date());

      const m = raw.match(/^(\d{1,2}:\d{2}(?::\d{2})?)(?:\s*([+-]\d{1,2})(?::?(\d{2}))?)?$/);
      if (!m) return null;

      const timePart = m[1];
      let offH = (m[2] !== undefined) ? Number(m[2]) : 9;
      let offM = (m[3] !== undefined) ? Number(m[3]) : 0;

      const sign = offH >= 0 ? '+' : '-';
      offH = Math.abs(offH);
      const offset = `${sign}${String(offH).padStart(2,'0')}:${String(offM).padStart(2,'0')}`;

      const hhmmss = timePart.length === 5 ? `${timePart}:00` : timePart;
      const iso = `${datePart}T${hhmmss}${offset}`;
      const d = new Date(iso);
      return isNaN(d.getTime()) ? null : d;
    }

    // update_log.imDae_sheet_timetz íŒŒì„œ (timestamptz/timetz ëª¨ë‘ ì§€ì›)
    function _parseUpdateLogTime(v) {
      if (!v) return null;
      if (v instanceof Date) return isNaN(v.getTime()) ? null : v;
      const s = String(v).trim();
      if (/^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}(:\d{2})?([+-]\d{2}:?\d{2}|Z)?$/.test(s)) {
        const isoLike = s.replace(' ', 'T');
        const d = new Date(isoLike);
        return isNaN(d.getTime()) ? null : d;
      }
      return _timetzToTodayISO(s);
    }

    // movementë³„ ìµœì‹  1ê±´ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
    async function getLatestUpdateISO(movement) {
      try {
        const { data, error } = await window.supabase
          .from('update_log')
          .select('imDae_sheet_timetz')
          .eq('memo', 'ì—…ë°ì´íŠ¸ì„±ê³µ')
          .eq('movement', movement)
          .order('imDae_sheet_timetz', { ascending: false })
          .limit(1)
          .maybeSingle();
        if (error) throw error;
        const t = data?.imDae_sheet_timetz ?? null;
        return t ? _parseUpdateLogTime(t) : null;
      } catch (e) {
        console.warn('update_log ì¡°íšŒ ì‹¤íŒ¨:', e);
        return null;
      }
    }

    // ë©”íƒ€ ìŠ¤íŒ¬ì— í‘œê¸°
    async function refreshLatestMeta() {
      const meta = document.getElementById('employee-listings-meta');
      if (!meta) return;
      meta.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';

      try {
        const maemulAt = await getLatestUpdateISO('ë§¤ë¬¼ì¥');

        if (!maemulAt) {
          meta.textContent = 'ë§¤ë¬¼ì •ë³´ ì—…ë°ì´íŠ¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤';
          meta.style.color = ''; // ê¸°ë³¸ìƒ‰
          return;
        }

        // í˜„ì¬ KST ì‹œê°„
        const now = new Date();
        const nowKST = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));

        // ì°¨ì´ (ë°€ë¦¬ì´ˆ)
        const diffMs = nowKST - maemulAt;
        const diffHours = diffMs / (1000 * 60 * 60);

        // ê¸°ë³¸ í‘œê¸°
        meta.textContent = `ë§¤ë¬¼ì •ë³´ ì—…ë°ì´íŠ¸ :  ${formatDate(maemulAt)}`;

        // 1ì‹œê°„ ì´ìƒ ì°¨ì´ â†’ ë¹¨ê°„ìƒ‰
        if (diffHours >= 1) {
          meta.style.color = '#FF4D4D';
          meta.style.fontWeight = 'bold';
        } else {
          // 1ì‹œê°„ ë¯¸ë§Œ â†’ ê¸°ë³¸ìƒ‰ (ì›ìƒë³µêµ¬)
          meta.style.color = '';
          meta.style.fontWeight = '';
        }

      } catch {
        meta.textContent = 'ë§¤ë¬¼ì •ë³´ ì—…ë°ì´íŠ¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤';
        meta.style.color = ''; // ê¸°ë³¸ìƒ‰
      }
    }

    // ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘
    // === [ì¶”ê°€] 'ë‚´ìš©' ë³µì‚¬ ê¸°ëŠ¥ìš© í—¬í¼ ===
    function getDescriptionValue(index) {
      const el = document.querySelector(`[data-field="description_${index}"]`);
      if (!el) return '';
      if (el.tagName === 'SPAN') return (el.textContent || '').trim();
      return (el.value || '').trim();
    }

    function setDescriptionValue(index, value) {
      const el = document.querySelector(`[data-field="description_${index}"]`);
      if (!el) return;
      if (el.tagName === 'SPAN') el.textContent = value ?? '';
      else el.value = value ?? '';
    }

    /** í˜„ì¬ 50ì¹¸ì˜ 'ë§¤ë¬¼ë²ˆí˜¸' inputë“¤ ì¤‘ ë™ì¼ ë§¤ë¬¼ë²ˆí˜¸ê°€ ìˆëŠ” í–‰ index ë°˜í™˜ (ì—†ìœ¼ë©´ null)
     *   - ë¹„êµ ì‹œ ìˆ«ìë§Œ ë¹„êµ (í•˜ì´í”ˆ/ê³µë°± ë“± ë¬´ì‹œ)
     */
    function findRowIndexByListingNumber(listingId, ignoreIndex = null) {
      const cleaned = String(listingId).replace(/[^\d]/g, '');
      if (!cleaned) return null;

      let found = null;
      document.querySelectorAll('input[data-index]').forEach(inp => {
        const idx = parseInt(inp.dataset.index, 10);
        if (ignoreIndex && idx === ignoreIndex) return;
        const val = String(inp.value || '').replace(/[^\d]/g, '');
        if (val && val === cleaned && found === null) {
          found = idx;
        }
      });
      return found;
    }

    function renderMemoPanel(listings = []) {
      const memoBody = document.getElementById('memo-body');
      if (!memoBody) return;
      memoBody.innerHTML = '';

      // order â†’ memo ë§¤í•‘ (orderê°€ ì—†ìœ¼ë©´ ì¸ë±ìŠ¤ë¡œ ê°€ì •)
      const memoMap = new Map();
      listings.forEach((it, idx) => {
        const order = (typeof it.order === 'number' && !Number.isNaN(it.order)) ? it.order : (idx + 1);
        memoMap.set(order, typeof it.memo === 'string' ? it.memo : '');
      });

      for (let i = 1; i <= 50; i++) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-1 border-b border-gray-200 align-top">
            <div class="flex items-start gap-2 h-full">
              <textarea
                class="w-[18rem] h-full resize-none outline-none bg-transparent text-sm align-top box-border p-1"
                data-memo-index="${i}"
                placeholder="ë©”ëª¨ ì…ë ¥"
                rows="1"
                style="height:100%;min-height:0"
              ></textarea>
            </div>
          </td>
        `;
        memoBody.appendChild(tr);

        // ì €ì¥ëœ ê°’ ìˆìœ¼ë©´ ì±„ì›€
        const ta = tr.querySelector('textarea[data-memo-index]');
        const val = memoMap.get(i);
        if (ta && typeof val === 'string') ta.value = val;
      }

      syncMemoRowHeights();
    }

    /** í˜„ì¬ í™”ë©´ì˜ ë©”ëª¨ Ní–‰ì—ì„œ ë¬¸ìì—´ì„ ì½ì–´ì˜´ (ì—†ìœ¼ë©´ ë¹ˆë¬¸ìì—´) */
    function getMemoValue(index) {
      const el = document.querySelector(`textarea[data-memo-index="${index}"]`);
      return (el?.value || '').trim();
    }

    // í˜„ì¬ ìˆëŠ” ëª¨ë“  í–‰ì„ ê´€ì°°
    function observeRows() {
      if (!listingsBody) return;
      if (!rowObserver) return;
      rowObserver.disconnect();
      listingsBody.querySelectorAll('tr').forEach(tr => rowObserver.observe(tr));
    }

    // âœ… data-field ê°’ì„ (span / input / textarea ëª¨ë‘ì—ì„œ) ì•ˆì „í•˜ê²Œ ì½ê¸°
    function getFieldValue(field, index) {
      const sel = `[data-field="${field}_${index}"]`;
      const el = document.querySelector(sel);
      if (!el) return '';
      if (el.tagName === 'SPAN') return (el.textContent || '').trim();
      return (el.value || '').trim();
    }

    // âœ… ê³µí†µ ì„¸í„°
    function setFieldValue(field, index, value) {
      const el = document.querySelector(`[data-field="${field}_${index}"]`);
      if (!el) return;
      if (el.tagName === 'SPAN') el.textContent = value ?? '';
      else el.value = value ?? '';
    }

    // âœ… íŠ¹ì • í•„ë“œë“¤ë§Œ ë‹¤ë¥¸ í–‰ì—ì„œ ë³µì‚¬í•´ì˜¤ê¸°
    function copyFieldsFromRow(srcIndex, destIndex, fields) {
      fields.forEach((f) => {
        const v = getFieldValue(f, srcIndex);
        if (v) setFieldValue(f, destIndex, v);
      });
    }

    // âœ… ì™¼ìª½ ë§¤ë¬¼ë²ˆí˜¸ inputì—ì„œ ë²ˆí˜¸ ì½ê¸°
    function getListingNumber(index) {
      const input = document.querySelector(`input[data-index="${index}"]`);
      return (input?.value || '').trim();
    }
    
    // === ë§¤ë¬¼ë²ˆí˜¸ ì¤‘ë³µ ì²´í¬ & ë¹¨ê°›ê²Œ í‘œì‹œ ===
    function highlightDuplicateListingNumbers() {
      const allInputs = [...document.querySelectorAll('input[data-index]')];

      // ê°’ ëª©ë¡ ìƒì„±
      const values = allInputs.map(inp => (inp.value || '').trim());

      allInputs.forEach((inp, idx) => {
        const v = values[idx];
        if (!v) {
          // ê°’ì´ ì—†ìœ¼ë©´ ìƒ‰ìƒ ì´ˆê¸°í™”
          inp.style.backgroundColor = '';
          inp.style.color = '';
          return;
        }

        // ë™ì¼ ê°’ì´ 2ê°œ ì´ìƒì¸ì§€ ì²´í¬
        const isDuplicate = values.filter(x => x === v).length > 1;

        if (isDuplicate) {
          // ë¹¨ê°„ í‘œì‹œ
          inp.style.backgroundColor = '#ffe4e4';
          inp.style.color = '#d00';
        } else {
          // ì •ìƒ ìƒ‰ìƒ ë³µì›
          inp.style.backgroundColor = '';
          inp.style.color = '';
        }
      });
    }

    // === ì‹¤ì œë¡œ ì¤‘ë³µì´ ìˆëŠ”ì§€ ì—¬ë¶€ë§Œ true/falseë¡œ ì•Œë ¤ì£¼ëŠ” í•¨ìˆ˜ ===
    function hasDuplicateListingNumbers() {
      const allInputs = [...document.querySelectorAll('input[data-index]')];
      const seen = new Set();

      for (const inp of allInputs) {
        const v = (inp.value || '').trim();
        if (!v) continue;
        if (seen.has(v)) {
          return true;  // ì´ë¯¸ ë³¸ ê°’ì´ë©´ ì¤‘ë³µ
        }
        seen.add(v);
      }
      return false;
    }

    // âœ… ëˆ í¬ë§· ë˜ì–´ ìˆëŠ” ë¬¸ìì—´ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ(â€˜ì–µ 2,000â€™ ë“±ë„ í—ˆìš©) â†’ ë‹¤ì‹œ ì›ë˜ ë¬¸ìì—´ ê·¸ëŒ€ë¡œ ì“°ê¸¸ ì›í•˜ë©´ ì´ ë¶€ë¶„ ì¡°ì •
    const stripEmpty = (s) => (s || '').trim();

    // (êµì²´) ë³´ì¦ê¸ˆ/ì›”ì„¸ ë¼ë²¨ì„ ë¶™ì—¬ì„œ í•©ì„±
    function joinMoney(deposit, monthly) {
      const a = (deposit || '').trim(); // ì˜ˆ: "1ì–µ 5,000"
      const b = (monthly || '').trim(); // ì˜ˆ: "800"
      const aL = a ? `${a}` : '';
      const bL = b ? `${b}`   : '';
      if (a && b) return `${aL}/${bL}`;
      return aL || bL || '';
    }

    // âœ… í•´ë‹¹ í–‰ì— â€œì˜ë¯¸ ìˆëŠ” ê°’â€ì´ í•˜ë‚˜ë¼ë„ ìˆëŠ”ì§€ í™•ì¸ (ë²ˆí˜¸ ì œì™¸)
    function hasMeaningfulData(index) {
      const keys = [
        'listing_title', 'full_address', 'combined_unit', 'deposit_price',
        'monthly_rent', 'premium_price', 'area_py', 'description'
      ];
      return keys.some(k => !!getFieldValue(k, index));
    }

    // âœ… í•œ í–‰ì„ ë©”ì‹œì§€ 4ì¤„ë¡œ ë³€í™˜ (ì£¼ì†Œ ë’¤ "-" ë¬¸ì œ ìˆ˜ì • ë²„ì „)
    function buildMessageForRow(index) {
      const no     = getListingNumber(index) || '';
      const title  = getFieldValue('listing_title', index) || '-';
      const addr   = getFieldValue('full_address', index) || '';
      const unit   = getFieldValue('combined_unit', index) || '';   // ìƒì„¸ ì£¼ì†Œ/í˜¸ìˆ˜ ì •ë³´
      const dep    = getFieldValue('deposit_price', index);
      const mon    = getFieldValue('monthly_rent', index);
      const prem   = getFieldValue('premium_price', index);
      const area   = getFieldValue('area_py', index);
      const desc   = getFieldValue('description', index);

      // ğŸ”¥ ì£¼ì†Œ + ìƒì„¸ì£¼ì†Œ(í˜¸ìˆ˜) ì¡°í•© ê°œì„ 
      // unit(í˜¸ìˆ˜/ìƒì„¸ì£¼ì†Œ)ì´ ìˆì„ ë•Œë§Œ "-" ë¥¼ ë¶™ì¸ë‹¤
      let line2 = addr.trim();
      if (unit.trim()) {
        line2 = `${line2} - ${unit.trim()}`;
      }
      line2 = line2.trim();

      // 1í–‰
      const line1 = `${title}`.trim();

      // 3í–‰: "ë©´ì  ë³´ì¦ê¸ˆ/ì›”ì„¸ ê¶Œë¦¬ê¸ˆ"
      const areaPart   = area ? `${area}í‰` : '';
      const moneyPair  = joinMoney(dep, mon); // ë³´ì¦ê¸ˆ/ì›”ì„¸
      const premiumTag = prem ? `ê¶Œ${prem}` : '';
      const parts = [areaPart, moneyPair, premiumTag].filter(Boolean);
      const line3 = parts.join(' ');

      // 4í–‰: ì„¤ëª…
      const line4 = desc || '';

      // 5í–‰: URL (ë§¤ë¬¼ë²ˆí˜¸ ìˆì„ ë•Œ)
      const baseUrl = "https://baikuk.com/item/view/";
      const line5 = no ? `${baseUrl}${no}` : '';

      const lines = [line1, line2, line3, line4, line5].filter(l => l !== '');
      return lines.join('\n');
    }

    // âœ… ì „ì²´ í–‰ì„ í›‘ì–´ í…ìŠ¤íŠ¸ ìƒì„±
    function buildAllMessages() {
      const rows = document.querySelectorAll('#listings-body tr');
      const blocks = [];
      rows.forEach((_, i) => {
        const idx = i + 1; // ì‹¤ì œ index
        if (hasMeaningfulData(idx) || getListingNumber(idx)) {
          const msg = buildMessageForRow(idx);
          if (msg) {
            // ğŸ”¹ ì•ì— ìˆœì„œ ë²ˆí˜¸ ë¶™ì´ê¸°
            blocks.push(`${blocks.length + 1}.\n${msg}`);
          }
        }
      });
      return blocks.join('\n\n'); // í–‰ê³¼ í–‰ ì‚¬ì´ ë¹ˆ ì¤„
    }

    // âœ… í´ë¦½ë³´ë“œ ë³µì‚¬ (í‘œì¤€ + í´ë°±)
    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        showToast('ë§í¬ìš© ë¬¸êµ¬ë¥¼ ë³µì‚¬í–ˆì–´ìš”.');
      } catch {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        try {
          document.execCommand('copy');
          showToast('ë§í¬ìš© ë¬¸êµ¬ë¥¼ ë³µì‚¬í–ˆì–´ìš”.');
        } catch {
          showToast('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
        }
        document.body.removeChild(ta);
      }
    }
    
    // í‡´ì‚¬ì ì•ˆë³´ì´ëŠ” ê´€ë ¨ì½”ë“œ
    // âœ… ë‚´ ê¶Œí•œ/ì†Œì† ì¡°íšŒ
    async function getAuthContext() {
      const { data: { user }, error: userError } = await supabase.auth.getUser();
      if (userError || !user) return { me: null, myAuth: null, myAff: null };

      const { data: me, error: meErr } = await supabase
        .from('staff_profiles')
        .select('id, authority, affiliation')
        .eq('user_id', user.id)
        .maybeSingle();

      return {
        me,
        myAuth: me?.authority ?? null,      // 'ê´€ë¦¬ì' | 'ì§€ì ì¥' | 'ì§ì›'
        myAff: (me?.affiliation ?? '').trim()
      };
    }

    // âœ… ì§ì› ëª©ë¡ ë¡œë”© (ê¶Œí•œë³„ í‡´ì‚¬ì í‘œì‹œ ì œì–´)
    async function loadStaffOptions(currentStaffId = null) {
      const staffSelect = document.getElementById('staff-select');
      if (!staffSelect) return;
      staffSelect.innerHTML = '';

      // ê¶Œí•œ/ì†Œì†
      const { me, myAuth, myAff } = await getAuthContext();
      if (!me) return;

      // 1) ê¸°ë³¸ ì¿¼ë¦¬
      let q = supabase
        .from('staff_profiles')
        .select('id, name, affiliation, leave_date')
        .order('affiliation', { ascending: true })
        .order('name', { ascending: true });

      // 2) ê¶Œí•œì´ 'ì§ì›'ì´ë©´ í‡´ì‚¬ì ì œì™¸
      if (myAuth === 'ì§ì›') {
        q = q.is('leave_date', null);
      }

      const { data: staffList, error: staffErr } = await q;
      if (staffErr || !staffList) return;

      // ë‚´ê°€ ë¡œê·¸ì¸í•œ staff id
      const myStaffId = me.id;

      // 3) ì†Œì†ë³„ ê·¸ë£¹í™”
      const grouped = staffList.reduce((acc, s) => {
        (acc[s.affiliation || 'ë¯¸ì§€ì •'] ||= []).push(s);
        return acc;
      }, {});

      const appendGroup = (label, members) => {
        if (!members?.length) return;
        const og = document.createElement('optgroup');
        og.label = label;
        members.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.id;
          const retiredTag = (myAuth !== 'ì§ì›' && s.leave_date) ? ' (í‡´ì‚¬)' : '';
          opt.textContent = `${s.name}${retiredTag}`;

          // âœ… ìš°ì„ ìˆœìœ„: currentStaffId â†’ ì—†ìœ¼ë©´ ë‚´ staff id
          if ((currentStaffId && s.id === currentStaffId) || (!currentStaffId && s.id === myStaffId)) {
            opt.selected = true;
          }

          og.appendChild(opt);
        });
        staffSelect.appendChild(og);
      };

      if (myAff && grouped[myAff]) {
        appendGroup(`${myAff} (ê°™ì€ ì†Œì†)`, grouped[myAff]);
        delete grouped[myAff];
      }

      Object.entries(grouped).forEach(([aff, members]) => {
        appendGroup(aff, members);
      });
    }

    // ì²«ë¡œë“œì‹œ ì§ì›í‘œì‹œ í•¨ìˆ˜
    async function loadCurrentUserStaffInfo() {
      const {
        data: { user },
        error
      } = await supabase.auth.getUser();

      if (error || !user) return;

      const userId = user.id;

      // staff_profiles í…Œì´ë¸”ì—ì„œ í•´ë‹¹ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
      const { data: staff } = await supabase
        .from('staff_profiles')
        .select('id, position, name, phone_num')
        .eq('user_id', userId) // í˜¹ì€ eq('id', userId) â†’ ì‹¤ì œ êµ¬ì¡°ì— ë”°ë¼ ë³€ê²½
        .maybeSingle();

      if (staff) {
        const staffInfoBox = document.getElementById('staff-info');
        if (staffInfoBox) {
          staffInfoBox.textContent = `${staff.position ?? ''} ${staff.name ?? ''} ${staff.phone_num ?? ''}`.trim();
          staffInfoBox.classList.remove('hidden');
        }

        // í˜„ì¬ ì„ íƒëœ ì§ì› ID ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
        selectedStaffId = staff.id || null;

        // ê¸°ì¡´ select UIëŠ” ìˆ¨ê¹€ ì²˜ë¦¬ (í˜¹ì‹œ ë‚¨ì•„ìˆì„ ê²½ìš° ëŒ€ë¹„)
        const staffSelect = document.getElementById('staff-select');
        if (staffSelect) staffSelect.classList.add('hidden');
      }
    }

    // ì§ì› ì´ë¦„ í´ë¦­ ì‹œ ì§ì› ë¦¬ìŠ¤íŠ¸ ë“œë¡­ë‹¤ìš´
    function setupStaffDropdown() {
      const staffInfo = document.getElementById('staff-info');
      const dropdown = document.getElementById('staff-dropdown');
      const container = document.getElementById('staff-info-container');

      if (!staffInfo || !dropdown || !container) return;

      // ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
      function closeDropdown() {
        dropdown.classList.add('hidden');
      }

      // ë“œë¡­ë‹¤ìš´ ì—´ê¸° + ì§ì› ë¦¬ìŠ¤íŠ¸ ë¡œë”©
      async function openDropdown() {
        // ìœ„ì¹˜ ì¡ê¸°
        const rect = staffInfo.getBoundingClientRect();
        dropdown.style.minWidth = rect.width + 'px';
        dropdown.style.left = rect.left + window.scrollX + 'px';
        dropdown.style.top = rect.bottom + window.scrollY + 4 + 'px';

        dropdown.classList.remove('hidden');
        dropdown.innerHTML = `
          <div class="px-3 py-2 text-sm text-gray-500">
            ì§ì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
          </div>
        `;

        const { me, myAuth, myAff } = await getAuthContext();

        if (!me) {
          dropdown.innerHTML = `
            <div class="px-3 py-2 text-sm text-red-500">
              ì§ì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.
            </div>
          `;
          return;
        }

        // ì§ì› ëª©ë¡ ì¡°íšŒ (í‡´ì‚¬ì ì œì™¸)
        const { data: staffList, error } = await supabase
          .from('staff_profiles')
          .select('id, name, position, phone_num, affiliation')
          .is('leave_date', null)   // í‡´ì‚¬ì ì œì™¸
          .order('affiliation', { ascending: true })
          .order('name', { ascending: true });

        if (error || !staffList || staffList.length === 0) {
          dropdown.innerHTML = `
            <div class="px-3 py-2 text-sm text-gray-500">
              í‘œì‹œí•  ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
          `;
          return;
        }

        // ì§€ì (affiliation)ë³„ ê·¸ë£¹í™”
        const grouped = staffList.reduce((acc, s) => {
          const aff = (s.affiliation || 'ë¯¸ì§€ì •').trim();
          (acc[aff] ||= []).push(s);
          return acc;
        }, {});

        dropdown.innerHTML = '';

        // ì§€ì  ìˆœì„œ ì •ë ¬: ë‚´ ì§€ì  ìš°ì„  + ë‚˜ë¨¸ì§€ ê°€ë‚˜ë‹¤ìˆœ
        const sortedAffiliations = Object.keys(grouped).sort((a, b) => {
          if (a === myAff) return -1;   // í˜„ì¬ ì§€ì ì´ aë©´ í•­ìƒ ë§¨ ìœ„
          if (b === myAff) return 1;    // í˜„ì¬ ì§€ì ì´ bë©´ aë³´ë‹¤ ì•„ë˜
          return a.localeCompare(b, 'ko'); // ë‚˜ë¨¸ì§€ëŠ” ê°€ë‚˜ë‹¤ìˆœ
        });

        sortedAffiliations.forEach(aff => {
          const group = grouped[aff];

          // ì§€ì  í—¤ë”
          const header = document.createElement('div');
          header.className =
            'px-3 py-1 text-xs font-semibold text-gray-500 bg-gray-50 border-b border-gray-100';
          const headerLabel = aff === 'ë¯¸ì§€ì •' ? 'ì§€ì  ë¯¸ì§€ì •' : `${aff} ì§€ì `;
          header.textContent = headerLabel;
          dropdown.appendChild(header);

          // ì§ì› ëª©ë¡
          group.forEach(staff => {
            const isSelected = selectedStaffId && selectedStaffId === staff.id;

            const item = document.createElement('button');
            item.type = 'button';
            item.className =
              'w-full text-left px-3 py-2 text-sm hover:bg-gray-100 flex flex-col ' +
              (isSelected ? 'bg-blue-50' : '');

            // ì§ì› ì •ë³´ ê°€ë¡œ ë°°ì¹˜
            const row = document.createElement('div');
            row.className = 'flex items-center gap-3 pl-4'; 

            const namePart = document.createElement('span');
            namePart.className = 'font-medium text-gray-800';
            namePart.textContent = `${staff.position ?? ''} ${staff.name ?? ''}`.trim();

            const phonePart = document.createElement('span');
            phonePart.className = 'text-sm text-gray-500';
            phonePart.textContent = staff.phone_num || '';

            row.appendChild(namePart);
            if (staff.phone_num) row.appendChild(phonePart);

            item.appendChild(row);

            item.addEventListener('click', () => {
              selectedStaffId = staff.id;
              staffInfo.textContent = `${staff.position ?? ''} ${staff.name ?? ''} ${staff.phone_num ?? ''}`.trim();
              closeDropdown();
            });

            dropdown.appendChild(item);
          });
        });
      }

      // ì´ë¦„ í´ë¦­ â†’ í† ê¸€
      staffInfo.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (dropdown.classList.contains('hidden')) {
          await openDropdown();
        } else {
          closeDropdown();
        }
      });

      // ë°”ê¹¥ í´ë¦­í•˜ë©´ ë‹«ê¸°
      document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
          closeDropdown();
        }
      });
    }

    // âœ… ë‚´ staff_profiles.id ê°€ì ¸ì˜¤ê¸°
    async function getMyStaffId() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return null;
      const { data: me } = await supabase
        .from('staff_profiles')
        .select('id')
        .eq('user_id', user.id)
        .maybeSingle();
      return me?.id ?? null;
    }

    // âœ… ë‚´ê°€(ëŒ€í‘œ/ë³´ì¡°) ë°°ì •ëœ ê³ ê°ì¸ì§€ í™•ì¸ (ê³ ê°-ë‹´ë‹¹ ë§í¬ OR customers.staff_profiles_id)
    async function isMyAssignedCustomer(customerId) {
      const myId = await getMyStaffId();
      if (!myId || !customerId) return false;

      const [{ data: link }, { data: cust }] = await Promise.all([
        supabase
          .from('customer_assignees')
          .select('customer_id')
          .eq('customer_id', customerId)
          .eq('staff_profiles_id', myId)
          .maybeSingle(),
        supabase
          .from('customers')
          .select('id, staff_profiles_id')
          .eq('id', customerId)
          .maybeSingle()
      ]);

      return !!link || (!!cust && cust.staff_profiles_id === myId);
    }

    // ì†ë‹˜ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜ (ëŒ€í‘œ/ë³´ì¡° ë‘˜ ë‹¤ ì ‘ê·¼ ê°€ëŠ¥)
    async function loadCustomerDataByName(name) {
        const myId = await getMyStaffId();
        if (!myId) { showToast('ë¡œê·¸ì¸ í•„ìš”'); return; }

        // 1) ì´ë¦„ìœ¼ë¡œ ê³ ê° 1ëª… ì°¾ê¸° (ì¡°ì¸ X)
        const { data: customer, error: custError } = await supabase
        .from('customers')
        .select(`
            id, customer_name, customer_phone_number, grade, memo, staff_profiles_id,
            floor_min, floor_max,
            area_min, area_max,
            deposit_min, deposit_max,
            rent_min, rent_max,
            rent_per_py_min, rent_per_py_max,
            premium_min, premium_max,
            sale_min, sale_max,
            total_deposit_min, total_deposit_max,
            total_rent_min, total_rent_max,
            roi_min, roi_max
            `)
        .eq('customer_name', name)
        .maybeSingle();

        if (custError || !customer) {
        console.warn('âŒ ê³ ê° ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', custError);
        showToast('ê³ ê° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
        }

        // 2) ì ‘ê·¼ ê¶Œí•œ ì²´í¬ (ëŒ€í‘œ ë˜ëŠ” ë³´ì¡°)
        const allowed = (customer.staff_profiles_id === myId) || (await isMyAssignedCustomer(customer.id));
        if (!allowed) {
        showToast('ë‹´ë‹¹ìê°€ ì•„ë‹Œ ê³ ê°ì€ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
        }

        currentCustomerId = customer.id;

        // ğŸ‘‰ ìš°ì¸¡ ì •ë³´ì°½ ì±„ìš°ê¸°
        document.getElementById('top-row-input').value = customer.customer_name || '';
        document.getElementById('customer-phone').value = customer.customer_phone_number || '';
        document.getElementById('customer-grade').value = customer.grade || 'F';
        document.getElementById('memo-textarea').value = customer.memo || '';
        document.getElementById("floor-min").value = customer.floor_min ?? "";
        document.getElementById("floor-max").value = customer.floor_max ?? "";
        document.getElementById("area-min").value = customer.area_min ?? "";
        document.getElementById("area-max").value = customer.area_max ?? "";
        document.getElementById("deposit-min").value = customer.deposit_min ?? "";
        document.getElementById("deposit-max").value = customer.deposit_max ?? "";
        document.getElementById("rent-min").value = customer.rent_min ?? "";
        document.getElementById("rent-max").value = customer.rent_max ?? "";
        document.getElementById("rent-per-py-min").value = customer.rent_per_py_min ?? "";
        document.getElementById("rent-per-py-max").value = customer.rent_per_py_max ?? "";
        document.getElementById("premium-min").value = customer.premium_min ?? "";
        document.getElementById("premium-max").value = customer.premium_max ?? "";
        document.getElementById("sale-min").value = customer.sale_min ?? "";
        document.getElementById("sale-max").value = customer.sale_max ?? "";
        document.getElementById("total-deposit-min").value = customer.total_deposit_min ?? "";
        document.getElementById("total-deposit-max").value = customer.total_deposit_max ?? "";
        document.getElementById("total-rent-min").value = customer.total_rent_min ?? "";
        document.getElementById("total-rent-max").value = customer.total_rent_max ?? "";
        document.getElementById("roi-min").value = customer.roi_min ?? "";
        document.getElementById("roi-max").value = customer.roi_max ?? "";

        // ğŸ‘‰ ì™¼ìª½ ë§¤ë¬¼ë²ˆí˜¸ ì…ë ¥ì°½ ì´ˆê¸°í™”
        document.querySelectorAll('input[data-index]').forEach(input => input.value = '');

        // ğŸ‘‰ ì˜¤ë¥¸ìª½ ë§¤ë¬¼ì…ë ¥ í…Œì´ë¸” ì´ˆê¸°í™”
        const listingsBody = document.getElementById('listings-body');
        listingsBody.innerHTML = '';

        // âœ… ì¶”ì²œ ë§¤ë¬¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (text ì»¬ëŸ¼ ë§ì¶° ë¬¸ìì—´ë¡œ ë¹„êµ + ì •ë ¬ ì •ë¦¬)
        const { data: listings, error: listingsError } = await supabase
        .from('customers_recommendations')
        .select('*')
        .eq('customers_id', String(currentCustomerId)) // â† íƒ€ì… ë§ì¶¤(ì¤‘ìš”)
        .order('order', { ascending: true, nullsFirst: false }) // order ë¨¼ì €, NULLì€ ë’¤ë¡œ
        .order('id', { ascending: true });                      // NULL ë¬¶ìŒ ë‚´ë¶€ëŠ” id ASC

        if (listingsError) {
        console.warn('âŒ ì¶”ì²œ ë§¤ë¬¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', listingsError);
        showToast('ì¶”ì²œ ë§¤ë¬¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        return;
        }

        // (êµì²´) order ê°’ ìˆìœ¼ë©´ ê·¸ ìë¦¬ë¥¼ ì“°ê³ , NULLì´ë©´ nextIndexë¡œ ìˆœì„œ ìœ ì§€
        let nextIndex = 1;

        listings.forEach((listing) => {
        // 1) ì¸ë±ìŠ¤ ê²°ì •
        const index = (typeof listing.order === 'number' && !Number.isNaN(listing.order))
            ? listing.order          // orderê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            : nextIndex++;           // orderê°€ NULLì´ë©´ ì˜ˆì „ì²˜ëŸ¼ ìˆœì„œëŒ€ë¡œ

        // 2) ì™¼ìª½ ë§¤ë¬¼ë²ˆí˜¸ ì±„ìš°ê¸°
        const leftInput = document.querySelector(`input[data-index="${index}"]`);
        if (leftInput) leftInput.value = listing.listing_id ?? '';

        // 3) ì˜¤ë¥¸ìª½ í‘œ í–‰ í™•ë³´/í™•ì¥
        updateListingsTableByInputs();

        // 4) í•„ë“œ ì£¼ì…
        const setField = (field, value) => {
            const el = document.querySelector(`[data-field="${field}_${index}"]`);
            if (!el) return;
            if (el.tagName === 'SPAN') el.textContent = value ?? '';
            else el.value = value ?? '';
        };

        setField('listing_title', listing.listing_title);
        setField('full_address', listing.full_address);

        // ğŸ”¹ ìˆ«ì í¬ë§· ì ìš© (ì½¤ë§ˆ í‘œì‹œ)
        setField('deposit_price', formatKoreanMoney(listing.deposit_price));
        setField('monthly_rent', formatKoreanMoney(listing.monthly_rent));
        setField('premium_price', formatKoreanMoney(listing.premium_price));
        setField('area_py', isNaN(Number(listing.area_py)) ? '-' : Number(listing.area_py).toFixed(1));

        setField('description', listing.contents);
        const memoValue = typeof listing.memo === 'string' ? listing.memo : '';
        const memoEl = document.querySelector(`textarea[data-memo-index="${index}"]`);
        if (memoEl) memoEl.value = memoValue;
        // === ğŸ”¥ ìƒ‰ìƒ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ===
        if (listing.color) {
            setFieldValue("color", index, listing.color);

            const tr = document.querySelector(`#listings-body tr:nth-child(${index})`);
            if (tr) {
            tr.dataset.userColor = "true";
            tr.style.backgroundColor = listing.color;
            tr.classList.remove("bg-white", "bg-gray-50");
            }
        }
        // === ğŸ”¥ ì·¨ì†Œì„ (strike) ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ===
        if (listing.row_properties?.strike === 1) {
            setFieldValue("strike", index, "1");

            const tr = document.querySelector(`#listings-body tr:nth-child(${index})`);
            if (tr) {
            tr.classList.add("line-through");
            }
        }

        // === ğŸ” ë¡œë”©ëœ ì·¨ì†Œì„  ì •ë³´ ì½˜ì†” ì¶œë ¥ ===
        console.log(`row ${index} strike =`, listing.row_properties?.strike ?? null);

        // 5) nextIndex ë³´ì •: orderê°€ ìˆëŠ” ë ˆì½”ë“œë¼ë©´ ë‹¤ìŒ NULL ë¼ì›Œë„£ê¸°ê°€
        //    ê²¹ì¹˜ì§€ ì•Šë„ë¡ nextIndexë¥¼ í•­ìƒ 'ìµœëŒ€ ì‚¬ìš© ì¸ë±ìŠ¤ + 1'ë¡œ ë§ì¶°ì¤ë‹ˆë‹¤.
        if (typeof listing.order === 'number' && !Number.isNaN(listing.order)) {
            nextIndex = Math.max(nextIndex, listing.order + 1);
        }
        });

        // ë†’ì´/ìŠ¤íŠ¸ë¼ì´í”„ ì •ë¦¬
        renderMemoPanel(listings);
        syncRowHeights?.();
        applyRowStriping?.();
        showToast(`ê³ ê° "${name}" ë°ì´í„° ë¶ˆëŸ¬ì˜´`);
        setDocumentTitle(name);

        // --- ğŸ‘‡ ë‹´ë‹¹ì í…ìŠ¤íŠ¸ í‘œì‹œ (ì½ê¸°ëª¨ë“œìš©) ---
        const staffInfoBox = document.getElementById('staff-info');
        if (customer.staff_profiles_id) {
            const { data: staff } = await supabase
                .from('staff_profiles')
                .select('position, name, phone_num')
                .eq('id', customer.staff_profiles_id)
                .maybeSingle();

            if (staff && staffInfoBox) {
                staffInfoBox.textContent = `${staff.position} ${staff.name} ${staff.phone_num}`;
                staffInfoBox.classList.remove('hidden');

                const staffSelect = document.getElementById('staff-select');
                if (staffSelect) staffSelect.classList.add('hidden');
            }
        }
    }

    // ì™¼ìª½íŒ¨ë„ì— ì†ë‹˜ì´ë¦„ ë¡œë”©í•¨ìˆ˜ (ëŒ€í‘œ/ë³´ì¡° ì „ë¶€, ë“±ê¸‰ ì œí•œ ì—†ìŒ)
    async function loadCustomersForCurrentStaff() {
      const myId = await getMyStaffId();
      if (!myId) {
        console.error('âŒ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // 1) ë‚´ê°€ 'ëŒ€í‘œ'ì¸ ê³ ê°
      const { data: primaryList, error: pErr } = await supabase
        .from('customers')
        .select('id, customer_name, grade')
        .eq('staff_profiles_id', myId);

      // 2) ë‚´ê°€ 'ë°°ì •ì(ëŒ€í‘œ/ë³´ì¡°)'ë¡œ ë“¤ì–´ê°„ ê³ ê° (ì¡°ì¸)
      const { data: assigneeList, error: aErr } = await supabase
        .from('customers')
        .select(`
          id,
          customer_name,
          grade,
          customer_assignees!inner(staff_profiles_id, is_primary)
        `)
        .eq('customer_assignees.staff_profiles_id', myId);

      if (pErr || aErr) {
        console.error('âŒ ê³ ê° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', pErr || aErr);
        return;
      }

      // 3) ë³‘í•© + ì¤‘ë³µ ì œê±° + ì—­í•  í‘œì‹œ(ëŒ€í‘œ/ë³´ì¡°)
      const map = new Map();

      (primaryList || []).forEach(c => {
        map.set(c.id, { ...c, role: 'ëŒ€í‘œ' });
      });

      (assigneeList || []).forEach(c => {
        const prev = map.get(c.id);
        // ì¡°ì¸ ê²°ê³¼ì— is_primaryê°€ ìˆì„ ìˆ˜ë„ ìˆê³  ì—†ì„ ìˆ˜ë„ ìˆìŒ â†’ ëŒ€í‘œ ìš°ì„ 
        const role = (c.customer_assignees?.[0]?.is_primary || prev?.role === 'ëŒ€í‘œ') ? 'ëŒ€í‘œ' : 'ë³´ì¡°';
        map.set(c.id, { id: c.id, customer_name: c.customer_name, grade: c.grade, role });
      });

      let customers = Array.from(map.values());

      // 4) ì •ë ¬: A > B > C > F, ê°™ì€ ë“±ê¸‰ì€ ì´ë¦„ ì˜¤ë¦„ì°¨ìˆœ
      const gradeOrder = { ê³„ì•½: 0, A: 1, B: 2, C: 3, F: 4 };
      customers.sort((a, b) => {
        const ga = gradeOrder[a.grade] ?? 99;
        const gb = gradeOrder[b.grade] ?? 99;
        if (ga !== gb) return ga - gb;
        return (a.customer_name || '').localeCompare(b.customer_name || '', 'ko');
        // í•„ìš”ì‹œ localeCompare ë‘ë²ˆì§¸ ì¸ì 'ko'ë¡œ í•œêµ­ì–´ ì •ë ¬
      });

      // 4.5) ê³ ê°ë³„ ë‹¤ë¥¸ ë‹´ë‹¹ì ì´ë¦„ ìˆ˜ì§‘ (ë‹´ë‹¹ìê°€ ì •í™•íˆ 2ëª…ì¼ ë•Œë§Œ í‘œì‹œ)
      const custIds = customers.map(c => c.id);

      // ëª¨ë“  ë°°ì •ì ì¡°íšŒ (ë‚´/ë‚¨ êµ¬ë¶„ ìœ„í•´ staff_profiles.id, name í•„ìš”)
      const { data: assigneesAll, error: assAllErr } = await supabase
        .from('customer_assignees')
        .select('customer_id, staff_profiles!inner(id, name)')
        .in('customer_id', custIds);

      const otherNameMap = new Map();
      if (!assAllErr && assigneesAll) {
        // customer_idë³„ë¡œ ë‹´ë‹¹ì id/name ëª¨ìœ¼ê¸° (ì¤‘ë³µ ì œê±°)
        const byCustomer = new Map();
        assigneesAll.forEach(row => {
          const cid = row.customer_id;
          const sp = row.staff_profiles;
          if (!sp) return;
          if (!byCustomer.has(cid)) byCustomer.set(cid, new Map());
          byCustomer.get(cid).set(sp.id, sp.name);
        });

        // ì •í™•íˆ 2ëª…ì¼ ë•Œ ë‚´ idê°€ ì•„ë‹Œ ì´ë¦„ì„ otherë¡œ ì €ì¥
        byCustomer.forEach((idNameMap, cid) => {
          if (idNameMap.size === 2 && idNameMap.has(myId)) {
            for (const [sid, sname] of idNameMap.entries()) {
              if (sid !== myId) { otherNameMap.set(cid, sname); break; }
            }
          }
        });
      }


      // 5) ë Œë” (ë“±ê¸‰ë³„ ê·¸ë£¹ ì„¹ì…˜ + ì´ë¦„ë§Œ)
      const container = document.getElementById('customer-list');
      if (!container) return;
      container.innerHTML = '';

      if (!customers.length) {
        container.textContent = 'ë“±ë¡ëœ ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤.';
        return;
      }

      // ê³„ì•½/A/B/C/Fë§Œ í‘œì‹œ (FëŠ” ì•„ë˜ì—ì„œ ì ‘ì€ ìƒíƒœë¡œ ë Œë”)
      const filteredCustomers = customers.filter(c =>
        ['ê³„ì•½', 'A', 'B', 'C', 'F'].includes((c.grade || '').toUpperCase())
      );

      // ë“±ê¸‰ ê·¸ë£¹í•‘
      const grouped = filteredCustomers.reduce((acc, c) => {
        const g = (c.grade || 'ë¯¸ë¶„ë¥˜').toUpperCase();
        (acc[g] ||= []).push(c);
        return acc;
      }, {});

      // í‘œì‹œ ìˆœì„œ ê³ ì •: A > B > C > F > ë‚˜ë¨¸ì§€
      const gradeOrderList = ['ê³„ì•½', 'A', 'B', 'C', 'F'];
      const sortedGrades = [
        ...gradeOrderList.filter(g => grouped[g]?.length),
        ...Object.keys(grouped).filter(g => !gradeOrderList.includes(g))
      ];

      // ì„¹ì…˜ë³„ ë Œë” (FëŠ” ê¸°ë³¸ ì ‘í˜)
      sortedGrades.forEach(grade => {
        const list = grouped[grade] || [];
        if (!list.length) return;

        // ë˜í¼(ì„¹ì…˜) ìƒì„±
        const section = document.createElement('div');
        section.className = 'mb-1';
        container.appendChild(section);

        // í—¤ë” (í´ë¦­ìœ¼ë¡œ ì ‘ê¸°/í¼ì¹˜ê¸°)
        const header = document.createElement('div');
        header.className = 'grade-header flex items-center justify-between cursor-pointer select-none';
        const countText = `${grade} (${list.length})`;
        header.innerHTML = `
          <span>${countText}</span>
          <span class="caret text-gray-600 transition-transform duration-200">â–¼</span>
        `;
        section.appendChild(header);

        // ëª©ë¡ ì»¨í…Œì´ë„ˆ
        const listBox = document.createElement('div');
        listBox.className = 'mt-1';
        section.appendChild(listBox);

        // FëŠ” ê¸°ë³¸ ì ‘í˜
        const isF = (grade || '').toUpperCase() === 'F';
        if (isF) {
          listBox.style.display = 'none';
          const caret = header.querySelector('.caret');
          caret.style.transform = 'rotate(-90deg)';
        }

        // ì´ë¦„ë“¤ ë Œë”
        list
          .sort((a, b) => (a.customer_name || '').localeCompare(b.customer_name || '', 'ko'))
          .forEach(cust => {
            const nameBtn = document.createElement('div');
            nameBtn.className = 'name-item';
            const other = otherNameMap.get(cust.id);

            const label = document.createElement('span');
            label.textContent = cust.customer_name || '-';

            const sub = document.createElement('span');
            sub.className = 'mr-1 text-sm text-gray-500';
            sub.textContent = other ? `(${other})` : '';

            nameBtn.append(sub, label);

            // ì ‘ê·¼ì„±: í‚¤ë³´ë“œ ì„ íƒ ì§€ì›
            nameBtn.setAttribute('role', 'button');
            nameBtn.tabIndex = 0;

            nameBtn.addEventListener('click', () => loadCustomerDataByName(cust.customer_name));
            nameBtn.addEventListener('keydown', (e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                loadCustomerDataByName(cust.customer_name);
              }
            });

            listBox.appendChild(nameBtn);
          });

        // í† ê¸€ ë™ì‘
        header.addEventListener('click', () => {
          const visible = listBox.style.display !== 'none';
          listBox.style.display = visible ? 'none' : '';
          const caret = header.querySelector('.caret');
          caret.style.transform = visible ? 'rotate(-90deg)' : 'rotate(0deg)';
        });
      });      
    }

    let buildingMap = new Map();

    // ë§¤ë¬¼ë²ˆí˜¸ ì…ë ¥ì— ë”°ë¼ ë§¤ë¬¼ì •ë³´ í‘œ ëŠ˜ë¦¬ê³  ì¤„ì´ê¸°
    function updateListingsTableByInputs() {
      const listingsBody = document.getElementById('listings-body');
      const allInputs = document.querySelectorAll('input[data-index]');

      // ì…ë ¥ëœ data-index ì¤‘ ìµœëŒ€ê°’ ì°¾ê¸° (ë¹ˆì¹¸ì€ ë¬´ì‹œ)
      let maxIndex = 0;
      allInputs.forEach(input => {
        const val = input.value.trim();
        const idx = parseInt(input.dataset.index);
        if (val !== '' && !isNaN(idx)) {
          maxIndex = Math.max(maxIndex, idx);
        }
      });

      // ê¸°ì¡´ í–‰ ìˆ˜
      const currentRows = listingsBody.children.length;

      // í–‰ì´ ë¶€ì¡±í•˜ë©´ ì¶”ê°€
      for (let i = currentRows + 1; i <= maxIndex; i++) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="p-2 border text-center relative">
            ${i}
            <input type="hidden" data-field="color_${i}" value="">
            <input type="hidden" data-field="strike_${i}" value=""> 
            <button 
              class="color-picker-btn absolute right-1 top-1 w-3 h-3 rounded-full border border-gray-400"
              data-index="${i}"
            ></button>
          </td>
          <td class="p-1 border text-center">
            <span contenteditable="true" class="text-base block" data-field="listing_title_${i}"></span>
          </td>
          <td class="p-1 border text-center">
            <span contenteditable="true" class="text-base block" data-field="full_address_${i}"></span>
          </td>
          <td class="p-1 border text-center">
            <span contenteditable="true" class="text-base block" data-field="deposit_price_${i}"></span>
          </td>
          <td class="p-1 border text-center">
            <span contenteditable="true" class="text-base block" data-field="monthly_rent_${i}"></span>
          </td>
          <td class="p-1 border text-center">
            <span contenteditable="true" class="text-base block" data-field="premium_price_${i}"></span>
          </td>
          <td class="p-1 border text-center">
            <span contenteditable="true" class="text-base block" data-field="area_py_${i}"></span>
          </td>
          <td class="p-1 border text-center">
            <span contenteditable="true" class="text-base block" data-field="description_${i}"></span>
          </td>
        `;

        listingsBody.appendChild(row);
        applyRowStriping(); // â¬… ìƒˆ í–‰ ì¶”ê°€ í›„ì—ë„ ì ìš©
      }

      // í–‰ì´ ë„ˆë¬´ ë§ìœ¼ë©´ ìë¦„
      while (listingsBody.children.length > maxIndex) {
        listingsBody.removeChild(listingsBody.lastChild);
      }

      // â¬‡ï¸ í–‰ ì¦ê° ì´í›„ ê´€ì°° ì¬ì„¤ì • + ìµœì¢… ë™ê¸°í™”
      observeRows();
      syncRowHeights();
    }

    (function setupColumnResizeSync() {
      const box = document.getElementById('white-box');
      const headerRow = document.querySelector('#white-box thead tr');

      if (!headerRow) return;

      const handles = headerRow.querySelectorAll('.resize-handle');

      handles.forEach(handle => {
        let startX = 0;
        let startWidth = 0;
        let th = handle.parentElement;

        handle.addEventListener('mousedown', (e) => {
          e.preventDefault();
          startX = e.clientX;
          startWidth = th.offsetWidth;

          function onMouseMove(ev) {
            const delta = ev.clientX - startX;
            const newWidth = Math.max(40, startWidth + delta);
            th.style.width = newWidth + 'px';

            // í…Œì´ë¸” ì „ì²´ ë„ˆë¹„ ê³„ì‚°
            const table = document.querySelector('#white-box table');
            const tableWidth = table.offsetWidth;

            // white-boxì˜ ì‹ ê·œ width = í…Œì´ë¸”ë„ˆë¹„ + ê¸°ì¡´ ì—¬ë°±
            box.style.width = (tableWidth + whiteBoxExtraGap) + 'px';
          }

          function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);

            // ë¦¬ì‚¬ì´ì¦ˆ ì¢…ë£Œ í›„ ì—¬ë°± ì¬ì¸¡ì •
            const table = document.querySelector('#white-box table');
            const tableWidth = table.offsetWidth;
            const boxWidth = box.offsetWidth;

            whiteBoxExtraGap = boxWidth - tableWidth;
          }

          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      });
    })();

    function showToast(message, duration = 3000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;

      // ìŠ¤íƒ€ì¼ ì§ì ‘ ì§€ì •
      toast.style.backgroundColor = '#F2C130';
      toast.style.color = 'black';
      toast.style.fontWeight = 'bold';
      toast.className = 'fixed top-5 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded shadow-lg z-[9999]';

      toast.classList.remove('hidden');

      setTimeout(() => {
        toast.classList.add('hidden');
      }, duration);
    }

    // ğŸ§­ íŒŒë¹„ì½˜ ì˜† íƒ­ ì œëª© ì—…ë°ì´íŠ¸
    function setDocumentTitle(name) {
      document.title = (name && name.trim()) ? name.trim() : 'ì„ëŒ€ì¶”ì²œ';
    }

    // --- Formatting Helpers ---
    function formatKoreanMoney(value) {
      if (value === null || value === undefined || value === '') return '-';
      const num = Number(value);
      if (isNaN(num)) return '-';
      return num.toLocaleString('ko-KR'); // 1,000 ë‹¨ìœ„ ì½¤ë§ˆ í‘œì‹œ
    }

    // === Listing Title Cleaner ===
    // ê·œì¹™: ê´„í˜¸ ì•ˆì— 'ìˆ«ì'ì™€ 'í˜¸'ê°€ í•¨ê»˜ ìˆìœ¼ë©´ ê·¸ ê´„í˜¸ ë¬¶ìŒë§Œ ì œê±°.
    // ê·¸ ì™¸ì˜ ê´„í˜¸(ì˜ˆ: '(ì „,ì†Œë‹´ìŠ¤ë ˆê¹€ì¹˜ì°Œê°œ)')ëŠ” ìœ ì§€.
    function cleanListingTitle(raw) {
      if (!raw) return '';
      let s = String(raw);

      // ëª¨ë“  ê´„í˜¸ ë¬¶ìŒì„ ìˆœíšŒí•˜ë©´ì„œ, ë‚´ë¶€ì— ìˆ«ì(\d)ì™€ 'í˜¸'ê°€ ëª¨ë‘ ìˆìœ¼ë©´ ì œê±°
      s = s.replace(/\s*\(([^)]*)\)\s*/g, (match, inside) => {
        const hasDigit = /\d/.test(inside);
        const hasHo = /í˜¸/.test(inside);
        // 101~103í˜¸ ê°™ì€ ë²”ìœ„ë„ ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨ë¨(ìˆ«ì+í˜¸)
        return (hasDigit && hasHo) ? '' : ` (${inside.trim()}) `;
      });

      // ë‚¨ì€ ê³µë°±/ì¤‘ë³µ ê³µë°± ì •ë¦¬
      s = s.replace(/\s{2,}/g, ' ').trim();

      // ë¹ˆ ê´„í˜¸ê°€ ë‚¨ì•˜ìœ¼ë©´ ì œê±°
      s = s.replace(/\(\s*\)/g, '').trim();

      return s;
    }
    
    async function preloadBuildingInfo() {
      const { data: buildings, error } = await supabase
        .from('building_info')
        .select('addr_compare, building_name');

      if (!error && buildings) {
        buildingMap = new Map(buildings.map(b => [b.addr_compare, b.building_name]));
        // console.log(`ğŸ¢ building_info ${buildings.length}ê±´ ë¡œë“œ ì™„ë£Œ`);
      } else {
        console.warn('â— building_info ë¡œë”© ì‹¤íŒ¨:', error);
      }
    }

    const leftTbody = document.getElementById('left-tbody');
    for (let i = 1; i <= 50; i++) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="border-b text-right pr-2"> <!-- ì˜¤ë¥¸ìª½ ì •ë ¬ -->
          <input type="text" placeholder="ì…ë ¥ ${i}" 
                class="w-[5rem] border px-2 rounded text-base ml-auto block" 
                data-index="${i}" />
        </td>
      `;
      leftTbody.appendChild(row);
    }


    function addListingRow(i) {
      const row = document.createElement('tr');
      const listingsBody = document.getElementById('listings-body');

      // iê°€ í™€ìˆ˜ë©´ í°ìƒ‰, ì§ìˆ˜ë©´ íšŒìƒ‰
      const bgClass = i % 2 === 0 ? 'bg-gray-50' : 'bg-white';
      row.className = `${bgClass} hover:bg-yellow-50`;

      row.innerHTML = `
        <td class="p-2 border text-center relative">
          ${i}
          <button 
            class="color-picker-btn absolute right-1 top-1 w-3 h-3 rounded-full border border-gray-400"
            data-index="${i}"
          ></button>
        </td>
        <td class="p-2 border text-center"><input type="text" class="w-full text-center text-base border-none bg-transparent outline-none" data-field="listing_title_${i}" /></td>
        <td class="p-2 border text-center"><input type="text" class="w-full text-center text-base border-none bg-transparent outline-none" data-field="full_address_${i}" /></td>
        <td class="p-2 border text-center"><input type="text" class="w-full text-center text-base border-none bg-transparent outline-none" data-field="building_name_${i}" /></td>
        <td class="p-2 border text-center"><input type="text" class="w-full text-center text-base border-none bg-transparent outline-none" data-field="unit_info_${i}" /></td>
        <td class="p-2 border text-center"><input type="text" class="w-full text-center text-base border-none bg-transparent outline-none" data-field="floor_${i}" /></td>
        <td class="p-2 border text-center"><input type="text" class="w-full text-center text-base border-none bg-transparent outline-none" data-field="deposit_price_${i}" /></td>
        <td class="p-2 border text-center"><input type="text" class="w-full text-center text-base border-none bg-transparent outline-none" data-field="monthly_rent_${i}" /></td>
        <td class="p-2 border text-center"><input type="text" class="w-full text-center text-base border-none bg-transparent outline-none" data-field="premium_price_${i}" /></td>
        <td class="p-2 border text-center"><input type="text" class="w-full text-center text-base border-none bg-transparent outline-none" data-field="area_py_${i}" /></td>
      `;

      listingsBody.appendChild(row);
      applyRowStriping(); // â¬… ìƒˆ í–‰ ì¶”ê°€ í›„ì—ë„ ì ìš©
    }

    function applyRowStriping() {
      const rows = document.querySelectorAll('#listings-body tr');

      rows.forEach((row, index) => {

        // ğŸ¯ ì‚¬ìš©ìê°€ ìƒ‰ì„ ì§€ì •í•œ ê²½ìš° â†’ ì¤„ë¬´ëŠ¬ ì ìš© ê¸ˆì§€
        if (row.dataset.userColor === "true") return;

        // ê¸°ì¡´ ì¤„ë¬´ëŠ¬ ì ìš©
        row.classList.remove('bg-white', 'bg-gray-50');
        row.style.backgroundColor = ""; // inline ìƒ‰ ì œê±°
        row.classList.add(index % 2 === 0 ? 'bg-white' : 'bg-gray-50');
      });
    }

    // ë§¤ë¬¼ì •ë³´ ì§€ìš°ëŠ” í•¨ìˆ˜
    function clearListingRow(index) {
      const fields = [
        'listing_title', 'full_address',
        'deposit_price', 'monthly_rent', 'premium_price', 'area_py', 'description'
      ];

      fields.forEach(field => {
        const el = document.querySelector(`[data-field="${field}_${index}"]`);
        if (el) {
          if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
            el.value = '';
          } else {
            el.textContent = '';
          }
        }
      });

      // memoë„ ê°™ì´ ì§€ìš°ê¸°
      const memoEl = document.querySelector(`textarea[data-memo-index="${index}"]`);
      if (memoEl) memoEl.value = '';

      // í–‰ ìƒ‰ìƒ ì´ˆê¸°í™”
      const tr = document.querySelector(`#listings-body tr:nth-child(${index})`);
      if (tr) {
        tr.style.backgroundColor = "";
        tr.dataset.userColor = "";
      }
      setFieldValue("color", index, "");

      syncRowHeights?.();
    }

    async function fetchListingInfo(listingId, rowIndex) {
      const cleanedId = listingId.replace(/[^\d]/g, '');  // ìˆ«ìë§Œ ë‚¨ê¸°ê¸°

      if (!cleanedId) {
        console.warn(`[${rowIndex}] ë§¤ë¬¼ë²ˆí˜¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.`);
        return;
      }

      const numericId = Number(cleanedId.replaceAll(',', '')); // ì‰¼í‘œ ì œê±° + ìˆ«ì ë³€í™˜

      if (isNaN(numericId)) {
        alert(`ìœ íš¨í•œ ìˆ«ì ë§¤ë¬¼ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
        return;
      }

      // Supabase ì¡°íšŒ
      const { data: listing, error: listingError } = await supabase
        .from('baikukdbtest')
        .select('listing_title, full_address, addr_compare, unit_info, floor, deposit_price, monthly_rent, premium_price, area_py')
        .eq('listing_id', numericId)
        .single();

      if (listingError || !listing) {
        console.error(`âŒ [${rowIndex}] ë§¤ë¬¼ ì¡°íšŒ ì‹¤íŒ¨`, listingError);
        showToast(`ë§¤ë¬¼ë²ˆí˜¸ ${listingId} ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        return;
      }

      // 2. ê±´ë¬¼ëª… ë§¤í•‘
      const buildingName = buildingMap.get(listing.addr_compare) ?? '-';

      // 3. í‘œì‹œí•  ë°ì´í„° ì •ë¦¬
      const combinedUnit = combineUnitInfo(buildingName, listing.floor, listing.unit_info);
      const dataToDisplay = {
        listing_title: listing.listing_title,
        full_address: listing.full_address,
        combined_unit: combinedUnit,
        deposit_price: listing.deposit_price,
        monthly_rent: listing.monthly_rent,
        premium_price: listing.premium_price,
        area_py: listing.area_py
      };

      updateListingsTableByInputs();
      
      // 4. DOMì— ì¶œë ¥
      Object.entries(dataToDisplay).forEach(([field, value]) => {
        const selector = `[data-field="${field}_${rowIndex}"]`;
        const el = document.querySelector(selector);
        if (el) {
          const isMoney = ['deposit_price', 'monthly_rent', 'premium_price'].includes(field);
          const formattedValue =
            isMoney
              ? formatKoreanMoney(value)
              : field === 'area_py'
                ? (isNaN(Number(value)) ? '-' : Number(value).toFixed(1))
              : field === 'full_address'
                ? (typeof value === 'string' ? value.split(' ').slice(1).join(' ') : '-')
              : (value ?? '-');

          if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
            el.value = formattedValue;
          } else {
            el.textContent = formattedValue;  // âœ… span íƒœê·¸ìš©
          }
        }
      });

      // âœ… ë†’ì´ ë™ê¸°í™” ì‹¤í–‰
      syncRowHeights();
      applyRowStriping();  // âœ… í–‰ ë°°ê²½ìƒ‰ ë‹¤ì‹œ ì ìš©      
    }


    window.addEventListener('DOMContentLoaded', () => {
      displayTodayDate();
      displayStaffInfo();
      preloadBuildingInfo();
      loadCustomersForCurrentStaff();
      loadCurrentUserStaffInfo(); // ì²«ë¡œë“œì‹œ ë‹´ë‹¹ìì •ë³´ ë³¸ì¸ì •ë³´ í‘œì‹œ
      loadStaffOptions();
      refreshLatestMeta(); // [ADD] ë§¤ë¬¼ì¥ ìµœì‹  ì—…ë°ì´íŠ¸ ì‹œê°„ ê°±ì‹ 
      setupStaffDropdown();

      // â­ staff-dropdown ì„ bodyë¡œ ì´ë™ (ë¶€ëª¨ overflow ì˜í–¥ ì•ˆ ë°›ê²Œ)
      const dropdown = document.getElementById('staff-dropdown');
      if (dropdown && dropdown.parentElement !== document.body) {
        document.body.appendChild(dropdown);
      }

      // === í–‰ ë†’ì´ ë™ê¸°í™”ë¥¼ ìœ„í•œ í–‰ ë‹¨ìœ„ ê´€ì°° ì´ˆê¸°í™” ===
      listingsBody = document.getElementById('listings-body');
      rowObserver = new ResizeObserver(() => {
        // í–‰ í•˜ë‚˜ê°€ ì»¤ì§€ê±°ë‚˜ ì‘ì•„ì§ˆ ë•Œë§ˆë‹¤ ì „ì²´ ë™ê¸°í™” (ê°„ë‹¨/ì•ˆì „)
        syncRowHeights();
      });
      observeRows();   // í˜„ì¬ ìˆëŠ” ëª¨ë“  í–‰ ê´€ì°° ì‹œì‘

      const memoTextarea = document.getElementById('memo-textarea');
      
      document.querySelectorAll('input[data-index]').forEach(input => {
        const index = parseInt(input.dataset.index, 10);

        // ê³µí†µ ì²˜ë¦¬: ì…ë ¥ê°’ì— ë”°ë¼ ì¡°íšŒ
        // - ë¹ˆì¹¸: í–‰ ì´ˆê¸°í™”
        // - ì¤‘ë³µ: ê¸°ì¡´í–‰ì—ì„œ 4ê°œ(ë§¤ë¬¼ëª…/ì£¼ì†Œ/ê±´ë¬¼ì •ë³´/ë‚´ìš©) ë³µì‚¬
        // - ë¹„ì¤‘ë³µ: âš  ë¬´ì¡°ê±´ 'ë‚´ìš©' ë¨¼ì € ë¹„ìš°ê³  â†’ DB ê°’ ë°˜ì˜
        const handleListingInput = async (rowIndex, rawValue) => {
          const value = (rawValue || '').trim();

          if (value === '') {
            clearListingRow(rowIndex);
            const inputEl = document.querySelector(`input[data-index="${rowIndex}"]`);
            if (inputEl) inputEl.dataset.prev = ''; // (ì„ íƒ) ì´ì „ ë²ˆí˜¸ ê¸°ë¡ ì´ˆê¸°í™”
            return;
          }

          // ë™ì¼ ë§¤ë¬¼ë²ˆí˜¸ ê¸°ì¡´ í–‰ ì°¾ê¸° (ë³¸ì¸ í–‰ ì œì™¸)
          const dupeIndex = findRowIndexByListingNumber(value, rowIndex);

          // âœ… ë¹„ì¤‘ë³µì´ë©´ 'ë‚´ìš©'ì„ í•­ìƒ ë¨¼ì € ë¹„ì›€(ìµœì´ˆ ì…ë ¥ í¬í•¨)
          if (!dupeIndex) {
            setFieldValue('description', rowIndex, '');
          }

          // DBì—ì„œ ë§¤ë¬¼ì •ë³´ ì±„ìš°ê¸°(ë³´ì¦ê¸ˆ/ì›”ì„¸/ê¶Œë¦¬ê¸ˆ/í‰ìˆ˜ ë“± ìµœì‹ ê°’)
          await fetchListingInfo(value, rowIndex);

          // âœ… ì¤‘ë³µì´ë©´ ê¸°ì¡´ í–‰ì—ì„œ 4ê°œ í•„ë“œ ë®ì–´ì“°ê¸°
          if (dupeIndex) {
            const dupes = {
              listing_title: getFieldValue('listing_title', dupeIndex),
              full_address:  getFieldValue('full_address',  dupeIndex),
              description:   getFieldValue('description',   dupeIndex),
            };
            setFieldValue('listing_title', rowIndex, dupes.listing_title ?? '');
            setFieldValue('full_address',  rowIndex, dupes.full_address  ?? '');
            setFieldValue('combined_unit', rowIndex, dupes.combined_unit ?? '');
            setFieldValue('description',   rowIndex, dupes.description   ?? '');

            // ë©”ëª¨ë„ ê°™ì´ ë³µì‚¬
            const srcMemo = getMemoValue(dupeIndex);
            const destMemoEl = document.querySelector(`textarea[data-memo-index="${rowIndex}"]`);
            if (destMemoEl) destMemoEl.value = srcMemo ?? '';

            showToast('ê¸°ì¡´ í–‰ì„ ë³µì‚¬');
          }
          highlightDuplicateListingNumbers();
        };
    
        // ë‹¨ì¼ ë³€ê²½
        input.addEventListener('change', async (e) => {
          await handleListingInput(index, e.target.value);
        });

        // Enterë¡œ í™•ì •
        input.addEventListener('keydown', async (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            await handleListingInput(index, e.target.value);

            // ë‹¤ìŒ ì¹¸ìœ¼ë¡œ í¬ì»¤ìŠ¤
            const nextInput = document.querySelector(`input[data-index="${index + 1}"]`);
            if (nextInput) nextInput.focus();
          }
        });

        // ì—¬ëŸ¬ ê°œ ë¶™ì—¬ë„£ê¸° (ì„¸ë¡œ/ê°€ë¡œ/ì‰¼í‘œ/ê³µë°± êµ¬ë¶„)
        input.addEventListener('paste', async (e) => {
          e.preventDefault();
          const pasteText = (e.clipboardData || window.clipboardData).getData('text');
          const values = pasteText
            .split(/[\s,\n]+/)
            .map(str => str.trim())
            .filter(Boolean);

          // ìˆœì„œëŒ€ë¡œ ì±„ìš°ë©° ê° ì¹¸ ì²˜ë¦¬
          for (let offset = 0; offset < values.length; offset++) {
            const targetIndex = index + offset;
            const targetInput = document.querySelector(`input[data-index="${targetIndex}"]`);
            if (!targetInput) break;

            targetInput.value = values[offset];

            // ê° ì¹¸ ì²˜ë¦¬ ì‹œì—ë„ ë™ì¼ ë§¤ë¬¼ë²ˆí˜¸ë¼ë©´ 'ë‚´ìš©' ë³µì‚¬
            await handleListingInput(targetIndex, values[offset]);
          }

          // ë¶™ì—¬ë„£ê¸° ëë‚˜ë©´ ë§ˆì§€ë§‰ ì¹¸ ë‹¤ìŒìœ¼ë¡œ í¬ì»¤ìŠ¤
          const lastIndex = index + values.length;
          const nextInput = document.querySelector(`input[data-index="${lastIndex}"]`);
          if (nextInput) nextInput.focus();
        });
      });

      // âœ… ì—´ ë¦¬ì‚¬ì´ì¦ˆ
      let startX, startWidth, resizableTh;
      document.querySelectorAll('.resize-handle').forEach(h => {
        h.addEventListener('mousedown', e => {
          resizableTh = e.target.closest('th');
          startX = e.clientX;
          startWidth = resizableTh.offsetWidth;

          document.addEventListener('mousemove', resizeColumn);
          document.addEventListener('mouseup', stopResize);
        });
      });
      function resizeColumn(e) {
        if (!resizableTh) return;
        const newWidth = startWidth + (e.clientX - startX);
        resizableTh.style.width = newWidth + 'px';
      }
      function stopResize() {
        document.removeEventListener('mousemove', resizeColumn);
        document.removeEventListener('mouseup', stopResize);
        resizableTh = null;
      }

      syncRowHeights?.();

      // ì „ì²´ì„ íƒ: 'ë§¤ë¬¼ë²ˆí˜¸'ë§Œ (ì™¼ìª½ input[data-index])
      document.addEventListener('focusin', (e) => {
        const t = e.target;
        if (t.matches('input[data-index]')) {
          // iOS/Safari ì¼ë¶€ ì´ìŠˆ ë°©ì§€ìš©
          setTimeout(() => {
            try { t.select(); } catch (_) {}
          }, 0);
        }
      });

      // === 'ë§¤ë¬¼ë²ˆí˜¸' ì¼ê´„ ì§€ìš°ê¸° ë²„íŠ¼ ===
      document.getElementById('clear-left-btn')?.addEventListener('click', () => {
        const inputs = document.querySelectorAll('input[data-index]');
        let touched = 0;
        inputs.forEach(inp => {
          if (inp.value && inp.value.trim() !== '') {
            inp.value = '';
            // ê¸°ì¡´ change í•¸ë“¤ëŸ¬ê°€ clearListingRow(index)ë¥¼ í˜¸ì¶œí•˜ë„ë¡ ì´ë²¤íŠ¸ ë°œìƒ
            inp.dispatchEvent(new Event('change'));
            touched++;
          }
        });
        showToast(touched > 0 ? 'ë§¤ë¬¼ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì§€ì› ìŠµë‹ˆë‹¤.' : 'ì§€ìš¸ ë§¤ë¬¼ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
      });

      // ìµœì´ˆ ì§„ì… ì‹œì—ë„ ë©”ëª¨ 50ì¤„ í‘œì‹œ
      renderMemoPanel([]);
    });

    

    // ğŸ‘‰ ì°½ ë¦¬ì‚¬ì´ì¦ˆ ì‹œì—ë„ ë†’ì´ ë™ê¸°í™”
    window.addEventListener('resize', syncRowHeights);

    function syncRowHeights() {
      const rightRows = document.querySelectorAll('#listings-body tr');
      const leftRows  = document.querySelectorAll('#left-tbody tr');

      const len = Math.min(rightRows.length, leftRows.length);
      for (let i = 0; i < len; i++) {
        const r = rightRows[i];
        const l = leftRows[i];
        if (!r || !l) continue;

        // ë†’ì´ ì¬ì„¤ì •
        l.style.height = 'auto';
        r.style.height = 'auto';

        const lh = l.getBoundingClientRect().height;
        const rh = r.getBoundingClientRect().height;

        const max = Math.max(lh, rh);

        // âœ… ì˜¤ë¥¸ìª½ì´ ë” ì‘ìœ¼ë©´ ì˜¤ë¥¸ìª½ì— ë†’ì´ ê³ ì • (ì™¼ìª½ì´ ê¸°ì¤€)
        if (rh < lh) r.style.height = `${lh}px`;

        // âœ… ì™¼ìª½ì€ í•­ìƒ ì˜¤ë¥¸ìª½ ë†’ì´ë¡œ ë§ì¶¤
        l.style.height = `${Math.max(lh, rh)}px`;
      }
      syncMemoRowHeights();
    }

    function syncMemoRowHeights() {
      const listingRows = document.querySelectorAll('#listings-body tr');
      const memoRows    = document.querySelectorAll('#memo-body tr');

      const count = Math.min(listingRows.length, memoRows.length);
      for (let i = 0; i < count; i++) {
        const h  = listingRows[i].offsetHeight; // ë§¤ë¬¼ í–‰ì˜ "ìµœì¢… ì´ë†’ì´"(íŒ¨ë”©/ë³´ë” ë°˜ì˜, ì •ìˆ˜ px)
        const td = memoRows[i].querySelector('td');
        if (!td) continue;

        // TD ìì²´ë¥¼ ë™ì¼ ë†’ì´ë¡œ ê³ ì •
        td.style.height = `${h}px`;

        // ë‚´ë¶€ textareaê°€ TDë¥¼ ê½‰ ì±„ìš°ê²Œ
        const ta = td.querySelector('textarea');
        if (ta) {
          ta.style.height   = '100%';
          ta.style.maxHeight = 'none';
        }
      }
    }

    const allInputs = document.querySelectorAll('input[data-index]');

    const inputTopRow = document.getElementById('top-row-input'); // ì†ë‹˜ì´ë¦„ ì…ë ¥ì°½

    // ê±´ë¬¼ì •ë³´, í˜¸ìˆ˜, ì¸µ í•˜ë‚˜ë¡œ í•©ì¹˜ëŠ” í•¨ìˆ˜
    function combineUnitInfo(buildingName, floor, unitInfo) {
      const parts = [];

      if (buildingName && buildingName !== '-') {
        parts.push(buildingName);
      }

      if (floor && floor !== '-') {
        const floorStr = String(floor);
        parts.push(floorStr.endsWith('ì¸µ') ? floorStr : floorStr + 'ì¸µ');
      }
        
      if (unitInfo && unitInfo !== '-') {
        const unitStr = String(unitInfo).trim();
        const endsWithHo = unitStr.endsWith('í˜¸');
        const endsWithIlbu = unitStr.endsWith('ì¼ë¶€');
        const containsJeonche = unitStr.includes('ì „ì²´');

        const displayUnit = (endsWithHo || endsWithIlbu || containsJeonche)
          ? unitStr
          : unitStr + 'í˜¸';

        parts.push(displayUnit);
      }

      return parts.join(' ');
    }

    // ì´ë¯¸ì§€ ì˜† ì˜¤ëŠ˜ ë‚ ì§œ ì¶œë ¥
    function displayTodayDate() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');

      const dateStr = `${yyyy}-${mm}-${dd}`; // ì˜ˆ: 2025-08-04
      const dateEl = document.getElementById('today-date');
      if (dateEl) dateEl.textContent = dateStr;
    }

    // ì´ë¯¸ì§€ ì˜† ë‹´ë‹¹ì ì •ë³´ ì¶œë ¥
    async function displayStaffInfo() {
      const { data: { user }, error: userError } = await supabase.auth.getUser();

      if (userError || !user) {
        console.warn('âŒ ë¡œê·¸ì¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', userError);
        return;
      }

      const { data: staff, error: staffError } = await supabase
        .from('staff_profiles')
        .select('position, name, phone_num')
        .eq('user_id', user.id)
        .maybeSingle();

      if (staffError || !staff) {
        console.warn('âŒ staff_profiles ì¡°íšŒ ì‹¤íŒ¨:', staffError);
        return;
      }

      const text = `${staff.position} ${staff.name} ${staff.phone_num}`;
      const el = document.getElementById('staff-info');
      if (el) el.textContent = text;
    }

    // === ì†ë‹˜ ì‚­ì œ ë²„íŠ¼ ===
    document.getElementById('delete-customer')?.addEventListener('click', async () => {
      try {
        if (!currentCustomerId) { showToast('ë¨¼ì € ê³ ê°ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

        // ê¶Œí•œ ì²´í¬: ëŒ€í‘œ/ë³´ì¡°ë§Œ ì‚­ì œ ê°€ëŠ¥
        if (!(await isMyAssignedCustomer(currentCustomerId))) {
          showToast('ë‹´ë‹¹ìê°€ ì•„ë‹Œ ê³ ê°ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        const name = (document.getElementById('top-row-input')?.value || '').trim();
        const ok = confirm(`ì •ë§ë¡œ "${name || 'ì´ ê³ ê°'}"ì„(ë¥¼) ì‚­ì œí• ê¹Œìš”?\nì¶”ì²œ ë§¤ë¬¼/ë‹´ë‹¹ ë°°ì • ë“± ê´€ë ¨ ë°ì´í„°ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`);
        if (!ok) return;

        // 1) ì—°ê´€ ë°ì´í„°ë¶€í„° ì‚­ì œ (FK ì¶©ëŒ ë°©ì§€)
        const { error: recErr } = await supabase
          .from('customers_recommendations')
          .delete()
          .eq('customers_id', String(currentCustomerId)); // text ì»¬ëŸ¼ì´ë¼ ë¬¸ìì—´ ë¹„êµ

        if (recErr) {
          console.error('ì¶”ì²œë§¤ë¬¼ ì‚­ì œ ì‹¤íŒ¨:', recErr);
          showToast('ì¶”ì²œ ë§¤ë¬¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          return;
        }

        const { error: assErr } = await supabase
          .from('customer_assignees')
          .delete()
          .eq('customer_id', currentCustomerId);

        if (assErr) {
          console.error('ë‹´ë‹¹ ë°°ì • ì‚­ì œ ì‹¤íŒ¨:', assErr);
          showToast('ë‹´ë‹¹ ë°°ì • ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          return;
        }

        // 2) ê³ ê° ì‚­ì œ
        const { error: custErr } = await supabase
          .from('customers')
          .delete()
          .eq('id', currentCustomerId);

        if (custErr) {
          console.error('ê³ ê° ì‚­ì œ ì‹¤íŒ¨:', custErr);
          showToast('ê³ ê° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          return;
        }

        // 3) UI ì´ˆê¸°í™”
        currentCustomerId = null;

        // ì…ë ¥ê°’ë“¤ ì´ˆê¸°í™”
        document.getElementById('top-row-input').value = '';
        document.getElementById('customer-phone').value = '';
        document.getElementById('customer-grade').value = 'F';
        document.getElementById('memo-textarea').value = '';

        setDocumentTitle('');

        // ì™¼ìª½ ë§¤ë¬¼ë²ˆí˜¸ ì „ì²´ ë¹„ìš°ê¸°(+change ë””ìŠ¤íŒ¨ì¹˜ë¡œ ì˜¤ë¥¸ìª½ë„ ì •ë¦¬)
        document.querySelectorAll('input[data-index]').forEach(inp => {
          if (inp.value && inp.value.trim() !== '') {
            inp.value = '';
            inp.dispatchEvent(new Event('change'));
          }
        });

        // ì˜¤ë¥¸ìª½ í‘œ ê°•ì œ ì´ˆê¸°í™”(ë³´í˜¸ì )
        const listingsBodyEl = document.getElementById('listings-body');
        if (listingsBodyEl) listingsBodyEl.innerHTML = '';

        // (ì¶”ê°€) ë©”ëª¨ íŒ¨ë„ ë¹„ìš°ê¸°
        const memoBody = document.getElementById('memo-body'); 
        if (memoBody) memoBody.innerHTML = '';

        // ì§ì› í‘œì‹œ/ì„ íƒ UI ì •ë¦¬
        document.getElementById('staff-info')?.classList.add('hidden');
        document.getElementById('staff-select')?.classList.add('hidden');

        // ì™¼ìª½ ê³ ê° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        loadCustomersForCurrentStaff?.();

        showToast('ê³ ê°ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.');
      } catch (e) {
        console.error('ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸:', e);
        showToast('ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
      
      loadCustomersForCurrentStaff();
    });

     // âœ… ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('copy-link-btn')?.addEventListener('click', () => {
      const text = buildAllMessages();
      if (!text) {
        showToast('ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      copyToClipboard(text);
    });

    let wasEditModeForPrint = false;
    let portalEl = null;

    function buildPrintPortal() {
      // ê¸°ì¡´ í¬í„¸ ì œê±°
      portalEl?.remove();

      // white-box ì „ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ ë³€ê²½
      const src = document.getElementById("white-box");
      if (!src) return;

      // ì¸ì‡„ìš© í¬í„¸ ìƒì„±
      portalEl = document.createElement("div");
      portalEl.id = "print-portal";
      portalEl.style.margin = "0";
      portalEl.style.padding = "0";

      // white-box ì „ì²´ ë³µì œ(ìì‹ + ìŠ¤íƒ€ì¼ í¬í•¨)
      const cloned = src.cloneNode(true);

      // ì¸ì‡„ìš©ì—ì„œ ë¶ˆí•„ìš”í•œ ìš”ì†Œ ì œê±° (ì˜¤ë¥¸ìª½ resize handle ë“±)
      const resizeHandle = cloned.querySelector("#whitebox-resize-handle");
      if (resizeHandle) resizeHandle.remove();

      // white-boxì˜ ì‹¤ì œ width ìœ ì§€
      const originalWidth = src.offsetWidth;
      cloned.style.width = originalWidth + "px";

      // ì¸ì‡„ìš© top-position, absolute ë“± ì´ˆê¸°í™”(ì¸ì‡„ ì‹œ ííŠ¸ëŸ¬ì§ ë°©ì§€)
      cloned.style.position = "static";
      cloned.style.left = "0";
      cloned.style.top = "0";
      cloned.style.margin = "0";

      // print-portalì— ë„£ê¸°
      portalEl.appendChild(cloned);
      document.body.appendChild(portalEl);

      // â˜… ì¸ì‡„ìš© í…Œì´ë¸”ì˜ í–‰ ë°°ê²½ìƒ‰ì„ ê°•ì œë¡œ inline style ë¡œ ê³ ì • â˜…
      const trs = cloned.querySelectorAll("tbody tr");
      trs.forEach((tr) => {
        const color = tr.style.backgroundColor;
        if (color) {
          tr.style.setProperty("background-color", color, "important");
        }
      });
    }

    function cleanupPrintPortal() {
      // í¬í„¸ ì œê±°
      portalEl?.remove();
      portalEl = null;

      // ì¤„ë¬´ëŠ¬/ë†’ì´ ë‹¤ì‹œ ë§ì¶¤(ë³´í˜¸ì  í˜¸ì¶œ)
      applyRowStriping?.();
      syncRowHeights?.();
    }

    window.addEventListener('beforeprint', buildPrintPortal);
    window.addEventListener('afterprint', cleanupPrintPortal);

    // ì„¸ë¡œì¸ì‡„
    document.getElementById('print-btn')?.addEventListener('click', () => {
      buildPrintPortal();   // í˜¹ì‹œ beforeprint ëª» ë°›ëŠ” ë¸Œë¼ìš°ì € ë³´ì •
      window.print();
      // ì¼ë¶€ ë¸Œë¼ìš°ì € ë³´ì •
      setTimeout(cleanupPrintPortal, 0);
    });

    // ê°€ë¡œì¸ì‡„
    document.getElementById('print-btn2')?.addEventListener('click', () => {
      // 1) A4 ê°€ë¡œ ìŠ¤íƒ€ì¼ ì£¼ì…
      const style = document.createElement("style");
      style.id = "landscape-style";
      style.innerHTML = `
        @media print {
          @page { size: A4 landscape; margin: 12mm; }
        }
      `;
      document.head.appendChild(style);

      // 2) í¬í„¸ ìƒì„± â†’ ì¸ì‡„ ì‹¤í–‰
      buildPrintPortal();
      window.print();

      // 3) ì¸ì‡„ í›„ ê°€ë¡œ ìŠ¤íƒ€ì¼ ì œê±° + cleanup
      setTimeout(() => {
        document.getElementById("landscape-style")?.remove();
        cleanupPrintPortal();
      }, 100);
    });

    // â­ ì €ì¥ ë²„íŠ¼ (ì‹ ê·œ + ê¸°ì¡´ í†µí•© ì €ì¥)
    document.getElementById('save-new-customer').addEventListener('click', async () => {
        const name  = document.getElementById('top-row-input').value.trim();
        const phone = document.getElementById('customer-phone').value.trim();
        const grade = document.getElementById('customer-grade').value.trim();
        const memo  = document.getElementById('memo-textarea').value.trim();
        
        const floor_min = Number(document.getElementById("floor-min").value) || null;
        const floor_max = Number(document.getElementById("floor-max").value) || null;
        const area_min = Number(document.getElementById("area-min").value) || null;
        const area_max = Number(document.getElementById("area-max").value) || null;
        const deposit_min = Number(document.getElementById("deposit-min").value) || null;
        const deposit_max = Number(document.getElementById("deposit-max").value) || null;
        const rent_min = Number(document.getElementById("rent-min").value) || null;
        const rent_max = Number(document.getElementById("rent-max").value) || null;
        const rent_per_py_min = Number(document.getElementById("rent-per-py-min").value) || null;
        const rent_per_py_max = Number(document.getElementById("rent-per-py-max").value) || null;
        const premium_min = Number(document.getElementById("premium-min").value) || null;
        const premium_max = Number(document.getElementById("premium-max").value) || null;
        const sale_min = Number(document.getElementById("sale-min").value) || null;
        const sale_max = Number(document.getElementById("sale-max").value) || null;
        const total_deposit_min = Number(document.getElementById("total-deposit-min").value) || null;
        const total_deposit_max = Number(document.getElementById("total-deposit-max").value) || null;
        const total_rent_min = Number(document.getElementById("total-rent-min").value) || null;
        const total_rent_max = Number(document.getElementById("total-rent-max").value) || null;
        const roi_min = Number(document.getElementById("roi-min").value) || null;
        const roi_max = Number(document.getElementById("roi-max").value) || null;

        if (!name) {
        showToast("ê³ ê° ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
        }

        let myStaffId = await getMyStaffId();
        if (!myStaffId) {
        showToast("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        return;
        }

        // ğŸ”´ ì—¬ê¸°ì„œ í•œ ë²ˆ ë” ìƒ‰ì¹  & ì¤‘ë³µ ì—¬ë¶€ ê²€ì‚¬
        highlightDuplicateListingNumbers();
        if (hasDuplicateListingNumbers()) {
        alert("ê°™ì€ ë§¤ë¬¼ë²ˆí˜¸ê°€ 2ê°œ ì´ìƒ ìˆìŠµë‹ˆë‹¤.\nì¤‘ë³µì„ ë¨¼ì € ì •ë¦¬í•œ ë’¤ ë‹¤ì‹œ ì €ì¥í•´ì£¼ì„¸ìš”.");
        return;
        }

        let isNewCustomer = !currentCustomerId; // ì‹ ê·œ ëª¨ë“œ íŒë‹¨

        // ==================================================
        // 1) ì‹ ê·œ ê³ ê°ì¸ ê²½ìš° â†’ INSERT
        // ==================================================
        if (isNewCustomer) {
        // ê°™ì€ ì´ë¦„ì´ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
        const { data: same, error: sameErr } = await supabase
            .from("customers")
            .select("id")
            .eq("customer_name", name)
            .maybeSingle();

        if (same) {
            showToast("ë™ì¼í•œ ì´ë¦„ì˜ ê³ ê°ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ì´ë¦„ì„ ë³€ê²½í•´ì£¼ì„¸ìš”.");
            return;
        }

        // ì‹ ê·œ ê³ ê° INSERT
        const { data: inserted, error: insertErr } = await supabase
            .from("customers")
            .insert({
                customer_name: name,
                customer_phone_number: phone,
                grade: grade,
                memo: memo,
                staff_profiles_id: selectedStaffId ?? myStaffId,
                floor_min, floor_max,
                area_min, area_max,
                deposit_min, deposit_max,
                rent_min, rent_max,
                rent_per_py_min, rent_per_py_max,
                premium_min, premium_max,
                sale_min, sale_max,
                total_deposit_min, total_deposit_max,
                total_rent_min, total_rent_max,
                roi_min, roi_max
            })
            .select()
            .single();

        if (insertErr || !inserted) {
            console.error(insertErr);
            showToast("ì‹ ê·œ ê³ ê° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            return;
        }

        currentCustomerId = inserted.id; // ì‹ ê·œ ê³ ê° ID ì €ì¥
        showToast("ì‹ ê·œ ê³ ê°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
        } 
        // ==================================================
        // 2) ê¸°ì¡´ ê³ ê° ìˆ˜ì • ëª¨ë“œ â†’ UPDATE
        // ==================================================
        else {
        const { error: updateErr } = await supabase
            .from("customers")
            .update({
            customer_name: name,
            customer_phone_number: phone,
            grade: grade,
            memo: memo,
            floor_min, floor_max,
            area_min, area_max,
            deposit_min, deposit_max,
            rent_min, rent_max,
            rent_per_py_min, rent_per_py_max,
            premium_min, premium_max,
            sale_min, sale_max,
            total_deposit_min, total_deposit_max,
            total_rent_min, total_rent_max,
            roi_min, roi_max
            })
            .eq("id", currentCustomerId);

        if (updateErr) {
            console.error(updateErr);
            showToast("ê³ ê° ì •ë³´ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            return;
        }
        }

        // ==================================================
        // 3) ë§¤ë¬¼ ì •ë³´ ì €ì¥ (ì‹ ê·œ/ê¸°ì¡´ ê³µí†µ)
        // ==================================================

        const saved = await saveListingsForCurrentCustomer();
        if (!saved) {
        showToast("ë§¤ë¬¼ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        return;
        }

        showToast("ì €ì¥ ì™„ë£Œ!");

        // ì €ì¥ í›„ ê³ ê° ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
        loadCustomersForCurrentStaff();
    });

    // â­ ì‹ ê·œ ê³ ê° ë²„íŠ¼ ê¸°ëŠ¥
    document.getElementById('new-customer-btn')?.addEventListener('click', () => {
      // 1) í˜„ì¬ ì„ íƒ ê³ ê° ì´ˆê¸°í™”
      currentCustomerId = null;

      // 2) ì˜¤ë¥¸ìª½ ê³ ê° ì…ë ¥ì¹¸ ì´ˆê¸°í™”
      document.getElementById('top-row-input').value = '';
      document.getElementById('customer-phone').value = '';
      document.getElementById('customer-grade').value = 'A';
      document.getElementById('memo-textarea').value = '';

      // 3) ë¬¸ì„œ ì œëª© ì´ˆê¸°í™”
      setDocumentTitle('');

      // 4) ë§¤ë¬¼ë²ˆí˜¸ ëª¨ë‘ ì§€ìš°ê¸° (ì›ë˜ ìˆë˜ ì´ë²¤íŠ¸ê°€ ì•Œì•„ì„œ ì˜¤ë¥¸ìª½ í‘œë„ ì§€ì›€)
      document.querySelectorAll('input[data-index]').forEach(inp => {
        inp.value = '';
        inp.dispatchEvent(new Event('change'));
      });

      // 5) ë©”ëª¨ íŒ¨ë„ ì´ˆê¸°í™”
      renderMemoPanel([]);

      // 6) ë‹´ë‹¹ì ì •ë³´ í‘œì‹œ
      loadCurrentUserStaffInfo();

      showToast('ì‹ ê·œ ê³ ê° ì‘ì„± ëª¨ë“œì…ë‹ˆë‹¤.');
    });
    
    // === ìˆ«ìì—´ í´ë¦­ ì‹œ í–‰ ê°•ì¡° ê¸°ëŠ¥ ===
    function enableRowHighlight() {
      const tbody = document.getElementById("listings-body");
      if (!tbody) return;
    }

    // í˜ì´ì§€ ë¡œë”© í›„ ê¸°ëŠ¥ í™œì„±í™”
    document.addEventListener("DOMContentLoaded", enableRowHighlight);

    // === í–‰ ìƒ‰ìƒ ì„ íƒ ê¸°ëŠ¥ ===
    document.addEventListener("DOMContentLoaded", () => {
      const popup = document.getElementById("color-picker-popup");
      let currentRow = null;

      // íŒì—… ë‹«ê¸°
      document.addEventListener("click", (e) => {
        if (!popup.contains(e.target) && !e.target.classList.contains("color-picker-btn")) {
          popup.classList.add("hidden");
        }
      });

      // ìˆ«ìì…€ ì „ì²´ í´ë¦­ â†’ ìƒ‰ìƒ íŒì—… ì—´ê¸°
      document.addEventListener("click", (e) => {
        const td = e.target.closest("td");
        if (!td) return;

        // listings-body ì•ˆì˜ trì¸ì§€ í™•ì¸
        const tr = td.closest("#listings-body tr");
        if (!tr) return;

        // ì²« ë²ˆì§¸ ì¹¸(ìˆ«ì ì…€)ì¸ì§€ í™•ì¸
        const isFirstCell = [...tr.children].indexOf(td) === 0;
        if (!isFirstCell) return;

        const index = [...tr.parentNode.children].indexOf(tr) + 1;

        // íŒì—… ìœ„ì¹˜ = ì…€ ê¸°ì¤€ìœ¼ë¡œ í‘œì‹œ
        const rect = td.getBoundingClientRect();
        popup.style.left = rect.left + window.scrollX + "px";
        popup.style.top = rect.bottom + window.scrollY + "px";
        popup.classList.remove("hidden");

        currentRow = tr;
      });

      // ìƒ‰ìƒ ì„ íƒ ì‹œ í–‰ì— ì ìš©
      document.querySelectorAll(".color-option").forEach(option => {
        const color = option.dataset.color;
        option.style.backgroundColor = color;
        option.style.border = "1px solid #ccc";
        option.addEventListener("click", () => {
          if (!currentRow) return;

          const color = option.dataset.color;

          // === ì·¨ì†Œì„  ê¸°ëŠ¥ ì¶”ê°€ ===
          if (color === "strike") {
            const index = [...currentRow.parentNode.children].indexOf(currentRow) + 1;

            // ğŸ”¥ í† ê¸€ ë°©ì‹: ì·¨ì†Œì„ ì´ ìˆìœ¼ë©´ ì œê±°, ì—†ìœ¼ë©´ ì¶”ê°€
            const alreadyStriked = currentRow.classList.contains("line-through");

            if (alreadyStriked) {
              currentRow.classList.remove("line-through");
              setFieldValue("strike", index, "");      // DB ì €ì¥ìš© hidden input
            } else {
              currentRow.classList.add("line-through");
              setFieldValue("strike", index, "1");   // DB ì €ì¥ìš© hidden input
            }

            popup.classList.add("hidden");
            return;
          }

          // === ê¸°ì¡´ ìƒ‰ìƒ í•´ì œ ì²˜ë¦¬ ===
          if (color === "none") {
            currentRow.style.backgroundColor = "";
            currentRow.dataset.userColor = "";

            const index = [...currentRow.parentNode.children].indexOf(currentRow) + 1;
            setFieldValue("color", index, "");    // ğŸ”¥ ìƒ‰ìƒë„ ë¹„ìš°ê¸°

            popup.classList.add("hidden");
            return;
          }

          // === ê¸°ì¡´ ìƒ‰ìƒ ì„ íƒ ë¡œì§ ===
          currentRow.dataset.userColor = "true";
          currentRow.classList.remove('bg-white', 'bg-gray-50');
          currentRow.style.backgroundColor = color;

          const index = [...currentRow.parentNode.children].indexOf(currentRow) + 1;
          setFieldValue("color", index, color);

          popup.classList.add("hidden");
        });
      });
    });
    
    (function applyColorOptions() {
      const options = document.querySelectorAll(".color-option");
      options.forEach(opt => {
        const color = opt.dataset.color;
        opt.style.setProperty("background-color", color, "important");
      });
    })();

    // === ìƒ‰ìƒ ì„ íƒì°½ì˜ ìƒ‰ìƒ ë°•ìŠ¤ì— ë°°ê²½ìƒ‰ ë„£ê¸° ===
    (function applyColorPreviewColors() {
      const options = document.querySelectorAll(".color-option");
      options.forEach(opt => {
        const color = opt.dataset.color;
        if (color) {
          opt.style.backgroundColor = color;
          opt.style.border = "1px solid #ccc";
        }
      });
    })();

  </script>

  <!-- === [ì €ì¥ ê°œì„ ] ë‹¨ìˆœ ë®ì–´ì“°ê¸° ëª¨ë‹¬ === -->
  <div id="dup-customer-modal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-[9999]">
    <div class="bg-white w-[440px] max-w-[92vw] rounded-2xl shadow-2xl overflow-hidden">
      <div class="px-5 py-3 border-b font-semibold text-lg">
        ê°™ì€ ì´ë¦„ì˜ ê³ ê°ì´ ì´ë¯¸ ìˆìŠµë‹ˆë‹¤
      </div>
      <div class="p-5 space-y-3 max-h-[60vh] overflow-auto">
        <p class="text-sm text-gray-700">
          í˜„ì¬ ì…ë ¥í•œ ë‚´ìš©ìœ¼ë¡œ <b>ê¸°ì¡´ ê³ ê° ì •ë³´ë¥¼ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?</b>
        </p>
        <!-- ì„ íƒ ë¦¬ìŠ¤íŠ¸ëŠ” ì‚¬ìš© ì•ˆí•¨ -->
      </div>
      <div class="px-5 py-4 border-t flex items-center gap-2 justify-end bg-gray-50">
        <button id="dup-overwrite" class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold">
          ë®ì–´ì“°ê¸°
        </button>
        <button id="dup-cancel" class="px-3 py-2 rounded-xl text-gray-600 hover:bg-gray-200 text-sm">
          ì·¨ì†Œ
        </button>
      </div>
    </div>
  </div>
  <div id="color-picker-popup" 
      class="fixed bg-white shadow-lg rounded-lg p-2 border hidden z-[9999] w-[15rem]">
    <div class="flex gap-2">
      <div class="color-option w-6 h-6 rounded cursor-pointer" data-color="none" style="background: repeating-linear-gradient(
        45deg,
        #fff,
        #fff 5px,
        #ccc 5px,
        #ccc 10px
      );"></div>
      <div class="color-option w-6 h-6 rounded cursor-pointer" data-color="#ffecec"></div>
      <div class="color-option w-6 h-6 rounded cursor-pointer" data-color="#fff7d4"></div>
      <div class="color-option w-6 h-6 rounded cursor-pointer" data-color="#eaffea"></div>
      <div class="color-option w-6 h-6 rounded cursor-pointer" data-color="#e9f3ff"></div>
      <div class="color-option w-6 h-6 rounded cursor-pointer" data-color="#f3e9ff"></div>
      <div class="color-option w-6 h-6 rounded cursor-pointer" data-color="#e5e7eb"></div>
      <div class="color-option w-6 h-6 rounded cursor-pointer flex items-center justify-center"
          data-color="strike"
          style="font-size: 18px; font-weight: bold; line-height: 1;">
        -
      </div>
    </div>
  </div>
</body>
</html>
