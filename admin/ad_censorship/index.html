<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>매출</title>
  <link rel="icon" type="image/png" href="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/pabicon-baikuk-simbol.png" />
  <link rel="preconnect" href="https://sfinbtiqlfnaaarziixu.supabase.co" crossorigin>
  <link rel="dns-prefetch" href="//sfinbtiqlfnaaarziixu.supabase.co">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- [ADD] 직원 리스트용 간단 스타일 -->
  <style>
    .shadow-right { box-shadow: 8px 0 12px -4px rgba(0, 0, 0, 0.08); }
    .grade-header {
      background-color: #e5e7eb;
      color: #111827;
      font-weight: 700;
      padding: 0.5rem;
      border-radius: 0.25rem;
      margin-top: 0.5rem;
      user-select: none;
    }
    .name-item {
      font-size: 0.9rem;
      color: #374151;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      cursor: pointer;
      margin-bottom: 0.4rem;
    }
    .name-item:hover { background-color: #fef9c3; }
  </style>
</head>
<body class="w-screen overflow-x-hidden">
  <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-[9999] hidden">
    메시지 영역
  </div>
  <div class="absolute top-0 left-0 z-[9998] bg-white w-[13rem] h-[60px] rounded-xl">
    <img src="https://github.com/mhale45/image/raw/main/map/%EB%B0%B1%EC%96%B5%EA%B3%B5%EC%9D%B8%EC%A4%91%EA%B0%9C%EC%82%AC%EC%82%AC%EB%AC%B4%EC%86%8C%20%EA%B8%80%EC%94%80%EB%A7%8C.png"
        alt="글씨로고"
        class="absolute h-11 w-auto cursor-pointer top-2 left-2 z-[9999]"
        onclick="location.reload()" />
  </div>
  <div class="flex min-h-screen">
    <div class="w-[6%] pt-[5rem] shadow-right text-center bg-white">
      <a href="/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">백억지도</div></a>
      <a href="/admin/listings/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">매물장부</div></a>
      <a href="/admin/recommend_imDae/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">임대추천</div></a>
      <a href="/admin/recommend_maeMae/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">매매추천</div></a>
      <a href="/admin/customer_manage/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">모든고객</div></a>
      <a href="/admin/ad_censorship/"><div class="bg-gray-100 border-l-4 border-gray-500 text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">광고관리</div></a>
      <a href="/admin/performance/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">매출</div></a>
      <a href="/admin/staff_manage/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">직원정보</div></a>
    </div>

    <!-- [ADD] 직원 패널 -->
    <div id="staff-col" class="bg-gray-100 w-[9.5%] pt-[5rem] shadow-right relative z-[10] text-left">
      <div id="staff-list" class="overflow-y-auto">
        <!-- JS로 렌더링 -->
      </div>
    </div>

    <!-- 어두운 오버레이 -->
    <div id="sales-overlay" class="fixed inset-0 bg-black/30 z-[900] hidden"></div>
  </div>

  <script type="module">
    import { client as supabase, waitForSupabase } from '../../../modules/core/supabase.js';
    import { showToastGreenRed } from '../../../modules/ui/toast.js';

    window.supabase = supabase;
    document.dispatchEvent(new Event('supabase-ready'));

    let __selectedStaffId = null;
    let __selectedAffiliation = null;
    const __AFFIL_STAFF_IDS = (window.__AFFIL_STAFF_IDS ||= {});

    async function getMyAuthorityAndStaffId() {
      await waitForSupabase();
      const { data: sessionRes, error: sErr } = await supabase.auth.getSession();
      if (sErr) throw sErr;
      const user = sessionRes?.session?.user;
      if (!user?.id) throw new Error('로그인이 필요합니다.');

      const { data: staff, error: spErr } = await supabase
        .from('staff_profiles')
        .select('id, authority, affiliation')
        .eq('user_id', user.id)
        .maybeSingle();

      if (spErr) throw spErr;
      if (!staff) throw new Error('staff_profiles에서 사용자 정보를 찾을 수 없습니다.');

      const authority = staff.authority || '';
      const isStaff = authority === '직원';
      window.__userRole = authority;
      window.__isStaff  = isStaff;

      return { authority, isStaff, staffId: staff.id, affiliation: staff.affiliation, userId: user.id };
    }

    /** ad_channel(s) 테이블에서 여러 ID를 이름으로 매핑 (테이블명이 ad_channel인지 ad_channels인지 모를 때 모두 시도) */
    async function fetchAdChannelsByIds(ids) {
      const uniqIds = Array.from(new Set(ids.filter(Boolean)));
      const result = new Map();
      if (!uniqIds.length) return result;

      const tables = ['ad_channel', 'ad_channels']; // 둘 중 존재하는 테이블을 사용
      for (const t of tables) {
        const { data, error } = await supabase
          .from(t)
          .select('id, channel_name')
          .in('id', uniqIds);

        if (!error && Array.isArray(data)) {
          for (const row of data) {
            result.set(row.id, row.channel_name);
          }
          return result; // 첫 성공에서 반환
        }
      }
      return result; // 실패해도 빈 Map 반환
    }

    (async () => {
      // 0) 권한/소속
      const me = await getMyAuthorityAndStaffId();

      // 1) 직원 데이터 로드 (조인은 하지 않고 ad_channel_id만 가져옴)
      let staffQuery = supabase
        .from('staff_profiles')
        .select(`
          id,
          name,
          affiliation,
          leave_date,
          ad_channel_id
        `)
        .order('affiliation', { ascending: true })
        .order('name', { ascending: true });

      if (me.authority === '직원') {
        staffQuery = staffQuery.is('leave_date', null);
      }

      const { data, error } = await staffQuery;
      if (error) {
        console.error('직원 정보 실패:', error);
        showToastGreenRed?.('직원 정보를 불러오지 못했습니다.');
        return;
      }

      // 2) 광고채널명 매핑 조회
      const channelIds = (data || []).map(r => r.ad_channel_id).filter(Boolean);
      const channelMap = await fetchAdChannelsByIds(channelIds);

      // 3) 소속별 묶기 + 지점→직원ID 캐시
      const grouped = {};
      (data || []).forEach(({ id, name, affiliation, leave_date, ad_channel_id }) => {
        if (!grouped[affiliation]) grouped[affiliation] = { active: [], inactive: [] };
        const entry = { id, name, affiliation, leave_date, ad_channel_id };
        if (!leave_date) grouped[affiliation].active.push(entry);
        else grouped[affiliation].inactive.push(entry);

        if (!__AFFIL_STAFF_IDS[affiliation]) __AFFIL_STAFF_IDS[affiliation] = new Set();
        __AFFIL_STAFF_IDS[affiliation].add(String(id));
      });

      const container = document.getElementById('staff-list');
      container.innerHTML = '';

      // 4) 권한별 클릭 가능 여부
      const canClickStaff = (emp) => {
        if (me.authority === '관리자') return true;
        if (me.authority === '지점장') return emp.affiliation === me.affiliation;
        if (me.authority === '직원')   return String(emp.id) === String(me.staffId);
        return false;
      };
      const canClickAff = (aff) => {
        if (me.authority === '관리자') return true;
        if (me.authority === '지점장') return aff === me.affiliation;
        return false;
      };

      function emitFilterChange() {
        document.dispatchEvent(new CustomEvent('adc:filter-change', {
          detail: {
            staffId: __selectedStaffId ? String(__selectedStaffId) : null,
            affiliation: __selectedAffiliation || null
          }
        }));
      }

      // 5) 렌더
      let firstClickableStaffEl = null;

      Object.entries(grouped).forEach(([aff, { active, inactive }], idx) => {
        // 지점 헤더
        const header = document.createElement('div');
        header.className = 'grade-header';
        header.textContent = aff;

        if (canClickAff(aff)) {
          header.classList.add('cursor-pointer', 'hover:bg-yellow-100');
          header.title = '이 지점의 전체 데이터 보기';
          header.addEventListener('click', () => {
            if (__selectedAffiliation === aff) {
              __selectedAffiliation = null;
              header.classList.remove('ring-2', 'ring-yellow-400');
            } else {
              __selectedAffiliation = aff;
              __selectedStaffId = null;
              container.querySelectorAll('.grade-header').forEach(h => h.classList.remove('ring-2','ring-yellow-400'));
              header.classList.add('ring-2', 'ring-yellow-400');
              container.querySelectorAll('.name-item').forEach(el => el.classList.remove('bg-yellow-200'));
            }
            emitFilterChange();
          });
        } else {
          header.classList.add('opacity-60');
          header.title = '이 지점은 조회 권한이 없습니다.';
        }
        container.appendChild(header);

        // 직원 아이템 생성
        const makeName = (emp, { dim = false } = {}) => {
          const el = document.createElement('div');
          el.className = 'name-item flex items-center gap-1';
          el.dataset.staffId = emp.id;

          // 광고채널명 표시
          const channel = channelMap.get(emp.ad_channel_id) || '';
          el.textContent = dim
            ? `${emp.name} (퇴사)${channel ? ' · ' + channel : ''}`
            : `${emp.name}${channel ? ' · ' + channel : ''}`;

          const allowed = canClickStaff(emp);
          if (!allowed) {
            el.classList.add('opacity-50', 'pointer-events-none', 'select-none');
            el.dataset.disabled = '1';
          } else {
            el.classList.add('cursor-pointer', 'hover:bg-yellow-100');
            if (!firstClickableStaffEl) firstClickableStaffEl = el;
          }
          return el;
        };

        active.forEach((emp) => container.appendChild(makeName(emp)));

        if (me.authority !== '직원' && inactive.length > 0) {
          const toggleBtn = document.createElement('button');
          toggleBtn.textContent = '▼ 퇴사자 보기';
          toggleBtn.className = 'text-sm text-blue-600 hover:underline ml-2 mb-1';

          const collapseDiv = document.createElement('div');
          collapseDiv.className = 'pl-4 mt-1 hidden';
          collapseDiv.id = `inactive-group-${idx}`;

          inactive.forEach((emp) => {
            const el = document.createElement('div');
            el.className = 'name-item text-gray-400 italic';
            el.dataset.staffId = emp.id;
            const channel = channelMap.get(emp.ad_channel_id) || '';
            el.textContent = `${emp.name} (퇴사)${channel ? ' · ' + channel : ''}`;
            // 퇴사자 클릭 비활성
            el.classList.add('opacity-60', 'pointer-events-none', 'select-none');
            collapseDiv.appendChild(el);
          });

          toggleBtn.onclick = () => {
            const expanded = collapseDiv.classList.toggle('hidden');
            toggleBtn.textContent = expanded ? '▲ 퇴사자 숨기기' : '▼ 퇴사자 보기';
          };

          container.appendChild(toggleBtn);
          container.appendChild(collapseDiv);
        }
      });

      // 직원 클릭 → 단일 직원 필터
      function setActiveStaff(staffId) {
        __selectedStaffId = staffId;
        __selectedAffiliation = null;

        container.querySelectorAll('.grade-header').forEach(h => h.classList.remove('ring-2','ring-yellow-400'));
        container.querySelectorAll('.name-item').forEach(el => {
          if (el.dataset.disabled === '1') return;
          if (String(el.dataset.staffId) === String(staffId)) {
            el.classList.add('bg-yellow-200');
          } else {
            el.classList.remove('bg-yellow-200');
          }
        });

        emitFilterChange();
      }
      container.addEventListener('click', (e) => {
        const el = e.target.closest('.name-item');
        if (!el || el.dataset.disabled === '1') return;
        setActiveStaff(el.dataset.staffId);
      });

      // 직원 권한: 본인 자동 선택
      if (me.isStaff && me.staffId) {
        setActiveStaff(me.staffId);
      }
    })();

    (async () => {
      try {
        await waitForSupabase();
        const { data } = await supabase.auth.getSession();
        if (!data?.session) location.replace("/");
      } catch (e) {
        console.warn(e);
      }
    })();

    // 예시) 필터 이벤트 수신
    // document.addEventListener('adc:filter-change', (e) => {
    //   const { staffId, affiliation } = e.detail || {};
    //   // TODO: 리스트 필터 적용
    // });
</script>

</body>
</html>
