<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>백억지도</title>
    <link rel="icon" type="image/png" href="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/pabicon-baikuk-simbol.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lightgallery.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lg-zoom.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lg-thumbnail.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lg-fullscreen.css">
    <link rel="preconnect" href="https://sfinbtiqlfnaaarziixu.supabase.co" crossorigin>
    <link rel="dns-prefetch" href="//sfinbtiqlfnaaarziixu.supabase.co">
    <script src="https://cdn.jsdelivr.net/npm/lightgallery/lightgallery.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightgallery/plugins/zoom/lg-zoom.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightgallery/plugins/thumbnail/lg-thumbnail.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightgallery/plugins/fullscreen/lg-fullscreen.umd.js"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f605c7b72dc7f3083f36483e55e2bc77&libraries=clusterer,services"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script> 
        window.REQUIRE_AUTH = true;   // admin은 항상 인증 필요
        window.LOGIN_PAGE = 'index.html';
        const BUCKET = 'listing-images'; //이미지 관련 변수
        window.BUCKET = 'listing-images'; // 버킷명
        window.BUCKET_IS_PUBLIC = false;  // 버킷이 Public이면 true (Private면 false)
        // 페이지네이션/좌측 목록 캐시 (초기값)
        let matchedListingsCache = [];
        let matchedListingsPage = 0;
        let _prewarmDoneOnce = false; //이미지 캐싱 관련 변수
        let lastPrewarmHash = null;  // 이전에 예열한 ID들 해시 저장
        let _imgReqToken = 0;
        // 전역 상태: 필드별 선택값 (예: { direction: ['남','서'], building_usage: ['제1종 근린생활시설'] })
        const selectFilterState = {}; 
        selectFilterState['transaction_status'] = ['진행중'];
    </script>
    <style>
        .image-wm { position: relative; overflow: hidden; }
        .thumb-box { background:#f3f4f6; overflow:hidden; }
        .thumb-img-contain { width:100%; height:100%; object-fit: contain; object-position:center; background:#fff; }
        .no-save {
            -webkit-user-drag: none; user-select: none; -webkit-user-select: none;
            -ms-user-select: none; -webkit-touch-callout: none;
        }
        #image-viewer-slot:empty { display: none; }
        #img-list .group:hover img { outline: 2px dashed rgba(0,0,0,0.15); } /* 선택모드에서 hover 시 구분감 */
    </style>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        const supabaseUrl = 'https://sfinbtiqlfnaaarziixu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaW5idGlxbGZuYWFhcnppaXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MDkxNjEsImV4cCI6MjA2ODA4NTE2MX0.4-7vnIjbF-biWWuv9-vTxK9Y99gMm-vS6oaRMdRL5fA';
        
        // 🔧 세션 영구 유지 + 자동 갱신
        window.supabase = createClient(supabaseUrl, supabaseKey, {
            auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
        });

        // ✅ 이후 코드는 client로만 사용(혼용 방지)
        const client = window.supabase;
        window.client = client;
        
        // ✅ 배포 서브패스에서도 안전한 이동 유틸
        const BASE = location.pathname.replace(/[^/]*$/, '');
        const here = (location.pathname.split('/').pop() || '/admin');

        function go(page){
            const targetUrl = new URL(page.startsWith('/') ? page : BASE + page, location.origin);
            if (location.pathname === targetUrl.pathname && location.search === targetUrl.search) return;
            location.replace(targetUrl.href);
        }

        window.go = go; // (onclick 등에서 쓸 수 있게)

        // 버튼 토글 유틸
        function toggleAuthButtons(has) {
            document.getElementById('logout-btn')?.classList.toggle('hidden', !has);
            document.getElementById('change-password-btn')?.classList.toggle('hidden', !has);
        }

        // ── Auth 가드: 논블로킹 + 타임아웃 ──────────────────────────

        // getSession이 지연돼도 화면이 멈추지 않도록 타임아웃 적용
        async function getSessionNonBlocking(timeoutMs = 1500) {
            const TIMEOUT = new Promise((resolve) =>
                setTimeout(() => resolve('__TIMEOUT__'), timeoutMs)
            );
            try {
                const res = await Promise.race([
                client.auth.getSession().then(r => (r?.data?.session ?? null)).catch(() => null),
                TIMEOUT
                ]);
                return res; // null | session | '__TIMEOUT__'
            } catch {
                return null;
            }
        }

        // 초기 1회: 세션 없으면 (관리영역이면) 루트로, 세션 있으면 버튼/뱃지 세팅
        async function runAdminGuardOnce() {
            const session = await getSessionNonBlocking(1500);

            if (session === '__TIMEOUT__') {
                console.warn('[auth] getSession timeout → continue rendering and check later');
                toggleAuthButtons(false); // 일단 비로그인 UI로
                return;
            }

            const isAuthed = !!session;
            toggleAuthButtons(isAuthed);

            // /admin 하위 경로에서 비로그인 → 루트로
            if (!isAuthed && location.pathname.startsWith('/admin')) {
                const url = new URL('/', location.origin);
                // 쿼리스트링을 보존하고 싶으면 유지
                if (location.search) url.search = location.search;
                location.replace(url.href);
                return;
            }

            // 배지 렌더 (DOM 준비 후 1회)
            document.addEventListener('DOMContentLoaded', () => {
                window.renderAffiliationBadge?.();
            });
        }

        // 상태 변화: 로그아웃 시 (관리영역이면) 루트로, 로그인 시 UI/뱃지 갱신
        client.auth.onAuthStateChange((_evt, session) => {
            const isAuthed = !!session;
            toggleAuthButtons(isAuthed);

            if (!isAuthed && location.pathname.startsWith('/admin')) {
                const url = new URL('/', location.origin);
                if (location.search) url.search = location.search;
                location.replace(url.href);
                return;
            }

            window.renderAffiliationBadge?.();
        });

        // 실행
        runAdminGuardOnce();

        // 앱 초기화 (인증 등)
        if (window.initializeApp) {
            initializeApp();
        }

    </script>

    <style>
        :root {
            --header-height: 3.5rem;
            --infopanel-left: 23.5%;
            --header-button-height: 1.6rem !important; /* ✅ 모든 헤더 버튼 높이를 제어할 변수 */
        }
        body { margin: 0; padding: 0; }
        header { position: fixed; top: 0; left: 0; right: 0; height: var(--header-height); z-index: 10000; background: #fff; }
        #map { position: absolute; top: var(--header-height); left: var(--infopanel-left); right: 0; bottom: 0; z-index: 0; }
        #info-panel { position: absolute; top: var(--header-height); left: 0; width: var(--infopanel-left); bottom: 0; z-index: 50; background: #fff; }
        #detail-panel { position: absolute; top: var(--header-height); left: var(--infopanel-left); width: 40%; bottom: 0; z-index: 9999; border-left: 0.3rem solid #e5e7eb;}
        #filter-bar { display: flex; flex-direction: column; gap: 2px; margin-top: 0; }
        
        /* ✅ 헤더 안의 모든 버튼에 스타일 적용 */
        header button {
            height: var(--header-button-height);
            font-size: 0.8rem !important;
            display: flex;
            align-items: center;
            padding-top: 0;
            padding-bottom: 0;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }
        .animate-fade-in-out {
            animation: fadeInOut 3s ease-in-out forwards;
        }
        #black-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            opacity: 0.8;
            z-index: 99999;
            pointer-events: none;
        }
        .two-line{
            display:-webkit-box;
            -webkit-box-orient:vertical;
            -webkit-line-clamp:2;
            overflow:hidden;
            line-height:1.4; /* 줄높이 고정(측정/적용에 동일 사용) */
        }
    </style>
</head>
<body class="m-0 p-0">
    <header class="flex items-center gap-4 w-full h-8 sm:h-10 md:h-12 px-2 sm:px-3 md:px-4 bg-white shadow-md border-b border-gray-200 fixed top-0 left-0 z-[10000]">
        <a href="/admin/listings/">
            <img src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/logotype-baikuk.png"
             alt="글씨로고" class="h-11 w-auto cursor-pointer" />
        </a>        
        <div class="relative">
            <button id="filter-btn-init" data-default-label="초기화" onclick="resetFilters()"
                    class="ml-[2rem] ml-[1rem] px-3 py-1.5 border border-gray-200 bg-red-100 text-red-600 rounded-md shadow-sm text-sm font-bold hover:bg-red-200 transition">초기화</button>
        </div>
        <div id="select-filter-wrap"></div>
        <div id="filter-bar" class="mr-[1rem] ml-[1rem] flex flex-row gap-2 items-start mt-2 relative z-[1000]">
            <div id="btn-wrap" class="flex flex-row gap-2"></div>
        </div>
        <button id="filter-btns-wrap" class="flex gap-1"></button>
        <div class="ml-auto flex items-center gap-2">
            <button id="open-listing-form-btn" class="text-sm text-gray-600 hover:text-black border px-3 py-1 rounded">
                🏢 매물등록
            </button>
            <button id="logout-btn"
                    onclick="logout()"
                    class="hidden text-sm text-gray-600 hover:text-black border px-3 py-1 rounded">
                🔓 로그아웃
            </button>
        </div>
    </header>
    <button id="btn-naver-map"
            class="hidden w-10 h-10 shadow rounded-lg flex items-center justify-center border border-gray-300 bg-[#00de5a] hover:bg-[#00b74a] transition mb-3 text-white text-[28px] font-black"
            style="text-shadow: 0 1px 2px #ffffff, 0 0 1px #ffffff;"
            title="네이버지도">
        N
    </button>
    <div id="login-modal"
         class="fixed inset-0 z-[20000] bg-black/40 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-lg p-8 w-80">
            <h2 class="font-bold text-xl mb-4 text-center">직원 로그인</h2>
            <input id="login-email" type="email" placeholder="이메일"
                   class="w-full border border-gray-300 rounded px-3 py-2 mb-3" />
            <input id="login-password" type="password" placeholder="비밀번호"
                   class="w-full border border-gray-300 rounded px-3 py-2 mb-4" />
            <button onclick="login()"
                    class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-semibold">
                로그인
            </button>
            <button onclick="hideLogin()"
                    class="w-full text-gray-500 mt-2">닫기</button>
            <div id="login-error" class="text-red-600 text-sm mt-2 hidden"></div>
        </div>
    </div>
    
    <div id="map" class="absolute top-0 bottom-0 right-0 left-[25%] z-0"></div>
    <div id="map-controls" class="fixed z-[11000] flex flex-col items-center bottom-10  right-5">
        
        <button id="btn-current-location"
                class="w-9 h-9 sm:w-10 sm:h-10 shadow rounded-lg flex items-center justify-center border border-gray-300 bg-white hover:bg-yellow-200 transition mb-5"
                title="현재 위치로 이동">
            <span class="text-xl text-black font-bold">◉</span>
        </button>
        <div class="flex flex-col space-y-1">
            <button id="btn-zoom-in"
                    class="w-9 h-9 sm:w-10 sm:h-10 shadow rounded-lg flex items-center justify-center border border-gray-300 bg-white hover:bg-yellow-200 transition"
                    title="확대">
                <span class="text-2xl text-black font-bold">＋</span>
            </button>
            <button id="btn-zoom-out"
                    class="w-9 h-9 sm:w-10 sm:h-10 shadow rounded-lg flex items-center justify-center border border-gray-300 bg-white hover:bg-yellow-200 transition"
                    title="축소">
                <span class="text-2xl text-black font-bold">－</span>
            </button>
        </div>
    </div>

    <div id="info-panel" class="absolute top-0 bottom-0 left-0 w-[25%] overflow-y-auto bg-white shadow-xl p-3 text-sm hidden z-50">
        <div id="info-content" class="text-xs text-gray-700"></div>
    </div>

    <div id="detail-panel"
         class="absolute top-[var(--header-height)] left-[25%] w-[40%] min-w-[300px] max-w-[35rem] bottom-0 bg-white shadow-xl relative z-[1000] hidden">

        <button 
            id="close-detail-btn"
            onclick="hideDetailPanel()"
            class="absolute top-2 right-4 w-8 h-8 bg-white text-gray-600 border border-gray-300 hover:border-black hover:text-black shadow-md flex items-center justify-center font-bold text-lg z-[1001]">
            ✕
        </button>

        <div id="detail-content" class="text-gray-800 text-sm whitespace-pre-line overflow-y-auto h-full px-4"></div>
    </div> 
    <div id="side-panel"
        class="pl-2 pt-2 absolute border-l border-gray-200 top-[var(--header-height)] left-[52.7%] w-[24rem] bottom-0 bg-white shadow-xl overflow-y-auto z-[1100]"
        style="border-left-width: 0.35rem;">
    </div>

  <script>

    const _nz = (s) => (s ?? '').toString();
    const normalizeAddr = (s) => _nz(s).replace(/\s+/g, '').trim();

    const HIGHLIGHT_COLOR = "#F2C130";
    const HIGHLIGHT_TEXT_COLOR = "#111";
    const DEFAULT_BTN_BG = "#f3f4f6";
    const DEFAULT_BTN_TEXT = "#374151";

    const PAGE_SIZE = 15;
    const allDealTypes = ['월세', '매매'];
    const allCategories = ['상가', '공장·창고', '주택'];
    const infoPanel = document.getElementById('info-panel');
    const infoContent = document.getElementById('info-content');
    // 네이버 부동산(랜드) 버튼 아이콘 URL - Supabase의 이미지 URL로 교체하세요
    const LAND_ICON_URL = 'https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/naver_land_icon.png';

    
    const filterDefs = [
        { id: 'deposit',       label: '보증금',   width: 300 },
        { id: 'rent',          label: '월세',     width: 280 },
        { id: 'floor',         label: '층',       width: 280 },
        { id: 'area_py',       label: '전용평수', width: 280 },
        { id: 'sale',          label: '매매가',   width: 300 },
        { id: 'total_deposit', label: '총보증금', width: 300 },
        { id: 'total_rent',    label: '총월세',   width: 280 },
    ];
    
    const formatNumber = (val) => {
        const num = parseFloat(val);
        if (isNaN(num)) return '';
        return Number.isInteger(num) ? num.toString() : num.toFixed(1);
    };

    let selectedDealTypes = ['월세'];
    let selectedCategories = ['상가'];
    
    let allListings = {};
    let allMarkers = {};
    let map, customImage;
    window.map = map;
    let clusterer, mapIdleTimer = null;
    let isFetching = false;

    let selectedClusterEl = null;
    let isLoggedIn = false;
    let currentGridSize = null;
    let updateTimer = null;
    let isEditMode = false;
    let detailScrollTop = 0;
    let _previewUrls = []; //사진 관련변수
    let publicBulkMode = true; // 공개 이미지 일괄삭제 전역 상태

    // 이미지 시간단축 위해서 캐시 관련 함수
    // 이미지 여러번 부르면 매번 서명 요청 관련 간단 캐시
    const _imgUrlCache = new Map();
    async function _memo(key, fn) {
        if (_imgUrlCache.has(key)) return _imgUrlCache.get(key);
        const v = await fn();
        _imgUrlCache.set(key, v);
        return v;
    }

    map = new kakao.maps.Map(document.getElementById('map'), {
      center: new kakao.maps.LatLng(37.7151, 126.7341),
      level: 3
    });

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            map.setCenter(new kakao.maps.LatLng(lat, lng));
        }, function(error) {
            console.log("위치 정보를 사용할 수 없습니다.", error);
        });
    } else {
        console.log("이 브라우저에서는 Geolocation을 지원하지 않습니다.");
    }

    infoPanel.style.display = 'block';

    customImage = new kakao.maps.MarkerImage(
      'https://raw.githubusercontent.com/mhale45/image/2d7ce4379b14d095d2f0b7f1d0057987548a37bf/2.png',
      new kakao.maps.Size(36, 36),
      { offset: new kakao.maps.Point(18, 36) }
    );

    // 스크립트 함수들 시작

    const _staffAffCache = new Map();
    // 지점 배지 렌더링 (전역에 노출)
    window.renderAffiliationBadge = async function renderAffiliationBadge(agentName) {
        const el = document.getElementById('affiliation-badge');
        if (!el) return;

        try {
            // 1) 대상 이름 결정 (파라미터 > 현재 상세 매물)
            let name =
            (agentName ||
            allListings?.[String(window.currentDetailListingId)]?.agent_name ||
            ''
            ).toString().trim();

            if (!name) {
            el.textContent = '';
            el.classList.add('hidden');
            return;
            }

            // (선택) 내부 id→표시명 매핑이 있다면 표시명으로 정규화
            if (window.resolveAgentDisplayName) {
                const disp = await window.resolveAgentDisplayName(name);
                if (disp) name = disp.toString().trim();
            }
            // (선택) 직함/괄호 등 제거가 필요하면 여기서 정리
            name = name.replace(/\s*\([^)]+\)\s*$/, '').trim();

            // 2) 캐시 조회
            let aff = _staffAffCache.get(name);

            // 3) DB 조회 (정확 일치 → 없으면 부분/대소문자 무시 매칭)
            if (!aff) {
            let q = await client
                .from('public_staff_view')
                .select('name, affiliation')
                .eq('name', name)
                .limit(1);

            if (q.error) throw q.error;

            if (!q.data?.length) {
                q = await client
                .from('public_staff_view')
                .select('name, affiliation')
                .ilike('name', `%${name}%`)
                .limit(1);
            }

            aff = q.data?.[0]?.affiliation || '';
            if (aff) _staffAffCache.set(name, aff);
            }

            // 4) 폴백: 그래도 없으면 로그인 사용자 소속
            if (!aff) {
            const ctx = await (window.getAuthContext?.() || {});
            aff = (ctx.me?.affiliation ?? '').toString().trim();
            }

            // 5) 렌더
            if (!aff) {
            el.textContent = '';
            el.classList.add('hidden');
            return;
            }

            el.classList.remove('hidden');
            el.innerHTML = `<span class="inline-flex items-center px-2 py-1 rounded-full border border-gray-200 bg-gray-50">${window.safeDisplay ? window.safeDisplay(aff) : aff}
            </span>
            `;
        } catch (e) {
            console.warn('affiliation 렌더 실패:', e);
            el.textContent = '';
            el.classList.add('hidden');
        }
    };

    // listing에서 검색용 전체 주소 문자열 만들기
    function getFullAddressForListing(listing){
        const norm = (v) => (v ?? '').toString().trim();
        const bad  = (s) => !s || s === '-' || s === '.' || s.toLowerCase() === 'null' || s.toLowerCase() === 'undefined';

        // 1) building_info에서 합쳐온 필드가 있으면 최우선
        const fromBI = norm(listing.full_address || listing.building_full_address);
        if (!bad(fromBI)) return fromBI;

        // 2) 개별 필드로 조립
        const parts = [norm(listing.province), norm(listing.city), norm(listing.district), norm(listing.detail_address)]
            .filter(s => !bad(s));
        return parts.join(' ').trim();
    }

    async function ensurePrimaryAfterDeletion(listingId){
        try {
            // 남은 공개 이미지 중 대표 유무 확인
            const { data: hasPrim } = await client
            .from('listing_images')
            .select('id')
            .eq('listing_id', String(listingId))
            .eq('is_private', false)
            .eq('is_primary', true)
            .limit(1);
            if (Array.isArray(hasPrim) && hasPrim.length) return; // 이미 대표 있음

            // 대표 없으면 order_index 가장 작은 한 장을 대표로 지정
            const { data: remain } = await client
            .from('listing_images')
            .select('id')
            .eq('listing_id', String(listingId))
            .eq('is_private', false)
            .order('order_index', { ascending: true })
            .limit(1);
            if (remain && remain[0]?.id){
            await client
                .from('listing_images')
                .update({ is_primary: true })
                .eq('id', remain[0].id);
            }
        } catch (e) {
            console.warn('ensurePrimaryAfterDeletion error', e);
        }
    }

    // 사진 일괄삭제 관련
    async function bulkDeleteSelectedPublicImages(listingId){
        const selected = Array.from(document.querySelectorAll('#img-list input.img-select:checked'));
        if (!selected.length) { showToast('선택된 이미지가 없습니다.'); return; }

        // 1) data-id/data-path 정규화 + 검증 (UUID/숫자 모두 허용, 빈값만 제거)
        const ids = selected
            .map(el => (el.dataset?.id ?? '').toString().trim())
            .filter(v => v && v !== 'null' && v !== 'undefined'); // 문자열 그대로 유지
        const paths = selected
            .map(el => (el.dataset?.path ?? '').toString().trim())
            .filter(Boolean);

        // 2) 방어: 유효 id 없으면 중단
        if (!ids.length) { 
            console.warn('[bulkDelete] invalid ids from checkboxes:', selected.map(el => el.dataset?.id));
            showToast('삭제할 이미지 ID를 읽지 못했어요. 새로고침 후 다시 시도해 주세요.');
            return;
        }

        if (!confirm(`선택된 ${ids.length}장을 삭제할까요?`)) return;

        // 대표컷이 포함되었는지 확인
        let primaryDeleted = false;
        try {
            const { data: prim } = await client
            .from('listing_images')
            .select('id')
            .eq('listing_id', String(listingId))
            .eq('is_private', false)
            .eq('is_primary', true)
            .maybeSingle();
            if (prim && ids.includes(prim.id)) primaryDeleted = true;
        } catch {}

        // 1) DB 삭제
        const { error: dbErr } = await client
            .from('listing_images')
            .delete()
            .in('id', ids)
            .eq('listing_id', String(listingId))
            .eq('is_private', false);
        if (dbErr){ showToast('DB 삭제 실패: ' + dbErr.message); return; }

        // 2) 스토리지 삭제 (배치)
        const { error: stErr } = await client.storage.from(BUCKET).remove(paths);
        if (stErr){ showToast('스토리지 일부 삭제 실패: ' + stErr.message); }

        // 3) 대표컷이 사라졌다면 재지정
        if (primaryDeleted){
            await ensurePrimaryAfterDeletion(listingId);
        }

        // 4) UI 갱신
        await loadListingImages(listingId);
        await initImageViewer(listingId); // 상세 2장 미리보기 갱신
        showToast('선택 이미지 삭제 완료');
    }
    
    // 사진 일괄삭제 관련
    function setupPublicBulkToolbar(listingId){
        const listBox = document.getElementById('img-list');
        if (!listBox) return;

        // 기존 툴바 있으면 교체
        document.getElementById('img-bulk-toolbar')?.remove();

        const wrap = document.createElement('div');
        wrap.id = 'img-bulk-toolbar';
        wrap.className = 'flex items-center gap-2 mb-2';

        wrap.innerHTML = `
            <button id="btn-bulk-all" class="px-2 py-1 border rounded">전체선택</button>
            <button id="btn-bulk-none" class="px-2 py-1 border rounded">전체해제</button>
            <button id="btn-bulk-del" class="px-2 py-1 border rounded text-red-600 border-red-400">선택삭제</button>
        `;

        // 리스트 바로 위에 꽂기
        listBox.parentElement?.insertBefore(wrap, listBox);

        // 이벤트
        document.getElementById('btn-bulk-all').onclick = () => {
            document.querySelectorAll('#img-list input.img-select').forEach(cb => {
                cb.checked = true;
                cb.dispatchEvent(new Event('change')); // ← 오버레이 업데이트
            });
        };
        document.getElementById('btn-bulk-none').onclick = () => {
            document.querySelectorAll('#img-list input.img-select').forEach(cb => {
                cb.checked = false;
                cb.dispatchEvent(new Event('change'));
            });
        };
        document.getElementById('btn-bulk-del').onclick = () => bulkDeleteSelectedPublicImages(listingId);
    }


    // 날짜 YYYY-MM-DD 포맷
    function formatYMD(dateStr){
        if (!dateStr) return '';
        const d = new Date(dateStr);
        if (isNaN(d)) return '';
        const pad = n => String(n).padStart(2, '0');
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    // 🔸 1) 공통 함수로 분리: 신규 매물 생성 + 수정모드로 상세패널 열기
    async function openNewListing() {
        try {
            console.log('[openNewListing] start');
            const newId = await getNextListingId();            // Supabase 최대 listing_id + 1
            const center = window.map?.getCenter();

            const dummyListing = {
                listing_id: newId,
                lat: center?.getLat() || 37.5665,
                lng: center?.getLng() || 126.9780,
                building_name: '',
                unit_info: '',
                floor: '',
                total_floor: '',
                detail_address: '',
                exclusive_m2: '',
                supply_m2: '',
                monthly_rent: '',
                deposit: '',
                price: '',
                manage_cost: '',
                manage_cost_items: '',
                restroom: '',
                store_type: '',
                store_type_detail: '',
                transaction_status: '진행중',
                title: '',
                memo: '',
                images: [],
                agent_name: '',
                agent_phone: '',
                agency_name: '',
                deal_type: '월세',
                is_public: '공개',
                category: '상가'
            };

            // 전역 캐시에 등록
            allListings[String(newId)] = dummyListing;

            showDetailPanel(newId); // 상세패널 열기(내부에서 panel.style.display='block')

            // 🔴 showDetailPanel 전에 수정모드 ON
            isEditMode = true;

            console.log('[openNewListing] done');
        } catch (err) {
            console.error('[openNewListing] 실패:', err);
            alert('매물등록 패널을 여는 중 문제가 발생했습니다.');
        }
    }

    // listing_id 가져오는 함수
    async function getNextListingId() {
        const { data, error } = await supabase
            .from('baikukdbtest')
            .select('listing_id')
            .order('listing_id', { ascending: false })
            .limit(1);

        if (error || !data || data.length === 0) {
            console.warn('listing_id 조회 실패:', error);
            return Date.now(); // fallback
        }

        return data[0].listing_id + 1;
    }

    // 상세패널에서 꼭 필요한 필드(예시) — 원하면 추가
    const REQUIRED_FIELDS_FOR_DETAIL = ['agent_name', 'deal_type', 'category', 'listing_title'];

    function isPartialListing(obj) {
        if (!obj) return true;
        return REQUIRED_FIELDS_FOR_DETAIL.some(k => obj[k] === undefined);
    }

    /**
     * ensureListingLoaded
     * @param {number|string} listingId
     * @param {{ force?: boolean, allowMissing?: boolean }} opts
     *   - force: 캐시에 있어도 DB 재조회
     *   - allowMissing: DB에 없을 때(신규 더미 등) 캐시가 있으면 캐시 반환
     */
    async function ensureListingLoaded(listingId, opts = {}) {
        const { force = false, allowMissing = false } = opts;
        const key = String(listingId);
        const cached = allListings[key];

        // 캐시가 있고, 강제 아님, 그리고 부분이 아니면 캐시 반환
        if (!force && cached && !isPartialListing(cached)) return cached;

        // DB에서 풀 레코드 재조회
        const { data, error } = await client
            .from('baikukdbtest')
            .select('*')
            .eq('listing_id', listingId)
            .maybeSingle();

        if (error || !data) {
            // DB에 없는데 캐시가 있으면(신규 더미 등) 옵션에 따라 캐시 반환
            if (allowMissing && cached) return cached;
            console.error('단건 로드 실패:', error || 'not found');
            showToast('매물 정보를 불러오지 못했습니다.');
            throw error || new Error('listing not found');
        }

        // 풀 레코드로 캐시 갱신(부분 캐시였다면 병합)
        allListings[key] = { ...(cached || {}), ...data };
        return allListings[key];
    }

    // ✅ 로그인 사용자 & 관리자 여부
    async function getAuthContext() {
        const { data: { session } } = await client.auth.getSession();
        if (!session?.user) return { isAdmin: false, me: null };

        const uid    = session.user.id;      // Supabase auth user id (uuid)
        const uemail = session.user.email ?? '';

        // 스키마: staff_profiles.user_id (uuid)
        let { data: me, error } = await client
            .from('staff_profiles')
            .select('id, name, affiliation, authority, email, user_id')
            .eq('user_id', uid)
            .maybeSingle();

        if ((!me || error) && uemail) {
            const r2 = await client
            .from('staff_profiles')
            .select('id, name, affiliation, authority, email, user_id')
            .eq('email', uemail)
            .maybeSingle();
            me = r2.data ?? null;
        }

        // 관리자 판정: authority 가 admin/관리자
        const auth = (me?.authority || '').toString().trim().toLowerCase();
        const isAdmin = auth === 'admin' || auth === '관리자';

        return { isAdmin, me };
    }
    window.getAuthContext = getAuthContext;

    // ✅ 담당자 표시 이름 resolving: 퇴사자면 '백억부동산'
    const _agentDisplayCache = new Map(); // name -> '백억부동산' or 원본 이름
    async function resolveAgentDisplayName(name) {
        const n = (name || '').trim();
        if (!n) return '';
        if (_agentDisplayCache.has(n)) return _agentDisplayCache.get(n);

        try {
            const { data, error } = await client
            .from('staff_profiles')
            .select('leave_date')
            .eq('name', n)
            .maybeSingle();
            if (error) throw error;

            const display = data?.leave_date ? '백억부동산' : n;
            _agentDisplayCache.set(n, display);
            return display;
        } catch (e) {
            console.warn('resolveAgentDisplayName error:', e);
            // 문제 있으면 원본 그대로 표시
            return n;
        }
    }
     
    // ✅ 편집모드 담당자 드롭다운: 퇴사자(leave_date 존재) 제외
    async function populateStaffSelect(selectElId = 'agent_name', preselectName = '') {
        const selectEl = document.getElementById(selectElId);
        if (!selectEl) return;

        // 로딩 UI
        selectEl.disabled = true;
        selectEl.innerHTML = '<option value="">불러오는 중...</option>';

        try {
            const { isAdmin, me } = await getAuthContext();
            let myAuth = (me?.authority || '').toLowerCase();
            let myAff  = (me?.affiliation || '').trim();

            if ((!myAuth || !myAff) && me?.id) {
            const { data: myRow } = await client
                .from('staff_profiles')
                .select('authority, affiliation')
                .eq('id', me.id)
                .maybeSingle();
            if (myRow) {
                if (!myAuth) myAuth = (myRow.authority || '').toLowerCase();
                if (!myAff)  myAff  = (myRow.affiliation || '').trim();
            }
            }

            const isManager = ['manager', '지점장'].includes(myAuth);

            // 🔎 직원 목록 조회 (퇴사자 포함해서 가져오되, 아래에서 필터링)
            let q = client.from('staff_profiles').select('id, name, affiliation, leave_date');
            if (isAdmin) {
            q = q.order('name', { ascending: true });
            } else {
            if (myAff) q = q.eq('affiliation', myAff).order('name', { ascending: true });
            else if (me?.id) q = q.eq('id', me.id);
            }

            const { data, error } = await q;
            if (error) throw error;

            // 🧹 퇴사자 제거: leave_date 있는 행은 옵션에서 제외
            const rows = (data || [])
            .filter(r => r?.name && !r?.leave_date)
            .map(r => ({
                id: r.id,
                name: (r.name || '').trim(),
                affiliation: (r.affiliation || '').trim()
            }));

            // (예외) 아무도 없을 때
            if (!rows.length) {
            selectEl.innerHTML = `<option value="">직원 없음</option>`;
            selectEl.disabled = true;
            return;
            }

            // 렌더 시작
            selectEl.innerHTML = '';
            const ph = document.createElement('option');
            ph.value = '';
            ph.textContent = isAdmin ? '담당자 선택 (전체)' : '담당자 선택 (내 지점)';
            selectEl.appendChild(ph);

            if (isAdmin) {
            // 지점별 그룹핑
            const groupMap = new Map();
            for (const r of rows) {
                const key = r.affiliation || '(지정없음)';
                if (!groupMap.has(key)) groupMap.set(key, []);
                groupMap.get(key).push(r);
            }

            // 지점/이름 정렬
            for (const arr of groupMap.values()) {
                arr.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
            }

            const allAffs = Array.from(groupMap.keys());
            const hasUnassigned = allAffs.includes('(지정없음)');
            const affsSansUnassigned = allAffs.filter(a => a !== '(지정없음)');

            const primaryAff = myAff || null;
            const sortedAffs = [];
            if (primaryAff && groupMap.has(primaryAff)) sortedAffs.push(primaryAff);
            affsSansUnassigned
                .filter(a => a !== primaryAff)
                .sort((a, b) => a.localeCompare(b, 'ko'))
                .forEach(a => sortedAffs.push(a));
            if (hasUnassigned) sortedAffs.push('(지정없음)');

            for (const aff of sortedAffs) {
                const og = document.createElement('optgroup');
                og.label = aff;
                for (const s of groupMap.get(aff)) {
                const opt = document.createElement('option');
                opt.value = s.name;      // 저장값 = 실제 이름
                opt.textContent = s.name; // 표시값 = 실제 이름
                og.appendChild(opt);
                }
                selectEl.appendChild(og);
            }
            } else {
            // 단순 리스트
            rows
                .sort((a, b) => a.name.localeCompare(b.name, 'ko'))
                .forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.name;
                opt.textContent = s.name;
                selectEl.appendChild(opt);
                });
            }

            // ✅ 기본 선택
            const want = (preselectName || '').trim();
            if (want) {
            // 퇴사자면 rows에 없으므로 선택되지 않음 (표시하지 않음)
            selectEl.value = want;
            if (selectEl.value !== want) {
                // 선택 불가 → 미지정 상태 유지
                selectEl.value = '';
            }
            } else if (!isAdmin && me?.name && rows.some(r => r.name === me.name)) {
            selectEl.value = (me.name || '').trim();
            }

            // 권한별 활성화
            const canChange = isAdmin || isManager;
            selectEl.disabled = !canChange;
            selectEl.title = !canChange
            ? '담당자 변경 권한이 없습니다.'
            : (isAdmin
                ? (myAff ? `관리자: 모든 직원 지정 가능 (내 지점 우선 표시: ${myAff})` : '관리자: 모든 직원 지정 가능')
                : `지점장: 내 지점 직원만 지정할 수 있습니다. (지점: ${myAff || '-'})`);
        } catch (e) {
            console.error('staff_profiles 로드 실패:', e);
            selectEl.innerHTML = `<option value="">직원 없음</option>`;
        }
    }


    // 매물 담당자 변경 관련 함수
    // RLS/권한 메시지 변환
    function agentUpdateErrorToHuman(err) {
        const msg = (err?.message || '').toLowerCase();

        if (msg.includes('violates row-level security') || msg.includes('rls')) {
            return '서버 정책(RLS)으로 거부되었습니다. 권한을 확인하세요.';
        }
        if (msg.includes('permission denied')) {
            return '권한이 없어 담당자를 변경할 수 없습니다.';
        }
        if (msg.includes('missing required permission')) {
            return '담당자 변경 권한이 없습니다.';
        }
        return '담당자 저장 중 오류가 발생했습니다.';
    }

    /**
     * 프런트에서 가능한 선검증 후 Supabase 업데이트 시도
     * - admin: 무조건 허용
     * - manager(지점장): 선택된 이름이 같은 affiliation 직원일 때만 허용
     * - 그 외: 금지
     */
    // ✅ 담당자 변경 시에만 저장 + RLS 에러 메시지 안내
    async function saveAgentNameIfChanged(listingId) {
        const selectEl = document.getElementById('agent_name');
        if (!selectEl) return true; // 저장할 게 없음

        const newName = (selectEl.value || '').trim();
        const listing = allListings?.[String(listingId)];
        if (!listing) return true;

        // 변경 없으면 패스
        if ((listing.agent_name || '') === newName) return true;

        const { error } = await client
            .from('baikukdbtest')
            .update({ agent_name: newName })
            .eq('listing_id', listingId);

        if (error) {
            // 권한/RLS/GRANT 실패 메시지 맵핑
            const msg = (error.message || '').toLowerCase();

            if (msg.includes('permission denied')) {
            showToast('담당자 저장 실패: 권한이 없습니다. (GRANT/RLS)', { type: 'error' });
            } else if (msg.includes('violates row-level security policy') || msg.includes('new row violates')) {
            showToast('담당자 저장 실패: RLS 정책에 맞지 않습니다.\n관리자나 지점장만 변경 가능하며, 지점장은 본인 지점의 직원만 지정할 수 있어요.', { type: 'error' });
            } else if (msg.includes('update')) {
            showToast('담당자 저장 실패: 업데이트 권한이 없거나 정책 조건을 만족하지 않습니다.', { type: 'error' });
            } else {
            showToast(`담당자 저장 실패: ${error.message}`, { type: 'error' });
            }
            console.error('saveAgentName error', error);
            return false;
        }

        // 로컬 상태 동기화
        listing.agent_name = newName;
        showToast('담당자를 저장했어요.', { type: 'success' });
        return true;
    }



    // 예열한 해시 저장 관련 함수
    function tryPrewarmVisibleThumbs() {
        const filtered = filterListings(Object.values(allListings));
        const idsInView = filtered.map(l => l.listing_id).sort();
        const hash = idsInView.join(',');

        if (hash === lastPrewarmHash) return; // 같은 영역이면 생략
        lastPrewarmHash = hash;

        console.log(`📸 예열 대상 ${idsInView.length}건`);
        ensureThumbsReady(idsInView, { timeout: 1000 }).catch(console.warn);
    }

    async function ensureThumbsReady(ids, { timeout = 350 } = {}) {
        const strIds = ids.map(String);

        // 1) URL 캐시 채우기
        await loadPrimaryThumbsBatch(strIds, { applyToDom: false });

        // 2) 캐시에서 URL 가져오기
        const urls = strIds
            .map(id => primaryThumbCache.get(id))
            .filter(Boolean);

        if (urls.length === 0) return;

        console.log(`🔄 썸네일 디코드 시작 (${urls.length}장), 타임아웃 ${timeout}ms`);

        let decodedCount = 0;
        const loaders = urls.map(u => {
            const img = new Image();
            img.decoding = 'async';
            img.loading  = 'eager';
            img.src = u;
            const p = img.decode ? img.decode() : new Promise(res => { img.onload = res; img.onerror = res; });
            p.then(() => {
            decodedCount++;
            });
            return p;
        });

        const decodePromise = Promise.allSettled(loaders).then(() => true);
        const timeoutPromise = new Promise(res => setTimeout(() => {
            res(false);
        }, timeout));

        const decodedInTime = await Promise.race([decodePromise, timeoutPromise]);
        
        console.log(`✅ 예열 완료: ${decodedCount} / ${urls.length} 장 성공`);
        return decodedInTime;
    }

    // 건물정보(주소공용) 대표 썸네일을 상세 패널의 thumb에 주입
    async function setBuildingThumbForDetail(listing) {
        try {
            if (!listing) return;
            const imgEl = document.getElementById(`thumb-edit-${listing.listing_id}`);
            if (!imgEl) return;

            const addrKey = getAddrKey(listing); // 이미 있는 함수(공백제거한 compare key)
            if (!addrKey) return;

            // 대표컷: is_primary 우선, 없으면 order_index 가장 작은 것
            const { data: rows, error } = await client
            .from('address_images')
            .select('path, is_primary, order_index')
            .eq('addr_compare', addrKey)
            .order('is_primary', { ascending: false })
            .order('order_index', { ascending: true })
            .limit(1);

            if (error || !rows?.length) return; // 이미지 없으면 기존 로고 유지

            // 140x100 박스 → 레티나 2x 품질로 280x200, cover 크롭
            const signed = await signDisplayCover(rows[0].path, 280, 200, 70);
            if (signed) {
            imgEl.src = signed;
            imgEl.style.cursor = 'zoom-in';
            imgEl.title = '클릭해서 크게 보기';
            imgEl.onclick = () => openViewerForAddress(addrKey, 0);
            }
        } catch (e) {
            console.warn('setBuildingThumbForDetail failed:', e);
        }
    }


    // 주소키 → 안전한 ASCII 폴더명 (SHA-1 40자리)
    async function addrFolderFromKey(addrKey) {
        const buf  = new TextEncoder().encode(String(addrKey));
        const hash = await crypto.subtle.digest('SHA-1', buf);
        return [...new Uint8Array(hash)].map(b => b.toString(16).padStart(2,'0')).join('');
    }

    // 주소 비교키: 공백 제거한 텍스트
    function getAddrKey(listing) {
        const parts = [
            listing?.province || '',
            listing?.city || '',
            listing?.district || '',
            listing?.detail_address || '',
        ].map(s => s.trim()).join(' ');
        return normalizeAddr(parts); // 공백제거+trim
    }


    // 사인 URL 캐시 재사용 (_signedUrlCache 유지)
    async function signDisplayCover(path, w, h, quality = 72) {
        const key = `dispCover:${path}|${w}x${h}|q${quality}`;
        return _memo(key, async () => {
            const { data, error } = await client.storage
            .from(BUCKET)
            .createSignedUrl(path, 600, { transform: { width: w, height: h, resize: 'contain', quality }});
            if (error) throw error;
            return data?.signedUrl || '';
        });
    }


    // === 인포패널 대표 썸네일 캐시 ===
    const primaryThumbCache = new Map();

    // 썸네일(가볍게) 서명 URL
    async function signedThumbUrl(path, width = 240) {
        const { data, error } = await client
            .storage.from(BUCKET)
            .createSignedUrl(path, 600, { transform: { width, resize: 'contain', quality: 48 }});
        if (error) { console.warn('signedThumbUrl 실패:', error); return ''; }
        return data?.signedUrl || '';
    }

    // 캐시값을 즉시 DOM 반영
    function applyPrimaryThumbsFromCache(listingIds) {
        for (const id of listingIds) {
            const el = document.getElementById(`thumb-${id}`);
            if (!el) continue;
            const cached = primaryThumbCache.get(String(id));
            if (cached) el.src = cached;
        }
    }

    // ✅ 옵션 추가: { applyToDom = true }
    async function loadPrimaryThumbsBatch(listingIds, { applyToDom = true } = {}) {
        const ids = listingIds.map(String);

        if (applyToDom) applyPrimaryThumbsFromCache(ids);

        // 1) 뷰에서 받은 path로 먼저 채우기
        const toSignNow = [];
        for (const id of ids) {
            if (!primaryThumbCache.has(id)) {
                const p = allListings?.[id]?.primary_image_path;
                if (p) toSignNow.push([id, p]);
            }
        }
        if (toSignNow.length) {
            // 병렬 서명
            const signed = await Promise.all(toSignNow.map(([id, p]) => signedThumbUrl(p, 240).then(u => [id, u || ''])));
            for (const [id, url] of signed) primaryThumbCache.set(id, url);
        }

         // 2) 여전히 비어있는 것만 테이블에서 보충
        const need = ids.filter(id => !primaryThumbCache.has(id));
        if (need.length === 0) return;

        const { data, error } = await client
            .from('listing_images')
            .select('listing_id, path, is_primary, order_index')
            .in('listing_id', need)
            .eq('is_private', false)
            .order('is_primary', { ascending: false })
            .order('order_index', { ascending: true });

        if (error) { console.warn('대표사진 조회 실패:', error); return; }

        const firstByListing = new Map();
        for (const row of data || []) {
            const id = String(row.listing_id);
            if (!firstByListing.has(id)) firstByListing.set(id, row);
        }

        for (const id of need) {
            const row = firstByListing.get(id);
            if (!row) { primaryThumbCache.set(id, ''); continue; }
            const url = await signedThumbUrl(row.path, 240);
            primaryThumbCache.set(id, url || '');
        }

        if (applyToDom) applyPrimaryThumbsFromCache(ids);
    }

    
    // --- 건물(주소공용): 미리보기 ---
    function previewSelectedFilesAddr(){
        const input = document.getElementById('img-upload-input-addr');
        const box   = document.getElementById('img-preview-list-addr');
        if (!input || !box) return;
        box.innerHTML = '';
        for (const f of input.files || []) {
            const url = URL.createObjectURL(f);
            const el = document.createElement('img');
            el.src = url;
            el.className = 'w-full h-24 object-cover rounded border';
            box.appendChild(el);
        }
    }

    // --- 건물(주소공용): 목록 로드 ---
    async function loadAddressImages(addrKey){
        const box = document.getElementById('img-list-addr');
        if (!box || !addrKey) return;

        const { data: rows, error } = await client
            .from('address_images')
            .select('id, path')
            .eq('addr_compare', addrKey)
            .order('order_index', { ascending: true });

        if (error) { console.error('addr imgs load fail', error); return; }

        box.innerHTML = '';
        for (const r of rows || []) {
            const thumbUrl = await getTransformedUrl(r.path, 360, 3600, 60, 96, 'contain');
            const wrap = document.createElement('div'); 
            wrap.className = 'relative group rounded overflow-hidden';

            const img = document.createElement('img');
            img.src = thumbUrl;
            img.className = 'w-full h-24 object-contain bg-white rounded border';

            // 선택 시 보여줄 오버레이(두꺼운 파란 테두리)
            const outline = document.createElement('div');
            outline.className = 'pointer-events-none absolute inset-0 hidden ring-2 ring-blue-500 rounded';
            wrap.appendChild(outline);

            img.onclick = () => openViewerForAddress(addrKey);

            const del = document.createElement('button');
            del.textContent = '삭제';
            del.className = 'absolute top-1 right-1 bg-white/90 text-xs px-2 py-[2px] rounded border';
            del.onclick = () => deleteAddressImage(r.id, r.path, addrKey);

            wrap.appendChild(img); wrap.appendChild(del); box.appendChild(wrap);
        }
    }

    // --- 건물(주소공용): 업로드 ---(addrKey는 텍스트, folder는 해시)
    async function uploadSelectedImagesAddr(listing){
        const input = document.getElementById('img-upload-input-addr');
        const btn   = document.getElementById('img-upload-btn-addr');
        if (!input || !input.files?.length) { showToast('먼저 파일을 선택하세요.'); return; }

        const addrKey = getAddrKey(listing);           // ← 텍스트 키
        if (!addrKey) { showToast('주소키가 없습니다.'); return; }
        const folder  = await addrFolderFromKey(addrKey); // ← 해시 폴더

        const prev = btn?.textContent;
        if (btn){ btn.disabled = true; btn.textContent = '업로드 중...'; }

        try {
            let nextIndex = 0;
            try {
            const { data: last } = await client
                .from('address_images')
                .select('order_index')
                .eq('addr_compare', addrKey)
                .order('order_index', { ascending:false })
                .limit(1)
                .maybeSingle();
            nextIndex = (last?.order_index ?? -1) + 1;
            } catch {}

            let success = 0;
            for (const f of input.files){
            if (!f.type?.startsWith('image/')) { showToast('이미지 파일만 올릴 수 있어요.'); continue; }
            if (f.size > 10*1024*1024) { showToast('10MB 이하만 업로드 가능합니다.'); continue; }

            const id  = (crypto?.randomUUID && crypto.randomUUID()) || (Date.now()+'-'+Math.random().toString(16).slice(2));
            const ext = (f.type?.split('/')[1] || 'jpg').toLowerCase();
            const key = `addresses/${folder}/orig/${id}.${ext}`;

            const { error: upErr } = await client.storage.from(BUCKET).upload(key, f, { upsert:false, contentType: f.type });
            if (upErr){ console.error(upErr); showToast('업로드 실패: '+upErr.message); continue; }

            const row = {
                addr_compare: addrKey, bucket: BUCKET, path: key, mime_type: f.type,
                order_index: nextIndex++, caption: null, is_primary: false
            };
            const { error: dbErr } = await client.from('address_images').insert(row);
            if (dbErr){ console.error(dbErr); await client.storage.from(BUCKET).remove([key]); showToast('DB 기록 실패: '+dbErr.message); continue; }

            success++;
            }

            input.value = '';
            previewSelectedFilesAddr();
            await loadAddressImages(addrKey);
            await setBuildingThumbForDetail(listing); // ← 업로드 직후 썸네일 갱신
            showToast(success>0 ? `업로드 완료 (${success}장)` : '업로드된 파일이 없습니다.');
        } finally {
            if (btn){ btn.disabled = false; btn.textContent = prev || '업로드'; }
        }
    }

    // --- 건물(주소공용): 삭제 ---
    async function deleteAddressImage(rowId, path, addrKey){
        if (!confirm('이 이미지를 삭제할까요?')) return;
        const { error: dbErr } = await client.from('address_images').delete().eq('id', rowId);
        if (dbErr){ showToast('DB 삭제 실패'); return; }
        const { error: stErr } = await client.storage.from(BUCKET).remove([path]);
        if (stErr){ showToast('스토리지 삭제 실패'); return; }
        await loadAddressImages(addrKey);
        showToast('삭제 완료');
    }

    // --- 건물(주소공용): 드래그&드롭 ---
    function setupDragAndDropUploadAddr(listing){
        const dropzone = document.getElementById('img-dropzone-addr');
        const input    = document.getElementById('img-upload-input-addr');
        if (!dropzone || !input) return;

        const highlight = () => dropzone.style.borderColor = '#F2C130';
        const unlight   = () => dropzone.style.borderColor = '#d1d5db';

        ['dragenter','dragover'].forEach(evt => dropzone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); highlight(); }));
        ['dragleave','dragend'].forEach(evt => dropzone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); unlight(); }));

        dropzone.addEventListener('drop', async (e) => {
            e.preventDefault(); e.stopPropagation(); unlight();
            if (!e.dataTransfer) return;
            const files = await collectFilesFromDataTransfer(e.dataTransfer);
            if (!files.length) { showToast('가져올 수 있는 이미지가 없습니다.'); return; }
            const dt = new DataTransfer(); for (const f of files) dt.items.add(f);
            input.files = dt.files;
            previewSelectedFilesAddr();
            // 자동 업로드하려면 ↓ 주석 해제
            // await uploadSelectedImagesAddr(listing);
        });
    }

    // --- 건물(주소공용): 뷰어 열기(선택) ---
    // --- 건물(주소공용): 뷰어 열기 ---
    // addrKey = 공백 제거된 주소 비교키
    async function openViewerForAddress(addrKey, startIndex = 0) {
        // 1) 이미지 목록
        const { data: rows } = await client
            .from('address_images')
            .select('path, caption, order_index, created_at')
            .eq('addr_compare', addrKey)
            .order('order_index', { ascending: true });

        const items = await Promise.all((rows || []).map(async r => {
            const [display, thumb, full] = await Promise.all([
                getTransformedUrl(r.path, 960, 3600, 72, null, 'contain'),
                getTransformedUrl(r.path, 220),
                getOriginalUrl(r.path)
            ]);
            return { display, thumb, full, caption: r.caption || '건물정보', createdAt: formatYMD(r.created_at)};
        }));
        if (!items.length) { showToast('이미지가 없습니다.'); return; }

        // 2) 제목용 메타: province city district detail_address + building_name
        const key = (addrKey || '').replace(/\s+/g, '').trim();

        const [biRes, oneListingRes] = await Promise.all([
            client.from('building_info')
            .select('building_name, full_address, addr_compare')
            .eq('addr_compare', key)
            .maybeSingle(),
            client.from('baikukdbtest')
            .select('province, city, district, detail_address')
            .eq('addr_compare', key)
            .limit(1)
            .maybeSingle()
        ]);

        const buildingName =
            (biRes?.data?.building_name && biRes.data.building_name !== '.') ? biRes.data.building_name : '';

        const p = oneListingRes?.data?.province ?? '';
        const c = oneListingRes?.data?.city ?? '';
        const d = oneListingRes?.data?.district ?? '';
        const da = oneListingRes?.data?.detail_address ?? '';

        const addressLine = [p, c, d, da].filter(Boolean).join(' ').trim();
        const pageTitle = [addressLine, buildingName].filter(Boolean).join(' · ') || '주소공용 이미지';

        // 3) 뷰어 열기
        openExternalViewerAdmin(items, startIndex, pageTitle);
    }


    // === 드래그&드롭 업로드 ===
    function setupDragAndDropUpload(listingId) {
        const dropzone = document.getElementById('img-dropzone');
        const input    = document.getElementById('img-upload-input');
        if (!dropzone || !input) return;

        const highlight = () => dropzone.style.borderColor = '#F2C130';
        const unlight   = () => dropzone.style.borderColor = '#d1d5db';

        ['dragenter','dragover'].forEach(evt =>
                dropzone.addEventListener(evt, e => {
                e.preventDefault(); e.stopPropagation(); highlight();
                })
            );
        ;['dragleave','dragend'].forEach(evt =>
                dropzone.addEventListener(evt, e => {
                e.preventDefault(); e.stopPropagation(); unlight();
                })
            );

        dropzone.addEventListener('drop', async (e) => {
            e.preventDefault(); e.stopPropagation(); unlight();
            if (!e.dataTransfer) return;

            // 1) 드래그된 항목에서 파일 수집 (폴더 지원)
            const files = await collectFilesFromDataTransfer(e.dataTransfer);

            if (!files.length) {
            showToast('가져올 수 있는 이미지가 없습니다.');
            return;
            }

            // 2) input.files 교체 (DataTransfer 이용)
            const dt = new DataTransfer();
            for (const f of files) dt.items.add(f);
            input.files = dt.files;

            // 3) 미리보기 갱신 (기존 함수 재활용)
            previewSelectedFiles();

            // (선택) 자동 업로드하고 싶으면 주석 해제:
            // await uploadSelectedImages(listingId);
        });
    }

    // DataTransfer에서 이미지 파일 수집 (폴더 재귀 탐색 포함)
    async function collectFilesFromDataTransfer(dt) {
        const out = [];

        // 크롬/엣지: webkitGetAsEntry로 폴더 탐색 가능
        if (dt.items && dt.items.length && dt.items[0].webkitGetAsEntry) {
            const entries = [];
            for (const item of dt.items) {
                const entry = item.webkitGetAsEntry?.();
                if (entry) entries.push(entry);
            }
            for (const entry of entries) {
                const files = await readEntryRecursive(entry);
                out.push(...files);
            }
        } else {
            // 파이어폭스 등: 파일만
            for (const f of dt.files || []) out.push(f);
        }

        // 이미지만 남기기
        return out.filter(f => (f.type || '').startsWith('image/'));
    }

    // 파일/폴더 엔트리 재귀 탐색
    function readEntryRecursive(entry) {
        return new Promise((resolve) => {
            if (entry.isFile) {
                entry.file(file => resolve([file]), () => resolve([]));
            } else if (entry.isDirectory) {
                const dirReader = entry.createReader();
                const all = [];
                const readBatch = () => {
                    dirReader.readEntries(async (entries) => {
                    if (!entries.length) return resolve(all);
                    for (const ent of entries) {
                        const files = await readEntryRecursive(ent);
                        all.push(...files);
                    }
                    readBatch();
                    }, () => resolve(all));
                };
                readBatch();
            } else {
                resolve([]);
            }
        });
    }

    // 사진수정창 닫는부분 헬퍼
    function closeSidePanel() {
        const sp = document.getElementById('side-panel');
        if (!sp) return;
        sp.classList.add('hidden');
        sp.innerHTML = '';
    }

    // 이미지 뷰어 관련 함수 가벼운 기본값으로(캐시는 3번 참고)
    async function getTransformedUrl(path, width = 480, expiresIn = 3600, quality = 48, height = null, resize = 'contain') {
        const hPart = height ? `|h${height}` : '';
        const rPart = resize ? `|r${resize}` : '';
        const key = `t:${path}|w${width}${hPart}|q${quality}|e${expiresIn}${rPart}`;
        return _memo(key, async () => {
            const transform = height ? { width, height, quality, resize } : { width, quality, resize };
            if (window.BUCKET_IS_PUBLIC !== false) {
            const { data } = client.storage.from(BUCKET).getPublicUrl(path, { transform });
            return data?.publicUrl || '';
            } else {
            const { data, error } = await client.storage.from(BUCKET)
                .createSignedUrl(path, expiresIn, { transform });
            if (error) { console.warn('signed url (transform) error:', error); }
            return data?.signedUrl || '';
            }
        });
    }

    async function getOriginalUrl(path, expiresIn = 3600) {
        const key = `o:${path}|e${expiresIn}`;
        return _memo(key, async () => {
            if (window.BUCKET_IS_PUBLIC !== false) {
            const { data } = client.storage.from(BUCKET).getPublicUrl(path);
            return data?.publicUrl || '';
            } else {
            const { data, error } = await client.storage.from(BUCKET)
                .createSignedUrl(path, expiresIn);
            if (error) { console.warn('signed url error:', error); }
            return data?.signedUrl || '';
            }
        });
    }

    // ================== 🧊 상세 썸네일 예열(디코드) ==================
    async function prewarmDetailThumbs(listingIds, {
        perListing = 2,         // 매물당 몇 장 미리?
        displayWidth = 900,     // 상세패널 표시용 변환폭
        timeout = 800,          // 디코딩 타임아웃(ms)
        maxListings = 60        // 한 번에 예열할 매물 수 상한
    } = {}) {
        const ids = [...new Set((listingIds||[]).map(String))].slice(0, maxListings);
        if (!ids.length) return;

        // 1) 해당 매물들의 (공개) 이미지 목록(대표 우선 → 순서) 가져오기
        const { data: rows, error } = await client
            .from('listing_images')
            .select('listing_id, path, is_primary, order_index')
            .in('listing_id', ids)
            .eq('is_private', false)
            .order('is_primary', { ascending: false })
            .order('order_index', { ascending: true });

        if (error || !rows?.length) return;

        // 2) 매물별 상위 N장만 추림
        const pickPaths = [];
        const pickedCount = new Map(); // listing_id -> count
        for (const r of rows) {
            const id = String(r.listing_id);
            const n = pickedCount.get(id) || 0;
            if (n < perListing) {
            pickPaths.push(r.path);
            pickedCount.set(id, n + 1);
            }
        }
        if (!pickPaths.length) return;

        // 3) 표시용 URL 발급(기존 캐시 유틸 재사용) → 디코딩
        const urls = await Promise.all(
            pickPaths.map(p => getTransformedUrl(p, displayWidth, 3600, 72).catch(()=>'')) // 품질·폭은 상황에 맞게 조정
        );
        const finalUrls = urls.filter(Boolean);
        if (!finalUrls.length) return;

        const loaders = finalUrls.map(u => {
            const img = new Image();
            img.decoding = 'async';
            img.loading  = 'eager';
            img.src = u;
            return img.decode ? img.decode().catch(()=>{}) : new Promise(res => {
            img.onload = img.onerror = () => res();
            });
        });

        await Promise.race([
            Promise.allSettled(loaders),
            new Promise(res => setTimeout(res, timeout))
        ]);
    }

    // ✅ 뷰어 열기 직전에 전체 아이템을 준비
    async function openViewerForListing(listingId, startIndex = 0, pageTitle = '이미지 보기', includePrivate = true) {
        // 공개 전부
        const { data: rowsPub } = await client
            .from('listing_images')
            .select('path, caption, order_index, is_primary, created_at')
            .eq('listing_id', String(listingId))
            .eq('is_private', false)
            .order('is_primary', { ascending: false })
            .order('order_index', { ascending: true });

        const itemsPublic = await Promise.all((rowsPub || []).map(async r => {
            const [display, thumb, full] = await Promise.all([
            getTransformedUrl(r.path, 640),  // ↓ 가볍게(아래 2번 참고)
            getTransformedUrl(r.path, 220),
            getOriginalUrl(r.path),
            ]);
            return { display, thumb, full, caption: r.caption || '', createdAt: formatYMD(r.created_at) };
        }));

        // 비공개는 진짜 볼 때만
        let itemsPrivate = [];
        if (includePrivate) {
            const { data: rowsPri } = await client
            .from('listing_images')
            .select('path, caption, order_index, created_at')
            .eq('listing_id', String(listingId))
            .eq('is_private', true)
            .order('order_index', { ascending: true });

            itemsPrivate = await Promise.all((rowsPri || []).map(async r => {
            const [display, thumb, full] = await Promise.all([
                getTransformedUrl(r.path, 640),
                getTransformedUrl(r.path, 220),
                getOriginalUrl(r.path),
            ]);
            return { display, thumb, full, caption: r.caption ? `🔒 ${r.caption}` : '🔒 비공개', createdAt: formatYMD(r.created_at) };
            }));
        }

        openExternalViewerAdmin([...itemsPublic, ...itemsPrivate], startIndex, pageTitle);
    }

    // ✅ 수정: 상세패널 2장만 먼저 (limit 2), 클릭시 전체 구성
    async function initImageViewer(listingId, opts = {}) {
        const wrap = document.getElementById('image-viewer');
        if (!wrap || !listingId) return;

        // 대표 2장만!
        const { data: rowsPub, error } = await client
            .from('listing_images')
            .select('path, caption, order_index, is_primary')
            .eq('listing_id', String(listingId))
            .eq('is_private', false)
            .order('is_primary', { ascending: false })
            .order('order_index', { ascending: true })
            .limit(2);

        if (error || !rowsPub?.length) { wrap.classList.add('hidden'); return; }

        // 가벼운 변환만 미리
        const items2 = await Promise.all(rowsPub.map(async r => ({
            display: await getTransformedUrl(r.path, 480, 3600, 60, 270, 'contain'),
            caption: r.caption || '',
            path: r.path,
        })));

        const img0 = document.getElementById('image-viewer-main-0');
        const img1 = document.getElementById('image-viewer-main-1');
        const listing = allListings?.[String(listingId)];
        const pageTitle = (listing?.listing_title || listing?.title || `매물 ${listingId} 이미지`).trim();

        if (img0 && items2[0]) {
            img0.loading = 'eager';
            img0.decoding = 'async';
            img0.setAttribute('fetchpriority', 'high');
            img0.src = items2[0].display;
            img0.onclick = () => openViewerForListing(listingId, 0, pageTitle, /*includePrivate*/ true);
        }
        if (img1 && items2[1]) {
            img1.classList.remove('hidden');
            img1.loading = 'lazy';
            img1.decoding = 'async';
            img1.setAttribute('fetchpriority', 'low');
            img1.src = items2[1].display;
            img1.onclick = () => openViewerForListing(listingId, 1, pageTitle, /*includePrivate*/ true);
        } else if (img1) {
            img1.classList.add('hidden');
        }

        wrap.classList.remove('hidden');
    }


    function openExternalViewerAdmin(items, startIndex = 0, pageTitle = '이미지 보기') {
        const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
        const html = `<!doctype html>
        <html lang="ko"><head>
            <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
            <title>${esc(pageTitle)}</title>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lightgallery.css">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lg-zoom.css">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lg-thumbnail.css">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lg-fullscreen.css">
            <style>
            body{margin:0;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;}
            #gallery{padding:8px;}
            html, body { -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; }
            .lg-outer img, .lg-thumb-outer img { -webkit-user-drag:none; }
            .meta-date {
                position: fixed; right: 16px; bottom: 12px; z-index: 99999;
                font-size: 12px; line-height: 1; color: #fff;
                background: rgba(0,0,0,0.5); padding: 6px 8px; border-radius: 6px;
                letter-spacing: .3px;
            }
            .lg-outer .lg-toolbar .lg-close { display:none !important; }
            </style>
        </head>
        <body>
            <div id="gallery"></div>
            <div id="meta-date" class="meta-date"></div>
            <script>
            function loadScript(src){return new Promise(r=>{const s=document.createElement('script');s.src=src;s.onload=r;document.head.appendChild(s);});}
            const items = ${JSON.stringify(items)};
            const start = ${Number(startIndex)};
            (async()=>{
                await loadScript('https://cdn.jsdelivr.net/npm/lightgallery/lightgallery.umd.js');
                await loadScript('https://cdn.jsdelivr.net/npm/lightgallery/plugins/zoom/lg-zoom.umd.js');
                await loadScript('https://cdn.jsdelivr.net/npm/lightgallery/plugins/thumbnail/lg-thumbnail.umd.js');
                await loadScript('https://cdn.jsdelivr.net/npm/lightgallery/plugins/fullscreen/lg-fullscreen.umd.js');

                // (팝업 HTML 내부 스크립트)
                const dynamicEl = items.map(it => ({
                    // ✅ 확대가 실제로 되게: src는 원본(full) 사용
                    src: it.full,
                    // 표시 성능은 display(축소본)로: responsive 사용하면 부드러워짐
                    responsive: it.display + ' 640w',
                    thumb: it.thumb,
                    subHtml: it.caption
                }));

                const index = Math.max(0, Math.min(start, Math.max(0, dynamicEl.length-1)));

                const lg = lightGallery(document.getElementById('gallery'), {
                    dynamic: true,
                    dynamicEl,
                    index,

                    // ✅ 플러그인 등록 (줌/썸네일/전체화면)
                    plugins: [lgZoom, lgThumbnail, lgFullscreen],

                    // 🔍 줌 관련 옵션
                    zoom: true,
                    actualSize: true,       // 원본 크기까지 확대
                    zoomFromOrigin: true,   // 썸네일/표시 이미지에서 확대 애니메이션
                    allowMediaOverlap: true,
                    closable: false,      // 배경 클릭으로 닫기 허용 (막고 싶으면 false)
                    escKey: false,        // ESC로 닫기 허용 (막고 싶으면 false)
                    closeOnTap: false,

                    // 기타
                    download: false,
                });
                lg.openGallery(index);


                // ▼ 하단 날짜 배지 업데이트
                const dateEl = document.getElementById('meta-date');
                function setDate(i){
                    const it = items?.[i];
                    dateEl.textContent = (it && it.createdAt) ? it.createdAt : '';
                    dateEl.style.display = dateEl.textContent ? 'block' : 'none';
                }
                setDate(index);
                lg.on('lgAfterSlide', (evt) => {
                    // evt.detail.index 가 현재 인덱스
                    const i = evt?.detail?.index ?? 0;
                    setDate(i);
                });

                // 라이트갤러리 영역만 우클릭/드래그 방지
                const protectCtx = (e) => { if (e.target.closest('.lg-outer')) e.preventDefault(); };
                document.addEventListener('contextmenu', protectCtx, { capture:true });
                document.addEventListener('dragstart', protectCtx, { capture:true });
            })();
            <\/script>
        </body></html>`;

        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const w = window.open(url, `img-viewer`, 'popup=yes,width=1280,height=800,menubar=no,toolbar=no,location=no,status=no,scrollbars=yes,resizable=yes');
        if(!w){ alert('팝업이 차단되었습니다. 팝업을 허용해주세요.'); URL.revokeObjectURL(url); return; }
        w.focus();
        setTimeout(() => URL.revokeObjectURL(url), 10000);
    }

    // 비공개사진 관련 함수들
    // --- 비공개: 미리보기 ---
    function previewSelectedFilesPrivate() {
        const input = document.getElementById('img-upload-input-private');
        const box   = document.getElementById('img-preview-list-private');
        if (!input || !box) return;

        // 로컬 URL 생성해서 미리보기
        const urls = [];
        box.innerHTML = '';
        for (const f of input.files || []) {
            const url = URL.createObjectURL(f);
            urls.push(url);
            const el = document.createElement('img');
            el.src = url;
            el.className = 'w-full h-24 object-cover rounded border';
            box.appendChild(el);
        }
        // 메모리 정리(선택): 창 닫을 때 revoke 필요하면 보강
    }

    // --- 비공개: 목록 로드 ---
    async function loadListingImagesPrivate(listingId) {
        const box = document.getElementById('img-list-private');
        if (!box) return;

        const { data: rows, error } = await client
            .from('listing_images')
            .select('id, path')
            .eq('listing_id', String(listingId))
            .eq('is_private', true)
            .order('order_index', { ascending: true });

        if (error) { console.error(error); return; }

        box.innerHTML = '';
        for (const r of rows) {
            const thumbUrl = await getTransformedUrl(r.path, 360);

            const wrap = document.createElement('div');
            wrap.className = 'relative group rounded overflow-hidden';

            const img = document.createElement('img');
            img.src = thumbUrl;
            img.className = 'w-full h-24 object-cover rounded border';

            // ✅ 선택 오버레이
            const outline = document.createElement('div');
            outline.className = 'pointer-events-none absolute inset-0 hidden ring-2 ring-blue-500 rounded';
            wrap.appendChild(outline);

            // 편집창에서는 항상 체크박스 표시(기본 선택모드)
            if (isEditMode) {
                const chk = document.createElement('input');
                chk.type = 'checkbox';
                chk.className = 'img-select absolute bottom-1 left-1 w-5 h-5 accent-blue-600 bg-white/90 rounded shadow';
                chk.dataset.id = r.id;
                chk.dataset.path = r.path;
                // 체크 상태에 따라 시각 표시 토글
                chk.addEventListener('change', () => {
                    outline.classList.toggle('hidden', !chk.checked);
                });
                wrap.appendChild(chk);
            }

            const del = document.createElement('button');
            del.textContent = '삭제';
            del.className = 'absolute top-1 right-1 bg-white/90 text-xs px-2 py-[2px] rounded border';
            del.onclick = () => deleteImagePrivate(r.id, r.path, listingId);

            wrap.appendChild(img);
            wrap.appendChild(del);
            box.appendChild(wrap);

            // 🔧 편집모드라면 툴바 보이기
            if (isEditMode) setupPublicBulkToolbar(listingId);
        }
    }

    // --- 비공개: 업로드 ---
    async function uploadSelectedImagesPrivate(listingId) {
        const input = document.getElementById('img-upload-input-private');
        const uploadBtn = document.getElementById('img-upload-btn-private');
        if (!input || !input.files?.length) { showToast('먼저 파일을 선택하세요.'); return; }

        const prevText = uploadBtn?.textContent;
        if (uploadBtn) { uploadBtn.disabled = true; uploadBtn.textContent = '업로드 중...'; }

        try {
            // 비공개 영역의 마지막 order_index
            let nextIndex = 0;
            try {
            const { data: last } = await client
                .from('listing_images')
                .select('order_index')
                .eq('listing_id', String(listingId))
                .eq('is_private', true)
                .order('order_index', { ascending: false })
                .limit(1)
                .maybeSingle();
            nextIndex = (last?.order_index ?? -1) + 1;
            } catch {}

            let successCount = 0;

            for (const f of input.files) {
            if (!f.type?.startsWith('image/')) { showToast('이미지 파일만 올릴 수 있어요.'); continue; }
            if (f.size > 10 * 1024 * 1024) { showToast('10MB 이하만 업로드 가능합니다.'); continue; }

            const id  = (crypto?.randomUUID && crypto.randomUUID()) || (Date.now() + '-' + Math.random().toString(16).slice(2));
            const ext = (f.type?.split('/')[1] || 'jpg').toLowerCase();
            const key = `listings/${listingId}/private/orig/${id}.${ext}`;  // ★ private 경로

            const { error: upErr } = await client.storage.from(BUCKET).upload(key, f, { upsert: false, contentType: f.type });
            if (upErr) { console.error('업로드 실패:', upErr); showToast('업로드 실패: ' + upErr.message); continue; }

            // 비공개는 대표개념 X
            const row = {
                listing_id: String(listingId),
                bucket: BUCKET,
                path: key,
                mime_type: f.type,
                order_index: nextIndex++,
                is_private: true,
                is_primary: false
            };

            const { error: dbErr } = await client.from('listing_images').insert(row);
            if (dbErr) {
                console.error('DB 기록 실패:', dbErr);
                showToast('DB 기록 실패: ' + dbErr.message);
                await client.storage.from(BUCKET).remove([key]);
                continue;
            }
            successCount++;
            }

            input.value = '';
            previewSelectedFilesPrivate();
            await loadListingImagesPrivate(listingId);
            showToast(successCount > 0 ? `업로드 완료 (${successCount}장)` : '업로드된 파일이 없습니다.');
        } finally {
            if (uploadBtn) { uploadBtn.disabled = false; uploadBtn.textContent = prevText || '업로드(비공개)'; }
        }
    }

    // --- 비공개: 삭제 ---
    async function deleteImagePrivate(rowId, path, listingId) {
        if (!confirm('이 이미지를 삭제할까요?')) return;

        const { error: dbErr } = await client.from('listing_images').delete().eq('id', rowId);
        if (dbErr) { showToast('DB 삭제 실패'); return; }

        const { error: stErr } = await client.storage.from(BUCKET).remove([path]);
        if (stErr) { showToast('스토리지 삭제 실패'); return; }

        await loadListingImagesPrivate(listingId);
        showToast('삭제 완료');
    }

    // --- 비공개: 드래그&드롭 ---
    function setupDragAndDropUploadPrivate(listingId) {
        const dropzone = document.getElementById('img-dropzone-private');
        const input    = document.getElementById('img-upload-input-private');
        if (!dropzone || !input) return;

        const highlight = () => dropzone.style.borderColor = '#F2C130';
        const unlight   = () => dropzone.style.borderColor = '#d1d5db';

        ['dragenter','dragover'].forEach(evt =>
            dropzone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); highlight(); })
        );
        ;['dragleave','dragend'].forEach(evt =>
            dropzone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); unlight(); })
        );

        dropzone.addEventListener('drop', async (e) => {
            e.preventDefault(); e.stopPropagation(); unlight();
            if (!e.dataTransfer) return;

            const files = await collectFilesFromDataTransfer(e.dataTransfer);
            if (!files.length) { showToast('가져올 수 있는 이미지가 없습니다.'); return; }

            const dt = new DataTransfer();
            for (const f of files) dt.items.add(f);
            input.files = dt.files;

            previewSelectedFilesPrivate();
            // 자동 업로드 원하면:
            // await uploadSelectedImagesPrivate(listingId);
        });
    }


    // 공개사진 관련 함수들
    function previewSelectedFiles() {
        const input = document.getElementById('img-upload-input');
        const box = document.getElementById('img-preview-list');
        if (!input || !box) return;

        // 이전 미리보기 정리
        _previewUrls.forEach(u => URL.revokeObjectURL(u));
        _previewUrls = [];
        box.innerHTML = '';

        for (const f of input.files || []) {
            const url = URL.createObjectURL(f);
            _previewUrls.push(url);
            const el = document.createElement('img');
            el.src = url;
            el.className = 'w-full h-24 object-cover rounded border';
            box.appendChild(el);
        }
    }

    // 저장된 이미지 목록 로드(썸네일로)
    async function loadListingImages(listingId) {
        const box = document.getElementById('img-list');
        if (!box) return;

        // DB에서 목록
        const { data: rows, error } = await client
            .from('listing_images')
            .select('id, path')
            .eq('listing_id', String(listingId))
            .eq('is_private', false)
            .order('order_index', { ascending: true });

        if (error) { console.error(error); return; }

        box.innerHTML = '';
        for (const r of rows) {
            // 공개 버킷이면 getPublicUrl이 가장 단순합니다.
            const thumbUrl = await getTransformedUrl(r.path, 360); // ✅ BUCKET_IS_PUBLIC 보고 알아서 서명/공개 선택


            const wrap = document.createElement('div');
            wrap.className = 'relative group rounded overflow-hidden';

            const img = document.createElement('img');
            img.src = thumbUrl;
            img.className = 'w-full h-24 object-cover rounded border';

            // ✅ 선택 시 표시될 오버레이(파란 테두리)
            const outline = document.createElement('div');
            outline.className = 'pointer-events-none absolute inset-0 hidden ring-2 ring-blue-500 rounded';
            wrap.appendChild(outline);

            // ✅ 선택모드일 때 체크박스 표시
            if (isEditMode) {
                const chk = document.createElement('input');
                chk.type = 'checkbox';
                chk.className = 'img-select absolute bottom-1 left-1 w-5 h-5 accent-blue-600 bg-white/90 rounded shadow';
                chk.dataset.id = r.id;
                chk.dataset.path = r.path;
                chk.addEventListener('change', () => {
                outline.classList.toggle('hidden', !chk.checked);
                });
                wrap.appendChild(chk);
            }

            // (선택) 삭제 버튼
            const del = document.createElement('button');
            del.textContent = '삭제';
            del.className = 'absolute top-1 right-1 bg-white/90 text-xs px-2 py-[2px] rounded border';
            del.onclick = () => deleteImage(r.id, r.path, listingId);

            wrap.appendChild(img);
            wrap.appendChild(del);
            box.appendChild(wrap);
        }
        if (isEditMode) setupPublicBulkToolbar(listingId);
    }

    // 사진 업로드
    async function uploadSelectedImages(listingId) {
        const input = document.getElementById('img-upload-input');
        const uploadBtn = document.getElementById('img-upload-btn');
        if (!input || !input.files?.length) {
            showToast('먼저 파일을 선택하세요.');
            return;
        }

        // 버튼 잠그기
        const prevText = uploadBtn?.textContent;
        if (uploadBtn) {
            uploadBtn.disabled = true;
            uploadBtn.textContent = '업로드 중...';
        }

        try {
            // 현재 마지막 order_index 구하기
            let nextIndex = 0;
            try {
            const { data: last } = await client
                .from('listing_images')
                .select('order_index')
                .eq('listing_id', String(listingId))
                .order('order_index', { ascending: false })
                .limit(1)
                .maybeSingle();
            nextIndex = (last?.order_index ?? -1) + 1;
            } catch {}

            // 대표사진 존재 여부
            let hasPrimary = false;
            try {
            const { data: primaryRow } = await client
                .from('listing_images')
                .select('id')
                .eq('listing_id', String(listingId))
                .eq('is_primary', true)
                .limit(1);
            hasPrimary = Array.isArray(primaryRow) && primaryRow.length > 0;
            } catch {}

            let successCount = 0;

            for (const f of input.files) {
            // 간단한 유효성 검사
            if (!f.type?.startsWith('image/')) { showToast('이미지 파일만 올릴 수 있어요.'); continue; }
            if (f.size > 10 * 1024 * 1024) { showToast('10MB 이하만 업로드 가능합니다.'); continue; }

            // 경로: listings/{listingId}/orig/{uuid}.{ext}
            const id = (crypto?.randomUUID && crypto.randomUUID())
                    || (Date.now() + '-' + Math.random().toString(16).slice(2));
            const ext = (f.type?.split('/')[1] || 'jpg').toLowerCase();
            const key = `listings/${listingId}/orig/${id}.${ext}`;

            // 1) 스토리지 업로드
            const { error: upErr } = await client
                .storage.from(BUCKET)
                .upload(key, f, { upsert: false, contentType: f.type });

            if (upErr) {
                console.error('업로드 실패:', upErr);
                showToast('업로드 실패: ' + upErr.message);
                continue;
            }

            // 2) DB 기록 (순서/대표 설정 포함)
            const row = {
                listing_id: String(listingId),
                bucket: BUCKET,
                path: key,
                mime_type: f.type,
                order_index: nextIndex++,
                // 대표사진이 아직 없으면, 이번 업로드 묶음 중 첫 장을 대표로
                is_primary: hasPrimary ? false : successCount === 0
            };

            const { error: dbErr } = await client
                .from('listing_images')
                .insert(row);

            if (dbErr) {
                console.error('DB 기록 실패:', dbErr);
                showToast('DB 기록 실패: ' + dbErr.message);
                // 롤백: 스토리지에서 방금 올린 파일 삭제
                await client.storage.from(BUCKET).remove([key]);
                continue;
            }

            if (row.is_primary) hasPrimary = true;
            successCount++;
            }

            // 초기화 & 목록 갱신
            input.value = '';
            previewSelectedFiles(); // 미리보기 비우기
            await loadListingImages(listingId);
            await initImageViewer(listingId);
            showToast(successCount > 0 ? `업로드 완료 (${successCount}장)` : '업로드된 파일이 없습니다.');
        } finally {
            if (uploadBtn) {
            uploadBtn.disabled = false;
            uploadBtn.textContent = prevText || '업로드';
            }
        }
    }


    // 삭제(선택)
    async function deleteImage(rowId, path, listingId) {
        if (!confirm('이 이미지를 삭제할까요?')) return;

        // 1) DB 삭제
        const { error: dbErr } = await client
            .from('listing_images')
            .delete()
            .eq('id', rowId);
        if (dbErr) { showToast('DB 삭제 실패'); return; }

        // 2) 스토리지 삭제
        const { error: stErr } = await client
            .storage.from(BUCKET)
            .remove([path]);
        if (stErr) { showToast('스토리지 삭제 실패'); return; }

        await loadListingImages(listingId);
        showToast('삭제 완료');
    }

    // '호'와 공백 제거해서 비교용으로 정규화
    function normalizeUnit(s) {
        return (s ?? '').toString().replace(/\s+/g, '').replace(/호/g, '').trim();
    }

    //중복매물 검사함수
    // 공백/‘호’ 제거는 기존 normalizeUnit 그대로 사용
    function getAddressPartsForDupCheck() {
        const v = (id) => (document.getElementById(id)?.value || '').trim();
        return {
            province: v('province'),
            city: v('city'),
            district: v('district'),
            detail_address: v('detail-address-input'), // 빈 문자열이면 그대로 사용
        };
    }

    async function checkDuplicateAndNavigateByParts(parts, unitValue) {
        try {
            const currentId = String(window.currentDetailListingId ?? '');
            const targetUnitNorm = normalizeUnit(unitValue);

            // 현재 선택된(또는 기존) 거래유형 확보
            const targetDealType = (
                document.getElementById('dealTypeSelect')?.value ||
                allListings?.[currentId]?.deal_type ||
                ''
            ).trim();

            // 최소한 시/도, 시/군/구, 읍/면/동은 있어야 의미 있음
            if (!parts.province || !parts.city || !parts.district) return false;

            let q = client
                .from('baikukdbtest')
                .select('listing_id, unit_info, deal_type') // ★ deal_type 포함
                .eq('province', parts.province)
                .eq('city', parts.city)
                .eq('district', parts.district);

            if (parts.detail_address) {
                q = q.eq('detail_address', parts.detail_address);
            }

            // ★ 현재 deal_type을 알고 있으면 동종만 조회(불필요한 레코드 감소)
            if (targetDealType) q = q.eq('deal_type', targetDealType);

            const { data, error } = await q;
            if (error) return false;

            const dupRow = (data || []).find((row) => {
                const rowUnitNorm = normalizeUnit(row.unit_info);
                const sameUnit = rowUnitNorm && rowUnitNorm === targetUnitNorm;
                const differentId = String(row.listing_id) !== currentId;
                const sameDealType = String(row.deal_type || '').trim() === targetDealType; // ★ 핵심
                return sameUnit && differentId && sameDealType;
            });

            if (dupRow) {
            showToast('중복매물입니다. 해당 매물로 이동합니다.', 2000);
            setTimeout(() => {
                if (typeof openDeepLink === 'function') openDeepLink(dupRow.listing_id);
                else go(`/admin?id=${dupRow.listing_id}`);
            }, 400);
            return true;
            }
            return false;
        } catch {
            return false;
        }
    }

    //호수 확인 관련함수
    function askUnitInfo() {
        return new Promise((resolve) => {
            const modal = document.getElementById('unit-modal');
            const input = document.getElementById('unit-modal-input');
            const btnYes = document.getElementById('unit-modal-yes');
            const btnNo  = document.getElementById('unit-modal-no');

            // 현재 값 있으면 미리 채워주기
            const current = document.getElementById('unit_info')?.value || '';
            input.value = current;

            const show = () => {
                modal.classList.remove('hidden');
                setTimeout(() => input.focus(), 0);
            };
            const hide = () => modal.classList.add('hidden');

            const cleanup = () => {
                btnYes.removeEventListener('click', onYes);
                btnNo.removeEventListener('click', onNo);
                input.removeEventListener('keydown', onKey);
            };
            const onYes = () => {
                const value = input.value.trim();
                hide(); cleanup();
                resolve({ confirmed: true, value });
            };
            const onNo = () => {
                hide(); cleanup();
                resolve({ confirmed: false, value: '' });
            };
            const onKey = (e) => {
                if (e.key === 'Enter') onYes();
                if (e.key === 'Escape') onNo();
            };

            btnYes.addEventListener('click', onYes);
            btnNo.addEventListener('click', onNo);
            input.addEventListener('keydown', onKey);

            show();
        });
    }


    // 시군구 선택관련
    // 한 번 불러오면 재사용 (토글 시 재요청 방지)
    let _pcdCache = null;

    /**
     * province_city_district 전체 로딩 (배치)
     * @param {number} batchSize - 페이지 크기(기본 1000)
     */
    async function fetchAllPCD(batchSize = 1000) {
    if (_pcdCache) return _pcdCache;

    let from = 0;
    let all = [];

    while (true) {
        const to = from + batchSize - 1; // range는 양끝 포함
        const { data, error } = await client
        .from('province_city_district')
        .select('province, city, district')
        // 페이지 간 정렬 일관성을 위해 고정 정렬 권장
        .order('province', { ascending: true })
        .order('city', { ascending: true })
        .order('district', { ascending: true })
        .range(from, to);

        if (error) throw error;

        all = all.concat(data || []);
        if (!data || data.length < batchSize) break; // 마지막 페이지
        from += batchSize;
    }

    _pcdCache = all;
    return all;
    }

    // ===== 지역(시/도-시/군/구-읍/면/동) 의존형 드롭다운 =====
    async function initLocationSelects(listing) {
        const provinceEl = document.getElementById('province');
        const cityEl = document.getElementById('city');
        const districtEl = document.getElementById('district');
        if (!provinceEl || !cityEl || !districtEl) return;

        const setPlaceholder = () => {
            provinceEl.innerHTML = `<option value="">시/도</option>`;
            cityEl.innerHTML     = `<option value="">시/군/구</option>`;
            districtEl.innerHTML = `<option value="">읍/면/동</option>`;
        };
        setPlaceholder();

        let rows = [];
        try {
            rows = await fetchAllPCD(1000); // 필요시 2000 등으로 올려도 OK
        } catch (e) {
            console.error('지역 데이터 로드 실패:', e);
            // 실패 시에도 현재 값은 보이도록
            fillSelect(provinceEl, listing.province ? [listing.province] : [], listing.province);
            fillSelect(cityEl, listing.city ? [listing.city] : [], listing.city);
            fillSelect(districtEl, listing.district ? [listing.district] : [], listing.district);
            return;
        }

        const collate = new Intl.Collator('ko-KR');
        const uniq = arr => Array.from(new Set(arr));
        const sortKo = arr => arr.sort((a,b)=>collate.compare(a,b));

        const citiesByProv = new Map();        // province -> Set(cities)
        const distsByProvCity = new Map();     // `${province}|${city}` -> Set(districts)

        for (const { province, city, district } of rows) {
            if (!province || !city || !district) continue;
            if (!citiesByProv.has(province)) citiesByProv.set(province, new Set());
            citiesByProv.get(province).add(city);

            const key = `${province}|${city}`;
            if (!distsByProvCity.has(key)) distsByProvCity.set(key, new Set());
            distsByProvCity.get(key).add(district);
        }

        const provinces = sortKo(uniq(rows.map(r => r.province).filter(Boolean)));

        function fillSelect(selectEl, values, selected) {
            selectEl.innerHTML = '';
            const ph = document.createElement('option');
            ph.value = '';
            ph.textContent = selectEl === provinceEl ? '시/도' : (selectEl === cityEl ? '시/군/구' : '읍/면/동');
            selectEl.appendChild(ph);

            // 현재 저장된 값이 목록에 없으면 맨 위에 먼저 보여주기
            let list = [...values];
            if (selected && !values.includes(selected)) list = [selected, ...values];

            for (const v of list) {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = v;
            if (selected && v === selected) opt.selected = true;
            selectEl.appendChild(opt);
            }
        }

        // 1) province
        fillSelect(provinceEl, provinces, listing.province);

        // 2) city (province에 종속)
        const selProvince = provinceEl.value || listing.province || '';
        const cities = selProvince ? sortKo(uniq([...(citiesByProv.get(selProvince) || [])])) : [];
        fillSelect(cityEl, cities, listing.city);

        // 3) district (province+city에 종속)
        const selCity = cityEl.value || listing.city || '';
        const key = `${selProvince}|${selCity}`;
        const districts = (selProvince && selCity) ? sortKo(uniq([...(distsByProvCity.get(key) || [])])) : [];
        fillSelect(districtEl, districts, listing.district);

        // 변화 이벤트
        provinceEl.onchange = () => {
            const p = provinceEl.value;
            const cities2 = p ? sortKo(uniq([...(citiesByProv.get(p) || [])])) : [];
            fillSelect(cityEl, cities2, '');
            fillSelect(districtEl, [], ''); // 초기화
        };

        cityEl.onchange = () => {
            const p = provinceEl.value;
            const c = cityEl.value;
            const k = `${p}|${c}`;
            const d2 = (p && c) ? sortKo(uniq([...(distsByProvCity.get(k) || [])])) : [];
            fillSelect(districtEl, d2, '');
        };
    }


    // === 딥링크 유틸: ?id=12345 ===
    function getListingIdFromURL() {
        const sp = new URLSearchParams(location.search);
        const qId = sp.get('id');
        return qId && /^\d+$/.test(qId) ? qId : null;
    }

    function updateURLForListing(listingId, replace = false) {
        const url = new URL(location.href);
        if (listingId) url.searchParams.set('id', String(listingId));
        else url.searchParams.delete('id');
        try {
            history[replace ? 'replaceState' : 'pushState']({}, '', url);
        } catch (_) {}
    }

    // openDeepLink 교체 (두 번째 인자 skipUrl=false 추가)
    async function openDeepLink(listingId, skipUrl = false) {
        if (!listingId) return;
        const id = String(listingId);

        if (!allListings[id]) {
            const { data, error } = await client
            .from('baikukdbtest')
            .select('*')
            .eq('listing_id', id)
            .maybeSingle();

            if (error || !data) { alert('해당 매물을 찾지 못했습니다.'); return; }

            try {
            const key = (data.addr_compare || '').replace(/\s+/g,'').trim();
            if (key) {
                const { data: bi } = await client
                .from('building_info')
                .select('building_name, building_note, addr_compare')
                .eq('addr_compare', key)
                .maybeSingle();
                if (bi) {
                data.building_name = bi.building_name ?? data.building_name ?? '-';
                data.building_note = bi.building_note ?? data.building_note ?? '-';
                }
            }
            } catch(e) {}

            allListings[id] = data;
        }

        const l = allListings[id];
        if (map && l?.lat && l?.lng) {
            map.setCenter(new kakao.maps.LatLng(l.lat, l.lng));
            map.setLevel(3);
        }

        if (typeof showDetailPanel === 'function') showDetailPanel(id);

        if (!skipUrl) updateURLForListing(id, /*replace*/true);
    }


    // 브라우저 뒤/앞 이동 대응
    window.addEventListener('popstate', () => {
        const id = getListingIdFromURL();
        if (id) openDeepLink(id, /*skipUrl*/true);
        else hideDetailPanel(/*skipUrl*/true);
    });

    // 소숫점 두번째자리까지만 표시함수
    function formatNumber2(num) {
        if (num === null || num === undefined || num === '' || isNaN(num)) return '';
        return parseFloat(num).toFixed(2).replace(/\.?0+$/, ''); 
        // 예) 10.50 → "10.5", 10.00 → "10"
    }

    // 수정모드에서 지도 검색버튼눌렀을 때 마커표시 관련 함수
    // 주소 파트 합치기
    function buildFullAddress() {
        const getVal = (id) => (document.getElementById(id)?.value || '').trim();
        const parts = [getVal('province'), getVal('city'), getVal('district'), getVal('detail-address-input')];
        return parts.filter(Boolean).join(' ').replace(/\s+/g, ' ').trim();
    }

    // 지오코딩해서 지도/마커 이동
    async function searchAndMoveMarker() {
        if (!window.previewMap || !window.previewMarker) {
            showToast('미리보기 지도가 아직 준비되지 않았습니다.', 2500);
            return;
        }

        // 1) 호수 입력 모달 (이미 구현한 부분)
        try {
            const { confirmed, value } = await askUnitInfo();
            if (confirmed) {
            const unitEl = document.getElementById('unit_info');
            if (unitEl) unitEl.value = value.trim();
            }
        } catch (e) {
            console.warn('호수 입력 모달 에러:', e);
        }

        // 2) 주소 문자열 만들기
        const fullAddr = buildFullAddress();
        if (!fullAddr) {
            showToast('주소를 입력해주세요.', 2500);
            return;
        }

        const parts = getAddressPartsForDupCheck();
        const unitVal = (document.getElementById('unit_info')?.value || '').trim();
        if (unitVal) {
            const dup = await checkDuplicateAndNavigateByParts(parts, unitVal);
            if (dup) return; // 중복이면 여기서 끝
        }

        // 5) 중복이 아니면 기존 지오코딩 + GRIS 트리거 계속 진행
        const geocoder = new kakao.maps.services.Geocoder();
        geocoder.addressSearch(fullAddr, (result, status) => {
            if (status === kakao.maps.services.Status.OK && result?.length) {
                const y = parseFloat(result[0].y), x = parseFloat(result[0].x);
                const coords = new kakao.maps.LatLng(y, x);

                window.previewMarker.setPosition(coords);
                window.previewMap.panTo(coords);
                window._previewLatLng = { lat: y, lng: x };

                showToast('지도 위치가 업데이트되었습니다.');
            } else {
                showToast('주소를 찾지 못했습니다. 입력값을 확인해주세요.', 3000);
            }
        });
    }

    // 호수, 건물명 높이 조절 함수
    // 보기 박스 높이로 줄수 계산(최대 2줄), 줄높이 픽셀도 같이 보관
    function measureLinesById(id, max=2) {
        const el = document.getElementById(id);
        if (!el) return { lines: 1, lineHeight: 20 };

        const cs = getComputedStyle(el);
        let lh = parseFloat(cs.lineHeight);
        if (Number.isNaN(lh)) {
            // 혹시 숫자로 못 읽으면 폰트크기*1.4 사용 (two-line의 line-height:1.4 기준)
            lh = (parseFloat(cs.fontSize) || 14) * 1.4;
        }
        const pt = parseFloat(cs.paddingTop) || 0;
        const pb = parseFloat(cs.paddingBottom) || 0;
        const contentH = el.clientHeight - pt - pb;
        const rawLines = contentH / lh;
        const lines = Math.max(1, Math.min(max, Math.round(rawLines)));
        return { lines, lineHeight: lh };
    }
    // textarea를 지정한 줄수로 “정확히” 맞추기
    function applyLinesToTextarea(id, state) {
        const ta = document.getElementById(id);
        if (!ta || !state) return;

        const cs = getComputedStyle(ta);
        const pt = parseFloat(cs.paddingTop) || 0;
        const pb = parseFloat(cs.paddingBottom) || 0;
        const bt = parseFloat(cs.borderTopWidth) || 0;
        const bb = parseFloat(cs.borderBottomWidth) || 0;

        ta.style.lineHeight = state.lineHeight + 'px';
        ta.style.boxSizing = 'border-box';
        ta.style.height = (state.lines * state.lineHeight + pt + pb + bt + bb) + 'px';
        ta.style.overflow = 'hidden';
        ta.rows = state.lines; // 보조
    }
    // 줄수 캐시 (보기→수정 전환할 때 저장)
    const _lineSyncCache = {
        building_name: { lines: 1, lineHeight: 20 },
        unit_info:     { lines: 1, lineHeight: 20 },
        restroom:      { lines: 1, lineHeight: 20 },
        store_type_detail:   { lines: 1, lineHeight: 20 },
        title:   { lines: 1, lineHeight: 20 }
    };


    function resetNumericFilters() {
        filterDefs.forEach(def => {
            const minEl = document.getElementById(`${def.id}_min`);
            const maxEl = document.getElementById(`${def.id}_max`);
            if (minEl) minEl.value = "";
            if (maxEl) maxEl.value = "";
            updateFilterButtonText(def.id);
        });
    }

    function resetFilters() {
        resetNumericFilters();
        selectedCategories = ['상가'];
        selectedDealTypes = ['월세'];      
        renderDealAndCategoryButtons();
        resetSelectFiltersToDefault();// ⬇️ 진행상태를 '진행중'만 선택으로 초기화
        updateFilteredListingsDebounced();
    }

    function renderFilterButtons() {
        const wrap = document.getElementById('filter-btns-wrap');
        wrap.innerHTML = '';
        filterDefs.forEach(def => {
            const btn = document.createElement('button');
            btn.id = `filter-btn-${def.id}`;
            btn.setAttribute('data-default-label', def.label + ' ▼');
            btn.className = "px-2 py-2 border border-gray-300 bg-white rounded-md shadow-sm text-[14px] text-gray-800 font-medium hover:bg-gray-100";
            btn.innerText = def.label + ' ▼';
            btn.onclick = () => toggleFilterPanel(def.id);

            const panel = document.createElement('div');
            panel.id = `filter-panel-${def.id}`;
            panel.className = `hidden absolute left-0 mt-1 bg-white border rounded shadow z-50`;
            panel.style.width = `${def.width}px`;
            panel.innerHTML = `<div class="flex items-center gap-2 p-3">
                <input id="${def.id}_min" type="number" placeholder="이상" class="w-20 px-2 py-1 border rounded text-sm" />
                <span class="text-gray-500">~</span>
                <input id="${def.id}_max" type="number" placeholder="이하" class="w-20 px-2 py-1 border rounded text-sm" />
            </div>`;
            
            const box = document.createElement('div');
            box.className = 'relative';
            box.appendChild(btn);
            box.appendChild(panel);
            wrap.appendChild(box);

            setTimeout(() => {
                const minInput = document.getElementById(`${def.id}_min`);
                const maxInput = document.getElementById(`${def.id}_max`);
                const update = () => {
                    updateFilterButtonText(def.id);
                    updateFilteredListingsDebounced();
                };
                if (minInput) minInput.addEventListener('input', update);
                if (maxInput) maxInput.addEventListener('input', update);
            }, 0);
        });
    }

    function createClusterer(gridSize) {
        if (clusterer && gridSize === currentGridSize) return;
        currentGridSize = gridSize;

        if (clusterer) clusterer.clear();

        clusterer = new kakao.maps.MarkerClusterer({
            map: map,
            averageCenter: true,
            minLevel: 1,
            minClusterSize: 1,
            disableClickZoom: true,
            gridSize: gridSize,
            styles: [{
            width: '40px', height: '40px', background: HIGHLIGHT_COLOR,
            border: '2px solid #F2C130', borderRadius: '50%', color: '#fff',
            fontWeight: 'bold', textAlign: 'center', lineHeight: '40px'
            }]
        });

        // 클릭: 스타일 토글 + 리스트 패널 표시 (기존 유지)
        kakao.maps.event.addListener(clusterer, 'clusterclick', function(cluster) {
            if (selectedClusterEl) {
            selectedClusterEl.style.border = "none";
            selectedClusterEl.style.borderRadius = "50%";
            const prevInner = selectedClusterEl.querySelector('div');
            if (prevInner) {
                prevInner.style.background = HIGHLIGHT_COLOR;
                prevInner.style.color = "#fff";
            }
            }

            const clusterEl = cluster.getClusterMarker().getContent().parentNode;
            if (clusterEl) {
                clusterEl.style.background = "transparent";
                clusterEl.style.border = "2px solid #F2C130";
                clusterEl.style.borderRadius = "50%";
                const inner = clusterEl.querySelector('div');
                if (inner) {
                    inner.style.background = "#ffffff";
                    inner.style.color = "#F2C130";
                    inner.style.borderRadius = "50%";
                }
                selectedClusterEl = clusterEl;
            }

            const markerList = cluster.getMarkers();
            const listings = markerList
            .map(mk => allListings[String(mk.listing_id)])
            .filter(Boolean);

            // ✅ 스크롤 초기화
            detailScrollTop = 0;
            showListingsInPanel(listings);

            // ✅ 클릭한 클러스터의 매물들 상세이미지(대표 1~2장) 미리 디코딩
            prewarmDetailThumbs(
                listings.map(l => l.listing_id),
                { perListing: 2, displayWidth: 900, timeout: 800, maxListings: 60 }
            ).catch(()=>{});
        });

        // Hover 시 스타일(기존 유지)
        const setupClusterHoverEvent = (eventName, style) => {
            kakao.maps.event.addListener(clusterer, eventName, function(cluster) {
            const el = cluster.getClusterMarker().getContent()?.parentNode;
            if (el) Object.assign(el.style, style);
            });
        };
        setupClusterHoverEvent('clusterover', { border: '3px solid white', borderRadius: '50%' });
        setupClusterHoverEvent('clusterout',  { border: 'none' });

    }

    /*************************
     * 다중선택 셀렉트 버튼 필터
     * - filter-btns-wrap와 동일한 버튼 UI
     * - 값 다중 선택 가능
     *************************/


    // 버튼 렌더링
    function renderSelectFilter({ containerId = 'select-filter-wrap', field, label = '', options = [] }) {
        const wrap = document.getElementById(containerId);
        if (!wrap) return;

        // 컨테이너 비우고 라벨 + 버튼 묶음 생성
        wrap.innerHTML = '';
        const group = document.createElement('div');
        group.className = 'flex flex-wrap items-center gap-2';

        if (label) {
            const title = document.createElement('div');
            title.className = 'text-[13px] text-gray-700 font-semibold mr-1';
            title.textContent = label;
            group.appendChild(title);
        }

        // 선택 상태 보장
        if (!Array.isArray(selectFilterState[field])) selectFilterState[field] = [];

        // 버튼 생성 함수
        const makeBtn = (text, value) => {
            const isSelected = selectFilterState[field].includes(value);
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.textContent = isSelected ? '✓ ' + text : text;
            btn.className = "px-3 py-2 rounded-full border border-gray-300 text-[13px] font-medium transition mr-0";
            if (isSelected) {
            Object.assign(btn.style, { 
                backgroundColor: HIGHLIGHT_COLOR, 
                color: HIGHLIGHT_TEXT_COLOR, 
                fontWeight: 'bold', 
                borderColor: "#eab308" 
            });
            } else {
            Object.assign(btn.style, { 
                backgroundColor: DEFAULT_BTN_BG, 
                color: DEFAULT_BTN_TEXT, 
                fontWeight: 'normal', 
                borderColor: "#d1d5db" 
            });
            }

            btn.onclick = () => {
            toggleSelectFilter(field, value);
            };
            return btn;
        };

        // 옵션 버튼들
        options.forEach(opt => group.appendChild(makeBtn(opt, opt)));

        wrap.appendChild(group);
    }

    // 토글 동작
    function toggleSelectFilter(field, value) {
        if (!Array.isArray(selectFilterState[field])) selectFilterState[field] = [];
        const arr = selectFilterState[field];
        const idx = arr.indexOf(value);
        if (idx >= 0) arr.splice(idx, 1); else arr.push(value);
        // UI 다시 그림
        renderSelectFilter({
            containerId: 'select-filter-wrap',
            field,
            // label, options은 마지막 렌더 시 전달된 걸 기억하지 못하므로,
            // 아래 init 예시처럼 매번 같은 파라미터로 호출해 주는 것이 안전합니다.
            label: window.__selectFilterMeta?.[field]?.label || '',
            options: window.__selectFilterMeta?.[field]?.options || []
        });
        // 필터 재적용
        updateFilteredListingsDebounced();
    }

    // ⬇️ 다중선택 필터를 기본값으로 되돌리는 헬퍼
    function resetSelectFiltersToDefault() {
        // 기본 상태: transaction_status = ['진행중']
        if (!window.__selectFilterMeta) window.__selectFilterMeta = {};
        if (!selectFilterState) window.selectFilterState = {};

        selectFilterState.transaction_status = ['진행중'];

        // UI 다시 렌더
        if (document.getElementById('select-filter-wrap')) {
            renderSelectFilter({
                containerId: 'select-filter-wrap',
                field: 'transaction_status',
                label: window.__selectFilterMeta?.transaction_status?.label || '진행상태',
                options: window.__selectFilterMeta?.transaction_status?.options || ['진행중', '계약완료', '-']
            });
        }
    }


    function renderDealAndCategoryButtons() {
        const btnWrap = document.getElementById('btn-wrap');
        btnWrap.innerHTML = '';

        const createButton = (text, isSelected, onClick) => {
            const btn = document.createElement('button');
            btn.textContent = isSelected ? '✓ ' + text : text;
            btn.className = "px-3 py-2 rounded-full border border-gray-300 text-[13px] font-medium transition mr-0";
            btn.onclick = onClick;
            if (isSelected) {
                Object.assign(btn.style, { backgroundColor: HIGHLIGHT_COLOR, color: HIGHLIGHT_TEXT_COLOR, fontWeight: 'bold', borderColor: "#eab308" });
            } else {
                Object.assign(btn.style, { backgroundColor: DEFAULT_BTN_BG, color: DEFAULT_BTN_TEXT, fontWeight: 'normal', borderColor: "#d1d5db" });
            }
            btnWrap.appendChild(btn);
        };

        allDealTypes.forEach(type => createButton(type, selectedDealTypes.includes(type), () => toggleDealType(type)));
        allCategories.forEach(cat => createButton(cat, selectedCategories.includes(cat), () => toggleCategory(cat)));
    }

    function toggleDealType(type) {
        if (selectedDealTypes.includes(type)) {
            if (selectedDealTypes.length > 1) selectedDealTypes = selectedDealTypes.filter(x => x !== type);
        } else {
            selectedDealTypes.push(type);
        }
        renderDealAndCategoryButtons();
        updateFilteredListingsDebounced();
    }
    
    function toggleCategory(cat) {
        if (selectedCategories.includes(cat)) {
            if (selectedCategories.length > 1) selectedCategories = selectedCategories.filter(c => c !== cat);
        } else {
            selectedCategories.push(cat);
        }
        renderDealAndCategoryButtons();
        updateFilteredListingsDebounced();
    }

    // 전역 가정: isEditMode, _lineSyncCache, showToast,
    // saveAgentNameIfChanged(listingId), saveListingDetails(listingId),
    // measureLinesById(id), showDetailPanel(listingId)

    async function toggleEditMode() {
        const listingId = window.currentDetailListingId;
        if (!listingId) {
            showToast('매물을 먼저 선택해 주세요.');
            return;
        }

        // 현재 패널 스크롤 저장
        const panelContent = document.getElementById('detail-content');
        if (panelContent) {
            detailScrollTop = panelContent.scrollTop;
        }

        // 무조건 오버레이 추가 (작업 중 클릭 방지)
        const overlay = document.createElement('div');
        overlay.id = 'black-overlay';
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.right = '0';
        overlay.style.bottom = '0';
        overlay.style.background = 'black';
        overlay.style.opacity = '0.8';
        overlay.style.zIndex = '99999';
        document.body.appendChild(overlay);

        try {
            // 보기 → 수정 들어가기 전에 보기모드 줄수 측정해서 캐시에 저장
            if (!isEditMode) {
            _lineSyncCache.building_name     = measureLinesById('building_name_view');
            _lineSyncCache.unit_info         = measureLinesById('unit_info_view');
            _lineSyncCache.restroom          = measureLinesById('restroom_view');
            _lineSyncCache.store_type_detail = measureLinesById('store_type_detail_view');
            _lineSyncCache.title             = measureLinesById('title_view');
            }

            // 수정 → 보기로 나갈 때만 저장 시도
            if (isEditMode) {
            // 1) 담당자 변경이 있으면 먼저 저장 (권한/정책 위반 시 토스트로 안내되고 false 반환하도록 구현되어 있다고 가정)
            const okAgent = await saveAgentNameIfChanged(listingId);
            if (!okAgent) {
                // 담당자 저장 실패 시 전체 저장 중단 (빈 값 저장 방지)
                showToast('담당자 변경을 저장하지 못했습니다.');
                return;
            }

            // 2) 나머지 필드 저장
            await saveListingDetails(listingId);
            }

            // 모드 토글
            isEditMode = !isEditMode;

            // 패널 다시 렌더링
            await showDetailPanel(listingId);

            // 스크롤 복원
            const newPanel = document.getElementById('detail-content');
            if (newPanel && typeof detailScrollTop === 'number') {
            newPanel.scrollTop = detailScrollTop;
            }
        } catch (err) {
            console.error(err);
            showToast('저장/전환 중 오류가 발생했습니다.');
        } finally {
            // 오버레이 제거
            const exist = document.getElementById('black-overlay');
            if (exist) exist.remove();
        }
    }
    
    // ✅ 업무일지 관련 함수
    function renderWorkLogs(workLogs) {
        console.log("🧾 업무일지 렌더링 중... 데이터:", workLogs);  // ✅ 3

        if (!Array.isArray(workLogs) || workLogs.length === 0) {
            return `<div class="text-sm text-gray-400 mt-2">📭 등록된 업무일지가 없습니다.</div>`;
        }

        return workLogs.map(log => {
            const date = new Date(log.Registration_date).toLocaleString("ko-KR");
            return `
                <div class="border border-gray-300 rounded px-3 py-0 mb-0 text-sm bg-white">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-gray-800">📌 ${log.type}</span>
                        <span class="text-gray-500 text-xs">${date}</span>
                    </div>
                    <div class="text-gray-700 mb-1">👤 ${log.agent_name}</div>
                    <div class="text-gray-600 whitespace-pre-line">${log.contents}</div>
                </div>
            `;
        }).join('');
    }

    function renderWorkLogPanel(workLogs) {
        const container = document.getElementById("work-log-content");

        function formatDate1(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            if (isNaN(d)) return '';
            const pad = n => String(n).padStart(2, '0');

            const yy = String(d.getUTCFullYear()).slice(-2);
            const mm = pad(d.getUTCMonth() + 1);
            const dd = pad(d.getUTCDate());
            const hh = pad(d.getUTCHours());

            return `${yy}${mm}${dd}`;
        }

        function formatDate2(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            if (isNaN(d)) return '';
            const pad = n => String(n).padStart(2, '0');

            const yy = String(d.getUTCFullYear()).slice(-2);
            const mm = pad(d.getUTCMonth() + 1);
            const dd = pad(d.getUTCDate());
            const hh = pad(d.getUTCHours());

            return `${hh}`;
        }



        const filteredLogs = workLogs.filter(log => log.type === "입력");

        const logsHTML = filteredLogs.length
            ? filteredLogs.map(log => {
                const content = (log.contents || '').trim().replace(/\n{2,}/g, '\n').replace(/\n/g, '<br>');

                // 대/소문자 모두 대응 (없으면 null)
                const regDate = log.Registration_date ?? log.registration_date ?? null;
                const dateHtml1 = regDate ? formatDate1(regDate) : '';
                const dateHtml2 = regDate ? formatDate2(regDate) : '';

                return `
        <div class="border-b border-gray-300 w-full px-2 py-1 text-sm text-gray-800 mb-[2px] leading-tight flex justify-between items-start">
        <div class="flex flex-col items-center mb-[1px]">
            <span class="font-semibold">${log.agent_name ?? ''}</span>
            <div class="flex items-baseline leading-tight">
                <span class="text-sm text-gray-500 items-center font-bold">${dateHtml1}</span>&nbsp;
                <span class="text-xs text-gray-500 items-center">${dateHtml2}</span>
            </div>            
        </div>
        <div class="text-[0.95rem] text-gray-900 leading-snug pb-1 w-[78%] text-left">${content}</div>
        </div>`;
            }).join('')
            : `<div class="text-gray-500 text-sm">등록된 업무일지가 없습니다.</div>`;

        container.innerHTML = logsHTML;
    }




    // 날짜오류해결할 유틸함수
    function parseDateOrNull(val) {
        const s = (val ?? '').trim();
        if (!s) return null; // 빈 입력은 null

        // 허용: YYYY-MM-DD / YYYY.MM.DD / YYYY/MM/DD
        const m = s.match(/^(\d{4})[-./](\d{1,2})[-./](\d{1,2})$/);
        if (!m) return null;

        let [_, y, mo, d] = m;
        const Y = +y, M = +mo, D = +d;
        const dt = new Date(Y, M - 1, D);

        // 달력 유효성 체크(2/30 같은 케이스 배제)
        if (dt.getFullYear() !== Y || (dt.getMonth()+1) !== M || dt.getDate() !== D) return null;

        // Postgres date 형식으로 반환
        return `${y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}`;
    }

    // 상세패널 저장함수
    async function saveListingDetails(listingId) {
        const getVal = (id) => {
            const el = document.getElementById(id);
            return el ? el.value : null;
        };
        const original = allListings[String(listingId)] || {};
        const parseNumberOrNull = (val, fallback) => {
            const n = parseFloat(val);
            return isNaN(n) ? fallback : n;
        };

        const isInvalidNumber = (val) => val === '' || val === '-' || val === null || val === undefined;

        const updateData = {
            title: getVal('input-title') || original.title || '-',
            features: getVal('textarea-features') || original.features || '-',
            detail_address: getVal('detail-address-input') || original.detail_address || '-',
            deal_type: getVal('dealTypeSelect') || original.deal_type || '-',

            deposit_price: isInvalidNumber(getVal('deposit_price')) ? null : parseFloat(getVal('deposit_price')),
            monthly_rent: isInvalidNumber(getVal('monthly_rent')) ? null : parseFloat(getVal('monthly_rent')),
            premium_price: isInvalidNumber(getVal('premium_price')) ? null : parseFloat(getVal('premium_price')),
            sale_price: isInvalidNumber(getVal('sale_price')) ? null : parseFloat(getVal('sale_price')),
            total_deposit: isInvalidNumber(getVal('total_deposit')) ? null : parseFloat(getVal('total_deposit')),
            total_rent: isInvalidNumber(getVal('total_rent')) ? null : parseFloat(getVal('total_rent')),

            supply_area_py: isInvalidNumber(getVal('supply-area-py')) ? null : parseFloat(getVal('supply-area-py')),
            area_py: isInvalidNumber(getVal('area-py')) ? null : parseFloat(getVal('area-py')),
            supply_area_m2: isInvalidNumber(getVal('supply-area-m2')) ? null : parseFloat(getVal('supply-area-m2')),
            area_m2: isInvalidNumber(getVal('area-m2')) ? null : parseFloat(getVal('area-m2')),

            floor: isInvalidNumber(getVal('floor')) ? null : parseNumberOrNull(getVal('floor'), original.floor ?? null),
            total_floors: isInvalidNumber(getVal('total-floors')) ? null : parseNumberOrNull(getVal('total-floors'), original.total_floors ?? null),
            parking: isInvalidNumber(getVal('parking')) ? null : parseNumberOrNull(getVal('parking'), original.parking ?? null),

            unit_info: getVal('unit_info'),
            agent_name: getVal('agent_name'),
            listing_title: getVal('listing_title'),
            restroom: getVal('restroom'),
            direction: getVal('direction'),
            approved_date: parseDateOrNull(getVal('approved_date')),
            store_type: getVal('store_type'),
            store_type_detail: getVal('store_type_detail'),
            ad_type: getVal('ad_type'),
            ad_status: getVal('ad_status'),
            customer_data: getVal('customer_data'),
            private_note: getVal('private_note'),
            entrance: getVal('entrance'),
            building_usage: getVal('building_usage'),
            province: getVal('province'),
            city: getVal('city'),
            district: getVal('district'),
            carrier: getVal('carrier'),
            buildingownername: getVal('buildingownername'),
            ownerphonenumber: getVal('ownerphonenumber'),
            ownergender: getVal('ownergender'),
            store_category: getVal('store_category') || original.store_category || '-',
        };

        // 1. baikukdbtest 업데이트
        const { data, error } = await client
            .from('baikukdbtest')
            .update(updateData)
            .eq('listing_id', String(listingId))
            .select();

        // 2. 먼저 실패 여부 확인
        if (error) {
            console.error('❌ 저장 실패:', error);
            alert('저장 실패: ' + error.message);
            return;  // 여기서 중단
        }

        // === building_info 저장 로직 ===
        let addrCompareFromDb = null;
        let fullAddressFromParts = '';

        try {
        // 1) addr_compare 확보
        if (data && data.length > 0) {
            addrCompareFromDb = data[0].addr_compare ?? null;
        }
        if (!addrCompareFromDb) {
            const { data: row, error: fetchErr } = await client
                .from('baikukdbtest')
                .select('addr_compare, province, city, district, detail_address')
                .eq('listing_id', String(listingId))
                .maybeSingle();

            if (fetchErr) {
                console.warn('⚠️ addr_compare 재조회 오류:', fetchErr);
            } else if (row) {
                addrCompareFromDb = row.addr_compare ?? null;
                fullAddressFromParts = `${row.province ?? ''} ${row.city ?? ''} ${row.district ?? ''} ${row.detail_address ?? ''}`.trim();
                if (!addrCompareFromDb) {
                    addrCompareFromDb = fullAddressFromParts.replace(/\s+/g, '');
                }
            }
        }

        console.log('🏠 full_address(조합):', fullAddressFromParts);
        console.log('📌 addr_compare(DB 기반):', addrCompareFromDb);

        if (!addrCompareFromDb) {
            console.warn('⚠️ addr_compare가 없어 building_info 저장을 건너뜀');
        } else {
            // 2) 입력값 읽기 (건물명/건물정보 메모)
            const newBuildingName = (getVal('building_name') || '').trim();
            const noteEl = document.getElementById('textarea-building-note-edit');  // ← 요구사항대로 edit값 사용
            const newBuildingNote = noteEl ? noteEl.value : null; // null이면 스킵, ""이면 비우기

            // 쿼리 키 정규화
            const key = (addrCompareFromDb || '').replace(/\s+/g, '').trim();

            // 저장 필드 구성 (빈 문자열 ""도 저장 허용)
            const payload = {};
            if (newBuildingName) payload.building_name = newBuildingName;
            if (newBuildingNote !== null && newBuildingNote !== undefined) {
                payload.building_note = newBuildingNote;
            }

            if (!key || Object.keys(payload).length === 0) {
                console.log('ℹ️ building_info 저장 스킵(키 또는 값 없음)');
            } else {
                // 3) 존재 여부 확인
                const { data: existed, error: existErr } = await client
                    .from('building_info')
                    .select('addr_compare')
                    .eq('addr_compare', key)   // key는 공백제거/trim된 값
                    .maybeSingle();

                if (existErr) {
                    console.error('❌ building_info 존재 여부 조회 실패:', existErr);
                } else if (existed) {
                // 4) UPDATE + 영향행 확인
                const { data: updRows, error: updErr } = await client
                    .from('building_info')
                    .update(payload)
                    .eq('addr_compare', key)
                    .select('addr_compare');

                if (updErr) console.error('❌ building_info 업데이트 실패:', updErr);
                else console.log('✅ building_info 업데이트 완료(건수):', updRows?.length ?? 0, payload);
                } else {
                    // 5) INSERT: addr_compare는 넣지 않음 (DB가 생성 컬럼으로 자동계산)
                    const fullAddressForInsert =
                    fullAddressFromParts && fullAddressFromParts.length > 0
                        ? fullAddressFromParts
                        : `${updateData.province ?? ''} ${updateData.city ?? ''} ${updateData.district ?? ''} ${updateData.detail_address ?? ''}`.trim();

                    const insertPayload = {
                    full_address: fullAddressForInsert
                    };
                    // building_name은 빈문자열이면 제외
                    if (newBuildingName) insertPayload.building_name = newBuildingName;
                    // building_note는 ""(비우기)도 허용 → null/undefined만 제외
                    if (newBuildingNote !== null && newBuildingNote !== undefined) {
                    insertPayload.building_note = newBuildingNote;
                    }

                    const { data: insRows, error: insErr } = await client
                    .from('building_info')
                    .insert([insertPayload]) // ← addr_compare 안 넣음!
                    .select('addr_compare, full_address');

                    if (insErr) console.error('❌ building_info 삽입 실패:', insErr);
                    else console.log('✅ building_info 삽입 완료:', insRows);
                }
            }
        }
        } catch (e) {
            console.error('❌ building_info 저장 처리 중 예외:', e);
        }

        // 4. 성공 후 처리
        console.log('✅ 저장 성공:', data);
        // ✅ 최신 building_name/Note를 Supabase에서 직접 조회하여 캐시 반영
        if (data && data.length > 0) {
        allListings[String(listingId)] = data[0];  // 캐시 갱신

        const addrCompare = (addrCompareFromDb || '').replace(/\s+/g,'').trim(); // ← 정규화
        if (addrCompare) {
            const { data: buildingInfoRows, error: fetchError } = await client
            .from('building_info')
            .select('building_name, building_note')
            .eq('addr_compare', addrCompare)
            .maybeSingle();

            if (!fetchError) {
            allListings[String(listingId)].building_name = buildingInfoRows?.building_name || '-';
            allListings[String(listingId)].building_note  = buildingInfoRows?.building_note  ?? '-';
            console.log('🏢 building_name 최신 값 반영됨:', allListings[String(listingId)].building_name);
            console.log('🗒️ building_note 최신 값 반영됨:', allListings[String(listingId)].building_note);
            }
        }
        }


        showToast('저장되었습니다!');
        showDetailPanel(listingId);

        // 저장이 끝난 뒤 클러스터 내 정보 최신화
        const clusterListingIds = window.currentClusterListings || [];

        if (clusterListingIds.length > 0) {
            console.log("🔁 클러스터 내 매물 재로드:", clusterListingIds);

            const { data: updatedListings, error: clusterError } = await client
                .from('baikukdbtest')
                .select('*')
                .in('listing_id', clusterListingIds.map(String));

            if (clusterError) {
                console.error("❌ 클러스터 재조회 실패:", clusterError);
            } else {
                // 기존 allListings 덮어쓰기
                updatedListings.forEach(listing => {
                    allListings[String(listing.listing_id)] = listing;
                });

                console.log(`✅ 클러스터 ${updatedListings.length}개 매물 최신 상태로 갱신됨`);
            }
        }
    }

    // 업무일지 저장 함수
    async function saveWorkLog() {
        const textarea = document.getElementById('textarea-worklog');
        const contents = textarea?.value.trim();
        const listingId = window.currentDetailListingId;

        // 🔑 로그인된 사용자 정보
        const { data: userData, error: userError } = await client.auth.getUser();
        const userId = userData?.user?.id;

        if (!contents) {
            showToast("내용을 입력해주세요.");
            return;
        }

        if (!userId || !listingId) {
            console.error("❌ 저장 실패 - userId 또는 listing 정보 없음");
            return;
        }

        // ✅ 직원 이름 조회
        const { data: profile, error: profileError } = await client
            .from('staff_profiles')
            .select('name')
            .eq('user_id', userId)
            .single();

        if (profileError || !profile) {
            console.error("❌ 직원 이름 조회 실패:", profileError);
            showToast("직원 이름을 불러올 수 없습니다.", true);
            return;
        }

        const agentName = profile.name;
        const now = new Date().toISOString();

        // ✅ 업무일지 저장
        const { data, error } = await client
            .from('work_log')
            .insert([
                {
                    listing_id: listingId,
                    agent_name: agentName,  // ✔ 이름 저장
                    contents,
                    Registration_date: now,
                    type: "입력"
                }
            ]);

        if (error) {
            console.error("❌ 업무일지 저장 실패:", error);
            showToast("저장 실패", true);
        } else {
            textarea.value = '';
            showToast("업무일지 저장 완료!");
            await fetchWorkLogs(listingId);   // 새로 불러와 다시 렌더
        }
    }

    // 전역 타이머(연속 호출 시 겹침 방지)
    let _toastTimer = null;

    function showToast(message = '작업이 완료되었습니다.', duration = 3000) {
        // 요소 확보(없으면 생성)
        let toast = document.getElementById('toast');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'toast';
            document.body.appendChild(toast);
        }

        // 내용/스타일 적용
        toast.textContent = message;
        toast.style.backgroundColor = '#F2C130';
        toast.style.color = 'black';
        toast.style.fontWeight = 'bold';

        // 🔝 overlay(z: 99999)보다 위에 나오도록 z-Index 크게!
        toast.className = 'fixed top-5 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded shadow-lg z-[100000]';

        // 보이기
        toast.classList.remove('hidden');

        // 기존 타이머 클리어 후 재설정
        if (_toastTimer) clearTimeout(_toastTimer);
        _toastTimer = setTimeout(() => {
            toast.classList.add('hidden');
        }, duration);
    }

    // 값이 없으면 공백으로 출력하는 함수
    function safeDisplay(value) {
        return !value || value === '-' ? '' : value;
    }

    // 이미지 선로드 전략
    // 상세 2장 선로드(서명 URL 생성 → Image.decode)
    // timeout 안에 끝나면 "동시 렌더", 못 끝나면 바로 렌더(나중 로딩)
    async function eagerDetailImages(listingId, { w = 480, q = 48, timeout = 160 } = {}) {
        // 공개 대표 2장만
        const { data: rows } = await client
            .from('listing_images')
            .select('path, caption, is_primary, order_index')
            .eq('listing_id', String(listingId))
            .eq('is_private', false)
            .order('is_primary', { ascending: false })
            .order('order_index', { ascending: true })
            .limit(2);

        if (!rows?.length) return { urls: [], decoded: false };

        const urls = await Promise.all(rows.map(r => getTransformedUrl(r.path, w, 3600, q)));

        // 디코드 시도(짧게). decode 지원 안 되면 onload 대체
        const loaders = urls.map(u => {
            const img = new Image();
            img.decoding = 'async';
            img.loading = 'eager';
            img.src = u;
            return (img.decode ? img.decode() : new Promise(res => { img.onload = res; img.onerror = res; }));
        });

        const all = Promise.allSettled(loaders).then(() => true);
        const timer = new Promise(res => setTimeout(() => res(false), timeout));
        const decoded = await Promise.race([all, timer]); // true=제때 준비, false=타임아웃

        return { urls, decoded };
    }

    // 상세패널
    async function showDetailPanel(listingId) {
        closeSidePanel();

        if (isEditMode && window.currentDetailListingId !== listingId) {
            isEditMode = false;
            detailScrollTop = 0;
        }

        let listing;
        try {
            // ✅ 캐시에 있건 없건 DB에서 풀 레코드 강제 재조회
            //    (단, 신규 더미는 DB에 없을 수 있으니 allowMissing=true)
            listing = await ensureListingLoaded(listingId, { force: true, allowMissing: true });
        } catch (e) {
            console.error(e);
            showToast('매물 정보를 불러오지 못했습니다.');
            return;
        }

        window.currentDetailListingId = listingId;
        renderMatchedListings();

        if (!listing) {
            showToast('매물 정보가 없습니다.');
            return;
        }

        const agentDisplayName = await resolveAgentDisplayName(listing.agent_name);
        const statusRaw = listing.transaction_status || '-';
        const status = statusRaw.trim().split(' ')[0];
        let statusStyle = 'background-color: #e5e7eb; color: #374151;';
        if (status === '진행중') statusStyle = 'background-color: #d9fae6; color: #00b74a;';
        else if (status === '계약완료') statusStyle = 'background-color: rgba(255,237,237); color: rgba(247,63,87); font-weight: 900;';

        // 👇 여기서 먼저 2장 선로드 시도
        let lead = { urls: [], decoded: false };
        try {
            lead = await eagerDetailImages(listingId, { w: 480, q: 48, timeout: 160 });
        } catch {}
        
        const detailHeader = `
            <div class="sticky top-0 z-10 bg-white shadow-md p-2 rounded transition cursor-pointer whitespace-normal">
                <div class="flex justify-between items-center">
                    <div class="flex items-start gap-2">
                        <!-- 매물번호 박스 -->
                        <div 
                            class="w-[61px] h-[26px] flex justify-center items-center text-[rgb(0,0,0)] px-1 py-0 rounded text-base font-bold"
                            style="background-color: ${
                                (listing.is_public || '').toString().trim().includes('비공개') 
                                    ? '#d1d5db' 
                                    : '#F2C130'
                            };">
                            ${listing.listing_id}
                        </div>

                        <!-- 상태 박스 -->
                        <div 
                            class="h-[26px] px-2 flex items-center justify-center rounded text-sm font-semibold"
                            style="${statusStyle}">
                            ${status}
                        </div>

                        <!-- 제목 -->
                        <div class="text-base font-bold text-gray-900 w-[20rem]">
                            ${(listing.listing_title || '-')}
                        </div>
                    </div>
                </div>
                <div class="flex flex-row flex-wrap items-start gap-6 mt-2">
                    <div class="text-left font-semibold text-[rgb(80,152,233)] text-base">
                        ${listing.deal_type}
                        ${
                            listing.deal_type?.includes("월세")
                                ? ` ${formatKoreanMoney(listing.deposit_price)} / ${formatKoreanMoney(listing.monthly_rent)}`
                                : listing.deal_type?.includes("매매")
                                ? ` ${formatKoreanMoney(listing.sale_price)}`
                                : ''
                        }
                    </div>
                    <div class="text-right font-semibold text-[rgb(248,63,87)] text-base whitespace-nowrap">
                        ${
                            listing.deal_type?.includes("월세")
                                ? (() => {
                                    const price = listing.premium_price;
                                    if (parseFloat(price) === 0) return '무권리';
                                    if (!price || price === '-' || isNaN(price)) return '';
                                    if (parseFloat(price) > 0) return `권 ${formatKoreanMoney(price)}`;
                                    return '';
                                })()
                                : listing.deal_type?.includes("매매")
                                ? `${listing.roi ? (parseFloat(listing.roi) * 100).toFixed(1) : '-'}%`
                                : ''
                        }
                    </div>
                    <div class="font-semibold text-base">
                        &nbsp;
                        <strong class="font-semibold">${listing.floor < 0 ? `B${Math.abs(listing.floor)}층` : `${listing.floor}층`}</strong>
                        <strong class="font-semibold">${Number(listing.area_py).toFixed(0)}</strong>평
                        <strong class="font-semibold">${(Number(listing.monthly_rent)/Number(listing.area_py)).toFixed(1)}</strong>만
                    </div>
                    <div class="ml-auto">
                        <button
                            onclick="toggleEditMode()"
                            class="text-green-800 bg-green-100 border border-green-300 text-sm px-3 py-1 rounded-full hover:bg-green-200 transition font-bold"
                        >
                            ${isEditMode ? '저장' : '수정'}
                        </button>
                    </div>
                </div>
            </div>
        `;

        // editSection 생성할 때 이미지 src를 선로드 결과로 박아두면 즉시 뜸
        const img0Src = lead.urls[0] || '';
        const img1Src = lead.urls[1] || '';

        const editSection = isEditMode ? `<div id="image-viewer" class="bg-white"> <div class="flex gap-2"> <div class="image-wm relative overflow-hidden w-1/2 h-[11rem] rounded bg-gray-100"> <img id="image-viewer-main-0" class="w-full h-full object-cover cursor-pointer" ${img0Src ? `src="${img0Src}"` : ''} loading="eager" decoding="async" fetchpriority="high" />
                </div><div class="image-wm relative overflow-hidden w-1/2 h-[11rem] rounded bg-gray-100"> <img id="image-viewer-main-1" class="w-full h-full object-cover cursor-pointer ${img1Src ? '' : 'hidden'}" ${img1Src ? `src="${img1Src}"` : ''} loading="lazy" decoding="async" fetchpriority="low" />
                </div></div></div> <div class="mt-2 flex flex-row gap-2 items-center">
                    <select id="province" class="border border-gray-300 rounded px-3 py-1 text-sm w-[6rem]"> </select>
                    <select id="city" class="border border-gray-300 rounded px-3 py-1 text-sm w-[8rem]"> </select>
                    <select id="district" class="border border-gray-300 rounded px-3 py-1 text-sm w-[6rem]"> 
                    </select> <input
                    type="text" 
                    id="detail-address-input" 
                    value="${!listing.detail_address || listing.detail_address === '-' || listing.detail_address === 'null' || listing.detail_address === 'undefined' ? '' : listing.detail_address}" 
                    class="border-2 border-neutral-400 rounded px-3 py-1 text-sm w-[5rem]" ${isEditMode ? '' : 'readonly'} />
                <button 
                    id="addr-search-btn"
                    class="bg-blue-500 text-white text-sm px-4 py-1 rounded hover:bg-blue-600"
                    ${isEditMode ? '' : 'disabled'}> 검색
                </button>
            </div> <div class="flex flex-row gap-3 items-center mt-2">
                <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">건물명</span>
                    <textarea
                        id="building_name"
                        placeholder="예: 삼융타워"
                        class="border border-gray-300 rounded px-3 py-1 text-sm w-32 overflow-hidden whitespace-normal break-words"
                        style="box-sizing:border-box; resize:none; overflow:hidden;"
                    >${safeDisplay(listing.building_name)}</textarea>
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">호수</span>
                    <textarea
                        id="unit_info"
                        placeholder="예: 109호"
                        class="border border-gray-300 rounded px-3 py-1 text-sm w-32 overflow-hidden whitespace-normal break-words"
                        style="box-sizing:border-box; resize:none; overflow:hidden;"
                    >${safeDisplay(listing.unit_info)}</textarea>
                </div>                
                <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">타입</span>
                    <select id="store_category" class="border border-gray-300 rounded px-3 py-1 text-sm w-[6.5rem]">
                        <option ${listing.store_category  === '-' ? 'selected' : ''}>-</option>
                        <option ${listing.store_category  === '프라자' ? 'selected' : ''}>프라자</option>
                        <option ${listing.store_category  === '주택상가' ? 'selected' : ''}>주택상가</option>
                    </select>
                </div>
            </div> <div id="map-preview" style="width:100%;height:9rem;margin-top:1rem;">
            </div> <div class="border-b border-gray-200 flex flex-row gap-8 items-center mt-2 h-[2.35rem]">
                <div class="flex items-center gap-8 pb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">공개</span>
                        <input
                            type="checkbox"
                            id="is_public"
                            class="border border-gray-300 w-5 h-5"
                            ${listing.is_public === '공개' ? 'checked' : ''}
                        />
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">매물명</span>
                        <input
                            type="text"
                            id="listing_title"
                            placeholder="예: 백억부동산 야당점"
                            class="border border-gray-300 rounded px-3 py-1 text-sm w-[22.3rem]"
                            value="${safeDisplay(listing.listing_title)}"
                        />
                    </div>
                </div>
            </div> <div class="flex flex-row gap-6 items-center mt-2 pb-2 border-b border-gray-200 h-[2.4rem]">
                <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">담당자</span>
                    <select
                        id="agent_name"
                        class="border border-gray-300 rounded px-3 py-1 text-sm w-[7.5rem]"
                    >
                        <option value="">로딩중...</option>
                    </select>
                </div>
                <div class="flex items-center gap-1">
                    <div class="flex flex-row gap-2 items-center">
                        <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">대분류</span>
                        <select class="border border-gray-300 rounded px-3 py-1 text-sm w-[5.2rem]">
                            <option ${listing.category === '상가' ? 'selected' : ''}>상가</option>
                            <option ${listing.category === '공장·창고' ? 'selected' : ''}>공장·창고</option>
                            <option ${listing.category === '토지' ? 'selected' : ''}>토지</option>
                            <option ${listing.category === '주택' ? 'selected' : ''}>주택</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="flex flex-row gap-2 items-center">
                        <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">거래유형</span>
                        <select id="dealTypeSelect" class="border border-gray-300 rounded px-3 py-1 text-sm w-[5.3rem]" onchange="renderDealFields()">
                            <option value="월세" ${listing.deal_type === '월세' ? 'selected' : ''}>월세</option>
                            <option value="매매" ${listing.deal_type === '매매' ? 'selected' : ''}>매매</option>
                        </select>
                    </div>
                </div>
            </div> <div id="dealFields" class="border-b border-gray-200 flex flex-row gap-2 items-center mt-2">
            </div> <div class="flex flex-row gap-8 items-center mt-2 pb-2 border-b border-gray-200 h-[2.35rem]">
                <div class="flex items-center gap-8"> <div class="flex flex-row items-center gap-1">
                        <span class="ml-1 text-sm text-gray-600 font-semibold" style="color: #5098e9;">계약/전용</span><input
                                type="text"
                                id="supply-area-py"
                                class="border border-gray-300 rounded px-3 py-1 text-sm w-[4.5rem] text-right"
                                value="${safeDisplay(listing.supply_area_py)}"
                            />
                            <span class="text-sm text-gray-600">/</span>
                            <input
                                type="text"
                                id="area-py"
                                class="border border-gray-300 rounded px-3 py-1 text-sm w-[4.5rem]"
                                value="${safeDisplay(listing.area_py)}"
                            />
                            <span class="text-sm text-gray-600">평</span>
                    </div><div class="ml-10 flex flex-row items-center gap-1">
                        <div class="flex items-center gap-1">
                            <input
                            type="text"
                            id="supply-area-m2"
                            class="border border-gray-300 rounded px-3 py-1 text-sm w-[4.5rem] text-right"
                            value="${safeDisplay(listing.supply_area_m2)}"
                        />
                        <span class="text-sm text-gray-600">/</span>
                        <input
                            type="text"
                            id="area-m2"
                            class="border border-gray-300 rounded px-3 py-1 text-sm w-[4.5rem]"
                            value="${safeDisplay(listing.area_m2)}"
                        />
                        <span class="text-sm text-gray-600">㎡</span>
                        </div>
                    </div>                    
                </div>
            </div> <div class="flex flex-row gap-5 items-center mt-2 pb-2 border-b border-gray-200">
                <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">해당층</span>
                    <input
                        type="text"
                        id="floor"
                        class="border border-gray-300 rounded px-3 py-1 text-sm w-[3rem]"
                        value="${safeDisplay(listing.floor)}"
                    />
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">총층</span>
                    <input
                        type="text"
                        id="total-floors"
                        class="border border-gray-300 rounded px-3 py-1 text-sm w-[3rem]"
                        value="${safeDisplay(listing.total_floors)}"
                    />
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">추천업종</span>
                    <textarea
                        id="store_type_detail"
                        placeholder="예: 카페, 미용, 학원 등"
                        class="border border-gray-300 rounded px-3 py-1 text-sm w-[15rem] overflow-hidden whitespace-normal break-words"
                        style="box-sizing:border-box; resize:none; overflow:hidden;"
                    >${safeDisplay(listing.store_type_detail)}</textarea>
                </div>
            </div> <div class="flex flex-row gap-4 items-center mt-2 pb-2 border-b border-gray-200 min-h-[2.3rem]">
                <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">주용도</span>
                    <select id="building_usage" class="border border-gray-300 rounded px-3 py-1 text-sm w-[13rem]">
                        ${[
                            '-', '단독주택', '공동주택', '제1종 근린생활시설', '제2종 근린생활시설',
                            '문화 및 집회시설', '종교시설', '판매시설', '운수시설', '의료시설',
                            '교육연구시설', '노유자', '수련시설', '운동시설', '업무시설', '숙박시설',
                            '위락', '공장', '창고시설', '위험물 저장 및 처리 시설', '자동차 관련 시설',
                            '동물 및 식물 관련 시설', '자원순환 관련 시설', '군사 시설', '방송통신시설',
                            '발전시설', '묘지 관련 시설', '관광 휴게시설', '장례시설', '야영장 시설',
                            '미등기건물', '그 밖에 토지의 정착'
                        ].map(type => `
                            <option value="${type}" ${listing.building_usage === type ? 'selected' : ''}>${type}</option>
                        `).join('')}
                    </select>
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">화장실</span>
                    <textarea
                        id="restroom"
                        placeholder="예: 내부/외부/없음"
                        class="border border-gray-300 rounded px-3 py-1 text-sm w-[11.4rem] overflow-hidden whitespace-normal break-words"
                        style="box-sizing:border-box; resize:none; overflow:hidden;"
                    >${safeDisplay(listing.restroom)}</textarea>
                </div>
            </div> <div class="flex flex-row gap-8 items-center mt-2 pb-2 border-b border-gray-200 h-[2.3rem]">
                <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">방향</span>
                    <select id="direction" class="border border-gray-300 rounded px-3 py-1 text-sm w-[5rem]">
                        <option ${listing.direction === '-' ? 'selected' : ''}>-</option>
                        <option ${listing.direction === '동' ? 'selected' : ''}>동</option>
                        <option ${listing.direction === '서' ? 'selected' : ''}>서</option>
                        <option ${listing.direction === '남' ? 'selected' : ''}>남</option>
                        <option ${listing.direction === '북' ? 'selected' : ''}>북</option>
                        <option ${listing.direction === '북동' ? 'selected' : ''}>북동</option>
                        <option ${listing.direction === '남동' ? 'selected' : ''}>남동</option>
                        <option ${listing.direction === '북서' ? 'selected' : ''}>북서</option>
                        <option ${listing.direction === '남서' ? 'selected' : ''}>남서</option>
                    </select>
                </div>
                <div class="flex items-center gap-1">
                    <span class="ml-1 text-sm text-gray-600 font-semibold" style="color: #5098e9;">총주차</span>
                    <input
                        type="text"
                        id="parking"
                        class="border border-gray-300 rounded px-3 py-1 text-sm w-[3.5rem]"
                        value="${safeDisplay(listing.parking)}"
                    />
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">사용승인일</span>
                    <input
                        type="text"
                        id="approved_date" 
                        placeholder="예: 2025-07-27"
                        class="border border-gray-300 rounded px-3 py-1 text-sm w-[8.9rem]"
                        value="${safeDisplay(listing.approved_date)}"
                    />
                </div>
            </div> <div class="flex flex-row gap-8 items-center mt-2 mb-10">
                <div class="flex flex-col items-start gap-1">
                    <div class="flex items-center gap-8 pb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">매물특징</span>
                        </div>
                        <textarea
                            id="input-title"
                            placeholder="예: 무권리. 시설 굿. 주방시설 완비"
                            class="border border-gray-300 rounded px-3 py-1 text-sm w-[25.7rem] overflow-hidden whitespace-normal break-words"
                            style="box-sizing:border-box; resize:none; overflow:hidden;"
                        >${safeDisplay(listing.title)}</textarea>
                    </div>                                
                    <textarea
                        class="border border-gray-300 rounded px-3 py-1 text-sm w-full h-[7rem] resize-none"
                        id="textarea-features"
                        placeholder="'Enter'로 구분"
                    >${safeDisplay(listing.features)}</textarea>
                </div>
            </div> <div class="flex flex-row gap-8 items-center border-t border-red-400 pt-5">
                <div class="flex flex-col items-start gap-1">
                    <div class="flex items-center gap-4 pb-2">
                        <span class="text-sm text-red-500 font-semibold">출입</span>
                        <input
                            type="text"
                            id="entrance"
                            placeholder="예: 2258* / 임차인에게 하루 전 연락"
                            class="border border-red-400 rounded px-3 py-1 text-sm w-[28.5rem]"
                            value="${safeDisplay(listing.entrance)}"
                        />
                    </div> 
                    <div class="flex flex-row gap-3.5 pb-2">
                        <!-- 광고 -->
                        <div class="flex flex-col items-start gap-1.5">                                        
                            <div class="flex items-start gap-2 pt-2">
                                <span class="text-sm text-gray-800 font-semibold">광고</span>
                            </div>                                           
                            <div class="flex items-start gap-7">
                                <div class="flex items-start gap-2">
                                    <span class="text-sm text-red-500 font-semibold">통신사</span>
                                    <select id="carrier" class="pl-0 border border-red-400 rounded px-3 py-0 py-1 text-sm w-[7.8rem]">
                                        <option ${listing.carrier  === '-' ? 'selected' : ''}>-</option>
                                        <option ${listing.carrier  === 'SKT' ? 'selected' : ''}>SKT</option>
                                        <option ${listing.carrier  === 'KT' ? 'selected' : ''}>KT</option>
                                        <option ${listing.carrier  === 'LGU+' ? 'selected' : ''}>LGU+</option>
                                        <option ${listing.carrier  === 'SKT 알뜰폰' ? 'selected' : ''}>SKT 알뜰폰</option>
                                        <option ${listing.carrier  === 'KT 알뜰폰' ? 'selected' : ''}>KT 알뜰폰</option>
                                        <option ${listing.carrier  === 'LGU+ 알뜰폰' ? 'selected' : ''}>LGU+ 알뜰폰</option>
                                    </select>
                                </div>
                                <div class="flex items-start gap-2">
                                    <span class="text-sm text-red-500 font-semibold">성별</span>
                                    <select id="ownergender" class="pl-0 border border-red-400 rounded px-3 py-0 py-1 text-sm w-[4.7rem]">
                                        <option ${listing.ownergender  === '-' ? 'selected' : ''}>-</option>
                                        <option ${listing.ownergender  === '남자' ? 'selected' : ''}>남자</option>
                                        <option ${listing.ownergender  === '여자' ? 'selected' : ''}>여자</option>
                                    </select>
                                </div>
                                <div class="flex items-start gap-2">
                                    <span class="text-sm text-red-500 font-semibold">상품</span>
                                    <select id="ad_type" class="border border-red-400 rounded px-3 py-0 py-1 text-sm w-[7.6rem]">
                                        <option ${listing.ad_type === '-' ? 'selected' : ''}>-</option>
                                        <option ${listing.ad_type === '신홍보-개인' ? 'selected' : ''}>신홍보-개인</option>
                                        <option ${listing.ad_type === '모바일v2' ? 'selected' : ''}>모바일v2</option>
                                        <option ${listing.ad_type === '위임장' ? 'selected' : ''}>위임장</option>
                                        <option ${listing.ad_type === '구홍보' ? 'selected' : ''}>구홍보</option>
                                    </select>
                                </div>
                            </div>           
                            <div class="flex items-start gap-7">
                                <div class="flex items-start gap-2">
                                    <span class="text-sm text-red-500 font-semibold w-[2.6rem]">성함</span>
                                    <input
                                        type="text"
                                        id="buildingownername"
                                        placeholder=" 예: 김철수"
                                        class="border border-red-400 rounded text-sm w-[7.8rem]"
                                        value="${safeDisplay(listing.buildingownername)}"
                                    />
                                </div>
                                <div class="flex items-start gap-2">
                                    <span class="text-sm text-red-500 font-semibold">전화번호</span>
                                    <input
                                        type="text"
                                        id="ownerphonenumber"
                                        placeholder=" 예: 010-9989-1163"
                                        class="border border-red-400 rounded text-sm w-[14.5rem]"
                                        value="${safeDisplay(listing.ownerphonenumber)}"
                                    />
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="text-sm text-red-500 font-semibold w-[2.3rem]">현황</span>
                                <textarea
                                    placeholder="파주매경, 야당한경, 일산뱅크, 파주블로그"
                                    id="ad_status"
                                    class="h-[3rem] border border-red-400 rounded px-3 py-1 text-sm w-[28.2rem] resize-none"
                                >${safeDisplay(listing.ad_status)}</textarea>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col items-start gap-1 pt-2">
                        <span class="text-sm text-gray-800 font-semibold pd-1">메모</span>
                        <div class="flex flex-row gap-3.5 pb-2">
                            <div class="flex items-start gap-3">
                                <div class="flex flex-col justify-between h-[5rem] w-[3.7rem]">
                                    <span class="self-start text-left text-sm text-red-500 font-semibold">고객정보</span>
                                    <span class="self-start text-left text-sm text-red-500 font-semibold">내용</span>
                                </div>
                                <textarea
                                    id="customer_data"                                 
                                    placeholder="소유(남) 김수미 SKT 010-8858-8885"
                                    class="h-[5rem] border border-red-400 rounded px-3 py-1 text-sm w-[26.7rem] resize-none"
                                >${safeDisplay(listing.customer_data)}</textarea>
                            </div>
                        </div>
                        <textarea
                            id="private_note" 
                            class="border border-red-400 rounded px-3 py-1 text-sm w-[31.2rem] h-[10rem] resize-none"
                            placeholder="직원전용메모"
                        >${safeDisplay(listing.private_note)}</textarea>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 10px; align-items: flex-start;">
                <!-- 썸네일 + 제목 -->
                <div class="flex flex-col gap-2">
                    <div class="font-bold mb-1">건물정보</div>
                    <div class="thumb-box w-[140px] h-[100px] rounded relative"><img
                            id="thumb-edit-${listing.listing_id}"
                            src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/baikuk-simbol.png"
                            alt="썸네일"
                            class="thumb-img-contain rounded no-save"
                            draggable="false"
                            oncontextmenu="return false"
                        />
                    </div>
                </div>
                <!-- 건물정보 내용 -->
                <textarea
                    id="textarea-building-note-edit"
                    class="border border-green-700 rounded px-1 py-1 text-sm w-[21.8rem] h-[9rem] resize-none"
                    placeholder="건물전체 내용"
                >${safeDisplay(listing.building_note)}</textarea>
            </div>` : `<div id="image-viewer" class="bg-white"> <div class="flex gap-2"> <div class="image-wm relative overflow-hidden w-1/2 h-[11rem] rounded bg-gray-100"> <img id="image-viewer-main-0" class="w-full h-full object-cover cursor-pointer" ${img0Src ? `src="${img0Src}"` : ''} loading="eager" decoding="async" fetchpriority="high"/>
                </div><div class="image-wm relative overflow-hidden w-1/2 h-[11rem] rounded bg-gray-100"> <img id="image-viewer-main-1" class="w-full h-full object-cover cursor-pointer ${img1Src ? '' : 'hidden'}" ${img1Src ? `src="${img1Src}"` : ''} loading="lazy" decoding="async" fetchpriority="low" />
                </div></div></div><div class="mt-2 flex flex-row gap-2 items-center py-2 h-[2.2rem]"> 
                <span>${listing.province}</span> <span>${listing.city}</span> <span>${listing.district}</span><span>${listing.detail_address && listing.detail_address !== '-' ? listing.detail_address : ''}</span><div id="affiliation-badge" class="ml-auto text-sm text-gray-700">지점이름 표시</div>
            </div>  <div class="flex flex-row gap-3 items-center mt-[0.3rem]">
                <!-- 건물명 (보기) -->
                <div class="flex items-center gap-1">
                <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">건물명</div>
                <div id="building_name_view"
                    class="rounded px-3 py-1 text-sm w-32 overflow-hidden whitespace-normal break-words two-line"
                    title="${safeDisplay(listing.building_name)}">
                    ${safeDisplay(listing.building_name)}
                </div>
                </div>

                <!-- 호수 (보기) -->
                <div class="flex items-center gap-1">
                <div class="text-sm text-gray-600 font-semibold" style="color:#5098e9;">호수</div>
                <div id="unit_info_view"
                    class="rounded px-3 py-1 text-sm w-32 overflow-hidden whitespace-normal break-words two-line"
                    title="${safeDisplay(listing.unit_info)}">
                    ${safeDisplay(listing.unit_info)}
                </div>
                </div>

                <div class="flex items-center gap-1">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">타입</div>
                    <div class="rounded px-3 py-1 text-sm w-[6.5rem]"> ${safeDisplay(listing.store_category)}</div>
                </div>
            </div><div id="map-preview" style="width:100%;height:9rem;margin-top:1rem;">
            </div> <div class="flex flex-row gap-6 items-center h-[3rem] border-b border-gray-200 "> <span
                    class="px-2 py-1 text-sm rounded font-semibold"
                    style="${listing.is_public === '공개'
                                ? 'background-color: #d9fae6; color: #00b74a;'
                                : 'background-color: rgba(255,237,237); color: rgba(247,63,87); font-weight: 900;'}"
                >${listing.is_public === '공개' ? '공개' : '비공개'}
                </span> <span class="ml-11 pl-7">${safeDisplay(listing.listing_title)}</span>
            </div> <div class="flex flex-row items-center h-[2.85rem] border-b border-gray-200 gap-11"> <div class="flex gap-8"><span class="font-semibold" style="color: #5098e9;"
                >담당자</span><span class="w-[4.5rem] truncate"> ${safeDisplay(agentDisplayName)}</span></div><div class="flex gap-5"><span class="font-semibold" style="color: #5098e9;"
                >대분류</span><span class="w-[2.45rem]"">${listing.category}</span></div><div class="flex gap-5"><span class="font-semibold" style="color: #5098e9;"
                >거래유형</span><span>${listing.deal_type}</span></div>
            </div> <div id="dealFieldsViewer" class="border-b border-gray-200 flex gap-12 h-[3rem]">
            </div> <div class="flex flex-row gap-8 items-center mt-2 pb-2 border-b border-gray-200">
                <div class="flex items-center gap-8"> <div class="flex flex-row items-center gap-1">
                        <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">계약/전용</div><div class="ml-1 rounded px-3 py-1 text-sm w-[4.5rem] text-right">${safeDisplay(listing.supply_area_py)}
                            </div>
                            <div class="text-sm text-gray-600">/</div>
                            <div class="rounded px-3 py-1 text-sm w-[4.5rem]">${formatNumber2(listing.area_py)}
                            </div>
                            <div class="text-sm text-gray-600">평</div>
                    </div><div class="ml-10 flex flex-row items-center gap-1">
                        <div class="flex items-center gap-1">
                            <div class="rounded px-3 py-1 text-sm w-[4.5rem] text-right"> ${formatNumber2(listing.supply_area_m2)}
                        </div>
                        <div class="text-sm text-gray-600">/</div>
                        <div class="rounded px-3 py-1 text-sm w-[4.5rem]">${formatNumber2(listing.area_m2)}
                        </div>
                        <div class="text-sm text-gray-600">㎡</div>
                        </div>
                    </div>                    
                </div>
            </div> <div class="flex flex-row gap-5 items-center mt-2 pb-2 border-b border-gray-200">
                <div class="flex items-center gap-1">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">해당층</div>
                    <div class="rounded px-3 py-1 text-sm w-[3rem]">${safeDisplay(listing.floor)}
                    </div>
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">총층</div>
                    <div class="rounded px-3 py-1 text-sm w-[3rem]">${safeDisplay(listing.total_floors)}
                    </div>
                </div>
                <div class="flex items-center gap-1">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">추천업종</div>
                    <div id="store_type_detail_view"
                        class="rounded px-3 py-1 text-sm w-[15rem] two-line"
                        title="${safeDisplay(listing.store_type_detail)}">${safeDisplay(listing.store_type_detail)}
                    </div>
                </div>
            </div> <div class="flex flex-row gap-4 items-center mt-2 pb-2 border-b border-gray-200 min-h-[2.3rem]">
                <div class="flex items-center gap-1">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">주용도</div>
                    <div id="building_usage" class="rounded px-3 py-1 text-sm w-[13rem]">${listing.building_usage}</div>
                </div>
                <div class="flex items-center gap-1">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">화장실</div>
                    <div id="restroom_view"
                        class="rounded px-3 py-1 text-sm w-[11.4rem] two-line"
                        title="${safeDisplay(listing.restroom)}">${safeDisplay(listing.restroom)}
                    </div>
                </div>
            </div> <div class="flex flex-row gap-8 items-center mt-2 pb-2 border-b border-gray-200">
                <div class="flex items-center gap-1 h-[1.7rem]">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">방향</div>
                    <div class="rounded px-3 py-1 text-sm w-[5rem]"> ${safeDisplay(listing.direction)}
                    </div>
                </div>
                <div class="flex items-center gap-1">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">총주차</div>
                    <div class="rounded px-3 py-1 text-sm w-[3.5rem]"> ${safeDisplay(listing.parking)}
                    </div>
                </div>
                <div class="flex items-center gap-1">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">사용승인일</div>
                    <div class="rounded px-3 py-1 text-sm w-[9rem]"> ${safeDisplay(listing.approved_date)}
                    </div>
                </div>
            </div> <div class="flex flex-row gap-8 items-center mt-2 mb-10">
                <div class="flex flex-col items-start gap-1">
                    <div class="flex items-center gap-8 pb-2 min-h-[2.4rem]">                        
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">매물특징</span>
                        </div>
                        <div id="title_view"
                            class="rounded px-3 py-1 text-sm w-[25.7rem] overflow-hidden whitespace-normal break-words two-line"
                            title="${safeDisplay(listing.title)}">
                            ${safeDisplay(listing.title)}
                        </div>
                    </div>
                    <div class="overflow-y-auto rounded px-3 py-1 text-sm w-full h-[7rem] resize-none"> ${safeDisplay(listing.features)}</div>
                </div>

            </div> <div class="flex flex-row gap-8 items-center border-t border-gray-400 pt-5 bg-green-100 bg-opacity-15">
                <div class="flex flex-col items-start gap-1 text-sm text-gray-800">
                    <div class="flex items-center gap-4 pb-2">
                        <div class="text-green-700 font-semibold">출입</div>
                        <div 
                            class="border border-green-700 rounded px-3 py-1 text-green-700 w-[28.5rem] overflow-hidden text-ellipsis whitespace-nowrap h-[1.9rem]"
                            title="${safeDisplay(listing.entrance)}"
                        >
                        ${safeDisplay(listing.entrance)}
                        </div>
                    </div>
                    <div class="flex flex-row gap-3.5 pb-2">
                        <!-- 광고 -->
                        <div class="flex flex-col items-start gap-1.5">                                        
                            <div class="flex items-start gap-2 pt-2"><div class="text-red-600 font-semibold">광고</div>
                            </div>                                           
                            <div class="flex items-start gap-7">
                                <div class="flex items-start gap-2"> <div class="text-green-700 font-semibold">통신사</div>
                                    <div class="pl-0 px-3 py-0 border border-green-700 rounded text-green-700 w-[7.8rem]"> ${safeDisplay(listing.carrier)}
                                    </div>
                                </div>
                                <div class="flex items-start gap-2"> <div class="text-green-700 font-semibold">성별</div>
                                    <div class="pl-0 px-3 py-0 border border-green-700 rounded text-green-700 w-[4.7rem]"> ${safeDisplay(listing.ownergender)}
                                    </div>
                                </div>
                                <div class="flex items-start gap-2">
                                    <div class="text-green-700 font-semibold">상품</div>
                                    <div class="px-3 py-0 border border-green-700 rounded text-green-700 w-[7.6rem]"> ${safeDisplay(listing.ad_type)}
                                    </div>
                                </div>
                            </div>           
                            <div class="flex items-start gap-7">
                                <div class="flex items-start gap-2"> <div class="text-green-700 font-semibold w-[2.6rem]">성함</div>
                                    <div class="border border-green-700 rounded text-green-700 text-sm w-[7.8rem]"> ${safeDisplay(listing.buildingownername)}
                                    </div>
                                </div>
                                <div class="flex items-start gap-2"> <div class="text-green-700 font-semibold">전화번호</div>
                                    <div class="border border-green-700 rounded text-green-700 text-sm w-[14.5rem]"> ${safeDisplay(listing.ownerphonenumber)}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="text-green-700 font-semibold w-[2.3rem]">현황</div>
                                <div class="h-[3rem] px-3 py-1 border border-green-700 rounded text-green-700 text-sm w-[28.2rem] resize-none overflow-y-auto"> ${safeDisplay(listing.ad_status)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col items-start gap-1 pt-2"> <div class="text-red-600 font-semibold pd-1">메모</div>
                        <div class="flex flex-row gap-3.5 pb-2">
                            <div class="flex items-start gap-3">
                                <div class="flex flex-col justify-between h-[5rem] w-[3.7rem]"> <div class="self-start text-left text-green-700 font-semibold">고객정보
                                    </div> <div class="self-start text-left text-green-700 font-semibold">내용</div>
                                </div>
                                <div class="h-[5rem] px-3 py-1 border border-green-700 rounded text-green-700 text-sm w-[26.7rem] resize-none overflow-y-auto">${safeDisplay(listing.customer_data)}</div>
                            </div>
                        </div>
                        <div class="px-3 py-1 border border-green-700 rounded text-green-700 text-sm w-[31.2rem] h-[10rem] resize-none overflow-y-auto">${safeDisplay(listing.private_note)}</div>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 10px; align-items: flex-start;">
                <!-- 썸네일 + 제목 -->
                <div class="flex flex-col gap-2">
                    <div class="font-bold mb-1">건물정보</div>
                    <div class="thumb-box w-[140px] h-[100px] rounded relative"><img
                            id="thumb-edit-${listing.listing_id}"
                            src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/baikuk-simbol.png"
                            alt="썸네일"
                            class="thumb-img-contain rounded no-save"
                            draggable="false"
                            oncontextmenu="return false"
                        />
                    </div>
                </div>
                <!-- 건물정보 내용 -->
                <textarea
                    id="textarea-building-note"
                    class="border border-green-700 rounded px-1 py-1 text-sm w-[21.8rem] h-[9rem] resize-none"
                    placeholder="건물전체 내용"
                    readonly
                >${safeDisplay(listing.building_note)}</textarea>
            </div>`;

        const panel = document.getElementById('detail-panel');
        const content = document.getElementById('detail-content');
        content.innerHTML = detailHeader + editSection;
        await window.renderAffiliationBadge?.();
        // ➜ 건물 썸네일 주입
        await setBuildingThumbForDetail(listing);

        // ✅ 수정모드일 때만 담당자 셀렉트를 채움
        if (isEditMode) {
            await populateStaffSelect('agent_name', listing.agent_name || '');
        }

        // 업무일지 영역 추가
        const workLogContainer = document.createElement("div");
        workLogContainer.className = "px-4 pb-4";
        workLogContainer.innerHTML = `                      
            <div class="flex flex-row items-start gap-2">
                <div class="flex flex-col items-center gap-3.3 pb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-800 font-semibold mb-2">업무일지</span>
                    </div>
                    <button id="worklog-save-btn" class="bg-[#F2C130] text-white text-sm px-4 py-1 rounded hover:bg-yellow-400">저장</button>
                </div>    
                <div class="flex items-center gap-8 pb-2">                                    
                    <div class="flex flex-col items-start gap-1">
                        <textarea
                            id="textarea-worklog"
                            class="border border-gray-300 rounded px-3 py-1 text-sm w-[25.3rem] h-[4rem] resize-none"
                            placeholder="업무일지내용"
                        ></textarea>
                    </div>
                </div> 
            </div>
            <div id="work-log-content" class="text-sm text-gray-300 leading-tight">불러오는 중...</div>
        `;
        content.appendChild(workLogContainer);

        // Supabase에서 업무일지 불러와 렌더링
        // (패널 HTML 추가한 직후)
        await fetchWorkLogs(listingId);   // 렌더까지 함

        const prevListingId = window.currentDetailListingId; // 패널위치고정 관련 변수
        window.currentDetailListingId = listingId; // 패널위치고정 관련
        setTimeout(async () => {
            // 수정모드에서 textarea 높이를 보기모드 줄수와 동일하게 맞춤
            if (isEditMode) {
                applyLinesToTextarea('building_name', _lineSyncCache.building_name);
                applyLinesToTextarea('unit_info',     _lineSyncCache.unit_info);
                applyLinesToTextarea('restroom',      _lineSyncCache.restroom);
                applyLinesToTextarea('store_type_detail',   _lineSyncCache.store_type_detail);
                applyLinesToTextarea('input-title',       _lineSyncCache.title);
            }

            const input = document.getElementById('detail-address-input');
            if (input) {
                const val = listing.detail_address;
                input.placeholder = (!val || val === '-' || val === 'null' || val === 'undefined') ? '번지' : val;
            }

            // 🗺️ 지도 미리보기 및 마커
            const mapPreviewContainer = document.getElementById('map-preview');
            const panelContent = document.getElementById('detail-content');

            if (mapPreviewContainer && listing.lat && listing.lng) {
                const isEditable = !!window.isEditMode; // or just: const isEditable = isEditMode;

                const mapPreviewOption = {
                    center: new kakao.maps.LatLng(listing.lat, listing.lng),
                    level: 3,
                    draggable: isEditable,
                    scrollwheel: false
                };

                const mapPreview = new kakao.maps.Map(mapPreviewContainer, mapPreviewOption);
                mapPreview.setZoomable(false);

                const marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(listing.lat, listing.lng),
                    draggable: isEditable
                });
                marker.setMap(mapPreview);
                
                // ✅ 전역으로 보관해서 검색 클릭 시 접근
                window.previewMap = mapPreview;
                window.previewMarker = marker;

                if (isEditable) {
                    kakao.maps.event.addListener(mapPreview, 'click', function(mouseEvent) {
                        const latlng = mouseEvent.latLng;
                        marker.setPosition(latlng);
                        console.log("새 위치:", latlng.getLat(), latlng.getLng());
                    });
                }

                // === 읽기모드 우하단 N 버튼 ===
                const NAVER_BTN_ID = 'btn-naver-on-preview';
                const LAND_BTN_ID  = 'btn-land-on-preview';

                // 중복 삽입 방지 (상세 열기/전환시 기존 버튼 제거)
                document.getElementById(NAVER_BTN_ID)?.remove();
                document.getElementById(LAND_BTN_ID)?.remove();

                // 지도 컨테이너를 absolute 기준점으로
                mapPreviewContainer.classList.add('relative');

                if (!isEditable) {
                    // 1) 네이버 부동산(랜드) 버튼 (위쪽)
                    const landBtn = document.createElement('button');
                    landBtn.id = LAND_BTN_ID;
                    landBtn.type = 'button';
                    landBtn.className = [
                        'absolute','right-2','bottom-14','z-[101]',   // ← N 버튼보다 위쪽에 배치 (bottom-14)
                        'w-10','h-10','rounded-lg','shadow',
                        'flex','items-center','justify-center',
                        'border','border-gray-300','bg-white','hover:bg-gray-100','transition'
                    ].join(' ');
                    landBtn.title = '네이버 부동산 (오피스/상가)';

                    // 아이콘 이미지 (Supabase URL)
                    const landIcon = document.createElement('img');
                    landIcon.src = LAND_ICON_URL;  // ← 1)에서 지정한 URL
                    landIcon.alt = 'Naver Land';
                    landIcon.className = 'w-8 h-8 pointer-events-none';
                    landBtn.appendChild(landIcon);

                    landBtn.onclick = () => {
                        // 위도/경도 계산 (리스트의 좌표 우선, 없으면 메인 맵 센터)
                        let lat = Number(listing?.lat);
                        let lng = Number(listing?.lng);
                        if (!lat || !lng) {
                        const c = window.map?.getCenter?.();
                        if (c) { lat = c.getLat(); lng = c.getLng(); }
                        }
                        if (!lat || !lng) return;

                        const url = `https://new.land.naver.com/offices?ms=${lat},${lng},19&a=SG:SMS:GJCG:APTHGJ:GM:TJ&b=B2&e=RETAIL&ad=true`;
                        window.open(url, '_blank');
                    };

                    mapPreviewContainer.appendChild(landBtn);

                    // 2) 기존 N 버튼 (아래쪽)
                    const btn = document.createElement('button');
                    btn.id = NAVER_BTN_ID;
                    btn.type = 'button';
                    btn.className = [
                        'absolute','right-2','bottom-2','z-[101]',
                        'w-10','h-10','rounded-lg','shadow',
                        'flex','items-center','justify-center',
                        'border','border-gray-300',
                        'bg-[#00de5a]','hover:bg-[#00b74a]',
                        'transition','text-white','text-[28px]','font-black'
                    ].join(' ');
                    btn.style.textShadow = '0 1px 2px #ffffff, 0 0 1px #ffffff';
                    btn.title = '네이버지도';
                    btn.textContent = 'N';

                    btn.onclick = () => {
                        // (이 버튼은 기존 로직 유지: 검색 URL 또는 좌표 폴백 등)
                        const query = getFullAddressForListing(listing);
                        if (query) {
                        window.open(`https://map.naver.com/v5/search/${encodeURIComponent(query)}?c=18.00,0,0,0,dh`, '_blank');
                        } else {
                        window.open(`https://map.naver.com/v5/?c=${listing.lng},${listing.lat},18,0,0,0,d`, '_blank');
                        }
                    };

                    mapPreviewContainer.appendChild(btn);
                }
            }

            renderDealFields();  // ✅ 거래유형 기반 필드 자동 렌더링
            renderDealFieldsViewer(listing);

            
            if (isEditMode) {
                setupAreaAutoFill(); // ✅ 평↔㎡ 자동 변환 바인딩
                initLocationSelects(listing); //  지역 셀렉트 의존형 초기화
            }

            // ✅ 업무일지 저장 버튼 이벤트 등록
            document.getElementById('worklog-save-btn')?.addEventListener('click', saveWorkLog);

            // ✅ 스크롤 위치 복원            
            if (panelContent) {
                const isSameListing = prevListingId === listingId;

                if (isSameListing && isEditMode) {
                    // ✅ 같은 매물을 수정 후 다시 보기로 → 복원
                    panelContent.scrollTop = detailScrollTop;
                } else if (!isSameListing) {
                    // ✅ 다른 매물 클릭한 경우 (수정 중이든 아니든) → 초기화
                    detailScrollTop = 0;
                    panelContent.scrollTop = 0;
                } else {
                    // ✅ 기타 (예: 수정모드 진입 등) → 복원
                    panelContent.scrollTop = detailScrollTop;
                }
            }

            // 수정모드 검색버튼 눌렀을 때 지도에 마커 표시관련 코드
            document.getElementById('addr-search-btn')?.addEventListener('click', searchAndMoveMarker);
        }, 0);

        panel.style.display = 'block';
        document.getElementById('close-detail-btn').style.display = 'block';

        // 개별url관련
        const cur = getListingIdFromURL();
        if (cur !== String(listingId)) updateURLForListing(listingId);

        // 사진수정창 관련
        const sidePanel = document.getElementById('side-panel');
        if (isEditMode) {
            sidePanel.innerHTML = `
                <div id="image-editor" class="w-[21.5rem]"> <div class="flex items-center justify-between"> <div class="text-sm font-bold text-gray-800">공개-매물</div>
                    <div class="text-xs text-gray-500">JPG/PNG 여러 장 선택 가능</div>
                    </div>
                    <!-- 업로드 드롭존 -->
                    <div id="img-dropzone"
                        class="mt-2 border-2 h-[5rem] border-dashed border-gray-300 rounded p-3 text-center text-sm text-gray-500">
                    이 영역에 이미지나 폴더를 드래그하여 놓으세요
                    </div>
                    <!-- 미리보기 -->
                    <div id="img-preview-list" class="grid grid-cols-4 gap-2 mb-2"></div>

                    <!-- 파일 선택 + 업로드 버튼 -->
                    <div class="flex items-center space-x-1">
                        <input id="img-upload-input" type="file" accept="image/*" multiple
                            class="text-sm"/>
                        <button id="img-upload-btn"
                            class="-ml-3 bg-[#F2C130] text-black font-semibold text-sm px-1 py-1 min-h-[2rem] min-w-[5rem] rounded hover:brightness-95">
                            업로드
                        </button>
                    </div>

                    <!-- 이미 저장된 이미지 목록 -->
                    <div class="mt-3 md-5">
                        <div class="text-xs text-gray-600 mb-1">저장된 이미지</div>
                        <div id="img-list" class="grid grid-cols-4 gap-2"></div>
                    </div>
                </div>
                <div class="border-t mt-5 pt-3 w-[21.5rem]"> <div class="flex items-center justify-between"> <div class="text-sm font-bold text-gray-800">비공개-매물</div>
                    <div class="text-xs text-gray-500">JPG/PNG 여러 장 선택 가능</div>
                    </div>
                    <!-- 업로드 드롭존 -->
                    <div id="img-dropzone-private"
                        class="mt-2 border-2 h-[5rem] border-dashed border-gray-300 rounded p-3 text-center text-sm text-gray-500">
                    이 영역에 이미지나 폴더를 드래그하여 놓으세요
                    </div>
                    <!-- 미리보기 -->
                    <div id="img-preview-list-private" class="grid grid-cols-4 gap-2 mb-2"></div>

                    <!-- 파일 선택 + 업로드 버튼 -->
                    <div class="flex items-center space-x-1">
                        <input id="img-upload-input-private" type="file" accept="image/*" multiple
                            class="text-sm"/>
                        <button id="img-upload-btn-private"
                            class="-ml-3 bg-[#F2C130] text-black font-semibold text-sm px-1 py-1 min-h-[2rem] min-w-[5rem] rounded hover:brightness-95">
                            업로드
                        </button>
                    </div>

                    <!-- 이미 저장된 이미지 목록 -->
                    <div class="mt-3">
                        <div class="text-xs text-gray-600 mb-1">저장된 이미지</div>
                        <div id="img-list-private" class="grid grid-cols-4 gap-2"></div>
                    </div>
                </div>
                <div class="border-t mt-5 pt-3 w-[21.5rem]"> <div class="flex items-center justify-between"> <div class="text-sm font-bold text-gray-800">건물</div>
                    <div class="text-xs text-gray-500">JPG/PNG 여러 장 선택 가능</div>
                    </div>
                    <!-- 업로드 드롭존 -->
                    <div id="img-dropzone-addr"
                        class="mt-2 border-2 h-[5rem] border-dashed border-gray-300 rounded p-3 text-center text-sm text-gray-500">
                    이 영역에 이미지나 폴더를 드래그하여 놓으세요
                    </div>
                    <!-- 미리보기 -->
                    <div id="img-preview-list-addr" class="grid grid-cols-4 gap-2 mb-2"></div>

                    <!-- 파일 선택 + 업로드 버튼 -->
                    <div class="flex items-center space-x-1">
                        <input id="img-upload-input-addr" type="file" accept="image/*" multiple
                            class="text-sm"/>
                        <button id="img-upload-btn-addr"
                            class="-ml-3 bg-[#F2C130] text-black font-semibold text-sm px-1 py-1 min-h-[2rem] min-w-[5rem] rounded hover:brightness-95">
                            업로드
                        </button>
                    </div>

                    <!-- 이미 저장된 이미지 목록 -->
                    <div class="mt-3">
                        <div class="text-xs text-gray-600 mb-1">저장된 이미지</div>
                        <div id="img-list-addr" class="grid grid-cols-4 gap-2"></div>
                    </div>
                </div>
            `;
            sidePanel.classList.remove('hidden');
        } else {
            sidePanel.classList.add('hidden');
        }

        // 이미지 업로드 UI 바인딩 + 초기 로드
        document.getElementById('img-upload-input')?.addEventListener('change', previewSelectedFiles);
        document.getElementById('img-upload-btn')?.addEventListener('click', () => uploadSelectedImages(listingId));
        await loadListingImages(listingId);

        await initImageViewer(listingId, { includePrivateInViewer: true });

        // ✅ 드래그&드롭 업로드 활성화
        setupDragAndDropUpload(listingId);

        // 비공개 사진 관련
        document.getElementById('img-upload-input-private')?.addEventListener('change', previewSelectedFilesPrivate);
        document.getElementById('img-upload-btn-private')?.addEventListener('click', () => uploadSelectedImagesPrivate(listingId));
        await loadListingImagesPrivate(listingId);
        setupDragAndDropUploadPrivate(listingId);

        // 건물(주소공용) 바인딩
        const addrKey = getAddrKey(listing);                 
        document.getElementById('img-upload-input-addr')?.addEventListener('change', previewSelectedFilesAddr);
        document.getElementById('img-upload-btn-addr')?.addEventListener('click', () => uploadSelectedImagesAddr(listing));
        await loadAddressImages(addrKey);            
        setupDragAndDropUploadAddr(listing);
    }

    // 평 m2사이의 변환 관련 함수
    function setupAreaAutoFill() {
        const $ = (id) => document.getElementById(id);
        const sa_py = $('supply-area-py');
        const a_py  = $('area-py');
        const sa_m2 = $('supply-area-m2');
        const a_m2  = $('area-m2');

        if (!sa_py || !a_py || !sa_m2 || !a_m2) return;

        const updateFromPy = (srcEl, destEl) => {
            const v = parseNum(srcEl.value);
            if (v === null) { destEl.value = ''; return; }
            destEl.value = toFixed2(v * M2_PER_PYEONG); // m² = 평 × 3.3058
        };
        const updateFromM2 = (srcEl, destEl) => {
            const v = parseNum(srcEl.value);
            if (v === null) { destEl.value = ''; return; }
            destEl.value = toFixed2(v * PYEONG_PER_M2); // 평 = m² × 0.3025
        };

        // 입력 시 서로 자동 채움 (프로그램으로 값 세팅은 input 이벤트 발생 안 함 → 루프 없음)
        sa_py.addEventListener('input', () => updateFromPy(sa_py, sa_m2));
        a_py .addEventListener('input', () => updateFromPy(a_py , a_m2));
        sa_m2.addEventListener('input', () => updateFromM2(sa_m2, sa_py));
        a_m2 .addEventListener('input', () => updateFromM2(a_m2 , a_py));

        // 초기값 동기화 (평 쪽이 있으면 평→㎡ 우선, 없으면 ㎡→평)
        if (parseNum(sa_py.value) !== null) updateFromPy(sa_py, sa_m2);
        else if (parseNum(sa_m2.value) !== null) updateFromM2(sa_m2, sa_py);

        if (parseNum(a_py.value) !== null) updateFromPy(a_py, a_m2);
        else if (parseNum(a_m2.value) !== null) updateFromM2(a_m2, a_py);
        }

    // 상세패널 뷰모드 매매, 월세에 따라서 가격정보 다르게 표시
    function renderDealFieldsViewer(listing) {
        const container = document.getElementById("dealFieldsViewer");
        if (!listing || !container) return;

        const selected = listing.deal_type || '';
        const isMaeMae = selected.includes("월세");

        container.innerHTML = `${isMaeMae ? ` <div class="flex flex-row items-center gap-6"> <div class="font-semibold text-[#5098e9]">보증금</div>
                    <div class="w-[4.7rem]"> ${formatKoreanMoney(listing.deposit_price)}</div>
                </div>
                <div class="flex flex-row items-center gap-3"> <div class="font-semibold text-[#5098e9]">월세</div>
                    <div class="w-[3.3rem]"> ${formatKoreanMoney(listing.monthly_rent)}</div>
                </div>
                <div class="flex flex-row items-center gap-3"> <span class="font-semibold text-[#5098e9]">권리금</span>
                    <span> ${formatKoreanMoney(listing.premium_price)}</span>
                </div>
            ` : `<div class="flex items-center gap-6">                    
                <div class="flex items-center gap-1">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">매매가</div>
                    <div class="w-[7.55rem] rounded px-3 py-1 text-sm w-[4.5rem]">${formatKoreanMoney(listing.sale_price)}</div>
                </div>
                <div class="flex items-center gap-1">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">총보증금</div>
                    <div class="w-[6rem] rounded px-3 py-1 text-sm w-[3.5rem]">${formatKoreanMoney(listing.total_deposit)}</div>
                </div>
                <div class="flex items-center gap-1">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">총월세</div>
                    <div class="w-[4.95rem] rounded px-3 py-1 text-sm">${formatKoreanMoney(listing.total_rent)}</div>
                </div>
                </div>`}
            </div>`;
    }

    // 수정창 매매, 월세에 따라서 가격정보 다르게 표시
    function renderDealFields() { 
        const selected = document.getElementById("dealTypeSelect")?.value;
        const container = document.getElementById("dealFields");
        const listing = allListings?.[window.currentDetailListingId];

        if (!container || !selected || !listing) return;


        if (selected === "월세") {
            container.innerHTML = `
                <div class="flex items-center gap-6 pb-2">                    
                    <div class="flex items-center gap-1">
                        <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">보증금</span>
                        <input type="text" id="deposit_price" placeholder="만원" class="w-[7.55rem] border border-gray-300 rounded px-3 py-1 text-sm" value="${formatNumber(listing.deposit_price)}" />
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">월세</span>
                        <input type="text" id="monthly_rent" placeholder="만원" class="w-[6rem] border border-gray-300 rounded px-3 py-1 text-sm" value="${formatNumber(listing.monthly_rent)}" />
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">권리금</span>
                        <input type="text" id="premium_price" placeholder="만원" class="w-[6.7rem] border border-gray-300 rounded px-3 py-1 text-sm" value="${formatNumber(listing.premium_price)}" />
                    </div>
                </div>
            `;
        } else if (selected === "매매") {
            container.innerHTML = `
                <div class="flex items-center gap-6 pb-2">                    
                    <div class="flex items-center gap-1">
                        <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">매매가</span>
                        <input type="text" id="sale_price" placeholder="만원" class="w-[7.55rem] border border-gray-300 rounded px-3 py-1 text-sm w-[4.5rem]" value="${formatNumber(listing.sale_price)}" />
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">총보증금</span>
                        <input type="text" id="total_deposit" placeholder="만원" class="w-[6rem] border border-gray-300 rounded px-3 py-1 text-sm w-[3.5rem]" value="${formatNumber(listing.total_deposit)}" />
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">총월세</span>
                        <input type="text" id="total_rent" placeholder="만원" class="w-[4.95rem] border border-gray-300 rounded px-3 py-1 text-sm" value="${formatNumber(listing.total_rent)}" />
                    </div>
                </div>
            `;
        } else {
            container.innerHTML = '';
        }
    }

    // hideDetailPanel 교체
    function hideDetailPanel(skipUrl = false) {
        const panel = document.getElementById('detail-panel');
        const content = document.getElementById('detail-content');

        if (content) content.scrollTop = 0;
        detailScrollTop = 0;

        panel.style.display = 'none';
        document.getElementById('close-detail-btn').style.display = 'none';
        document.querySelectorAll('[id^="filter-panel-"]').forEach(p => p.classList.add('hidden'));
        isEditMode = false;
        publicBulkMode = false; // 선택모드 해제

        closeSidePanel();// 사진수정창 닫기
        if (!skipUrl) updateURLForListing(null); // <- 뒤로가기 때는 안 건드리기
    }


    // 매물수정에서 평 m2사이의 변환
    // 평↔㎡ 변환 상수 (요청대로 0.3025 사용)
    const M2_PER_PYEONG = 1 / 0.3025; // ≈ 3.3058
    const PYEONG_PER_M2 = 0.3025;

    // 숫자 파싱 & 두 자리 포맷
    function parseNum(v) {
        const n = parseFloat((v ?? '').toString().replace(/,/g, ''));
        return Number.isFinite(n) ? n : null;
    }
    function toFixed2(n) {
        if (!Number.isFinite(n)) return '';
        return (Math.round(n * 100) / 100).toFixed(2); // 항상 2자리 표시
    }

    
    function formatKoreanMoney(value) {
        if (!value && value !== 0) return '-';
        const num = Number(value);
        if (num >= 10000) {
            const eok = Math.floor(num / 10000);
            const man = num % 10000;
            return `${eok}억${man > 0 ? ` ${man.toLocaleString()}` : ''}`;
        }
        return `${num.toLocaleString()}`;
    }

    function formatValue(type, val) {
        if (val === "" || val === undefined || val === null) return '-';
        const num = Number(val);
        const filterUnits = {
            floor: '층', sale: '만', deposit: '만', rent: '만',
            total_deposit: '만', total_rent: '만', area_py: '평'
        };
        if (['sale', 'deposit', 'rent', 'total_deposit', 'total_rent'].includes(type)) {
            if (isNaN(num)) return '-';
            return num >= 10000 ? `${Math.floor(num / 10000)}억${num % 10000 > 0 ? ` ${(num % 10000).toLocaleString()}` : ''}` : `${num.toLocaleString()}만`;
        }
        if (['floor', 'area_py'].includes(type)) return isNaN(num) ? '-' : num + filterUnits[type];
        return val;
    }

    function updateFilterButtonText(type) {
        let min = document.getElementById(`${type}_min`)?.value;
        let max = document.getElementById(`${type}_max`)?.value;
        let btn = document.getElementById(`filter-btn-${type}`);
        let label = "";
        if (min && max) label = `${formatValue(type, min)}~${formatValue(type, max)}`;
        else if (min) label = `${formatValue(type, min)}~`;
        else if (max) label = `~${formatValue(type, max)}`;
        else label = btn ? btn.getAttribute('data-default-label') || '▼' : '▼';
        
        if (btn) {
            btn.textContent = label;
            const isDefault = label === btn.getAttribute('data-default-label');
            Object.assign(btn.style, {
                backgroundColor: isDefault ? "#fff" : HIGHLIGHT_COLOR,
                color: isDefault ? "#374151" : "#111",
                borderColor: isDefault ? "#d1d5db" : "#eab308",
                fontWeight: isDefault ? "normal" : "bold",
            });
        }
    }
    
    function showListingsInPanel(listings) {
        matchedListingsCache = listings;
        matchedListingsPage = 1;
        if (typeof renderMatchedListings === "function") renderMatchedListings();
        infoPanel.classList.remove("hidden");
        infoPanel.style.display = 'block';
        setTimeout(() => {
            infoPanel.scrollTop = 0;
        }, 0);
    }
    
    function hideLogin() { document.getElementById('login-modal').classList.add('hidden'); }
    function showLogin() { document.getElementById('login-modal').classList.remove('hidden'); }

    async function logout() {
        await client.auth.signOut();
        window.location.replace(location.origin);
    }

    function getFilterValues() {
        const values = {};
        filterDefs.forEach(def => {
            values[`${def.id}_min`] = parseFloat(document.getElementById(`${def.id}_min`).value);
            values[`${def.id}_max`] = parseFloat(document.getElementById(`${def.id}_max`).value);
        });
        return values;
    }

    function filterListings(listings) {
        const f = getFilterValues();
        const filterMap = {
            floor: 'floor',
            sale: 'sale_price',
            deposit: 'deposit_price',
            rent: 'monthly_rent',
            total_deposit: 'total_deposit',
            total_rent: 'total_rent',
            area_py: 'area_py'
        };

        return listings.filter(l => {
            if (!selectedDealTypes.includes(l.deal_type)) return false;
            if (selectedCategories.length > 0 && !selectedCategories.includes(l.category)) return false;

            for (const key in filterMap) {
                const dbKey = filterMap[key];
                const minVal = f[`${key}_min`];
                const maxVal = f[`${key}_max`];

                if (!isNaN(minVal) && l[dbKey] < minVal) return false;
                if (!isNaN(maxVal) && l[dbKey] > maxVal) return false;
            }

            // ⬇️ 다중선택 셀렉트 필터 적용 (이제 l을 참조 가능)
            for (const [field, selectedValues] of Object.entries(selectFilterState)) {
                if (Array.isArray(selectedValues) && selectedValues.length > 0) {
                    const cur = (l[field] ?? '').toString().trim();
                    if (!selectedValues.includes(cur)) return false;
                }
            }

            return true;
        });
    }

    function toggleFilterPanel(type) {
        document.querySelectorAll('[id^="filter-panel-"]').forEach(panel => {
            if (panel.id === `filter-panel-${type}`) {
                panel.classList.toggle('hidden');
            } else {
                panel.classList.add('hidden');
            }
        });
    }
    
    function updateFilteredListingsDebounced() {
        if (updateTimer) clearTimeout(updateTimer);
        updateTimer = setTimeout(() => {
            updateFilteredListings();
        }, 150);
    }

    function updateFilteredListings() {
        const filtered = filterListings(Object.values(allListings));

        const level = map.getLevel();
        let gridSize;
        if (level <= 2) gridSize = 10;
        else if (level === 3) gridSize = 30;
        else if (level === 4) gridSize = 40;
        else gridSize = 50;
        createClusterer(gridSize);

        clusterer.clear();
        const markers = [];
        filtered.forEach(l => {
            if (!l.lat || !l.lng) return;
            if (!allMarkers[l.listing_id]) {
            const marker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(l.lat, l.lng),
                image: customImage
            });
            marker.listing_id = l.listing_id;
            allMarkers[l.listing_id] = marker;
            }
            markers.push(allMarkers[l.listing_id]);
        });
        clusterer.addMarkers(markers);

        // 🔥 여기서 "현재 클러스터에 포함된 모든 매물"의 대표 썸네일을 한 번에 캐시에 예열
        if (!_prewarmDoneOnce) {
            _prewarmDoneOnce = true;
            const allIdsInView = filtered.map(l => l.listing_id);
            // 캐시만 채움 (DOM 즉시 반영 X)
            loadPrimaryThumbsBatch(allIdsInView, { applyToDom: false }).catch(console.warn);
        }

        matchedListingsCache = filtered;
        matchedListingsPage = 1;
        renderMatchedListings();
    }

    function renderMatchedListings() {
        if (!Array.isArray(matchedListingsCache)) return;
        const end = matchedListingsPage * PAGE_SIZE;
        const listingsToShow = matchedListingsCache.slice(0, end);             

        infoContent.innerHTML = listingsToShow.map(l => {
            const statusRaw = l.transaction_status || '-';
            const status = statusRaw.trim().split(' ')[0];
            let bgStyle = 'background-color: #d1d5db; color: #37373d;';
            if (status === '진행중') bgStyle = 'background-color: #d9fae6; color: #00b74a;';
            else if (status === '계약완료') bgStyle = 'background-color: rgba(255,237,237); color: rgba(247,63,87); font-weight: 900;';
            
            const isActive = String(window.currentDetailListingId).trim() === String(l.listing_id).trim();
            const highlightStyle = isActive ? 'background-color: rgba(243,244,246);' : '';
            const logo = 'https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/baikuk-simbol.png';

            return `
                <div class="mb-1 pb-1 border-b border-gray-300 text-left" style="${highlightStyle};">
                    <div onclick="showDetailPanel(${l.listing_id})" class="cursor-pointer hover:bg-gray-100 transition">
                        <div class="flex flex-row items-center gap-3">
                            <div class="relative w-[140px] h-[100px]">
                                <div class="absolute top-1 right-1 w-[57px] h-[22px] flex items-center justify-center text-xs px-1 rounded-md font-semibold z-10" style="${bgStyle}">${status}</div>
                                <div 
                                    class="absolute top-1 left-1 w-[53px] h-[22px] flex items-center justify-center text-[15px] px-1 rounded-md font-semibold z-10"
                                    style="background-color: ${
                                        (l.is_public || '').toString().trim().includes('비공개') 
                                            ? '#d1d5db' 
                                            : '#F2C130'
                                    }; color: #37373d;">
                                    ${l.listing_id}
                                </div>
                                <img id="thumb-${l.listing_id}" src="${logo}" alt="썸네일" class="thumb-img-contain rounded no-save" draggable="false" oncontextmenu="return false" />
                            </div>                           
                            <div class="flex-1 flex flex-col gap-1">                                   
                                <div class="flex items-center gap-2">
                                    <div class="flex flex-row items-center">
                                        <div class="flex items-center gap-5 leading-[1.4]">
                                            <strong class="text-[15px] text-gray-800 max-w-[280px]" title="${l.listing_title}">${l.listing_title.length > 40 ? l.listing_title.slice(0, 40) + '⋯' : l.listing_title}</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-[2px] leading-[1.4]">
                                    <div class="flex flex-row justify-between items-start">
                                        <div class="flex items-start gap-2">
                                            <div class="flex-1 text-left font-bold text-[rgb(80,152,233)] text-base">
                                                ${l.deal_type} ${l.deal_type === "매매" ? ` ${formatKoreanMoney(l.sale_price)}` : l.deal_type === "월세" ? ` ${formatKoreanMoney(l.deposit_price)} / ${formatKoreanMoney(l.monthly_rent)}` : ""}
                                            </div>
                                        </div>                                        
                                        <div class="text-right font-bold text-[rgb(248,63,87)] text-base whitespace-nowrap">
                                            ${
                                                l.deal_type?.includes("월세")
                                                    ? (() => {
                                                        const price = l.premium_price;
                                                        if (parseFloat(price) === 0) return '무권리';
                                                        if (!price || price === '-' || isNaN(price)) return '';
                                                        if (parseFloat(price) > 0) return `권 ${formatKoreanMoney(price)}`;
                                                        return '';
                                                    })()
                                                    : l.deal_type?.includes("매매")
                                                    ? `${l.roi ? (parseFloat(l.roi) * 100).toFixed(1) : '-'}%`
                                                    : ''
                                            }
                                        </div>

                                    </div>
                                    <div class="flex-1 text-[16px]">
                                        <strong class="font-semibold">${l.floor < 0 ? `B${Math.abs(l.floor)}` : `${l.floor}`}</strong>/${l.total_floors}층
                                        <strong class="font-semibold">${Number(l.area_py).toFixed(0)}</strong>평
                                        <strong class="font-semibold">${(Number(l.monthly_rent)/Number(l.area_py)).toFixed(1)}</strong>만
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
        }).join('');

        // ▼ 새로 그려진 썸네일들에 대표사진 적용
        const ids = listingsToShow.map(l => l.listing_id);
        applyPrimaryThumbsFromCache(ids);
        loadPrimaryThumbsBatch(ids).catch(console.warn);
    }    

    // 속도 높이기 위해, 줌번화 이동 할때만 쿼리 하도록
    let _lastQuery = { lat: null, lng: null, level: null };
    function shouldQueryAgain(map) {
        const c = map.getCenter();
        const lv = map.getLevel();
        if (_lastQuery.level !== lv) { _lastQuery = { lat: c.getLat(), lng: c.getLng(), level: lv }; return true; }
        if (_lastQuery.lat === null) { _lastQuery = { lat: c.getLat(), lng: c.getLng(), level: lv }; return true; }
        // 중심이 약 200m 이상 변할 때만 (대략적인 라디안 → meters 변환 생략, 경험값)
        const dLat = Math.abs(c.getLat() - _lastQuery.lat);
        const dLng = Math.abs(c.getLng() - _lastQuery.lng);
        const movedEnough = (dLat + dLng) > 0.002; // 경험적 기준
        if (movedEnough) { _lastQuery = { lat: c.getLat(), lng: c.getLng(), level: lv }; return true; }
        return false;
    }
    function debounceLoadListings() {
        if (isFetching) return;
        if (mapIdleTimer) clearTimeout(mapIdleTimer);

        mapIdleTimer = setTimeout(() => {
            if (!isFetching && shouldQueryAgain(map)) {
                loadListingsInBounds().then(() => {
                    tryPrewarmVisibleThumbs(); // 👈 예열 시도
                });
            } else {
                tryPrewarmVisibleThumbs(); // 👈 줌 이동만 있더라도 예열
            }
        }, 250);
    }

    kakao.maps.event.addListener(map, 'idle', () => {
        debounceLoadListings();
    });

    async function loadListingsInBounds() {
        if (isFetching) return;
        isFetching = true;

        try {
            const bounds = map.getBounds();
            const sw = bounds.getSouthWest();
            const ne = bounds.getNorthEast();
            const tableToQuery = 'listing_with_primary';

            // 1. 주요 매물 데이터 조회
            const { data: listings, error: listingError } = await client
                .from(tableToQuery)
                .select('listing_id, lat, lng, listing_title, deal_type, deposit_price, monthly_rent, sale_price, total_deposit, total_rent, premium_price, roi, floor, total_floors, area_py, supply_area_py, area_m2, supply_area_m2, category, transaction_status, is_public, province, city, district, detail_address, addr_compare, primary_image_path')
                .gte('lat', sw.getLat()).lte('lat', ne.getLat())
                .gte('lng', sw.getLng()).lte('lng', ne.getLng());

            if (listingError) { console.error(listingError); return; }

            // 2. building_info 테이블에서 full_address와 building_note 가져오기
            const { data: latlngData, error: latlngError } = await client
                .from('building_info')
                .select('addr_compare, building_note, building_name');

            if (latlngError) {
                console.error("❌ building_info 에러:", latlngError);
            }

            // addr_compare 기준으로 building_info와병합
            const latLngMap = Object.fromEntries(
                latlngData.map(l => {
                    const key = String(l.addr_compare || '').replace(/\s+/g, '').trim();
                    const building_name_raw = l.building_name; // 원본 그대로 저장

                    const value = {
                    building_note: (l.building_note && l.building_note !== '.' ? l.building_note : '-'),
                    building_name: (building_name_raw && building_name_raw !== '.' ? building_name_raw : '-')
                    };

                    return [key, value];
                })
            );

            // listings에 building_info와 병합
            const mergedData = listings.map(l => {
                const key = normalizeAddr(l.addr_compare);   // 공백 삭제 + trim으로 통일
                const info = latLngMap[key] || { building_note: '-', building_name: '-' };
                const merged = {
                    ...l,
                    building_note: info.building_note,
                    building_name: info.building_name
                };
                // console.log("🔗 병합된 listing:", key, merged);
                return merged;
            });


            // 5. 전역 저장
            allListings = Object.fromEntries(mergedData.map(l => [String(l.listing_id), l]));

            // 6. 지도에 표시
            updateFilteredListings();

        } finally {
            isFetching = false;
        }
    }

    kakao.maps.event.addListener(map, 'click', () => {
        detailScrollTop = 0;  // ✅ 스크롤 위치 초기화
        window.currentDetailListingId = null;  // ✅ 현재 열려있던 매물 ID 초기화
        hideDetailPanel();
    });
    
    document.addEventListener('DOMContentLoaded', async () => {
        // ✅ 첫 로드 때 사이드패널/상세패널 닫기
        closeSidePanel();
        hideDetailPanel(true); // URL은 건드리지 않도록 skipUrl=true
        renderDealAndCategoryButtons();
        renderFilterButtons();

        await renderAffiliationBadge();
        isLoggedIn = true;
        document.getElementById('logout-btn')?.classList.remove('hidden');

        await loadListingsInBounds();

        // 👇 몰래 예열
        const idsForWarm = Object.values(allListings).slice(0, 500).map(l => l.listing_id);
        ensureThumbsReady(idsForWarm, { timeout: 1000 }).catch(()=>{});

        const deepId = getListingIdFromURL();
        if (deepId) await openDeepLink(deepId);   // ✅ URL에 id 있으면 바로 열기

        // ✅ 여기 교체!
        (async () => {
            const idFromUrl = getListingIdFromURL();
            if (idFromUrl) {
            try {
                await ensureListingLoaded(idFromUrl);  // 먼저 메모리에 보장
                await showDetailPanel(idFromUrl);      // 그 다음 상세 패널 오픈
            } catch (e) {
                console.error(e);
                showToast('URL의 매물 정보를 불러오지 못했습니다.');
            }
            }
        })();
        
        renderDealFields();
        const listing = allListings?.[window.currentDetailListingId];
        if (listing) renderDealFieldsViewer(listing);
        
        // ✅ 매물등록 버튼 이벤트 바인딩
        // 1) 매물등록 버튼 바인딩 (그대로 유지)
        const newBtn = document.getElementById('open-listing-form-btn');
        if (newBtn) {
            let creating = false;
            newBtn.addEventListener('click', async () => {
                if (creating) return;
                creating = true;
                try {
                // 수동 클릭 시 켜지는 편집 모드 로직 그대로 타게 함
                window.isEditMode = true;
                await openNewListing();
                } finally {
                creating = false;
                }
            });
        }

        // 2) URL 파라미터로 자동 실행 (버튼을 '실제로' 클릭)
        const params = new URLSearchParams(location.search);
        const shouldAutoOpen =
        params.get('autoclick') === 'open-listing' || params.get('mode') === 'new';

        if (shouldAutoOpen) {
        const started = Date.now();
        const TIMEOUT = 7000;

        const tick = setInterval(() => {
            // 버튼이 DOM에 붙고, 클릭 핸들러가 바인딩된 뒤에 실행되도록 대기
            const btn = document.getElementById('open-listing-form-btn');
            if (btn) {
            // 수동 클릭과 동일 경로로 실행 → 편집모드/UI 토글까지 동일하게 동작
            btn.click();
            clearInterval(tick);
            return;
            }
            if (Date.now() - started > TIMEOUT) {
            clearInterval(tick);
            console.warn('[autoclick] open-listing-form-btn을 찾지 못했습니다. ID를 확인하세요.');
            }
        }, 120);
        }
    });

    // 진행중, 보류, 계약완료 선택 필터링 관련
    window.__selectFilterMeta = window.__selectFilterMeta || {};
    window.__selectFilterMeta.transaction_status = {
        options: ['진행중', '보류', '계약완료']  // DB에 실제 들어가는 값에 맞게 조정
    };

    renderSelectFilter({
        containerId: 'select-filter-wrap',   // 원하는 div id
        field: 'transaction_status',         // 테이블 컬럼명 그대로
        label: window.__selectFilterMeta.transaction_status.label,
        options: window.__selectFilterMeta.transaction_status.options
    });

    const setupControlButtons = () => {
        document.getElementById('btn-zoom-in').onclick = () => map.setLevel(map.getLevel() - 1);
        document.getElementById('btn-zoom-out').onclick = () => map.setLevel(map.getLevel() + 1);
        document.getElementById('btn-current-location').onclick = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    map.setCenter(new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude));
                });
            }
        };
        
        document.getElementById('btn-naver-map').onclick = () => {
            const curId = window.currentDetailListingId;
            const l = curId ? allListings?.[String(curId)] : null;

            if (l) {
                const query = getFullAddressForListing(l);
                if (query) {
                window.open(`https://map.naver.com/v5/search/${encodeURIComponent(query)}`, '_blank');
                return;
                }
            }
            // 폴백: 주소가 없으면 기존 좌표 방식으로
            const c = map.getCenter();
            window.open(`https://map.naver.com/v5/?c=${c.getLng()},${c.getLat()},17,0,0,0,d`, '_blank');
        };


    };
    setupControlButtons();

    document.getElementById('info-panel').addEventListener('scroll', function () {
        if (this.scrollTop + this.clientHeight >= this.scrollHeight - 50) {
            if (matchedListingsPage * PAGE_SIZE < matchedListingsCache.length) {
                matchedListingsPage++;
                renderMatchedListings();
            }
        }
    });

    window.resetFilters = resetFilters;
    
    window.fetchWorkLogs = async function(listingId) {

    const { data, error } = await client
        .from("work_log")
        .select("*")
        .eq("listing_id", listingId)
        .order("Registration_date", { ascending: false });

    if (error) {
        console.error("❌ 업무일지 가져오기 실패:", error);
        renderWorkLogPanel([]);  // 빈 상태 표시
        return [];
    }

    // 화면에 실제로 렌더링
    renderWorkLogPanel(data);

    // 필요 시 호출부에서 활용할 수 있도록 반환
    return data;
    };

  </script>
  <!-- 오른쪽 아래 안내창 -->
  <div id="toast-container" class="fixed bottom-4 right-4 z-[9999] space-y-2"></div> 
    <!-- 호수 입력 모달 -->
    <div id="unit-modal"
        class="fixed inset-0 z-[21000] bg-black/40 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 w-80">
            <h3 class="font-bold text-lg mb-3">호수가 있나요?</h3>
            <input id="unit-modal-input" type="text"
                class="w-full border border-gray-300 rounded px-3 py-2 mb-4"
                placeholder="예: 109호" />
            <div class="flex gap-2 justify-end">
            <button id="unit-modal-no"
                    class="px-3 py-1.5 rounded border border-gray-300 text-gray-700 hover:bg-gray-100">
                아니오
            </button>
            <button id="unit-modal-yes"
                    class="px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700">
                예
            </button>
            </div>
        </div>
    </div>
</body>
</html>