<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ë°±ì–µì§€ë„</title>
    <link rel="icon" type="image/png" href="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/pabicon-baikuk-simbol.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lightgallery.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lg-zoom.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lg-thumbnail.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lg-fullscreen.css">
    <link rel="preconnect" href="https://sfinbtiqlfnaaarziixu.supabase.co" crossorigin>
    <link rel="dns-prefetch" href="//sfinbtiqlfnaaarziixu.supabase.co">
    <script src="https://cdn.jsdelivr.net/npm/lightgallery/lightgallery.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightgallery/plugins/zoom/lg-zoom.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightgallery/plugins/thumbnail/lg-thumbnail.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightgallery/plugins/fullscreen/lg-fullscreen.umd.js"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f605c7b72dc7f3083f36483e55e2bc77&libraries=clusterer,services"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script> 
        window.REQUIRE_AUTH = true;   // adminì€ í•­ìƒ ì¸ì¦ í•„ìš”
        window.LOGIN_PAGE = 'index.html';
        const BUCKET = 'listing-images'; //ì´ë¯¸ì§€ ê´€ë ¨ ë³€ìˆ˜
        window.BUCKET = 'listing-images'; // ë²„í‚·ëª…
        window.BUCKET_IS_PUBLIC = false;  // ë²„í‚·ì´ Publicì´ë©´ true (Privateë©´ false)
        // í˜ì´ì§€ë„¤ì´ì…˜/ì¢Œì¸¡ ëª©ë¡ ìºì‹œ (ì´ˆê¸°ê°’)
        let matchedListingsCache = [];
        let matchedListingsPage = 0;
        let _prewarmDoneOnce = false; //ì´ë¯¸ì§€ ìºì‹± ê´€ë ¨ ë³€ìˆ˜
        let lastPrewarmHash = null;  // ì´ì „ì— ì˜ˆì—´í•œ IDë“¤ í•´ì‹œ ì €ì¥
        let _imgReqToken = 0;
        // ì „ì—­ ìƒíƒœ: í•„ë“œë³„ ì„ íƒê°’ (ì˜ˆ: { direction: ['ë‚¨','ì„œ'], building_usage: ['ì œ1ì¢… ê·¼ë¦°ìƒí™œì‹œì„¤'] })
        const selectFilterState = {}; 
        selectFilterState['transaction_status'] = ['ì§„í–‰ì¤‘'];
    </script>
    <style>
        .image-wm { position: relative; overflow: hidden; }
        .thumb-box { background:#f3f4f6; overflow:hidden; }
        .thumb-img-contain { width:100%; height:100%; object-fit: contain; object-position:center; background:#fff; }
        .no-save {
            -webkit-user-drag: none; user-select: none; -webkit-user-select: none;
            -ms-user-select: none; -webkit-touch-callout: none;
        }
        #image-viewer-slot:empty { display: none; }
        #img-list .group:hover img { outline: 2px dashed rgba(0,0,0,0.15); } /* ì„ íƒëª¨ë“œì—ì„œ hover ì‹œ êµ¬ë¶„ê° */
    </style>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        const supabaseUrl = 'https://sfinbtiqlfnaaarziixu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaW5idGlxbGZuYWFhcnppaXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MDkxNjEsImV4cCI6MjA2ODA4NTE2MX0.4-7vnIjbF-biWWuv9-vTxK9Y99gMm-vS6oaRMdRL5fA';
        
        // ğŸ”§ ì„¸ì…˜ ì˜êµ¬ ìœ ì§€ + ìë™ ê°±ì‹ 
        window.supabase = createClient(supabaseUrl, supabaseKey, {
            auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
        });

        // âœ… ì´í›„ ì½”ë“œëŠ” clientë¡œë§Œ ì‚¬ìš©(í˜¼ìš© ë°©ì§€)
        const client = window.supabase;
        window.client = client;
        
        // âœ… ë°°í¬ ì„œë¸ŒíŒ¨ìŠ¤ì—ì„œë„ ì•ˆì „í•œ ì´ë™ ìœ í‹¸
        const BASE = location.pathname.replace(/[^/]*$/, '');
        const here = (location.pathname.split('/').pop() || '/admin');

        function go(page){
            const targetUrl = new URL(page.startsWith('/') ? page : BASE + page, location.origin);
            if (location.pathname === targetUrl.pathname && location.search === targetUrl.search) return;
            location.replace(targetUrl.href);
        }

        window.go = go; // (onclick ë“±ì—ì„œ ì“¸ ìˆ˜ ìˆê²Œ)

        // ë²„íŠ¼ í† ê¸€ ìœ í‹¸
        function toggleAuthButtons(has) {
            document.getElementById('logout-btn')?.classList.toggle('hidden', !has);
            document.getElementById('change-password-btn')?.classList.toggle('hidden', !has);
        }

        // â”€â”€ Auth ê°€ë“œ: ë…¼ë¸”ë¡œí‚¹ + íƒ€ì„ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        // getSessionì´ ì§€ì—°ë¼ë„ í™”ë©´ì´ ë©ˆì¶”ì§€ ì•Šë„ë¡ íƒ€ì„ì•„ì›ƒ ì ìš©
        async function getSessionNonBlocking(timeoutMs = 1500) {
            const TIMEOUT = new Promise((resolve) =>
                setTimeout(() => resolve('__TIMEOUT__'), timeoutMs)
            );
            try {
                const res = await Promise.race([
                client.auth.getSession().then(r => (r?.data?.session ?? null)).catch(() => null),
                TIMEOUT
                ]);
                return res; // null | session | '__TIMEOUT__'
            } catch {
                return null;
            }
        }

        // ì´ˆê¸° 1íšŒ: ì„¸ì…˜ ì—†ìœ¼ë©´ (ê´€ë¦¬ì˜ì—­ì´ë©´) ë£¨íŠ¸ë¡œ, ì„¸ì…˜ ìˆìœ¼ë©´ ë²„íŠ¼/ë±ƒì§€ ì„¸íŒ…
        async function runAdminGuardOnce() {
            const session = await getSessionNonBlocking(1500);

            if (session === '__TIMEOUT__') {
                console.warn('[auth] getSession timeout â†’ continue rendering and check later');
                toggleAuthButtons(false); // ì¼ë‹¨ ë¹„ë¡œê·¸ì¸ UIë¡œ
                return;
            }

            const isAuthed = !!session;
            toggleAuthButtons(isAuthed);

            // /admin í•˜ìœ„ ê²½ë¡œì—ì„œ ë¹„ë¡œê·¸ì¸ â†’ ë£¨íŠ¸ë¡œ
            if (!isAuthed && location.pathname.startsWith('/admin')) {
                const url = new URL('/', location.origin);
                // ì¿¼ë¦¬ìŠ¤íŠ¸ë§ì„ ë³´ì¡´í•˜ê³  ì‹¶ìœ¼ë©´ ìœ ì§€
                if (location.search) url.search = location.search;
                location.replace(url.href);
                return;
            }

            // ë°°ì§€ ë Œë” (DOM ì¤€ë¹„ í›„ 1íšŒ)
            document.addEventListener('DOMContentLoaded', () => {
                window.renderAffiliationBadge?.();
            });
        }

        // ìƒíƒœ ë³€í™”: ë¡œê·¸ì•„ì›ƒ ì‹œ (ê´€ë¦¬ì˜ì—­ì´ë©´) ë£¨íŠ¸ë¡œ, ë¡œê·¸ì¸ ì‹œ UI/ë±ƒì§€ ê°±ì‹ 
        client.auth.onAuthStateChange((_evt, session) => {
            const isAuthed = !!session;
            toggleAuthButtons(isAuthed);

            if (!isAuthed && location.pathname.startsWith('/admin')) {
                const url = new URL('/', location.origin);
                if (location.search) url.search = location.search;
                location.replace(url.href);
                return;
            }

            window.renderAffiliationBadge?.();
        });

        // ì‹¤í–‰
        runAdminGuardOnce();

        // ì•± ì´ˆê¸°í™” (ì¸ì¦ ë“±)
        if (window.initializeApp) {
            initializeApp();
        }

    </script>

    <style>
        :root {
            --header-height: 3.5rem;
            --infopanel-left: 23.5%;
            --header-button-height: 1.6rem !important; /* âœ… ëª¨ë“  í—¤ë” ë²„íŠ¼ ë†’ì´ë¥¼ ì œì–´í•  ë³€ìˆ˜ */
        }
        body { margin: 0; padding: 0; }
        header { position: fixed; top: 0; left: 0; right: 0; height: var(--header-height); z-index: 10000; background: #fff; }
        #map { position: absolute; top: var(--header-height); left: var(--infopanel-left); right: 0; bottom: 0; z-index: 0; }
        #info-panel { position: absolute; top: var(--header-height); left: 0; width: var(--infopanel-left); bottom: 0; z-index: 50; background: #fff; }
        #detail-panel { position: absolute; top: var(--header-height); left: var(--infopanel-left); width: 40%; bottom: 0; z-index: 9999; border-left: 0.3rem solid #e5e7eb;}
        #filter-bar { display: flex; flex-direction: column; gap: 2px; margin-top: 0; }
        
        /* âœ… í—¤ë” ì•ˆì˜ ëª¨ë“  ë²„íŠ¼ì— ìŠ¤íƒ€ì¼ ì ìš© */
        header button {
            height: var(--header-button-height);
            font-size: 0.8rem !important;
            display: flex;
            align-items: center;
            padding-top: 0;
            padding-bottom: 0;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }
        .animate-fade-in-out {
            animation: fadeInOut 3s ease-in-out forwards;
        }
        #black-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            opacity: 0.8;
            z-index: 99999;
            pointer-events: none;
        }
        .two-line{
            display:-webkit-box;
            -webkit-box-orient:vertical;
            -webkit-line-clamp:2;
            overflow:hidden;
            line-height:1.4; /* ì¤„ë†’ì´ ê³ ì •(ì¸¡ì •/ì ìš©ì— ë™ì¼ ì‚¬ìš©) */
        }
    </style>
</head>
<body class="m-0 p-0">
    <header class="flex items-center gap-4 w-full h-8 sm:h-10 md:h-12 px-2 sm:px-3 md:px-4 bg-white shadow-md border-b border-gray-200 fixed top-0 left-0 z-[10000]">
        <a href="/admin/listings/">
            <img src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/logotype-baikuk.png"
             alt="ê¸€ì”¨ë¡œê³ " class="h-11 w-auto cursor-pointer" />
        </a>        
        <div class="relative">
            <button id="filter-btn-init" data-default-label="ì´ˆê¸°í™”" onclick="resetFilters()"
                    class="ml-[2rem] ml-[1rem] px-3 py-1.5 border border-gray-200 bg-red-100 text-red-600 rounded-md shadow-sm text-sm font-bold hover:bg-red-200 transition">ì´ˆê¸°í™”</button>
        </div>
        <div id="select-filter-wrap"></div>
        <div id="filter-bar" class="mr-[1rem] ml-[1rem] flex flex-row gap-2 items-start mt-2 relative z-[1000]">
            <div id="btn-wrap" class="flex flex-row gap-2"></div>
        </div>
        <button id="filter-btns-wrap" class="flex gap-1"></button>
        <div class="ml-auto flex items-center gap-2">
            <button id="open-listing-form-btn" class="text-sm text-gray-600 hover:text-black border px-3 py-1 rounded">
                ğŸ¢ ë§¤ë¬¼ë“±ë¡
            </button>
            <button id="logout-btn"
                    onclick="logout()"
                    class="hidden text-sm text-gray-600 hover:text-black border px-3 py-1 rounded">
                ğŸ”“ ë¡œê·¸ì•„ì›ƒ
            </button>
        </div>
    </header>
    <button id="btn-naver-map"
            class="hidden w-10 h-10 shadow rounded-lg flex items-center justify-center border border-gray-300 bg-[#00de5a] hover:bg-[#00b74a] transition mb-3 text-white text-[28px] font-black"
            style="text-shadow: 0 1px 2px #ffffff, 0 0 1px #ffffff;"
            title="ë„¤ì´ë²„ì§€ë„">
        N
    </button>
    <div id="login-modal"
         class="fixed inset-0 z-[20000] bg-black/40 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-lg p-8 w-80">
            <h2 class="font-bold text-xl mb-4 text-center">ì§ì› ë¡œê·¸ì¸</h2>
            <input id="login-email" type="email" placeholder="ì´ë©”ì¼"
                   class="w-full border border-gray-300 rounded px-3 py-2 mb-3" />
            <input id="login-password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"
                   class="w-full border border-gray-300 rounded px-3 py-2 mb-4" />
            <button onclick="login()"
                    class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-semibold">
                ë¡œê·¸ì¸
            </button>
            <button onclick="hideLogin()"
                    class="w-full text-gray-500 mt-2">ë‹«ê¸°</button>
            <div id="login-error" class="text-red-600 text-sm mt-2 hidden"></div>
        </div>
    </div>
    
    <div id="map" class="absolute top-0 bottom-0 right-0 left-[25%] z-0"></div>
    <div id="map-controls" class="fixed z-[11000] flex flex-col items-center bottom-10  right-5">
        
        <button id="btn-current-location"
                class="w-9 h-9 sm:w-10 sm:h-10 shadow rounded-lg flex items-center justify-center border border-gray-300 bg-white hover:bg-yellow-200 transition mb-5"
                title="í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™">
            <span class="text-xl text-black font-bold">â—‰</span>
        </button>
        <div class="flex flex-col space-y-1">
            <button id="btn-zoom-in"
                    class="w-9 h-9 sm:w-10 sm:h-10 shadow rounded-lg flex items-center justify-center border border-gray-300 bg-white hover:bg-yellow-200 transition"
                    title="í™•ëŒ€">
                <span class="text-2xl text-black font-bold">ï¼‹</span>
            </button>
            <button id="btn-zoom-out"
                    class="w-9 h-9 sm:w-10 sm:h-10 shadow rounded-lg flex items-center justify-center border border-gray-300 bg-white hover:bg-yellow-200 transition"
                    title="ì¶•ì†Œ">
                <span class="text-2xl text-black font-bold">ï¼</span>
            </button>
        </div>
    </div>

    <div id="info-panel" class="absolute top-0 bottom-0 left-0 w-[25%] overflow-y-auto bg-white shadow-xl p-3 text-sm hidden z-50">
        <div id="info-content" class="text-xs text-gray-700"></div>
    </div>

    <div id="detail-panel"
         class="absolute top-[var(--header-height)] left-[25%] w-[40%] min-w-[300px] max-w-[35rem] bottom-0 bg-white shadow-xl relative z-[1000] hidden">

        <button 
            id="close-detail-btn"
            onclick="hideDetailPanel()"
            class="absolute top-2 right-4 w-8 h-8 bg-white text-gray-600 border border-gray-300 hover:border-black hover:text-black shadow-md flex items-center justify-center font-bold text-lg z-[1001]">
            âœ•
        </button>

        <div id="detail-content" class="text-gray-800 text-sm whitespace-pre-line overflow-y-auto h-full px-4"></div>
    </div> 
    <div id="side-panel"
        class="pl-2 pt-2 absolute border-l border-gray-200 top-[var(--header-height)] left-[52.7%] w-[24rem] bottom-0 bg-white shadow-xl overflow-y-auto z-[1100]"
        style="border-left-width: 0.35rem;">
    </div>

  <script>

    const _nz = (s) => (s ?? '').toString();
    const normalizeAddr = (s) => _nz(s).replace(/\s+/g, '').trim();

    const HIGHLIGHT_COLOR = "#F2C130";
    const HIGHLIGHT_TEXT_COLOR = "#111";
    const DEFAULT_BTN_BG = "#f3f4f6";
    const DEFAULT_BTN_TEXT = "#374151";

    const PAGE_SIZE = 15;
    const allDealTypes = ['ì›”ì„¸', 'ë§¤ë§¤'];
    const allCategories = ['ìƒê°€', 'ê³µì¥Â·ì°½ê³ ', 'ì£¼íƒ'];
    const infoPanel = document.getElementById('info-panel');
    const infoContent = document.getElementById('info-content');
    // ë„¤ì´ë²„ ë¶€ë™ì‚°(ëœë“œ) ë²„íŠ¼ ì•„ì´ì½˜ URL - Supabaseì˜ ì´ë¯¸ì§€ URLë¡œ êµì²´í•˜ì„¸ìš”
    const LAND_ICON_URL = 'https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/naver_land_icon.png';

    
    const filterDefs = [
        { id: 'deposit',       label: 'ë³´ì¦ê¸ˆ',   width: 300 },
        { id: 'rent',          label: 'ì›”ì„¸',     width: 280 },
        { id: 'floor',         label: 'ì¸µ',       width: 280 },
        { id: 'area_py',       label: 'ì „ìš©í‰ìˆ˜', width: 280 },
        { id: 'sale',          label: 'ë§¤ë§¤ê°€',   width: 300 },
        { id: 'total_deposit', label: 'ì´ë³´ì¦ê¸ˆ', width: 300 },
        { id: 'total_rent',    label: 'ì´ì›”ì„¸',   width: 280 },
    ];
    
    const formatNumber = (val) => {
        const num = parseFloat(val);
        if (isNaN(num)) return '';
        return Number.isInteger(num) ? num.toString() : num.toFixed(1);
    };

    let selectedDealTypes = ['ì›”ì„¸'];
    let selectedCategories = ['ìƒê°€'];
    
    let allListings = {};
    let allMarkers = {};
    let map, customImage;
    window.map = map;
    let clusterer, mapIdleTimer = null;
    let isFetching = false;

    let selectedClusterEl = null;
    let isLoggedIn = false;
    let currentGridSize = null;
    let updateTimer = null;
    let isEditMode = false;
    let detailScrollTop = 0;
    let _previewUrls = []; //ì‚¬ì§„ ê´€ë ¨ë³€ìˆ˜
    let publicBulkMode = true; // ê³µê°œ ì´ë¯¸ì§€ ì¼ê´„ì‚­ì œ ì „ì—­ ìƒíƒœ

    // ì´ë¯¸ì§€ ì‹œê°„ë‹¨ì¶• ìœ„í•´ì„œ ìºì‹œ ê´€ë ¨ í•¨ìˆ˜
    // ì´ë¯¸ì§€ ì—¬ëŸ¬ë²ˆ ë¶€ë¥´ë©´ ë§¤ë²ˆ ì„œëª… ìš”ì²­ ê´€ë ¨ ê°„ë‹¨ ìºì‹œ
    const _imgUrlCache = new Map();
    async function _memo(key, fn) {
        if (_imgUrlCache.has(key)) return _imgUrlCache.get(key);
        const v = await fn();
        _imgUrlCache.set(key, v);
        return v;
    }

    map = new kakao.maps.Map(document.getElementById('map'), {
      center: new kakao.maps.LatLng(37.7151, 126.7341),
      level: 3
    });

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            map.setCenter(new kakao.maps.LatLng(lat, lng));
        }, function(error) {
            console.log("ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", error);
        });
    } else {
        console.log("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }

    infoPanel.style.display = 'block';

    customImage = new kakao.maps.MarkerImage(
      'https://raw.githubusercontent.com/mhale45/image/2d7ce4379b14d095d2f0b7f1d0057987548a37bf/2.png',
      new kakao.maps.Size(36, 36),
      { offset: new kakao.maps.Point(18, 36) }
    );

    // ìŠ¤í¬ë¦½íŠ¸ í•¨ìˆ˜ë“¤ ì‹œì‘

    const _staffAffCache = new Map();
    // ì§€ì  ë°°ì§€ ë Œë”ë§ (ì „ì—­ì— ë…¸ì¶œ)
    window.renderAffiliationBadge = async function renderAffiliationBadge(agentName) {
        const el = document.getElementById('affiliation-badge');
        if (!el) return;

        try {
            // 1) ëŒ€ìƒ ì´ë¦„ ê²°ì • (íŒŒë¼ë¯¸í„° > í˜„ì¬ ìƒì„¸ ë§¤ë¬¼)
            let name =
            (agentName ||
            allListings?.[String(window.currentDetailListingId)]?.agent_name ||
            ''
            ).toString().trim();

            if (!name) {
            el.textContent = '';
            el.classList.add('hidden');
            return;
            }

            // (ì„ íƒ) ë‚´ë¶€ idâ†’í‘œì‹œëª… ë§¤í•‘ì´ ìˆë‹¤ë©´ í‘œì‹œëª…ìœ¼ë¡œ ì •ê·œí™”
            if (window.resolveAgentDisplayName) {
                const disp = await window.resolveAgentDisplayName(name);
                if (disp) name = disp.toString().trim();
            }
            // (ì„ íƒ) ì§í•¨/ê´„í˜¸ ë“± ì œê±°ê°€ í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ ì •ë¦¬
            name = name.replace(/\s*\([^)]+\)\s*$/, '').trim();

            // 2) ìºì‹œ ì¡°íšŒ
            let aff = _staffAffCache.get(name);

            // 3) DB ì¡°íšŒ (ì •í™• ì¼ì¹˜ â†’ ì—†ìœ¼ë©´ ë¶€ë¶„/ëŒ€ì†Œë¬¸ì ë¬´ì‹œ ë§¤ì¹­)
            if (!aff) {
            let q = await client
                .from('public_staff_view')
                .select('name, affiliation')
                .eq('name', name)
                .limit(1);

            if (q.error) throw q.error;

            if (!q.data?.length) {
                q = await client
                .from('public_staff_view')
                .select('name, affiliation')
                .ilike('name', `%${name}%`)
                .limit(1);
            }

            aff = q.data?.[0]?.affiliation || '';
            if (aff) _staffAffCache.set(name, aff);
            }

            // 4) í´ë°±: ê·¸ë˜ë„ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ ì‚¬ìš©ì ì†Œì†
            if (!aff) {
            const ctx = await (window.getAuthContext?.() || {});
            aff = (ctx.me?.affiliation ?? '').toString().trim();
            }

            // 5) ë Œë”
            if (!aff) {
            el.textContent = '';
            el.classList.add('hidden');
            return;
            }

            el.classList.remove('hidden');
            el.innerHTML = `<span class="inline-flex items-center px-2 py-1 rounded-full border border-gray-200 bg-gray-50">${window.safeDisplay ? window.safeDisplay(aff) : aff}
            </span>
            `;
        } catch (e) {
            console.warn('affiliation ë Œë” ì‹¤íŒ¨:', e);
            el.textContent = '';
            el.classList.add('hidden');
        }
    };

    // listingì—ì„œ ê²€ìƒ‰ìš© ì „ì²´ ì£¼ì†Œ ë¬¸ìì—´ ë§Œë“¤ê¸°
    function getFullAddressForListing(listing){
        const norm = (v) => (v ?? '').toString().trim();
        const bad  = (s) => !s || s === '-' || s === '.' || s.toLowerCase() === 'null' || s.toLowerCase() === 'undefined';

        // 1) building_infoì—ì„œ í•©ì³ì˜¨ í•„ë“œê°€ ìˆìœ¼ë©´ ìµœìš°ì„ 
        const fromBI = norm(listing.full_address || listing.building_full_address);
        if (!bad(fromBI)) return fromBI;

        // 2) ê°œë³„ í•„ë“œë¡œ ì¡°ë¦½
        const parts = [norm(listing.province), norm(listing.city), norm(listing.district), norm(listing.detail_address)]
            .filter(s => !bad(s));
        return parts.join(' ').trim();
    }

    async function ensurePrimaryAfterDeletion(listingId){
        try {
            // ë‚¨ì€ ê³µê°œ ì´ë¯¸ì§€ ì¤‘ ëŒ€í‘œ ìœ ë¬´ í™•ì¸
            const { data: hasPrim } = await client
            .from('listing_images')
            .select('id')
            .eq('listing_id', String(listingId))
            .eq('is_private', false)
            .eq('is_primary', true)
            .limit(1);
            if (Array.isArray(hasPrim) && hasPrim.length) return; // ì´ë¯¸ ëŒ€í‘œ ìˆìŒ

            // ëŒ€í‘œ ì—†ìœ¼ë©´ order_index ê°€ì¥ ì‘ì€ í•œ ì¥ì„ ëŒ€í‘œë¡œ ì§€ì •
            const { data: remain } = await client
            .from('listing_images')
            .select('id')
            .eq('listing_id', String(listingId))
            .eq('is_private', false)
            .order('order_index', { ascending: true })
            .limit(1);
            if (remain && remain[0]?.id){
            await client
                .from('listing_images')
                .update({ is_primary: true })
                .eq('id', remain[0].id);
            }
        } catch (e) {
            console.warn('ensurePrimaryAfterDeletion error', e);
        }
    }

    // ì‚¬ì§„ ì¼ê´„ì‚­ì œ ê´€ë ¨
    async function bulkDeleteSelectedPublicImages(listingId){
        const selected = Array.from(document.querySelectorAll('#img-list input.img-select:checked'));
        if (!selected.length) { showToast('ì„ íƒëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

        // 1) data-id/data-path ì •ê·œí™” + ê²€ì¦ (UUID/ìˆ«ì ëª¨ë‘ í—ˆìš©, ë¹ˆê°’ë§Œ ì œê±°)
        const ids = selected
            .map(el => (el.dataset?.id ?? '').toString().trim())
            .filter(v => v && v !== 'null' && v !== 'undefined'); // ë¬¸ìì—´ ê·¸ëŒ€ë¡œ ìœ ì§€
        const paths = selected
            .map(el => (el.dataset?.path ?? '').toString().trim())
            .filter(Boolean);

        // 2) ë°©ì–´: ìœ íš¨ id ì—†ìœ¼ë©´ ì¤‘ë‹¨
        if (!ids.length) { 
            console.warn('[bulkDelete] invalid ids from checkboxes:', selected.map(el => el.dataset?.id));
            showToast('ì‚­ì œí•  ì´ë¯¸ì§€ IDë¥¼ ì½ì§€ ëª»í–ˆì–´ìš”. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
            return;
        }

        if (!confirm(`ì„ íƒëœ ${ids.length}ì¥ì„ ì‚­ì œí• ê¹Œìš”?`)) return;

        // ëŒ€í‘œì»·ì´ í¬í•¨ë˜ì—ˆëŠ”ì§€ í™•ì¸
        let primaryDeleted = false;
        try {
            const { data: prim } = await client
            .from('listing_images')
            .select('id')
            .eq('listing_id', String(listingId))
            .eq('is_private', false)
            .eq('is_primary', true)
            .maybeSingle();
            if (prim && ids.includes(prim.id)) primaryDeleted = true;
        } catch {}

        // 1) DB ì‚­ì œ
        const { error: dbErr } = await client
            .from('listing_images')
            .delete()
            .in('id', ids)
            .eq('listing_id', String(listingId))
            .eq('is_private', false);
        if (dbErr){ showToast('DB ì‚­ì œ ì‹¤íŒ¨: ' + dbErr.message); return; }

        // 2) ìŠ¤í† ë¦¬ì§€ ì‚­ì œ (ë°°ì¹˜)
        const { error: stErr } = await client.storage.from(BUCKET).remove(paths);
        if (stErr){ showToast('ìŠ¤í† ë¦¬ì§€ ì¼ë¶€ ì‚­ì œ ì‹¤íŒ¨: ' + stErr.message); }

        // 3) ëŒ€í‘œì»·ì´ ì‚¬ë¼ì¡Œë‹¤ë©´ ì¬ì§€ì •
        if (primaryDeleted){
            await ensurePrimaryAfterDeletion(listingId);
        }

        // 4) UI ê°±ì‹ 
        await loadListingImages(listingId);
        await initImageViewer(listingId); // ìƒì„¸ 2ì¥ ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
        showToast('ì„ íƒ ì´ë¯¸ì§€ ì‚­ì œ ì™„ë£Œ');
    }
    
    // ì‚¬ì§„ ì¼ê´„ì‚­ì œ ê´€ë ¨
    function setupPublicBulkToolbar(listingId){
        const listBox = document.getElementById('img-list');
        if (!listBox) return;

        // ê¸°ì¡´ íˆ´ë°” ìˆìœ¼ë©´ êµì²´
        document.getElementById('img-bulk-toolbar')?.remove();

        const wrap = document.createElement('div');
        wrap.id = 'img-bulk-toolbar';
        wrap.className = 'flex items-center gap-2 mb-2';

        wrap.innerHTML = `
            <button id="btn-bulk-all" class="px-2 py-1 border rounded">ì „ì²´ì„ íƒ</button>
            <button id="btn-bulk-none" class="px-2 py-1 border rounded">ì „ì²´í•´ì œ</button>
            <button id="btn-bulk-del" class="px-2 py-1 border rounded text-red-600 border-red-400">ì„ íƒì‚­ì œ</button>
        `;

        // ë¦¬ìŠ¤íŠ¸ ë°”ë¡œ ìœ„ì— ê½‚ê¸°
        listBox.parentElement?.insertBefore(wrap, listBox);

        // ì´ë²¤íŠ¸
        document.getElementById('btn-bulk-all').onclick = () => {
            document.querySelectorAll('#img-list input.img-select').forEach(cb => {
                cb.checked = true;
                cb.dispatchEvent(new Event('change')); // â† ì˜¤ë²„ë ˆì´ ì—…ë°ì´íŠ¸
            });
        };
        document.getElementById('btn-bulk-none').onclick = () => {
            document.querySelectorAll('#img-list input.img-select').forEach(cb => {
                cb.checked = false;
                cb.dispatchEvent(new Event('change'));
            });
        };
        document.getElementById('btn-bulk-del').onclick = () => bulkDeleteSelectedPublicImages(listingId);
    }


    // ë‚ ì§œ YYYY-MM-DD í¬ë§·
    function formatYMD(dateStr){
        if (!dateStr) return '';
        const d = new Date(dateStr);
        if (isNaN(d)) return '';
        const pad = n => String(n).padStart(2, '0');
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    // ğŸ”¸ 1) ê³µí†µ í•¨ìˆ˜ë¡œ ë¶„ë¦¬: ì‹ ê·œ ë§¤ë¬¼ ìƒì„± + ìˆ˜ì •ëª¨ë“œë¡œ ìƒì„¸íŒ¨ë„ ì—´ê¸°
    async function openNewListing() {
        try {
            console.log('[openNewListing] start');
            const newId = await getNextListingId();            // Supabase ìµœëŒ€ listing_id + 1
            const center = window.map?.getCenter();

            const dummyListing = {
                listing_id: newId,
                lat: center?.getLat() || 37.5665,
                lng: center?.getLng() || 126.9780,
                building_name: '',
                unit_info: '',
                floor: '',
                total_floor: '',
                detail_address: '',
                exclusive_m2: '',
                supply_m2: '',
                monthly_rent: '',
                deposit: '',
                price: '',
                manage_cost: '',
                manage_cost_items: '',
                restroom: '',
                store_type: '',
                store_type_detail: '',
                transaction_status: 'ì§„í–‰ì¤‘',
                title: '',
                memo: '',
                images: [],
                agent_name: '',
                agent_phone: '',
                agency_name: '',
                deal_type: 'ì›”ì„¸',
                is_public: 'ê³µê°œ',
                category: 'ìƒê°€'
            };

            // ì „ì—­ ìºì‹œì— ë“±ë¡
            allListings[String(newId)] = dummyListing;

            showDetailPanel(newId); // ìƒì„¸íŒ¨ë„ ì—´ê¸°(ë‚´ë¶€ì—ì„œ panel.style.display='block')

            // ğŸ”´ showDetailPanel ì „ì— ìˆ˜ì •ëª¨ë“œ ON
            isEditMode = true;

            console.log('[openNewListing] done');
        } catch (err) {
            console.error('[openNewListing] ì‹¤íŒ¨:', err);
            alert('ë§¤ë¬¼ë“±ë¡ íŒ¨ë„ì„ ì—¬ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // listing_id ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    async function getNextListingId() {
        const { data, error } = await supabase
            .from('baikukdbtest')
            .select('listing_id')
            .order('listing_id', { ascending: false })
            .limit(1);

        if (error || !data || data.length === 0) {
            console.warn('listing_id ì¡°íšŒ ì‹¤íŒ¨:', error);
            return Date.now(); // fallback
        }

        return data[0].listing_id + 1;
    }

    // ìƒì„¸íŒ¨ë„ì—ì„œ ê¼­ í•„ìš”í•œ í•„ë“œ(ì˜ˆì‹œ) â€” ì›í•˜ë©´ ì¶”ê°€
    const REQUIRED_FIELDS_FOR_DETAIL = ['agent_name', 'deal_type', 'category', 'listing_title'];

    function isPartialListing(obj) {
        if (!obj) return true;
        return REQUIRED_FIELDS_FOR_DETAIL.some(k => obj[k] === undefined);
    }

    /**
     * ensureListingLoaded
     * @param {number|string} listingId
     * @param {{ force?: boolean, allowMissing?: boolean }} opts
     *   - force: ìºì‹œì— ìˆì–´ë„ DB ì¬ì¡°íšŒ
     *   - allowMissing: DBì— ì—†ì„ ë•Œ(ì‹ ê·œ ë”ë¯¸ ë“±) ìºì‹œê°€ ìˆìœ¼ë©´ ìºì‹œ ë°˜í™˜
     */
    async function ensureListingLoaded(listingId, opts = {}) {
        const { force = false, allowMissing = false } = opts;
        const key = String(listingId);
        const cached = allListings[key];

        // ìºì‹œê°€ ìˆê³ , ê°•ì œ ì•„ë‹˜, ê·¸ë¦¬ê³  ë¶€ë¶„ì´ ì•„ë‹ˆë©´ ìºì‹œ ë°˜í™˜
        if (!force && cached && !isPartialListing(cached)) return cached;

        // DBì—ì„œ í’€ ë ˆì½”ë“œ ì¬ì¡°íšŒ
        const { data, error } = await client
            .from('baikukdbtest')
            .select('*')
            .eq('listing_id', listingId)
            .maybeSingle();

        if (error || !data) {
            // DBì— ì—†ëŠ”ë° ìºì‹œê°€ ìˆìœ¼ë©´(ì‹ ê·œ ë”ë¯¸ ë“±) ì˜µì…˜ì— ë”°ë¼ ìºì‹œ ë°˜í™˜
            if (allowMissing && cached) return cached;
            console.error('ë‹¨ê±´ ë¡œë“œ ì‹¤íŒ¨:', error || 'not found');
            showToast('ë§¤ë¬¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            throw error || new Error('listing not found');
        }

        // í’€ ë ˆì½”ë“œë¡œ ìºì‹œ ê°±ì‹ (ë¶€ë¶„ ìºì‹œì˜€ë‹¤ë©´ ë³‘í•©)
        allListings[key] = { ...(cached || {}), ...data };
        return allListings[key];
    }

    // âœ… ë¡œê·¸ì¸ ì‚¬ìš©ì & ê´€ë¦¬ì ì—¬ë¶€
    async function getAuthContext() {
        const { data: { session } } = await client.auth.getSession();
        if (!session?.user) return { isAdmin: false, me: null };

        const uid    = session.user.id;      // Supabase auth user id (uuid)
        const uemail = session.user.email ?? '';

        // ìŠ¤í‚¤ë§ˆ: staff_profiles.user_id (uuid)
        let { data: me, error } = await client
            .from('staff_profiles')
            .select('id, name, affiliation, authority, email, user_id')
            .eq('user_id', uid)
            .maybeSingle();

        if ((!me || error) && uemail) {
            const r2 = await client
            .from('staff_profiles')
            .select('id, name, affiliation, authority, email, user_id')
            .eq('email', uemail)
            .maybeSingle();
            me = r2.data ?? null;
        }

        // ê´€ë¦¬ì íŒì •: authority ê°€ admin/ê´€ë¦¬ì
        const auth = (me?.authority || '').toString().trim().toLowerCase();
        const isAdmin = auth === 'admin' || auth === 'ê´€ë¦¬ì';

        return { isAdmin, me };
    }
    window.getAuthContext = getAuthContext;

    // âœ… ë‹´ë‹¹ì í‘œì‹œ ì´ë¦„ resolving: í‡´ì‚¬ìë©´ 'ë°±ì–µë¶€ë™ì‚°'
    const _agentDisplayCache = new Map(); // name -> 'ë°±ì–µë¶€ë™ì‚°' or ì›ë³¸ ì´ë¦„
    async function resolveAgentDisplayName(name) {
        const n = (name || '').trim();
        if (!n) return '';
        if (_agentDisplayCache.has(n)) return _agentDisplayCache.get(n);

        try {
            const { data, error } = await client
            .from('staff_profiles')
            .select('leave_date')
            .eq('name', n)
            .maybeSingle();
            if (error) throw error;

            const display = data?.leave_date ? 'ë°±ì–µë¶€ë™ì‚°' : n;
            _agentDisplayCache.set(n, display);
            return display;
        } catch (e) {
            console.warn('resolveAgentDisplayName error:', e);
            // ë¬¸ì œ ìˆìœ¼ë©´ ì›ë³¸ ê·¸ëŒ€ë¡œ í‘œì‹œ
            return n;
        }
    }
     
    // âœ… í¸ì§‘ëª¨ë“œ ë‹´ë‹¹ì ë“œë¡­ë‹¤ìš´: í‡´ì‚¬ì(leave_date ì¡´ì¬) ì œì™¸
    async function populateStaffSelect(selectElId = 'agent_name', preselectName = '') {
        const selectEl = document.getElementById(selectElId);
        if (!selectEl) return;

        // ë¡œë”© UI
        selectEl.disabled = true;
        selectEl.innerHTML = '<option value="">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>';

        try {
            const { isAdmin, me } = await getAuthContext();
            let myAuth = (me?.authority || '').toLowerCase();
            let myAff  = (me?.affiliation || '').trim();

            if ((!myAuth || !myAff) && me?.id) {
            const { data: myRow } = await client
                .from('staff_profiles')
                .select('authority, affiliation')
                .eq('id', me.id)
                .maybeSingle();
            if (myRow) {
                if (!myAuth) myAuth = (myRow.authority || '').toLowerCase();
                if (!myAff)  myAff  = (myRow.affiliation || '').trim();
            }
            }

            const isManager = ['manager', 'ì§€ì ì¥'].includes(myAuth);

            // ğŸ” ì§ì› ëª©ë¡ ì¡°íšŒ (í‡´ì‚¬ì í¬í•¨í•´ì„œ ê°€ì ¸ì˜¤ë˜, ì•„ë˜ì—ì„œ í•„í„°ë§)
            let q = client.from('staff_profiles').select('id, name, affiliation, leave_date');
            if (isAdmin) {
            q = q.order('name', { ascending: true });
            } else {
            if (myAff) q = q.eq('affiliation', myAff).order('name', { ascending: true });
            else if (me?.id) q = q.eq('id', me.id);
            }

            const { data, error } = await q;
            if (error) throw error;

            // ğŸ§¹ í‡´ì‚¬ì ì œê±°: leave_date ìˆëŠ” í–‰ì€ ì˜µì…˜ì—ì„œ ì œì™¸
            const rows = (data || [])
            .filter(r => r?.name && !r?.leave_date)
            .map(r => ({
                id: r.id,
                name: (r.name || '').trim(),
                affiliation: (r.affiliation || '').trim()
            }));

            // (ì˜ˆì™¸) ì•„ë¬´ë„ ì—†ì„ ë•Œ
            if (!rows.length) {
            selectEl.innerHTML = `<option value="">ì§ì› ì—†ìŒ</option>`;
            selectEl.disabled = true;
            return;
            }

            // ë Œë” ì‹œì‘
            selectEl.innerHTML = '';
            const ph = document.createElement('option');
            ph.value = '';
            ph.textContent = isAdmin ? 'ë‹´ë‹¹ì ì„ íƒ (ì „ì²´)' : 'ë‹´ë‹¹ì ì„ íƒ (ë‚´ ì§€ì )';
            selectEl.appendChild(ph);

            if (isAdmin) {
            // ì§€ì ë³„ ê·¸ë£¹í•‘
            const groupMap = new Map();
            for (const r of rows) {
                const key = r.affiliation || '(ì§€ì •ì—†ìŒ)';
                if (!groupMap.has(key)) groupMap.set(key, []);
                groupMap.get(key).push(r);
            }

            // ì§€ì /ì´ë¦„ ì •ë ¬
            for (const arr of groupMap.values()) {
                arr.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
            }

            const allAffs = Array.from(groupMap.keys());
            const hasUnassigned = allAffs.includes('(ì§€ì •ì—†ìŒ)');
            const affsSansUnassigned = allAffs.filter(a => a !== '(ì§€ì •ì—†ìŒ)');

            const primaryAff = myAff || null;
            const sortedAffs = [];
            if (primaryAff && groupMap.has(primaryAff)) sortedAffs.push(primaryAff);
            affsSansUnassigned
                .filter(a => a !== primaryAff)
                .sort((a, b) => a.localeCompare(b, 'ko'))
                .forEach(a => sortedAffs.push(a));
            if (hasUnassigned) sortedAffs.push('(ì§€ì •ì—†ìŒ)');

            for (const aff of sortedAffs) {
                const og = document.createElement('optgroup');
                og.label = aff;
                for (const s of groupMap.get(aff)) {
                const opt = document.createElement('option');
                opt.value = s.name;      // ì €ì¥ê°’ = ì‹¤ì œ ì´ë¦„
                opt.textContent = s.name; // í‘œì‹œê°’ = ì‹¤ì œ ì´ë¦„
                og.appendChild(opt);
                }
                selectEl.appendChild(og);
            }
            } else {
            // ë‹¨ìˆœ ë¦¬ìŠ¤íŠ¸
            rows
                .sort((a, b) => a.name.localeCompare(b.name, 'ko'))
                .forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.name;
                opt.textContent = s.name;
                selectEl.appendChild(opt);
                });
            }

            // âœ… ê¸°ë³¸ ì„ íƒ
            const want = (preselectName || '').trim();
            if (want) {
            // í‡´ì‚¬ìë©´ rowsì— ì—†ìœ¼ë¯€ë¡œ ì„ íƒë˜ì§€ ì•ŠìŒ (í‘œì‹œí•˜ì§€ ì•ŠìŒ)
            selectEl.value = want;
            if (selectEl.value !== want) {
                // ì„ íƒ ë¶ˆê°€ â†’ ë¯¸ì§€ì • ìƒíƒœ ìœ ì§€
                selectEl.value = '';
            }
            } else if (!isAdmin && me?.name && rows.some(r => r.name === me.name)) {
            selectEl.value = (me.name || '').trim();
            }

            // ê¶Œí•œë³„ í™œì„±í™”
            const canChange = isAdmin || isManager;
            selectEl.disabled = !canChange;
            selectEl.title = !canChange
            ? 'ë‹´ë‹¹ì ë³€ê²½ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'
            : (isAdmin
                ? (myAff ? `ê´€ë¦¬ì: ëª¨ë“  ì§ì› ì§€ì • ê°€ëŠ¥ (ë‚´ ì§€ì  ìš°ì„  í‘œì‹œ: ${myAff})` : 'ê´€ë¦¬ì: ëª¨ë“  ì§ì› ì§€ì • ê°€ëŠ¥')
                : `ì§€ì ì¥: ë‚´ ì§€ì  ì§ì›ë§Œ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì§€ì : ${myAff || '-'})`);
        } catch (e) {
            console.error('staff_profiles ë¡œë“œ ì‹¤íŒ¨:', e);
            selectEl.innerHTML = `<option value="">ì§ì› ì—†ìŒ</option>`;
        }
    }


    // ë§¤ë¬¼ ë‹´ë‹¹ì ë³€ê²½ ê´€ë ¨ í•¨ìˆ˜
    // RLS/ê¶Œí•œ ë©”ì‹œì§€ ë³€í™˜
    function agentUpdateErrorToHuman(err) {
        const msg = (err?.message || '').toLowerCase();

        if (msg.includes('violates row-level security') || msg.includes('rls')) {
            return 'ì„œë²„ ì •ì±…(RLS)ìœ¼ë¡œ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.';
        }
        if (msg.includes('permission denied')) {
            return 'ê¶Œí•œì´ ì—†ì–´ ë‹´ë‹¹ìë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        }
        if (msg.includes('missing required permission')) {
            return 'ë‹´ë‹¹ì ë³€ê²½ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
        }
        return 'ë‹´ë‹¹ì ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
    }

    /**
     * í”„ëŸ°íŠ¸ì—ì„œ ê°€ëŠ¥í•œ ì„ ê²€ì¦ í›„ Supabase ì—…ë°ì´íŠ¸ ì‹œë„
     * - admin: ë¬´ì¡°ê±´ í—ˆìš©
     * - manager(ì§€ì ì¥): ì„ íƒëœ ì´ë¦„ì´ ê°™ì€ affiliation ì§ì›ì¼ ë•Œë§Œ í—ˆìš©
     * - ê·¸ ì™¸: ê¸ˆì§€
     */
    // âœ… ë‹´ë‹¹ì ë³€ê²½ ì‹œì—ë§Œ ì €ì¥ + RLS ì—ëŸ¬ ë©”ì‹œì§€ ì•ˆë‚´
    async function saveAgentNameIfChanged(listingId) {
        const selectEl = document.getElementById('agent_name');
        if (!selectEl) return true; // ì €ì¥í•  ê²Œ ì—†ìŒ

        const newName = (selectEl.value || '').trim();
        const listing = allListings?.[String(listingId)];
        if (!listing) return true;

        // ë³€ê²½ ì—†ìœ¼ë©´ íŒ¨ìŠ¤
        if ((listing.agent_name || '') === newName) return true;

        const { error } = await client
            .from('baikukdbtest')
            .update({ agent_name: newName })
            .eq('listing_id', listingId);

        if (error) {
            // ê¶Œí•œ/RLS/GRANT ì‹¤íŒ¨ ë©”ì‹œì§€ ë§µí•‘
            const msg = (error.message || '').toLowerCase();

            if (msg.includes('permission denied')) {
            showToast('ë‹´ë‹¹ì ì €ì¥ ì‹¤íŒ¨: ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (GRANT/RLS)', { type: 'error' });
            } else if (msg.includes('violates row-level security policy') || msg.includes('new row violates')) {
            showToast('ë‹´ë‹¹ì ì €ì¥ ì‹¤íŒ¨: RLS ì •ì±…ì— ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.\nê´€ë¦¬ìë‚˜ ì§€ì ì¥ë§Œ ë³€ê²½ ê°€ëŠ¥í•˜ë©°, ì§€ì ì¥ì€ ë³¸ì¸ ì§€ì ì˜ ì§ì›ë§Œ ì§€ì •í•  ìˆ˜ ìˆì–´ìš”.', { type: 'error' });
            } else if (msg.includes('update')) {
            showToast('ë‹´ë‹¹ì ì €ì¥ ì‹¤íŒ¨: ì—…ë°ì´íŠ¸ ê¶Œí•œì´ ì—†ê±°ë‚˜ ì •ì±… ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', { type: 'error' });
            } else {
            showToast(`ë‹´ë‹¹ì ì €ì¥ ì‹¤íŒ¨: ${error.message}`, { type: 'error' });
            }
            console.error('saveAgentName error', error);
            return false;
        }

        // ë¡œì»¬ ìƒíƒœ ë™ê¸°í™”
        listing.agent_name = newName;
        showToast('ë‹´ë‹¹ìë¥¼ ì €ì¥í–ˆì–´ìš”.', { type: 'success' });
        return true;
    }



    // ì˜ˆì—´í•œ í•´ì‹œ ì €ì¥ ê´€ë ¨ í•¨ìˆ˜
    function tryPrewarmVisibleThumbs() {
        const filtered = filterListings(Object.values(allListings));
        const idsInView = filtered.map(l => l.listing_id).sort();
        const hash = idsInView.join(',');

        if (hash === lastPrewarmHash) return; // ê°™ì€ ì˜ì—­ì´ë©´ ìƒëµ
        lastPrewarmHash = hash;

        console.log(`ğŸ“¸ ì˜ˆì—´ ëŒ€ìƒ ${idsInView.length}ê±´`);
        ensureThumbsReady(idsInView, { timeout: 1000 }).catch(console.warn);
    }

    async function ensureThumbsReady(ids, { timeout = 350 } = {}) {
        const strIds = ids.map(String);

        // 1) URL ìºì‹œ ì±„ìš°ê¸°
        await loadPrimaryThumbsBatch(strIds, { applyToDom: false });

        // 2) ìºì‹œì—ì„œ URL ê°€ì ¸ì˜¤ê¸°
        const urls = strIds
            .map(id => primaryThumbCache.get(id))
            .filter(Boolean);

        if (urls.length === 0) return;

        console.log(`ğŸ”„ ì¸ë„¤ì¼ ë””ì½”ë“œ ì‹œì‘ (${urls.length}ì¥), íƒ€ì„ì•„ì›ƒ ${timeout}ms`);

        let decodedCount = 0;
        const loaders = urls.map(u => {
            const img = new Image();
            img.decoding = 'async';
            img.loading  = 'eager';
            img.src = u;
            const p = img.decode ? img.decode() : new Promise(res => { img.onload = res; img.onerror = res; });
            p.then(() => {
            decodedCount++;
            });
            return p;
        });

        const decodePromise = Promise.allSettled(loaders).then(() => true);
        const timeoutPromise = new Promise(res => setTimeout(() => {
            res(false);
        }, timeout));

        const decodedInTime = await Promise.race([decodePromise, timeoutPromise]);
        
        console.log(`âœ… ì˜ˆì—´ ì™„ë£Œ: ${decodedCount} / ${urls.length} ì¥ ì„±ê³µ`);
        return decodedInTime;
    }

    // ê±´ë¬¼ì •ë³´(ì£¼ì†Œê³µìš©) ëŒ€í‘œ ì¸ë„¤ì¼ì„ ìƒì„¸ íŒ¨ë„ì˜ thumbì— ì£¼ì…
    async function setBuildingThumbForDetail(listing) {
        try {
            if (!listing) return;
            const imgEl = document.getElementById(`thumb-edit-${listing.listing_id}`);
            if (!imgEl) return;

            const addrKey = getAddrKey(listing); // ì´ë¯¸ ìˆëŠ” í•¨ìˆ˜(ê³µë°±ì œê±°í•œ compare key)
            if (!addrKey) return;

            // ëŒ€í‘œì»·: is_primary ìš°ì„ , ì—†ìœ¼ë©´ order_index ê°€ì¥ ì‘ì€ ê²ƒ
            const { data: rows, error } = await client
            .from('address_images')
            .select('path, is_primary, order_index')
            .eq('addr_compare', addrKey)
            .order('is_primary', { ascending: false })
            .order('order_index', { ascending: true })
            .limit(1);

            if (error || !rows?.length) return; // ì´ë¯¸ì§€ ì—†ìœ¼ë©´ ê¸°ì¡´ ë¡œê³  ìœ ì§€

            // 140x100 ë°•ìŠ¤ â†’ ë ˆí‹°ë‚˜ 2x í’ˆì§ˆë¡œ 280x200, cover í¬ë¡­
            const signed = await signDisplayCover(rows[0].path, 280, 200, 70);
            if (signed) {
            imgEl.src = signed;
            imgEl.style.cursor = 'zoom-in';
            imgEl.title = 'í´ë¦­í•´ì„œ í¬ê²Œ ë³´ê¸°';
            imgEl.onclick = () => openViewerForAddress(addrKey, 0);
            }
        } catch (e) {
            console.warn('setBuildingThumbForDetail failed:', e);
        }
    }


    // ì£¼ì†Œí‚¤ â†’ ì•ˆì „í•œ ASCII í´ë”ëª… (SHA-1 40ìë¦¬)
    async function addrFolderFromKey(addrKey) {
        const buf  = new TextEncoder().encode(String(addrKey));
        const hash = await crypto.subtle.digest('SHA-1', buf);
        return [...new Uint8Array(hash)].map(b => b.toString(16).padStart(2,'0')).join('');
    }

    // ì£¼ì†Œ ë¹„êµí‚¤: ê³µë°± ì œê±°í•œ í…ìŠ¤íŠ¸
    function getAddrKey(listing) {
        const parts = [
            listing?.province || '',
            listing?.city || '',
            listing?.district || '',
            listing?.detail_address || '',
        ].map(s => s.trim()).join(' ');
        return normalizeAddr(parts); // ê³µë°±ì œê±°+trim
    }


    // ì‚¬ì¸ URL ìºì‹œ ì¬ì‚¬ìš© (_signedUrlCache ìœ ì§€)
    async function signDisplayCover(path, w, h, quality = 72) {
        const key = `dispCover:${path}|${w}x${h}|q${quality}`;
        return _memo(key, async () => {
            const { data, error } = await client.storage
            .from(BUCKET)
            .createSignedUrl(path, 600, { transform: { width: w, height: h, resize: 'contain', quality }});
            if (error) throw error;
            return data?.signedUrl || '';
        });
    }


    // === ì¸í¬íŒ¨ë„ ëŒ€í‘œ ì¸ë„¤ì¼ ìºì‹œ ===
    const primaryThumbCache = new Map();

    // ì¸ë„¤ì¼(ê°€ë³ê²Œ) ì„œëª… URL
    async function signedThumbUrl(path, width = 240) {
        const { data, error } = await client
            .storage.from(BUCKET)
            .createSignedUrl(path, 600, { transform: { width, resize: 'contain', quality: 48 }});
        if (error) { console.warn('signedThumbUrl ì‹¤íŒ¨:', error); return ''; }
        return data?.signedUrl || '';
    }

    // ìºì‹œê°’ì„ ì¦‰ì‹œ DOM ë°˜ì˜
    function applyPrimaryThumbsFromCache(listingIds) {
        for (const id of listingIds) {
            const el = document.getElementById(`thumb-${id}`);
            if (!el) continue;
            const cached = primaryThumbCache.get(String(id));
            if (cached) el.src = cached;
        }
    }

    // âœ… ì˜µì…˜ ì¶”ê°€: { applyToDom = true }
    async function loadPrimaryThumbsBatch(listingIds, { applyToDom = true } = {}) {
        const ids = listingIds.map(String);

        if (applyToDom) applyPrimaryThumbsFromCache(ids);

        // 1) ë·°ì—ì„œ ë°›ì€ pathë¡œ ë¨¼ì € ì±„ìš°ê¸°
        const toSignNow = [];
        for (const id of ids) {
            if (!primaryThumbCache.has(id)) {
                const p = allListings?.[id]?.primary_image_path;
                if (p) toSignNow.push([id, p]);
            }
        }
        if (toSignNow.length) {
            // ë³‘ë ¬ ì„œëª…
            const signed = await Promise.all(toSignNow.map(([id, p]) => signedThumbUrl(p, 240).then(u => [id, u || ''])));
            for (const [id, url] of signed) primaryThumbCache.set(id, url);
        }

         // 2) ì—¬ì „íˆ ë¹„ì–´ìˆëŠ” ê²ƒë§Œ í…Œì´ë¸”ì—ì„œ ë³´ì¶©
        const need = ids.filter(id => !primaryThumbCache.has(id));
        if (need.length === 0) return;

        const { data, error } = await client
            .from('listing_images')
            .select('listing_id, path, is_primary, order_index')
            .in('listing_id', need)
            .eq('is_private', false)
            .order('is_primary', { ascending: false })
            .order('order_index', { ascending: true });

        if (error) { console.warn('ëŒ€í‘œì‚¬ì§„ ì¡°íšŒ ì‹¤íŒ¨:', error); return; }

        const firstByListing = new Map();
        for (const row of data || []) {
            const id = String(row.listing_id);
            if (!firstByListing.has(id)) firstByListing.set(id, row);
        }

        for (const id of need) {
            const row = firstByListing.get(id);
            if (!row) { primaryThumbCache.set(id, ''); continue; }
            const url = await signedThumbUrl(row.path, 240);
            primaryThumbCache.set(id, url || '');
        }

        if (applyToDom) applyPrimaryThumbsFromCache(ids);
    }

    
    // --- ê±´ë¬¼(ì£¼ì†Œê³µìš©): ë¯¸ë¦¬ë³´ê¸° ---
    function previewSelectedFilesAddr(){
        const input = document.getElementById('img-upload-input-addr');
        const box   = document.getElementById('img-preview-list-addr');
        if (!input || !box) return;
        box.innerHTML = '';
        for (const f of input.files || []) {
            const url = URL.createObjectURL(f);
            const el = document.createElement('img');
            el.src = url;
            el.className = 'w-full h-24 object-cover rounded border';
            box.appendChild(el);
        }
    }

    // --- ê±´ë¬¼(ì£¼ì†Œê³µìš©): ëª©ë¡ ë¡œë“œ ---
    async function loadAddressImages(addrKey){
        const box = document.getElementById('img-list-addr');
        if (!box || !addrKey) return;

        const { data: rows, error } = await client
            .from('address_images')
            .select('id, path')
            .eq('addr_compare', addrKey)
            .order('order_index', { ascending: true });

        if (error) { console.error('addr imgs load fail', error); return; }

        box.innerHTML = '';
        for (const r of rows || []) {
            const thumbUrl = await getTransformedUrl(r.path, 360, 3600, 60, 96, 'contain');
            const wrap = document.createElement('div'); 
            wrap.className = 'relative group rounded overflow-hidden';

            const img = document.createElement('img');
            img.src = thumbUrl;
            img.className = 'w-full h-24 object-contain bg-white rounded border';

            // ì„ íƒ ì‹œ ë³´ì—¬ì¤„ ì˜¤ë²„ë ˆì´(ë‘êº¼ìš´ íŒŒë€ í…Œë‘ë¦¬)
            const outline = document.createElement('div');
            outline.className = 'pointer-events-none absolute inset-0 hidden ring-2 ring-blue-500 rounded';
            wrap.appendChild(outline);

            img.onclick = () => openViewerForAddress(addrKey);

            const del = document.createElement('button');
            del.textContent = 'ì‚­ì œ';
            del.className = 'absolute top-1 right-1 bg-white/90 text-xs px-2 py-[2px] rounded border';
            del.onclick = () => deleteAddressImage(r.id, r.path, addrKey);

            wrap.appendChild(img); wrap.appendChild(del); box.appendChild(wrap);
        }
    }

    // --- ê±´ë¬¼(ì£¼ì†Œê³µìš©): ì—…ë¡œë“œ ---(addrKeyëŠ” í…ìŠ¤íŠ¸, folderëŠ” í•´ì‹œ)
    async function uploadSelectedImagesAddr(listing){
        const input = document.getElementById('img-upload-input-addr');
        const btn   = document.getElementById('img-upload-btn-addr');
        if (!input || !input.files?.length) { showToast('ë¨¼ì € íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }

        const addrKey = getAddrKey(listing);           // â† í…ìŠ¤íŠ¸ í‚¤
        if (!addrKey) { showToast('ì£¼ì†Œí‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
        const folder  = await addrFolderFromKey(addrKey); // â† í•´ì‹œ í´ë”

        const prev = btn?.textContent;
        if (btn){ btn.disabled = true; btn.textContent = 'ì—…ë¡œë“œ ì¤‘...'; }

        try {
            let nextIndex = 0;
            try {
            const { data: last } = await client
                .from('address_images')
                .select('order_index')
                .eq('addr_compare', addrKey)
                .order('order_index', { ascending:false })
                .limit(1)
                .maybeSingle();
            nextIndex = (last?.order_index ?? -1) + 1;
            } catch {}

            let success = 0;
            for (const f of input.files){
            if (!f.type?.startsWith('image/')) { showToast('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì˜¬ë¦´ ìˆ˜ ìˆì–´ìš”.'); continue; }
            if (f.size > 10*1024*1024) { showToast('10MB ì´í•˜ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); continue; }

            const id  = (crypto?.randomUUID && crypto.randomUUID()) || (Date.now()+'-'+Math.random().toString(16).slice(2));
            const ext = (f.type?.split('/')[1] || 'jpg').toLowerCase();
            const key = `addresses/${folder}/orig/${id}.${ext}`;

            const { error: upErr } = await client.storage.from(BUCKET).upload(key, f, { upsert:false, contentType: f.type });
            if (upErr){ console.error(upErr); showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: '+upErr.message); continue; }

            const row = {
                addr_compare: addrKey, bucket: BUCKET, path: key, mime_type: f.type,
                order_index: nextIndex++, caption: null, is_primary: false
            };
            const { error: dbErr } = await client.from('address_images').insert(row);
            if (dbErr){ console.error(dbErr); await client.storage.from(BUCKET).remove([key]); showToast('DB ê¸°ë¡ ì‹¤íŒ¨: '+dbErr.message); continue; }

            success++;
            }

            input.value = '';
            previewSelectedFilesAddr();
            await loadAddressImages(addrKey);
            await setBuildingThumbForDetail(listing); // â† ì—…ë¡œë“œ ì§í›„ ì¸ë„¤ì¼ ê°±ì‹ 
            showToast(success>0 ? `ì—…ë¡œë“œ ì™„ë£Œ (${success}ì¥)` : 'ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
        } finally {
            if (btn){ btn.disabled = false; btn.textContent = prev || 'ì—…ë¡œë“œ'; }
        }
    }

    // --- ê±´ë¬¼(ì£¼ì†Œê³µìš©): ì‚­ì œ ---
    async function deleteAddressImage(rowId, path, addrKey){
        if (!confirm('ì´ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
        const { error: dbErr } = await client.from('address_images').delete().eq('id', rowId);
        if (dbErr){ showToast('DB ì‚­ì œ ì‹¤íŒ¨'); return; }
        const { error: stErr } = await client.storage.from(BUCKET).remove([path]);
        if (stErr){ showToast('ìŠ¤í† ë¦¬ì§€ ì‚­ì œ ì‹¤íŒ¨'); return; }
        await loadAddressImages(addrKey);
        showToast('ì‚­ì œ ì™„ë£Œ');
    }

    // --- ê±´ë¬¼(ì£¼ì†Œê³µìš©): ë“œë˜ê·¸&ë“œë¡­ ---
    function setupDragAndDropUploadAddr(listing){
        const dropzone = document.getElementById('img-dropzone-addr');
        const input    = document.getElementById('img-upload-input-addr');
        if (!dropzone || !input) return;

        const highlight = () => dropzone.style.borderColor = '#F2C130';
        const unlight   = () => dropzone.style.borderColor = '#d1d5db';

        ['dragenter','dragover'].forEach(evt => dropzone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); highlight(); }));
        ['dragleave','dragend'].forEach(evt => dropzone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); unlight(); }));

        dropzone.addEventListener('drop', async (e) => {
            e.preventDefault(); e.stopPropagation(); unlight();
            if (!e.dataTransfer) return;
            const files = await collectFilesFromDataTransfer(e.dataTransfer);
            if (!files.length) { showToast('ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
            const dt = new DataTransfer(); for (const f of files) dt.items.add(f);
            input.files = dt.files;
            previewSelectedFilesAddr();
            // ìë™ ì—…ë¡œë“œí•˜ë ¤ë©´ â†“ ì£¼ì„ í•´ì œ
            // await uploadSelectedImagesAddr(listing);
        });
    }

    // --- ê±´ë¬¼(ì£¼ì†Œê³µìš©): ë·°ì–´ ì—´ê¸°(ì„ íƒ) ---
    // --- ê±´ë¬¼(ì£¼ì†Œê³µìš©): ë·°ì–´ ì—´ê¸° ---
    // addrKey = ê³µë°± ì œê±°ëœ ì£¼ì†Œ ë¹„êµí‚¤
    async function openViewerForAddress(addrKey, startIndex = 0) {
        // 1) ì´ë¯¸ì§€ ëª©ë¡
        const { data: rows } = await client
            .from('address_images')
            .select('path, caption, order_index, created_at')
            .eq('addr_compare', addrKey)
            .order('order_index', { ascending: true });

        const items = await Promise.all((rows || []).map(async r => {
            const [display, thumb, full] = await Promise.all([
                getTransformedUrl(r.path, 960, 3600, 72, null, 'contain'),
                getTransformedUrl(r.path, 220),
                getOriginalUrl(r.path)
            ]);
            return { display, thumb, full, caption: r.caption || 'ê±´ë¬¼ì •ë³´', createdAt: formatYMD(r.created_at)};
        }));
        if (!items.length) { showToast('ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

        // 2) ì œëª©ìš© ë©”íƒ€: province city district detail_address + building_name
        const key = (addrKey || '').replace(/\s+/g, '').trim();

        const [biRes, oneListingRes] = await Promise.all([
            client.from('building_info')
            .select('building_name, full_address, addr_compare')
            .eq('addr_compare', key)
            .maybeSingle(),
            client.from('baikukdbtest')
            .select('province, city, district, detail_address')
            .eq('addr_compare', key)
            .limit(1)
            .maybeSingle()
        ]);

        const buildingName =
            (biRes?.data?.building_name && biRes.data.building_name !== '.') ? biRes.data.building_name : '';

        const p = oneListingRes?.data?.province ?? '';
        const c = oneListingRes?.data?.city ?? '';
        const d = oneListingRes?.data?.district ?? '';
        const da = oneListingRes?.data?.detail_address ?? '';

        const addressLine = [p, c, d, da].filter(Boolean).join(' ').trim();
        const pageTitle = [addressLine, buildingName].filter(Boolean).join(' Â· ') || 'ì£¼ì†Œê³µìš© ì´ë¯¸ì§€';

        // 3) ë·°ì–´ ì—´ê¸°
        openExternalViewerAdmin(items, startIndex, pageTitle);
    }


    // === ë“œë˜ê·¸&ë“œë¡­ ì—…ë¡œë“œ ===
    function setupDragAndDropUpload(listingId) {
        const dropzone = document.getElementById('img-dropzone');
        const input    = document.getElementById('img-upload-input');
        if (!dropzone || !input) return;

        const highlight = () => dropzone.style.borderColor = '#F2C130';
        const unlight   = () => dropzone.style.borderColor = '#d1d5db';

        ['dragenter','dragover'].forEach(evt =>
                dropzone.addEventListener(evt, e => {
                e.preventDefault(); e.stopPropagation(); highlight();
                })
            );
        ;['dragleave','dragend'].forEach(evt =>
                dropzone.addEventListener(evt, e => {
                e.preventDefault(); e.stopPropagation(); unlight();
                })
            );

        dropzone.addEventListener('drop', async (e) => {
            e.preventDefault(); e.stopPropagation(); unlight();
            if (!e.dataTransfer) return;

            // 1) ë“œë˜ê·¸ëœ í•­ëª©ì—ì„œ íŒŒì¼ ìˆ˜ì§‘ (í´ë” ì§€ì›)
            const files = await collectFilesFromDataTransfer(e.dataTransfer);

            if (!files.length) {
            showToast('ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
            }

            // 2) input.files êµì²´ (DataTransfer ì´ìš©)
            const dt = new DataTransfer();
            for (const f of files) dt.items.add(f);
            input.files = dt.files;

            // 3) ë¯¸ë¦¬ë³´ê¸° ê°±ì‹  (ê¸°ì¡´ í•¨ìˆ˜ ì¬í™œìš©)
            previewSelectedFiles();

            // (ì„ íƒ) ìë™ ì—…ë¡œë“œí•˜ê³  ì‹¶ìœ¼ë©´ ì£¼ì„ í•´ì œ:
            // await uploadSelectedImages(listingId);
        });
    }

    // DataTransferì—ì„œ ì´ë¯¸ì§€ íŒŒì¼ ìˆ˜ì§‘ (í´ë” ì¬ê·€ íƒìƒ‰ í¬í•¨)
    async function collectFilesFromDataTransfer(dt) {
        const out = [];

        // í¬ë¡¬/ì—£ì§€: webkitGetAsEntryë¡œ í´ë” íƒìƒ‰ ê°€ëŠ¥
        if (dt.items && dt.items.length && dt.items[0].webkitGetAsEntry) {
            const entries = [];
            for (const item of dt.items) {
                const entry = item.webkitGetAsEntry?.();
                if (entry) entries.push(entry);
            }
            for (const entry of entries) {
                const files = await readEntryRecursive(entry);
                out.push(...files);
            }
        } else {
            // íŒŒì´ì–´í­ìŠ¤ ë“±: íŒŒì¼ë§Œ
            for (const f of dt.files || []) out.push(f);
        }

        // ì´ë¯¸ì§€ë§Œ ë‚¨ê¸°ê¸°
        return out.filter(f => (f.type || '').startsWith('image/'));
    }

    // íŒŒì¼/í´ë” ì—”íŠ¸ë¦¬ ì¬ê·€ íƒìƒ‰
    function readEntryRecursive(entry) {
        return new Promise((resolve) => {
            if (entry.isFile) {
                entry.file(file => resolve([file]), () => resolve([]));
            } else if (entry.isDirectory) {
                const dirReader = entry.createReader();
                const all = [];
                const readBatch = () => {
                    dirReader.readEntries(async (entries) => {
                    if (!entries.length) return resolve(all);
                    for (const ent of entries) {
                        const files = await readEntryRecursive(ent);
                        all.push(...files);
                    }
                    readBatch();
                    }, () => resolve(all));
                };
                readBatch();
            } else {
                resolve([]);
            }
        });
    }

    // ì‚¬ì§„ìˆ˜ì •ì°½ ë‹«ëŠ”ë¶€ë¶„ í—¬í¼
    function closeSidePanel() {
        const sp = document.getElementById('side-panel');
        if (!sp) return;
        sp.classList.add('hidden');
        sp.innerHTML = '';
    }

    // ì´ë¯¸ì§€ ë·°ì–´ ê´€ë ¨ í•¨ìˆ˜ ê°€ë²¼ìš´ ê¸°ë³¸ê°’ìœ¼ë¡œ(ìºì‹œëŠ” 3ë²ˆ ì°¸ê³ )
    async function getTransformedUrl(path, width = 480, expiresIn = 3600, quality = 48, height = null, resize = 'contain') {
        const hPart = height ? `|h${height}` : '';
        const rPart = resize ? `|r${resize}` : '';
        const key = `t:${path}|w${width}${hPart}|q${quality}|e${expiresIn}${rPart}`;
        return _memo(key, async () => {
            const transform = height ? { width, height, quality, resize } : { width, quality, resize };
            if (window.BUCKET_IS_PUBLIC !== false) {
            const { data } = client.storage.from(BUCKET).getPublicUrl(path, { transform });
            return data?.publicUrl || '';
            } else {
            const { data, error } = await client.storage.from(BUCKET)
                .createSignedUrl(path, expiresIn, { transform });
            if (error) { console.warn('signed url (transform) error:', error); }
            return data?.signedUrl || '';
            }
        });
    }

    async function getOriginalUrl(path, expiresIn = 3600) {
        const key = `o:${path}|e${expiresIn}`;
        return _memo(key, async () => {
            if (window.BUCKET_IS_PUBLIC !== false) {
            const { data } = client.storage.from(BUCKET).getPublicUrl(path);
            return data?.publicUrl || '';
            } else {
            const { data, error } = await client.storage.from(BUCKET)
                .createSignedUrl(path, expiresIn);
            if (error) { console.warn('signed url error:', error); }
            return data?.signedUrl || '';
            }
        });
    }

    // ================== ğŸ§Š ìƒì„¸ ì¸ë„¤ì¼ ì˜ˆì—´(ë””ì½”ë“œ) ==================
    async function prewarmDetailThumbs(listingIds, {
        perListing = 2,         // ë§¤ë¬¼ë‹¹ ëª‡ ì¥ ë¯¸ë¦¬?
        displayWidth = 900,     // ìƒì„¸íŒ¨ë„ í‘œì‹œìš© ë³€í™˜í­
        timeout = 800,          // ë””ì½”ë”© íƒ€ì„ì•„ì›ƒ(ms)
        maxListings = 60        // í•œ ë²ˆì— ì˜ˆì—´í•  ë§¤ë¬¼ ìˆ˜ ìƒí•œ
    } = {}) {
        const ids = [...new Set((listingIds||[]).map(String))].slice(0, maxListings);
        if (!ids.length) return;

        // 1) í•´ë‹¹ ë§¤ë¬¼ë“¤ì˜ (ê³µê°œ) ì´ë¯¸ì§€ ëª©ë¡(ëŒ€í‘œ ìš°ì„  â†’ ìˆœì„œ) ê°€ì ¸ì˜¤ê¸°
        const { data: rows, error } = await client
            .from('listing_images')
            .select('listing_id, path, is_primary, order_index')
            .in('listing_id', ids)
            .eq('is_private', false)
            .order('is_primary', { ascending: false })
            .order('order_index', { ascending: true });

        if (error || !rows?.length) return;

        // 2) ë§¤ë¬¼ë³„ ìƒìœ„ Nì¥ë§Œ ì¶”ë¦¼
        const pickPaths = [];
        const pickedCount = new Map(); // listing_id -> count
        for (const r of rows) {
            const id = String(r.listing_id);
            const n = pickedCount.get(id) || 0;
            if (n < perListing) {
            pickPaths.push(r.path);
            pickedCount.set(id, n + 1);
            }
        }
        if (!pickPaths.length) return;

        // 3) í‘œì‹œìš© URL ë°œê¸‰(ê¸°ì¡´ ìºì‹œ ìœ í‹¸ ì¬ì‚¬ìš©) â†’ ë””ì½”ë”©
        const urls = await Promise.all(
            pickPaths.map(p => getTransformedUrl(p, displayWidth, 3600, 72).catch(()=>'')) // í’ˆì§ˆÂ·í­ì€ ìƒí™©ì— ë§ê²Œ ì¡°ì •
        );
        const finalUrls = urls.filter(Boolean);
        if (!finalUrls.length) return;

        const loaders = finalUrls.map(u => {
            const img = new Image();
            img.decoding = 'async';
            img.loading  = 'eager';
            img.src = u;
            return img.decode ? img.decode().catch(()=>{}) : new Promise(res => {
            img.onload = img.onerror = () => res();
            });
        });

        await Promise.race([
            Promise.allSettled(loaders),
            new Promise(res => setTimeout(res, timeout))
        ]);
    }

    // âœ… ë·°ì–´ ì—´ê¸° ì§ì „ì— ì „ì²´ ì•„ì´í…œì„ ì¤€ë¹„
    async function openViewerForListing(listingId, startIndex = 0, pageTitle = 'ì´ë¯¸ì§€ ë³´ê¸°', includePrivate = true) {
        // ê³µê°œ ì „ë¶€
        const { data: rowsPub } = await client
            .from('listing_images')
            .select('path, caption, order_index, is_primary, created_at')
            .eq('listing_id', String(listingId))
            .eq('is_private', false)
            .order('is_primary', { ascending: false })
            .order('order_index', { ascending: true });

        const itemsPublic = await Promise.all((rowsPub || []).map(async r => {
            const [display, thumb, full] = await Promise.all([
            getTransformedUrl(r.path, 640),  // â†“ ê°€ë³ê²Œ(ì•„ë˜ 2ë²ˆ ì°¸ê³ )
            getTransformedUrl(r.path, 220),
            getOriginalUrl(r.path),
            ]);
            return { display, thumb, full, caption: r.caption || '', createdAt: formatYMD(r.created_at) };
        }));

        // ë¹„ê³µê°œëŠ” ì§„ì§œ ë³¼ ë•Œë§Œ
        let itemsPrivate = [];
        if (includePrivate) {
            const { data: rowsPri } = await client
            .from('listing_images')
            .select('path, caption, order_index, created_at')
            .eq('listing_id', String(listingId))
            .eq('is_private', true)
            .order('order_index', { ascending: true });

            itemsPrivate = await Promise.all((rowsPri || []).map(async r => {
            const [display, thumb, full] = await Promise.all([
                getTransformedUrl(r.path, 640),
                getTransformedUrl(r.path, 220),
                getOriginalUrl(r.path),
            ]);
            return { display, thumb, full, caption: r.caption ? `ğŸ”’ ${r.caption}` : 'ğŸ”’ ë¹„ê³µê°œ', createdAt: formatYMD(r.created_at) };
            }));
        }

        openExternalViewerAdmin([...itemsPublic, ...itemsPrivate], startIndex, pageTitle);
    }

    // âœ… ìˆ˜ì •: ìƒì„¸íŒ¨ë„ 2ì¥ë§Œ ë¨¼ì € (limit 2), í´ë¦­ì‹œ ì „ì²´ êµ¬ì„±
    async function initImageViewer(listingId, opts = {}) {
        const wrap = document.getElementById('image-viewer');
        if (!wrap || !listingId) return;

        // ëŒ€í‘œ 2ì¥ë§Œ!
        const { data: rowsPub, error } = await client
            .from('listing_images')
            .select('path, caption, order_index, is_primary')
            .eq('listing_id', String(listingId))
            .eq('is_private', false)
            .order('is_primary', { ascending: false })
            .order('order_index', { ascending: true })
            .limit(2);

        if (error || !rowsPub?.length) { wrap.classList.add('hidden'); return; }

        // ê°€ë²¼ìš´ ë³€í™˜ë§Œ ë¯¸ë¦¬
        const items2 = await Promise.all(rowsPub.map(async r => ({
            display: await getTransformedUrl(r.path, 480, 3600, 60, 270, 'contain'),
            caption: r.caption || '',
            path: r.path,
        })));

        const img0 = document.getElementById('image-viewer-main-0');
        const img1 = document.getElementById('image-viewer-main-1');
        const listing = allListings?.[String(listingId)];
        const pageTitle = (listing?.listing_title || listing?.title || `ë§¤ë¬¼ ${listingId} ì´ë¯¸ì§€`).trim();

        if (img0 && items2[0]) {
            img0.loading = 'eager';
            img0.decoding = 'async';
            img0.setAttribute('fetchpriority', 'high');
            img0.src = items2[0].display;
            img0.onclick = () => openViewerForListing(listingId, 0, pageTitle, /*includePrivate*/ true);
        }
        if (img1 && items2[1]) {
            img1.classList.remove('hidden');
            img1.loading = 'lazy';
            img1.decoding = 'async';
            img1.setAttribute('fetchpriority', 'low');
            img1.src = items2[1].display;
            img1.onclick = () => openViewerForListing(listingId, 1, pageTitle, /*includePrivate*/ true);
        } else if (img1) {
            img1.classList.add('hidden');
        }

        wrap.classList.remove('hidden');
    }


    function openExternalViewerAdmin(items, startIndex = 0, pageTitle = 'ì´ë¯¸ì§€ ë³´ê¸°') {
        const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
        const html = `<!doctype html>
        <html lang="ko"><head>
            <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
            <title>${esc(pageTitle)}</title>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lightgallery.css">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lg-zoom.css">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lg-thumbnail.css">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lg-fullscreen.css">
            <style>
            body{margin:0;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;}
            #gallery{padding:8px;}
            html, body { -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; }
            .lg-outer img, .lg-thumb-outer img { -webkit-user-drag:none; }
            .meta-date {
                position: fixed; right: 16px; bottom: 12px; z-index: 99999;
                font-size: 12px; line-height: 1; color: #fff;
                background: rgba(0,0,0,0.5); padding: 6px 8px; border-radius: 6px;
                letter-spacing: .3px;
            }
            .lg-outer .lg-toolbar .lg-close { display:none !important; }
            </style>
        </head>
        <body>
            <div id="gallery"></div>
            <div id="meta-date" class="meta-date"></div>
            <script>
            function loadScript(src){return new Promise(r=>{const s=document.createElement('script');s.src=src;s.onload=r;document.head.appendChild(s);});}
            const items = ${JSON.stringify(items)};
            const start = ${Number(startIndex)};
            (async()=>{
                await loadScript('https://cdn.jsdelivr.net/npm/lightgallery/lightgallery.umd.js');
                await loadScript('https://cdn.jsdelivr.net/npm/lightgallery/plugins/zoom/lg-zoom.umd.js');
                await loadScript('https://cdn.jsdelivr.net/npm/lightgallery/plugins/thumbnail/lg-thumbnail.umd.js');
                await loadScript('https://cdn.jsdelivr.net/npm/lightgallery/plugins/fullscreen/lg-fullscreen.umd.js');

                // (íŒì—… HTML ë‚´ë¶€ ìŠ¤í¬ë¦½íŠ¸)
                const dynamicEl = items.map(it => ({
                    // âœ… í™•ëŒ€ê°€ ì‹¤ì œë¡œ ë˜ê²Œ: srcëŠ” ì›ë³¸(full) ì‚¬ìš©
                    src: it.full,
                    // í‘œì‹œ ì„±ëŠ¥ì€ display(ì¶•ì†Œë³¸)ë¡œ: responsive ì‚¬ìš©í•˜ë©´ ë¶€ë“œëŸ¬ì›Œì§
                    responsive: it.display + ' 640w',
                    thumb: it.thumb,
                    subHtml: it.caption
                }));

                const index = Math.max(0, Math.min(start, Math.max(0, dynamicEl.length-1)));

                const lg = lightGallery(document.getElementById('gallery'), {
                    dynamic: true,
                    dynamicEl,
                    index,

                    // âœ… í”ŒëŸ¬ê·¸ì¸ ë“±ë¡ (ì¤Œ/ì¸ë„¤ì¼/ì „ì²´í™”ë©´)
                    plugins: [lgZoom, lgThumbnail, lgFullscreen],

                    // ğŸ” ì¤Œ ê´€ë ¨ ì˜µì…˜
                    zoom: true,
                    actualSize: true,       // ì›ë³¸ í¬ê¸°ê¹Œì§€ í™•ëŒ€
                    zoomFromOrigin: true,   // ì¸ë„¤ì¼/í‘œì‹œ ì´ë¯¸ì§€ì—ì„œ í™•ëŒ€ ì• ë‹ˆë©”ì´ì…˜
                    allowMediaOverlap: true,
                    closable: false,      // ë°°ê²½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸° í—ˆìš© (ë§‰ê³  ì‹¶ìœ¼ë©´ false)
                    escKey: false,        // ESCë¡œ ë‹«ê¸° í—ˆìš© (ë§‰ê³  ì‹¶ìœ¼ë©´ false)
                    closeOnTap: false,

                    // ê¸°íƒ€
                    download: false,
                });
                lg.openGallery(index);


                // â–¼ í•˜ë‹¨ ë‚ ì§œ ë°°ì§€ ì—…ë°ì´íŠ¸
                const dateEl = document.getElementById('meta-date');
                function setDate(i){
                    const it = items?.[i];
                    dateEl.textContent = (it && it.createdAt) ? it.createdAt : '';
                    dateEl.style.display = dateEl.textContent ? 'block' : 'none';
                }
                setDate(index);
                lg.on('lgAfterSlide', (evt) => {
                    // evt.detail.index ê°€ í˜„ì¬ ì¸ë±ìŠ¤
                    const i = evt?.detail?.index ?? 0;
                    setDate(i);
                });

                // ë¼ì´íŠ¸ê°¤ëŸ¬ë¦¬ ì˜ì—­ë§Œ ìš°í´ë¦­/ë“œë˜ê·¸ ë°©ì§€
                const protectCtx = (e) => { if (e.target.closest('.lg-outer')) e.preventDefault(); };
                document.addEventListener('contextmenu', protectCtx, { capture:true });
                document.addEventListener('dragstart', protectCtx, { capture:true });
            })();
            <\/script>
        </body></html>`;

        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const w = window.open(url, `img-viewer`, 'popup=yes,width=1280,height=800,menubar=no,toolbar=no,location=no,status=no,scrollbars=yes,resizable=yes');
        if(!w){ alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.'); URL.revokeObjectURL(url); return; }
        w.focus();
        setTimeout(() => URL.revokeObjectURL(url), 10000);
    }

    // ë¹„ê³µê°œì‚¬ì§„ ê´€ë ¨ í•¨ìˆ˜ë“¤
    // --- ë¹„ê³µê°œ: ë¯¸ë¦¬ë³´ê¸° ---
    function previewSelectedFilesPrivate() {
        const input = document.getElementById('img-upload-input-private');
        const box   = document.getElementById('img-preview-list-private');
        if (!input || !box) return;

        // ë¡œì»¬ URL ìƒì„±í•´ì„œ ë¯¸ë¦¬ë³´ê¸°
        const urls = [];
        box.innerHTML = '';
        for (const f of input.files || []) {
            const url = URL.createObjectURL(f);
            urls.push(url);
            const el = document.createElement('img');
            el.src = url;
            el.className = 'w-full h-24 object-cover rounded border';
            box.appendChild(el);
        }
        // ë©”ëª¨ë¦¬ ì •ë¦¬(ì„ íƒ): ì°½ ë‹«ì„ ë•Œ revoke í•„ìš”í•˜ë©´ ë³´ê°•
    }

    // --- ë¹„ê³µê°œ: ëª©ë¡ ë¡œë“œ ---
    async function loadListingImagesPrivate(listingId) {
        const box = document.getElementById('img-list-private');
        if (!box) return;

        const { data: rows, error } = await client
            .from('listing_images')
            .select('id, path')
            .eq('listing_id', String(listingId))
            .eq('is_private', true)
            .order('order_index', { ascending: true });

        if (error) { console.error(error); return; }

        box.innerHTML = '';
        for (const r of rows) {
            const thumbUrl = await getTransformedUrl(r.path, 360);

            const wrap = document.createElement('div');
            wrap.className = 'relative group rounded overflow-hidden';

            const img = document.createElement('img');
            img.src = thumbUrl;
            img.className = 'w-full h-24 object-cover rounded border';

            // âœ… ì„ íƒ ì˜¤ë²„ë ˆì´
            const outline = document.createElement('div');
            outline.className = 'pointer-events-none absolute inset-0 hidden ring-2 ring-blue-500 rounded';
            wrap.appendChild(outline);

            // í¸ì§‘ì°½ì—ì„œëŠ” í•­ìƒ ì²´í¬ë°•ìŠ¤ í‘œì‹œ(ê¸°ë³¸ ì„ íƒëª¨ë“œ)
            if (isEditMode) {
                const chk = document.createElement('input');
                chk.type = 'checkbox';
                chk.className = 'img-select absolute bottom-1 left-1 w-5 h-5 accent-blue-600 bg-white/90 rounded shadow';
                chk.dataset.id = r.id;
                chk.dataset.path = r.path;
                // ì²´í¬ ìƒíƒœì— ë”°ë¼ ì‹œê° í‘œì‹œ í† ê¸€
                chk.addEventListener('change', () => {
                    outline.classList.toggle('hidden', !chk.checked);
                });
                wrap.appendChild(chk);
            }

            const del = document.createElement('button');
            del.textContent = 'ì‚­ì œ';
            del.className = 'absolute top-1 right-1 bg-white/90 text-xs px-2 py-[2px] rounded border';
            del.onclick = () => deleteImagePrivate(r.id, r.path, listingId);

            wrap.appendChild(img);
            wrap.appendChild(del);
            box.appendChild(wrap);

            // ğŸ”§ í¸ì§‘ëª¨ë“œë¼ë©´ íˆ´ë°” ë³´ì´ê¸°
            if (isEditMode) setupPublicBulkToolbar(listingId);
        }
    }

    // --- ë¹„ê³µê°œ: ì—…ë¡œë“œ ---
    async function uploadSelectedImagesPrivate(listingId) {
        const input = document.getElementById('img-upload-input-private');
        const uploadBtn = document.getElementById('img-upload-btn-private');
        if (!input || !input.files?.length) { showToast('ë¨¼ì € íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }

        const prevText = uploadBtn?.textContent;
        if (uploadBtn) { uploadBtn.disabled = true; uploadBtn.textContent = 'ì—…ë¡œë“œ ì¤‘...'; }

        try {
            // ë¹„ê³µê°œ ì˜ì—­ì˜ ë§ˆì§€ë§‰ order_index
            let nextIndex = 0;
            try {
            const { data: last } = await client
                .from('listing_images')
                .select('order_index')
                .eq('listing_id', String(listingId))
                .eq('is_private', true)
                .order('order_index', { ascending: false })
                .limit(1)
                .maybeSingle();
            nextIndex = (last?.order_index ?? -1) + 1;
            } catch {}

            let successCount = 0;

            for (const f of input.files) {
            if (!f.type?.startsWith('image/')) { showToast('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì˜¬ë¦´ ìˆ˜ ìˆì–´ìš”.'); continue; }
            if (f.size > 10 * 1024 * 1024) { showToast('10MB ì´í•˜ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); continue; }

            const id  = (crypto?.randomUUID && crypto.randomUUID()) || (Date.now() + '-' + Math.random().toString(16).slice(2));
            const ext = (f.type?.split('/')[1] || 'jpg').toLowerCase();
            const key = `listings/${listingId}/private/orig/${id}.${ext}`;  // â˜… private ê²½ë¡œ

            const { error: upErr } = await client.storage.from(BUCKET).upload(key, f, { upsert: false, contentType: f.type });
            if (upErr) { console.error('ì—…ë¡œë“œ ì‹¤íŒ¨:', upErr); showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + upErr.message); continue; }

            // ë¹„ê³µê°œëŠ” ëŒ€í‘œê°œë… X
            const row = {
                listing_id: String(listingId),
                bucket: BUCKET,
                path: key,
                mime_type: f.type,
                order_index: nextIndex++,
                is_private: true,
                is_primary: false
            };

            const { error: dbErr } = await client.from('listing_images').insert(row);
            if (dbErr) {
                console.error('DB ê¸°ë¡ ì‹¤íŒ¨:', dbErr);
                showToast('DB ê¸°ë¡ ì‹¤íŒ¨: ' + dbErr.message);
                await client.storage.from(BUCKET).remove([key]);
                continue;
            }
            successCount++;
            }

            input.value = '';
            previewSelectedFilesPrivate();
            await loadListingImagesPrivate(listingId);
            showToast(successCount > 0 ? `ì—…ë¡œë“œ ì™„ë£Œ (${successCount}ì¥)` : 'ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
        } finally {
            if (uploadBtn) { uploadBtn.disabled = false; uploadBtn.textContent = prevText || 'ì—…ë¡œë“œ(ë¹„ê³µê°œ)'; }
        }
    }

    // --- ë¹„ê³µê°œ: ì‚­ì œ ---
    async function deleteImagePrivate(rowId, path, listingId) {
        if (!confirm('ì´ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;

        const { error: dbErr } = await client.from('listing_images').delete().eq('id', rowId);
        if (dbErr) { showToast('DB ì‚­ì œ ì‹¤íŒ¨'); return; }

        const { error: stErr } = await client.storage.from(BUCKET).remove([path]);
        if (stErr) { showToast('ìŠ¤í† ë¦¬ì§€ ì‚­ì œ ì‹¤íŒ¨'); return; }

        await loadListingImagesPrivate(listingId);
        showToast('ì‚­ì œ ì™„ë£Œ');
    }

    // --- ë¹„ê³µê°œ: ë“œë˜ê·¸&ë“œë¡­ ---
    function setupDragAndDropUploadPrivate(listingId) {
        const dropzone = document.getElementById('img-dropzone-private');
        const input    = document.getElementById('img-upload-input-private');
        if (!dropzone || !input) return;

        const highlight = () => dropzone.style.borderColor = '#F2C130';
        const unlight   = () => dropzone.style.borderColor = '#d1d5db';

        ['dragenter','dragover'].forEach(evt =>
            dropzone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); highlight(); })
        );
        ;['dragleave','dragend'].forEach(evt =>
            dropzone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); unlight(); })
        );

        dropzone.addEventListener('drop', async (e) => {
            e.preventDefault(); e.stopPropagation(); unlight();
            if (!e.dataTransfer) return;

            const files = await collectFilesFromDataTransfer(e.dataTransfer);
            if (!files.length) { showToast('ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

            const dt = new DataTransfer();
            for (const f of files) dt.items.add(f);
            input.files = dt.files;

            previewSelectedFilesPrivate();
            // ìë™ ì—…ë¡œë“œ ì›í•˜ë©´:
            // await uploadSelectedImagesPrivate(listingId);
        });
    }


    // ê³µê°œì‚¬ì§„ ê´€ë ¨ í•¨ìˆ˜ë“¤
    function previewSelectedFiles() {
        const input = document.getElementById('img-upload-input');
        const box = document.getElementById('img-preview-list');
        if (!input || !box) return;

        // ì´ì „ ë¯¸ë¦¬ë³´ê¸° ì •ë¦¬
        _previewUrls.forEach(u => URL.revokeObjectURL(u));
        _previewUrls = [];
        box.innerHTML = '';

        for (const f of input.files || []) {
            const url = URL.createObjectURL(f);
            _previewUrls.push(url);
            const el = document.createElement('img');
            el.src = url;
            el.className = 'w-full h-24 object-cover rounded border';
            box.appendChild(el);
        }
    }

    // ì €ì¥ëœ ì´ë¯¸ì§€ ëª©ë¡ ë¡œë“œ(ì¸ë„¤ì¼ë¡œ)
    async function loadListingImages(listingId) {
        const box = document.getElementById('img-list');
        if (!box) return;

        // DBì—ì„œ ëª©ë¡
        const { data: rows, error } = await client
            .from('listing_images')
            .select('id, path')
            .eq('listing_id', String(listingId))
            .eq('is_private', false)
            .order('order_index', { ascending: true });

        if (error) { console.error(error); return; }

        box.innerHTML = '';
        for (const r of rows) {
            // ê³µê°œ ë²„í‚·ì´ë©´ getPublicUrlì´ ê°€ì¥ ë‹¨ìˆœí•©ë‹ˆë‹¤.
            const thumbUrl = await getTransformedUrl(r.path, 360); // âœ… BUCKET_IS_PUBLIC ë³´ê³  ì•Œì•„ì„œ ì„œëª…/ê³µê°œ ì„ íƒ


            const wrap = document.createElement('div');
            wrap.className = 'relative group rounded overflow-hidden';

            const img = document.createElement('img');
            img.src = thumbUrl;
            img.className = 'w-full h-24 object-cover rounded border';

            // âœ… ì„ íƒ ì‹œ í‘œì‹œë  ì˜¤ë²„ë ˆì´(íŒŒë€ í…Œë‘ë¦¬)
            const outline = document.createElement('div');
            outline.className = 'pointer-events-none absolute inset-0 hidden ring-2 ring-blue-500 rounded';
            wrap.appendChild(outline);

            // âœ… ì„ íƒëª¨ë“œì¼ ë•Œ ì²´í¬ë°•ìŠ¤ í‘œì‹œ
            if (isEditMode) {
                const chk = document.createElement('input');
                chk.type = 'checkbox';
                chk.className = 'img-select absolute bottom-1 left-1 w-5 h-5 accent-blue-600 bg-white/90 rounded shadow';
                chk.dataset.id = r.id;
                chk.dataset.path = r.path;
                chk.addEventListener('change', () => {
                outline.classList.toggle('hidden', !chk.checked);
                });
                wrap.appendChild(chk);
            }

            // (ì„ íƒ) ì‚­ì œ ë²„íŠ¼
            const del = document.createElement('button');
            del.textContent = 'ì‚­ì œ';
            del.className = 'absolute top-1 right-1 bg-white/90 text-xs px-2 py-[2px] rounded border';
            del.onclick = () => deleteImage(r.id, r.path, listingId);

            wrap.appendChild(img);
            wrap.appendChild(del);
            box.appendChild(wrap);
        }
        if (isEditMode) setupPublicBulkToolbar(listingId);
    }

    // ì‚¬ì§„ ì—…ë¡œë“œ
    async function uploadSelectedImages(listingId) {
        const input = document.getElementById('img-upload-input');
        const uploadBtn = document.getElementById('img-upload-btn');
        if (!input || !input.files?.length) {
            showToast('ë¨¼ì € íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }

        // ë²„íŠ¼ ì ê·¸ê¸°
        const prevText = uploadBtn?.textContent;
        if (uploadBtn) {
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'ì—…ë¡œë“œ ì¤‘...';
        }

        try {
            // í˜„ì¬ ë§ˆì§€ë§‰ order_index êµ¬í•˜ê¸°
            let nextIndex = 0;
            try {
            const { data: last } = await client
                .from('listing_images')
                .select('order_index')
                .eq('listing_id', String(listingId))
                .order('order_index', { ascending: false })
                .limit(1)
                .maybeSingle();
            nextIndex = (last?.order_index ?? -1) + 1;
            } catch {}

            // ëŒ€í‘œì‚¬ì§„ ì¡´ì¬ ì—¬ë¶€
            let hasPrimary = false;
            try {
            const { data: primaryRow } = await client
                .from('listing_images')
                .select('id')
                .eq('listing_id', String(listingId))
                .eq('is_primary', true)
                .limit(1);
            hasPrimary = Array.isArray(primaryRow) && primaryRow.length > 0;
            } catch {}

            let successCount = 0;

            for (const f of input.files) {
            // ê°„ë‹¨í•œ ìœ íš¨ì„± ê²€ì‚¬
            if (!f.type?.startsWith('image/')) { showToast('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì˜¬ë¦´ ìˆ˜ ìˆì–´ìš”.'); continue; }
            if (f.size > 10 * 1024 * 1024) { showToast('10MB ì´í•˜ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); continue; }

            // ê²½ë¡œ: listings/{listingId}/orig/{uuid}.{ext}
            const id = (crypto?.randomUUID && crypto.randomUUID())
                    || (Date.now() + '-' + Math.random().toString(16).slice(2));
            const ext = (f.type?.split('/')[1] || 'jpg').toLowerCase();
            const key = `listings/${listingId}/orig/${id}.${ext}`;

            // 1) ìŠ¤í† ë¦¬ì§€ ì—…ë¡œë“œ
            const { error: upErr } = await client
                .storage.from(BUCKET)
                .upload(key, f, { upsert: false, contentType: f.type });

            if (upErr) {
                console.error('ì—…ë¡œë“œ ì‹¤íŒ¨:', upErr);
                showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + upErr.message);
                continue;
            }

            // 2) DB ê¸°ë¡ (ìˆœì„œ/ëŒ€í‘œ ì„¤ì • í¬í•¨)
            const row = {
                listing_id: String(listingId),
                bucket: BUCKET,
                path: key,
                mime_type: f.type,
                order_index: nextIndex++,
                // ëŒ€í‘œì‚¬ì§„ì´ ì•„ì§ ì—†ìœ¼ë©´, ì´ë²ˆ ì—…ë¡œë“œ ë¬¶ìŒ ì¤‘ ì²« ì¥ì„ ëŒ€í‘œë¡œ
                is_primary: hasPrimary ? false : successCount === 0
            };

            const { error: dbErr } = await client
                .from('listing_images')
                .insert(row);

            if (dbErr) {
                console.error('DB ê¸°ë¡ ì‹¤íŒ¨:', dbErr);
                showToast('DB ê¸°ë¡ ì‹¤íŒ¨: ' + dbErr.message);
                // ë¡¤ë°±: ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°©ê¸ˆ ì˜¬ë¦° íŒŒì¼ ì‚­ì œ
                await client.storage.from(BUCKET).remove([key]);
                continue;
            }

            if (row.is_primary) hasPrimary = true;
            successCount++;
            }

            // ì´ˆê¸°í™” & ëª©ë¡ ê°±ì‹ 
            input.value = '';
            previewSelectedFiles(); // ë¯¸ë¦¬ë³´ê¸° ë¹„ìš°ê¸°
            await loadListingImages(listingId);
            await initImageViewer(listingId);
            showToast(successCount > 0 ? `ì—…ë¡œë“œ ì™„ë£Œ (${successCount}ì¥)` : 'ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
        } finally {
            if (uploadBtn) {
            uploadBtn.disabled = false;
            uploadBtn.textContent = prevText || 'ì—…ë¡œë“œ';
            }
        }
    }


    // ì‚­ì œ(ì„ íƒ)
    async function deleteImage(rowId, path, listingId) {
        if (!confirm('ì´ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;

        // 1) DB ì‚­ì œ
        const { error: dbErr } = await client
            .from('listing_images')
            .delete()
            .eq('id', rowId);
        if (dbErr) { showToast('DB ì‚­ì œ ì‹¤íŒ¨'); return; }

        // 2) ìŠ¤í† ë¦¬ì§€ ì‚­ì œ
        const { error: stErr } = await client
            .storage.from(BUCKET)
            .remove([path]);
        if (stErr) { showToast('ìŠ¤í† ë¦¬ì§€ ì‚­ì œ ì‹¤íŒ¨'); return; }

        await loadListingImages(listingId);
        showToast('ì‚­ì œ ì™„ë£Œ');
    }

    // 'í˜¸'ì™€ ê³µë°± ì œê±°í•´ì„œ ë¹„êµìš©ìœ¼ë¡œ ì •ê·œí™”
    function normalizeUnit(s) {
        return (s ?? '').toString().replace(/\s+/g, '').replace(/í˜¸/g, '').trim();
    }

    //ì¤‘ë³µë§¤ë¬¼ ê²€ì‚¬í•¨ìˆ˜
    // ê³µë°±/â€˜í˜¸â€™ ì œê±°ëŠ” ê¸°ì¡´ normalizeUnit ê·¸ëŒ€ë¡œ ì‚¬ìš©
    function getAddressPartsForDupCheck() {
        const v = (id) => (document.getElementById(id)?.value || '').trim();
        return {
            province: v('province'),
            city: v('city'),
            district: v('district'),
            detail_address: v('detail-address-input'), // ë¹ˆ ë¬¸ìì—´ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        };
    }

    async function checkDuplicateAndNavigateByParts(parts, unitValue) {
        try {
            const currentId = String(window.currentDetailListingId ?? '');
            const targetUnitNorm = normalizeUnit(unitValue);

            // í˜„ì¬ ì„ íƒëœ(ë˜ëŠ” ê¸°ì¡´) ê±°ë˜ìœ í˜• í™•ë³´
            const targetDealType = (
                document.getElementById('dealTypeSelect')?.value ||
                allListings?.[currentId]?.deal_type ||
                ''
            ).trim();

            // ìµœì†Œí•œ ì‹œ/ë„, ì‹œ/êµ°/êµ¬, ì/ë©´/ë™ì€ ìˆì–´ì•¼ ì˜ë¯¸ ìˆìŒ
            if (!parts.province || !parts.city || !parts.district) return false;

            let q = client
                .from('baikukdbtest')
                .select('listing_id, unit_info, deal_type') // â˜… deal_type í¬í•¨
                .eq('province', parts.province)
                .eq('city', parts.city)
                .eq('district', parts.district);

            if (parts.detail_address) {
                q = q.eq('detail_address', parts.detail_address);
            }

            // â˜… í˜„ì¬ deal_typeì„ ì•Œê³  ìˆìœ¼ë©´ ë™ì¢…ë§Œ ì¡°íšŒ(ë¶ˆí•„ìš”í•œ ë ˆì½”ë“œ ê°ì†Œ)
            if (targetDealType) q = q.eq('deal_type', targetDealType);

            const { data, error } = await q;
            if (error) return false;

            const dupRow = (data || []).find((row) => {
                const rowUnitNorm = normalizeUnit(row.unit_info);
                const sameUnit = rowUnitNorm && rowUnitNorm === targetUnitNorm;
                const differentId = String(row.listing_id) !== currentId;
                const sameDealType = String(row.deal_type || '').trim() === targetDealType; // â˜… í•µì‹¬
                return sameUnit && differentId && sameDealType;
            });

            if (dupRow) {
            showToast('ì¤‘ë³µë§¤ë¬¼ì…ë‹ˆë‹¤. í•´ë‹¹ ë§¤ë¬¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.', 2000);
            setTimeout(() => {
                if (typeof openDeepLink === 'function') openDeepLink(dupRow.listing_id);
                else go(`/admin?id=${dupRow.listing_id}`);
            }, 400);
            return true;
            }
            return false;
        } catch {
            return false;
        }
    }

    //í˜¸ìˆ˜ í™•ì¸ ê´€ë ¨í•¨ìˆ˜
    function askUnitInfo() {
        return new Promise((resolve) => {
            const modal = document.getElementById('unit-modal');
            const input = document.getElementById('unit-modal-input');
            const btnYes = document.getElementById('unit-modal-yes');
            const btnNo  = document.getElementById('unit-modal-no');

            // í˜„ì¬ ê°’ ìˆìœ¼ë©´ ë¯¸ë¦¬ ì±„ì›Œì£¼ê¸°
            const current = document.getElementById('unit_info')?.value || '';
            input.value = current;

            const show = () => {
                modal.classList.remove('hidden');
                setTimeout(() => input.focus(), 0);
            };
            const hide = () => modal.classList.add('hidden');

            const cleanup = () => {
                btnYes.removeEventListener('click', onYes);
                btnNo.removeEventListener('click', onNo);
                input.removeEventListener('keydown', onKey);
            };
            const onYes = () => {
                const value = input.value.trim();
                hide(); cleanup();
                resolve({ confirmed: true, value });
            };
            const onNo = () => {
                hide(); cleanup();
                resolve({ confirmed: false, value: '' });
            };
            const onKey = (e) => {
                if (e.key === 'Enter') onYes();
                if (e.key === 'Escape') onNo();
            };

            btnYes.addEventListener('click', onYes);
            btnNo.addEventListener('click', onNo);
            input.addEventListener('keydown', onKey);

            show();
        });
    }


    // ì‹œêµ°êµ¬ ì„ íƒê´€ë ¨
    // í•œ ë²ˆ ë¶ˆëŸ¬ì˜¤ë©´ ì¬ì‚¬ìš© (í† ê¸€ ì‹œ ì¬ìš”ì²­ ë°©ì§€)
    let _pcdCache = null;

    /**
     * province_city_district ì „ì²´ ë¡œë”© (ë°°ì¹˜)
     * @param {number} batchSize - í˜ì´ì§€ í¬ê¸°(ê¸°ë³¸ 1000)
     */
    async function fetchAllPCD(batchSize = 1000) {
    if (_pcdCache) return _pcdCache;

    let from = 0;
    let all = [];

    while (true) {
        const to = from + batchSize - 1; // rangeëŠ” ì–‘ë í¬í•¨
        const { data, error } = await client
        .from('province_city_district')
        .select('province, city, district')
        // í˜ì´ì§€ ê°„ ì •ë ¬ ì¼ê´€ì„±ì„ ìœ„í•´ ê³ ì • ì •ë ¬ ê¶Œì¥
        .order('province', { ascending: true })
        .order('city', { ascending: true })
        .order('district', { ascending: true })
        .range(from, to);

        if (error) throw error;

        all = all.concat(data || []);
        if (!data || data.length < batchSize) break; // ë§ˆì§€ë§‰ í˜ì´ì§€
        from += batchSize;
    }

    _pcdCache = all;
    return all;
    }

    // ===== ì§€ì—­(ì‹œ/ë„-ì‹œ/êµ°/êµ¬-ì/ë©´/ë™) ì˜ì¡´í˜• ë“œë¡­ë‹¤ìš´ =====
    async function initLocationSelects(listing) {
        const provinceEl = document.getElementById('province');
        const cityEl = document.getElementById('city');
        const districtEl = document.getElementById('district');
        if (!provinceEl || !cityEl || !districtEl) return;

        const setPlaceholder = () => {
            provinceEl.innerHTML = `<option value="">ì‹œ/ë„</option>`;
            cityEl.innerHTML     = `<option value="">ì‹œ/êµ°/êµ¬</option>`;
            districtEl.innerHTML = `<option value="">ì/ë©´/ë™</option>`;
        };
        setPlaceholder();

        let rows = [];
        try {
            rows = await fetchAllPCD(1000); // í•„ìš”ì‹œ 2000 ë“±ìœ¼ë¡œ ì˜¬ë ¤ë„ OK
        } catch (e) {
            console.error('ì§€ì—­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
            // ì‹¤íŒ¨ ì‹œì—ë„ í˜„ì¬ ê°’ì€ ë³´ì´ë„ë¡
            fillSelect(provinceEl, listing.province ? [listing.province] : [], listing.province);
            fillSelect(cityEl, listing.city ? [listing.city] : [], listing.city);
            fillSelect(districtEl, listing.district ? [listing.district] : [], listing.district);
            return;
        }

        const collate = new Intl.Collator('ko-KR');
        const uniq = arr => Array.from(new Set(arr));
        const sortKo = arr => arr.sort((a,b)=>collate.compare(a,b));

        const citiesByProv = new Map();        // province -> Set(cities)
        const distsByProvCity = new Map();     // `${province}|${city}` -> Set(districts)

        for (const { province, city, district } of rows) {
            if (!province || !city || !district) continue;
            if (!citiesByProv.has(province)) citiesByProv.set(province, new Set());
            citiesByProv.get(province).add(city);

            const key = `${province}|${city}`;
            if (!distsByProvCity.has(key)) distsByProvCity.set(key, new Set());
            distsByProvCity.get(key).add(district);
        }

        const provinces = sortKo(uniq(rows.map(r => r.province).filter(Boolean)));

        function fillSelect(selectEl, values, selected) {
            selectEl.innerHTML = '';
            const ph = document.createElement('option');
            ph.value = '';
            ph.textContent = selectEl === provinceEl ? 'ì‹œ/ë„' : (selectEl === cityEl ? 'ì‹œ/êµ°/êµ¬' : 'ì/ë©´/ë™');
            selectEl.appendChild(ph);

            // í˜„ì¬ ì €ì¥ëœ ê°’ì´ ëª©ë¡ì— ì—†ìœ¼ë©´ ë§¨ ìœ„ì— ë¨¼ì € ë³´ì—¬ì£¼ê¸°
            let list = [...values];
            if (selected && !values.includes(selected)) list = [selected, ...values];

            for (const v of list) {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = v;
            if (selected && v === selected) opt.selected = true;
            selectEl.appendChild(opt);
            }
        }

        // 1) province
        fillSelect(provinceEl, provinces, listing.province);

        // 2) city (provinceì— ì¢…ì†)
        const selProvince = provinceEl.value || listing.province || '';
        const cities = selProvince ? sortKo(uniq([...(citiesByProv.get(selProvince) || [])])) : [];
        fillSelect(cityEl, cities, listing.city);

        // 3) district (province+cityì— ì¢…ì†)
        const selCity = cityEl.value || listing.city || '';
        const key = `${selProvince}|${selCity}`;
        const districts = (selProvince && selCity) ? sortKo(uniq([...(distsByProvCity.get(key) || [])])) : [];
        fillSelect(districtEl, districts, listing.district);

        // ë³€í™” ì´ë²¤íŠ¸
        provinceEl.onchange = () => {
            const p = provinceEl.value;
            const cities2 = p ? sortKo(uniq([...(citiesByProv.get(p) || [])])) : [];
            fillSelect(cityEl, cities2, '');
            fillSelect(districtEl, [], ''); // ì´ˆê¸°í™”
        };

        cityEl.onchange = () => {
            const p = provinceEl.value;
            const c = cityEl.value;
            const k = `${p}|${c}`;
            const d2 = (p && c) ? sortKo(uniq([...(distsByProvCity.get(k) || [])])) : [];
            fillSelect(districtEl, d2, '');
        };
    }


    // === ë”¥ë§í¬ ìœ í‹¸: ?id=12345 ===
    function getListingIdFromURL() {
        const sp = new URLSearchParams(location.search);
        const qId = sp.get('id');
        return qId && /^\d+$/.test(qId) ? qId : null;
    }

    function updateURLForListing(listingId, replace = false) {
        const url = new URL(location.href);
        if (listingId) url.searchParams.set('id', String(listingId));
        else url.searchParams.delete('id');
        try {
            history[replace ? 'replaceState' : 'pushState']({}, '', url);
        } catch (_) {}
    }

    // openDeepLink êµì²´ (ë‘ ë²ˆì§¸ ì¸ì skipUrl=false ì¶”ê°€)
    async function openDeepLink(listingId, skipUrl = false) {
        if (!listingId) return;
        const id = String(listingId);

        if (!allListings[id]) {
            const { data, error } = await client
            .from('baikukdbtest')
            .select('*')
            .eq('listing_id', id)
            .maybeSingle();

            if (error || !data) { alert('í•´ë‹¹ ë§¤ë¬¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); return; }

            try {
            const key = (data.addr_compare || '').replace(/\s+/g,'').trim();
            if (key) {
                const { data: bi } = await client
                .from('building_info')
                .select('building_name, building_note, addr_compare')
                .eq('addr_compare', key)
                .maybeSingle();
                if (bi) {
                data.building_name = bi.building_name ?? data.building_name ?? '-';
                data.building_note = bi.building_note ?? data.building_note ?? '-';
                }
            }
            } catch(e) {}

            allListings[id] = data;
        }

        const l = allListings[id];
        if (map && l?.lat && l?.lng) {
            map.setCenter(new kakao.maps.LatLng(l.lat, l.lng));
            map.setLevel(3);
        }

        if (typeof showDetailPanel === 'function') showDetailPanel(id);

        if (!skipUrl) updateURLForListing(id, /*replace*/true);
    }


    // ë¸Œë¼ìš°ì € ë’¤/ì• ì´ë™ ëŒ€ì‘
    window.addEventListener('popstate', () => {
        const id = getListingIdFromURL();
        if (id) openDeepLink(id, /*skipUrl*/true);
        else hideDetailPanel(/*skipUrl*/true);
    });

    // ì†Œìˆ«ì  ë‘ë²ˆì§¸ìë¦¬ê¹Œì§€ë§Œ í‘œì‹œí•¨ìˆ˜
    function formatNumber2(num) {
        if (num === null || num === undefined || num === '' || isNaN(num)) return '';
        return parseFloat(num).toFixed(2).replace(/\.?0+$/, ''); 
        // ì˜ˆ) 10.50 â†’ "10.5", 10.00 â†’ "10"
    }

    // ìˆ˜ì •ëª¨ë“œì—ì„œ ì§€ë„ ê²€ìƒ‰ë²„íŠ¼ëˆŒë €ì„ ë•Œ ë§ˆì»¤í‘œì‹œ ê´€ë ¨ í•¨ìˆ˜
    // ì£¼ì†Œ íŒŒíŠ¸ í•©ì¹˜ê¸°
    function buildFullAddress() {
        const getVal = (id) => (document.getElementById(id)?.value || '').trim();
        const parts = [getVal('province'), getVal('city'), getVal('district'), getVal('detail-address-input')];
        return parts.filter(Boolean).join(' ').replace(/\s+/g, ' ').trim();
    }

    // ì§€ì˜¤ì½”ë”©í•´ì„œ ì§€ë„/ë§ˆì»¤ ì´ë™
    async function searchAndMoveMarker() {
        if (!window.previewMap || !window.previewMarker) {
            showToast('ë¯¸ë¦¬ë³´ê¸° ì§€ë„ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 2500);
            return;
        }

        // 1) í˜¸ìˆ˜ ì…ë ¥ ëª¨ë‹¬ (ì´ë¯¸ êµ¬í˜„í•œ ë¶€ë¶„)
        try {
            const { confirmed, value } = await askUnitInfo();
            if (confirmed) {
            const unitEl = document.getElementById('unit_info');
            if (unitEl) unitEl.value = value.trim();
            }
        } catch (e) {
            console.warn('í˜¸ìˆ˜ ì…ë ¥ ëª¨ë‹¬ ì—ëŸ¬:', e);
        }

        // 2) ì£¼ì†Œ ë¬¸ìì—´ ë§Œë“¤ê¸°
        const fullAddr = buildFullAddress();
        if (!fullAddr) {
            showToast('ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 2500);
            return;
        }

        const parts = getAddressPartsForDupCheck();
        const unitVal = (document.getElementById('unit_info')?.value || '').trim();
        if (unitVal) {
            const dup = await checkDuplicateAndNavigateByParts(parts, unitVal);
            if (dup) return; // ì¤‘ë³µì´ë©´ ì—¬ê¸°ì„œ ë
        }

        // 5) ì¤‘ë³µì´ ì•„ë‹ˆë©´ ê¸°ì¡´ ì§€ì˜¤ì½”ë”© + GRIS íŠ¸ë¦¬ê±° ê³„ì† ì§„í–‰
        const geocoder = new kakao.maps.services.Geocoder();
        geocoder.addressSearch(fullAddr, (result, status) => {
            if (status === kakao.maps.services.Status.OK && result?.length) {
                const y = parseFloat(result[0].y), x = parseFloat(result[0].x);
                const coords = new kakao.maps.LatLng(y, x);

                window.previewMarker.setPosition(coords);
                window.previewMap.panTo(coords);
                window._previewLatLng = { lat: y, lng: x };

                showToast('ì§€ë„ ìœ„ì¹˜ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                showToast('ì£¼ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 3000);
            }
        });
    }

    // í˜¸ìˆ˜, ê±´ë¬¼ëª… ë†’ì´ ì¡°ì ˆ í•¨ìˆ˜
    // ë³´ê¸° ë°•ìŠ¤ ë†’ì´ë¡œ ì¤„ìˆ˜ ê³„ì‚°(ìµœëŒ€ 2ì¤„), ì¤„ë†’ì´ í”½ì…€ë„ ê°™ì´ ë³´ê´€
    function measureLinesById(id, max=2) {
        const el = document.getElementById(id);
        if (!el) return { lines: 1, lineHeight: 20 };

        const cs = getComputedStyle(el);
        let lh = parseFloat(cs.lineHeight);
        if (Number.isNaN(lh)) {
            // í˜¹ì‹œ ìˆ«ìë¡œ ëª» ì½ìœ¼ë©´ í°íŠ¸í¬ê¸°*1.4 ì‚¬ìš© (two-lineì˜ line-height:1.4 ê¸°ì¤€)
            lh = (parseFloat(cs.fontSize) || 14) * 1.4;
        }
        const pt = parseFloat(cs.paddingTop) || 0;
        const pb = parseFloat(cs.paddingBottom) || 0;
        const contentH = el.clientHeight - pt - pb;
        const rawLines = contentH / lh;
        const lines = Math.max(1, Math.min(max, Math.round(rawLines)));
        return { lines, lineHeight: lh };
    }
    // textareaë¥¼ ì§€ì •í•œ ì¤„ìˆ˜ë¡œ â€œì •í™•íˆâ€ ë§ì¶”ê¸°
    function applyLinesToTextarea(id, state) {
        const ta = document.getElementById(id);
        if (!ta || !state) return;

        const cs = getComputedStyle(ta);
        const pt = parseFloat(cs.paddingTop) || 0;
        const pb = parseFloat(cs.paddingBottom) || 0;
        const bt = parseFloat(cs.borderTopWidth) || 0;
        const bb = parseFloat(cs.borderBottomWidth) || 0;

        ta.style.lineHeight = state.lineHeight + 'px';
        ta.style.boxSizing = 'border-box';
        ta.style.height = (state.lines * state.lineHeight + pt + pb + bt + bb) + 'px';
        ta.style.overflow = 'hidden';
        ta.rows = state.lines; // ë³´ì¡°
    }
    // ì¤„ìˆ˜ ìºì‹œ (ë³´ê¸°â†’ìˆ˜ì • ì „í™˜í•  ë•Œ ì €ì¥)
    const _lineSyncCache = {
        building_name: { lines: 1, lineHeight: 20 },
        unit_info:     { lines: 1, lineHeight: 20 },
        restroom:      { lines: 1, lineHeight: 20 },
        store_type_detail:   { lines: 1, lineHeight: 20 },
        title:   { lines: 1, lineHeight: 20 }
    };


    function resetNumericFilters() {
        filterDefs.forEach(def => {
            const minEl = document.getElementById(`${def.id}_min`);
            const maxEl = document.getElementById(`${def.id}_max`);
            if (minEl) minEl.value = "";
            if (maxEl) maxEl.value = "";
            updateFilterButtonText(def.id);
        });
    }

    function resetFilters() {
        resetNumericFilters();
        selectedCategories = ['ìƒê°€'];
        selectedDealTypes = ['ì›”ì„¸'];      
        renderDealAndCategoryButtons();
        resetSelectFiltersToDefault();// â¬‡ï¸ ì§„í–‰ìƒíƒœë¥¼ 'ì§„í–‰ì¤‘'ë§Œ ì„ íƒìœ¼ë¡œ ì´ˆê¸°í™”
        updateFilteredListingsDebounced();
    }

    function renderFilterButtons() {
        const wrap = document.getElementById('filter-btns-wrap');
        wrap.innerHTML = '';
        filterDefs.forEach(def => {
            const btn = document.createElement('button');
            btn.id = `filter-btn-${def.id}`;
            btn.setAttribute('data-default-label', def.label + ' â–¼');
            btn.className = "px-2 py-2 border border-gray-300 bg-white rounded-md shadow-sm text-[14px] text-gray-800 font-medium hover:bg-gray-100";
            btn.innerText = def.label + ' â–¼';
            btn.onclick = () => toggleFilterPanel(def.id);

            const panel = document.createElement('div');
            panel.id = `filter-panel-${def.id}`;
            panel.className = `hidden absolute left-0 mt-1 bg-white border rounded shadow z-50`;
            panel.style.width = `${def.width}px`;
            panel.innerHTML = `<div class="flex items-center gap-2 p-3">
                <input id="${def.id}_min" type="number" placeholder="ì´ìƒ" class="w-20 px-2 py-1 border rounded text-sm" />
                <span class="text-gray-500">~</span>
                <input id="${def.id}_max" type="number" placeholder="ì´í•˜" class="w-20 px-2 py-1 border rounded text-sm" />
            </div>`;
            
            const box = document.createElement('div');
            box.className = 'relative';
            box.appendChild(btn);
            box.appendChild(panel);
            wrap.appendChild(box);

            setTimeout(() => {
                const minInput = document.getElementById(`${def.id}_min`);
                const maxInput = document.getElementById(`${def.id}_max`);
                const update = () => {
                    updateFilterButtonText(def.id);
                    updateFilteredListingsDebounced();
                };
                if (minInput) minInput.addEventListener('input', update);
                if (maxInput) maxInput.addEventListener('input', update);
            }, 0);
        });
    }

    function createClusterer(gridSize) {
        if (clusterer && gridSize === currentGridSize) return;
        currentGridSize = gridSize;

        if (clusterer) clusterer.clear();

        clusterer = new kakao.maps.MarkerClusterer({
            map: map,
            averageCenter: true,
            minLevel: 1,
            minClusterSize: 1,
            disableClickZoom: true,
            gridSize: gridSize,
            styles: [{
            width: '40px', height: '40px', background: HIGHLIGHT_COLOR,
            border: '2px solid #F2C130', borderRadius: '50%', color: '#fff',
            fontWeight: 'bold', textAlign: 'center', lineHeight: '40px'
            }]
        });

        // í´ë¦­: ìŠ¤íƒ€ì¼ í† ê¸€ + ë¦¬ìŠ¤íŠ¸ íŒ¨ë„ í‘œì‹œ (ê¸°ì¡´ ìœ ì§€)
        kakao.maps.event.addListener(clusterer, 'clusterclick', function(cluster) {
            if (selectedClusterEl) {
            selectedClusterEl.style.border = "none";
            selectedClusterEl.style.borderRadius = "50%";
            const prevInner = selectedClusterEl.querySelector('div');
            if (prevInner) {
                prevInner.style.background = HIGHLIGHT_COLOR;
                prevInner.style.color = "#fff";
            }
            }

            const clusterEl = cluster.getClusterMarker().getContent().parentNode;
            if (clusterEl) {
                clusterEl.style.background = "transparent";
                clusterEl.style.border = "2px solid #F2C130";
                clusterEl.style.borderRadius = "50%";
                const inner = clusterEl.querySelector('div');
                if (inner) {
                    inner.style.background = "#ffffff";
                    inner.style.color = "#F2C130";
                    inner.style.borderRadius = "50%";
                }
                selectedClusterEl = clusterEl;
            }

            const markerList = cluster.getMarkers();
            const listings = markerList
            .map(mk => allListings[String(mk.listing_id)])
            .filter(Boolean);

            // âœ… ìŠ¤í¬ë¡¤ ì´ˆê¸°í™”
            detailScrollTop = 0;
            showListingsInPanel(listings);

            // âœ… í´ë¦­í•œ í´ëŸ¬ìŠ¤í„°ì˜ ë§¤ë¬¼ë“¤ ìƒì„¸ì´ë¯¸ì§€(ëŒ€í‘œ 1~2ì¥) ë¯¸ë¦¬ ë””ì½”ë”©
            prewarmDetailThumbs(
                listings.map(l => l.listing_id),
                { perListing: 2, displayWidth: 900, timeout: 800, maxListings: 60 }
            ).catch(()=>{});
        });

        // Hover ì‹œ ìŠ¤íƒ€ì¼(ê¸°ì¡´ ìœ ì§€)
        const setupClusterHoverEvent = (eventName, style) => {
            kakao.maps.event.addListener(clusterer, eventName, function(cluster) {
            const el = cluster.getClusterMarker().getContent()?.parentNode;
            if (el) Object.assign(el.style, style);
            });
        };
        setupClusterHoverEvent('clusterover', { border: '3px solid white', borderRadius: '50%' });
        setupClusterHoverEvent('clusterout',  { border: 'none' });

    }

    /*************************
     * ë‹¤ì¤‘ì„ íƒ ì…€ë ‰íŠ¸ ë²„íŠ¼ í•„í„°
     * - filter-btns-wrapì™€ ë™ì¼í•œ ë²„íŠ¼ UI
     * - ê°’ ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥
     *************************/


    // ë²„íŠ¼ ë Œë”ë§
    function renderSelectFilter({ containerId = 'select-filter-wrap', field, label = '', options = [] }) {
        const wrap = document.getElementById(containerId);
        if (!wrap) return;

        // ì»¨í…Œì´ë„ˆ ë¹„ìš°ê³  ë¼ë²¨ + ë²„íŠ¼ ë¬¶ìŒ ìƒì„±
        wrap.innerHTML = '';
        const group = document.createElement('div');
        group.className = 'flex flex-wrap items-center gap-2';

        if (label) {
            const title = document.createElement('div');
            title.className = 'text-[13px] text-gray-700 font-semibold mr-1';
            title.textContent = label;
            group.appendChild(title);
        }

        // ì„ íƒ ìƒíƒœ ë³´ì¥
        if (!Array.isArray(selectFilterState[field])) selectFilterState[field] = [];

        // ë²„íŠ¼ ìƒì„± í•¨ìˆ˜
        const makeBtn = (text, value) => {
            const isSelected = selectFilterState[field].includes(value);
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.textContent = isSelected ? 'âœ“ ' + text : text;
            btn.className = "px-3 py-2 rounded-full border border-gray-300 text-[13px] font-medium transition mr-0";
            if (isSelected) {
            Object.assign(btn.style, { 
                backgroundColor: HIGHLIGHT_COLOR, 
                color: HIGHLIGHT_TEXT_COLOR, 
                fontWeight: 'bold', 
                borderColor: "#eab308" 
            });
            } else {
            Object.assign(btn.style, { 
                backgroundColor: DEFAULT_BTN_BG, 
                color: DEFAULT_BTN_TEXT, 
                fontWeight: 'normal', 
                borderColor: "#d1d5db" 
            });
            }

            btn.onclick = () => {
            toggleSelectFilter(field, value);
            };
            return btn;
        };

        // ì˜µì…˜ ë²„íŠ¼ë“¤
        options.forEach(opt => group.appendChild(makeBtn(opt, opt)));

        wrap.appendChild(group);
    }

    // í† ê¸€ ë™ì‘
    function toggleSelectFilter(field, value) {
        if (!Array.isArray(selectFilterState[field])) selectFilterState[field] = [];
        const arr = selectFilterState[field];
        const idx = arr.indexOf(value);
        if (idx >= 0) arr.splice(idx, 1); else arr.push(value);
        // UI ë‹¤ì‹œ ê·¸ë¦¼
        renderSelectFilter({
            containerId: 'select-filter-wrap',
            field,
            // label, optionsì€ ë§ˆì§€ë§‰ ë Œë” ì‹œ ì „ë‹¬ëœ ê±¸ ê¸°ì–µí•˜ì§€ ëª»í•˜ë¯€ë¡œ,
            // ì•„ë˜ init ì˜ˆì‹œì²˜ëŸ¼ ë§¤ë²ˆ ê°™ì€ íŒŒë¼ë¯¸í„°ë¡œ í˜¸ì¶œí•´ ì£¼ëŠ” ê²ƒì´ ì•ˆì „í•©ë‹ˆë‹¤.
            label: window.__selectFilterMeta?.[field]?.label || '',
            options: window.__selectFilterMeta?.[field]?.options || []
        });
        // í•„í„° ì¬ì ìš©
        updateFilteredListingsDebounced();
    }

    // â¬‡ï¸ ë‹¤ì¤‘ì„ íƒ í•„í„°ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ëŠ” í—¬í¼
    function resetSelectFiltersToDefault() {
        // ê¸°ë³¸ ìƒíƒœ: transaction_status = ['ì§„í–‰ì¤‘']
        if (!window.__selectFilterMeta) window.__selectFilterMeta = {};
        if (!selectFilterState) window.selectFilterState = {};

        selectFilterState.transaction_status = ['ì§„í–‰ì¤‘'];

        // UI ë‹¤ì‹œ ë Œë”
        if (document.getElementById('select-filter-wrap')) {
            renderSelectFilter({
                containerId: 'select-filter-wrap',
                field: 'transaction_status',
                label: window.__selectFilterMeta?.transaction_status?.label || 'ì§„í–‰ìƒíƒœ',
                options: window.__selectFilterMeta?.transaction_status?.options || ['ì§„í–‰ì¤‘', 'ê³„ì•½ì™„ë£Œ', '-']
            });
        }
    }


    function renderDealAndCategoryButtons() {
        const btnWrap = document.getElementById('btn-wrap');
        btnWrap.innerHTML = '';

        const createButton = (text, isSelected, onClick) => {
            const btn = document.createElement('button');
            btn.textContent = isSelected ? 'âœ“ ' + text : text;
            btn.className = "px-3 py-2 rounded-full border border-gray-300 text-[13px] font-medium transition mr-0";
            btn.onclick = onClick;
            if (isSelected) {
                Object.assign(btn.style, { backgroundColor: HIGHLIGHT_COLOR, color: HIGHLIGHT_TEXT_COLOR, fontWeight: 'bold', borderColor: "#eab308" });
            } else {
                Object.assign(btn.style, { backgroundColor: DEFAULT_BTN_BG, color: DEFAULT_BTN_TEXT, fontWeight: 'normal', borderColor: "#d1d5db" });
            }
            btnWrap.appendChild(btn);
        };

        allDealTypes.forEach(type => createButton(type, selectedDealTypes.includes(type), () => toggleDealType(type)));
        allCategories.forEach(cat => createButton(cat, selectedCategories.includes(cat), () => toggleCategory(cat)));
    }

    function toggleDealType(type) {
        if (selectedDealTypes.includes(type)) {
            if (selectedDealTypes.length > 1) selectedDealTypes = selectedDealTypes.filter(x => x !== type);
        } else {
            selectedDealTypes.push(type);
        }
        renderDealAndCategoryButtons();
        updateFilteredListingsDebounced();
    }
    
    function toggleCategory(cat) {
        if (selectedCategories.includes(cat)) {
            if (selectedCategories.length > 1) selectedCategories = selectedCategories.filter(c => c !== cat);
        } else {
            selectedCategories.push(cat);
        }
        renderDealAndCategoryButtons();
        updateFilteredListingsDebounced();
    }

    // ì „ì—­ ê°€ì •: isEditMode, _lineSyncCache, showToast,
    // saveAgentNameIfChanged(listingId), saveListingDetails(listingId),
    // measureLinesById(id), showDetailPanel(listingId)

    async function toggleEditMode() {
        const listingId = window.currentDetailListingId;
        if (!listingId) {
            showToast('ë§¤ë¬¼ì„ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.');
            return;
        }

        // í˜„ì¬ íŒ¨ë„ ìŠ¤í¬ë¡¤ ì €ì¥
        const panelContent = document.getElementById('detail-content');
        if (panelContent) {
            detailScrollTop = panelContent.scrollTop;
        }

        // ë¬´ì¡°ê±´ ì˜¤ë²„ë ˆì´ ì¶”ê°€ (ì‘ì—… ì¤‘ í´ë¦­ ë°©ì§€)
        const overlay = document.createElement('div');
        overlay.id = 'black-overlay';
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.right = '0';
        overlay.style.bottom = '0';
        overlay.style.background = 'black';
        overlay.style.opacity = '0.8';
        overlay.style.zIndex = '99999';
        document.body.appendChild(overlay);

        try {
            // ë³´ê¸° â†’ ìˆ˜ì • ë“¤ì–´ê°€ê¸° ì „ì— ë³´ê¸°ëª¨ë“œ ì¤„ìˆ˜ ì¸¡ì •í•´ì„œ ìºì‹œì— ì €ì¥
            if (!isEditMode) {
            _lineSyncCache.building_name     = measureLinesById('building_name_view');
            _lineSyncCache.unit_info         = measureLinesById('unit_info_view');
            _lineSyncCache.restroom          = measureLinesById('restroom_view');
            _lineSyncCache.store_type_detail = measureLinesById('store_type_detail_view');
            _lineSyncCache.title             = measureLinesById('title_view');
            }

            // ìˆ˜ì • â†’ ë³´ê¸°ë¡œ ë‚˜ê°ˆ ë•Œë§Œ ì €ì¥ ì‹œë„
            if (isEditMode) {
            // 1) ë‹´ë‹¹ì ë³€ê²½ì´ ìˆìœ¼ë©´ ë¨¼ì € ì €ì¥ (ê¶Œí•œ/ì •ì±… ìœ„ë°˜ ì‹œ í† ìŠ¤íŠ¸ë¡œ ì•ˆë‚´ë˜ê³  false ë°˜í™˜í•˜ë„ë¡ êµ¬í˜„ë˜ì–´ ìˆë‹¤ê³  ê°€ì •)
            const okAgent = await saveAgentNameIfChanged(listingId);
            if (!okAgent) {
                // ë‹´ë‹¹ì ì €ì¥ ì‹¤íŒ¨ ì‹œ ì „ì²´ ì €ì¥ ì¤‘ë‹¨ (ë¹ˆ ê°’ ì €ì¥ ë°©ì§€)
                showToast('ë‹´ë‹¹ì ë³€ê²½ì„ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                return;
            }

            // 2) ë‚˜ë¨¸ì§€ í•„ë“œ ì €ì¥
            await saveListingDetails(listingId);
            }

            // ëª¨ë“œ í† ê¸€
            isEditMode = !isEditMode;

            // íŒ¨ë„ ë‹¤ì‹œ ë Œë”ë§
            await showDetailPanel(listingId);

            // ìŠ¤í¬ë¡¤ ë³µì›
            const newPanel = document.getElementById('detail-content');
            if (newPanel && typeof detailScrollTop === 'number') {
            newPanel.scrollTop = detailScrollTop;
            }
        } catch (err) {
            console.error(err);
            showToast('ì €ì¥/ì „í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
            // ì˜¤ë²„ë ˆì´ ì œê±°
            const exist = document.getElementById('black-overlay');
            if (exist) exist.remove();
        }
    }
    
    // âœ… ì—…ë¬´ì¼ì§€ ê´€ë ¨ í•¨ìˆ˜
    function renderWorkLogs(workLogs) {
        console.log("ğŸ§¾ ì—…ë¬´ì¼ì§€ ë Œë”ë§ ì¤‘... ë°ì´í„°:", workLogs);  // âœ… 3

        if (!Array.isArray(workLogs) || workLogs.length === 0) {
            return `<div class="text-sm text-gray-400 mt-2">ğŸ“­ ë“±ë¡ëœ ì—…ë¬´ì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        }

        return workLogs.map(log => {
            const date = new Date(log.Registration_date).toLocaleString("ko-KR");
            return `
                <div class="border border-gray-300 rounded px-3 py-0 mb-0 text-sm bg-white">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-gray-800">ğŸ“Œ ${log.type}</span>
                        <span class="text-gray-500 text-xs">${date}</span>
                    </div>
                    <div class="text-gray-700 mb-1">ğŸ‘¤ ${log.agent_name}</div>
                    <div class="text-gray-600 whitespace-pre-line">${log.contents}</div>
                </div>
            `;
        }).join('');
    }

    function renderWorkLogPanel(workLogs) {
        const container = document.getElementById("work-log-content");

        function formatDate1(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            if (isNaN(d)) return '';
            const pad = n => String(n).padStart(2, '0');

            const yy = String(d.getUTCFullYear()).slice(-2);
            const mm = pad(d.getUTCMonth() + 1);
            const dd = pad(d.getUTCDate());
            const hh = pad(d.getUTCHours());

            return `${yy}${mm}${dd}`;
        }

        function formatDate2(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            if (isNaN(d)) return '';
            const pad = n => String(n).padStart(2, '0');

            const yy = String(d.getUTCFullYear()).slice(-2);
            const mm = pad(d.getUTCMonth() + 1);
            const dd = pad(d.getUTCDate());
            const hh = pad(d.getUTCHours());

            return `${hh}`;
        }



        const filteredLogs = workLogs.filter(log => log.type === "ì…ë ¥");

        const logsHTML = filteredLogs.length
            ? filteredLogs.map(log => {
                const content = (log.contents || '').trim().replace(/\n{2,}/g, '\n').replace(/\n/g, '<br>');

                // ëŒ€/ì†Œë¬¸ì ëª¨ë‘ ëŒ€ì‘ (ì—†ìœ¼ë©´ null)
                const regDate = log.Registration_date ?? log.registration_date ?? null;
                const dateHtml1 = regDate ? formatDate1(regDate) : '';
                const dateHtml2 = regDate ? formatDate2(regDate) : '';

                return `
        <div class="border-b border-gray-300 w-full px-2 py-1 text-sm text-gray-800 mb-[2px] leading-tight flex justify-between items-start">
        <div class="flex flex-col items-center mb-[1px]">
            <span class="font-semibold">${log.agent_name ?? ''}</span>
            <div class="flex items-baseline leading-tight">
                <span class="text-sm text-gray-500 items-center font-bold">${dateHtml1}</span>&nbsp;
                <span class="text-xs text-gray-500 items-center">${dateHtml2}</span>
            </div>            
        </div>
        <div class="text-[0.95rem] text-gray-900 leading-snug pb-1 w-[78%] text-left">${content}</div>
        </div>`;
            }).join('')
            : `<div class="text-gray-500 text-sm">ë“±ë¡ëœ ì—…ë¬´ì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;

        container.innerHTML = logsHTML;
    }




    // ë‚ ì§œì˜¤ë¥˜í•´ê²°í•  ìœ í‹¸í•¨ìˆ˜
    function parseDateOrNull(val) {
        const s = (val ?? '').trim();
        if (!s) return null; // ë¹ˆ ì…ë ¥ì€ null

        // í—ˆìš©: YYYY-MM-DD / YYYY.MM.DD / YYYY/MM/DD
        const m = s.match(/^(\d{4})[-./](\d{1,2})[-./](\d{1,2})$/);
        if (!m) return null;

        let [_, y, mo, d] = m;
        const Y = +y, M = +mo, D = +d;
        const dt = new Date(Y, M - 1, D);

        // ë‹¬ë ¥ ìœ íš¨ì„± ì²´í¬(2/30 ê°™ì€ ì¼€ì´ìŠ¤ ë°°ì œ)
        if (dt.getFullYear() !== Y || (dt.getMonth()+1) !== M || dt.getDate() !== D) return null;

        // Postgres date í˜•ì‹ìœ¼ë¡œ ë°˜í™˜
        return `${y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}`;
    }

    // ìƒì„¸íŒ¨ë„ ì €ì¥í•¨ìˆ˜
    async function saveListingDetails(listingId) {
        const getVal = (id) => {
            const el = document.getElementById(id);
            return el ? el.value : null;
        };
        const original = allListings[String(listingId)] || {};
        const parseNumberOrNull = (val, fallback) => {
            const n = parseFloat(val);
            return isNaN(n) ? fallback : n;
        };

        const isInvalidNumber = (val) => val === '' || val === '-' || val === null || val === undefined;

        const updateData = {
            title: getVal('input-title') || original.title || '-',
            features: getVal('textarea-features') || original.features || '-',
            detail_address: getVal('detail-address-input') || original.detail_address || '-',
            deal_type: getVal('dealTypeSelect') || original.deal_type || '-',

            deposit_price: isInvalidNumber(getVal('deposit_price')) ? null : parseFloat(getVal('deposit_price')),
            monthly_rent: isInvalidNumber(getVal('monthly_rent')) ? null : parseFloat(getVal('monthly_rent')),
            premium_price: isInvalidNumber(getVal('premium_price')) ? null : parseFloat(getVal('premium_price')),
            sale_price: isInvalidNumber(getVal('sale_price')) ? null : parseFloat(getVal('sale_price')),
            total_deposit: isInvalidNumber(getVal('total_deposit')) ? null : parseFloat(getVal('total_deposit')),
            total_rent: isInvalidNumber(getVal('total_rent')) ? null : parseFloat(getVal('total_rent')),

            supply_area_py: isInvalidNumber(getVal('supply-area-py')) ? null : parseFloat(getVal('supply-area-py')),
            area_py: isInvalidNumber(getVal('area-py')) ? null : parseFloat(getVal('area-py')),
            supply_area_m2: isInvalidNumber(getVal('supply-area-m2')) ? null : parseFloat(getVal('supply-area-m2')),
            area_m2: isInvalidNumber(getVal('area-m2')) ? null : parseFloat(getVal('area-m2')),

            floor: isInvalidNumber(getVal('floor')) ? null : parseNumberOrNull(getVal('floor'), original.floor ?? null),
            total_floors: isInvalidNumber(getVal('total-floors')) ? null : parseNumberOrNull(getVal('total-floors'), original.total_floors ?? null),
            parking: isInvalidNumber(getVal('parking')) ? null : parseNumberOrNull(getVal('parking'), original.parking ?? null),

            unit_info: getVal('unit_info'),
            agent_name: getVal('agent_name'),
            listing_title: getVal('listing_title'),
            restroom: getVal('restroom'),
            direction: getVal('direction'),
            approved_date: parseDateOrNull(getVal('approved_date')),
            store_type: getVal('store_type'),
            store_type_detail: getVal('store_type_detail'),
            ad_type: getVal('ad_type'),
            ad_status: getVal('ad_status'),
            customer_data: getVal('customer_data'),
            private_note: getVal('private_note'),
            entrance: getVal('entrance'),
            building_usage: getVal('building_usage'),
            province: getVal('province'),
            city: getVal('city'),
            district: getVal('district'),
            carrier: getVal('carrier'),
            buildingownername: getVal('buildingownername'),
            ownerphonenumber: getVal('ownerphonenumber'),
            ownergender: getVal('ownergender'),
            store_category: getVal('store_category') || original.store_category || '-',
        };

        // 1. baikukdbtest ì—…ë°ì´íŠ¸
        const { data, error } = await client
            .from('baikukdbtest')
            .update(updateData)
            .eq('listing_id', String(listingId))
            .select();

        // 2. ë¨¼ì € ì‹¤íŒ¨ ì—¬ë¶€ í™•ì¸
        if (error) {
            console.error('âŒ ì €ì¥ ì‹¤íŒ¨:', error);
            alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            return;  // ì—¬ê¸°ì„œ ì¤‘ë‹¨
        }

        // === building_info ì €ì¥ ë¡œì§ ===
        let addrCompareFromDb = null;
        let fullAddressFromParts = '';

        try {
        // 1) addr_compare í™•ë³´
        if (data && data.length > 0) {
            addrCompareFromDb = data[0].addr_compare ?? null;
        }
        if (!addrCompareFromDb) {
            const { data: row, error: fetchErr } = await client
                .from('baikukdbtest')
                .select('addr_compare, province, city, district, detail_address')
                .eq('listing_id', String(listingId))
                .maybeSingle();

            if (fetchErr) {
                console.warn('âš ï¸ addr_compare ì¬ì¡°íšŒ ì˜¤ë¥˜:', fetchErr);
            } else if (row) {
                addrCompareFromDb = row.addr_compare ?? null;
                fullAddressFromParts = `${row.province ?? ''} ${row.city ?? ''} ${row.district ?? ''} ${row.detail_address ?? ''}`.trim();
                if (!addrCompareFromDb) {
                    addrCompareFromDb = fullAddressFromParts.replace(/\s+/g, '');
                }
            }
        }

        console.log('ğŸ  full_address(ì¡°í•©):', fullAddressFromParts);
        console.log('ğŸ“Œ addr_compare(DB ê¸°ë°˜):', addrCompareFromDb);

        if (!addrCompareFromDb) {
            console.warn('âš ï¸ addr_compareê°€ ì—†ì–´ building_info ì €ì¥ì„ ê±´ë„ˆëœ€');
        } else {
            // 2) ì…ë ¥ê°’ ì½ê¸° (ê±´ë¬¼ëª…/ê±´ë¬¼ì •ë³´ ë©”ëª¨)
            const newBuildingName = (getVal('building_name') || '').trim();
            const noteEl = document.getElementById('textarea-building-note-edit');  // â† ìš”êµ¬ì‚¬í•­ëŒ€ë¡œ editê°’ ì‚¬ìš©
            const newBuildingNote = noteEl ? noteEl.value : null; // nullì´ë©´ ìŠ¤í‚µ, ""ì´ë©´ ë¹„ìš°ê¸°

            // ì¿¼ë¦¬ í‚¤ ì •ê·œí™”
            const key = (addrCompareFromDb || '').replace(/\s+/g, '').trim();

            // ì €ì¥ í•„ë“œ êµ¬ì„± (ë¹ˆ ë¬¸ìì—´ ""ë„ ì €ì¥ í—ˆìš©)
            const payload = {};
            if (newBuildingName) payload.building_name = newBuildingName;
            if (newBuildingNote !== null && newBuildingNote !== undefined) {
                payload.building_note = newBuildingNote;
            }

            if (!key || Object.keys(payload).length === 0) {
                console.log('â„¹ï¸ building_info ì €ì¥ ìŠ¤í‚µ(í‚¤ ë˜ëŠ” ê°’ ì—†ìŒ)');
            } else {
                // 3) ì¡´ì¬ ì—¬ë¶€ í™•ì¸
                const { data: existed, error: existErr } = await client
                    .from('building_info')
                    .select('addr_compare')
                    .eq('addr_compare', key)   // keyëŠ” ê³µë°±ì œê±°/trimëœ ê°’
                    .maybeSingle();

                if (existErr) {
                    console.error('âŒ building_info ì¡´ì¬ ì—¬ë¶€ ì¡°íšŒ ì‹¤íŒ¨:', existErr);
                } else if (existed) {
                // 4) UPDATE + ì˜í–¥í–‰ í™•ì¸
                const { data: updRows, error: updErr } = await client
                    .from('building_info')
                    .update(payload)
                    .eq('addr_compare', key)
                    .select('addr_compare');

                if (updErr) console.error('âŒ building_info ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', updErr);
                else console.log('âœ… building_info ì—…ë°ì´íŠ¸ ì™„ë£Œ(ê±´ìˆ˜):', updRows?.length ?? 0, payload);
                } else {
                    // 5) INSERT: addr_compareëŠ” ë„£ì§€ ì•ŠìŒ (DBê°€ ìƒì„± ì»¬ëŸ¼ìœ¼ë¡œ ìë™ê³„ì‚°)
                    const fullAddressForInsert =
                    fullAddressFromParts && fullAddressFromParts.length > 0
                        ? fullAddressFromParts
                        : `${updateData.province ?? ''} ${updateData.city ?? ''} ${updateData.district ?? ''} ${updateData.detail_address ?? ''}`.trim();

                    const insertPayload = {
                    full_address: fullAddressForInsert
                    };
                    // building_nameì€ ë¹ˆë¬¸ìì—´ì´ë©´ ì œì™¸
                    if (newBuildingName) insertPayload.building_name = newBuildingName;
                    // building_noteëŠ” ""(ë¹„ìš°ê¸°)ë„ í—ˆìš© â†’ null/undefinedë§Œ ì œì™¸
                    if (newBuildingNote !== null && newBuildingNote !== undefined) {
                    insertPayload.building_note = newBuildingNote;
                    }

                    const { data: insRows, error: insErr } = await client
                    .from('building_info')
                    .insert([insertPayload]) // â† addr_compare ì•ˆ ë„£ìŒ!
                    .select('addr_compare, full_address');

                    if (insErr) console.error('âŒ building_info ì‚½ì… ì‹¤íŒ¨:', insErr);
                    else console.log('âœ… building_info ì‚½ì… ì™„ë£Œ:', insRows);
                }
            }
        }
        } catch (e) {
            console.error('âŒ building_info ì €ì¥ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸:', e);
        }

        // 4. ì„±ê³µ í›„ ì²˜ë¦¬
        console.log('âœ… ì €ì¥ ì„±ê³µ:', data);
        // âœ… ìµœì‹  building_name/Noteë¥¼ Supabaseì—ì„œ ì§ì ‘ ì¡°íšŒí•˜ì—¬ ìºì‹œ ë°˜ì˜
        if (data && data.length > 0) {
        allListings[String(listingId)] = data[0];  // ìºì‹œ ê°±ì‹ 

        const addrCompare = (addrCompareFromDb || '').replace(/\s+/g,'').trim(); // â† ì •ê·œí™”
        if (addrCompare) {
            const { data: buildingInfoRows, error: fetchError } = await client
            .from('building_info')
            .select('building_name, building_note')
            .eq('addr_compare', addrCompare)
            .maybeSingle();

            if (!fetchError) {
            allListings[String(listingId)].building_name = buildingInfoRows?.building_name || '-';
            allListings[String(listingId)].building_note  = buildingInfoRows?.building_note  ?? '-';
            console.log('ğŸ¢ building_name ìµœì‹  ê°’ ë°˜ì˜ë¨:', allListings[String(listingId)].building_name);
            console.log('ğŸ—’ï¸ building_note ìµœì‹  ê°’ ë°˜ì˜ë¨:', allListings[String(listingId)].building_note);
            }
        }
        }


        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        showDetailPanel(listingId);

        // ì €ì¥ì´ ëë‚œ ë’¤ í´ëŸ¬ìŠ¤í„° ë‚´ ì •ë³´ ìµœì‹ í™”
        const clusterListingIds = window.currentClusterListings || [];

        if (clusterListingIds.length > 0) {
            console.log("ğŸ” í´ëŸ¬ìŠ¤í„° ë‚´ ë§¤ë¬¼ ì¬ë¡œë“œ:", clusterListingIds);

            const { data: updatedListings, error: clusterError } = await client
                .from('baikukdbtest')
                .select('*')
                .in('listing_id', clusterListingIds.map(String));

            if (clusterError) {
                console.error("âŒ í´ëŸ¬ìŠ¤í„° ì¬ì¡°íšŒ ì‹¤íŒ¨:", clusterError);
            } else {
                // ê¸°ì¡´ allListings ë®ì–´ì“°ê¸°
                updatedListings.forEach(listing => {
                    allListings[String(listing.listing_id)] = listing;
                });

                console.log(`âœ… í´ëŸ¬ìŠ¤í„° ${updatedListings.length}ê°œ ë§¤ë¬¼ ìµœì‹  ìƒíƒœë¡œ ê°±ì‹ ë¨`);
            }
        }
    }

    // ì—…ë¬´ì¼ì§€ ì €ì¥ í•¨ìˆ˜
    async function saveWorkLog() {
        const textarea = document.getElementById('textarea-worklog');
        const contents = textarea?.value.trim();
        const listingId = window.currentDetailListingId;

        // ğŸ”‘ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´
        const { data: userData, error: userError } = await client.auth.getUser();
        const userId = userData?.user?.id;

        if (!contents) {
            showToast("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        if (!userId || !listingId) {
            console.error("âŒ ì €ì¥ ì‹¤íŒ¨ - userId ë˜ëŠ” listing ì •ë³´ ì—†ìŒ");
            return;
        }

        // âœ… ì§ì› ì´ë¦„ ì¡°íšŒ
        const { data: profile, error: profileError } = await client
            .from('staff_profiles')
            .select('name')
            .eq('user_id', userId)
            .single();

        if (profileError || !profile) {
            console.error("âŒ ì§ì› ì´ë¦„ ì¡°íšŒ ì‹¤íŒ¨:", profileError);
            showToast("ì§ì› ì´ë¦„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", true);
            return;
        }

        const agentName = profile.name;
        const now = new Date().toISOString();

        // âœ… ì—…ë¬´ì¼ì§€ ì €ì¥
        const { data, error } = await client
            .from('work_log')
            .insert([
                {
                    listing_id: listingId,
                    agent_name: agentName,  // âœ” ì´ë¦„ ì €ì¥
                    contents,
                    Registration_date: now,
                    type: "ì…ë ¥"
                }
            ]);

        if (error) {
            console.error("âŒ ì—…ë¬´ì¼ì§€ ì €ì¥ ì‹¤íŒ¨:", error);
            showToast("ì €ì¥ ì‹¤íŒ¨", true);
        } else {
            textarea.value = '';
            showToast("ì—…ë¬´ì¼ì§€ ì €ì¥ ì™„ë£Œ!");
            await fetchWorkLogs(listingId);   // ìƒˆë¡œ ë¶ˆëŸ¬ì™€ ë‹¤ì‹œ ë Œë”
        }
    }

    // ì „ì—­ íƒ€ì´ë¨¸(ì—°ì† í˜¸ì¶œ ì‹œ ê²¹ì¹¨ ë°©ì§€)
    let _toastTimer = null;

    function showToast(message = 'ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', duration = 3000) {
        // ìš”ì†Œ í™•ë³´(ì—†ìœ¼ë©´ ìƒì„±)
        let toast = document.getElementById('toast');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'toast';
            document.body.appendChild(toast);
        }

        // ë‚´ìš©/ìŠ¤íƒ€ì¼ ì ìš©
        toast.textContent = message;
        toast.style.backgroundColor = '#F2C130';
        toast.style.color = 'black';
        toast.style.fontWeight = 'bold';

        // ğŸ” overlay(z: 99999)ë³´ë‹¤ ìœ„ì— ë‚˜ì˜¤ë„ë¡ z-Index í¬ê²Œ!
        toast.className = 'fixed top-5 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded shadow-lg z-[100000]';

        // ë³´ì´ê¸°
        toast.classList.remove('hidden');

        // ê¸°ì¡´ íƒ€ì´ë¨¸ í´ë¦¬ì–´ í›„ ì¬ì„¤ì •
        if (_toastTimer) clearTimeout(_toastTimer);
        _toastTimer = setTimeout(() => {
            toast.classList.add('hidden');
        }, duration);
    }

    // ê°’ì´ ì—†ìœ¼ë©´ ê³µë°±ìœ¼ë¡œ ì¶œë ¥í•˜ëŠ” í•¨ìˆ˜
    function safeDisplay(value) {
        return !value || value === '-' ? '' : value;
    }

    // ì´ë¯¸ì§€ ì„ ë¡œë“œ ì „ëµ
    // ìƒì„¸ 2ì¥ ì„ ë¡œë“œ(ì„œëª… URL ìƒì„± â†’ Image.decode)
    // timeout ì•ˆì— ëë‚˜ë©´ "ë™ì‹œ ë Œë”", ëª» ëë‚˜ë©´ ë°”ë¡œ ë Œë”(ë‚˜ì¤‘ ë¡œë”©)
    async function eagerDetailImages(listingId, { w = 480, q = 48, timeout = 160 } = {}) {
        // ê³µê°œ ëŒ€í‘œ 2ì¥ë§Œ
        const { data: rows } = await client
            .from('listing_images')
            .select('path, caption, is_primary, order_index')
            .eq('listing_id', String(listingId))
            .eq('is_private', false)
            .order('is_primary', { ascending: false })
            .order('order_index', { ascending: true })
            .limit(2);

        if (!rows?.length) return { urls: [], decoded: false };

        const urls = await Promise.all(rows.map(r => getTransformedUrl(r.path, w, 3600, q)));

        // ë””ì½”ë“œ ì‹œë„(ì§§ê²Œ). decode ì§€ì› ì•ˆ ë˜ë©´ onload ëŒ€ì²´
        const loaders = urls.map(u => {
            const img = new Image();
            img.decoding = 'async';
            img.loading = 'eager';
            img.src = u;
            return (img.decode ? img.decode() : new Promise(res => { img.onload = res; img.onerror = res; }));
        });

        const all = Promise.allSettled(loaders).then(() => true);
        const timer = new Promise(res => setTimeout(() => res(false), timeout));
        const decoded = await Promise.race([all, timer]); // true=ì œë•Œ ì¤€ë¹„, false=íƒ€ì„ì•„ì›ƒ

        return { urls, decoded };
    }

    // ìƒì„¸íŒ¨ë„
    async function showDetailPanel(listingId) {
        closeSidePanel();

        if (isEditMode && window.currentDetailListingId !== listingId) {
            isEditMode = false;
            detailScrollTop = 0;
        }

        let listing;
        try {
            // âœ… ìºì‹œì— ìˆê±´ ì—†ê±´ DBì—ì„œ í’€ ë ˆì½”ë“œ ê°•ì œ ì¬ì¡°íšŒ
            //    (ë‹¨, ì‹ ê·œ ë”ë¯¸ëŠ” DBì— ì—†ì„ ìˆ˜ ìˆìœ¼ë‹ˆ allowMissing=true)
            listing = await ensureListingLoaded(listingId, { force: true, allowMissing: true });
        } catch (e) {
            console.error(e);
            showToast('ë§¤ë¬¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            return;
        }

        window.currentDetailListingId = listingId;
        renderMatchedListings();

        if (!listing) {
            showToast('ë§¤ë¬¼ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const agentDisplayName = await resolveAgentDisplayName(listing.agent_name);
        const statusRaw = listing.transaction_status || '-';
        const status = statusRaw.trim().split(' ')[0];
        let statusStyle = 'background-color: #e5e7eb; color: #374151;';
        if (status === 'ì§„í–‰ì¤‘') statusStyle = 'background-color: #d9fae6; color: #00b74a;';
        else if (status === 'ê³„ì•½ì™„ë£Œ') statusStyle = 'background-color: rgba(255,237,237); color: rgba(247,63,87); font-weight: 900;';

        // ğŸ‘‡ ì—¬ê¸°ì„œ ë¨¼ì € 2ì¥ ì„ ë¡œë“œ ì‹œë„
        let lead = { urls: [], decoded: false };
        try {
            lead = await eagerDetailImages(listingId, { w: 480, q: 48, timeout: 160 });
        } catch {}
        
        const detailHeader = `
            <div class="sticky top-0 z-10 bg-white shadow-md p-2 rounded transition cursor-pointer whitespace-normal">
                <div class="flex justify-between items-center">
                    <div class="flex items-start gap-2">
                        <!-- ë§¤ë¬¼ë²ˆí˜¸ ë°•ìŠ¤ -->
                        <div 
                            class="w-[61px] h-[26px] flex justify-center items-center text-[rgb(0,0,0)] px-1 py-0 rounded text-base font-bold"
                            style="background-color: ${
                                (listing.is_public || '').toString().trim().includes('ë¹„ê³µê°œ') 
                                    ? '#d1d5db' 
                                    : '#F2C130'
                            };">
                            ${listing.listing_id}
                        </div>

                        <!-- ìƒíƒœ ë°•ìŠ¤ -->
                        <div 
                            class="h-[26px] px-2 flex items-center justify-center rounded text-sm font-semibold"
                            style="${statusStyle}">
                            ${status}
                        </div>

                        <!-- ì œëª© -->
                        <div class="text-base font-bold text-gray-900 w-[20rem]">
                            ${(listing.listing_title || '-')}
                        </div>
                    </div>
                </div>
                <div class="flex flex-row flex-wrap items-start gap-6 mt-2">
                    <div class="text-left font-semibold text-[rgb(80,152,233)] text-base">
                        ${listing.deal_type}
                        ${
                            listing.deal_type?.includes("ì›”ì„¸")
                                ? ` ${formatKoreanMoney(listing.deposit_price)} / ${formatKoreanMoney(listing.monthly_rent)}`
                                : listing.deal_type?.includes("ë§¤ë§¤")
                                ? ` ${formatKoreanMoney(listing.sale_price)}`
                                : ''
                        }
                    </div>
                    <div class="text-right font-semibold text-[rgb(248,63,87)] text-base whitespace-nowrap">
                        ${
                            listing.deal_type?.includes("ì›”ì„¸")
                                ? (() => {
                                    const price = listing.premium_price;
                                    if (parseFloat(price) === 0) return 'ë¬´ê¶Œë¦¬';
                                    if (!price || price === '-' || isNaN(price)) return '';
                                    if (parseFloat(price) > 0) return `ê¶Œ ${formatKoreanMoney(price)}`;
                                    return '';
                                })()
                                : listing.deal_type?.includes("ë§¤ë§¤")
                                ? `${listing.roi ? (parseFloat(listing.roi) * 100).toFixed(1) : '-'}%`
                                : ''
                        }
                    </div>
                    <div class="font-semibold text-base">
                        &nbsp;
                        <strong class="font-semibold">${listing.floor < 0 ? `B${Math.abs(listing.floor)}ì¸µ` : `${listing.floor}ì¸µ`}</strong>
                        <strong class="font-semibold">${Number(listing.area_py).toFixed(0)}</strong>í‰
                        <strong class="font-semibold">${(Number(listing.monthly_rent)/Number(listing.area_py)).toFixed(1)}</strong>ë§Œ
                    </div>
                    <div class="ml-auto">
                        <button
                            onclick="toggleEditMode()"
                            class="text-green-800 bg-green-100 border border-green-300 text-sm px-3 py-1 rounded-full hover:bg-green-200 transition font-bold"
                        >
                            ${isEditMode ? 'ì €ì¥' : 'ìˆ˜ì •'}
                        </button>
                    </div>
                </div>
            </div>
        `;

        // editSection ìƒì„±í•  ë•Œ ì´ë¯¸ì§€ srcë¥¼ ì„ ë¡œë“œ ê²°ê³¼ë¡œ ë°•ì•„ë‘ë©´ ì¦‰ì‹œ ëœ¸
        const img0Src = lead.urls[0] || '';
        const img1Src = lead.urls[1] || '';

        const editSection = isEditMode ? `<div id="image-viewer" class="bg-white"> <div class="flex gap-2"> <div class="image-wm relative overflow-hidden w-1/2 h-[11rem] rounded bg-gray-100"> <img id="image-viewer-main-0" class="w-full h-full object-cover cursor-pointer" ${img0Src ? `src="${img0Src}"` : ''} loading="eager" decoding="async" fetchpriority="high" />
                </div><div class="image-wm relative overflow-hidden w-1/2 h-[11rem] rounded bg-gray-100"> <img id="image-viewer-main-1" class="w-full h-full object-cover cursor-pointer ${img1Src ? '' : 'hidden'}" ${img1Src ? `src="${img1Src}"` : ''} loading="lazy" decoding="async" fetchpriority="low" />
                </div></div></div> <div class="mt-2 flex flex-row gap-2 items-center">
                    <select id="province" class="border border-gray-300 rounded px-3 py-1 text-sm w-[6rem]"> </select>
                    <select id="city" class="border border-gray-300 rounded px-3 py-1 text-sm w-[8rem]"> </select>
                    <select id="district" class="border border-gray-300 rounded px-3 py-1 text-sm w-[6rem]"> 
                    </select> <input
                    type="text" 
                    id="detail-address-input" 
                    value="${!listing.detail_address || listing.detail_address === '-' || listing.detail_address === 'null' || listing.detail_address === 'undefined' ? '' : listing.detail_address}" 
                    class="border-2 border-neutral-400 rounded px-3 py-1 text-sm w-[5rem]" ${isEditMode ? '' : 'readonly'} />
                <button 
                    id="addr-search-btn"
                    class="bg-blue-500 text-white text-sm px-4 py-1 rounded hover:bg-blue-600"
                    ${isEditMode ? '' : 'disabled'}> ê²€ìƒ‰
                </button>
            </div> <div class="flex flex-row gap-3 items-center mt-2">
                <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ê±´ë¬¼ëª…</span>
                    <textarea
                        id="building_name"
                        placeholder="ì˜ˆ: ì‚¼ìœµíƒ€ì›Œ"
                        class="border border-gray-300 rounded px-3 py-1 text-sm w-32 overflow-hidden whitespace-normal break-words"
                        style="box-sizing:border-box; resize:none; overflow:hidden;"
                    >${safeDisplay(listing.building_name)}</textarea>
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">í˜¸ìˆ˜</span>
                    <textarea
                        id="unit_info"
                        placeholder="ì˜ˆ: 109í˜¸"
                        class="border border-gray-300 rounded px-3 py-1 text-sm w-32 overflow-hidden whitespace-normal break-words"
                        style="box-sizing:border-box; resize:none; overflow:hidden;"
                    >${safeDisplay(listing.unit_info)}</textarea>
                </div>                
                <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">íƒ€ì…</span>
                    <select id="store_category" class="border border-gray-300 rounded px-3 py-1 text-sm w-[6.5rem]">
                        <option ${listing.store_category  === '-' ? 'selected' : ''}>-</option>
                        <option ${listing.store_category  === 'í”„ë¼ì' ? 'selected' : ''}>í”„ë¼ì</option>
                        <option ${listing.store_category  === 'ì£¼íƒìƒê°€' ? 'selected' : ''}>ì£¼íƒìƒê°€</option>
                    </select>
                </div>
            </div> <div id="map-preview" style="width:100%;height:9rem;margin-top:1rem;">
            </div> <div class="border-b border-gray-200 flex flex-row gap-8 items-center mt-2 h-[2.35rem]">
                <div class="flex items-center gap-8 pb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ê³µê°œ</span>
                        <input
                            type="checkbox"
                            id="is_public"
                            class="border border-gray-300 w-5 h-5"
                            ${listing.is_public === 'ê³µê°œ' ? 'checked' : ''}
                        />
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ë§¤ë¬¼ëª…</span>
                        <input
                            type="text"
                            id="listing_title"
                            placeholder="ì˜ˆ: ë°±ì–µë¶€ë™ì‚° ì•¼ë‹¹ì "
                            class="border border-gray-300 rounded px-3 py-1 text-sm w-[22.3rem]"
                            value="${safeDisplay(listing.listing_title)}"
                        />
                    </div>
                </div>
            </div> <div class="flex flex-row gap-6 items-center mt-2 pb-2 border-b border-gray-200 h-[2.4rem]">
                <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ë‹´ë‹¹ì</span>
                    <select
                        id="agent_name"
                        class="border border-gray-300 rounded px-3 py-1 text-sm w-[7.5rem]"
                    >
                        <option value="">ë¡œë”©ì¤‘...</option>
                    </select>
                </div>
                <div class="flex items-center gap-1">
                    <div class="flex flex-row gap-2 items-center">
                        <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ëŒ€ë¶„ë¥˜</span>
                        <select class="border border-gray-300 rounded px-3 py-1 text-sm w-[5.2rem]">
                            <option ${listing.category === 'ìƒê°€' ? 'selected' : ''}>ìƒê°€</option>
                            <option ${listing.category === 'ê³µì¥Â·ì°½ê³ ' ? 'selected' : ''}>ê³µì¥Â·ì°½ê³ </option>
                            <option ${listing.category === 'í† ì§€' ? 'selected' : ''}>í† ì§€</option>
                            <option ${listing.category === 'ì£¼íƒ' ? 'selected' : ''}>ì£¼íƒ</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="flex flex-row gap-2 items-center">
                        <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ê±°ë˜ìœ í˜•</span>
                        <select id="dealTypeSelect" class="border border-gray-300 rounded px-3 py-1 text-sm w-[5.3rem]" onchange="renderDealFields()">
                            <option value="ì›”ì„¸" ${listing.deal_type === 'ì›”ì„¸' ? 'selected' : ''}>ì›”ì„¸</option>
                            <option value="ë§¤ë§¤" ${listing.deal_type === 'ë§¤ë§¤' ? 'selected' : ''}>ë§¤ë§¤</option>
                        </select>
                    </div>
                </div>
            </div> <div id="dealFields" class="border-b border-gray-200 flex flex-row gap-2 items-center mt-2">
            </div> <div class="flex flex-row gap-8 items-center mt-2 pb-2 border-b border-gray-200 h-[2.35rem]">
                <div class="flex items-center gap-8"> <div class="flex flex-row items-center gap-1">
                        <span class="ml-1 text-sm text-gray-600 font-semibold" style="color: #5098e9;">ê³„ì•½/ì „ìš©</span><input
                                type="text"
                                id="supply-area-py"
                                class="border border-gray-300 rounded px-3 py-1 text-sm w-[4.5rem] text-right"
                                value="${safeDisplay(listing.supply_area_py)}"
                            />
                            <span class="text-sm text-gray-600">/</span>
                            <input
                                type="text"
                                id="area-py"
                                class="border border-gray-300 rounded px-3 py-1 text-sm w-[4.5rem]"
                                value="${safeDisplay(listing.area_py)}"
                            />
                            <span class="text-sm text-gray-600">í‰</span>
                    </div><div class="ml-10 flex flex-row items-center gap-1">
                        <div class="flex items-center gap-1">
                            <input
                            type="text"
                            id="supply-area-m2"
                            class="border border-gray-300 rounded px-3 py-1 text-sm w-[4.5rem] text-right"
                            value="${safeDisplay(listing.supply_area_m2)}"
                        />
                        <span class="text-sm text-gray-600">/</span>
                        <input
                            type="text"
                            id="area-m2"
                            class="border border-gray-300 rounded px-3 py-1 text-sm w-[4.5rem]"
                            value="${safeDisplay(listing.area_m2)}"
                        />
                        <span class="text-sm text-gray-600">ã¡</span>
                        </div>
                    </div>                    
                </div>
            </div> <div class="flex flex-row gap-5 items-center mt-2 pb-2 border-b border-gray-200">
                <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">í•´ë‹¹ì¸µ</span>
                    <input
                        type="text"
                        id="floor"
                        class="border border-gray-300 rounded px-3 py-1 text-sm w-[3rem]"
                        value="${safeDisplay(listing.floor)}"
                    />
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ì´ì¸µ</span>
                    <input
                        type="text"
                        id="total-floors"
                        class="border border-gray-300 rounded px-3 py-1 text-sm w-[3rem]"
                        value="${safeDisplay(listing.total_floors)}"
                    />
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ì¶”ì²œì—…ì¢…</span>
                    <textarea
                        id="store_type_detail"
                        placeholder="ì˜ˆ: ì¹´í˜, ë¯¸ìš©, í•™ì› ë“±"
                        class="border border-gray-300 rounded px-3 py-1 text-sm w-[15rem] overflow-hidden whitespace-normal break-words"
                        style="box-sizing:border-box; resize:none; overflow:hidden;"
                    >${safeDisplay(listing.store_type_detail)}</textarea>
                </div>
            </div> <div class="flex flex-row gap-4 items-center mt-2 pb-2 border-b border-gray-200 min-h-[2.3rem]">
                <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ì£¼ìš©ë„</span>
                    <select id="building_usage" class="border border-gray-300 rounded px-3 py-1 text-sm w-[13rem]">
                        ${[
                            '-', 'ë‹¨ë…ì£¼íƒ', 'ê³µë™ì£¼íƒ', 'ì œ1ì¢… ê·¼ë¦°ìƒí™œì‹œì„¤', 'ì œ2ì¢… ê·¼ë¦°ìƒí™œì‹œì„¤',
                            'ë¬¸í™” ë° ì§‘íšŒì‹œì„¤', 'ì¢…êµì‹œì„¤', 'íŒë§¤ì‹œì„¤', 'ìš´ìˆ˜ì‹œì„¤', 'ì˜ë£Œì‹œì„¤',
                            'êµìœ¡ì—°êµ¬ì‹œì„¤', 'ë…¸ìœ ì', 'ìˆ˜ë ¨ì‹œì„¤', 'ìš´ë™ì‹œì„¤', 'ì—…ë¬´ì‹œì„¤', 'ìˆ™ë°•ì‹œì„¤',
                            'ìœ„ë½', 'ê³µì¥', 'ì°½ê³ ì‹œì„¤', 'ìœ„í—˜ë¬¼ ì €ì¥ ë° ì²˜ë¦¬ ì‹œì„¤', 'ìë™ì°¨ ê´€ë ¨ ì‹œì„¤',
                            'ë™ë¬¼ ë° ì‹ë¬¼ ê´€ë ¨ ì‹œì„¤', 'ìì›ìˆœí™˜ ê´€ë ¨ ì‹œì„¤', 'êµ°ì‚¬ ì‹œì„¤', 'ë°©ì†¡í†µì‹ ì‹œì„¤',
                            'ë°œì „ì‹œì„¤', 'ë¬˜ì§€ ê´€ë ¨ ì‹œì„¤', 'ê´€ê´‘ íœ´ê²Œì‹œì„¤', 'ì¥ë¡€ì‹œì„¤', 'ì•¼ì˜ì¥ ì‹œì„¤',
                            'ë¯¸ë“±ê¸°ê±´ë¬¼', 'ê·¸ ë°–ì— í† ì§€ì˜ ì •ì°©'
                        ].map(type => `
                            <option value="${type}" ${listing.building_usage === type ? 'selected' : ''}>${type}</option>
                        `).join('')}
                    </select>
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">í™”ì¥ì‹¤</span>
                    <textarea
                        id="restroom"
                        placeholder="ì˜ˆ: ë‚´ë¶€/ì™¸ë¶€/ì—†ìŒ"
                        class="border border-gray-300 rounded px-3 py-1 text-sm w-[11.4rem] overflow-hidden whitespace-normal break-words"
                        style="box-sizing:border-box; resize:none; overflow:hidden;"
                    >${safeDisplay(listing.restroom)}</textarea>
                </div>
            </div> <div class="flex flex-row gap-8 items-center mt-2 pb-2 border-b border-gray-200 h-[2.3rem]">
                <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ë°©í–¥</span>
                    <select id="direction" class="border border-gray-300 rounded px-3 py-1 text-sm w-[5rem]">
                        <option ${listing.direction === '-' ? 'selected' : ''}>-</option>
                        <option ${listing.direction === 'ë™' ? 'selected' : ''}>ë™</option>
                        <option ${listing.direction === 'ì„œ' ? 'selected' : ''}>ì„œ</option>
                        <option ${listing.direction === 'ë‚¨' ? 'selected' : ''}>ë‚¨</option>
                        <option ${listing.direction === 'ë¶' ? 'selected' : ''}>ë¶</option>
                        <option ${listing.direction === 'ë¶ë™' ? 'selected' : ''}>ë¶ë™</option>
                        <option ${listing.direction === 'ë‚¨ë™' ? 'selected' : ''}>ë‚¨ë™</option>
                        <option ${listing.direction === 'ë¶ì„œ' ? 'selected' : ''}>ë¶ì„œ</option>
                        <option ${listing.direction === 'ë‚¨ì„œ' ? 'selected' : ''}>ë‚¨ì„œ</option>
                    </select>
                </div>
                <div class="flex items-center gap-1">
                    <span class="ml-1 text-sm text-gray-600 font-semibold" style="color: #5098e9;">ì´ì£¼ì°¨</span>
                    <input
                        type="text"
                        id="parking"
                        class="border border-gray-300 rounded px-3 py-1 text-sm w-[3.5rem]"
                        value="${safeDisplay(listing.parking)}"
                    />
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ì‚¬ìš©ìŠ¹ì¸ì¼</span>
                    <input
                        type="text"
                        id="approved_date" 
                        placeholder="ì˜ˆ: 2025-07-27"
                        class="border border-gray-300 rounded px-3 py-1 text-sm w-[8.9rem]"
                        value="${safeDisplay(listing.approved_date)}"
                    />
                </div>
            </div> <div class="flex flex-row gap-8 items-center mt-2 mb-10">
                <div class="flex flex-col items-start gap-1">
                    <div class="flex items-center gap-8 pb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ë§¤ë¬¼íŠ¹ì§•</span>
                        </div>
                        <textarea
                            id="input-title"
                            placeholder="ì˜ˆ: ë¬´ê¶Œë¦¬. ì‹œì„¤ êµ¿. ì£¼ë°©ì‹œì„¤ ì™„ë¹„"
                            class="border border-gray-300 rounded px-3 py-1 text-sm w-[25.7rem] overflow-hidden whitespace-normal break-words"
                            style="box-sizing:border-box; resize:none; overflow:hidden;"
                        >${safeDisplay(listing.title)}</textarea>
                    </div>                                
                    <textarea
                        class="border border-gray-300 rounded px-3 py-1 text-sm w-full h-[7rem] resize-none"
                        id="textarea-features"
                        placeholder="'Enter'ë¡œ êµ¬ë¶„"
                    >${safeDisplay(listing.features)}</textarea>
                </div>
            </div> <div class="flex flex-row gap-8 items-center border-t border-red-400 pt-5">
                <div class="flex flex-col items-start gap-1">
                    <div class="flex items-center gap-4 pb-2">
                        <span class="text-sm text-red-500 font-semibold">ì¶œì…</span>
                        <input
                            type="text"
                            id="entrance"
                            placeholder="ì˜ˆ: 2258* / ì„ì°¨ì¸ì—ê²Œ í•˜ë£¨ ì „ ì—°ë½"
                            class="border border-red-400 rounded px-3 py-1 text-sm w-[28.5rem]"
                            value="${safeDisplay(listing.entrance)}"
                        />
                    </div> 
                    <div class="flex flex-row gap-3.5 pb-2">
                        <!-- ê´‘ê³  -->
                        <div class="flex flex-col items-start gap-1.5">                                        
                            <div class="flex items-start gap-2 pt-2">
                                <span class="text-sm text-gray-800 font-semibold">ê´‘ê³ </span>
                            </div>                                           
                            <div class="flex items-start gap-7">
                                <div class="flex items-start gap-2">
                                    <span class="text-sm text-red-500 font-semibold">í†µì‹ ì‚¬</span>
                                    <select id="carrier" class="pl-0 border border-red-400 rounded px-3 py-0 py-1 text-sm w-[7.8rem]">
                                        <option ${listing.carrier  === '-' ? 'selected' : ''}>-</option>
                                        <option ${listing.carrier  === 'SKT' ? 'selected' : ''}>SKT</option>
                                        <option ${listing.carrier  === 'KT' ? 'selected' : ''}>KT</option>
                                        <option ${listing.carrier  === 'LGU+' ? 'selected' : ''}>LGU+</option>
                                        <option ${listing.carrier  === 'SKT ì•Œëœ°í°' ? 'selected' : ''}>SKT ì•Œëœ°í°</option>
                                        <option ${listing.carrier  === 'KT ì•Œëœ°í°' ? 'selected' : ''}>KT ì•Œëœ°í°</option>
                                        <option ${listing.carrier  === 'LGU+ ì•Œëœ°í°' ? 'selected' : ''}>LGU+ ì•Œëœ°í°</option>
                                    </select>
                                </div>
                                <div class="flex items-start gap-2">
                                    <span class="text-sm text-red-500 font-semibold">ì„±ë³„</span>
                                    <select id="ownergender" class="pl-0 border border-red-400 rounded px-3 py-0 py-1 text-sm w-[4.7rem]">
                                        <option ${listing.ownergender  === '-' ? 'selected' : ''}>-</option>
                                        <option ${listing.ownergender  === 'ë‚¨ì' ? 'selected' : ''}>ë‚¨ì</option>
                                        <option ${listing.ownergender  === 'ì—¬ì' ? 'selected' : ''}>ì—¬ì</option>
                                    </select>
                                </div>
                                <div class="flex items-start gap-2">
                                    <span class="text-sm text-red-500 font-semibold">ìƒí’ˆ</span>
                                    <select id="ad_type" class="border border-red-400 rounded px-3 py-0 py-1 text-sm w-[7.6rem]">
                                        <option ${listing.ad_type === '-' ? 'selected' : ''}>-</option>
                                        <option ${listing.ad_type === 'ì‹ í™ë³´-ê°œì¸' ? 'selected' : ''}>ì‹ í™ë³´-ê°œì¸</option>
                                        <option ${listing.ad_type === 'ëª¨ë°”ì¼v2' ? 'selected' : ''}>ëª¨ë°”ì¼v2</option>
                                        <option ${listing.ad_type === 'ìœ„ì„ì¥' ? 'selected' : ''}>ìœ„ì„ì¥</option>
                                        <option ${listing.ad_type === 'êµ¬í™ë³´' ? 'selected' : ''}>êµ¬í™ë³´</option>
                                    </select>
                                </div>
                            </div>           
                            <div class="flex items-start gap-7">
                                <div class="flex items-start gap-2">
                                    <span class="text-sm text-red-500 font-semibold w-[2.6rem]">ì„±í•¨</span>
                                    <input
                                        type="text"
                                        id="buildingownername"
                                        placeholder=" ì˜ˆ: ê¹€ì² ìˆ˜"
                                        class="border border-red-400 rounded text-sm w-[7.8rem]"
                                        value="${safeDisplay(listing.buildingownername)}"
                                    />
                                </div>
                                <div class="flex items-start gap-2">
                                    <span class="text-sm text-red-500 font-semibold">ì „í™”ë²ˆí˜¸</span>
                                    <input
                                        type="text"
                                        id="ownerphonenumber"
                                        placeholder=" ì˜ˆ: 010-9989-1163"
                                        class="border border-red-400 rounded text-sm w-[14.5rem]"
                                        value="${safeDisplay(listing.ownerphonenumber)}"
                                    />
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="text-sm text-red-500 font-semibold w-[2.3rem]">í˜„í™©</span>
                                <textarea
                                    placeholder="íŒŒì£¼ë§¤ê²½, ì•¼ë‹¹í•œê²½, ì¼ì‚°ë±…í¬, íŒŒì£¼ë¸”ë¡œê·¸"
                                    id="ad_status"
                                    class="h-[3rem] border border-red-400 rounded px-3 py-1 text-sm w-[28.2rem] resize-none"
                                >${safeDisplay(listing.ad_status)}</textarea>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col items-start gap-1 pt-2">
                        <span class="text-sm text-gray-800 font-semibold pd-1">ë©”ëª¨</span>
                        <div class="flex flex-row gap-3.5 pb-2">
                            <div class="flex items-start gap-3">
                                <div class="flex flex-col justify-between h-[5rem] w-[3.7rem]">
                                    <span class="self-start text-left text-sm text-red-500 font-semibold">ê³ ê°ì •ë³´</span>
                                    <span class="self-start text-left text-sm text-red-500 font-semibold">ë‚´ìš©</span>
                                </div>
                                <textarea
                                    id="customer_data"                                 
                                    placeholder="ì†Œìœ (ë‚¨) ê¹€ìˆ˜ë¯¸ SKT 010-8858-8885"
                                    class="h-[5rem] border border-red-400 rounded px-3 py-1 text-sm w-[26.7rem] resize-none"
                                >${safeDisplay(listing.customer_data)}</textarea>
                            </div>
                        </div>
                        <textarea
                            id="private_note" 
                            class="border border-red-400 rounded px-3 py-1 text-sm w-[31.2rem] h-[10rem] resize-none"
                            placeholder="ì§ì›ì „ìš©ë©”ëª¨"
                        >${safeDisplay(listing.private_note)}</textarea>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 10px; align-items: flex-start;">
                <!-- ì¸ë„¤ì¼ + ì œëª© -->
                <div class="flex flex-col gap-2">
                    <div class="font-bold mb-1">ê±´ë¬¼ì •ë³´</div>
                    <div class="thumb-box w-[140px] h-[100px] rounded relative"><img
                            id="thumb-edit-${listing.listing_id}"
                            src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/baikuk-simbol.png"
                            alt="ì¸ë„¤ì¼"
                            class="thumb-img-contain rounded no-save"
                            draggable="false"
                            oncontextmenu="return false"
                        />
                    </div>
                </div>
                <!-- ê±´ë¬¼ì •ë³´ ë‚´ìš© -->
                <textarea
                    id="textarea-building-note-edit"
                    class="border border-green-700 rounded px-1 py-1 text-sm w-[21.8rem] h-[9rem] resize-none"
                    placeholder="ê±´ë¬¼ì „ì²´ ë‚´ìš©"
                >${safeDisplay(listing.building_note)}</textarea>
            </div>` : `<div id="image-viewer" class="bg-white"> <div class="flex gap-2"> <div class="image-wm relative overflow-hidden w-1/2 h-[11rem] rounded bg-gray-100"> <img id="image-viewer-main-0" class="w-full h-full object-cover cursor-pointer" ${img0Src ? `src="${img0Src}"` : ''} loading="eager" decoding="async" fetchpriority="high"/>
                </div><div class="image-wm relative overflow-hidden w-1/2 h-[11rem] rounded bg-gray-100"> <img id="image-viewer-main-1" class="w-full h-full object-cover cursor-pointer ${img1Src ? '' : 'hidden'}" ${img1Src ? `src="${img1Src}"` : ''} loading="lazy" decoding="async" fetchpriority="low" />
                </div></div></div><div class="mt-2 flex flex-row gap-2 items-center py-2 h-[2.2rem]"> 
                <span>${listing.province}</span> <span>${listing.city}</span> <span>${listing.district}</span><span>${listing.detail_address && listing.detail_address !== '-' ? listing.detail_address : ''}</span><div id="affiliation-badge" class="ml-auto text-sm text-gray-700">ì§€ì ì´ë¦„ í‘œì‹œ</div>
            </div>  <div class="flex flex-row gap-3 items-center mt-[0.3rem]">
                <!-- ê±´ë¬¼ëª… (ë³´ê¸°) -->
                <div class="flex items-center gap-1">
                <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ê±´ë¬¼ëª…</div>
                <div id="building_name_view"
                    class="rounded px-3 py-1 text-sm w-32 overflow-hidden whitespace-normal break-words two-line"
                    title="${safeDisplay(listing.building_name)}">
                    ${safeDisplay(listing.building_name)}
                </div>
                </div>

                <!-- í˜¸ìˆ˜ (ë³´ê¸°) -->
                <div class="flex items-center gap-1">
                <div class="text-sm text-gray-600 font-semibold" style="color:#5098e9;">í˜¸ìˆ˜</div>
                <div id="unit_info_view"
                    class="rounded px-3 py-1 text-sm w-32 overflow-hidden whitespace-normal break-words two-line"
                    title="${safeDisplay(listing.unit_info)}">
                    ${safeDisplay(listing.unit_info)}
                </div>
                </div>

                <div class="flex items-center gap-1">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">íƒ€ì…</div>
                    <div class="rounded px-3 py-1 text-sm w-[6.5rem]"> ${safeDisplay(listing.store_category)}</div>
                </div>
            </div><div id="map-preview" style="width:100%;height:9rem;margin-top:1rem;">
            </div> <div class="flex flex-row gap-6 items-center h-[3rem] border-b border-gray-200 "> <span
                    class="px-2 py-1 text-sm rounded font-semibold"
                    style="${listing.is_public === 'ê³µê°œ'
                                ? 'background-color: #d9fae6; color: #00b74a;'
                                : 'background-color: rgba(255,237,237); color: rgba(247,63,87); font-weight: 900;'}"
                >${listing.is_public === 'ê³µê°œ' ? 'ê³µê°œ' : 'ë¹„ê³µê°œ'}
                </span> <span class="ml-11 pl-7">${safeDisplay(listing.listing_title)}</span>
            </div> <div class="flex flex-row items-center h-[2.85rem] border-b border-gray-200 gap-11"> <div class="flex gap-8"><span class="font-semibold" style="color: #5098e9;"
                >ë‹´ë‹¹ì</span><span class="w-[4.5rem] truncate"> ${safeDisplay(agentDisplayName)}</span></div><div class="flex gap-5"><span class="font-semibold" style="color: #5098e9;"
                >ëŒ€ë¶„ë¥˜</span><span class="w-[2.45rem]"">${listing.category}</span></div><div class="flex gap-5"><span class="font-semibold" style="color: #5098e9;"
                >ê±°ë˜ìœ í˜•</span><span>${listing.deal_type}</span></div>
            </div> <div id="dealFieldsViewer" class="border-b border-gray-200 flex gap-12 h-[3rem]">
            </div> <div class="flex flex-row gap-8 items-center mt-2 pb-2 border-b border-gray-200">
                <div class="flex items-center gap-8"> <div class="flex flex-row items-center gap-1">
                        <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ê³„ì•½/ì „ìš©</div><div class="ml-1 rounded px-3 py-1 text-sm w-[4.5rem] text-right">${safeDisplay(listing.supply_area_py)}
                            </div>
                            <div class="text-sm text-gray-600">/</div>
                            <div class="rounded px-3 py-1 text-sm w-[4.5rem]">${formatNumber2(listing.area_py)}
                            </div>
                            <div class="text-sm text-gray-600">í‰</div>
                    </div><div class="ml-10 flex flex-row items-center gap-1">
                        <div class="flex items-center gap-1">
                            <div class="rounded px-3 py-1 text-sm w-[4.5rem] text-right"> ${formatNumber2(listing.supply_area_m2)}
                        </div>
                        <div class="text-sm text-gray-600">/</div>
                        <div class="rounded px-3 py-1 text-sm w-[4.5rem]">${formatNumber2(listing.area_m2)}
                        </div>
                        <div class="text-sm text-gray-600">ã¡</div>
                        </div>
                    </div>                    
                </div>
            </div> <div class="flex flex-row gap-5 items-center mt-2 pb-2 border-b border-gray-200">
                <div class="flex items-center gap-1">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">í•´ë‹¹ì¸µ</div>
                    <div class="rounded px-3 py-1 text-sm w-[3rem]">${safeDisplay(listing.floor)}
                    </div>
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ì´ì¸µ</div>
                    <div class="rounded px-3 py-1 text-sm w-[3rem]">${safeDisplay(listing.total_floors)}
                    </div>
                </div>
                <div class="flex items-center gap-1">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ì¶”ì²œì—…ì¢…</div>
                    <div id="store_type_detail_view"
                        class="rounded px-3 py-1 text-sm w-[15rem] two-line"
                        title="${safeDisplay(listing.store_type_detail)}">${safeDisplay(listing.store_type_detail)}
                    </div>
                </div>
            </div> <div class="flex flex-row gap-4 items-center mt-2 pb-2 border-b border-gray-200 min-h-[2.3rem]">
                <div class="flex items-center gap-1">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ì£¼ìš©ë„</div>
                    <div id="building_usage" class="rounded px-3 py-1 text-sm w-[13rem]">${listing.building_usage}</div>
                </div>
                <div class="flex items-center gap-1">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">í™”ì¥ì‹¤</div>
                    <div id="restroom_view"
                        class="rounded px-3 py-1 text-sm w-[11.4rem] two-line"
                        title="${safeDisplay(listing.restroom)}">${safeDisplay(listing.restroom)}
                    </div>
                </div>
            </div> <div class="flex flex-row gap-8 items-center mt-2 pb-2 border-b border-gray-200">
                <div class="flex items-center gap-1 h-[1.7rem]">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ë°©í–¥</div>
                    <div class="rounded px-3 py-1 text-sm w-[5rem]"> ${safeDisplay(listing.direction)}
                    </div>
                </div>
                <div class="flex items-center gap-1">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ì´ì£¼ì°¨</div>
                    <div class="rounded px-3 py-1 text-sm w-[3.5rem]"> ${safeDisplay(listing.parking)}
                    </div>
                </div>
                <div class="flex items-center gap-1">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ì‚¬ìš©ìŠ¹ì¸ì¼</div>
                    <div class="rounded px-3 py-1 text-sm w-[9rem]"> ${safeDisplay(listing.approved_date)}
                    </div>
                </div>
            </div> <div class="flex flex-row gap-8 items-center mt-2 mb-10">
                <div class="flex flex-col items-start gap-1">
                    <div class="flex items-center gap-8 pb-2 min-h-[2.4rem]">                        
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ë§¤ë¬¼íŠ¹ì§•</span>
                        </div>
                        <div id="title_view"
                            class="rounded px-3 py-1 text-sm w-[25.7rem] overflow-hidden whitespace-normal break-words two-line"
                            title="${safeDisplay(listing.title)}">
                            ${safeDisplay(listing.title)}
                        </div>
                    </div>
                    <div class="overflow-y-auto rounded px-3 py-1 text-sm w-full h-[7rem] resize-none"> ${safeDisplay(listing.features)}</div>
                </div>

            </div> <div class="flex flex-row gap-8 items-center border-t border-gray-400 pt-5 bg-green-100 bg-opacity-15">
                <div class="flex flex-col items-start gap-1 text-sm text-gray-800">
                    <div class="flex items-center gap-4 pb-2">
                        <div class="text-green-700 font-semibold">ì¶œì…</div>
                        <div 
                            class="border border-green-700 rounded px-3 py-1 text-green-700 w-[28.5rem] overflow-hidden text-ellipsis whitespace-nowrap h-[1.9rem]"
                            title="${safeDisplay(listing.entrance)}"
                        >
                        ${safeDisplay(listing.entrance)}
                        </div>
                    </div>
                    <div class="flex flex-row gap-3.5 pb-2">
                        <!-- ê´‘ê³  -->
                        <div class="flex flex-col items-start gap-1.5">                                        
                            <div class="flex items-start gap-2 pt-2"><div class="text-red-600 font-semibold">ê´‘ê³ </div>
                            </div>                                           
                            <div class="flex items-start gap-7">
                                <div class="flex items-start gap-2"> <div class="text-green-700 font-semibold">í†µì‹ ì‚¬</div>
                                    <div class="pl-0 px-3 py-0 border border-green-700 rounded text-green-700 w-[7.8rem]"> ${safeDisplay(listing.carrier)}
                                    </div>
                                </div>
                                <div class="flex items-start gap-2"> <div class="text-green-700 font-semibold">ì„±ë³„</div>
                                    <div class="pl-0 px-3 py-0 border border-green-700 rounded text-green-700 w-[4.7rem]"> ${safeDisplay(listing.ownergender)}
                                    </div>
                                </div>
                                <div class="flex items-start gap-2">
                                    <div class="text-green-700 font-semibold">ìƒí’ˆ</div>
                                    <div class="px-3 py-0 border border-green-700 rounded text-green-700 w-[7.6rem]"> ${safeDisplay(listing.ad_type)}
                                    </div>
                                </div>
                            </div>           
                            <div class="flex items-start gap-7">
                                <div class="flex items-start gap-2"> <div class="text-green-700 font-semibold w-[2.6rem]">ì„±í•¨</div>
                                    <div class="border border-green-700 rounded text-green-700 text-sm w-[7.8rem]"> ${safeDisplay(listing.buildingownername)}
                                    </div>
                                </div>
                                <div class="flex items-start gap-2"> <div class="text-green-700 font-semibold">ì „í™”ë²ˆí˜¸</div>
                                    <div class="border border-green-700 rounded text-green-700 text-sm w-[14.5rem]"> ${safeDisplay(listing.ownerphonenumber)}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="text-green-700 font-semibold w-[2.3rem]">í˜„í™©</div>
                                <div class="h-[3rem] px-3 py-1 border border-green-700 rounded text-green-700 text-sm w-[28.2rem] resize-none overflow-y-auto"> ${safeDisplay(listing.ad_status)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col items-start gap-1 pt-2"> <div class="text-red-600 font-semibold pd-1">ë©”ëª¨</div>
                        <div class="flex flex-row gap-3.5 pb-2">
                            <div class="flex items-start gap-3">
                                <div class="flex flex-col justify-between h-[5rem] w-[3.7rem]"> <div class="self-start text-left text-green-700 font-semibold">ê³ ê°ì •ë³´
                                    </div> <div class="self-start text-left text-green-700 font-semibold">ë‚´ìš©</div>
                                </div>
                                <div class="h-[5rem] px-3 py-1 border border-green-700 rounded text-green-700 text-sm w-[26.7rem] resize-none overflow-y-auto">${safeDisplay(listing.customer_data)}</div>
                            </div>
                        </div>
                        <div class="px-3 py-1 border border-green-700 rounded text-green-700 text-sm w-[31.2rem] h-[10rem] resize-none overflow-y-auto">${safeDisplay(listing.private_note)}</div>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 10px; align-items: flex-start;">
                <!-- ì¸ë„¤ì¼ + ì œëª© -->
                <div class="flex flex-col gap-2">
                    <div class="font-bold mb-1">ê±´ë¬¼ì •ë³´</div>
                    <div class="thumb-box w-[140px] h-[100px] rounded relative"><img
                            id="thumb-edit-${listing.listing_id}"
                            src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/baikuk-simbol.png"
                            alt="ì¸ë„¤ì¼"
                            class="thumb-img-contain rounded no-save"
                            draggable="false"
                            oncontextmenu="return false"
                        />
                    </div>
                </div>
                <!-- ê±´ë¬¼ì •ë³´ ë‚´ìš© -->
                <textarea
                    id="textarea-building-note"
                    class="border border-green-700 rounded px-1 py-1 text-sm w-[21.8rem] h-[9rem] resize-none"
                    placeholder="ê±´ë¬¼ì „ì²´ ë‚´ìš©"
                    readonly
                >${safeDisplay(listing.building_note)}</textarea>
            </div>`;

        const panel = document.getElementById('detail-panel');
        const content = document.getElementById('detail-content');
        content.innerHTML = detailHeader + editSection;
        await window.renderAffiliationBadge?.();
        // âœ ê±´ë¬¼ ì¸ë„¤ì¼ ì£¼ì…
        await setBuildingThumbForDetail(listing);

        // âœ… ìˆ˜ì •ëª¨ë“œì¼ ë•Œë§Œ ë‹´ë‹¹ì ì…€ë ‰íŠ¸ë¥¼ ì±„ì›€
        if (isEditMode) {
            await populateStaffSelect('agent_name', listing.agent_name || '');
        }

        // ì—…ë¬´ì¼ì§€ ì˜ì—­ ì¶”ê°€
        const workLogContainer = document.createElement("div");
        workLogContainer.className = "px-4 pb-4";
        workLogContainer.innerHTML = `                      
            <div class="flex flex-row items-start gap-2">
                <div class="flex flex-col items-center gap-3.3 pb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-800 font-semibold mb-2">ì—…ë¬´ì¼ì§€</span>
                    </div>
                    <button id="worklog-save-btn" class="bg-[#F2C130] text-white text-sm px-4 py-1 rounded hover:bg-yellow-400">ì €ì¥</button>
                </div>    
                <div class="flex items-center gap-8 pb-2">                                    
                    <div class="flex flex-col items-start gap-1">
                        <textarea
                            id="textarea-worklog"
                            class="border border-gray-300 rounded px-3 py-1 text-sm w-[25.3rem] h-[4rem] resize-none"
                            placeholder="ì—…ë¬´ì¼ì§€ë‚´ìš©"
                        ></textarea>
                    </div>
                </div> 
            </div>
            <div id="work-log-content" class="text-sm text-gray-300 leading-tight">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        `;
        content.appendChild(workLogContainer);

        // Supabaseì—ì„œ ì—…ë¬´ì¼ì§€ ë¶ˆëŸ¬ì™€ ë Œë”ë§
        // (íŒ¨ë„ HTML ì¶”ê°€í•œ ì§í›„)
        await fetchWorkLogs(listingId);   // ë Œë”ê¹Œì§€ í•¨

        const prevListingId = window.currentDetailListingId; // íŒ¨ë„ìœ„ì¹˜ê³ ì • ê´€ë ¨ ë³€ìˆ˜
        window.currentDetailListingId = listingId; // íŒ¨ë„ìœ„ì¹˜ê³ ì • ê´€ë ¨
        setTimeout(async () => {
            // ìˆ˜ì •ëª¨ë“œì—ì„œ textarea ë†’ì´ë¥¼ ë³´ê¸°ëª¨ë“œ ì¤„ìˆ˜ì™€ ë™ì¼í•˜ê²Œ ë§ì¶¤
            if (isEditMode) {
                applyLinesToTextarea('building_name', _lineSyncCache.building_name);
                applyLinesToTextarea('unit_info',     _lineSyncCache.unit_info);
                applyLinesToTextarea('restroom',      _lineSyncCache.restroom);
                applyLinesToTextarea('store_type_detail',   _lineSyncCache.store_type_detail);
                applyLinesToTextarea('input-title',       _lineSyncCache.title);
            }

            const input = document.getElementById('detail-address-input');
            if (input) {
                const val = listing.detail_address;
                input.placeholder = (!val || val === '-' || val === 'null' || val === 'undefined') ? 'ë²ˆì§€' : val;
            }

            // ğŸ—ºï¸ ì§€ë„ ë¯¸ë¦¬ë³´ê¸° ë° ë§ˆì»¤
            const mapPreviewContainer = document.getElementById('map-preview');
            const panelContent = document.getElementById('detail-content');

            if (mapPreviewContainer && listing.lat && listing.lng) {
                const isEditable = !!window.isEditMode; // or just: const isEditable = isEditMode;

                const mapPreviewOption = {
                    center: new kakao.maps.LatLng(listing.lat, listing.lng),
                    level: 3,
                    draggable: isEditable,
                    scrollwheel: false
                };

                const mapPreview = new kakao.maps.Map(mapPreviewContainer, mapPreviewOption);
                mapPreview.setZoomable(false);

                const marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(listing.lat, listing.lng),
                    draggable: isEditable
                });
                marker.setMap(mapPreview);
                
                // âœ… ì „ì—­ìœ¼ë¡œ ë³´ê´€í•´ì„œ ê²€ìƒ‰ í´ë¦­ ì‹œ ì ‘ê·¼
                window.previewMap = mapPreview;
                window.previewMarker = marker;

                if (isEditable) {
                    kakao.maps.event.addListener(mapPreview, 'click', function(mouseEvent) {
                        const latlng = mouseEvent.latLng;
                        marker.setPosition(latlng);
                        console.log("ìƒˆ ìœ„ì¹˜:", latlng.getLat(), latlng.getLng());
                    });
                }

                // === ì½ê¸°ëª¨ë“œ ìš°í•˜ë‹¨ N ë²„íŠ¼ ===
                const NAVER_BTN_ID = 'btn-naver-on-preview';
                const LAND_BTN_ID  = 'btn-land-on-preview';

                // ì¤‘ë³µ ì‚½ì… ë°©ì§€ (ìƒì„¸ ì—´ê¸°/ì „í™˜ì‹œ ê¸°ì¡´ ë²„íŠ¼ ì œê±°)
                document.getElementById(NAVER_BTN_ID)?.remove();
                document.getElementById(LAND_BTN_ID)?.remove();

                // ì§€ë„ ì»¨í…Œì´ë„ˆë¥¼ absolute ê¸°ì¤€ì ìœ¼ë¡œ
                mapPreviewContainer.classList.add('relative');

                if (!isEditable) {
                    // 1) ë„¤ì´ë²„ ë¶€ë™ì‚°(ëœë“œ) ë²„íŠ¼ (ìœ„ìª½)
                    const landBtn = document.createElement('button');
                    landBtn.id = LAND_BTN_ID;
                    landBtn.type = 'button';
                    landBtn.className = [
                        'absolute','right-2','bottom-14','z-[101]',   // â† N ë²„íŠ¼ë³´ë‹¤ ìœ„ìª½ì— ë°°ì¹˜ (bottom-14)
                        'w-10','h-10','rounded-lg','shadow',
                        'flex','items-center','justify-center',
                        'border','border-gray-300','bg-white','hover:bg-gray-100','transition'
                    ].join(' ');
                    landBtn.title = 'ë„¤ì´ë²„ ë¶€ë™ì‚° (ì˜¤í”¼ìŠ¤/ìƒê°€)';

                    // ì•„ì´ì½˜ ì´ë¯¸ì§€ (Supabase URL)
                    const landIcon = document.createElement('img');
                    landIcon.src = LAND_ICON_URL;  // â† 1)ì—ì„œ ì§€ì •í•œ URL
                    landIcon.alt = 'Naver Land';
                    landIcon.className = 'w-8 h-8 pointer-events-none';
                    landBtn.appendChild(landIcon);

                    landBtn.onclick = () => {
                        // ìœ„ë„/ê²½ë„ ê³„ì‚° (ë¦¬ìŠ¤íŠ¸ì˜ ì¢Œí‘œ ìš°ì„ , ì—†ìœ¼ë©´ ë©”ì¸ ë§µ ì„¼í„°)
                        let lat = Number(listing?.lat);
                        let lng = Number(listing?.lng);
                        if (!lat || !lng) {
                        const c = window.map?.getCenter?.();
                        if (c) { lat = c.getLat(); lng = c.getLng(); }
                        }
                        if (!lat || !lng) return;

                        const url = `https://new.land.naver.com/offices?ms=${lat},${lng},19&a=SG:SMS:GJCG:APTHGJ:GM:TJ&b=B2&e=RETAIL&ad=true`;
                        window.open(url, '_blank');
                    };

                    mapPreviewContainer.appendChild(landBtn);

                    // 2) ê¸°ì¡´ N ë²„íŠ¼ (ì•„ë˜ìª½)
                    const btn = document.createElement('button');
                    btn.id = NAVER_BTN_ID;
                    btn.type = 'button';
                    btn.className = [
                        'absolute','right-2','bottom-2','z-[101]',
                        'w-10','h-10','rounded-lg','shadow',
                        'flex','items-center','justify-center',
                        'border','border-gray-300',
                        'bg-[#00de5a]','hover:bg-[#00b74a]',
                        'transition','text-white','text-[28px]','font-black'
                    ].join(' ');
                    btn.style.textShadow = '0 1px 2px #ffffff, 0 0 1px #ffffff';
                    btn.title = 'ë„¤ì´ë²„ì§€ë„';
                    btn.textContent = 'N';

                    btn.onclick = () => {
                        // (ì´ ë²„íŠ¼ì€ ê¸°ì¡´ ë¡œì§ ìœ ì§€: ê²€ìƒ‰ URL ë˜ëŠ” ì¢Œí‘œ í´ë°± ë“±)
                        const query = getFullAddressForListing(listing);
                        if (query) {
                        window.open(`https://map.naver.com/v5/search/${encodeURIComponent(query)}?c=18.00,0,0,0,dh`, '_blank');
                        } else {
                        window.open(`https://map.naver.com/v5/?c=${listing.lng},${listing.lat},18,0,0,0,d`, '_blank');
                        }
                    };

                    mapPreviewContainer.appendChild(btn);
                }
            }

            renderDealFields();  // âœ… ê±°ë˜ìœ í˜• ê¸°ë°˜ í•„ë“œ ìë™ ë Œë”ë§
            renderDealFieldsViewer(listing);

            
            if (isEditMode) {
                setupAreaAutoFill(); // âœ… í‰â†”ã¡ ìë™ ë³€í™˜ ë°”ì¸ë”©
                initLocationSelects(listing); //  ì§€ì—­ ì…€ë ‰íŠ¸ ì˜ì¡´í˜• ì´ˆê¸°í™”
            }

            // âœ… ì—…ë¬´ì¼ì§€ ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
            document.getElementById('worklog-save-btn')?.addEventListener('click', saveWorkLog);

            // âœ… ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µì›            
            if (panelContent) {
                const isSameListing = prevListingId === listingId;

                if (isSameListing && isEditMode) {
                    // âœ… ê°™ì€ ë§¤ë¬¼ì„ ìˆ˜ì • í›„ ë‹¤ì‹œ ë³´ê¸°ë¡œ â†’ ë³µì›
                    panelContent.scrollTop = detailScrollTop;
                } else if (!isSameListing) {
                    // âœ… ë‹¤ë¥¸ ë§¤ë¬¼ í´ë¦­í•œ ê²½ìš° (ìˆ˜ì • ì¤‘ì´ë“  ì•„ë‹ˆë“ ) â†’ ì´ˆê¸°í™”
                    detailScrollTop = 0;
                    panelContent.scrollTop = 0;
                } else {
                    // âœ… ê¸°íƒ€ (ì˜ˆ: ìˆ˜ì •ëª¨ë“œ ì§„ì… ë“±) â†’ ë³µì›
                    panelContent.scrollTop = detailScrollTop;
                }
            }

            // ìˆ˜ì •ëª¨ë“œ ê²€ìƒ‰ë²„íŠ¼ ëˆŒë €ì„ ë•Œ ì§€ë„ì— ë§ˆì»¤ í‘œì‹œê´€ë ¨ ì½”ë“œ
            document.getElementById('addr-search-btn')?.addEventListener('click', searchAndMoveMarker);
        }, 0);

        panel.style.display = 'block';
        document.getElementById('close-detail-btn').style.display = 'block';

        // ê°œë³„urlê´€ë ¨
        const cur = getListingIdFromURL();
        if (cur !== String(listingId)) updateURLForListing(listingId);

        // ì‚¬ì§„ìˆ˜ì •ì°½ ê´€ë ¨
        const sidePanel = document.getElementById('side-panel');
        if (isEditMode) {
            sidePanel.innerHTML = `
                <div id="image-editor" class="w-[21.5rem]"> <div class="flex items-center justify-between"> <div class="text-sm font-bold text-gray-800">ê³µê°œ-ë§¤ë¬¼</div>
                    <div class="text-xs text-gray-500">JPG/PNG ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥</div>
                    </div>
                    <!-- ì—…ë¡œë“œ ë“œë¡­ì¡´ -->
                    <div id="img-dropzone"
                        class="mt-2 border-2 h-[5rem] border-dashed border-gray-300 rounded p-3 text-center text-sm text-gray-500">
                    ì´ ì˜ì—­ì— ì´ë¯¸ì§€ë‚˜ í´ë”ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ë†“ìœ¼ì„¸ìš”
                    </div>
                    <!-- ë¯¸ë¦¬ë³´ê¸° -->
                    <div id="img-preview-list" class="grid grid-cols-4 gap-2 mb-2"></div>

                    <!-- íŒŒì¼ ì„ íƒ + ì—…ë¡œë“œ ë²„íŠ¼ -->
                    <div class="flex items-center space-x-1">
                        <input id="img-upload-input" type="file" accept="image/*" multiple
                            class="text-sm"/>
                        <button id="img-upload-btn"
                            class="-ml-3 bg-[#F2C130] text-black font-semibold text-sm px-1 py-1 min-h-[2rem] min-w-[5rem] rounded hover:brightness-95">
                            ì—…ë¡œë“œ
                        </button>
                    </div>

                    <!-- ì´ë¯¸ ì €ì¥ëœ ì´ë¯¸ì§€ ëª©ë¡ -->
                    <div class="mt-3 md-5">
                        <div class="text-xs text-gray-600 mb-1">ì €ì¥ëœ ì´ë¯¸ì§€</div>
                        <div id="img-list" class="grid grid-cols-4 gap-2"></div>
                    </div>
                </div>
                <div class="border-t mt-5 pt-3 w-[21.5rem]"> <div class="flex items-center justify-between"> <div class="text-sm font-bold text-gray-800">ë¹„ê³µê°œ-ë§¤ë¬¼</div>
                    <div class="text-xs text-gray-500">JPG/PNG ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥</div>
                    </div>
                    <!-- ì—…ë¡œë“œ ë“œë¡­ì¡´ -->
                    <div id="img-dropzone-private"
                        class="mt-2 border-2 h-[5rem] border-dashed border-gray-300 rounded p-3 text-center text-sm text-gray-500">
                    ì´ ì˜ì—­ì— ì´ë¯¸ì§€ë‚˜ í´ë”ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ë†“ìœ¼ì„¸ìš”
                    </div>
                    <!-- ë¯¸ë¦¬ë³´ê¸° -->
                    <div id="img-preview-list-private" class="grid grid-cols-4 gap-2 mb-2"></div>

                    <!-- íŒŒì¼ ì„ íƒ + ì—…ë¡œë“œ ë²„íŠ¼ -->
                    <div class="flex items-center space-x-1">
                        <input id="img-upload-input-private" type="file" accept="image/*" multiple
                            class="text-sm"/>
                        <button id="img-upload-btn-private"
                            class="-ml-3 bg-[#F2C130] text-black font-semibold text-sm px-1 py-1 min-h-[2rem] min-w-[5rem] rounded hover:brightness-95">
                            ì—…ë¡œë“œ
                        </button>
                    </div>

                    <!-- ì´ë¯¸ ì €ì¥ëœ ì´ë¯¸ì§€ ëª©ë¡ -->
                    <div class="mt-3">
                        <div class="text-xs text-gray-600 mb-1">ì €ì¥ëœ ì´ë¯¸ì§€</div>
                        <div id="img-list-private" class="grid grid-cols-4 gap-2"></div>
                    </div>
                </div>
                <div class="border-t mt-5 pt-3 w-[21.5rem]"> <div class="flex items-center justify-between"> <div class="text-sm font-bold text-gray-800">ê±´ë¬¼</div>
                    <div class="text-xs text-gray-500">JPG/PNG ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥</div>
                    </div>
                    <!-- ì—…ë¡œë“œ ë“œë¡­ì¡´ -->
                    <div id="img-dropzone-addr"
                        class="mt-2 border-2 h-[5rem] border-dashed border-gray-300 rounded p-3 text-center text-sm text-gray-500">
                    ì´ ì˜ì—­ì— ì´ë¯¸ì§€ë‚˜ í´ë”ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ë†“ìœ¼ì„¸ìš”
                    </div>
                    <!-- ë¯¸ë¦¬ë³´ê¸° -->
                    <div id="img-preview-list-addr" class="grid grid-cols-4 gap-2 mb-2"></div>

                    <!-- íŒŒì¼ ì„ íƒ + ì—…ë¡œë“œ ë²„íŠ¼ -->
                    <div class="flex items-center space-x-1">
                        <input id="img-upload-input-addr" type="file" accept="image/*" multiple
                            class="text-sm"/>
                        <button id="img-upload-btn-addr"
                            class="-ml-3 bg-[#F2C130] text-black font-semibold text-sm px-1 py-1 min-h-[2rem] min-w-[5rem] rounded hover:brightness-95">
                            ì—…ë¡œë“œ
                        </button>
                    </div>

                    <!-- ì´ë¯¸ ì €ì¥ëœ ì´ë¯¸ì§€ ëª©ë¡ -->
                    <div class="mt-3">
                        <div class="text-xs text-gray-600 mb-1">ì €ì¥ëœ ì´ë¯¸ì§€</div>
                        <div id="img-list-addr" class="grid grid-cols-4 gap-2"></div>
                    </div>
                </div>
            `;
            sidePanel.classList.remove('hidden');
        } else {
            sidePanel.classList.add('hidden');
        }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ UI ë°”ì¸ë”© + ì´ˆê¸° ë¡œë“œ
        document.getElementById('img-upload-input')?.addEventListener('change', previewSelectedFiles);
        document.getElementById('img-upload-btn')?.addEventListener('click', () => uploadSelectedImages(listingId));
        await loadListingImages(listingId);

        await initImageViewer(listingId, { includePrivateInViewer: true });

        // âœ… ë“œë˜ê·¸&ë“œë¡­ ì—…ë¡œë“œ í™œì„±í™”
        setupDragAndDropUpload(listingId);

        // ë¹„ê³µê°œ ì‚¬ì§„ ê´€ë ¨
        document.getElementById('img-upload-input-private')?.addEventListener('change', previewSelectedFilesPrivate);
        document.getElementById('img-upload-btn-private')?.addEventListener('click', () => uploadSelectedImagesPrivate(listingId));
        await loadListingImagesPrivate(listingId);
        setupDragAndDropUploadPrivate(listingId);

        // ê±´ë¬¼(ì£¼ì†Œê³µìš©) ë°”ì¸ë”©
        const addrKey = getAddrKey(listing);                 
        document.getElementById('img-upload-input-addr')?.addEventListener('change', previewSelectedFilesAddr);
        document.getElementById('img-upload-btn-addr')?.addEventListener('click', () => uploadSelectedImagesAddr(listing));
        await loadAddressImages(addrKey);            
        setupDragAndDropUploadAddr(listing);
    }

    // í‰ m2ì‚¬ì´ì˜ ë³€í™˜ ê´€ë ¨ í•¨ìˆ˜
    function setupAreaAutoFill() {
        const $ = (id) => document.getElementById(id);
        const sa_py = $('supply-area-py');
        const a_py  = $('area-py');
        const sa_m2 = $('supply-area-m2');
        const a_m2  = $('area-m2');

        if (!sa_py || !a_py || !sa_m2 || !a_m2) return;

        const updateFromPy = (srcEl, destEl) => {
            const v = parseNum(srcEl.value);
            if (v === null) { destEl.value = ''; return; }
            destEl.value = toFixed2(v * M2_PER_PYEONG); // mÂ² = í‰ Ã— 3.3058
        };
        const updateFromM2 = (srcEl, destEl) => {
            const v = parseNum(srcEl.value);
            if (v === null) { destEl.value = ''; return; }
            destEl.value = toFixed2(v * PYEONG_PER_M2); // í‰ = mÂ² Ã— 0.3025
        };

        // ì…ë ¥ ì‹œ ì„œë¡œ ìë™ ì±„ì›€ (í”„ë¡œê·¸ë¨ìœ¼ë¡œ ê°’ ì„¸íŒ…ì€ input ì´ë²¤íŠ¸ ë°œìƒ ì•ˆ í•¨ â†’ ë£¨í”„ ì—†ìŒ)
        sa_py.addEventListener('input', () => updateFromPy(sa_py, sa_m2));
        a_py .addEventListener('input', () => updateFromPy(a_py , a_m2));
        sa_m2.addEventListener('input', () => updateFromM2(sa_m2, sa_py));
        a_m2 .addEventListener('input', () => updateFromM2(a_m2 , a_py));

        // ì´ˆê¸°ê°’ ë™ê¸°í™” (í‰ ìª½ì´ ìˆìœ¼ë©´ í‰â†’ã¡ ìš°ì„ , ì—†ìœ¼ë©´ ã¡â†’í‰)
        if (parseNum(sa_py.value) !== null) updateFromPy(sa_py, sa_m2);
        else if (parseNum(sa_m2.value) !== null) updateFromM2(sa_m2, sa_py);

        if (parseNum(a_py.value) !== null) updateFromPy(a_py, a_m2);
        else if (parseNum(a_m2.value) !== null) updateFromM2(a_m2, a_py);
        }

    // ìƒì„¸íŒ¨ë„ ë·°ëª¨ë“œ ë§¤ë§¤, ì›”ì„¸ì— ë”°ë¼ì„œ ê°€ê²©ì •ë³´ ë‹¤ë¥´ê²Œ í‘œì‹œ
    function renderDealFieldsViewer(listing) {
        const container = document.getElementById("dealFieldsViewer");
        if (!listing || !container) return;

        const selected = listing.deal_type || '';
        const isMaeMae = selected.includes("ì›”ì„¸");

        container.innerHTML = `${isMaeMae ? ` <div class="flex flex-row items-center gap-6"> <div class="font-semibold text-[#5098e9]">ë³´ì¦ê¸ˆ</div>
                    <div class="w-[4.7rem]"> ${formatKoreanMoney(listing.deposit_price)}</div>
                </div>
                <div class="flex flex-row items-center gap-3"> <div class="font-semibold text-[#5098e9]">ì›”ì„¸</div>
                    <div class="w-[3.3rem]"> ${formatKoreanMoney(listing.monthly_rent)}</div>
                </div>
                <div class="flex flex-row items-center gap-3"> <span class="font-semibold text-[#5098e9]">ê¶Œë¦¬ê¸ˆ</span>
                    <span> ${formatKoreanMoney(listing.premium_price)}</span>
                </div>
            ` : `<div class="flex items-center gap-6">                    
                <div class="flex items-center gap-1">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ë§¤ë§¤ê°€</div>
                    <div class="w-[7.55rem] rounded px-3 py-1 text-sm w-[4.5rem]">${formatKoreanMoney(listing.sale_price)}</div>
                </div>
                <div class="flex items-center gap-1">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ì´ë³´ì¦ê¸ˆ</div>
                    <div class="w-[6rem] rounded px-3 py-1 text-sm w-[3.5rem]">${formatKoreanMoney(listing.total_deposit)}</div>
                </div>
                <div class="flex items-center gap-1">
                    <div class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ì´ì›”ì„¸</div>
                    <div class="w-[4.95rem] rounded px-3 py-1 text-sm">${formatKoreanMoney(listing.total_rent)}</div>
                </div>
                </div>`}
            </div>`;
    }

    // ìˆ˜ì •ì°½ ë§¤ë§¤, ì›”ì„¸ì— ë”°ë¼ì„œ ê°€ê²©ì •ë³´ ë‹¤ë¥´ê²Œ í‘œì‹œ
    function renderDealFields() { 
        const selected = document.getElementById("dealTypeSelect")?.value;
        const container = document.getElementById("dealFields");
        const listing = allListings?.[window.currentDetailListingId];

        if (!container || !selected || !listing) return;


        if (selected === "ì›”ì„¸") {
            container.innerHTML = `
                <div class="flex items-center gap-6 pb-2">                    
                    <div class="flex items-center gap-1">
                        <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ë³´ì¦ê¸ˆ</span>
                        <input type="text" id="deposit_price" placeholder="ë§Œì›" class="w-[7.55rem] border border-gray-300 rounded px-3 py-1 text-sm" value="${formatNumber(listing.deposit_price)}" />
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ì›”ì„¸</span>
                        <input type="text" id="monthly_rent" placeholder="ë§Œì›" class="w-[6rem] border border-gray-300 rounded px-3 py-1 text-sm" value="${formatNumber(listing.monthly_rent)}" />
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ê¶Œë¦¬ê¸ˆ</span>
                        <input type="text" id="premium_price" placeholder="ë§Œì›" class="w-[6.7rem] border border-gray-300 rounded px-3 py-1 text-sm" value="${formatNumber(listing.premium_price)}" />
                    </div>
                </div>
            `;
        } else if (selected === "ë§¤ë§¤") {
            container.innerHTML = `
                <div class="flex items-center gap-6 pb-2">                    
                    <div class="flex items-center gap-1">
                        <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ë§¤ë§¤ê°€</span>
                        <input type="text" id="sale_price" placeholder="ë§Œì›" class="w-[7.55rem] border border-gray-300 rounded px-3 py-1 text-sm w-[4.5rem]" value="${formatNumber(listing.sale_price)}" />
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ì´ë³´ì¦ê¸ˆ</span>
                        <input type="text" id="total_deposit" placeholder="ë§Œì›" class="w-[6rem] border border-gray-300 rounded px-3 py-1 text-sm w-[3.5rem]" value="${formatNumber(listing.total_deposit)}" />
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-sm text-gray-600 font-semibold" style="color: #5098e9;">ì´ì›”ì„¸</span>
                        <input type="text" id="total_rent" placeholder="ë§Œì›" class="w-[4.95rem] border border-gray-300 rounded px-3 py-1 text-sm" value="${formatNumber(listing.total_rent)}" />
                    </div>
                </div>
            `;
        } else {
            container.innerHTML = '';
        }
    }

    // hideDetailPanel êµì²´
    function hideDetailPanel(skipUrl = false) {
        const panel = document.getElementById('detail-panel');
        const content = document.getElementById('detail-content');

        if (content) content.scrollTop = 0;
        detailScrollTop = 0;

        panel.style.display = 'none';
        document.getElementById('close-detail-btn').style.display = 'none';
        document.querySelectorAll('[id^="filter-panel-"]').forEach(p => p.classList.add('hidden'));
        isEditMode = false;
        publicBulkMode = false; // ì„ íƒëª¨ë“œ í•´ì œ

        closeSidePanel();// ì‚¬ì§„ìˆ˜ì •ì°½ ë‹«ê¸°
        if (!skipUrl) updateURLForListing(null); // <- ë’¤ë¡œê°€ê¸° ë•ŒëŠ” ì•ˆ ê±´ë“œë¦¬ê¸°
    }


    // ë§¤ë¬¼ìˆ˜ì •ì—ì„œ í‰ m2ì‚¬ì´ì˜ ë³€í™˜
    // í‰â†”ã¡ ë³€í™˜ ìƒìˆ˜ (ìš”ì²­ëŒ€ë¡œ 0.3025 ì‚¬ìš©)
    const M2_PER_PYEONG = 1 / 0.3025; // â‰ˆ 3.3058
    const PYEONG_PER_M2 = 0.3025;

    // ìˆ«ì íŒŒì‹± & ë‘ ìë¦¬ í¬ë§·
    function parseNum(v) {
        const n = parseFloat((v ?? '').toString().replace(/,/g, ''));
        return Number.isFinite(n) ? n : null;
    }
    function toFixed2(n) {
        if (!Number.isFinite(n)) return '';
        return (Math.round(n * 100) / 100).toFixed(2); // í•­ìƒ 2ìë¦¬ í‘œì‹œ
    }

    
    function formatKoreanMoney(value) {
        if (!value && value !== 0) return '-';
        const num = Number(value);
        if (num >= 10000) {
            const eok = Math.floor(num / 10000);
            const man = num % 10000;
            return `${eok}ì–µ${man > 0 ? ` ${man.toLocaleString()}` : ''}`;
        }
        return `${num.toLocaleString()}`;
    }

    function formatValue(type, val) {
        if (val === "" || val === undefined || val === null) return '-';
        const num = Number(val);
        const filterUnits = {
            floor: 'ì¸µ', sale: 'ë§Œ', deposit: 'ë§Œ', rent: 'ë§Œ',
            total_deposit: 'ë§Œ', total_rent: 'ë§Œ', area_py: 'í‰'
        };
        if (['sale', 'deposit', 'rent', 'total_deposit', 'total_rent'].includes(type)) {
            if (isNaN(num)) return '-';
            return num >= 10000 ? `${Math.floor(num / 10000)}ì–µ${num % 10000 > 0 ? ` ${(num % 10000).toLocaleString()}` : ''}` : `${num.toLocaleString()}ë§Œ`;
        }
        if (['floor', 'area_py'].includes(type)) return isNaN(num) ? '-' : num + filterUnits[type];
        return val;
    }

    function updateFilterButtonText(type) {
        let min = document.getElementById(`${type}_min`)?.value;
        let max = document.getElementById(`${type}_max`)?.value;
        let btn = document.getElementById(`filter-btn-${type}`);
        let label = "";
        if (min && max) label = `${formatValue(type, min)}~${formatValue(type, max)}`;
        else if (min) label = `${formatValue(type, min)}~`;
        else if (max) label = `~${formatValue(type, max)}`;
        else label = btn ? btn.getAttribute('data-default-label') || 'â–¼' : 'â–¼';
        
        if (btn) {
            btn.textContent = label;
            const isDefault = label === btn.getAttribute('data-default-label');
            Object.assign(btn.style, {
                backgroundColor: isDefault ? "#fff" : HIGHLIGHT_COLOR,
                color: isDefault ? "#374151" : "#111",
                borderColor: isDefault ? "#d1d5db" : "#eab308",
                fontWeight: isDefault ? "normal" : "bold",
            });
        }
    }
    
    function showListingsInPanel(listings) {
        matchedListingsCache = listings;
        matchedListingsPage = 1;
        if (typeof renderMatchedListings === "function") renderMatchedListings();
        infoPanel.classList.remove("hidden");
        infoPanel.style.display = 'block';
        setTimeout(() => {
            infoPanel.scrollTop = 0;
        }, 0);
    }
    
    function hideLogin() { document.getElementById('login-modal').classList.add('hidden'); }
    function showLogin() { document.getElementById('login-modal').classList.remove('hidden'); }

    async function logout() {
        await client.auth.signOut();
        window.location.replace(location.origin);
    }

    function getFilterValues() {
        const values = {};
        filterDefs.forEach(def => {
            values[`${def.id}_min`] = parseFloat(document.getElementById(`${def.id}_min`).value);
            values[`${def.id}_max`] = parseFloat(document.getElementById(`${def.id}_max`).value);
        });
        return values;
    }

    function filterListings(listings) {
        const f = getFilterValues();
        const filterMap = {
            floor: 'floor',
            sale: 'sale_price',
            deposit: 'deposit_price',
            rent: 'monthly_rent',
            total_deposit: 'total_deposit',
            total_rent: 'total_rent',
            area_py: 'area_py'
        };

        return listings.filter(l => {
            if (!selectedDealTypes.includes(l.deal_type)) return false;
            if (selectedCategories.length > 0 && !selectedCategories.includes(l.category)) return false;

            for (const key in filterMap) {
                const dbKey = filterMap[key];
                const minVal = f[`${key}_min`];
                const maxVal = f[`${key}_max`];

                if (!isNaN(minVal) && l[dbKey] < minVal) return false;
                if (!isNaN(maxVal) && l[dbKey] > maxVal) return false;
            }

            // â¬‡ï¸ ë‹¤ì¤‘ì„ íƒ ì…€ë ‰íŠ¸ í•„í„° ì ìš© (ì´ì œ lì„ ì°¸ì¡° ê°€ëŠ¥)
            for (const [field, selectedValues] of Object.entries(selectFilterState)) {
                if (Array.isArray(selectedValues) && selectedValues.length > 0) {
                    const cur = (l[field] ?? '').toString().trim();
                    if (!selectedValues.includes(cur)) return false;
                }
            }

            return true;
        });
    }

    function toggleFilterPanel(type) {
        document.querySelectorAll('[id^="filter-panel-"]').forEach(panel => {
            if (panel.id === `filter-panel-${type}`) {
                panel.classList.toggle('hidden');
            } else {
                panel.classList.add('hidden');
            }
        });
    }
    
    function updateFilteredListingsDebounced() {
        if (updateTimer) clearTimeout(updateTimer);
        updateTimer = setTimeout(() => {
            updateFilteredListings();
        }, 150);
    }

    function updateFilteredListings() {
        const filtered = filterListings(Object.values(allListings));

        const level = map.getLevel();
        let gridSize;
        if (level <= 2) gridSize = 10;
        else if (level === 3) gridSize = 30;
        else if (level === 4) gridSize = 40;
        else gridSize = 50;
        createClusterer(gridSize);

        clusterer.clear();
        const markers = [];
        filtered.forEach(l => {
            if (!l.lat || !l.lng) return;
            if (!allMarkers[l.listing_id]) {
            const marker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(l.lat, l.lng),
                image: customImage
            });
            marker.listing_id = l.listing_id;
            allMarkers[l.listing_id] = marker;
            }
            markers.push(allMarkers[l.listing_id]);
        });
        clusterer.addMarkers(markers);

        // ğŸ”¥ ì—¬ê¸°ì„œ "í˜„ì¬ í´ëŸ¬ìŠ¤í„°ì— í¬í•¨ëœ ëª¨ë“  ë§¤ë¬¼"ì˜ ëŒ€í‘œ ì¸ë„¤ì¼ì„ í•œ ë²ˆì— ìºì‹œì— ì˜ˆì—´
        if (!_prewarmDoneOnce) {
            _prewarmDoneOnce = true;
            const allIdsInView = filtered.map(l => l.listing_id);
            // ìºì‹œë§Œ ì±„ì›€ (DOM ì¦‰ì‹œ ë°˜ì˜ X)
            loadPrimaryThumbsBatch(allIdsInView, { applyToDom: false }).catch(console.warn);
        }

        matchedListingsCache = filtered;
        matchedListingsPage = 1;
        renderMatchedListings();
    }

    function renderMatchedListings() {
        if (!Array.isArray(matchedListingsCache)) return;
        const end = matchedListingsPage * PAGE_SIZE;
        const listingsToShow = matchedListingsCache.slice(0, end);             

        infoContent.innerHTML = listingsToShow.map(l => {
            const statusRaw = l.transaction_status || '-';
            const status = statusRaw.trim().split(' ')[0];
            let bgStyle = 'background-color: #d1d5db; color: #37373d;';
            if (status === 'ì§„í–‰ì¤‘') bgStyle = 'background-color: #d9fae6; color: #00b74a;';
            else if (status === 'ê³„ì•½ì™„ë£Œ') bgStyle = 'background-color: rgba(255,237,237); color: rgba(247,63,87); font-weight: 900;';
            
            const isActive = String(window.currentDetailListingId).trim() === String(l.listing_id).trim();
            const highlightStyle = isActive ? 'background-color: rgba(243,244,246);' : '';
            const logo = 'https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/baikuk-simbol.png';

            return `
                <div class="mb-1 pb-1 border-b border-gray-300 text-left" style="${highlightStyle};">
                    <div onclick="showDetailPanel(${l.listing_id})" class="cursor-pointer hover:bg-gray-100 transition">
                        <div class="flex flex-row items-center gap-3">
                            <div class="relative w-[140px] h-[100px]">
                                <div class="absolute top-1 right-1 w-[57px] h-[22px] flex items-center justify-center text-xs px-1 rounded-md font-semibold z-10" style="${bgStyle}">${status}</div>
                                <div 
                                    class="absolute top-1 left-1 w-[53px] h-[22px] flex items-center justify-center text-[15px] px-1 rounded-md font-semibold z-10"
                                    style="background-color: ${
                                        (l.is_public || '').toString().trim().includes('ë¹„ê³µê°œ') 
                                            ? '#d1d5db' 
                                            : '#F2C130'
                                    }; color: #37373d;">
                                    ${l.listing_id}
                                </div>
                                <img id="thumb-${l.listing_id}" src="${logo}" alt="ì¸ë„¤ì¼" class="thumb-img-contain rounded no-save" draggable="false" oncontextmenu="return false" />
                            </div>                           
                            <div class="flex-1 flex flex-col gap-1">                                   
                                <div class="flex items-center gap-2">
                                    <div class="flex flex-row items-center">
                                        <div class="flex items-center gap-5 leading-[1.4]">
                                            <strong class="text-[15px] text-gray-800 max-w-[280px]" title="${l.listing_title}">${l.listing_title.length > 40 ? l.listing_title.slice(0, 40) + 'â‹¯' : l.listing_title}</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-[2px] leading-[1.4]">
                                    <div class="flex flex-row justify-between items-start">
                                        <div class="flex items-start gap-2">
                                            <div class="flex-1 text-left font-bold text-[rgb(80,152,233)] text-base">
                                                ${l.deal_type} ${l.deal_type === "ë§¤ë§¤" ? ` ${formatKoreanMoney(l.sale_price)}` : l.deal_type === "ì›”ì„¸" ? ` ${formatKoreanMoney(l.deposit_price)} / ${formatKoreanMoney(l.monthly_rent)}` : ""}
                                            </div>
                                        </div>                                        
                                        <div class="text-right font-bold text-[rgb(248,63,87)] text-base whitespace-nowrap">
                                            ${
                                                l.deal_type?.includes("ì›”ì„¸")
                                                    ? (() => {
                                                        const price = l.premium_price;
                                                        if (parseFloat(price) === 0) return 'ë¬´ê¶Œë¦¬';
                                                        if (!price || price === '-' || isNaN(price)) return '';
                                                        if (parseFloat(price) > 0) return `ê¶Œ ${formatKoreanMoney(price)}`;
                                                        return '';
                                                    })()
                                                    : l.deal_type?.includes("ë§¤ë§¤")
                                                    ? `${l.roi ? (parseFloat(l.roi) * 100).toFixed(1) : '-'}%`
                                                    : ''
                                            }
                                        </div>

                                    </div>
                                    <div class="flex-1 text-[16px]">
                                        <strong class="font-semibold">${l.floor < 0 ? `B${Math.abs(l.floor)}` : `${l.floor}`}</strong>/${l.total_floors}ì¸µ
                                        <strong class="font-semibold">${Number(l.area_py).toFixed(0)}</strong>í‰
                                        <strong class="font-semibold">${(Number(l.monthly_rent)/Number(l.area_py)).toFixed(1)}</strong>ë§Œ
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
        }).join('');

        // â–¼ ìƒˆë¡œ ê·¸ë ¤ì§„ ì¸ë„¤ì¼ë“¤ì— ëŒ€í‘œì‚¬ì§„ ì ìš©
        const ids = listingsToShow.map(l => l.listing_id);
        applyPrimaryThumbsFromCache(ids);
        loadPrimaryThumbsBatch(ids).catch(console.warn);
    }    

    // ì†ë„ ë†’ì´ê¸° ìœ„í•´, ì¤Œë²ˆí™” ì´ë™ í• ë•Œë§Œ ì¿¼ë¦¬ í•˜ë„ë¡
    let _lastQuery = { lat: null, lng: null, level: null };
    function shouldQueryAgain(map) {
        const c = map.getCenter();
        const lv = map.getLevel();
        if (_lastQuery.level !== lv) { _lastQuery = { lat: c.getLat(), lng: c.getLng(), level: lv }; return true; }
        if (_lastQuery.lat === null) { _lastQuery = { lat: c.getLat(), lng: c.getLng(), level: lv }; return true; }
        // ì¤‘ì‹¬ì´ ì•½ 200m ì´ìƒ ë³€í•  ë•Œë§Œ (ëŒ€ëµì ì¸ ë¼ë””ì•ˆ â†’ meters ë³€í™˜ ìƒëµ, ê²½í—˜ê°’)
        const dLat = Math.abs(c.getLat() - _lastQuery.lat);
        const dLng = Math.abs(c.getLng() - _lastQuery.lng);
        const movedEnough = (dLat + dLng) > 0.002; // ê²½í—˜ì  ê¸°ì¤€
        if (movedEnough) { _lastQuery = { lat: c.getLat(), lng: c.getLng(), level: lv }; return true; }
        return false;
    }
    function debounceLoadListings() {
        if (isFetching) return;
        if (mapIdleTimer) clearTimeout(mapIdleTimer);

        mapIdleTimer = setTimeout(() => {
            if (!isFetching && shouldQueryAgain(map)) {
                loadListingsInBounds().then(() => {
                    tryPrewarmVisibleThumbs(); // ğŸ‘ˆ ì˜ˆì—´ ì‹œë„
                });
            } else {
                tryPrewarmVisibleThumbs(); // ğŸ‘ˆ ì¤Œ ì´ë™ë§Œ ìˆë”ë¼ë„ ì˜ˆì—´
            }
        }, 250);
    }

    kakao.maps.event.addListener(map, 'idle', () => {
        debounceLoadListings();
    });

    async function loadListingsInBounds() {
        if (isFetching) return;
        isFetching = true;

        try {
            const bounds = map.getBounds();
            const sw = bounds.getSouthWest();
            const ne = bounds.getNorthEast();
            const tableToQuery = 'listing_with_primary';

            // 1. ì£¼ìš” ë§¤ë¬¼ ë°ì´í„° ì¡°íšŒ
            const { data: listings, error: listingError } = await client
                .from(tableToQuery)
                .select('listing_id, lat, lng, listing_title, deal_type, deposit_price, monthly_rent, sale_price, total_deposit, total_rent, premium_price, roi, floor, total_floors, area_py, supply_area_py, area_m2, supply_area_m2, category, transaction_status, is_public, province, city, district, detail_address, addr_compare, primary_image_path')
                .gte('lat', sw.getLat()).lte('lat', ne.getLat())
                .gte('lng', sw.getLng()).lte('lng', ne.getLng());

            if (listingError) { console.error(listingError); return; }

            // 2. building_info í…Œì´ë¸”ì—ì„œ full_addressì™€ building_note ê°€ì ¸ì˜¤ê¸°
            const { data: latlngData, error: latlngError } = await client
                .from('building_info')
                .select('addr_compare, building_note, building_name');

            if (latlngError) {
                console.error("âŒ building_info ì—ëŸ¬:", latlngError);
            }

            // addr_compare ê¸°ì¤€ìœ¼ë¡œ building_infoì™€ë³‘í•©
            const latLngMap = Object.fromEntries(
                latlngData.map(l => {
                    const key = String(l.addr_compare || '').replace(/\s+/g, '').trim();
                    const building_name_raw = l.building_name; // ì›ë³¸ ê·¸ëŒ€ë¡œ ì €ì¥

                    const value = {
                    building_note: (l.building_note && l.building_note !== '.' ? l.building_note : '-'),
                    building_name: (building_name_raw && building_name_raw !== '.' ? building_name_raw : '-')
                    };

                    return [key, value];
                })
            );

            // listingsì— building_infoì™€ ë³‘í•©
            const mergedData = listings.map(l => {
                const key = normalizeAddr(l.addr_compare);   // ê³µë°± ì‚­ì œ + trimìœ¼ë¡œ í†µì¼
                const info = latLngMap[key] || { building_note: '-', building_name: '-' };
                const merged = {
                    ...l,
                    building_note: info.building_note,
                    building_name: info.building_name
                };
                // console.log("ğŸ”— ë³‘í•©ëœ listing:", key, merged);
                return merged;
            });


            // 5. ì „ì—­ ì €ì¥
            allListings = Object.fromEntries(mergedData.map(l => [String(l.listing_id), l]));

            // 6. ì§€ë„ì— í‘œì‹œ
            updateFilteredListings();

        } finally {
            isFetching = false;
        }
    }

    kakao.maps.event.addListener(map, 'click', () => {
        detailScrollTop = 0;  // âœ… ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì´ˆê¸°í™”
        window.currentDetailListingId = null;  // âœ… í˜„ì¬ ì—´ë ¤ìˆë˜ ë§¤ë¬¼ ID ì´ˆê¸°í™”
        hideDetailPanel();
    });
    
    document.addEventListener('DOMContentLoaded', async () => {
        // âœ… ì²« ë¡œë“œ ë•Œ ì‚¬ì´ë“œíŒ¨ë„/ìƒì„¸íŒ¨ë„ ë‹«ê¸°
        closeSidePanel();
        hideDetailPanel(true); // URLì€ ê±´ë“œë¦¬ì§€ ì•Šë„ë¡ skipUrl=true
        renderDealAndCategoryButtons();
        renderFilterButtons();

        await renderAffiliationBadge();
        isLoggedIn = true;
        document.getElementById('logout-btn')?.classList.remove('hidden');

        await loadListingsInBounds();

        // ğŸ‘‡ ëª°ë˜ ì˜ˆì—´
        const idsForWarm = Object.values(allListings).slice(0, 500).map(l => l.listing_id);
        ensureThumbsReady(idsForWarm, { timeout: 1000 }).catch(()=>{});

        const deepId = getListingIdFromURL();
        if (deepId) await openDeepLink(deepId);   // âœ… URLì— id ìˆìœ¼ë©´ ë°”ë¡œ ì—´ê¸°

        // âœ… ì—¬ê¸° êµì²´!
        (async () => {
            const idFromUrl = getListingIdFromURL();
            if (idFromUrl) {
            try {
                await ensureListingLoaded(idFromUrl);  // ë¨¼ì € ë©”ëª¨ë¦¬ì— ë³´ì¥
                await showDetailPanel(idFromUrl);      // ê·¸ ë‹¤ìŒ ìƒì„¸ íŒ¨ë„ ì˜¤í”ˆ
            } catch (e) {
                console.error(e);
                showToast('URLì˜ ë§¤ë¬¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }
            }
        })();
        
        renderDealFields();
        const listing = allListings?.[window.currentDetailListingId];
        if (listing) renderDealFieldsViewer(listing);
        
        // âœ… ë§¤ë¬¼ë“±ë¡ ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
        // 1) ë§¤ë¬¼ë“±ë¡ ë²„íŠ¼ ë°”ì¸ë”© (ê·¸ëŒ€ë¡œ ìœ ì§€)
        const newBtn = document.getElementById('open-listing-form-btn');
        if (newBtn) {
            let creating = false;
            newBtn.addEventListener('click', async () => {
                if (creating) return;
                creating = true;
                try {
                // ìˆ˜ë™ í´ë¦­ ì‹œ ì¼œì§€ëŠ” í¸ì§‘ ëª¨ë“œ ë¡œì§ ê·¸ëŒ€ë¡œ íƒ€ê²Œ í•¨
                window.isEditMode = true;
                await openNewListing();
                } finally {
                creating = false;
                }
            });
        }

        // 2) URL íŒŒë¼ë¯¸í„°ë¡œ ìë™ ì‹¤í–‰ (ë²„íŠ¼ì„ 'ì‹¤ì œë¡œ' í´ë¦­)
        const params = new URLSearchParams(location.search);
        const shouldAutoOpen =
        params.get('autoclick') === 'open-listing' || params.get('mode') === 'new';

        if (shouldAutoOpen) {
        const started = Date.now();
        const TIMEOUT = 7000;

        const tick = setInterval(() => {
            // ë²„íŠ¼ì´ DOMì— ë¶™ê³ , í´ë¦­ í•¸ë“¤ëŸ¬ê°€ ë°”ì¸ë”©ëœ ë’¤ì— ì‹¤í–‰ë˜ë„ë¡ ëŒ€ê¸°
            const btn = document.getElementById('open-listing-form-btn');
            if (btn) {
            // ìˆ˜ë™ í´ë¦­ê³¼ ë™ì¼ ê²½ë¡œë¡œ ì‹¤í–‰ â†’ í¸ì§‘ëª¨ë“œ/UI í† ê¸€ê¹Œì§€ ë™ì¼í•˜ê²Œ ë™ì‘
            btn.click();
            clearInterval(tick);
            return;
            }
            if (Date.now() - started > TIMEOUT) {
            clearInterval(tick);
            console.warn('[autoclick] open-listing-form-btnì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. IDë¥¼ í™•ì¸í•˜ì„¸ìš”.');
            }
        }, 120);
        }
    });

    // ì§„í–‰ì¤‘, ë³´ë¥˜, ê³„ì•½ì™„ë£Œ ì„ íƒ í•„í„°ë§ ê´€ë ¨
    window.__selectFilterMeta = window.__selectFilterMeta || {};
    window.__selectFilterMeta.transaction_status = {
        options: ['ì§„í–‰ì¤‘', 'ë³´ë¥˜', 'ê³„ì•½ì™„ë£Œ']  // DBì— ì‹¤ì œ ë“¤ì–´ê°€ëŠ” ê°’ì— ë§ê²Œ ì¡°ì •
    };

    renderSelectFilter({
        containerId: 'select-filter-wrap',   // ì›í•˜ëŠ” div id
        field: 'transaction_status',         // í…Œì´ë¸” ì»¬ëŸ¼ëª… ê·¸ëŒ€ë¡œ
        label: window.__selectFilterMeta.transaction_status.label,
        options: window.__selectFilterMeta.transaction_status.options
    });

    const setupControlButtons = () => {
        document.getElementById('btn-zoom-in').onclick = () => map.setLevel(map.getLevel() - 1);
        document.getElementById('btn-zoom-out').onclick = () => map.setLevel(map.getLevel() + 1);
        document.getElementById('btn-current-location').onclick = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    map.setCenter(new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude));
                });
            }
        };
        
        document.getElementById('btn-naver-map').onclick = () => {
            const curId = window.currentDetailListingId;
            const l = curId ? allListings?.[String(curId)] : null;

            if (l) {
                const query = getFullAddressForListing(l);
                if (query) {
                window.open(`https://map.naver.com/v5/search/${encodeURIComponent(query)}`, '_blank');
                return;
                }
            }
            // í´ë°±: ì£¼ì†Œê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ì¢Œí‘œ ë°©ì‹ìœ¼ë¡œ
            const c = map.getCenter();
            window.open(`https://map.naver.com/v5/?c=${c.getLng()},${c.getLat()},17,0,0,0,d`, '_blank');
        };


    };
    setupControlButtons();

    document.getElementById('info-panel').addEventListener('scroll', function () {
        if (this.scrollTop + this.clientHeight >= this.scrollHeight - 50) {
            if (matchedListingsPage * PAGE_SIZE < matchedListingsCache.length) {
                matchedListingsPage++;
                renderMatchedListings();
            }
        }
    });

    window.resetFilters = resetFilters;
    
    window.fetchWorkLogs = async function(listingId) {

    const { data, error } = await client
        .from("work_log")
        .select("*")
        .eq("listing_id", listingId)
        .order("Registration_date", { ascending: false });

    if (error) {
        console.error("âŒ ì—…ë¬´ì¼ì§€ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
        renderWorkLogPanel([]);  // ë¹ˆ ìƒíƒœ í‘œì‹œ
        return [];
    }

    // í™”ë©´ì— ì‹¤ì œë¡œ ë Œë”ë§
    renderWorkLogPanel(data);

    // í•„ìš” ì‹œ í˜¸ì¶œë¶€ì—ì„œ í™œìš©í•  ìˆ˜ ìˆë„ë¡ ë°˜í™˜
    return data;
    };

  </script>
  <!-- ì˜¤ë¥¸ìª½ ì•„ë˜ ì•ˆë‚´ì°½ -->
  <div id="toast-container" class="fixed bottom-4 right-4 z-[9999] space-y-2"></div> 
    <!-- í˜¸ìˆ˜ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="unit-modal"
        class="fixed inset-0 z-[21000] bg-black/40 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 w-80">
            <h3 class="font-bold text-lg mb-3">í˜¸ìˆ˜ê°€ ìˆë‚˜ìš”?</h3>
            <input id="unit-modal-input" type="text"
                class="w-full border border-gray-300 rounded px-3 py-2 mb-4"
                placeholder="ì˜ˆ: 109í˜¸" />
            <div class="flex gap-2 justify-end">
            <button id="unit-modal-no"
                    class="px-3 py-1.5 rounded border border-gray-300 text-gray-700 hover:bg-gray-100">
                ì•„ë‹ˆì˜¤
            </button>
            <button id="unit-modal-yes"
                    class="px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700">
                ì˜ˆ
            </button>
            </div>
        </div>
    </div>
</body>
</html>