<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ë°±ì–µì§€ë„ - New Map</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ì¹´ì¹´ì˜¤ ì§€ë„ -->
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f605c7b72dc7f3083f36483e55e2bc77&libraries=clusterer,services"></script>

    <style>
        :root { --header-height: 5rem; }
        body { margin: 0; padding: 0; }
        header {
            position: fixed; top: 0; left: 0; right: 0;
            height: var(--header-height); z-index: 10000;
            background: #fff;
        }
        #map {
            position: absolute;
            top: var(--header-height);
            left: 0; right: 0; bottom: 0;
        }
    </style>

    <!-- ğŸ”¥ Supabase Client -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const supabaseUrl = 'https://sfinbtiqlfnaaarziixu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaW5idGlxbGZuYWFhcnppaXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MDkxNjEsImV4cCI6MjA2ODA4NTE2MX0.4-7vnIjbF-biWWuv9-vTxK9Y99gMm-vS6oaRMdRL5fA';

        window.supabase = createClient(supabaseUrl, supabaseKey, {
            auth: { persistSession: true, autoRefreshToken: true }
        });

        async function enforceAuthForMMap() {
            const { data: { session } } = await window.supabase.auth.getSession();
            if (!session) {
                location.replace("/admin/listings/");
            }
        }

        enforceAuthForMMap();
        
        import { loadListingsFromSupabase, setMarkersOnMap } from './mMap.js';

        window.addEventListener("DOMContentLoaded", async () => {
            // 1) Supabaseì—ì„œ ë§¤ë¬¼ ê°€ì ¸ì˜¤ê¸°
            const listings = await loadListingsFromSupabase();

            // 2) ì§€ë„ì— í‘œì‹œ
            setMarkersOnMap(listings);

            console.log("ë¶ˆëŸ¬ì˜¨ ë§¤ë¬¼ ìˆ˜:", listings.length);
        });
    </script>
</head>

<body>

<header class="flex items-start gap-4 w-full px-4 pt-2 bg-white shadow-md border-b border-gray-200">
    <a href="/admin/listings/">
        <img src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/logotype-baikuk.png"
             alt="ê¸€ì”¨ë¡œê³ " class="h-11 w-auto cursor-pointer" />
    </a>

    <div class="flex flex-col gap-2 mt-1">
        <div class="flex gap-2">
            <button class="px-3 py-1 border border-gray-300 rounded bg-gray-100 text-sm">ì¹´í…Œê³ ë¦¬1</button>
            <button class="px-3 py-1 border border-gray-300 rounded bg-gray-100 text-sm">ì¹´í…Œê³ ë¦¬2</button>
        </div>
    </div>

    <div class="ml-auto flex items-center gap-2">
        <button class="text-sm text-gray-600 hover:text-black border px-3 py-1 rounded">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</header>

<div id="map"></div>

<!-- ğŸ”¥ adminê³¼ ì™„ì „íˆ ë™ì¼í•œ í´ëŸ¬ìŠ¤í„° ë¡œì§ mMap.js ë¶ˆëŸ¬ì˜¤ê¸° -->
<script type="module" src="./mMap.js"></script>

<!-- í…ŒìŠ¤íŠ¸ìš© ë°ì´í„° (ì›í•˜ë©´ ì œê±° ê°€ëŠ¥) -->
<script type="module">
    import { setMarkersOnMap } from './mMap.js';

    const sample = [
        { lat: 37.5665, lng: 126.9780 },
        { lat: 37.5675, lng: 126.9790 },
        { lat: 37.5685, lng: 126.9800 }
    ];

    window.addEventListener("DOMContentLoaded", () => {
        setTimeout(() => setMarkersOnMap(sample), 800);
    });
</script>

</body>
</html>
