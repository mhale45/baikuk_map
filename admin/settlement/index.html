<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>정산</title>
  <link rel="icon" type="image/png" href="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/pabicon-baikuk-simbol.png" />
  <link rel="preconnect" href="https://sfinbtiqlfnaaarziixu.supabase.co" crossorigin>
  <link rel="dns-prefetch" href="//sfinbtiqlfnaaarziixu.supabase.co">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>

</head>
<body class="w-screen overflow-x-hidden">
  <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-[9999] hidden">
    메시지 영역
  </div>
  <div class="absolute top-0 left-0 z-[9998] bg-white w-[13rem] h-[60px] rounded-xl">
    <img src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/logotype-baikuk.png"
        alt="글씨로고"
        class="absolute h-11 w-auto cursor-pointer top-2 left-2 z-[9999]"
        onclick="location.reload()" />
  </div>
  <div class="flex min-h-screen">
    <div class="w-[6%] pt-[5rem] shadow-right text-center bg-white">
      <a href="https://baikuk.com/map" target="_blank">
        <div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">백억지도</div>
      </a>
      <a href="/admin/listings/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">매물장부</div></a>
      <a href="/admin/recommend_imDae/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">임대추천</div></a>
      <a href="/admin/recommend_maeMae/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">매매추천</div></a>
      <a href="/admin/customer_manage/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">모든고객</div></a>
      <a href="/admin/ad_censorship/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">광고관리</div></a>
      <a href="/admin/performance/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">매출</div></a>
      <a href="/admin/staff_manage/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">직원정보</div></a>
      <a id="settlement-tab" href="/admin/settlement/" style="display:none">
        <div class="bg-gray-100 border-l-4 border-gray-500 text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">정산</div>
      </a>
    </div>


    <!-- 어두운 오버레이 -->
    <div id="sales-overlay" class="fixed inset-0 bg-black/30 z-[900] hidden"></div>
  </div>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://sfinbtiqlfnaaarziixu.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaW5idGlxbGZuYWFhcnppaXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MDkxNjEsImV4cCI6MjA2ODA4NTE2MX0.4-7vnIjbF-biWWuv9-vTxK9Y99gMm-vS6oaRMdRL5fA'
    );

    window.supabase = supabase; // 전역으로 접근

    (async () => {
      try {
        // 1) 로그인 세션 확인 (없으면 이동)
        const { data, error } = await supabase.auth.getSession();
        if (error) console.warn("세션 조회 에러:", error);
        if (!data?.session) {
          console.warn("로그인 세션 없음 → /map 으로 이동");
          location.replace("https://baikuk.com/map");
          return;
        }

        // 2) 권한 기반으로 '정산' 탭 표시/숨김
        const guardClick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          alert('직원 권한은 정산 메뉴에 접근할 수 없습니다.');
        };

        const showOrHideSettlementTab = async () => {
          const tab = document.getElementById('settlement-tab');
          if (!tab) return;

          const { data: { user } } = await supabase.auth.getUser();
          if (!user?.id) return;

          const { data: me, error: authErr } = await supabase
            .from('staff_profiles')
            .select('authority')
            .eq('user_id', user.id)
            .maybeSingle();

          if (authErr) {
            console.warn('authority 조회 실패:', authErr);
            return; // 실패 시 기본 숨김 유지
          }

          const role = (me?.authority || '').trim();
          if (role === '직원') {
            // 직원: 숨김(기본값 유지) + 안전 가드
            tab.style.display = 'none';
            tab.addEventListener('click', guardClick, { once: true });
          } else {
            // 관리자/지점장: 표시
            tab.style.removeProperty('display');
          }
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', showOrHideSettlementTab, { once: true });
        } else {
          showOrHideSettlementTab();
        }
      } catch (e) {
        console.warn('세션/정산 탭 처리 중 예외:', e);
      }
    })();

  </script>
</body>
</html>
