<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì„ëŒ€ì¶”ì²œ</title>
  <link rel="icon" type="image/png" href="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/pabicon-baikuk-simbol.png" />
  <link rel="preconnect" href="https://sfinbtiqlfnaaarziixu.supabase.co" crossorigin>
  <link rel="dns-prefetch" href="//sfinbtiqlfnaaarziixu.supabase.co">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    let currentCustomerId = null; // ì „ì—­ ë³€ìˆ˜ë¡œ ì¶”ê°€
  </script>
  <style>
    /* === print ì „ìš© ì„¤ì • === */
    @media print {
      @page { size: A4 landscape; margin: 12mm; }
      html, body { margin:0 !important; padding:0 !important; }

      /* body ì§ê³„/í›„ì† ì „ë¶€ ìˆ¨ê¹€ */
      body > * { display: none !important; }

      /* ì¸ì‡„ í¬í„¸ë§Œ í‘œì‹œ */
      #print-portal { 
        display: block !important; 
        position: static !important;
        width: 100% !important; 
        margin: 0 !important; 
        padding: 0 !important;
      }
      #print-portal table { width: 100% !important; table-layout: fixed; border-collapse: collapse; }
      #print-portal th, #print-portal td { border: 1px solid #ccc; padding: 4px; font-size: 12px; text-align: center; }
      #print-portal thead { background: #f3f4f6; position: static !important; }

      /* ìƒ‰/ë°°ê²½ ì¶œë ¥ */
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
  <style>
    .shadow-right {
      box-shadow: 8px 0 12px -4px rgba(0, 0, 0, 0.08);
    }
    /* === ì—´ ë¦¬ì‚¬ì´ì¦ˆ: ë§¤ë§¤ì¶”ì²œ í˜ì´ì§€ì™€ ë™ì¼ ìŠ¤íƒ€ì¼ === */
    th.resizable {
      position: relative;
      min-width: 40px;
      white-space: nowrap;
    }
    .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      width: 0.4rem;
      height: 100%;
      cursor: col-resize;
      z-index: 10;
      background-color: transparent;
    }
    .customer-item {
      position: relative;
      padding: 0.5rem 0.5rem; /* ìœ„ì•„ë˜/ì¢Œìš° ì—¬ë°± ì¦ê°€ */
      margin-bottom: 0.25rem;  /* í•­ëª© ì‚¬ì´ ê°„ê²© */
      border-radius: 0.25rem;  /* ëª¨ì„œë¦¬ ì‚´ì§ ë‘¥ê¸€ê²Œ (ì„ íƒ) */
    }
    .customer-item:hover .customer-delete-btn {
      display: block;
    }
    .customer-item:active { background-color: #fde68a; } /* ëˆŒë €ì„ ë•Œ ì‚´ì§ ë” ì§„í•˜ê²Œ */
    .grade-header {
      background-color: #e5e7eb; /* bg-yellow-100 ê°™ì€ íš¨ê³¼ */
      color: #000000;           /* ì§„í•œ ì£¼í™©ìƒ‰ ê¸€ì”¨ */
      font-weight: bold;
      padding: 0.5rem;
      border-radius: 0.25rem;
      margin-top: 0.5rem;
    }
    .name-item {
      font-size: 0.9rem;
      color: #374151;           /* text-gray-700 */
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      cursor: pointer;
      margin-bottom: 0.4rem;
    }
    .name-item:hover {
      background-color: #fef9c3; /* hover:bg-yellow-100 */
    }

  </style>
  <style>
    /* í…Œì´ë¸” ì „ì²´ + ì…€ í…Œë‘ë¦¬ */
    table {
      border-collapse: collapse; /* í…Œë‘ë¦¬ ê²¹ì¹¨ ì œê±° */
      width: 50rem;
      table-layout: fixed;
    }

    table, th, td {
      border: 1px solid #ccc; /* ì—°í•œ íšŒìƒ‰ í…Œë‘ë¦¬ */
    }

    th, td {
      padding: 0.25rem; /* p-1 ì •ë„ */
      text-align: center;
      font-size: 0.875rem; /* text-sm */
    }

    /* í—¤ë” ìŠ¤íƒ€ì¼ */
    thead {
      background-color: #f3f4f6; /* bg-gray-100 */
      position: sticky;
      top: 0;
      z-index: 10;
    }

    /* ì§ìˆ˜/í™€ìˆ˜ ì¤„ ë°°ê²½ */
    tbody tr:nth-child(odd) {
      background-color: white;
    }
    tbody tr:nth-child(even) {
      background-color: #f9fafb; /* bg-gray-50 */
    }
  </style>
</head>
<body class="w-screen overflow-y-hidden min-h-screen overflow-x-auto">
  <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-[9999] hidden">
    ë©”ì‹œì§€ ì˜ì—­
  </div>
  <div class="absolute top-0 left-0 z-[9998] bg-white w-[13rem] h-[60px] rounded-xl">
    <img src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/logotype-baikuk.png"
        alt="ê¸€ì”¨ë¡œê³ "
        class="absolute h-11 w-auto cursor-pointer top-2 left-2 z-[9999]"
        onclick="location.reload()" />
  </div>
  <div class="flex min-h-screen">
    <div class="w-[6%] pt-[5rem] shadow-right text-center bg-white">
      <a href="https://baikuk.com/map" target="_blank">
        <div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">ë°±ì–µì§€ë„</div>
      </a>
      <a href="/admin/listings/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë§¤ë¬¼ì¥ë¶€</div></a>
      <a href="/admin/recommend_imDae/"><div class="bg-gray-100 border-l-4 border-gray-500 text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ì„ëŒ€ì¶”ì²œ</div></a>
      <a href="/admin/recommend_maeMae/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë§¤ë§¤ì¶”ì²œ</div></a>
      <a href="/admin/customer_manage/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">ëª¨ë“ ê³ ê°</div></a>
      <a href="/admin/ad_censorship/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ê´‘ê³ ê´€ë¦¬</div></a>
      <a href="/admin/staff_manage/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ì§ì›ì •ë³´</div></a>
      <a href="/admin/performance/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë§¤ì¶œ</div></a>
      <a href="/admin/cost_management/"><div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer">ë¹„ìš©</div></a>
      <a id="settlement-tab" href="/admin/settlement/" style="display:none">
        <div class="text-lg font-extrabold px-2 py-1 rounded hover:bg-gray-200 cursor-pointer mb-5">ì •ì‚°</div>
      </a>
    </div>
    <div id="customer-col" class="bg-gray-100 w-[14%] pt-[5rem] shadow-right relative z-[10] text-left">
      <div id="customer-list" class="overflow-y-auto max-h-[calc(100vh-5rem)]">
        <!-- ì—¬ê¸°ì— ê³ ê° ì´ë¦„ë“¤ì´ í‘œì‹œë©ë‹ˆë‹¤ -->
      </div>
    </div>
    <div class="w-[84%] flex flex-col bg-gray-100 overflow-y-auto min-h-0 h-screen">
      <div class="mt-[2rem] flex px-3 bg-gray-100">
        <div class="text-left text-base rounded outline-none resize-none">
          <textarea
            placeholder="ê³ ê°ì´ë¦„"
            class="border border-gray-300 px-2 rounded ml-1 w-full text-left text-base resize-none"
            id="top-row-input"
            rows="2"
          ></textarea>
          <div class="flex mt-[0.5rem]">
            <button id="delete-customer" class="ml-1 h-[2.3rem] bg-rose-500 hover:bg-rose-600 text-white text-sm px-4 py-1 rounded font-bold">
              ì†ë‹˜ì‚­ì œ
            </button>
            <button id="save-new-customer" class="ml-auto h-[2.3rem] bg-blue-500 hover:bg-blue-600 text-white text-sm px-4 py-1 rounded font-bold">
              ì†ë‹˜ì €ì¥
            </button>
          </div>
          <div class="flex mt-[0.5rem]">
            <div class="flex">
              <div class="ml-1 mt-1">êµ¬ë¶„:</div>
              <select id="customer-grade" class="ml-1 px-1 h-[2rem] text-left box-border border border-gray-300 rounded text-base">
                <option >A</option>
                <option >B</option>
                <option >C</option>
                <option >F</option>
              </select>
            </div>
            <input id="customer-phone" placeholder="ì „í™”ë²ˆí˜¸" class="w-[13rem] ml-auto px-1 h-[2rem] text-left box-border border border-gray-300 rounded text-base">
          </div>
          <textarea id="memo-textarea" placeholder="ë©”ëª¨" class="mt-[0.5rem] ml-1 px-1 pt-1 w-[20rem] h-[47rem] box-border text-left text-base border border-gray-300 rounded bg-white outline-none resize-none"></textarea>
        </div>
        <div class="ml-3 mt-[1rem] flex flex-col">
          <div class="mb-2 text-right flex gap-2 justify-end">
            <button id="print-btn" class="h-[2rem] bg-neutral-500 hover:bg-neutral-600 text-white text-sm px-4 py-1 rounded">
              ğŸ–¨ï¸
            </button>
            <button id="copy-link-btn" class="h-[2rem] bg-[#F2C130] hover:bg-[#E0B120] text-black font-bold px-3 py-1 rounded mr-2">
              ë§í¬
            </button>
          </div>
          <div class="pt-2 px-2 py-2bg-white border border-gray-300 rounded-md"> <!-- ë§¤ë¬¼ë²ˆí˜¸ í…Œì´ë¸” ì „ì²´ -->
            <div class="mb-2 text-right flex gap-2 justify-end">
              <button id="clear-left-btn" class="h-[2rem] bg-rose-500 hover:bg-rose-600 text-white font-bold text-sm px-1 py-1 rounded">
                ì§€ìš°ê¸°
              </button>
              <button id="toggle-edit-btn" class="h-[2rem] bg-blue-500 hover:bg-blue-600 text-white font-bold text-sm px-3 py-1 rounded">
                ì €ì¥
              </button>
            </div>
            <div id="table-container" class="border rounded-md">
              <table class="w-[7rem] text-sm text-left">
                <thead class="bg-gray-100 sticky top-0 z-10">
                  <tr id="header-row">
                    <th class="p-1 font-bold text-base text-center">ë§¤ë¬¼ë²ˆí˜¸</th>
                  </tr>
                </thead>
                <tbody id="left-tbody" class="bg-white">
                </tbody>
              </table>
            </div>
          </div>
        </div>        
        <div class="ml-1 px-4 py-4 bg-white rounded-md self-start">
          <div id="table-container" class="custom-scroll bg-white rounded-md">
            <div id="print-block">              
              <div class="flex items-end mb-2 gap-3">
                <img
                  src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/biakuk-images//baikuk-logo-yellow_simbol_name.png"
                  alt="ë°±ì–µë¡œê³ "
                  class="w-[25rem]"
                />
                <div class="justify-between items-end mb-2">
                  <!-- ë‚ ì§œ -->
                  <div id="today-date" class="text-gray-600 text-sm font-semibold"></div>
                  <!-- ë‹´ë‹¹ì -->
                  <div id="staff-info-container" class="text-gray-800 text-lg font-semibold">
                    <div id="staff-info" class="hidden"></div>
                    <select id="staff-select" class="hidden border border-gray-300 rounded px-2 py-1 text-base"></select>
                  </div>
                </div>
              </div>
              <table>
                <thead>
                  <tr id="header-row">
                    <th class="resizable" style="width: 1.4rem;">
                      <div class="resize-handle"></div>
                    </th>
                    <th class="resizable" style="width: 10rem;">
                      ë§¤ë¬¼ëª… <div class="resize-handle"></div>
                    </th>
                    <th class="resizable" style="width: 9rem;">
                      ì£¼ì†Œ <div class="resize-handle"></div>
                    </th>
                    <th class="resizable" style="width: 9rem;">
                      ê±´ë¬¼ì •ë³´ <div class="resize-handle"></div>
                    </th>
                    <th class="resizable" style="width: 5.2rem;">
                      ë³´ì¦ê¸ˆ <div class="resize-handle"></div>
                    </th>
                    <th class="resizable" style="width: 3.8rem;">
                      ì›”ì„¸ <div class="resize-handle"></div>
                    </th>
                    <th class="resizable" style="width: 5.2rem;">
                      ê¶Œë¦¬ê¸ˆ <div class="resize-handle"></div>
                    </th>
                    <th class="resizable" style="width: 4.7rem;">
                      ì „ìš©(í‰) <div class="resize-handle"></div>
                    </th>
                    <th class="resizable" style="width: 15rem;">
                      ë‚´ìš© <div class="resize-handle"></div>
                    </th>
                  </tr>
                </thead>
                <tbody id="listings-body"></tbody>
              </table>
            </div>  
          </div>
        </div>
        <div class="ml-3 mt-[6.2rem] flex flex-col">
          <div class="pt-2 px-2 py-2 bg-white border border-gray-300 rounded-md">
            <!-- ì˜¤ë¥¸ìª½(ìŠ¤í¬ë¦°ìƒ· ì œì™¸) ë©”ëª¨ í‘œ -->
            <div id="memo-panel" class="print:hidden sticky top-2">
              <table class="w-[16rem] border-collapse">
                <thead>
                  <tr>
                    <td class="p-1 border-b border-gray-200 align-top">
                      ë©”ëª¨
                    </th>
                  </tr>
                </thead>
                <tbody id="memo-body"></tbody>
              </table>
            </div>
          </div>
        </div>          
      </div>
    </div>
  </div>  
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://sfinbtiqlfnaaarziixu.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaW5idGlxbGZuYWFhcnppaXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MDkxNjEsImV4cCI6MjA2ODA4NTE2MX0.4-7vnIjbF-biWWuv9-vTxK9Y99gMm-vS6oaRMdRL5fA'
    );

    (async () => {
      try {
        // 1) ë¡œê·¸ì¸ ì„¸ì…˜ í™•ì¸ (ì—†ìœ¼ë©´ ì´ë™)
        const { data, error } = await supabase.auth.getSession();
        if (error) console.warn("ì„¸ì…˜ ì¡°íšŒ ì—ëŸ¬:", error);
        if (!data?.session) {
          console.warn("ë¡œê·¸ì¸ ì„¸ì…˜ ì—†ìŒ â†’ /map ìœ¼ë¡œ ì´ë™");
          location.replace("https://baikuk-map.netlify.app/admin/listings/");
          return;
        }

        // 2) ê¶Œí•œ ê¸°ë°˜ìœ¼ë¡œ 'ì •ì‚°' íƒ­ í‘œì‹œ/ìˆ¨ê¹€
        const guardClick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          alert('ì§ì› ê¶Œí•œì€ ì •ì‚° ë©”ë‰´ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        };

        const showOrHideSettlementTab = async () => {
          const tab = document.getElementById('settlement-tab');
          if (!tab) return;

          const { data: { user } } = await supabase.auth.getUser();
          if (!user?.id) return;

          const { data: me, error: authErr } = await supabase
            .from('staff_profiles')
            .select('authority')
            .eq('user_id', user.id)
            .maybeSingle();

          if (authErr) {
            console.warn('authority ì¡°íšŒ ì‹¤íŒ¨:', authErr);
            return; // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ìˆ¨ê¹€ ìœ ì§€
          }

          const role = (me?.authority || '').trim();
          if (role === 'ì§ì›') {
            // ì§ì›: ìˆ¨ê¹€(ê¸°ë³¸ê°’ ìœ ì§€) + ì•ˆì „ ê°€ë“œ
            tab.style.display = 'none';
            tab.addEventListener('click', guardClick, { once: true });
          } else {
            // ê´€ë¦¬ì/ì§€ì ì¥: í‘œì‹œ
            tab.style.removeProperty('display');
          }
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', showOrHideSettlementTab, { once: true });
        } else {
          showOrHideSettlementTab();
        }
      } catch (e) {
        console.warn('ì„¸ì…˜/ì •ì‚° íƒ­ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸:', e);
      }
    })();

    window.supabase = supabase; // ì „ì—­ìœ¼ë¡œ ì ‘ê·¼
  </script>
  <script>
    // === í–‰ ê´€ì°°ìš© ì „ì—­ ===
    let listingsBody;          // tbody ìºì‹œ
    let rowObserver;           // ResizeObserver ì¸ìŠ¤í„´ìŠ¤

    // ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘
    function renderMemoPanel(listings = []) {
      const memoBody = document.getElementById('memo-body');
      if (!memoBody) return;
      memoBody.innerHTML = '';

      // order â†’ memo ë§¤í•‘ (orderê°€ ì—†ìœ¼ë©´ ì¸ë±ìŠ¤ë¡œ ê°€ì •)
      const memoMap = new Map();
      listings.forEach((it, idx) => {
        const order = (typeof it.order === 'number' && !Number.isNaN(it.order)) ? it.order : (idx + 1);
        memoMap.set(order, typeof it.memo === 'string' ? it.memo : '');
      });

      for (let i = 1; i <= 50; i++) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-1 border-b border-gray-200 align-top">
            <div class="flex items-start gap-2">
              <div class="text-gray-400 w-5 text-right select-none">${i}</div>
              <textarea
                class="w-[11rem] resize-none outline-none bg-transparent text-sm align-top box-border p-1"
                data-memo-index="${i}"
                placeholder="ë©”ëª¨ ì…ë ¥"
                rows="1"
                style="height:auto; min-height:0"
              ></textarea>
            </div>
          </td>
        `;
        memoBody.appendChild(tr);

        // ì €ì¥ëœ ê°’ ìˆìœ¼ë©´ ì±„ì›€
        const ta = tr.querySelector('textarea[data-memo-index]');
        const val = memoMap.get(i);
        if (ta && typeof val === 'string') ta.value = val;
      }

      syncMemoRowHeights();
    }

    /** í˜„ì¬ í™”ë©´ì˜ ë©”ëª¨ Ní–‰ì—ì„œ ë¬¸ìì—´ì„ ì½ì–´ì˜´ (ì—†ìœ¼ë©´ ë¹ˆë¬¸ìì—´) */
    function getMemoValue(index) {
      const el = document.querySelector(`textarea[data-memo-index="${index}"]`);
      return (el?.value || '').trim();
    }

    // === [ì €ì¥ ê°œì„ ] ë‹¨ìˆœ ë®ì–´ì“°ê¸° ëª¨ë‹¬ ===
    const OverwriteModal = {
      root: null,
      btnOverwrite: null,
      btnCancel: null,
      targetId: null,
    };

    function initOverwriteModalRefs() {
      OverwriteModal.root = document.getElementById('dup-customer-modal');
      OverwriteModal.btnOverwrite = document.getElementById('dup-overwrite');
      OverwriteModal.btnCancel = document.getElementById('dup-cancel');
    }

    function openOverwriteModal(targetId, onConfirm) {
      if (!OverwriteModal.root) initOverwriteModalRefs();
      OverwriteModal.targetId = targetId;

      // ë²„íŠ¼ í•¸ë“¤ëŸ¬ ì¬ë°”ì¸ë”©
      OverwriteModal.btnOverwrite.onclick = async () => {
        try { await onConfirm?.(OverwriteModal.targetId); }
        finally { closeOverwriteModal(); }
      };
      OverwriteModal.btnCancel.onclick = () => closeOverwriteModal();

      OverwriteModal.root.classList.remove('hidden');
      OverwriteModal.root.classList.add('flex');
    }

    function closeOverwriteModal() {
      if (!OverwriteModal.root) initOverwriteModalRefs();
      OverwriteModal.root.classList.add('hidden');
      OverwriteModal.root.classList.remove('flex');
      OverwriteModal.targetId = null;
    }

    // í˜„ì¬ ìˆëŠ” ëª¨ë“  í–‰ì„ ê´€ì°°
    function observeRows() {
      if (!listingsBody) return;
      if (!rowObserver) return;
      rowObserver.disconnect();
      listingsBody.querySelectorAll('tr').forEach(tr => rowObserver.observe(tr));
    }

    // âœ… data-field ê°’ì„ (span / input / textarea ëª¨ë‘ì—ì„œ) ì•ˆì „í•˜ê²Œ ì½ê¸°
    function getFieldValue(field, index) {
      const sel = `[data-field="${field}_${index}"]`;
      const el = document.querySelector(sel);
      if (!el) return '';
      if (el.tagName === 'SPAN') return (el.textContent || '').trim();
      return (el.value || '').trim();
    }

    // âœ… ì™¼ìª½ ë§¤ë¬¼ë²ˆí˜¸ inputì—ì„œ ë²ˆí˜¸ ì½ê¸°
    function getListingNumber(index) {
      const input = document.querySelector(`input[data-index="${index}"]`);
      return (input?.value || '').trim();
    }

    // âœ… ëˆ í¬ë§· ë˜ì–´ ìˆëŠ” ë¬¸ìì—´ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ(â€˜ì–µ 2,000â€™ ë“±ë„ í—ˆìš©) â†’ ë‹¤ì‹œ ì›ë˜ ë¬¸ìì—´ ê·¸ëŒ€ë¡œ ì“°ê¸¸ ì›í•˜ë©´ ì´ ë¶€ë¶„ ì¡°ì •
    const stripEmpty = (s) => (s || '').trim();
    // (êµì²´) ë³´ì¦ê¸ˆ/ì›”ì„¸ ë¼ë²¨ì„ ë¶™ì—¬ì„œ í•©ì„±
    function joinMoney(deposit, monthly) {
      const a = (deposit || '').trim(); // ì˜ˆ: "1ì–µ 5,000"
      const b = (monthly || '').trim(); // ì˜ˆ: "800"
      const aL = a ? `${a}` : '';
      const bL = b ? `${b}`   : '';
      if (a && b) return `${aL}/${bL}`;
      return aL || bL || '';
    }

    // âœ… í•´ë‹¹ í–‰ì— â€œì˜ë¯¸ ìˆëŠ” ê°’â€ì´ í•˜ë‚˜ë¼ë„ ìˆëŠ”ì§€ í™•ì¸ (ë²ˆí˜¸ ì œì™¸)
    function hasMeaningfulData(index) {
      const keys = [
        'listing_title', 'full_address', 'combined_unit', 'deposit_price',
        'monthly_rent', 'premium_price', 'area_py', 'description'
      ];
      return keys.some(k => !!getFieldValue(k, index));
    }

    // âœ… í•œ í–‰ì„ ë©”ì‹œì§€ 4ì¤„ë¡œ ë³€í™˜
    function buildMessageForRow(index) {
      const no     = getListingNumber(index) || '';
      const title  = getFieldValue('listing_title', index) || '-';
      const addr   = getFieldValue('full_address', index) || '-';
      const unit   = getFieldValue('combined_unit', index) || '-';
      const dep    = getFieldValue('deposit_price', index);
      const mon    = getFieldValue('monthly_rent', index);
      const prem   = getFieldValue('premium_price', index);
      const area   = getFieldValue('area_py', index);
      const desc   = getFieldValue('description', index);

      // 1í–‰/2í–‰
      const line1 = `${title}`.trim();
      const line2 = `${addr} ${unit}`.trim();

      // 3í–‰
      const areaPart   = area ? `${area}í‰` : '';
      const moneyPair  = joinMoney(dep, mon);   // ë³´ì¦ê¸ˆ/ì›”ì„¸
      const premiumTag = prem ? `ê¶Œ${prem}` : '';
      const parts = [areaPart, moneyPair, premiumTag].filter(Boolean);
      const line3 = parts.join(' ');

      // 4í–‰: ì„¤ëª…
      const line4 = desc || '';

      // 5í–‰: URL (ë§¤ë¬¼ë²ˆí˜¸ ìˆì„ ë•Œë§Œ)
      const baseUrl = "baikuk.com/item/view/";
      const line5 = no ? `${baseUrl}${no}` : '';

      const lines = [line1, line2, line3, line4, line5].filter(l => l !== '');
      return lines.join('\n');
    }


    // âœ… ì „ì²´ í–‰ì„ í›‘ì–´ í…ìŠ¤íŠ¸ ìƒì„±
    function buildAllMessages() {
      const rows = document.querySelectorAll('#listings-body tr');
      const blocks = [];
      rows.forEach((_, i) => {
        const idx = i + 1; // ì‹¤ì œ index
        if (hasMeaningfulData(idx) || getListingNumber(idx)) {
          const msg = buildMessageForRow(idx);
          if (msg) {
            // ğŸ”¹ ì•ì— ìˆœì„œ ë²ˆí˜¸ ë¶™ì´ê¸°
            blocks.push(`${blocks.length + 1}.\n${msg}`);
          }
        }
      });
      return blocks.join('\n\n'); // í–‰ê³¼ í–‰ ì‚¬ì´ ë¹ˆ ì¤„
    }

    // âœ… í´ë¦½ë³´ë“œ ë³µì‚¬ (í‘œì¤€ + í´ë°±)
    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        showToast('ë§í¬ìš© ë¬¸êµ¬ë¥¼ ë³µì‚¬í–ˆì–´ìš”.');
      } catch {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        try {
          document.execCommand('copy');
          showToast('ë§í¬ìš© ë¬¸êµ¬ë¥¼ ë³µì‚¬í–ˆì–´ìš”.');
        } catch {
          showToast('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
        }
        document.body.removeChild(ta);
      }
    }
    
    // í‡´ì‚¬ì ì•ˆë³´ì´ëŠ” ê´€ë ¨ì½”ë“œ
    // âœ… ë‚´ ê¶Œí•œ/ì†Œì† ì¡°íšŒ
    async function getAuthContext() {
      const { data: { user }, error: userError } = await supabase.auth.getUser();
      if (userError || !user) return { me: null, myAuth: null, myAff: null };

      const { data: me, error: meErr } = await supabase
        .from('staff_profiles')
        .select('id, authority, affiliation')
        .eq('user_id', user.id)
        .maybeSingle();

      return {
        me,
        myAuth: me?.authority ?? null,      // 'ê´€ë¦¬ì' | 'ì§€ì ì¥' | 'ì§ì›'
        myAff: (me?.affiliation ?? '').trim()
      };
    }

    // âœ… ì§ì› ëª©ë¡ ë¡œë”© (ê¶Œí•œë³„ í‡´ì‚¬ì í‘œì‹œ ì œì–´)
    async function loadStaffOptions(currentStaffId = null) {
      const staffSelect = document.getElementById('staff-select');
      if (!staffSelect) return;
      staffSelect.innerHTML = '';

      // ê¶Œí•œ/ì†Œì†
      const { me, myAuth, myAff } = await getAuthContext();
      if (!me) return;

      // 1) ê¸°ë³¸ ì¿¼ë¦¬
      let q = supabase
        .from('staff_profiles')
        .select('id, name, affiliation, leave_date')
        .order('affiliation', { ascending: true })
        .order('name', { ascending: true });

      // 2) ê¶Œí•œì´ 'ì§ì›'ì´ë©´ í‡´ì‚¬ì ì œì™¸
      if (myAuth === 'ì§ì›') {
        q = q.is('leave_date', null);
      }

      const { data: staffList, error: staffErr } = await q;
      if (staffErr || !staffList) return;

      // ë‚´ê°€ ë¡œê·¸ì¸í•œ staff id
      const myStaffId = me.id;

      // 3) ì†Œì†ë³„ ê·¸ë£¹í™”
      const grouped = staffList.reduce((acc, s) => {
        (acc[s.affiliation || 'ë¯¸ì§€ì •'] ||= []).push(s);
        return acc;
      }, {});

      const appendGroup = (label, members) => {
        if (!members?.length) return;
        const og = document.createElement('optgroup');
        og.label = label;
        members.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.id;
          const retiredTag = (myAuth !== 'ì§ì›' && s.leave_date) ? ' (í‡´ì‚¬)' : '';
          opt.textContent = `${s.name}${retiredTag}`;

          // âœ… ìš°ì„ ìˆœìœ„: currentStaffId â†’ ì—†ìœ¼ë©´ ë‚´ staff id
          if ((currentStaffId && s.id === currentStaffId) || (!currentStaffId && s.id === myStaffId)) {
            opt.selected = true;
          }

          og.appendChild(opt);
        });
        staffSelect.appendChild(og);
      };

      if (myAff && grouped[myAff]) {
        appendGroup(`${myAff} (ê°™ì€ ì†Œì†)`, grouped[myAff]);
        delete grouped[myAff];
      }

      Object.entries(grouped).forEach(([aff, members]) => {
        appendGroup(aff, members);
      });
    }


    // ì²«ë¡œë“œì‹œ ì§ì›í‘œì‹œ í•¨ìˆ˜
    async function loadCurrentUserStaffInfo() {
      const {
        data: { user },
        error
      } = await supabase.auth.getUser();

      if (error || !user) return;

      const userId = user.id;

      // staff_profiles í…Œì´ë¸”ì—ì„œ í•´ë‹¹ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
      const { data: staff } = await supabase
        .from('staff_profiles')
        .select('position, name, phone_num')
        .eq('user_id', userId) // í˜¹ì€ eq('id', userId) â†’ ì‹¤ì œ êµ¬ì¡°ì— ë”°ë¼ ë³€ê²½
        .maybeSingle();

      if (staff) {
        const staffInfoBox = document.getElementById('staff-info');
        staffInfoBox.textContent = `${staff.position} ${staff.name} ${staff.phone_num}`;
        staffInfoBox.classList.remove('hidden');
        document.getElementById('staff-select').classList.add('hidden');
      }
    }

    // âœ… ë‚´ staff_profiles.id ê°€ì ¸ì˜¤ê¸°
    async function getMyStaffId() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return null;
      const { data: me } = await supabase
        .from('staff_profiles')
        .select('id')
        .eq('user_id', user.id)
        .maybeSingle();
      return me?.id ?? null;
    }

    // âœ… ë‚´ê°€(ëŒ€í‘œ/ë³´ì¡°) ë°°ì •ëœ ê³ ê°ì¸ì§€ í™•ì¸ (ê³ ê°-ë‹´ë‹¹ ë§í¬ OR customers.staff_profiles_id)
    async function isMyAssignedCustomer(customerId) {
      const myId = await getMyStaffId();
      if (!myId || !customerId) return false;

      const [{ data: link }, { data: cust }] = await Promise.all([
        supabase
          .from('customer_assignees')
          .select('customer_id')
          .eq('customer_id', customerId)
          .eq('staff_profiles_id', myId)
          .maybeSingle(),
        supabase
          .from('customers')
          .select('id, staff_profiles_id')
          .eq('id', customerId)
          .maybeSingle()
      ]);

      return !!link || (!!cust && cust.staff_profiles_id === myId);
    }

    // ì†ë‹˜ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜ (ëŒ€í‘œ/ë³´ì¡° ë‘˜ ë‹¤ ì ‘ê·¼ ê°€ëŠ¥)
    async function loadCustomerDataByName(name) {
      const myId = await getMyStaffId();
      if (!myId) { showToast('ë¡œê·¸ì¸ í•„ìš”'); return; }

      // 1) ì´ë¦„ìœ¼ë¡œ ê³ ê° 1ëª… ì°¾ê¸° (ì¡°ì¸ X)
      const { data: customer, error: custError } = await supabase
        .from('customers')
        .select('id, customer_name, customer_phone_number, grade, memo, staff_profiles_id')
        .eq('customer_name', name)
        .maybeSingle();

      if (custError || !customer) {
        console.warn('âŒ ê³ ê° ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', custError);
        showToast('ê³ ê° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // 2) ì ‘ê·¼ ê¶Œí•œ ì²´í¬ (ëŒ€í‘œ ë˜ëŠ” ë³´ì¡°)
      const allowed = (customer.staff_profiles_id === myId) || (await isMyAssignedCustomer(customer.id));
      if (!allowed) {
        showToast('ë‹´ë‹¹ìê°€ ì•„ë‹Œ ê³ ê°ì€ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      currentCustomerId = customer.id;

      // ğŸ‘‰ ìš°ì¸¡ ì •ë³´ì°½ ì±„ìš°ê¸°
      document.getElementById('top-row-input').value = customer.customer_name || '';
      document.getElementById('customer-phone').value = customer.customer_phone_number || '';
      document.getElementById('customer-grade').value = customer.grade || 'F';
      document.getElementById('memo-textarea').value = customer.memo || '';

      // ğŸ‘‰ ì™¼ìª½ ë§¤ë¬¼ë²ˆí˜¸ ì…ë ¥ì°½ ì´ˆê¸°í™”
      document.querySelectorAll('input[data-index]').forEach(input => input.value = '');

      // ğŸ‘‰ ì˜¤ë¥¸ìª½ ë§¤ë¬¼ì…ë ¥ í…Œì´ë¸” ì´ˆê¸°í™”
      const listingsBody = document.getElementById('listings-body');
      listingsBody.innerHTML = '';

      // âœ… ì¶”ì²œ ë§¤ë¬¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (text ì»¬ëŸ¼ ë§ì¶° ë¬¸ìì—´ë¡œ ë¹„êµ + ì •ë ¬ ì •ë¦¬)
      const { data: listings, error: listingsError } = await supabase
        .from('customers_recommendations')
        .select('*')
        .eq('customers_id', String(currentCustomerId)) // â† íƒ€ì… ë§ì¶¤(ì¤‘ìš”)
        .order('order', { ascending: true, nullsFirst: false }) // order ë¨¼ì €, NULLì€ ë’¤ë¡œ
        .order('id', { ascending: true });                      // NULL ë¬¶ìŒ ë‚´ë¶€ëŠ” id ASC

      if (listingsError) {
        console.warn('âŒ ì¶”ì²œ ë§¤ë¬¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', listingsError);
        showToast('ì¶”ì²œ ë§¤ë¬¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      // (êµì²´) order ê°’ ìˆìœ¼ë©´ ê·¸ ìë¦¬ë¥¼ ì“°ê³ , NULLì´ë©´ nextIndexë¡œ ìˆœì„œ ìœ ì§€
      let nextIndex = 1;

      listings.forEach((listing) => {
        // 1) ì¸ë±ìŠ¤ ê²°ì •
        const index = (typeof listing.order === 'number' && !Number.isNaN(listing.order))
          ? listing.order          // orderê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
          : nextIndex++;           // orderê°€ NULLì´ë©´ ì˜ˆì „ì²˜ëŸ¼ ìˆœì„œëŒ€ë¡œ

        // 2) ì™¼ìª½ ë§¤ë¬¼ë²ˆí˜¸ ì±„ìš°ê¸°
        const leftInput = document.querySelector(`input[data-index="${index}"]`);
        if (leftInput) leftInput.value = listing.listing_id ?? '';

        // 3) ì˜¤ë¥¸ìª½ í‘œ í–‰ í™•ë³´/í™•ì¥
        updateListingsTableByInputs();

        // 4) í•„ë“œ ì£¼ì…
        const setField = (field, value) => {
          const el = document.querySelector(`[data-field="${field}_${index}"]`);
          if (!el) return;
          if (el.tagName === 'SPAN') el.textContent = value ?? '';
          else el.value = value ?? '';
        };

        setField('listing_title', cleanListingTitle(listing.listing_title));
        setField('full_address', listing.full_address);
        setField('combined_unit', listing.building_detail_info);
        setField('deposit_price', listing.deposit_price);
        setField('monthly_rent', listing.monthly_rent);
        setField('premium_price', listing.premium_price);
        setField('area_py', listing.area_py);
        setField('description', listing.contents);

        // 5) nextIndex ë³´ì •: orderê°€ ìˆëŠ” ë ˆì½”ë“œë¼ë©´ ë‹¤ìŒ NULL ë¼ì›Œë„£ê¸°ê°€
        //    ê²¹ì¹˜ì§€ ì•Šë„ë¡ nextIndexë¥¼ í•­ìƒ 'ìµœëŒ€ ì‚¬ìš© ì¸ë±ìŠ¤ + 1'ë¡œ ë§ì¶°ì¤ë‹ˆë‹¤.
        if (typeof listing.order === 'number' && !Number.isNaN(listing.order)) {
          nextIndex = Math.max(nextIndex, listing.order + 1);
        }
      });

      // ë†’ì´/ìŠ¤íŠ¸ë¼ì´í”„ ì •ë¦¬
      renderMemoPanel(listings);
      syncRowHeights?.();
      applyRowStriping?.();
      showToast(`ê³ ê° "${name}" ë°ì´í„° ë¶ˆëŸ¬ì˜´`);

      // ë¬´ì¡°ê±´ ì½ê¸°ëª¨ë“œë¡œ ì •ë¦¬
      if (isEditMode) {
        toggleButton.click();
        switchInputsToSpans();
      }
      switchInputsToSpans();

      // --- ğŸ‘‡ ë‹´ë‹¹ì í…ìŠ¤íŠ¸ í‘œì‹œ (ì½ê¸°ëª¨ë“œìš©) ---
      const staffInfoBox = document.getElementById('staff-info');
      if (customer.staff_profiles_id) {
        const { data: staff } = await supabase
          .from('staff_profiles')
          .select('position, name, phone_num')
          .eq('id', customer.staff_profiles_id)
          .maybeSingle();

        if (staff && staffInfoBox) {
          staffInfoBox.textContent = `${staff.position} ${staff.name} ${staff.phone_num}`;
          staffInfoBox.classList.remove('hidden');
          document.getElementById('staff-select').classList.add('hidden');
        }
      }

    }


    // ì™¼ìª½íŒ¨ë„ì— ì†ë‹˜ì´ë¦„ ë¡œë”©í•¨ìˆ˜ (ëŒ€í‘œ/ë³´ì¡° ì „ë¶€, ë“±ê¸‰ ì œí•œ ì—†ìŒ)
    async function loadCustomersForCurrentStaff() {
      const myId = await getMyStaffId();
      if (!myId) {
        console.error('âŒ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // 1) ë‚´ê°€ 'ëŒ€í‘œ'ì¸ ê³ ê°
      const { data: primaryList, error: pErr } = await supabase
        .from('customers')
        .select('id, customer_name, grade')
        .eq('staff_profiles_id', myId);

      // 2) ë‚´ê°€ 'ë°°ì •ì(ëŒ€í‘œ/ë³´ì¡°)'ë¡œ ë“¤ì–´ê°„ ê³ ê° (ì¡°ì¸)
      const { data: assigneeList, error: aErr } = await supabase
        .from('customers')
        .select(`
          id,
          customer_name,
          grade,
          customer_assignees!inner(staff_profiles_id, is_primary)
        `)
        .eq('customer_assignees.staff_profiles_id', myId);

      if (pErr || aErr) {
        console.error('âŒ ê³ ê° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', pErr || aErr);
        return;
      }

      // 3) ë³‘í•© + ì¤‘ë³µ ì œê±° + ì—­í•  í‘œì‹œ(ëŒ€í‘œ/ë³´ì¡°)
      const map = new Map();

      (primaryList || []).forEach(c => {
        map.set(c.id, { ...c, role: 'ëŒ€í‘œ' });
      });

      (assigneeList || []).forEach(c => {
        const prev = map.get(c.id);
        // ì¡°ì¸ ê²°ê³¼ì— is_primaryê°€ ìˆì„ ìˆ˜ë„ ìˆê³  ì—†ì„ ìˆ˜ë„ ìˆìŒ â†’ ëŒ€í‘œ ìš°ì„ 
        const role = (c.customer_assignees?.[0]?.is_primary || prev?.role === 'ëŒ€í‘œ') ? 'ëŒ€í‘œ' : 'ë³´ì¡°';
        map.set(c.id, { id: c.id, customer_name: c.customer_name, grade: c.grade, role });
      });

      let customers = Array.from(map.values());

      // 4) ì •ë ¬: A > B > C > F, ê°™ì€ ë“±ê¸‰ì€ ì´ë¦„ ì˜¤ë¦„ì°¨ìˆœ
      const gradeOrder = { A: 0, B: 1, C: 2, F: 3 };
      customers.sort((a, b) => {
        const ga = gradeOrder[a.grade] ?? 99;
        const gb = gradeOrder[b.grade] ?? 99;
        if (ga !== gb) return ga - gb;
        return (a.customer_name || '').localeCompare(b.customer_name || '', 'ko');
        // í•„ìš”ì‹œ localeCompare ë‘ë²ˆì§¸ ì¸ì 'ko'ë¡œ í•œêµ­ì–´ ì •ë ¬
      });

      // 4.5) ê³ ê°ë³„ ë‹¤ë¥¸ ë‹´ë‹¹ì ì´ë¦„ ìˆ˜ì§‘ (ë‹´ë‹¹ìê°€ ì •í™•íˆ 2ëª…ì¼ ë•Œë§Œ í‘œì‹œ)
      const custIds = customers.map(c => c.id);

      // ëª¨ë“  ë°°ì •ì ì¡°íšŒ (ë‚´/ë‚¨ êµ¬ë¶„ ìœ„í•´ staff_profiles.id, name í•„ìš”)
      const { data: assigneesAll, error: assAllErr } = await supabase
        .from('customer_assignees')
        .select('customer_id, staff_profiles!inner(id, name)')
        .in('customer_id', custIds);

      const otherNameMap = new Map();
      if (!assAllErr && assigneesAll) {
        // customer_idë³„ë¡œ ë‹´ë‹¹ì id/name ëª¨ìœ¼ê¸° (ì¤‘ë³µ ì œê±°)
        const byCustomer = new Map();
        assigneesAll.forEach(row => {
          const cid = row.customer_id;
          const sp = row.staff_profiles;
          if (!sp) return;
          if (!byCustomer.has(cid)) byCustomer.set(cid, new Map());
          byCustomer.get(cid).set(sp.id, sp.name);
        });

        // ì •í™•íˆ 2ëª…ì¼ ë•Œ ë‚´ idê°€ ì•„ë‹Œ ì´ë¦„ì„ otherë¡œ ì €ì¥
        byCustomer.forEach((idNameMap, cid) => {
          if (idNameMap.size === 2 && idNameMap.has(myId)) {
            for (const [sid, sname] of idNameMap.entries()) {
              if (sid !== myId) { otherNameMap.set(cid, sname); break; }
            }
          }
        });
      }


      // 5) ë Œë” (ë“±ê¸‰ë³„ ê·¸ë£¹ ì„¹ì…˜ + ì´ë¦„ë§Œ)
      const container = document.getElementById('customer-list');
      if (!container) return;
      container.innerHTML = '';

      if (!customers.length) {
        container.textContent = 'ë“±ë¡ëœ ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤.';
        return;
      }

      // A/B/C/Fë§Œ í‘œì‹œ (FëŠ” ì•„ë˜ì—ì„œ ì ‘ì€ ìƒíƒœë¡œ ë Œë”)
      const filteredCustomers = customers.filter(c => ['A', 'B', 'C', 'F'].includes((c.grade || '').toUpperCase()));

      // ë“±ê¸‰ ê·¸ë£¹í•‘
      const grouped = filteredCustomers.reduce((acc, c) => {
        const g = (c.grade || 'ë¯¸ë¶„ë¥˜').toUpperCase();
        (acc[g] ||= []).push(c);
        return acc;
      }, {});

      // í‘œì‹œ ìˆœì„œ ê³ ì •: A > B > C > F > ë‚˜ë¨¸ì§€
      const gradeOrderList = ['A', 'B', 'C', 'F'];
      const sortedGrades = [
        ...gradeOrderList.filter(g => grouped[g]?.length),
        ...Object.keys(grouped).filter(g => !gradeOrderList.includes(g))
      ];

      // ì„¹ì…˜ë³„ ë Œë” (FëŠ” ê¸°ë³¸ ì ‘í˜)
      sortedGrades.forEach(grade => {
        const list = grouped[grade] || [];
        if (!list.length) return;

        // ë˜í¼(ì„¹ì…˜) ìƒì„±
        const section = document.createElement('div');
        section.className = 'mb-1';
        container.appendChild(section);

        // í—¤ë” (í´ë¦­ìœ¼ë¡œ ì ‘ê¸°/í¼ì¹˜ê¸°)
        const header = document.createElement('div');
        header.className = 'grade-header flex items-center justify-between cursor-pointer select-none';
        const countText = `${grade} (${list.length})`;
        header.innerHTML = `
          <span>${countText}</span>
          <span class="caret text-gray-600 transition-transform duration-200">â–¼</span>
        `;
        section.appendChild(header);

        // ëª©ë¡ ì»¨í…Œì´ë„ˆ
        const listBox = document.createElement('div');
        listBox.className = 'mt-1';
        section.appendChild(listBox);

        // FëŠ” ê¸°ë³¸ ì ‘í˜
        const isF = (grade || '').toUpperCase() === 'F';
        if (isF) {
          listBox.style.display = 'none';
          const caret = header.querySelector('.caret');
          caret.style.transform = 'rotate(-90deg)';
        }

        // ì´ë¦„ë“¤ ë Œë”
        list
          .sort((a, b) => (a.customer_name || '').localeCompare(b.customer_name || '', 'ko'))
          .forEach(cust => {
            const nameBtn = document.createElement('div');
            nameBtn.className = 'name-item';
            const other = otherNameMap.get(cust.id);

            const label = document.createElement('span');
            label.textContent = cust.customer_name || '-';

            const sub = document.createElement('span');
            sub.className = 'mr-1 text-sm text-gray-500';
            sub.textContent = other ? `(${other})` : '';

            nameBtn.append(sub, label);

            // ì ‘ê·¼ì„±: í‚¤ë³´ë“œ ì„ íƒ ì§€ì›
            nameBtn.setAttribute('role', 'button');
            nameBtn.tabIndex = 0;

            nameBtn.addEventListener('click', () => loadCustomerDataByName(cust.customer_name));
            nameBtn.addEventListener('keydown', (e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                loadCustomerDataByName(cust.customer_name);
              }
            });

            listBox.appendChild(nameBtn);
          });

        // í† ê¸€ ë™ì‘
        header.addEventListener('click', () => {
          const visible = listBox.style.display !== 'none';
          listBox.style.display = visible ? 'none' : '';
          const caret = header.querySelector('.caret');
          caret.style.transform = visible ? 'rotate(-90deg)' : 'rotate(0deg)';
        });
      });
      
    }

    // ì €ì¥ë²„íŠ¼ ëˆ„ë¥´ë©´ ìˆ˜ì •ëª¨ë“œë¡œ í‘œ ë°”ê¿”ì£¼ëŠ” í•¨ìˆ˜
    function switchSpansToInputs() {
      const rows = document.querySelectorAll('#listings-body tr');

      rows.forEach((row, rowIndex) => {
        const spans = row.querySelectorAll('span[data-field]');
        spans.forEach(span => {
          const field = span.dataset.field;
          const value = span.textContent || '';

          let inputEl;

          if (
            field.startsWith('listing_title_') ||
            field.startsWith('full_address_')  ||
            field.startsWith('combined_unit_') ||   // âœ… ê±´ë¬¼ì •ë³´ë„ textareaë¡œ
            field.startsWith('description_')
          ) {
            inputEl = document.createElement('textarea');
            inputEl.rows = 2;
            inputEl.className = 'w-full text-center text-base border rounded bg-white outline-none resize-none';
          } else {
            inputEl = document.createElement('input');
            inputEl.type = 'text';
            inputEl.className = 'w-full text-center text-base border rounded bg-white outline-none';
          }

          inputEl.value = value;
          inputEl.dataset.field = field;

          span.parentElement.replaceChild(inputEl, span);
        });
      });
    }

    // ì €ì¥ë²„íŠ¼ ëˆ„ë¥´ë©´ ë·°ëª¨ë“œë¡œ ë°”ê¿”ì£¼ëŠ” í•¨ìˆ˜
    function switchInputsToSpans() {
      const rows = document.querySelectorAll('#listings-body tr');

      rows.forEach(row => {
        const fields = row.querySelectorAll('input[data-field], textarea[data-field]');
        fields.forEach(el => {
          const value = el.value || '';
          const field = el.dataset.field;

          const span = document.createElement('span');
          span.className = 'text-base block whitespace-pre-wrap';
          span.dataset.field = field;
          span.textContent = value;

          el.parentElement.replaceChild(span, el);
        });
      });
    }

    let buildingMap = new Map();

    // ë§¤ë¬¼ë²ˆí˜¸ ì…ë ¥ì— ë”°ë¼ ë§¤ë¬¼ì •ë³´ í‘œ ëŠ˜ë¦¬ê³  ì¤„ì´ê¸°
    function updateListingsTableByInputs() {
      const listingsBody = document.getElementById('listings-body');
      const allInputs = document.querySelectorAll('input[data-index]');

      // ì…ë ¥ëœ data-index ì¤‘ ìµœëŒ€ê°’ ì°¾ê¸° (ë¹ˆì¹¸ì€ ë¬´ì‹œ)
      let maxIndex = 0;
      allInputs.forEach(input => {
        const val = input.value.trim();
        const idx = parseInt(input.dataset.index);
        if (val !== '' && !isNaN(idx)) {
          maxIndex = Math.max(maxIndex, idx);
        }
      });

      // ê¸°ì¡´ í–‰ ìˆ˜
      const currentRows = listingsBody.children.length;

      // í–‰ì´ ë¶€ì¡±í•˜ë©´ ì¶”ê°€
      for (let i = currentRows + 1; i <= maxIndex; i++) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="p-1 border text-center">${i}</td>
          <td class="p-1 border text-center">
            <textarea rows="2" class="w-full box-border text-center text-base border rounded bg-white outline-none resize-none" data-field="listing_title_${i}"></textarea>
          </td>
          <td class="p-1 border text-center">
            <textarea rows="2" class="w-full box-border text-center text-base border rounded bg-white outline-none resize-none" data-field="full_address_${i}"></textarea>
          </td>
          <td class="p-1 border text-center">
            <textarea rows="2" class="w-full box-border text-center text-base border rounded bg-white outline-none resize-none" data-field="combined_unit_${i}"></textarea>
          </td>
          <td class="p-1 border text-center">
            <input type="text" class="w-full box-border text-center text-base border rounded bg-white outline-none" data-field="deposit_price_${i}" />
          </td>
          <td class="p-1 border text-center">
            <input type="text" class="w-full box-border text-center text-base border rounded bg-white outline-none" data-field="monthly_rent_${i}" />
          </td>
          <td class="p-1 border text-center">
            <input type="text" class="w-full box-border text-center text-base border rounded bg-white outline-none" data-field="premium_price_${i}" />
          </td>
          <td class="p-1 border text-center">
            <input type="text" class="w-full box-border text-center text-base border rounded bg-white outline-none" data-field="area_py_${i}" />
          </td>
          <td class="p-1 border text-center">
            <textarea rows="2" class="w-full box-border text-left text-base border rounded bg-white outline-none resize-none"  data-field="description_${i}"></textarea>
          </td>
        `;

        listingsBody.appendChild(row);
        applyRowStriping(); // â¬… ìƒˆ í–‰ ì¶”ê°€ í›„ì—ë„ ì ìš©
      }

      // í–‰ì´ ë„ˆë¬´ ë§ìœ¼ë©´ ìë¦„
      while (listingsBody.children.length > maxIndex) {
        listingsBody.removeChild(listingsBody.lastChild);
      }

      // â¬‡ï¸ í–‰ ì¦ê° ì´í›„ ê´€ì°° ì¬ì„¤ì • + ìµœì¢… ë™ê¸°í™”
      observeRows();
      syncRowHeights();
    }

    function showToast(message, duration = 3000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;

      // ìŠ¤íƒ€ì¼ ì§ì ‘ ì§€ì •
      toast.style.backgroundColor = '#F2C130';
      toast.style.color = 'black';
      toast.style.fontWeight = 'bold';
      toast.className = 'fixed top-5 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded shadow-lg z-[9999]';

      toast.classList.remove('hidden');

      setTimeout(() => {
        toast.classList.add('hidden');
      }, duration);
    }

    // --- Formatting Helpers ---
    function formatKoreanMoney(value) {
        if (!value && value !== 0) return '-';
        const num = Number(value);
        if (isNaN(num)) return '-';
        if (num >= 10000) {
            const eok = Math.floor(num / 10000);
            const man = num % 10000;
            return `${eok}ì–µ${man > 0 ? ' ' + man.toLocaleString() : ''}`;
        }
        return num.toLocaleString();
    }

    // === Listing Title Cleaner ===
    // ê·œì¹™: ê´„í˜¸ ì•ˆì— 'ìˆ«ì'ì™€ 'í˜¸'ê°€ í•¨ê»˜ ìˆìœ¼ë©´ ê·¸ ê´„í˜¸ ë¬¶ìŒë§Œ ì œê±°.
    // ê·¸ ì™¸ì˜ ê´„í˜¸(ì˜ˆ: '(ì „,ì†Œë‹´ìŠ¤ë ˆê¹€ì¹˜ì°Œê°œ)')ëŠ” ìœ ì§€.
    function cleanListingTitle(raw) {
      if (!raw) return '';
      let s = String(raw);

      // ëª¨ë“  ê´„í˜¸ ë¬¶ìŒì„ ìˆœíšŒí•˜ë©´ì„œ, ë‚´ë¶€ì— ìˆ«ì(\d)ì™€ 'í˜¸'ê°€ ëª¨ë‘ ìˆìœ¼ë©´ ì œê±°
      s = s.replace(/\s*\(([^)]*)\)\s*/g, (match, inside) => {
        const hasDigit = /\d/.test(inside);
        const hasHo = /í˜¸/.test(inside);
        // 101~103í˜¸ ê°™ì€ ë²”ìœ„ë„ ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨ë¨(ìˆ«ì+í˜¸)
        return (hasDigit && hasHo) ? '' : ` (${inside.trim()}) `;
      });

      // ë‚¨ì€ ê³µë°±/ì¤‘ë³µ ê³µë°± ì •ë¦¬
      s = s.replace(/\s{2,}/g, ' ').trim();

      // ë¹ˆ ê´„í˜¸ê°€ ë‚¨ì•˜ìœ¼ë©´ ì œê±°
      s = s.replace(/\(\s*\)/g, '').trim();

      return s;
    }
    
    async function preloadBuildingInfo() {
      const { data: buildings, error } = await supabase
        .from('building_info')
        .select('addr_compare, building_name');

      if (!error && buildings) {
        buildingMap = new Map(buildings.map(b => [b.addr_compare, b.building_name]));
        // console.log(`ğŸ¢ building_info ${buildings.length}ê±´ ë¡œë“œ ì™„ë£Œ`);
      } else {
        console.warn('â— building_info ë¡œë”© ì‹¤íŒ¨:', error);
      }
    }

    const leftTbody = document.getElementById('left-tbody');
    for (let i = 1; i <= 50; i++) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="border-b text-right pr-2"> <!-- ì˜¤ë¥¸ìª½ ì •ë ¬ -->
          <input type="text" placeholder="ì…ë ¥ ${i}" 
                class="w-[5rem] border px-2 rounded text-base ml-auto block" 
                data-index="${i}" />
        </td>
      `;
      leftTbody.appendChild(row);
    }


    function addListingRow(i) {
      const row = document.createElement('tr');
      const listingsBody = document.getElementById('listings-body');

      // iê°€ í™€ìˆ˜ë©´ í°ìƒ‰, ì§ìˆ˜ë©´ íšŒìƒ‰
      const bgClass = i % 2 === 0 ? 'bg-gray-50' : 'bg-white';
      row.className = `${bgClass} hover:bg-yellow-50`;

      row.innerHTML = `
        <td class="p-2 border text-center">${i}</td>
        <td class="p-2 border text-center"><input type="text" class="w-full text-center text-base border-none bg-transparent outline-none" data-field="listing_title_${i}" /></td>
        <td class="p-2 border text-center"><input type="text" class="w-full text-center text-base border-none bg-transparent outline-none" data-field="full_address_${i}" /></td>
        <td class="p-2 border text-center"><input type="text" class="w-full text-center text-base border-none bg-transparent outline-none" data-field="building_name_${i}" /></td>
        <td class="p-2 border text-center"><input type="text" class="w-full text-center text-base border-none bg-transparent outline-none" data-field="unit_info_${i}" /></td>
        <td class="p-2 border text-center"><input type="text" class="w-full text-center text-base border-none bg-transparent outline-none" data-field="floor_${i}" /></td>
        <td class="p-2 border text-center"><input type="text" class="w-full text-center text-base border-none bg-transparent outline-none" data-field="deposit_price_${i}" /></td>
        <td class="p-2 border text-center"><input type="text" class="w-full text-center text-base border-none bg-transparent outline-none" data-field="monthly_rent_${i}" /></td>
        <td class="p-2 border text-center"><input type="text" class="w-full text-center text-base border-none bg-transparent outline-none" data-field="premium_price_${i}" /></td>
        <td class="p-2 border text-center"><input type="text" class="w-full text-center text-base border-none bg-transparent outline-none" data-field="area_py_${i}" /></td>
      `;

      listingsBody.appendChild(row);
      applyRowStriping(); // â¬… ìƒˆ í–‰ ì¶”ê°€ í›„ì—ë„ ì ìš©
    }

    // í…Œì´ë¸” inputì°½ì—ì„œë„ í–‰ ë²ˆê°ˆì•„ê°€ë©´ì„œ íšŒìƒ‰ ì ìš©ë˜ê²Œ
    function applyRowStriping() {
      const rows = document.querySelectorAll('#listings-body tr');
      rows.forEach((row, index) => {
        row.classList.remove('bg-white', 'bg-gray-50'); // ê¸°ì¡´ ìƒ‰ ì œê±°
        row.classList.add(index % 2 === 0 ? 'bg-white' : 'bg-gray-50'); // ìˆœì„œëŒ€ë¡œ ì ìš©
      });
    }
    
    // ë§¤ë¬¼ì •ë³´ ì§€ìš°ëŠ” í•¨ìˆ˜
    function clearListingRow(index) {
      const fields = [
        'listing_title', 'full_address', 'combined_unit',
        'deposit_price', 'monthly_rent', 'premium_price', 'area_py', 'description'
      ];

      fields.forEach(field => {
        const el = document.querySelector(`[data-field="${field}_${index}"]`);
        if (el) {
          if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
            el.value = '';
          } else {
            el.textContent = '';
          }
        }
      });

      // âœ… í–‰ ë†’ì´ ë‹¤ì‹œ ë™ê¸°í™”
      syncRowHeights?.();
    }

    async function fetchListingInfo(listingId, rowIndex) {
      const cleanedId = listingId.replace(/[^\d]/g, '');  // ìˆ«ìë§Œ ë‚¨ê¸°ê¸°

      if (!cleanedId) {
        console.warn(`[${rowIndex}] ë§¤ë¬¼ë²ˆí˜¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.`);
        return;
      }

      const numericId = Number(cleanedId.replaceAll(',', '')); // ì‰¼í‘œ ì œê±° + ìˆ«ì ë³€í™˜

      if (isNaN(numericId)) {
        alert(`ìœ íš¨í•œ ìˆ«ì ë§¤ë¬¼ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
        return;
      }

      // Supabase ì¡°íšŒ
      const { data: listing, error: listingError } = await supabase
        .from('baikukdbtest')
        .select('listing_title, full_address, addr_compare, unit_info, floor, deposit_price, monthly_rent, premium_price, area_py')
        .eq('listing_id', numericId)
        .single();

      if (listingError || !listing) {
        console.error(`âŒ [${rowIndex}] ë§¤ë¬¼ ì¡°íšŒ ì‹¤íŒ¨`, listingError);
        showToast(`ë§¤ë¬¼ë²ˆí˜¸ ${listingId} ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        return;
      }

      // 2. ê±´ë¬¼ëª… ë§¤í•‘
      const buildingName = buildingMap.get(listing.addr_compare) ?? '-';

      // 3. í‘œì‹œí•  ë°ì´í„° ì •ë¦¬
      const combinedUnit = combineUnitInfo(buildingName, listing.floor, listing.unit_info);
      const dataToDisplay = {
        listing_title: cleanListingTitle(listing.listing_title), // ğŸ‘ˆ ì—¬ê¸°!
        full_address: listing.full_address,
        combined_unit: combinedUnit,
        deposit_price: listing.deposit_price,
        monthly_rent: listing.monthly_rent,
        premium_price: listing.premium_price,
        area_py: listing.area_py
      };

      updateListingsTableByInputs();
      
      // ğŸ”½ ì½ê¸°ëª¨ë“œì¼ ê²½ìš°, í•´ë‹¹ í–‰ë§Œ ë‹¤ì‹œ spanìœ¼ë¡œ ì „í™˜
      if (!isEditMode) {
        const row = document.querySelectorAll('#listings-body tr')[rowIndex - 1];
        if (row) {
          const fields = row.querySelectorAll('input[data-field], textarea[data-field]');
          fields.forEach(el => {
            const value = el.value || '';
            const field = el.dataset.field;

            const span = document.createElement('span');
            span.className = 'text-base block whitespace-pre-wrap';
            span.dataset.field = field;
            span.textContent = value;

            el.parentElement.replaceChild(span, el);
          });
        }
      }
      
      
      // 4. DOMì— ì¶œë ¥
      Object.entries(dataToDisplay).forEach(([field, value]) => {
        const selector = `[data-field="${field}_${rowIndex}"]`;
        const el = document.querySelector(selector);
        if (el) {
          const isMoney = ['deposit_price', 'monthly_rent', 'premium_price'].includes(field);
          const formattedValue =
            isMoney
              ? formatKoreanMoney(value)
              : field === 'area_py'
                ? (isNaN(Number(value)) ? '-' : Number(value).toFixed(1))
              : field === 'full_address'
                ? (typeof value === 'string' ? value.split(' ').slice(1).join(' ') : '-')
              : (value ?? '-');

          if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
            el.value = formattedValue;
          } else {
            el.textContent = formattedValue;  // âœ… span íƒœê·¸ìš©
          }
        }
      });

      // âœ… ë†’ì´ ë™ê¸°í™” ì‹¤í–‰
      syncRowHeights();
      applyRowStriping();  // âœ… í–‰ ë°°ê²½ìƒ‰ ë‹¤ì‹œ ì ìš©      
    }


    window.addEventListener('DOMContentLoaded', () => {
      displayTodayDate();
      displayStaffInfo();
      preloadBuildingInfo();
      loadCustomersForCurrentStaff();
      loadCurrentUserStaffInfo(); // ì²«ë¡œë“œì‹œ ë‹´ë‹¹ìì •ë³´ ë³¸ì¸ì •ë³´ í‘œì‹œ
      loadStaffOptions();

      // === í–‰ ë†’ì´ ë™ê¸°í™”ë¥¼ ìœ„í•œ í–‰ ë‹¨ìœ„ ê´€ì°° ì´ˆê¸°í™” ===
      listingsBody = document.getElementById('listings-body');
      rowObserver = new ResizeObserver(() => {
        // í–‰ í•˜ë‚˜ê°€ ì»¤ì§€ê±°ë‚˜ ì‘ì•„ì§ˆ ë•Œë§ˆë‹¤ ì „ì²´ ë™ê¸°í™” (ê°„ë‹¨/ì•ˆì „)
        syncRowHeights();
      });
      observeRows();   // í˜„ì¬ ìˆëŠ” ëª¨ë“  í–‰ ê´€ì°° ì‹œì‘

      const memoTextarea = document.getElementById('memo-textarea');
      
      // ë§¤ë¬¼ë²ˆí˜¸ ì…ë ¥ ê°ì§€
      document.querySelectorAll('input[data-index]').forEach(input => {
        const index = parseInt(input.dataset.index);

        input.addEventListener('change', (e) => {
          const value = e.target.value.trim();

          if (value === '') {
            // âœ… ì…ë ¥ì´ ë¹ˆ ê²½ìš° â†’ í•´ë‹¹ í–‰ ì´ˆê¸°í™”
            clearListingRow(index);
          } else {
            // âœ… ì…ë ¥ëœ ê²½ìš° â†’ ë§¤ë¬¼ì¡°íšŒ
            fetchListingInfo(value, index);
          }
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            const value = e.target.value.trim();
            if (value === '') {
              clearListingRow(index);
            } else {
              fetchListingInfo(value, index);
            }
            const nextInput = document.querySelector(`input[data-index="${index + 1}"]`);
            if (nextInput) nextInput.focus();
            e.preventDefault();
          }
        });

        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const pasteText = (e.clipboardData || window.clipboardData).getData('text');
          const values = pasteText
            .split(/[\s,\n]+/)
            .map(str => str.trim())
            .filter(Boolean);

          values.forEach((val, offset) => {
            const targetInput = document.querySelector(`input[data-index="${index + offset}"]`);
            if (targetInput) {
              targetInput.value = val;
              targetInput.dispatchEvent(new Event('change'));
            }
          });
        });
      });

      // âœ… ì—´ ë¦¬ì‚¬ì´ì¦ˆ: ë§¤ë§¤ì¶”ì²œ í˜ì´ì§€ì™€ ë™ì¼ ë™ì‘(ì‹¬í”Œ)
      let startX, startWidth, resizableTh;
      document.querySelectorAll('.resize-handle').forEach(h => {
        h.addEventListener('mousedown', e => {
          resizableTh = e.target.closest('th');
          startX = e.clientX;
          startWidth = resizableTh.offsetWidth;

          document.addEventListener('mousemove', resizeColumn);
          document.addEventListener('mouseup', stopResize);
        });
      });
      function resizeColumn(e) {
        if (!resizableTh) return;
        const newWidth = startWidth + (e.clientX - startX);
        resizableTh.style.width = newWidth + 'px';
      }
      function stopResize() {
        document.removeEventListener('mousemove', resizeColumn);
        document.removeEventListener('mouseup', stopResize);
        resizableTh = null;
      }

      syncRowHeights?.();

      // âœ… ì „ì²´ì„ íƒ ëŒ€ìƒ ì œí•œ: ë§¤ë¬¼ë²ˆí˜¸/ë§¤ë¬¼ì •ë³´ë§Œ
      document.addEventListener('focusin', (e) => {
        const t = e.target;

        // ê³ ê°ì •ë³´(ì´ë¦„/ì „í™”/ë©”ëª¨)ëŠ” ì œì™¸
        const isCustomerField = t.matches('#top-row-input, #customer-phone, #memo-textarea');
        if (isCustomerField) return;

        // ë§¤ë¬¼ë²ˆí˜¸(ì™¼ìª½) OR ë§¤ë¬¼ì •ë³´(ì˜¤ë¥¸ìª½ data-fieldê°€ ìˆëŠ” input/textarea)ë§Œ í—ˆìš©
        const isListingNumber = t.matches('input[data-index]');
        const isListingField  = t.matches('input[data-field], textarea[data-field]');

        if (isListingNumber || isListingField) {
          // iOS/Safari ì¼ë¶€ ì´ìŠˆ ë°©ì§€ìš© setTimeout
          setTimeout(() => {
            try { t.select(); } catch (_) {}
          }, 0);
        }
      });

      // âœ… ì½ê¸° ëª¨ë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë° í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
      toggleButton.textContent = 'ìˆ˜ì •';
      toggleButton.classList.remove('bg-blue-400', 'hover:bg-blue-500');
      toggleButton.classList.add('bg-neutral-500', 'hover:bg-neutral-600');

      // âœ… input â†’ span ì „í™˜ (ë§¤ë¬¼ í…Œì´ë¸”ì´ ë Œë”ëœ í›„ ìˆ˜í–‰í•´ì•¼ í•¨)
      switchInputsToSpans();  // â† í˜¹ì‹œ ì…ë ¥ í•„ë“œê°€ ê¸°ë³¸ìœ¼ë¡œ ìƒì„±ë˜ì–´ ìˆë‹¤ë©´ ì´ê±¸ í†µí•´ spanìœ¼ë¡œ ì „í™˜

      // === 'ë§¤ë¬¼ë²ˆí˜¸' ì¼ê´„ ì§€ìš°ê¸° ë²„íŠ¼ ===
      document.getElementById('clear-left-btn')?.addEventListener('click', () => {
        const inputs = document.querySelectorAll('input[data-index]');
        let touched = 0;
        inputs.forEach(inp => {
          if (inp.value && inp.value.trim() !== '') {
            inp.value = '';
            // ê¸°ì¡´ change í•¸ë“¤ëŸ¬ê°€ clearListingRow(index)ë¥¼ í˜¸ì¶œí•˜ë„ë¡ ì´ë²¤íŠ¸ ë°œìƒ
            inp.dispatchEvent(new Event('change'));
            touched++;
          }
        });
        showToast(touched > 0 ? 'ë§¤ë¬¼ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì§€ì› ìŠµë‹ˆë‹¤.' : 'ì§€ìš¸ ë§¤ë¬¼ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
      });

      // ìµœì´ˆ ì§„ì… ì‹œì—ë„ ë©”ëª¨ 50ì¤„ í‘œì‹œ
      renderMemoPanel([]);
    });

    // ğŸ‘‰ ì°½ ë¦¬ì‚¬ì´ì¦ˆ ì‹œì—ë„ ë†’ì´ ë™ê¸°í™”
    window.addEventListener('resize', syncRowHeights);

    function syncRowHeights() {
      const rightRows = document.querySelectorAll('#listings-body tr');
      const leftRows  = document.querySelectorAll('#left-tbody tr');

      const len = Math.min(rightRows.length, leftRows.length);
      for (let i = 0; i < len; i++) {
        const r = rightRows[i];
        const l = leftRows[i];
        if (!r || !l) continue;

        // ë†’ì´ ì¬ì„¤ì •
        l.style.height = 'auto';
        r.style.height = 'auto';

        const lh = l.getBoundingClientRect().height;
        const rh = r.getBoundingClientRect().height;

        const max = Math.max(lh, rh);

        // âœ… ì˜¤ë¥¸ìª½ì´ ë” ì‘ìœ¼ë©´ ì˜¤ë¥¸ìª½ì— ë†’ì´ ê³ ì • (ì™¼ìª½ì´ ê¸°ì¤€)
        if (rh < lh) r.style.height = `${lh}px`;

        // âœ… ì™¼ìª½ì€ í•­ìƒ ì˜¤ë¥¸ìª½ ë†’ì´ë¡œ ë§ì¶¤
        l.style.height = `${Math.max(lh, rh)}px`;
      }
      syncMemoRowHeights();
    }

    function syncMemoRowHeights() {
      const listingRows = document.querySelectorAll('#listings-body tr');
      const memoRows = document.querySelectorAll('#memo-body tr');

      const px = (v) => (v ? parseFloat(v) || 0 : 0);

      const count = Math.min(listingRows.length, memoRows.length);
      for (let i = 0; i < count; i++) {
        const targetRowHeight = listingRows[i].getBoundingClientRect().height;

        const td = memoRows[i].querySelector('td');
        const ta = td?.querySelector('textarea');
        if (!td || !ta) continue;

        const tdStyle = getComputedStyle(td);
        const taStyle = getComputedStyle(ta);

        // TDì˜ ìœ„ì•„ë˜ íŒ¨ë”©/ë³´ë” í•©
        const tdVertical =
          px(tdStyle.paddingTop) + px(tdStyle.paddingBottom) +
          px(tdStyle.borderTopWidth) + px(tdStyle.borderBottomWidth);

        // textareaê°€ border-boxë©´ height=ì´ë†’ì´, content-boxë©´ íŒ¨ë”©/ë³´ë”ë¥¼ ë¹¼ì¤˜ì•¼ í•¨
        const isBorderBox = taStyle.boxSizing === 'border-box';
        const taPadding = px(taStyle.paddingTop) + px(taStyle.paddingBottom);
        const taBorder  = px(taStyle.borderTopWidth) + px(taStyle.borderBottomWidth);

        // TD ì•ˆì—ì„œ textareaê°€ ê°€ì ¸ì•¼ í•  ì´ ë†’ì´
        const innerTarget = Math.max(0, targetRowHeight - tdVertical);

        const adjust = 1.29; // â† ë†’ì´ ì‚´ì§ ëŠ˜ë¦¬ëŠ” ë³´ì •ê°’(px)
        ta.style.height = isBorderBox
          ? `${innerTarget + adjust}px`
          : `${Math.max(0, innerTarget - taPadding - taBorder + adjust)}px`;
      }
    }

    const allInputs = document.querySelectorAll('input[data-index]');

    // ìˆ˜ì •, ì €ì¥ë²„íŠ¼ ê´€ë ¨
    const toggleButton = document.getElementById('toggle-edit-btn');
    let isEditMode = false;

    // === 'ì†ë‹˜ì €ì¥'ì„ 'ìˆ˜ì •â†’ì €ì¥'ê³¼ ë™ì¼ ë¡œì§ìœ¼ë¡œ ì‹¤í–‰ ===
    // - í˜„ì¬ í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ˆë©´: í•œ ë²ˆ í´ë¦­ìœ¼ë¡œ í¸ì§‘ ëª¨ë“œ ì§„ì… â†’ ë‹¤ì‹œ í´ë¦­ìœ¼ë¡œ ì €ì¥ ì‹¤í–‰
    // - í˜„ì¬ í¸ì§‘ ëª¨ë“œë©´: í•œ ë²ˆë§Œ í´ë¦­í•´ì„œ ì €ì¥ ì‹¤í–‰
    document.getElementById('save-new-customer')?.addEventListener('click', () => {
      if (!toggleButton) return;

      if (!isEditMode) {
        // 1) ë¨¼ì € 'ìˆ˜ì •' í´ë¦­(í¸ì§‘ëª¨ë“œ ì§„ì…: í•„ìˆ˜ ì¤€ë¹„ ì‘ì—…/ê²€ì¦ ë¡œì§ ê·¸ëŒ€ë¡œ ìˆ˜í–‰)
        toggleButton.click();
      }
      // 2) ê³§ë°”ë¡œ 'ì €ì¥' í´ë¦­(ì½ê¸°ëª¨ë“œ ì „í™˜ + ë™ì¼ ì €ì¥ ë¡œì§ ì‹¤í–‰)
      toggleButton.click();
    });

    const inputTopRow = document.getElementById('top-row-input'); // ì†ë‹˜ì´ë¦„ ì…ë ¥ì°½

    toggleButton.addEventListener('click', async () => {
      isEditMode = !isEditMode;
      toggleButton.textContent = isEditMode ? 'ì €ì¥' : 'ìˆ˜ì •';

      // ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½
      toggleButton.classList.remove('bg-neutral-500', 'hover:bg-neutral-600', 'bg-blue-500', 'hover:bg-blue-600');
      if (isEditMode) {
        // ìˆ˜ì •ëª¨ë“œ: íŒŒë‘
        toggleButton.classList.add('bg-blue-500', 'hover:bg-blue-600');
      } else {
        // ì½ê¸°ëª¨ë“œ: ë¹¨ê°„ìƒ‰
        toggleButton.classList.add('bg-neutral-500', 'hover:bg-neutral-600');
      }

      if (isEditMode) {
        switchSpansToInputs(); // ìˆ˜ì • ëª¨ë“œ: input/textareaë¡œ ë³µì›
        showToast('í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.');

        document.getElementById('staff-info').classList.add('hidden');
        document.getElementById('staff-select').classList.remove('hidden');

        // í˜„ì¬ ê³ ê°ì˜ staff_profiles_id ë¶ˆëŸ¬ì˜¤ê¸°
        const { data: customer } = await supabase
          .from('customers')
          .select('staff_profiles_id')
          .eq('id', currentCustomerId)
          .maybeSingle();

        const currentStaffId = customer?.staff_profiles_id;
        await loadStaffOptions(currentStaffId);

        // âœ… ì €ì¥ ì‹œ, ë§ˆì§€ë§‰ ê°’ì´ ìˆëŠ” í–‰ê¹Œì§€ë§Œ ë‚¨ê¸°ê³  ì´í›„ ì˜¤ë¥¸ìª½ listings í–‰ ì œê±°
        const listingsBody = document.getElementById('listings-body');
        const rows = listingsBody.querySelectorAll('tr');

        let lastFilledRowIndex = -1;

        rows.forEach((row, i) => {
          const index = i + 1;

          const keyFields = [
            `listing_title_${index}`,
            `full_address_${index}`,
            `deposit_price_${index}`,
            `monthly_rent_${index}`,
            `area_py_${index}`
          ];

          const hasValue = keyFields.some(field => {
            const el = row.querySelector(`[data-field="${field}"]`);
            if (!el) return false;
            const val = el.tagName === 'SPAN' ? el.textContent : el.value;
            return val && val.trim() !== '';
          });

          if (hasValue) {
            lastFilledRowIndex = i;
          }
        });
        // âœ… ì˜¤ë¥¸ìª½ listings í–‰ë§Œ ì œê±° (ì™¼ìª½ì€ ìœ ì§€)
        for (let i = rows.length - 1; i > lastFilledRowIndex; i--) {
          listingsBody.removeChild(rows[i]);
        }
        // âœ… ë†’ì´ ë‹¤ì‹œ ë™ê¸°í™”
        syncRowHeights?.();
        return;
      } else {
        switchInputsToSpans(); // ì €ì¥ ëª¨ë“œ: spanìœ¼ë¡œ ë³€ê²½
        // --- ğŸ‘‡ ë‹´ë‹¹ì ì €ì¥ ì²˜ë¦¬ (staff-select â†’ customers.staff_profiles_id) ---
        const selectedStaffId = document.getElementById('staff-select').value;
        if (selectedStaffId) {
          await supabase
            .from('customers')
            .update({ staff_profiles_id: selectedStaffId })
            .eq('id', currentCustomerId);

          const { data: selectedStaff } = await supabase
            .from('staff_profiles')
            .select('position, name, phone_num')
            .eq('id', selectedStaffId)
            .maybeSingle();

          if (selectedStaff) {
            const displayText = `${selectedStaff.position} ${selectedStaff.name} ${selectedStaff.phone_num}`;
            document.getElementById('staff-info').textContent = displayText;
          }
        }
        document.getElementById('staff-select').classList.add('hidden');
        document.getElementById('staff-info').classList.remove('hidden');
        // --- ğŸ‘† ì´ ë¸”ëŸ­ì„ switchInputsToSpans() ë‹¤ìŒì— ë¶™ì—¬ì£¼ì„¸ìš” ---

        showToast('ì½ê¸° ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }

      // ğŸ‘‡ ì €ì¥ ë¡œì§ ì‹¤í–‰
      const { data: { user }, error: userError } = await supabase.auth.getUser();
      if (userError || !user) { showToast("ë¡œê·¸ì¸ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤."); return; }

      const customerName = document.getElementById('top-row-input')?.value.trim();
      const customerPhone = document.getElementById('customer-phone')?.value.trim();
      const customerGrade = document.getElementById('customer-grade')?.value;
      const memoText = document.getElementById('memo-textarea')?.value.trim();

      // âœ… ì„ íƒëœ ê³ ê°ì´ ì—†ì„ ë•Œ: ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰í•´ì„œ ì—†ìœ¼ë©´ ì‹ ê·œ ìƒì„±
      if (!currentCustomerId) {
        if (!customerName) { // ì‹ ê·œë„ ì´ë¦„ì€ í•„ìˆ˜
          showToast('ê³ ê° ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
          return;
        }

        // 1) ê°™ì€ ì´ë¦„ ê³ ê°ì´ ìˆëŠ”ì§€ ë¨¼ì € í™•ì¸
        const { data: existingByName, error: findErr } = await supabase
          .from('customers')
          .select('id')
          .eq('customer_name', customerName)
          .maybeSingle();

        if (findErr) {
          console.error('âŒ ê³ ê° ê²€ìƒ‰ ì‹¤íŒ¨:', findErr);
          showToast('ê³ ê° ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          return;
        }

        if (existingByName?.id) {
          // ê°™ì€ ì´ë¦„ ê³ ê°ì´ ì´ë¯¸ ìˆìœ¼ë©´ ê·¸ ê³ ê°ì„ ì„ íƒí•œ ê²ƒìœ¼ë¡œ ê°„ì£¼í•˜ê³  ì´í›„ ë¡œì§ ì¬ì‚¬ìš©
          currentCustomerId = existingByName.id;
        } else {
          // 2) ê°™ì€ ì´ë¦„ì´ ì—†ë‹¤ â†’ ì‹ ê·œ ìƒì„±
          const myStaffId = await getMyStaffId();
          if (!myStaffId) {
            showToast('ì§ì› ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }

          const today = new Date().toISOString().split('T')[0];
          const newCustomer = {
            customer_name: customerName,
            customer_phone_number: customerPhone || null,
            phone_last4: customerPhone ? customerPhone.replace(/\D/g,'').slice(-4) : null,
            grade: customerGrade || 'F',
            memo: memoText || null,
            registered_at: today,
            staff_profiles_id: myStaffId
          };

          const { data: inserted, error: insertError } = await supabase
            .from('customers')
            .insert([newCustomer])
            .select()
            .single();

          if (insertError || !inserted) {
            console.error('âŒ ì‹ ê·œ ê³ ê° ì €ì¥ ì‹¤íŒ¨:', insertError);
            showToast('ê³ ê° ì €ì¥ ì‹¤íŒ¨');
            return;
          }

          currentCustomerId = inserted.id;
          showToast(`"${customerName}" ê³ ê° ì €ì¥ ì™„ë£Œ`);
        }
      }


      // âœ… ê¶Œí•œ í™•ì¸: ë‚´ê°€ ì´ ê³ ê°ì˜ ëŒ€í‘œ/ë³´ì¡° ë°°ì •ìì—¬ì•¼ í•¨
      if (!(await isMyAssignedCustomer(currentCustomerId))) {
        showToast('ë‹´ë‹¹ìê°€ ì•„ë‹Œ ê³ ê°ì€ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // ì¤‘ë³µ ì´ë¦„ ì²´í¬(ë³¸ì¸ ì œì™¸)
      if (customerName) {
        const { data: duplicateCustomer } = await supabase
          .from('customers')
          .select('id')
          .eq('customer_name', customerName)
          .neq('id', currentCustomerId)
          .maybeSingle();

        if (duplicateCustomer) {
          const staffId = await getMyStaffId(); // ë®ì–´ì“¸ ë•Œ ëŒ€í‘œì êµì²´ë¥¼ ì›ì¹˜ ì•Šìœ¼ë©´ ì•„ë˜ overwriteDataì—ì„œ ì œì™¸
          openOverwriteModal(duplicateCustomer.id, async (targetId) => {
            const today = new Date().toISOString().split('T')[0];
            const overwriteData = {
              customer_name: customerName,
              customer_phone_number: customerPhone,
              phone_last4: customerPhone ? customerPhone.replace(/\D/g,'').slice(-4) : null,
              grade: customerGrade,
              memo: memoText,
              // registered_at: today,      // ë“±ë¡ì¼ ê°±ì‹  ì›ì¹˜ ì•Šìœ¼ë©´ ì£¼ì„ ìœ ì§€
              // staff_profiles_id: staffId // ëŒ€í‘œì êµì²´ ì›ì¹˜ ì•Šìœ¼ë©´ ì£¼ì„ ìœ ì§€
            };

            // 1) ê³ ê° UPDATE (ì¤‘ë³µ ì´ë¦„ì¸ íƒ€ê²Ÿì— ë®ì–´ì“°ê¸°)
            const { error: updErr } = await supabase
              .from('customers')
              .update(overwriteData)
              .eq('id', targetId);
            if (updErr) {
              console.error('âŒ ê³ ê° ë®ì–´ì“°ê¸° ì‹¤íŒ¨:', updErr);
              showToast('ë®ì–´ì“°ê¸° ì‹¤íŒ¨');
              return;
            }

            // 2) ì¶”ì²œë§¤ë¬¼ ë®ì–´ì“°ê¸° (DELETE â†’ INSERT)
            const rowCount = document.querySelectorAll('#listings-body tr').length;
            const getListingIdByIndex = (index) => {
              const raw = document.querySelector(`input[data-index="${index}"]`)?.value.trim() || '';
              const num = Number(raw.replace(/[^\d]/g, ''));
              return isNaN(num) ? null : num;
            };
            const getNumericFromField = (field, index) => {
              const el = document.querySelector(`[data-field="${field}_${index}"]`);
              if (!el) return null;
              const val = (el.tagName === 'SPAN' ? el.textContent : el.value || '').replace(/,/g, '').trim();
              const n = Number(val);
              return isNaN(n) ? null : n;
            };
            const getStringFromField = (field, index) => {
              const el = document.querySelector(`[data-field="${field}_${index}"]`);
              if (!el) return '';
              const v = el.tagName === 'SPAN' ? (el.textContent || '') : (el.value || '');
              return v.trim();
            };

            // (ë³µë¶™ ì „ì²´ ì˜ˆì‹œ) â€” rowsToInsert ì‘ì„±ë¶€
            const rowsToInsert = [];
            for (let index = 1; index <= rowCount; index++) {
              const listingId     = getListingIdByIndex(index);
              const listing_title = getStringFromField('listing_title', index);
              const full_address  = getStringFromField('full_address', index);
              const combined_unit = getStringFromField('combined_unit', index);
              const description   = getStringFromField('description', index);

              const deposit_price = getNumericFromField('deposit_price', index);
              const monthly_rent  = getNumericFromField('monthly_rent', index);
              const premium_price = getNumericFromField('premium_price', index);
              const area_py       = getNumericFromField('area_py', index);

              // ë©”ëª¨ íŒ¨ë„ì—ì„œ í•´ë‹¹ í–‰ ë©”ëª¨ ì½ê¸°
              const memoText = getMemoValue(index);

              const hasMeaningful =
                (listing_title || full_address || combined_unit || description || memoText ||
                deposit_price !== null || monthly_rent !== null || premium_price !== null || area_py !== null);

              if (listingId || hasMeaningful) {
                rowsToInsert.push({
                  customers_id: String(currentCustomerId),
                  listing_id: listingId,
                  listing_title,
                  full_address,
                  building_detail_info: combined_unit,
                  deposit_price,
                  monthly_rent,
                  premium_price,
                  area_py,
                  // descriptionì€ contentsì— ì €ì¥(ê¸°ì¡´ ë¡œì§ ìœ ì§€)
                  contents: description ?? null,
                  // âœ… ë©”ëª¨ëŠ” memo ì»¬ëŸ¼ì—ë§Œ ì €ì¥
                  memo: memoText || null,
                  order: index
                });
              }
            }

            const { error: delErr } = await supabase
              .from('customers_recommendations')
              .delete()
              .eq('customers_id', targetId);
            if (delErr) {
              console.error('âŒ ê¸°ì¡´ ì¶”ì²œ ë§¤ë¬¼ ì‚­ì œ ì‹¤íŒ¨:', delErr);
              showToast('ì¶”ì²œ ë§¤ë¬¼ ì‚­ì œ ì‹¤íŒ¨');
              return;
            }

            if (rowsToInsert.length > 0) {
              const { error: insErr } = await supabase
                .from('customers_recommendations')
                .insert(rowsToInsert);
              if (insErr) {
                console.error('âŒ ì¶”ì²œ ë§¤ë¬¼ ì‚½ì… ì‹¤íŒ¨:', insErr);
                showToast('ì¶”ì²œ ë§¤ë¬¼ ì €ì¥ ì‹¤íŒ¨');
                return;
              }
            }

            // ìƒíƒœ/ëª©ë¡ ê°±ì‹ 
            currentCustomerId = targetId;
            showToast(`"${customerName}" ê³ ê° ì •ë³´ë¥¼ ë®ì–´ì¼ìŠµë‹ˆë‹¤.`);
            loadCustomersForCurrentStaff?.();
          });

          // ëª¨ë‹¬ë¡œ ë¶„ê¸°í–ˆìœ¼ë‹ˆ ì—¬ê¸°ì„œ ì¤‘ë‹¨
          return;
        }
      }

      const customerData = {
        customer_name: customerName || null,
        customer_phone_number: customerPhone || null,
        phone_last4: customerPhone ? customerPhone.replace(/\D/g,'').slice(-4) : null,
        grade: customerGrade || 'F',
        memo: memoText || null
      };
      // âš ï¸ ëŒ€í‘œë‹´ë‹¹ì ì¹¼ëŸ¼(staff_profiles_id)ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
      const { error: updateError } = await supabase
        .from('customers')
        .update(customerData)
        .eq('id', currentCustomerId);

      if (updateError) {
        console.error('âŒ ê³ ê° ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', updateError);
        showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
        return;
      }

      // âœ… ì…ë ¥ëœ ë§¤ë¬¼ë²ˆí˜¸ ìˆ˜ì§‘
      const allInputs = document.querySelectorAll('input[data-index]');
      const listingIds = [];
      allInputs.forEach(input => {
        const raw = input.value.trim();
        const num = Number(raw.replace(/[^\d]/g, ''));
        if (!isNaN(num)) listingIds.push(num);
      });

      // âœ… customers_recommendations ì „ì²´ ê°ˆì•„ë¼ìš°ê¸°: (DELETE ALL â†’ INSERT CURRENT)
      {
        // í˜„ì¬ í™”ë©´ì˜ ì˜¤ë¥¸ìª½ í…Œì´ë¸” í–‰ ìˆ˜
        const rowCount = document.querySelectorAll('#listings-body tr').length;

        // index â†’ ì™¼ìª½ ë§¤ë¬¼ë²ˆí˜¸ ìˆ«ì ì¶”ì¶œ
        const getListingIdByIndex = (index) => {
          const raw = document.querySelector(`input[data-index="${index}"]`)?.value.trim() || '';
          const num = Number(raw.replace(/[^\d]/g, ''));
          return isNaN(num) ? null : num;
        };

        // ìˆ«ì í•„ë“œ íŒŒì‹±
        const getNumericFromField = (field, index) => {
          const el = document.querySelector(`[data-field="${field}_${index}"]`);
          if (!el) return null;
          const val = (el.tagName === 'SPAN' ? el.textContent : el.value || '').replace(/,/g, '').trim();
          const n = Number(val);
          return isNaN(n) ? null : n;
        };

        // ë¬¸ìì—´ í•„ë“œ íŒŒì‹±
        const getStringFromField = (field, index) => {
          const el = document.querySelector(`[data-field="${field}_${index}"]`);
          if (!el) return '';
          const v = el.tagName === 'SPAN' ? (el.textContent || '') : (el.value || '');
          return v.trim();
        };

        const rowsToInsert = [];
        for (let index = 1; index <= rowCount; index++) {
          const listingId     = getListingIdByIndex(index);

          const listing_title = getStringFromField('listing_title', index);
          const full_address  = getStringFromField('full_address', index);
          const combined_unit = getStringFromField('combined_unit', index);
          const description   = getStringFromField('description', index);

          const deposit_price = getNumericFromField('deposit_price', index);
          const monthly_rent  = getNumericFromField('monthly_rent', index);
          const premium_price = getNumericFromField('premium_price', index);
          const area_py       = getNumericFromField('area_py', index);

          // âœ… ìƒˆë¡œ ì¶”ê°€: ë©”ëª¨ 50ì¤„ íŒ¨ë„ì—ì„œ í•´ë‹¹ ì¤„ ë©”ëª¨ ê°’ ì½ê¸°
          const memoText = getMemoValue(index);

          // âœ… ì˜ë¯¸ ìˆëŠ” ë°ì´í„° íŒì •ì— memo í¬í•¨
          const hasMeaningful =
            (listing_title || full_address || combined_unit || description || memoText ||
            deposit_price !== null || monthly_rent !== null || premium_price !== null || area_py !== null);

          // ë²ˆí˜¸ê°€ ìˆê±°ë‚˜ ì˜ë¯¸ ìˆëŠ” ë°ì´í„°ê°€ ìˆëŠ” í–‰ë§Œ ì €ì¥
          if (listingId || hasMeaningful) {
            rowsToInsert.push({
              customers_id: String(currentCustomerId), // â† text ì»¬ëŸ¼ì— ë§ì¶° ë¬¸ìì—´ë¡œ ì €ì¥
              listing_id: listingId,                   // ì—†ìœ¼ë©´ null ì €ì¥
              listing_title,
              full_address,
              building_detail_info: combined_unit,
              deposit_price,
              monthly_rent,
              premium_price,
              area_py,
              contents: description ?? null, // 'ë‚´ìš©'ì€ contentsë¡œ
              memo: memoText || null,        // âœ… 'ë©”ëª¨'ëŠ” memoë¡œ
              order: index
            });
          }
        }

        // 1) í•´ë‹¹ ê³ ê°ì˜ ê¸°ì¡´ ì¶”ì²œë§¤ë¬¼ ì „ë¶€ ì‚­ì œ
        const { error: delErr } = await supabase
          .from('customers_recommendations')
          .delete()
          .eq('customers_id', currentCustomerId);

        if (delErr) {
          console.error('âŒ ê¸°ì¡´ ì¶”ì²œ ë§¤ë¬¼ ì‚­ì œ ì‹¤íŒ¨:', delErr);
          showToast('ê¸°ì¡´ ì¶”ì²œ ë§¤ë¬¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          return;
        }

        // 2) í˜„ì¬ í™”ë©´ì˜ í–‰ë§Œ ì¬ì‚½ì… (ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë¹ˆ ìƒíƒœë¡œ ë‘ )
        if (rowsToInsert.length > 0) {
          const { error: insErr } = await supabase
            .from('customers_recommendations')
            .insert(rowsToInsert);

          if (insErr) {
            console.error('âŒ ì¶”ì²œ ë§¤ë¬¼ ì‚½ì… ì‹¤íŒ¨:', insErr);
            showToast('ì¶”ì²œ ë§¤ë¬¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            return;
          }
        }

        showToast('ì¶”ì²œ ë§¤ë¬¼ ì €ì¥ ì™„ë£Œ');
      }

      // ì™¼ìª½ ê³ ê° ëª©ë¡ ê°±ì‹ 
      loadCustomersForCurrentStaff();

      // âœ… ë¬´ì¡°ê±´ ì½ê¸°ëª¨ë“œë¡œ ì „í™˜
      if (isEditMode) {
        toggleButton.click();
      }
    });

    // ê±´ë¬¼ì •ë³´, í˜¸ìˆ˜, ì¸µ í•˜ë‚˜ë¡œ í•©ì¹˜ëŠ” í•¨ìˆ˜
    function combineUnitInfo(buildingName, floor, unitInfo) {
      const parts = [];

      if (buildingName && buildingName !== '-') {
        parts.push(buildingName);
      }

      if (floor && floor !== '-') {
        const floorStr = String(floor);
        parts.push(floorStr.endsWith('ì¸µ') ? floorStr : floorStr + 'ì¸µ');
      }
        
      if (unitInfo && unitInfo !== '-') {
        const unitStr = String(unitInfo).trim();
        const endsWithHo = unitStr.endsWith('í˜¸');
        const endsWithIlbu = unitStr.endsWith('ì¼ë¶€');
        const containsJeonche = unitStr.includes('ì „ì²´');

        const displayUnit = (endsWithHo || endsWithIlbu || containsJeonche)
          ? unitStr
          : unitStr + 'í˜¸';

        parts.push(displayUnit);
      }

      return parts.join(' ');
    }

    // ì´ë¯¸ì§€ ì˜† ì˜¤ëŠ˜ ë‚ ì§œ ì¶œë ¥
    function displayTodayDate() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');

      const dateStr = `${yyyy}-${mm}-${dd}`; // ì˜ˆ: 2025-08-04
      const dateEl = document.getElementById('today-date');
      if (dateEl) dateEl.textContent = dateStr;
    }

    // ì´ë¯¸ì§€ ì˜† ë‹´ë‹¹ì ì •ë³´ ì¶œë ¥
    async function displayStaffInfo() {
      const { data: { user }, error: userError } = await supabase.auth.getUser();

      if (userError || !user) {
        console.warn('âŒ ë¡œê·¸ì¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', userError);
        return;
      }

      const { data: staff, error: staffError } = await supabase
        .from('staff_profiles')
        .select('position, name, phone_num')
        .eq('user_id', user.id)
        .maybeSingle();

      if (staffError || !staff) {
        console.warn('âŒ staff_profiles ì¡°íšŒ ì‹¤íŒ¨:', staffError);
        return;
      }

      const text = `${staff.position} ${staff.name} ${staff.phone_num}`;
      const el = document.getElementById('staff-info');
      if (el) el.textContent = text;
    }


    // === ì†ë‹˜ ì‚­ì œ ë²„íŠ¼ ===
    document.getElementById('delete-customer')?.addEventListener('click', async () => {
      try {
        if (!currentCustomerId) { showToast('ë¨¼ì € ê³ ê°ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

        // ê¶Œí•œ ì²´í¬: ëŒ€í‘œ/ë³´ì¡°ë§Œ ì‚­ì œ ê°€ëŠ¥
        if (!(await isMyAssignedCustomer(currentCustomerId))) {
          showToast('ë‹´ë‹¹ìê°€ ì•„ë‹Œ ê³ ê°ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        const name = (document.getElementById('top-row-input')?.value || '').trim();
        const ok = confirm(`ì •ë§ë¡œ "${name || 'ì´ ê³ ê°'}"ì„(ë¥¼) ì‚­ì œí• ê¹Œìš”?\nì¶”ì²œ ë§¤ë¬¼/ë‹´ë‹¹ ë°°ì • ë“± ê´€ë ¨ ë°ì´í„°ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`);
        if (!ok) return;

        // 1) ì—°ê´€ ë°ì´í„°ë¶€í„° ì‚­ì œ (FK ì¶©ëŒ ë°©ì§€)
        const { error: recErr } = await supabase
          .from('customers_recommendations')
          .delete()
          .eq('customers_id', String(currentCustomerId)); // text ì»¬ëŸ¼ì´ë¼ ë¬¸ìì—´ ë¹„êµ

        if (recErr) {
          console.error('ì¶”ì²œë§¤ë¬¼ ì‚­ì œ ì‹¤íŒ¨:', recErr);
          showToast('ì¶”ì²œ ë§¤ë¬¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          return;
        }

        const { error: assErr } = await supabase
          .from('customer_assignees')
          .delete()
          .eq('customer_id', currentCustomerId);

        if (assErr) {
          console.error('ë‹´ë‹¹ ë°°ì • ì‚­ì œ ì‹¤íŒ¨:', assErr);
          showToast('ë‹´ë‹¹ ë°°ì • ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          return;
        }

        // 2) ê³ ê° ì‚­ì œ
        const { error: custErr } = await supabase
          .from('customers')
          .delete()
          .eq('id', currentCustomerId);

        if (custErr) {
          console.error('ê³ ê° ì‚­ì œ ì‹¤íŒ¨:', custErr);
          showToast('ê³ ê° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          return;
        }

        // 3) UI ì´ˆê¸°í™”
        currentCustomerId = null;

        // ì…ë ¥ê°’ë“¤ ì´ˆê¸°í™”
        document.getElementById('top-row-input').value = '';
        document.getElementById('customer-phone').value = '';
        document.getElementById('customer-grade').value = 'F';
        document.getElementById('memo-textarea').value = '';

        // ì™¼ìª½ ë§¤ë¬¼ë²ˆí˜¸ ì „ì²´ ë¹„ìš°ê¸°(+change ë””ìŠ¤íŒ¨ì¹˜ë¡œ ì˜¤ë¥¸ìª½ë„ ì •ë¦¬)
        document.querySelectorAll('input[data-index]').forEach(inp => {
          if (inp.value && inp.value.trim() !== '') {
            inp.value = '';
            inp.dispatchEvent(new Event('change'));
          }
        });

        // ì˜¤ë¥¸ìª½ í‘œ ê°•ì œ ì´ˆê¸°í™”(ë³´í˜¸ì )
        const listingsBodyEl = document.getElementById('listings-body');
        if (listingsBodyEl) listingsBodyEl.innerHTML = '';

        // (ì¶”ê°€) ë©”ëª¨ íŒ¨ë„ ë¹„ìš°ê¸°
        const memoBody = document.getElementById('memo-body'); 
        if (memoBody) memoBody.innerHTML = '';

        // ì§ì› í‘œì‹œ/ì„ íƒ UI ì •ë¦¬
        document.getElementById('staff-info')?.classList.add('hidden');
        document.getElementById('staff-select')?.classList.add('hidden');

        // ì™¼ìª½ ê³ ê° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        loadCustomersForCurrentStaff?.();

        showToast('ê³ ê°ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.');
      } catch (e) {
        console.error('ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸:', e);
        showToast('ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
      
      loadCustomersForCurrentStaff();
    });

     // âœ… ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('copy-link-btn')?.addEventListener('click', () => {
      const text = buildAllMessages();
      if (!text) {
        showToast('ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      copyToClipboard(text);
    });

    let wasEditModeForPrint = false;
    let portalEl = null;

    function buildPrintPortal() {
      // í¸ì§‘ëª¨ë“œë©´ ë³´ê¸° ì¢‹ê²Œ spanìœ¼ë¡œ ì„ì‹œ ì „í™˜
      wasEditModeForPrint = isEditMode;
      if (isEditMode) switchInputsToSpans();

      // ê¸°ì¡´ í¬í„¸ ì œê±°
      portalEl?.remove();

      // #print-block ë³µì œí•´ì„œ body ë°”ë¡œ ì•„ë˜ í¬í„¸ë¡œ ë¶™ì„
      const src = document.getElementById('print-block');
      if (!src) return;
      portalEl = document.createElement('div');
      portalEl.id = 'print-portal';
      // í•„ìš”í•œ ìµœì†Œ ìŠ¤íƒ€ì¼(ì—¬ë°± ì œê±°)
      portalEl.style.margin = '0';
      portalEl.style.padding = '0';
      portalEl.appendChild(src.cloneNode(true)); // ê¹Šì€ ë³µì œ
      document.body.appendChild(portalEl);
    }

    function cleanupPrintPortal() {
      // í¬í„¸ ì œê±°
      portalEl?.remove();
      portalEl = null;

      // ì¸ì‡„ ì „ì´ í¸ì§‘ëª¨ë“œì˜€ìœ¼ë©´ ì›ë³µ
      if (wasEditModeForPrint) {
        switchSpansToInputs();
      }

      // ì¤„ë¬´ëŠ¬/ë†’ì´ ë‹¤ì‹œ ë§ì¶¤(ë³´í˜¸ì  í˜¸ì¶œ)
      applyRowStriping?.();
      syncRowHeights?.();
    }

    window.addEventListener('beforeprint', buildPrintPortal);
    window.addEventListener('afterprint', cleanupPrintPortal);

    document.getElementById('print-btn')?.addEventListener('click', () => {
      buildPrintPortal();   // í˜¹ì‹œ beforeprint ëª» ë°›ëŠ” ë¸Œë¼ìš°ì € ë³´ì •
      window.print();
      // ì¼ë¶€ ë¸Œë¼ìš°ì € ë³´ì •
      setTimeout(cleanupPrintPortal, 0);
    });
  </script>

  <!-- === [ì €ì¥ ê°œì„ ] ë‹¨ìˆœ ë®ì–´ì“°ê¸° ëª¨ë‹¬ === -->
  <div id="dup-customer-modal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-[9999]">
    <div class="bg-white w-[440px] max-w-[92vw] rounded-2xl shadow-2xl overflow-hidden">
      <div class="px-5 py-3 border-b font-semibold text-lg">
        ê°™ì€ ì´ë¦„ì˜ ê³ ê°ì´ ì´ë¯¸ ìˆìŠµë‹ˆë‹¤
      </div>
      <div class="p-5 space-y-3 max-h-[60vh] overflow-auto">
        <p class="text-sm text-gray-700">
          í˜„ì¬ ì…ë ¥í•œ ë‚´ìš©ìœ¼ë¡œ <b>ê¸°ì¡´ ê³ ê° ì •ë³´ë¥¼ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?</b>
        </p>
        <!-- ì„ íƒ ë¦¬ìŠ¤íŠ¸ëŠ” ì‚¬ìš© ì•ˆí•¨ -->
      </div>
      <div class="px-5 py-4 border-t flex items-center gap-2 justify-end bg-gray-50">
        <button id="dup-overwrite" class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold">
          ë®ì–´ì“°ê¸°
        </button>
        <button id="dup-cancel" class="px-3 py-2 rounded-xl text-gray-600 hover:bg-gray-200 text-sm">
          ì·¨ì†Œ
        </button>
      </div>
    </div>
  </div>
</body>
</html>
