<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>백억지도 </title>
    <link rel="icon" type="image/png" href="https://github.com/mhale45/image/raw/main/map/%EB%B0%B1%EC%96%B5%20%EC%8B%AC%EB%B3%BC.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f605c7b72dc7f3083f36483e55e2bc77&libraries=clusterer"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --header-height: 50px; --infopanel-left: 450px;}
        body { margin: 0; padding: 0; }
        header { position: fixed; top: 0; left: 0; right: 0; height: var(--header-height); z-index: 10000; background: #fff; }
        #map { position: absolute; top: var(--header-height); left: var(--infopanel-left); right: 0; bottom: 0; z-index: 0; }
        #info-panel { position: absolute; top: var(--header-height); left: 0; width: var(--infopanel-left); bottom: 0; z-index: 50; background: #fff; }
        #detail-panel { position: absolute; top: var(--header-height); left: var(--infopanel-left); width: 500px; bottom: 0; z-index: 9999; border-left: 5px solid #e5e7eb;}
        #filter-bar { display: flex; flex-direction: column; gap: 2px; margin-top: 0; }
    </style>
</head>
<body class="m-0 p-0">
    <!-- 헤더/필터 바 -->
    <header class="flex items-center gap-4 w-full h-[50px] px-6 py-4 bg-white shadow-md border-b border-gray-200 fixed top-0 left-0 z-[10000]">
        <img src="https://github.com/mhale45/image/raw/main/map/%EB%B0%B1%EC%96%B5%EA%B3%B5%EC%9D%B8%EC%A4%91%EA%B0%9C%EC%82%AC%EC%82%AC%EB%AC%B4%EC%86%8C%20%EA%B8%80%EC%94%A8%EB%A7%8C.png"
            alt="글씨로고" class="h-12 w-auto cursor-pointer" onclick="showLogin()" />
        <div class="relative">
            <button id="filter-btn-init" data-default-label="초기화" onclick="resetFilters()"
                class="ml-[100px] px-3 py-1.5 border border-gray-200 bg-red-100 text-red-600 rounded-md shadow-sm text-sm font-bold hover:bg-red-200 transition">초기화</button>
        </div>
        <div id="filter-bar" class="flex flex-row gap-2 items-start mt-2 relative z-[1000]">
            <div id="btn-wrap" class="flex flex-row gap-2"></div>
        </div>

        <!-- 필터링버튼들 -->
        <div id="filter-btns-wrap" class="flex gap-1"></div>

        <div style="flex:1"></div> <!-- 이 줄이 헤더에서 오른쪽 정렬 역할 -->

        <!-- 헤더 오른쪽에 로그아웃 버튼 -->
        <button id="logout-btn"
                onclick="logout()"
                class="hidden text-sm text-gray-600 hover:text-black border px-3 py-1 rounded">
            로그아웃
        </button>

    </header>
    
    <!-- 로그인 모달 -->
    <div id="login-modal"
        class="fixed inset-0 z-[20000] bg-black/40 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-lg p-8 w-80">
            <h2 class="font-bold text-xl mb-4 text-center">직원 로그인</h2>
            <input id="login-email" type="email" placeholder="이메일"
                class="w-full border border-gray-300 rounded px-3 py-2 mb-3" />
            <input id="login-password" type="password" placeholder="비밀번호"
                class="w-full border border-gray-300 rounded px-3 py-2 mb-4" />
            <button onclick="login()"
                    class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-semibold">
            로그인
            </button>
            <button onclick="hideLogin()"
                    class="w-full text-gray-500 mt-2">닫기</button>
            <div id="login-error" class="text-red-600 text-sm mt-2 hidden"></div>
        </div>
    </div>
    <!-- ✅ 로그인 중 로딩 오버레이 추가 -->
    <div id="loading-overlay"
        class="fixed inset-0 z-[30000] bg-black bg-opacity-40 flex items-center justify-center hidden">
    <div class="text-white text-xl font-bold">로그인 중입니다...</div>
    </div>
    <div id="map" class="absolute top-0 bottom-0 right-0 left-[340px] z-0 gap-0"></div>
    <!-- 지도 우측 하단 컨트롤 패널 -->
    <div id="map-controls" class="fixed z-[11000] flex flex-col items-center bottom-10  right-5">
        <!-- 새로 추가하는 버튼 (맨 위) -->
        <button id="btn-naver-map"
            class="w-[40px] h-10 shadow rounded-lg flex items-center justify-center border border-gray-300 bg-[#00de5a] hover:bg-[#00b74a] transition mb-3 text-white text-[50] font-[black]"
            style="text-shadow: 0 1px 2px #ffffff, 0 0 1px #ffffff;"
            title="네이버지도">
            N
        </button>
        <!-- 현재위치 버튼 -->
        <button id="btn-current-location"
            class="w-[40px] h-10 shadow rounded-lg flex items-center justify-center border border-gray-300 hover:bg-yellow-200 transition mb-5"
            style="background-color: #ffffff;"
            title="현재 위치로 이동">
            <span class="text-xl text-black font-bold">◉</span>
        </button>
        <div class="flex flex-col gap-0">
            <button id="btn-zoom-in"
                class="w-[40px] h-10 shadow rounded-lg flex items-center justify-center border border-gray-300 hover:bg-yellow-200 transition"
                style="background-color: #ffffff;"
                title="확대">
                <span class="text-2xl text-black font-bold">＋</span>
            </button>
            <button id="btn-zoom-out"
                class="w-[40px] h-10 shadow rounded-lg flex items-center justify-center border border-gray-300 hover:bg-yellow-200 transition"
                style="background-color: #ffffff;"
                title="축소">
                <span class="text-2xl text-black font-bold">－</span>
            </button>
        </div>
    </div>

    <div id="info-panel" class="absolute top-0 bottom-0 left-0 w-[340px] overflow-y-auto bg-white shadow-xl p-3 text-sm hidden z-50">
        <div id="info-content" class="text-xs text-gray-700"></div>
    </div>

    <!-- ✅ 상세 정보 패널 추가 -->
    <div id="detail-panel" class="absolute top-[70px] left-[340px] w-[400px] bottom-0 bg-white/90 backdrop-blur-sm shadow-xl text-sm hidden z-[1000] overflow-y-auto">
    <div id="detail-content" class="text-gray-800 text-sm whitespace-pre-line overflow-y-auto h-full"></div>
    </div>

    <!-- 버튼은 패널 바로 닫기 버튼 -->
    <button 
        id="close-detail-btn"
        onclick="hideDetailPanel()"
        class="fixed z-[1001] w-10 h-10 bg-white text-gray-600 border border-gray-300 hover:border-black hover:text-black shadow-md flex items-center justify-center font-bold text-lg hidden"
        style="top: 60px; left: 949px; display: none;">
        ✕
    </button>      

  <script>
    const supabaseUrl = 'https://sfinbtiqlfnaaarziixu.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaW5idGlxbGZuYWFhcnppaXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MDkxNjEsImV4cCI6MjA2ODA4NTE2MX0.4-7vnIjbF-biWWuv9-vTxK9Y99gMm-vS6oaRMdRL5fA';
    const client = supabase.createClient(supabaseUrl, supabaseKey);

    const HIGHLIGHT_COLOR = "#F2C130";
    const HIGHLIGHT_TEXT_COLOR = "#111";  // 선택 시 텍스트 색상
    const DEFAULT_BTN_BG = "#f3f4f6";     // bg-gray-100
    const DEFAULT_BTN_TEXT = "#374151";   // text-gray-700

    const PAGE_SIZE = 15;
    const allDealTypes = ['월세', '매매'];
    const allCategories = ['상가', '공장·창고']; // 카테고리 종류 (고정)
    const infoPanel = document.getElementById('info-panel');
    const infoContent = document.getElementById('info-content');
    const filterTypes = ['floor','sale','deposit','rent','total_deposit','total_rent','area_py'];

    const filterDefs = [
        { id: 'deposit',   label: '보증금',    width: 300 },
        { id: 'rent',      label: '월세',      width: 280 },
        { id: 'floor',     label: '층',        width: 280 },
        { id: 'area_py',   label: '전용평수',  width: 280 },
        { id: 'sale',      label: '매매가',    width: 300 },
        { id: 'total_deposit', label: '총보증금', width: 300 },
        { id: 'total_rent', label: '총월세',   width: 280 },
    ];

    let selectedDealTypes = ['월세'];
    let selectedCategories = ['상가']; // 선택된 카테고리 (여러개 가능)
    
    let allListings = {};
    let isLoading = false;  

    let allMarkers = {};
    let map, customImage;   // 카카오맵 객체
    let clusterer, mapIdleTimer = null;
    let selectedClusterEl = null;  // 클러스터 색 반전 위함
    let isLoggedIn = false; // 페이지 최상단 스크립트 영역에 선언

    map = new kakao.maps.Map(document.getElementById('map'), {
      center: new kakao.maps.LatLng(37.7151, 126.7341),
      level: 3
    });

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            map.setCenter(new kakao.maps.LatLng(lat, lng));
        }, function(error) {
            console.log("위치 정보를 사용할 수 없습니다.", error);
        });
    } else {
        console.log("이 브라우저에서는 Geolocation을 지원하지 않습니다.");
    }

    infoPanel.style.display = 'block';

    clusterer = new kakao.maps.MarkerClusterer({
        map: map,
        averageCenter: true,
        minLevel: 1,
        minClusterSize: 1, // ✅ 마커가 1개여도 클러스터 처리
        disableClickZoom: true,
        gridSize: 30,
        styles: [
            {
                width: '40px',
                height: '40px',
                background: HIGHLIGHT_COLOR,
                border: 'none',
                borderRadius: '50%',
                color: '#fff', // ✅ 글자색 흰색으로 변경
                fontWeight: 'bold',
                textAlign: 'center',
                lineHeight: '40px'
            }
            ]
    });


    customImage = new kakao.maps.MarkerImage(
      'https://raw.githubusercontent.com/mhale45/image/2d7ce4379b14d095d2f0b7f1d0057987548a37bf/2.png',
      new kakao.maps.Size(36, 36),
      { offset: new kakao.maps.Point(18, 36) }
    );

    function renderFilterButtons() {
        const wrap = document.getElementById('filter-btns-wrap');
        wrap.innerHTML = '';

        filterDefs.forEach(def => {
            // 필터링 버튼
            const btn = document.createElement('button');
            btn.id = `filter-btn-${def.id}`;
            btn.setAttribute('data-default-label', def.label + ' ▼');
            btn.className = "px-2 py-2 border border-gray-300 bg-white rounded-md shadow-sm text-[14px] text-gray-800 font-medium hover:bg-gray-100";
            btn.innerText = def.label + ' ▼';
            btn.onclick = () => toggleFilterPanel(def.id);

            // 드롭다운 패널
            const panel = document.createElement('div');
            panel.id = `filter-panel-${def.id}`;
            panel.className = "hidden absolute left-0 mt-1 bg-white border rounded shadow z-50";
            panel.style.width = `${def.width}px`;

            const inner = document.createElement('div');
            inner.className = "flex items-center gap-2 p-3";
            inner.innerHTML = `
                <input id="${def.id}_min" type="number" placeholder="이상" class="w-20 px-2 py-1 border rounded text-sm" />
                <span class="text-gray-500">~</span>
                <input id="${def.id}_max" type="number" placeholder="이하" class="w-20 px-2 py-1 border rounded text-sm" />
            `;
            panel.appendChild(inner);

            // 버튼과 패널을 하나의 div로 묶기
            const box = document.createElement('div');
            box.className = 'relative';
            box.appendChild(btn);
            box.appendChild(panel);

            wrap.appendChild(box);

            // ⭐⭐⭐ [여기!] 이벤트 연결은 DOM에 추가된 뒤에 해야함 ⭐⭐⭐
            setTimeout(() => {
                const minInput = document.getElementById(`${def.id}_min`);
                const maxInput = document.getElementById(`${def.id}_max`);
                if (minInput) minInput.addEventListener('input', () => {
                    updateFilterButtonText(def.id);
                    updateFilteredListings();
                });
                if (maxInput) maxInput.addEventListener('input', () => {
                    updateFilterButtonText(def.id);
                    updateFilteredListings();
                });
            }, 0);
        });
    }


    // 클러스터 레벨별 뭉쳐지게
    function createClusterer(gridSize) {
        if (clusterer) clusterer.clear();
        clusterer = new kakao.maps.MarkerClusterer({
            map: map,
            averageCenter: true,
            minLevel: 1,
            minClusterSize: 1,
            disableClickZoom: true,
            gridSize: gridSize,
            styles: [
                {
                    width: '40px',
                    height: '40px',
                    background: HIGHLIGHT_COLOR,
                    border: 'none',
                    borderRadius: '50%',
                    color: '#fff',
                    fontWeight: 'bold',
                    textAlign: 'center',
                    lineHeight: '40px'
                }
            ]
        });
        
        // 클러스터 클릭 시
        kakao.maps.event.addListener(clusterer, 'clusterclick', function(cluster) {
            const clusterOverlay = cluster.getClusterMarker(); // 클러스터 마커 객체
            if (selectedClusterEl) {
                selectedClusterEl.style.border = "none";
                selectedClusterEl.style.borderRadius = "50%";
                const prevInner = selectedClusterEl.querySelector('div');
                if (prevInner) {
                    prevInner.style.background = HIGHLIGHT_COLOR; // 원래 배경
                    prevInner.style.color = "#fff";               // 원래 숫자색
                }
                selectedClusterEl = null;
            }

            // 새로 클릭된 클러스터 DOM
            const clusterEl = cluster.getClusterMarker().getContent().parentNode;
            if (clusterEl) {
                // 외곽 테두리만 남김
                clusterEl.style.background = "transparent";
                clusterEl.style.border = "2px solid #F2C130";
                clusterEl.style.borderRadius = "50%";

                // 내부 숫자 div 배경 흰색 + 텍스트 노란색
                const inner = clusterEl.querySelector('div');
                if (inner) {
                    inner.style.background = "#ffffff";
                    inner.style.color = "#F2C130";
                    inner.style.borderRadius = "50%";  // 혹시 내부도 모서리가 꺾이면 추가
                }

                selectedClusterEl = clusterEl;
            }


            // 인포패널 내용 표시
            const markerList = cluster.getMarkers();
            const listings = markerList.map(mk => allListings[mk.listing_id]).filter(Boolean);
            showListingsInPanel(listings);
        });
    }



    function renderDealAndCategoryButtons() {
        const btnWrap = document.getElementById('btn-wrap');
        btnWrap.innerHTML = '';

        // 거래유형(월세, 매매) 버튼
        allDealTypes.forEach(type => {
            const btn = document.createElement('button');
            btn.textContent = selectedDealTypes.includes(type) ? '✓ ' + type : type;
            btn.className = "px-3 py-2 rounded-full border border-gray-300 text-[13px] font-medium transition mr-0";
            btn.onclick = function() { toggleDealType(type); };
            if (selectedDealTypes.includes(type)) {
                btn.style.backgroundColor = HIGHLIGHT_COLOR;
                btn.style.color = HIGHLIGHT_TEXT_COLOR;
                btn.style.fontWeight = 'bold';
                btn.style.borderColor = "#eab308";
            } else {
                btn.style.backgroundColor = DEFAULT_BTN_BG;
                btn.style.color = DEFAULT_BTN_TEXT;
                btn.style.fontWeight = 'normal';
                btn.style.borderColor = "#d1d5db";
            }
            btnWrap.appendChild(btn);
        });

        // 카테고리(상가, 공장창고) 버튼
        allCategories.forEach(cat => {
            const btn = document.createElement('button');
            btn.textContent = selectedCategories.includes(cat) ? '✓ ' + cat : cat;
            btn.className = "px-3 py-2 rounded-full border border-gray-300 text-[13px] font-medium transition mr-0";
            btn.onclick = function () {
                if (selectedCategories.includes(cat)) {
                    selectedCategories = selectedCategories.filter(c => c !== cat);
                } else {
                    selectedCategories.push(cat);
                }
                renderDealAndCategoryButtons();
                updateFilteredListings();
            };
            if (selectedCategories.includes(cat)) {
                btn.style.backgroundColor = HIGHLIGHT_COLOR;
                btn.style.color = HIGHLIGHT_TEXT_COLOR;
                btn.style.fontWeight = 'bold';
                btn.style.borderColor = "#eab308";
            } else {
                btn.style.backgroundColor = DEFAULT_BTN_BG;
                btn.style.color = DEFAULT_BTN_TEXT;
                btn.style.fontWeight = 'normal';
                btn.style.borderColor = "#d1d5db";
            }
            btnWrap.appendChild(btn);
        });
    }

    // 거래유형 버튼 클릭 시 해당 유형 선택/해제 및 UI, 리스트 업데이트
    function toggleDealType(type) {
        if (selectedDealTypes.includes(type)) {
            if (selectedDealTypes.length > 1) {
                selectedDealTypes = selectedDealTypes.filter(x => x !== type);
            }
        } else {
            selectedDealTypes.push(type);
        }
        renderDealAndCategoryButtons();
        updateFilteredListings();
    }


    // 매물 카드 클릭 시 상세 패널을 열고 상세 내용을 표시
    function showDetailPanel(listingId) {
        window.currentDetailListingId = listingId;
        renderMatchedListings(); // ⭐ 하이라이트 적용 위해 리스트 다시 렌더

        const listing = allListings[listingId];
        if (!listing) return;

        const detailContent = `
            <div class="sticky top-0 z-10 bg-white shadow-sm p-2 rounded transition cursor-pointer whitespace-normal" onclick="showDetailPanel(${listing.listing_id})">
                <div class="flex items-start gap-2">
                    <div class="w-[61px] h-[26px] flex justify-center items-center border-[2px] border-[rgb(242,193,48)] text-[rgb(0,0,0)] px-1 py-0 rounded text-base font-bold">
                        ${listing.listing_id}
                    </div>
                    <div class="flex-1 text-left font-semibold text-[rgb(80,152,233)] text-base translate-y-[-2px] translate-y-[3px] leading-tight">
                        ${listing.deal_type}
                        ${listing.deal_type === "매매"
                            ? ` ${formatKoreanMoney(listing.sale_price)}`
                            : listing.deal_type === "월세"
                            ? ` ${formatKoreanMoney(listing.deposit_price)} / ${formatKoreanMoney(listing.monthly_rent)}`
                            : ""
                        }
                        <span class="text-[13px] text-gray-700 ml-2">
                            전용 <strong class="font-semibold">${Number(listing.area_py).toFixed(1)}</strong>평,
                            <strong class="font-semibold">${formatFloor(listing.floor, listing.floor_type)}</strong>층
                        </span>
                    </div>
                </div>
            </div>
            <div class="mb-2 px-4">
                <span class="font-medium whitespace-pre-line">${listing.description}</span>
            </div>
        `;




        const panel = document.getElementById('detail-panel');
        const content = document.getElementById('detail-content');
        const closeBtn = document.getElementById('close-detail-btn');

        // ✅ 패널 내용 채우기
        content.innerHTML = detailContent;

        // ✅ 스크롤 맨 위로 이동
        content.scrollTop = 0;

        // ✅ 패널 보이기
        panel.classList.remove('hidden');
        panel.style.display = 'block';
                
        // ✅ 버튼도 같이 show
        closeBtn.classList.remove('hidden');
        closeBtn.style.display = 'block';
    }
    
    //상세 패널과 닫기 버튼, 모든 필터 패널 숨김 처리
    function hideDetailPanel() { 
        const detailPanel = document.getElementById('detail-panel');
        const closeBtn = document.getElementById('close-detail-btn');
        detailPanel.classList.add('hidden');
        detailPanel.style.display = 'none';

        // ✅ 버튼도 같이 hide
        closeBtn.classList.add('hidden');
        closeBtn.style.display = 'none';
        
        // 패널 전부 닫기
        document.querySelectorAll('[id^="filter-panel-"]').forEach(p => p.classList.add('hidden'));
    }
    
    // 가격 숫자를 '억', '만' 등 한국식 단위로 포맷팅
    function formatKoreanMoney(value) {
        if (!value && value !== 0) return '-';
        const num = Number(value);
        if (num >= 10000) {
            const eok = Math.floor(num / 10000);
            const man = num % 10000;
            const manStr = man > 0 ? `${man.toLocaleString()}` : '';
            return `${eok}억${manStr ? ' ' + manStr : ''}`;
        } else {
            return `${num.toLocaleString()}`;
        }
    }

    // 타입(매매가, 보증금 등)에 따라 숫자를 '억/만/평/층' 등으로 보기 좋게 포맷팅
    function formatValue(type, val) {
        if (val === "" || val === undefined || val === null) return '-';
        const num = Number(val);

        // '만' 단위(억, 만 변환)
        if (['sale', 'deposit', 'rent', 'total_deposit', 'total_rent'].includes(type)) {
            if (isNaN(num)) return '-';
            if (num >= 10000) {
                const eok = Math.floor(num / 10000);
                const man = num % 10000;
                const manStr = man > 0 ? `${man.toLocaleString()}` : '';
                return `${eok}억${manStr ? ' ' + manStr : ''}`;
            } else {
                return num.toLocaleString() + '만';
            }
        }

        // '층', '전용평수' 등 숫자 + 단위 붙이기
        if (['floor', 'area_py'].includes(type)) {
            if (isNaN(num)) return '-';
            return num + filterUnits[type];
        }

        // 나머지 그냥 반환
        return val;
    }

    //각 필터 버튼에 input 값(최소~최대 등)이 실시간으로 표시되도록 라벨 업데이트 + 강조 스타일 적용
    function updateFilterButtonText(type) {
        let min = document.getElementById(`${type}_min`)?.value;
        let max = document.getElementById(`${type}_max`)?.value;
        let btn = document.getElementById(`filter-btn-${type}`);
        let label = "";

        if (min && max) label = `${formatValue(type, min)}~${formatValue(type, max)}`;
        else if (min) label = `${formatValue(type, min)}~`;
        else if (max) label = `~${formatValue(type, max)}`;
        else label = btn ? btn.getAttribute('data-default-label') || '▼' : '▼';

        if (btn) {
            btn.textContent = label;
            // 강조 스타일
            if (label !== btn.getAttribute('data-default-label')) {
                btn.style.backgroundColor = HIGHLIGHT_COLOR;
                btn.style.color = "#111";
                btn.style.borderColor = "#eab308";
                btn.style.fontWeight = "bold";
            } else {
                btn.style.backgroundColor = "#fff";
                btn.style.color = "#374151";
                btn.style.borderColor = "#d1d5db";
                btn.style.fontWeight = "normal";
            }
        }
    }


    // 층수 표시 시 지하는 'B', 일반층은 숫자로 표기
    function formatFloor(floor, floor_type) {
        const abs = Math.abs(floor);
        if (floor_type === '지하' || floor < 0) {
            return `B${abs}`;
        }
        return `${floor}`;
    }
    
    // 클러스터 등에서 매물 리스트 패널 열고, 매물 목록을 info-panel에 출력
    function showListingsInPanel(listings) {
        matchedListingsCache = listings;
        matchedListingsPage = 1;
        if (typeof renderMatchedListings === "function") renderMatchedListings();
        infoPanel.classList.remove("hidden");
        infoPanel.style.display = 'block';
        setTimeout(() => {
            infoPanel.scrollTop = 0;
        }, 0);
    }

    // 평수 값이 비었거나 이상할 때 '-'로, 아니면 소수 1자리로 표시
    function formatArea(area_py) {
        const value = String(area_py).trim();
        if (
            area_py === undefined ||
            area_py === null ||
            value === "" ||
            value === "-" ||
            value.toLowerCase() === "nan" || // 'NaN', 'nan' 모두 대응
            isNaN(Number(area_py))
        ) return '-';
        return Number(area_py).toFixed(1);
    }

    // 로그인 모달 닫기
    function hideLogin() {
        document.getElementById('login-modal').classList.add('hidden');
    }

    // 로그인 모달 열기
    function showLogin() {
        document.getElementById('login-modal').classList.remove('hidden');
    }
        
    async function login() {
        showLoadingOverlay();  // 로그인 시작 시 오버레이 보여주기

        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value.trim();
        const errorDiv = document.getElementById('login-error');
        errorDiv.classList.add('hidden');

        if (!email || !password) {
            errorDiv.textContent = '이메일과 비밀번호를 입력하세요.';
            errorDiv.classList.remove('hidden');
            hideLoadingOverlay();  // 실패 시 오버레이 숨기기
            return;
        }

        const { data, error } = await client.auth.signInWithPassword({ email, password });
        if (error) {
            errorDiv.textContent = '로그인 실패: ' + error.message;
            errorDiv.classList.remove('hidden');
            hideLoadingOverlay();  // 실패 시 오버레이 숨기기
            return;
        }

        isLoggedIn = true;
        hideLogin();
        document.getElementById('logout-btn')?.classList.remove('hidden');

        // 🔽 지도 클러스터/마커 초기화
        clusterer.clear();  // 기존 클러스터 제거
        allListings = {};   // 매물 데이터 초기화
        allMarkers = {};    // 마커 초기화

        await loadListingsInBounds();  // 로그인 후 데이터 새로 로딩
        hideLoadingOverlay();  // 완료 후 오버레이 숨기기
    }


    function showLoadingOverlay() {
        document.getElementById('loading-overlay').classList.remove('hidden');
    }

    function hideLoadingOverlay() {
        document.getElementById('loading-overlay').classList.add('hidden');
    }

    async function logout() {
        await client.auth.signOut();
        location.reload();  // 완전 초기화
    }

    // 필터링 함수
    function getFilterValues() {
        return {
            floor_min: parseFloat(document.getElementById('floor_min').value),
            floor_max: parseFloat(document.getElementById('floor_max').value),
            sale_price_min: parseFloat(document.getElementById('sale_min').value),
            sale_price_max: parseFloat(document.getElementById('sale_max').value),
            deposit_price_min: parseFloat(document.getElementById('deposit_min').value),
            deposit_price_max: parseFloat(document.getElementById('deposit_max').value),
            monthly_rent_min: parseFloat(document.getElementById('rent_min').value),
            monthly_rent_max: parseFloat(document.getElementById('rent_max').value),
            total_deposit_min: parseFloat(document.getElementById('total_deposit_min').value),
            total_deposit_max: parseFloat(document.getElementById('total_deposit_max').value),
            total_rent_min: parseFloat(document.getElementById('total_rent_min').value),
            total_rent_max: parseFloat(document.getElementById('total_rent_max').value),
            area_py_min: parseFloat(document.getElementById('area_py_min').value),
            area_py_max: parseFloat(document.getElementById('area_py_max').value),
        };
    }

    // 실제로 allListings에서 조건에 맞는 것만 반환
    function filterListings(listings) {
        const f = getFilterValues();
        return listings.filter(l => {
            if (!selectedDealTypes.includes(l.deal_type)) return false; // 카테고리 매매, 월세
            if (selectedCategories.length > 0 && !selectedCategories.includes(l.category)) return false;// 카테고리 상가, 주택, 공장창고
            // 층
            if (!isNaN(f.floor_min) && l.floor < f.floor_min) return false;
            if (!isNaN(f.floor_max) && l.floor > f.floor_max) return false;
            // 매매가
            if (!isNaN(f.sale_price_min) && l.sale_price < f.sale_price_min) return false;
            if (!isNaN(f.sale_price_max) && l.sale_price > f.sale_price_max) return false;
            // 보증금
            if (!isNaN(f.deposit_price_min) && l.deposit_price < f.deposit_price_min) return false;
            if (!isNaN(f.deposit_price_max) && l.deposit_price > f.deposit_price_max) return false;
            // 월세
            if (!isNaN(f.monthly_rent_min) && l.monthly_rent < f.monthly_rent_min) return false;
            if (!isNaN(f.monthly_rent_max) && l.monthly_rent > f.monthly_rent_max) return false;
            // 총보증금
            if (!isNaN(f.total_deposit_min) && l.total_deposit < f.total_deposit_min) return false;
            if (!isNaN(f.total_deposit_max) && l.total_deposit > f.total_deposit_max) return false;
            // 총월세
            if (!isNaN(f.total_rent_min) && l.total_rent < f.total_rent_min) return false;
            if (!isNaN(f.total_rent_max) && l.total_rent > f.total_rent_max) return false;
            // 전용평수
            if (!isNaN(f.area_py_min) && l.area_py < f.area_py_min) return false;
            if (!isNaN(f.area_py_max) && l.area_py > f.area_py_max) return false;
            return true;
        });
    }

    // 상단 필터링 버튼 눌렀을 때 패널
    function toggleFilterPanel(type) {
        const panelIds = ['floor', 'sale', 'deposit', 'rent', 'total_deposit', 'total_rent', 'area_py', 'init'];
        panelIds.forEach(id => {
            const panel = document.getElementById(`filter-panel-${id}`);
            if (panel) {
            if (id === type) {
                panel.classList.toggle('hidden');
            } else {
                panel.classList.add('hidden');
            }
            }
        });
    }

    // 지도/리스트를 필터값에 맞게 새로 그림
    function updateFilteredListings() {
        const filtered = filterListings(Object.values(allListings)); // ✅

        clusterer.clear();
        const markers = [];
        filtered.forEach(listing => {
            // 캐시된 마커가 있으면 그걸, 없으면 새로 만든다
            if (!allMarkers[listing.listing_id]) {
                const marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(listing.lat, listing.lng),
                    image: customImage
                });
                if (!listing || !listing.listing_id || !listing.lat || !listing.lng) return;
                allMarkers[listing.listing_id] = marker;
            }
            markers.push(allMarkers[listing.listing_id]);
        });
        clusterer.addMarkers(markers);     

        // infoPanel의 리스트도 갱신
        matchedListingsCache = filtered;
        matchedListingsPage = 1;
        if (typeof renderMatchedListings === "function") renderMatchedListings();
    }

    // 매물 리스트 렌더링 함수
    function renderMatchedListings() {
        if (!Array.isArray(matchedListingsCache)) return;
        const start = 0;
        const end = matchedListingsPage * PAGE_SIZE;
        const listingsToShow = matchedListingsCache.slice(start, end);            

        const listText = listingsToShow.map(l => {
            // 기존 템플릿(카드) 복사
            const statusRaw = l.transaction_status || '-';
            const status = statusRaw.trim().split(' ')[0];

            let bgStyle = 'background-color: #e5e7eb; color: #374151;';
            if (status === '진행중') {
                bgStyle = 'background-color: rgba(250,230,172); color: black;';
            } else if (status === '계약완료') {
                bgStyle = 'background-color: rgba(255,237,237); color: rgba(247,63,87); font-weight: 900;';
            }

            const normalize = (val) => String(val || '').replace(/\s+/g, '');
            const isActive = String(window.currentDetailListingId).trim() === String(l.listing_id).trim();
            const highlightStyle = isActive
            ? 'background-color: rgba(243,244,246);'
            : '';

            return `
                <div class="mb-5 pb-2 border-b border-gray-300 text-left" style="${highlightStyle};">
                    <div onclick="showDetailPanel(${l.listing_id})" class="cursor-pointer hover:bg-gray-100 transition">
                        ${
                            isLoggedIn
                                ? `
                            <!-- ✅ 로그인 후 내부용 레이아웃 -->
                            <div class="flex flex-row items-center gap-3">
                                <div class="relative w-[120px] h-[100px]">
                                    <!-- 상태 뱃지 -->
                                    <div class="absolute top-1 left-1 w-[61px] h-[22px] flex items-center justify-center text-xs px-1 rounded-sm font-semibold z-10"
                                        style="${bgStyle}">
                                        ${status}
                                    </div>
                                    <!-- 썸네일 이미지 -->
                                    <img src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/biakuk-images//baikuk-simbol.png"
                                        alt="썸네일"
                                        class="w-full h-full object-cover rounded border" />
                                </div>                                
                                <div class="flex-1 flex flex-col gap-1">                                    
                                    <div class="flex items-center gap-2">
                                        <div class="flex flex-row items-center">
                                            <div class="w-[56px] h-[24px] flex justify-center items-center border-[1px] border-[rgb(242,193,48)] text-[rgb(0,0,0)] px-1 py-0 rounded text-sm font-bold">
                                                ${l.listing_id}
                                            </div>
                                            </div>
                                        <div class="flex-1 text-sm">
                                            전용 <strong class="font-semibold">${Number(l.area_py).toFixed(1)}</strong>평,
                                            <strong class="font-semibold">${formatFloor(l.floor, l.floor_type)}</strong>/${l.total_floors}층
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <strong class="text-base text-gray-800 max-w-[280px] truncate whitespace-nowrap overflow-hidden" title="${l.listing_title}">
                                            ${l.listing_title.length > 20 ? l.listing_title.slice(0, 20) + '⋯' : l.listing_title}
                                        </strong>
                                    </div>
                                    <div class="flex flex-col gap-[2px] leading-[1.4]">
                                        <div class="flex flex-row justify-between items-start">
                                            <div class="flex items-start gap-2">
                                                <div class="flex-1 text-left font-bold text-[rgb(80,152,233)] text-base">
                                                    ${l.deal_type}
                                                    ${
                                                        l.deal_type === "매매"
                                                            ? ` ${formatKoreanMoney(l.sale_price)}`
                                                            : l.deal_type === "월세"
                                                            ? ` ${formatKoreanMoney(l.deposit_price)} / ${formatKoreanMoney(l.monthly_rent)}`
                                                            : ""
                                                    }
                                                </div>
                                            </div>
                                            <div class="text-right font-bold text-[rgb(248,63,87)] text-base whitespace-nowrap">
                                                ${
                                                    l.premium_price === "0"
                                                        ? `무권리`
                                                        : `${formatKoreanMoney(l.premium_price)}`
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            `
                                : `
                            <!-- ✅ 비로그인 시 공개용 레이아웃 -->
                            <div class="flex flex-row items-center gap-3">
                                <img src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/biakuk-images//baikuk-simbol.png"
                                    alt="썸네일"
                                    class="w-[120px] h-[100px] object-cover rounded border flex-shrink-0" />

                                <div class="flex-1 flex flex-col gap-1">
                                    <div class="flex items-start gap-2">
                                        <div class="flex-1 text-left font-bold text-[rgb(80,152,233)] text-base">
                                            ${l.deal_type}
                                            ${
                                                l.deal_type === "매매"
                                                    ? ` ${formatKoreanMoney(l.sale_price)}`
                                                    : l.deal_type === "월세"
                                                    ? ` ${formatKoreanMoney(l.deposit_price)} / ${formatKoreanMoney(l.monthly_rent)}`
                                                    : ""
                                            }
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="flex-1 text-sm">
                                            전용 <strong class="font-semibold">${Number(l.area_py).toFixed(1)}</strong>평,
                                            <strong class="font-semibold">${formatFloor(l.floor, l.floor_type)}</strong>/${l.total_floors}층
                                        </div>
                                    </div>
                                    <div class="flex justify-between mt-1">
                                        <span class="inline-block text-[14px] text-[rgb(85,85,85)] leading-[1.4]">
                                            ${
                                                l.deal_type === "월세" && Number(l.premium_price) === 0
                                                    ? `<span style="
                                                            background-color:rgb(0,222,90,0.07);
                                                            color:rgb(16,177,120);
                                                            font-weight:bold;
                                                            border-radius:4px;
                                                            padding:1px 6px;
                                                            margin-right:4px;
                                                            font-size:12px;
                                                            vertical-align: 0.5px;
                                                        ">무권리</span>`
                                                    : ""
                                            }
                                            ${l.title}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            `
                        }
                    </div>
                </div>
            `;
        }).join('');

        infoContent.innerHTML = listText;
    }
    
    async function loadListingsInBounds() {
        if (isLoading) {
            return;
        }
        isLoading = true;

        const bounds = map.getBounds();
        const sw = bounds.getSouthWest();
        const ne = bounds.getNorthEast();

        // 확장된 범위
        const extSwLat = sw.getLat(); // 기존 sw 그대로
        const extSwLng = sw.getLng();
        const extNeLat = ne.getLat(); // 기존 ne 그대로
        const extNeLng = ne.getLng();
        const tableToQuery = isLoggedIn ? 'baikukdbtest' : 'public_baikuk_view';

        // ✅ 비로그인 시 내부 테이블 접근 방지
        if (!isLoggedIn && tableToQuery === 'baikukdbtest') {
            console.warn("비로그인 상태에서 내부 테이블 접근 시도 차단됨");
            isLoading = false;
            return;
        }

        // 1. 확장된 영역 내 매물ID 조회
        const { data: idData, error: idError } = await client
            .from(tableToQuery)
            .select('listing_id, lat, lng')
            .gte('lat', extSwLat)
            .lte('lat', extNeLat)
            .gte('lng', extSwLng)
            .lte('lng', extNeLng)
            .limit(1000); 

        if (idError) {
            alert("데이터를 불러오는 중 오류 발생: " + idError.message);
            isLoading = false;
            return;
        }

        // 2. 상세 데이터 fetch (캐시된 것 제외)
        const neededIds = idData.map(d => d.listing_id);
        const toFetch = neededIds.filter(id => !(id in allListings));
        if (toFetch.length > 0) {
            const { data: detailData, error: detailError } = await client
                .from(tableToQuery)
                .select('*')
                .in('listing_id', toFetch);
            if (detailError) {
                alert("상세 데이터 오류: " + detailError.message);
                isLoading = false;
                return;
            }
            detailData.forEach(l => { allListings[l.listing_id] = l; });
        }

        // 3. info-panel/마커 모두 "필터된 매물만" 반영!
        const listArr = neededIds.map(id => allListings[id]).filter(v => !!v);

        // 필터링
        const filtered = filterListings(listArr) || [];  // ← undefined 방지
        
        // ✅ 여기에 줌 레벨 별 gridSize 조절 (아래 코드 추가!)
        const level = map.getLevel();
        let gridSize;
        if (level <= 2) {
            gridSize = 10;
        } else if (level === 3) {
            gridSize = 30;
        } else if (level === 4) {
            gridSize = 40;
        } else {
            gridSize = 50;  // ← 이게 '동' 단위로 클러스터링의 근사값. (100~300px 사이로 조절)
        }
        createClusterer(gridSize);

        // 마커 클리어 및 새로 추가
        clusterer.clear();
        const markers = [];
        filtered.forEach(l => {
            if (!l.lat || !l.lng) return;
            if (!allMarkers[l.listing_id]) {
                const marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(l.lat, l.lng),
                    image: customImage
                });
                marker.listing_id = l.listing_id;
                allMarkers[l.listing_id] = marker;
            }
            markers.push(allMarkers[l.listing_id]);
        });
        clusterer.addMarkers(markers);

        // 리스트 패널
        matchedListingsCache = Array.isArray(filtered) ? filtered : [];
        matchedListingsPage = 1;
        if (typeof renderMatchedListings === "function") {
            renderMatchedListings();
        }

        isLoading = false;
    }

    // 최초 한 번 로딩
    loadListingsInBounds();
    
    // (1) 현재 지도 영역의 매물을 가져옴 (이미 allListings에 있음)
    matchedListingsCache = Object.values(allListings); // 전체 리스트 저장
    matchedListingsPage = 1;            // 첫 페이지로 초기화

    // (2) 리스트 15개만 info-panel에 그려줌
    if (typeof renderMatchedListings === "function") renderMatchedListings();

    const filterUnits = {
        floor: '층',
        sale: '만',
        deposit: '만',
        rent: '만',
        total_deposit: '만',
        total_rent: '만',
        area_py: '평'
    };


    function resetFilters() {
        // 모든 input 초기화
        filterTypes.forEach(type => {
            const minEl = document.getElementById(`${type}_min`);
            const maxEl = document.getElementById(`${type}_max`);
            if (minEl) minEl.value = "";
            if (maxEl) maxEl.value = "";
            updateFilterButtonText(type);
        });
        selectedCategories = ['상가'];
        selectedDealTypes = ['월세'];        
        renderDealAndCategoryButtons(); // 3. UI 다시 그림 ✅ 이게 핵심!
        loadListingsInBounds();
    }

    // 지도를 클릭하면 두 번째 패널 닫기
    kakao.maps.event.addListener(map, 'click', function () {
        hideDetailPanel();
        loadListingsInBounds();
    });

    // 1. 지도 idle 리스너는 딱 이것만!
    kakao.maps.event.addListener(map, 'idle', () => {
        if (mapIdleTimer) clearTimeout(mapIdleTimer);
        mapIdleTimer = setTimeout(() => {
            loadListingsInBounds();
        }, 200);
    });


    
    // 페이지 로딩 시 필터 버튼 표시
    document.addEventListener('DOMContentLoaded', async () => {
        renderDealAndCategoryButtons();
        renderFilterButtons();

        const { data: { session } } = await client.auth.getSession();
        if (session) {
            isLoggedIn = true;
            document.getElementById('logout-btn')?.classList.remove('hidden');
            console.log('✅ 로그인 세션 유지됨');
        } else {
            isLoggedIn = false;
            document.getElementById('logout-btn')?.classList.add('hidden');
            console.log('🔒 로그인 필요');
        }

        await loadListingsInBounds();
    });


    // 확대/축소/현재위치 버튼 이벤트 연결
    document.getElementById('btn-zoom-in').onclick = function() {
    map.setLevel(map.getLevel() - 1); // 더 확대 (레벨 낮을수록 확대)
    };
    document.getElementById('btn-zoom-out').onclick = function() {
    map.setLevel(map.getLevel() + 1); // 더 축소
    };
    document.getElementById('btn-current-location').onclick = function() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        map.setCenter(new kakao.maps.LatLng(lat, lng));
        });
    } else {
        alert('이 브라우저는 위치 정보를 지원하지 않습니다.');
    }
    };

    // info-panel 무한 스크롤(아래로 끝까지 내리면 다음 페이지)
    document.getElementById('info-panel').addEventListener('scroll', function () {
        const el = this;
        if (el.scrollTop + el.clientHeight >= el.scrollHeight - 50) {
            if (matchedListingsPage * PAGE_SIZE < matchedListingsCache.length) {
                matchedListingsPage++;
                renderMatchedListings();
            }
        }
    });

    document.getElementById('btn-naver-map').onclick = function () {
        let lat, lng;

        // 상세 패널이 열려 있고, 매물 데이터가 있으면 → 그 매물의 좌표 사용
        const detailPanel = document.getElementById('detail-panel');
        if (!detailPanel.classList.contains('hidden')) {
            // 상세 매물 ID는 showDetailPanel()에서 어딘가 저장 필요
            // 예시: window.currentDetailListingId에 보관
            if (window.currentDetailListingId && allListings[window.currentDetailListingId]) {
                lat = allListings[window.currentDetailListingId].lat;
                lng = allListings[window.currentDetailListingId].lng;
            }
        }

        // 상세 패널이 안 열렸거나, 매물 정보가 없으면 지도 중심 사용
        if (!lat || !lng) {
            const center = map.getCenter();
            lat = center.getLat();
            lng = center.getLng();
        }

        const naverUrl = `https://map.naver.com/v5/?c=${lng},${lat},17,0,0,0,d`;
        window.open(naverUrl, '_blank');
    };



    window.resetFilters = resetFilters;
  </script>
</body>
</html>
