<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ë°±ì–µì§€ë„ </title>
    <link rel="icon" type="image/png" href="https://github.com/mhale45/image/raw/main/map/%EB%B0%B1%EC%96%B5%20%EC%8B%AC%EB%B3%BC.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f605c7b72dc7f3083f36483e55e2bc77&libraries=clusterer"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --header-height: 90px;  /* ì´ ê°’ë§Œ ë°”ê¾¸ë©´ ëª¨ë“  íŒ¨ë„ì´ ìë™ ë°˜ì˜ */
        }
        body { margin: 0; padding: 0; }
        header {
            position: fixed;  /* <- í•„ìˆ˜! */
            top: 0; left: 0; right: 0;
            height: var(--header-height);
            z-index: 10000;
            background: #fff;
        }
        #map {
            position: absolute;
            top: var(--header-height);
            left: 340px;
            right: 0;
            bottom: 0;
            z-index: 0;
        }
        #info-panel {
            position: absolute;
            top: var(--header-height);
            left: 0;
            width: 340px;
            bottom: 0;
            z-index: 50;
        }
        #detail-panel {
            position: absolute;
            top: var(--header-height);
            left: 340px;
            width: 400px;
            bottom: 0;
            z-index: 9999;
        }
        #filter-bar {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-top: 0; /* í˜¹ì‹œ mt-2 ë“± ìˆìœ¼ë©´ ì‚­ì œ */
        }
        #office-info {
            /* flex, gap ë“±ë§Œ! */
            gap: 20px;
        }



    </style>
    <style>
        .filter-box-wrap {
        display: flex;
        align-items: center;
        gap: 0.5rem; /* gap-2 */
        padding: 0.75rem; /* p-3 */
        justify-content: space-between;
        }
        .filter-input {
        width: 5rem; /* w-20 */
        padding: 0.25rem 0.5rem; /* px-2 py-1 */
        border: 1px solid #d1d5db; /* border-gray-300 */
        border-radius: 0.375rem; /* rounded */
        font-size: 0.875rem; /* text-sm */
        color: #374151; /* text-gray-700 */
        }
        .filter-apply-btn {
        margin-left: 0.5rem;
        padding: 0.25rem 0.5rem;
        background-color: #2563eb; /* bg-blue-600 */
        color: white;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        }
    </style>
</head>
<body class="m-0 p-0">
    <!-- í—¤ë”/í•„í„° ë°” -->
    <header class="flex items-center gap-4 w-full h-[90px] px-6 py-4 bg-white shadow-md border-b border-gray-200 fixed top-0 left-0 z-[10000]">
        
        <img
            src="https://github.com/mhale45/image/raw/main/map/%EB%B0%B1%EC%96%B5%EA%B3%B5%EC%9D%B8%EC%A4%91%EA%B0%9C%EC%82%AC%EC%82%AC%EB%AC%B4%EC%86%8C%20%EA%B8%80%EC%94%A8%EB%A7%8C.png"
            alt="ê¸€ì”¨ë¡œê³ "
            class="h-12 w-auto cursor-pointer"
            onclick="showLogin()"
        />
        

        <!-- í•„í„°ì´ˆê¸°í™” -->
        <div class="relative">
        <button
            id="filter-btn-init"
            data-default-label="ì´ˆê¸°í™”"
            onclick="resetFilters()"
            class="ml-[100px] px-3 py-1.5 border border-gray-200 bg-red-100 text-red-600 rounded-md shadow-sm text-sm font-bold hover:bg-red-200 transition"
        >
            ì´ˆê¸°í™”
        </button>

        </div>

        <div id="filter-bar" class="flex flex-wrap gap-2 items-start mt-2 relative z-[1000] flex-col">
            <!-- ì²« ì¤„: ê±°ë˜ìœ í˜• -->
            <div id="deal-type-btn-wrap" class="flex gap-1 mb-0"></div>
            <!-- ë‘˜ì§¸ ì¤„: ì¹´í…Œê³ ë¦¬ -->
            <div id="category-btn-wrap" class="flex gap-1 mb-0"></div>
        <!-- ...ì´í•˜ ìƒëµ (í•„í„° ë²„íŠ¼ë“¤) -->
        </div>

        <!-- ë³´ì¦ê¸ˆ -->
        <div class="relative">
        <button id="filter-btn-deposit" data-default-label="ë³´ì¦ê¸ˆ â–¼" onclick="toggleFilterPanel('deposit')" class="px-3 py-1.5 border border-gray-300 bg-white rounded-md shadow-sm text-sm text-gray-800 font-medium hover:bg-gray-100">
            ë³´ì¦ê¸ˆ â–¼
        </button>
        <div id="filter-panel-deposit" class="hidden absolute left-0 mt-1 w-[300px] bg-white border rounded shadow z-50">
            <div class="flex items-center gap-2 p-3">
            <input id="deposit_min" type="number" placeholder="ì´ìƒ" class="w-24 px-2 py-1 border rounded text-sm" />
            <span class="text-gray-500">~</span>
            <input id="deposit_max" type="number" placeholder="ì´í•˜" class="w-24 px-2 py-1 border rounded text-sm" />
            </div>
        </div>
        </div>

        <!-- ì›”ì„¸ -->
        <div class="relative">
        <button id="filter-btn-rent" data-default-label="ì›”ì„¸ â–¼" onclick="toggleFilterPanel('rent')" class="px-3 py-1.5 border border-gray-300 bg-white rounded-md shadow-sm text-sm text-gray-800 font-medium hover:bg-gray-100">
            ì›”ì„¸ â–¼
        </button>
        <div id="filter-panel-rent" class="hidden absolute left-0 mt-1 w-[280px] bg-white border rounded shadow z-50">
            <div class="flex items-center gap-2 p-3">
            <input id="rent_min" type="number" placeholder="ì´ìƒ" class="w-20 px-2 py-1 border rounded text-sm" />
            <span class="text-gray-500">~</span>
            <input id="rent_max" type="number" placeholder="ì´í•˜" class="w-20 px-2 py-1 border rounded text-sm" />
            </div>
        </div>
        </div>

        <!-- ì¸µ -->
        <div class="relative">
        <button id="filter-btn-floor" data-default-label="ì¸µ â–¼" onclick="toggleFilterPanel('floor')" class="px-3 py-1.5 border border-gray-300 bg-white rounded-md shadow-sm text-sm text-gray-800 font-medium hover:bg-gray-100">
            ì¸µ â–¼
        </button>
        <div id="filter-panel-floor" class="hidden absolute left-0 mt-1 w-[280px] bg-white border rounded shadow z-50">
            <div class="flex items-center gap-2 p-3">
            <input id="floor_min" type="number" placeholder="ì´ìƒ" class="w-20 px-2 py-1 border rounded text-sm" />
            <span class="text-gray-500">~</span>
            <input id="floor_max" type="number" placeholder="ì´í•˜" class="w-20 px-2 py-1 border rounded text-sm" />
            </div>
        </div>
        </div>

        <!-- ì „ìš©í‰ìˆ˜ -->
        <div class="relative">
        <button id="filter-btn-area_py" data-default-label="ì „ìš©í‰ìˆ˜ â–¼" onclick="toggleFilterPanel('area_py')" class="px-3 py-1.5 border border-gray-300 bg-white rounded-md shadow-sm text-sm text-gray-800 font-medium hover:bg-gray-100">
            ì „ìš©í‰ìˆ˜ â–¼
        </button>
        <div id="filter-panel-area_py" class="hidden absolute left-0 mt-1 w-[280px] bg-white border rounded shadow z-50">
            <div class="flex items-center gap-2 p-3">
            <input id="area_py_min" type="number" placeholder="ì´ìƒ" class="w-20 px-2 py-1 border rounded text-sm" />
            <span class="text-gray-500">~</span>
            <input id="area_py_max" type="number" placeholder="ì´í•˜" class="w-20 px-2 py-1 border rounded text-sm" />
            </div>
        </div>
        </div>

        <!-- ë§¤ë§¤ê°€ -->
        <div class="relative">
        <button id="filter-btn-sale" data-default-label="ë§¤ë§¤ê°€ â–¼" onclick="toggleFilterPanel('sale')" class="px-3 py-1.5 border border-gray-300 bg-white rounded-md shadow-sm text-sm text-gray-800 font-medium hover:bg-gray-100">
            ë§¤ë§¤ê°€ â–¼
        </button>
        <div id="filter-panel-sale" class="hidden absolute left-0 mt-1 w-[300px] bg-white border rounded shadow z-50">
            <div class="flex items-center gap-2 p-3">
                <input id="sale_min" type="number" placeholder="ì´ìƒ" class="w-24 px-2 py-1 border rounded text-sm" />
                <span class="text-gray-500">~</span>
                <input id="sale_max" type="number" placeholder="ì´í•˜" class="w-24 px-2 py-1 border rounded text-sm" />
            </div>
        </div>
        </div>

        <!-- ì´ë³´ì¦ê¸ˆ -->
        <div class="relative">
        <button id="filter-btn-total_deposit" data-default-label="ì´ë³´ì¦ê¸ˆ â–¼" onclick="toggleFilterPanel('total_deposit')" class="px-3 py-1.5 border border-gray-300 bg-white rounded-md shadow-sm text-sm text-gray-800 font-medium hover:bg-gray-100">
            ì´ë³´ì¦ê¸ˆ â–¼
        </button>
        <div id="filter-panel-total_deposit" class="hidden absolute left-0 mt-1 w-[300px] bg-white border rounded shadow z-50">
            <div class="flex items-center gap-2 p-3">
            <input id="total_deposit_min" type="number" placeholder="ì´ìƒ" class="w-24 px-2 py-1 border rounded text-sm" />
            <span class="text-gray-500">~</span>
            <input id="total_deposit_max" type="number" placeholder="ì´í•˜" class="w-24 px-2 py-1 border rounded text-sm" />
            </div>
        </div>
        </div>

        <!-- ì´ì›”ì„¸ -->
        <div class="relative">
        <button id="filter-btn-total_rent" data-default-label="ì´ì›”ì„¸ â–¼" onclick="toggleFilterPanel('total_rent')" class="px-3 py-1.5 border border-gray-300 bg-white rounded-md shadow-sm text-sm text-gray-800 font-medium hover:bg-gray-100">
            ì´ì›”ì„¸ â–¼
        </button>
        <div id="filter-panel-total_rent" class="hidden absolute left-0 mt-1 w-[280px] bg-white border rounded shadow z-50">
            <div class="flex items-center gap-2 p-3">
            <input id="total_rent_min" type="number" placeholder="ì´ìƒ" class="w-20 px-2 py-1 border rounded text-sm" />
            <span class="text-gray-500">~</span>
            <input id="total_rent_max" type="number" placeholder="ì´í•˜" class="w-20 px-2 py-1 border rounded text-sm" />
            </div>
        </div>
        </div>

        </div>


        <!-- âœ… ë“œë¡­ë‹¤ìš´ íŒ¨ë„ë“¤ -->
        <div id="filter-panels" class="mt-2 space-y-2">
        <!-- ì¸µ -->
        <div id="filter-panel-floor" class="filter-panel hidden">
            <div class="flex items-center gap-2 p-3 bg-gray-50 border rounded">
            <span class="text-sm font-semibold">ì¸µìˆ˜</span>
            <input id="floor_min" type="number" placeholder="ì´ìƒ" class="w-20 px-2 py-1 border rounded" />
            <input id="floor_max" type="number" placeholder="ì´í•˜" class="w-20 px-2 py-1 border rounded" />
            </div>
        </div>

        <!-- ë§¤ë§¤ê°€ -->
        <div id="filter-panel-sale" class="filter-panel hidden">
            <div class="flex items-center gap-2 p-3 bg-gray-50 border rounded">
            <span class="text-sm font-semibold">ë§¤ë§¤ê°€</span>
            <input id="sale_price_min" type="number" placeholder="ì´ìƒ" class="w-24 px-2 py-1 border rounded" />
            <input id="sale_price_max" type="number" placeholder="ì´í•˜" class="w-24 px-2 py-1 border rounded" />
            </div>
        </div>

        <!-- ë³´ì¦ê¸ˆ -->
        <div id="filter-panel-deposit" class="filter-panel hidden">
            <div class="flex items-center gap-2 p-3 bg-gray-50 border rounded">
            <span class="text-sm font-semibold">ë³´ì¦ê¸ˆ</span>
            <input id="deposit_price_min" type="number" placeholder="ì´ìƒ" class="w-24 px-2 py-1 border rounded" />
            <input id="deposit_price_max" type="number" placeholder="ì´í•˜" class="w-24 px-2 py-1 border rounded" />
            </div>
        </div>

        <!-- ì›”ì„¸ -->
        <div id="filter-panel-rent" class="filter-panel hidden">
            <div class="flex items-center gap-2 p-3 bg-gray-50 border rounded">
            <span class="text-sm font-semibold">ì›”ì„¸</span>
            <input id="monthly_rent_min" type="number" placeholder="ì´ìƒ" class="w-20 px-2 py-1 border rounded" />
            <input id="monthly_rent_max" type="number" placeholder="ì´í•˜" class="w-20 px-2 py-1 border rounded" />
            </div>
        </div>

        <!-- ì´ë³´ì¦ê¸ˆ -->
        <div id="filter-panel-total_deposit" class="filter-panel hidden">
            <div class="flex items-center gap-2 p-3 bg-gray-50 border rounded">
            <span class="text-sm font-semibold">ì´ë³´ì¦ê¸ˆ</span>
            <input id="total_deposit_min" type="number" placeholder="ì´ìƒ" class="w-24 px-2 py-1 border rounded" />
            <input id="total_deposit_max" type="number" placeholder="ì´í•˜" class="w-24 px-2 py-1 border rounded" />
            </div>
        </div>

        <!-- ì´ì›”ì„¸ -->
        <div id="filter-panel-total_rent" class="filter-panel hidden">
            <div class="flex items-center gap-2 p-3 bg-gray-50 border rounded">
            <span class="text-sm font-semibold">ì´ì›”ì„¸</span>
            <input id="total_rent_min" type="number" placeholder="ì´ìƒ" class="w-20 px-2 py-1 border rounded" />
            <input id="total_rent_max" type="number" placeholder="ì´í•˜" class="w-20 px-2 py-1 border rounded" />
            </div>
        </div>

        <!-- ì „ìš©í‰ìˆ˜ -->
        <div id="filter-panel-area_py" class="filter-panel hidden">
            <div class="flex items-center gap-2 p-3 bg-gray-50 border rounded">
            <span class="text-sm font-semibold">ì „ìš©í‰ìˆ˜</span>
            <input id="area_py_min" type="number" placeholder="ì´ìƒ" class="w-20 px-2 py-1 border rounded" />
            <input id="area_py_max" type="number" placeholder="ì´í•˜" class="w-20 px-2 py-1 border rounded" />
            </div>
        </div>
        </div>
        <div style="flex:1"></div> <!-- ì´ ì¤„ì´ í—¤ë”ì—ì„œ ì˜¤ë¥¸ìª½ ì •ë ¬ ì—­í•  -->
            
        <!-- <div id="office-info" class="flex gap-12 items-start">
            <div class="office text-xs leading-snug">
                <b>ë°±ì–µê³µì¸ì¤‘ê°œì‚¬ì‚¬ë¬´ì†Œ íŒŒì£¼ì </b><br>
                ê²½ê¸° íŒŒì£¼ì‹œ ì²­ì•”ë¡œ17ë²ˆê¸¸ 43, 108í˜¸<br>
                031-942-2834<br>
                ë“±ë¡ë²ˆí˜¸ ì œ41480-2022-00001í˜¸<br>
                ì¡°ì¸í˜¸
            </div>
            <div class="office text-xs leading-snug">
                <b>ë°±ì–µê³µì¸ì¤‘ê°œì‚¬ì‚¬ë¬´ì†Œ ì¼ì‚°ì </b><br>
                ê²½ê¸° ê³ ì–‘ì‹œ ì¼ì‚°ë™êµ¬ ì¼ì‚°ë¡œ 441ë²ˆê¸¸ 18, 1ì¸µ<br>
                031-922-2580<br>
                ë“±ë¡ë²ˆí˜¸ ì œ41285-2022-00002í˜¸<br>
                ë°±ì€í˜œ
            </div>
        </div> -->
    </header>
        <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
        <div id="login-modal"
            class="fixed inset-0 z-[20000] bg-black/40 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-lg p-8 w-80">
            <h2 class="font-bold text-xl mb-4 text-center">ì§ì› ë¡œê·¸ì¸</h2>
            <input id="login-email" type="email" placeholder="ì´ë©”ì¼"
                class="w-full border border-gray-300 rounded px-3 py-2 mb-3" />
            <input id="login-password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"
                class="w-full border border-gray-300 rounded px-3 py-2 mb-4" />
            <button onclick="login()"
                    class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-semibold">
            ë¡œê·¸ì¸
            </button>
            <button onclick="hideLogin()"
                    class="w-full text-gray-500 mt-2">ë‹«ê¸°</button>
            <div id="login-error" class="text-red-600 text-sm mt-2 hidden"></div>
        </div>
        </div>

    <!-- âœ… ìƒì„¸ ì •ë³´ íŒ¨ë„ ì¶”ê°€ -->
    <div id="detail-panel" class="absolute top-[80px] left-[340px] w-[400px] h-full bg-white/90 backdrop-blur-sm shadow-xl p-4 text-sm hidden z-[1000] overflow-y-auto">
    <div id="detail-content" class="text-gray-800 text-sm whitespace-pre-line overflow-y-auto h-full"></div>
    </div>
    <!-- ë²„íŠ¼ì€ íŒ¨ë„ ë°”ë¡œ ë‹¤ìŒì—! -->
    <button
        id="close-detail-btn"
        onclick="hideDetailPanel()"
        class="fixed z-[1001] w-10 h-10 bg-white text-gray-600 border border-gray-300 hover:border-black hover:text-black shadow-md flex items-center justify-center font-bold text-lg hidden"
        style="top: 90px; left: 740px; display: none;">
        âœ•
    </button>      

    <div id="map" class="absolute top-0 bottom-0 right-0 left-[340px] z-0"></div>
    <div id="info-panel" class="absolute top-0 bottom-0 left-0 w-[340px] overflow-y-auto bg-white shadow-xl p-3 text-sm hidden z-50">
        <div id="info-content" class="text-xs text-gray-700"></div>
    </div>

  <script>
    const supabaseUrl = 'https://sfinbtiqlfnaaarziixu.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaW5idGlxbGZuYWFhcnppaXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MDkxNjEsImV4cCI6MjA2ODA4NTE2MX0.4-7vnIjbF-biWWuv9-vTxK9Y99gMm-vS6oaRMdRL5fA';
    let currentPage = 1;
    const pageSize = 20;
    let isLoading = false;
    let hasMore = true;
    let allListings = [];
    let matchedListingsCache = [];
    let matchedListingsPage = 1;    
    const allDealTypes = ['ì›”ì„¸', 'ë§¤ë§¤'];
    let selectedDealTypes = ['ì›”ì„¸'];
    const allCategories = ['ìƒê°€', 'ì£¼íƒ', 'ê³µì¥Â·ì°½ê³ ']; // ì¹´í…Œê³ ë¦¬ ì¢…ë¥˜ (ê³ ì •)
    let selectedCategories = ['ìƒê°€']; // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ (ì—¬ëŸ¬ê°œ ê°€ëŠ¥)

    const PAGE_SIZE = 15;

    const client = supabase.createClient(supabaseUrl, supabaseKey);
    const infoPanel = document.getElementById('info-panel');
    const infoContent = document.getElementById('info-content');


    const map = new kakao.maps.Map(document.getElementById('map'), {
      center: new kakao.maps.LatLng(37.7151, 126.7341),
      level: 4
    });
    infoPanel.classList.remove("hidden");
    infoPanel.style.display = 'block';
    document.getElementById('map').style.left = '340px'; // ì§€ë„ë„ í•­ìƒ íŒ¨ë„ ê³ ë ¤


    const clusterer = new kakao.maps.MarkerClusterer({
        map: map,
        averageCenter: true,
        minLevel: 1,
        minClusterSize: 1, // âœ… ë§ˆì»¤ê°€ 1ê°œì—¬ë„ í´ëŸ¬ìŠ¤í„° ì²˜ë¦¬
        disableClickZoom: true,
        styles: [
            {
                width: '40px',
                height: '40px',
                background: '#F2C130',
                border: 'none',
                borderRadius: '50%',
                color: '#fff', // âœ… ê¸€ììƒ‰ í°ìƒ‰ìœ¼ë¡œ ë³€ê²½
                fontWeight: 'bold',
                textAlign: 'center',
                lineHeight: '40px'
            }
            ]

    });

    const customImage = new kakao.maps.MarkerImage(
      'https://raw.githubusercontent.com/mhale45/image/2d7ce4379b14d095d2f0b7f1d0057987548a37bf/2.png',
      new kakao.maps.Size(36, 36),
      { offset: new kakao.maps.Point(18, 36) }
    );

    // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ë™ì  ìƒì„±
    function renderCategoryButtons() {
        const wrap = document.getElementById('category-btn-wrap');
        wrap.innerHTML = '';
        allCategories.forEach(cat => {
            const btn = document.createElement('button');
            btn.className =
                'px-3 py-1 rounded bg-gray-100 text-gray-700 border border-gray-300 text-sm font-medium transition hover:bg-yellow-100';
            btn.textContent = cat;
            btn.dataset.cat = cat;
            // ì´ë¯¸ ì„ íƒëœ ê±´ ìƒ‰ìƒ ë³€ê²½
            if (selectedCategories.includes(cat)) {
                btn.classList.add('bg-yellow-300', 'font-bold', 'text-black');
                btn.classList.remove('bg-gray-100', 'text-gray-700');
            }
            btn.onclick = function () {
                // í† ê¸€
                if (selectedCategories.includes(cat)) {
                    selectedCategories = selectedCategories.filter(c => c !== cat);
                    btn.classList.remove('bg-yellow-300', 'font-bold', 'text-black');
                    btn.classList.add('bg-gray-100', 'text-gray-700');
                } else {
                    selectedCategories.push(cat);
                    btn.classList.remove('bg-gray-100', 'text-gray-700');
                    btn.classList.add('bg-yellow-300', 'font-bold', 'text-black');
                }
                updateFilteredListings();
            };
            wrap.appendChild(btn);
        });
    }

    function shiftMapCenterByPixels(pixelsX) {
        const proj = map.getProjection();
        if (!proj) return;

        const center = map.getCenter();
        // KakaoëŠ” ì—¬ê¸°ì„œ ì˜ˆì™¸ê°€ ê°€ì¥ ë§ì´ ë°œìƒí•¨
        let centerPoint;
        try {
            centerPoint = proj.pointFromCoords(center);
        } catch (e) {
            // projection ì´ˆê¸°í™” ì „/ë„ì¤‘ì—ëŠ” ì˜ˆì™¸ ë°œìƒ â†’ í•¨ìˆ˜ ì¢…ë£Œ!
            return;
        }
        if (!centerPoint || typeof centerPoint.x !== "number") return;

        centerPoint.x += pixelsX;
        let newCenter;
        try {
            newCenter = proj.coordsFromPoint(centerPoint);
        } catch (e) {
            return;
        }
        if (!newCenter) return;
        map.setCenter(newCenter);
    }
    
    async function loadListingsInBounds() {
        if (isLoading) return;
        isLoading = true;
        const level = map.getLevel();
        let limitNum = 100;
        if (level <= 3)      limitNum = 400;
        else if (level === 4) limitNum = 200;
        else if (level === 5) limitNum = 100;
        else if (level === 6) limitNum = 60;
        else                  limitNum = 30;

        const mapDiv = document.getElementById('map');
        const detailPanel = document.getElementById('detail-panel');
        const closeBtn = document.getElementById('close-detail-btn');

        if (level >= 5) {
            clusterer.clear();

            // âœ… ë‘ ë²ˆì§¸ íŒ¨ë„(ìƒì„¸) ìˆ¨ê¸°ê¸°
            if (!detailPanel.classList.contains("hidden")) {
                detailPanel.classList.add("hidden");
                detailPanel.style.display = 'none';
            }

            // âœ… Xë²„íŠ¼ ìˆ¨ê¸°ê¸°
            if (!closeBtn.classList.contains("hidden")) {
                closeBtn.classList.add("hidden");
                closeBtn.style.display = 'none';
            }
            isLoading = false;
            return;
        } else {
        }

        const bounds = map.getBounds();
        const sw = bounds.getSouthWest(); // ë‚¨ì„œìª½ ì¢Œí‘œ
        const ne = bounds.getNorthEast(); // ë¶ë™ìª½ ì¢Œí‘œ

        // ì§€ë„ ì˜ì—­ ë‚´ ë§¤ë¬¼ë§Œ Supabaseì—ì„œ ì¿¼ë¦¬
        const { data, error } = await client
            .from('baikukdbtest')
            .select('*')
            .gte('lat', sw.getLat())
            .lte('lat', ne.getLat())
            .gte('lng', sw.getLng())
            .lte('lng', ne.getLng())
            .limit(limitNum); // ğŸ‘ˆ ë³€ìˆ˜ë¡œ ë°”ê¿”ì¤Œ

        if (error) {
            alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
            return;
        }
        allListings = data; 
        clusterer.clear(); // ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ
        allMarkers = [];

        data.forEach(listing => {
        if (!listing.lat || !listing.lng) return;
        const marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(listing.lat, listing.lng),
            image: customImage
        });
        marker.listing_id = listing.listing_id;
        allMarkers.push(marker);
        });

        clusterer.addMarkers(allMarkers);

        
        // 2. ë§¤ë¬¼ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ í•¨ìˆ˜
        function renderMatchedListings() {
            const start = 0;
            const end = matchedListingsPage * PAGE_SIZE;
            const listingsToShow = matchedListingsCache.slice(start, end);
            
            function formatKoreanMoney(value) {
            if (!value && value !== 0) return '-';
            const num = Number(value);
            if (num >= 10000) {
                const eok = Math.floor(num / 10000);
                const man = num % 10000;
                const manStr = man > 0 ? `${man.toLocaleString()}` : '';
                return `${eok}ì–µ${manStr ? ' ' + manStr : ''}`;
            } else {
                return `${num.toLocaleString()}`;
            }
            }

            function formatFloor(floor, floor_type) {
            const abs = Math.abs(floor);
            if (floor_type === 'ì§€í•˜' || floor < 0) {
                return `B${abs}`;
            }
            return `${floor}`;
            }

            const listText = listingsToShow.map(l => {
                // ê¸°ì¡´ í…œí”Œë¦¿(ì¹´ë“œ) ë³µì‚¬
                const statusRaw = l.transaction_status || '-';
                const status = statusRaw.trim().split(' ')[0];

                let bgStyle = 'background-color: #e5e7eb; color: #374151;';
                if (status === 'ì§„í–‰ì¤‘') {
                    bgStyle = 'background-color: rgba(242,193,48,0.4); color: black;';
                } else if (status === 'ê³„ì•½ì™„ë£Œ') {
                    bgStyle = 'background-color: rgba(255,0,0,0.3); color: black;';
                }

                function formatKoreanMoney(value) {
                    if (!value && value !== 0) return '-';
                    const num = Number(value);
                    if (num >= 10000) {
                        const eok = Math.floor(num / 10000);
                        const man = num % 10000;
                        const manStr = man > 0 ? `${man.toLocaleString()}` : '';
                        return `${eok}ì–µ${manStr ? ' ' + manStr : ''}`;
                    } else {
                        return `${num.toLocaleString()}`;
                    }
                }

                function formatArea(area_py) {
                    const value = String(area_py).trim();
                    if (
                        area_py === undefined ||
                        area_py === null ||
                        value === "" ||
                        value === "-" ||
                        value.toLowerCase() === "nan" || // 'NaN', 'nan' ëª¨ë‘ ëŒ€ì‘
                        isNaN(Number(area_py))
                    ) return '-';
                    return Number(area_py).toFixed(1);
                }

                function formatFloor(floor, floor_type) {
                    if (floor === undefined || floor === null || isNaN(floor)) return '-';
                    const abs = Math.abs(floor);
                    if (floor_type === 'ì§€í•˜' || floor < 0) {
                        return `B${abs}`;
                    }
                    return `${floor}`;
                }

                function formatTotalFloors(total_floors) {
                    if (total_floors === undefined || total_floors === null || isNaN(total_floors)) return '-';
                    return total_floors;
                }

                return `
                    <div class="mb-5 pb-2 border-b border-gray-300 text-left">
                        <div onclick="showDetailPanel(${l.listing_id})" class="cursor-pointer hover:bg-gray-100 transition">
                            <div class="flex items-start gap-2 mt-1 mb-1">
                                <div class="w-[61px] border-[3px] border-[rgb(242,193,48)] text-[rgb(0,0,0)] px-1 py-0 rounded text-base font-bold">
                                ${l.listing_id}
                                </div>
                                <div class="flex-1 text-left font-semibold text-[rgb(80,152,233)] text-lg">
                                    ${l.deal_type}
                                    ${
                                    l.deal_type === "ë§¤ë§¤"
                                        ? ` ${formatKoreanMoney(l.sale_price)}`
                                        : l.deal_type === "ì›”ì„¸"
                                        ? ` ${formatKoreanMoney(l.deposit_price)} / ${formatKoreanMoney(l.monthly_rent)}`
                                        : ""
                                    }
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-[61px] h-[22px] flex items-center justify-center text-xs px-1 rounded-sm font-semibold" style="${bgStyle}">
                                ${status}
                                </div>
                                <div class="flex-1 text-base">
                                ì „ìš© <strong class="font-semibold">${Number(l.area_py).toFixed(1)}</strong>í‰,
                                <strong class="font-semibold">${formatFloor(l.floor, l.floor_type)}</strong>/${l.total_floors}ì¸µ
                                </div>
                            </div>
                            <div class="flex justify-between mt-1">
                                <span class="text-base font-medium">
                                    ${
                                        l.deal_type === "ì›”ì„¸" && Number(l.premium_price) === 0
                                        ? `<span style="
                                                background-color:rgb(0,222,90,0.25);
                                                color:black;
                                                font-weight:bold;
                                                border-radius:4px;
                                                padding:1px 6px;
                                                margin-right:4px;
                                                font-size:12px;
                                            ">ë¬´ê¶Œë¦¬</span>`
                                        : ""
                                    }
                                    ${l.title}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            infoContent.innerHTML = listText;
        }

        function showListingsInPanel(listings) {
            matchedListingsCache = listings;
            matchedListingsPage = 1;
            if (typeof renderMatchedListings === "function") renderMatchedListings();
            infoPanel.classList.remove("hidden");
            infoPanel.style.display = 'block';
            setTimeout(() => {
                infoPanel.scrollTop = 0;
            }, 0);
        }

        // 3. í´ëŸ¬ìŠ¤í„° í´ë¦­ ì´ë²¤íŠ¸ (ê¸°ì¡´ ì½”ë“œëŠ” ëª¨ë‘ ì‚­ì œ!)
        kakao.maps.event.addListener(clusterer, 'clusterclick', function (cluster) {
            const markersInCluster = cluster.getMarkers();
            const idsInCluster = markersInCluster.map(m => String(m.listing_id));
            // allListingsëŠ” ì§€ë„ ë²”ìœ„ ë‚´ ì „ì²´ ë§¤ë¬¼ì„
            const matchedListings = allListings.filter(l => idsInCluster.includes(String(l.listing_id)));

            if (matchedListings.length > 0) {
                showListingsInPanel(matchedListings);
                matchedListingsCache = matchedListings; // ì „ì²´ ë¦¬ìŠ¤íŠ¸ ì €ì¥
                matchedListingsPage = 1;                // ì²« í˜ì´ì§€ë¡œ ì´ˆê¸°í™”
                renderMatchedListings();                // 15ê°œë§Œ ê·¸ë ¤ì¤Œ

                infoPanel.classList.remove("hidden");
                setTimeout(() => {
                    infoPanel.scrollTop = 0; // í•­ìƒ ë§¨ ìœ„ë¡œ ìŠ¤í¬ë¡¤
                }, 0);
            }
        });

        // 4. infoPanel ë¬´í•œìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ (ìŠ¤í¬ë¦½íŠ¸ ì–´ë””ì„œë“  1ë²ˆë§Œ ë“±ë¡)
        infoPanel.addEventListener('scroll', function() {
            if (infoPanel.scrollTop + infoPanel.clientHeight >= infoPanel.scrollHeight - 10) {
                // ë” ë³´ì—¬ì¤„ ë§¤ë¬¼ì´ ìˆìœ¼ë©´
                if (matchedListingsCache.length > matchedListingsPage * PAGE_SIZE) {
                    matchedListingsPage++;
                    renderMatchedListings();
                }
            }
        });

        updateFilteredListings(); // ì§€ë„í˜ì´ì§€ì—ì„œ í•„í„°ë§ ê´€ë ¨í•¨ìˆ˜
        // ------ ì¶”ê°€: ì²˜ìŒ ë¡œë”©ì‹œ ë¦¬ìŠ¤íŠ¸ ìë™ ì¶œë ¥ ------
        matchedListingsCache = filterListings(allListings);
        matchedListingsPage = 1;
        if (typeof renderMatchedListings === "function") renderMatchedListings();        
        
        isLoading = false;
    }

    // debounceë¥¼ ìœ„í•œ ë³€ìˆ˜ ì¶”ê°€
    let mapIdleTimer = null;

    // ì§€ë„ ì´ë™/ì¤Œ ëë‚  ë•Œë§ˆë‹¤ (debounce)
    kakao.maps.event.addListener(map, 'idle', () => {
    if (mapIdleTimer) clearTimeout(mapIdleTimer);
    mapIdleTimer = setTimeout(() => {
        loadListingsInBounds();
    }, 200); // 0.2ì´ˆ í›„ 1ë²ˆë§Œ ì‹¤í–‰
    });


    // ìµœì´ˆ í•œ ë²ˆ ë¡œë”©
    loadListingsInBounds();

    
    // (1) í˜„ì¬ ì§€ë„ ì˜ì—­ì˜ ë§¤ë¬¼ì„ ê°€ì ¸ì˜´ (ì´ë¯¸ allListingsì— ìˆìŒ)
    matchedListingsCache = allListings; // ì „ì²´ ë¦¬ìŠ¤íŠ¸ ì €ì¥
    matchedListingsPage = 1;            // ì²« í˜ì´ì§€ë¡œ ì´ˆê¸°í™”

    // (2) ë¦¬ìŠ¤íŠ¸ 15ê°œë§Œ info-panelì— ê·¸ë ¤ì¤Œ
    if (typeof renderMatchedListings === "function") renderMatchedListings();


    function formatKoreanMoney(value) {
        if (!value && value !== 0) return '-';
        const num = Number(value);
        if (num >= 10000) {
            const eok = Math.floor(num / 10000);
            const man = num % 10000;
            const manStr = man > 0 ? `${man.toLocaleString()}` : '';
            return `${eok}ì–µ${manStr ? ' ' + manStr : ''}`;
        } else {
            return `${num.toLocaleString()}`;
        }
    }

    function showDetailPanel(listingId) {
        const listing = allListings.find(l => String(l.listing_id) === String(listingId));
        if (!listing) return;

        const detailContent = `
            <div class="mb-2">
                <span class="font-medium">${listing.description}</span>
                </span>
            </div>
            
        `;

        const panel = document.getElementById('detail-panel');
        const content = document.getElementById('detail-content');
        const closeBtn = document.getElementById('close-detail-btn');

        // âœ… íŒ¨ë„ ë‚´ìš© ì±„ìš°ê¸°
        content.innerHTML = detailContent;

        // âœ… ìŠ¤í¬ë¡¤ ë§¨ ìœ„ë¡œ ì´ë™
        content.scrollTop = 0;

        // âœ… íŒ¨ë„ ë³´ì´ê¸°
        panel.classList.remove('hidden');
        panel.style.display = 'block';
                
        // âœ… ë²„íŠ¼ë„ ê°™ì´ show
        closeBtn.classList.remove('hidden');
        closeBtn.style.display = 'block';
    }
    
    function hideDetailPanel() { // íŒ¨ë„ ë‹«ëŠ” í•¨ìˆ˜
        const detailPanel = document.getElementById('detail-panel');
        const closeBtn = document.getElementById('close-detail-btn');
        detailPanel.classList.add('hidden');
        detailPanel.style.display = 'none';

        // âœ… ë²„íŠ¼ë„ ê°™ì´ hide
        closeBtn.classList.add('hidden');
        closeBtn.style.display = 'none';
        
        // íŒ¨ë„ ì „ë¶€ ë‹«ê¸°
        document.querySelectorAll('[id^="filter-panel-"]').forEach(p => p.classList.add('hidden'));
    }
    // ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ ë‘ ë²ˆì§¸ íŒ¨ë„ ë‹«ê¸°
    kakao.maps.event.addListener(map, 'click', function () {
        hideDetailPanel();
    });

    //ë¡œê·¸ì¸
    function showLogin() {
        document.getElementById('login-modal').classList.remove('hidden');
        }
        function hideLogin() {
        document.getElementById('login-modal').classList.add('hidden');
        }
        async function login() {
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value.trim();
        const errorDiv = document.getElementById('login-error');
        errorDiv.classList.add('hidden');

        if (!email || !password) {
            errorDiv.textContent = 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
            errorDiv.classList.remove('hidden');
            return;
        }

        const { data, error } = await client.auth.signInWithPassword({ email, password });
        if (error) {
            errorDiv.textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message;
            errorDiv.classList.remove('hidden');
            return;
        }
        hideLogin();
        alert("ë¡œê·¸ì¸ ì„±ê³µ!");
    }

    // 1. í•„í„°ë§ í•¨ìˆ˜
    function getFilterValues() {
        return {
            floor_min: parseFloat(document.getElementById('floor_min').value),
            floor_max: parseFloat(document.getElementById('floor_max').value),
            sale_price_min: parseFloat(document.getElementById('sale_min').value),
            sale_price_max: parseFloat(document.getElementById('sale_max').value),
            deposit_price_min: parseFloat(document.getElementById('deposit_min').value),
            deposit_price_max: parseFloat(document.getElementById('deposit_max').value),
            monthly_rent_min: parseFloat(document.getElementById('rent_min').value),
            monthly_rent_max: parseFloat(document.getElementById('rent_max').value),
            total_deposit_min: parseFloat(document.getElementById('total_deposit_min').value),
            total_deposit_max: parseFloat(document.getElementById('total_deposit_max').value),
            total_rent_min: parseFloat(document.getElementById('total_rent_min').value),
            total_rent_max: parseFloat(document.getElementById('total_rent_max').value),
            area_py_min: parseFloat(document.getElementById('area_py_min').value),
            area_py_max: parseFloat(document.getElementById('area_py_max').value),
        };
    }
    
    // í•„í„° í•¨ìˆ˜ì— ì¹´í…Œê³ ë¦¬ ì¶”ê°€
    const originalFilterListings = filterListings;

    // ì‹¤ì œë¡œ allListingsì—ì„œ ì¡°ê±´ì— ë§ëŠ” ê²ƒë§Œ ë°˜í™˜
    function filterListings(listings) {
        const f = getFilterValues();
        return listings.filter(l => {
            if (!selectedDealTypes.includes(l.deal_type)) return false; // ì¹´í…Œê³ ë¦¬ ë§¤ë§¤, ì›”ì„¸
            if (selectedCategories.length > 0 && !selectedCategories.includes(l.category)) return false;// ì¹´í…Œê³ ë¦¬ ìƒê°€, ì£¼íƒ, ê³µì¥ì°½ê³ 
            // ì¸µ
            if (!isNaN(f.floor_min) && l.floor < f.floor_min) return false;
            if (!isNaN(f.floor_max) && l.floor > f.floor_max) return false;
            // ë§¤ë§¤ê°€
            if (!isNaN(f.sale_price_min) && l.sale_price < f.sale_price_min) return false;
            if (!isNaN(f.sale_price_max) && l.sale_price > f.sale_price_max) return false;
            // ë³´ì¦ê¸ˆ
            if (!isNaN(f.deposit_price_min) && l.deposit_price < f.deposit_price_min) return false;
            if (!isNaN(f.deposit_price_max) && l.deposit_price > f.deposit_price_max) return false;
            // ì›”ì„¸
            if (!isNaN(f.monthly_rent_min) && l.monthly_rent < f.monthly_rent_min) return false;
            if (!isNaN(f.monthly_rent_max) && l.monthly_rent > f.monthly_rent_max) return false;
            // ì´ë³´ì¦ê¸ˆ
            if (!isNaN(f.total_deposit_min) && l.total_deposit < f.total_deposit_min) return false;
            if (!isNaN(f.total_deposit_max) && l.total_deposit > f.total_deposit_max) return false;
            // ì´ì›”ì„¸
            if (!isNaN(f.total_rent_min) && l.total_rent < f.total_rent_min) return false;
            if (!isNaN(f.total_rent_max) && l.total_rent > f.total_rent_max) return false;
            // ì „ìš©í‰ìˆ˜
            if (!isNaN(f.area_py_min) && l.area_py < f.area_py_min) return false;
            if (!isNaN(f.area_py_max) && l.area_py > f.area_py_max) return false;
            return true;
        });
    }


    // ì§€ë„/ë¦¬ìŠ¤íŠ¸ë¥¼ í•„í„°ê°’ì— ë§ê²Œ ìƒˆë¡œ ê·¸ë¦¼
    function updateFilteredListings() {
        const filtered = filterListings(allListings);

        // ë§ˆì»¤ ë‹¤ì‹œ ì„¸íŒ…
        clusterer.clear();
        const markers = [];
        filtered.forEach(listing => {
            if (!listing.lat || !listing.lng) return;
            const marker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(listing.lat, listing.lng),
                image: customImage
            });
            marker.listing_id = listing.listing_id;
            markers.push(marker);
        });
        clusterer.addMarkers(markers);

        // infoPanelì˜ ë¦¬ìŠ¤íŠ¸ë„ ê°±ì‹ 
        matchedListingsCache = filtered;
        matchedListingsPage = 1;
        if (typeof renderMatchedListings === "function") renderMatchedListings();
    }

    // 3. input ì´ë²¤íŠ¸ ì—°ê²° (ìµœì´ˆ í•œ ë²ˆë§Œ ì‹¤í–‰)
    document.querySelectorAll('#filter-bar input').forEach(input => {
        input.addEventListener('input', () => {
            updateFilteredListings(); // ë§¤ë¬¼ ì „ì²´ì—ì„œ í•„í„°ë§í•´ì„œ ë§ˆì»¤/ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
        });
    });

    function toggleFilterPanel(type) {
        const panelIds = ['floor', 'sale', 'deposit', 'rent', 'total_deposit', 'total_rent', 'area_py', 'init'];
        panelIds.forEach(id => {
            const panel = document.getElementById(`filter-panel-${id}`);
            if (panel) {
            if (id === type) {
                panel.classList.toggle('hidden');
            } else {
                panel.classList.add('hidden');
            }
            }
        });
    }

    const filterUnits = {
        floor: 'ì¸µ',
        sale: 'ë§Œ',
        deposit: 'ë§Œ',
        rent: 'ë§Œ',
        total_deposit: 'ë§Œ',
        total_rent: 'ë§Œ',
        area_py: 'í‰'
    };

    function updateFilterButtonText(type) {
        let min = document.getElementById(`${type}_min`)?.value;
        let max = document.getElementById(`${type}_max`)?.value;
        let btn = document.getElementById(`filter-btn-${type}`);
        let unit = filterUnits[type] || '';
        let label = "";

        // 'ë§Œ' ë‹¨ìœ„ë¡œ ì…ë ¥ë°›ëŠ” í•­ëª©ë§Œ formatKoreanMoney ì ìš©
        const moneyFilters = ['sale', 'deposit', 'rent', 'total_deposit', 'total_rent'];

        // ê°’ í¬ë§· ë³€í™˜
        function formatValue(val) {
            if (!val && val !== 0) return '-';
            const num = Number(val);

            // 'ë§Œ' ë‹¨ìœ„(ì–µ, ë§Œ ë³€í™˜)
            if (['sale', 'deposit', 'rent', 'total_deposit', 'total_rent'].includes(type)) {
                if (isNaN(num)) return '-';
                if (num >= 10000) {
                    return formatKoreanMoney(val);
                } else {
                    return num.toLocaleString() + 'ë§Œ';
                }
            }

            // 'ì¸µ', 'ì „ìš©í‰ìˆ˜' ë“± ìˆ«ì + ë‹¨ìœ„ ë¶™ì´ê¸°
            if (['floor', 'area_py'].includes(type)) {
                if (isNaN(num)) return '-';
                return num + filterUnits[type];
            }

            // ë‚˜ë¨¸ì§€ ê·¸ëƒ¥ ë°˜í™˜
            return val;
        }


        if (min && max) {
            label = `${formatValue(min)}~${formatValue(max)}`;
        } else if (min) {
            label = `${formatValue(min)}~`;
        } else if (max) {
            label = `~${formatValue(max)}`;
        } else {
            label = btn ? btn.getAttribute('data-default-label') || 'â–¼' : 'â–¼';
        }

        if (btn) {
            btn.textContent = label;
            // ìƒ‰ìƒ ë³€ê²½
            if (label !== btn.getAttribute('data-default-label')) {
                btn.style.backgroundColor = "#F2C130";
                btn.style.color = "#111";
                btn.style.borderColor = "#eab308";
                btn.style.fontWeight = "bold";
            } else {
                btn.style.backgroundColor = "#fff";
                btn.style.color = "#374151";
                btn.style.borderColor = "#d1d5db";
                btn.style.fontWeight = "normal";
            }
        }
    }


    document.getElementById('floor_min').addEventListener('input', () => updateFilterButtonText('floor'));
    document.getElementById('floor_max').addEventListener('input', () => updateFilterButtonText('floor'));

    ['floor', 'sale', 'deposit', 'rent', 'total_deposit', 'total_rent', 'area_py'].forEach(type => { // í•„í„° ê°’ ì…ë ¥í–ˆì„ ë•Œ ê·¸ ê°’ ë²„íŠ¼ì— í‘œì‹œí•˜ëŠ” ë¶€ë¶„
        const minInput = document.getElementById(`${type}_min`);
        const maxInput = document.getElementById(`${type}_max`);
        if (minInput) minInput.addEventListener('input', () => updateFilterButtonText(type));
        if (maxInput) maxInput.addEventListener('input', () => updateFilterButtonText(type));
    });

    function resetFilters() { // í•„í„°ì´ˆê¸°í™” ë²„íŠ¼ ëˆ„ë¥´ë©´ ë™ì‘í•˜ëŠ” ì´ˆê¸°í™”í•¨ìˆ˜
        // ê° í•„í„° input IDë“¤
        const ids = [
            'floor_min', 'floor_max',
            'sale_min', 'sale_max',
            'deposit_min', 'deposit_max',
            'rent_min', 'rent_max',
            'total_deposit_min', 'total_deposit_max',
            'total_rent_min', 'total_rent_max',
            'area_py_min', 'area_py_max'
        ];

        // input ëª¨ë‘ ê³µë°± ì²˜ë¦¬
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = "";
        });

        // í•„í„° ë²„íŠ¼ í…ìŠ¤íŠ¸ë„ ì›ë˜ëŒ€ë¡œ ë³µì›
        ['floor','sale','deposit','rent','total_deposit','total_rent','area_py'].forEach(type => {
            updateFilterButtonText(type);
        });

        // í•„í„° ì ìš©(ë§ˆì»¤/ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”)
        updateFilteredListings();
    }

    // í•„í„°ë§ ì´ˆê¸°í™” ë²„íŠ¼ ëˆ„ë¥¼ ë•Œ ì¹´í…Œê³ ë¦¬ë„ ëª¨ë‘ í•´ì œ
    const originalResetFilters = resetFilters;
    resetFilters = function () {
        // ê¸°ì¡´ ì´ˆê¸°í™” ë™ì‘
        if (typeof originalResetFilters === 'function') originalResetFilters();
        selectedCategories = ['ìƒê°€'];
        renderCategoryButtons();
    }
    
    // ê±°ë˜ìœ í˜• ë²„íŠ¼ ë Œë”ë§
    function renderDealTypeButtons() {
        const bar = document.getElementById('filter-bar');
        let dealTypeBtnWrap = document.getElementById('deal-type-btn-wrap');
        if (!dealTypeBtnWrap) {
            dealTypeBtnWrap = document.createElement('div');
            dealTypeBtnWrap.id = 'deal-type-btn-wrap';
            dealTypeBtnWrap.className = 'flex gap-1 relative';
            bar.insertBefore(dealTypeBtnWrap, bar.children[1]);  // ì´ˆê¸°í™” ì˜†ì— ì‚½ì…
        }
        dealTypeBtnWrap.innerHTML = allDealTypes.map(type => `
            <button
                type="button"
                class="
                    px-3 py-1 rounded border border-gray-300 text-sm font-medium transition
                    ${selectedDealTypes.includes(type)
                        ? 'bg-yellow-300 font-bold text-black'
                        : 'bg-gray-100 text-gray-700 hover:bg-yellow-100'}
                "
                onclick="toggleDealType('${type}')"
            >${type}</button>
        `).join('');
    }


    // ê±°ë˜ìœ í˜• í† ê¸€
    function toggleDealType(type) {
        if (selectedDealTypes.includes(type)) {
            // í•˜ë‚˜ë§Œ ë‚¨ì§€ ì•Šì•˜ì„ ë•Œë§Œ í•´ì œ
            if (selectedDealTypes.length > 1) {
                selectedDealTypes = selectedDealTypes.filter(x => x !== type);
            }
        } else {
            selectedDealTypes.push(type);
        }
        renderDealTypeButtons();
        updateFilteredListings();
    }

    // ê±°ë˜ìœ í˜• ì´ˆê¸°í™” (ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì‹œ)
    const originalResetFilters2 = resetFilters;
    resetFilters = function () {
        if (typeof originalResetFilters2 === 'function') originalResetFilters2();
        selectedDealTypes = ['ì›”ì„¸'];
        renderDealTypeButtons();
        updateFilteredListings();
    }

    // ** í˜ì´ì§€ ë¡œë“œ ì‹œ ë²„íŠ¼ í‘œì‹œ **
    document.addEventListener('DOMContentLoaded', renderDealTypeButtons);

    // í•„í„°ë§ - í˜ì´ì§€ ë¡œë”©/ë§¤ë¬¼ ë¶ˆëŸ¬ì˜¨ ë’¤ 1ë²ˆë§Œ ë²„íŠ¼ ì„¸íŒ…
    document.addEventListener('DOMContentLoaded', renderCategoryButtons);

  </script>
</body>

</html>
