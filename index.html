<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ë°±ì–µì§€ë„</title>
    <link rel="icon" type="image/png" href="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/pabicon-baikuk-simbol.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f605c7b72dc7f3083f36483e55e2bc77&libraries=clusterer"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- LightGallery CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lightgallery.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lg-zoom.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lg-thumbnail.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lg-fullscreen.css">

    <!-- LightGallery JS -->
    <script src="https://cdn.jsdelivr.net/npm/lightgallery/lightgallery.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightgallery/plugins/zoom/lg-zoom.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightgallery/plugins/thumbnail/lg-thumbnail.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightgallery/plugins/fullscreen/lg-fullscreen.umd.js"></script>
    <script>
        // ê³ ê°ë·°ë„ ê°™ì€ ë²„í‚· ì‚¬ìš© (Private)
        window.BUCKET = 'listing-images';
        window.BUCKET_IS_PUBLIC = false;

        // ì›Œí„°ë§ˆí¬ íŒŒì¼(íˆ¬ëª… PNG) ìœ„ì¹˜
        window.WATERMARK_BUCKET = 'baikuk-images-open';
        window.WATERMARK_PREFIX = '';           // ë£¨íŠ¸ë©´ ë¹ˆ ë¬¸ìì—´
        window.WATERMARK_FILE   = 'baikuk-logo-warter-mark.png';
        window.WATERMARK_BUCKET_IS_PUBLIC = true;

        const LOGIN_PAGE = 'index.html'; // ì•ˆë‚´ í›„ ë³´ë‚¼ ë¡œê·¸ì¸ í˜ì´ì§€
        const REQUIRE_AUTH = /\/admin(?:\/index\.html)?\/?$/.test(location.pathname);

        const staffPublicMap = new Map();
    </script>
    <style>
        :root {
            --header-height: 3.5rem;
            --infopanel-left: 23.5%;
            --header-button-height: 1.6rem !important;
        }
        body { margin: 0; padding: 0; }
        header { position: fixed; top: 0; left: 0; right: 0; height: var(--header-height); z-index: 10000; background: #fff; }
        #map { position: absolute; top: var(--header-height); left: var(--infopanel-left); right: 0; bottom: 0; z-index: 0; }
        #info-panel { position: absolute; top: var(--header-height); left: 0; width: var(--infopanel-left); bottom: 0; z-index: 50; background: #fff; }
        #detail-panel { position: absolute; top: var(--header-height); left: var(--infopanel-left); width: 26%; bottom: 0; z-index: 9999; border-left: 0.3rem solid #e5e7eb;}
        #filter-bar { display: flex; flex-direction: column; gap: 2px; margin-top: 0; }
        header button {
            height: var(--header-button-height);
            font-size: 0.8rem !important;
            display: flex;
            align-items: center;
            padding-top: 0;
            padding-bottom: 0;
        }
    </style>
    <style>
        /* ë‘ ì¥ ì¸ë„¤ì¼ ìœ„ì— â€˜í°ìƒ‰â€™ ì›Œí„°ë§ˆí¬ ë§ˆìŠ¤í¬ */
        .wm-white{
            position:absolute; inset:0; pointer-events:none; user-select:none;
            background:#fff; opacity:.40;
            -webkit-mask-repeat:no-repeat; mask-repeat:no-repeat;
            -webkit-mask-position:center; mask-position:center;
            -webkit-mask-size: var(--wm-size, 360px) auto;
            mask-size: var(--wm-size, 360px) auto;
        }
        .thumb-box { background:#f3f4f6; overflow:hidden; }         /* ì—¬ë°± ìƒ‰ */
        .thumb-img { width:100%; height:100%;  object-fit: cover; object-position:center; }
        /* ìƒì„¸íŒ¨ë„(ë‘ ì¥ ë¯¸ë¦¬ë³´ê¸°) ì „ìš©: ê½‰ ì±„ìš°ê³  ì˜ë¦¬ê¸° */
        .thumb-img-cover { width:100%; height:100%; object-fit: cover; object-position:center; }

        /* ì¸í¬íŒ¨ë„ ì „ìš©: ì „ì²´ ë³´ì´ê²Œ, ì˜ë¦¬ì§€ ì•Šê¸° */
        .thumb-img-contain { width:100%; height:100%; object-fit: cover; object-position:center; }
        /* ìš°í´ë¦­ ë°©ì§€ìš© ë³´ì¡° (ë“œë˜ê·¸/ë¡±íƒ­/ì„ íƒ ì°¨ë‹¨) */
        .no-save {
            -webkit-user-drag: none;
            user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            -webkit-touch-callout: none; /* iOS ê¸¸ê²ŒëˆŒëŸ¬ ì €ì¥ ë°©ì§€ */
        }
    </style>
</head>
<body class="m-0 p-0">
    <header class="flex items-center gap-4 w-full px-4 bg-white shadow-md border-b border-gray-200 fixed top-0 left-0">
        <img src="https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/logotype-baikuk.png"
             alt="ê¸€ì”¨ë¡œê³ " class="h-11 w-auto cursor-pointer" onclick="showLogin()" />
        <div class="relative">
            <button id="filter-btn-init" data-default-label="ì´ˆê¸°í™”" onclick="resetFilters()"
                    class="ml-[100px] px-3 py-1.5 border border-gray-200 bg-red-100 text-red-600 rounded-md shadow-sm text-sm font-bold hover:bg-red-200 transition">ì´ˆê¸°í™”</button>
        </div>
        <div id="filter-bar" class="flex flex-row gap-2 items-start mt-2 relative z-[1000]">
            <div id="btn-wrap" class="flex flex-row gap-2"></div>
        </div>

        <button id="filter-btns-wrap" class="flex gap-1"></button>

        <div style="flex:1"></div> <button id="logout-btn" onclick="logout()" class="hidden text-sm text-gray-600 hover:text-black border px-3 py-1 rounded">
            ë¡œê·¸ì•„ì›ƒ
        </button>
    </header>
    
    <div id="login-modal" class="fixed inset-0 z-[20000] bg-black/40 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-lg p-8 w-80">
            <h2 class="font-bold text-xl mb-4 text-center">ì§ì› ë¡œê·¸ì¸</h2>
            <input id="login-email" type="email" placeholder="ì´ë©”ì¼" class="w-full border border-gray-300 rounded px-3 py-2 mb-3" />
            <input id="login-password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full border border-gray-300 rounded px-3 py-2 mb-4" />
            <button onclick="login()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-semibold">
                ë¡œê·¸ì¸
            </button>
            <button onclick="hideLogin()" class="w-full text-gray-500 mt-2">ë‹«ê¸°</button>
            <div id="login-error" class="text-red-600 text-sm mt-2 hidden"></div>
        </div>
    </div>
    <div id="loading-overlay" class="fixed inset-0 z-[30000] bg-black bg-opacity-40 flex items-center justify-center hidden">
        <div class="text-white text-xl font-bold">ë¡œê·¸ì¸ ì¤‘ì…ë‹ˆë‹¤...</div>
    </div>

    <div id="map"></div>
    <div id="info-panel" class="overflow-y-auto bg-white shadow-xl p-3 text-sm hidden">
        <div id="info-content" class="text-xs text-gray-700"></div>
    </div>
    <div id="detail-panel" class="hidden" style="background-color: white;">
        <button id="close-detail-btn" onclick="hideDetailPanel()" class="absolute top-2 right-4 w-8 h-8 bg-white text-gray-600 border border-gray-300 hover:border-black hover:text-black shadow-md flex items-center justify-center font-bold text-lg z-[1001]">
            âœ•
        </button>
        <div id="detail-content" class="text-gray-800 text-sm whitespace-pre-line overflow-y-auto h-full px-4 pb-4"></div>
    </div>

    <div id="map-controls" class="fixed z-[11000] flex flex-col items-center bottom-10 right-5">
        <button id="btn-naver-map" class="w-10 h-10 shadow rounded-lg flex items-center justify-center border border-gray-300 bg-[#00de5a] hover:bg-[#00b74a] transition mb-3 text-white text-[28px] font-black" style="text-shadow: 0 1px 2px #ffffff, 0 0 1px #ffffff;" title="ë„¤ì´ë²„ì§€ë„">
            N
        </button>
        <button id="btn-current-location" class="w-10 h-10 shadow rounded-lg flex items-center justify-center border border-gray-300 bg-white hover:bg-yellow-200 transition mb-5" title="í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™">
            <span class="text-xl text-black font-bold">â—‰</span>
        </button>
        <div class="flex flex-col space-y-1">
            <button id="btn-zoom-in" class="w-10 h-10 shadow rounded-lg flex items-center justify-center border border-gray-300 bg-white hover:bg-yellow-200 transition" title="í™•ëŒ€">
                <span class="text-2xl text-black font-bold">ï¼‹</span>
            </button>
            <button id="btn-zoom-out" class="w-10 h-10 shadow rounded-lg flex items-center justify-center border border-gray-300 bg-white hover:bg-yellow-200 transition" title="ì¶•ì†Œ">
                <span class="text-2xl text-black font-bold">ï¼</span>
            </button>
        </div>
    </div>

  <script>
    const supabaseUrl = 'https://sfinbtiqlfnaaarziixu.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaW5idGlxbGZuYWFhcnppaXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MDkxNjEsImV4cCI6MjA2ODA4NTE2MX0.4-7vnIjbF-biWWuv9-vTxK9Y99gMm-vS6oaRMdRL5fA';
    const client = supabase.createClient(supabaseUrl, supabaseKey);
    window.client = client;
    const BUCKET = window.BUCKET || 'listing-images';

    // ì ‘ì† ì¦‰ì‹œ ì„¸ì…˜ í™•ì¸ â†’ ìˆìœ¼ë©´ admin.htmlë¡œ ì´ë™(ì¿¼ë¦¬ìŠ¤íŠ¸ë§ì€ ê·¸ëŒ€ë¡œ ìœ ì§€)
    (async function earlyRedirect() {
        const { data: { session } } = await client.auth.getSession();
        if (session) {
            location.replace('/admin' + location.search);
            return;
        }
    })();

    // ë¡œê·¸ì¸ ì§í›„ì—ë„ ìë™ ì´ë™ (í˜¹ì‹œ ëª¨ë¥¼ íƒ€ì´ë° ì´ìŠˆ ëŒ€ë¹„)
    client.auth.onAuthStateChange((_event, session) => {
        if (session) location.replace('/admin' + location.search);
    });

    let _imgReqToken = 0;

    // --- Constants ---
    const HIGHLIGHT_COLOR = "#F2C130";
    const HIGHLIGHT_TEXT_COLOR = "#111";
    const DEFAULT_BTN_BG = "#f3f4f6";
    const DEFAULT_BTN_TEXT = "#374151";
    const PAGE_SIZE = 15;
    
    const allDealTypes = ['ì›”ì„¸', 'ë§¤ë§¤'];
    const allCategories = ['ìƒê°€', 'ê³µì¥Â·ì°½ê³ '];
    
    const filterDefs = [
        { id: 'deposit',       label: 'ë³´ì¦ê¸ˆ',    width: 300 },
        { id: 'rent',          label: 'ì›”ì„¸',      width: 280 },
        { id: 'floor',         label: 'ì¸µ',        width: 280 },
        { id: 'area_py',       label: 'ì „ìš©í‰ìˆ˜',   width: 280 },
        { id: 'sale',          label: 'ë§¤ë§¤ê°€',     width: 300 },
        { id: 'total_deposit', label: 'ì´ë³´ì¦ê¸ˆ',   width: 300 },
        { id: 'total_rent',    label: 'ì´ì›”ì„¸',     width: 280 },
    ];
    const filterUnits = {
        floor: 'ì¸µ', sale: 'ë§Œ', deposit: 'ë§Œ', rent: 'ë§Œ',
        total_deposit: 'ë§Œ', total_rent: 'ë§Œ', area_py: 'í‰'
    };

    // --- State Variables ---
    let selectedDealTypes = ['ì›”ì„¸'];
    let selectedCategories = ['ìƒê°€'];
    let allListings = {};
    window.allListings = allListings;
    let allMarkers = {};
    let isLoading = false;
    let isLoggedIn = false;
    let map, clusterer, customImage, mapIdleTimer;
    let selectedClusterEl = null;
    let matchedListingsCache = [];
    let matchedListingsPage = 1;
    window.currentDetailListingId = null;

    // === â‘¡ ìºì‹œ: key -> { url, expireAt, inflight? } ===
    const _signedUrlCache2 = new Map();

    // key ì¡°í•© ìœ í‹¸
    const _k = (path, kind, w='') => `${kind}:${path}|w=${w}`;

    // === â‘  TTL ìƒìˆ˜(ì›í•˜ëŠ” ê°’ìœ¼ë¡œ ì¡°ì ˆ) ===
    const TTL_THUMB_SEC   = 600;  // ì¸ë„¤ì¼ 10ë¶„
    const TTL_DISPLAY_SEC = 900;  // ìƒì„¸ 15ë¶„
    const TTL_ORIG_SEC    = 900;  // ì›ë³¸ 15ë¶„
    const TTL_SKEW_MS     = 15_000; // ë§Œë£Œ 15ì´ˆ ì „ì´ë©´ ê°±ì‹ 

    // --- DOM Elements ---
    const infoPanel = document.getElementById('info-panel');
    const infoContent = document.getElementById('info-content');
    const detailPanel = document.getElementById('detail-panel');
    const detailContent = document.getElementById('detail-content');

    // ì§€ì ì •ë³´/ë‹´ë‹¹ì ì†Œì† ìºì‹œ
    const staffAffCache   = new Map();   // key: staff id or name  â†’ affiliation
    const branchInfoCache = new Map();   // key: affiliation       â†’ branch_info row
    

    // --- Initialization ---
    map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(37.7151, 126.7341),
        level: 3
    });

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            pos => map.setCenter(new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude)),
            err => console.log("ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", err)
        );
    }

    infoPanel.style.display = 'block';

    customImage = new kakao.maps.MarkerImage(
        'https://raw.githubusercontent.com/mhale45/image/2d7ce4379b14d095d2f0b7f1d0057987548a37bf/2.png',
        new kakao.maps.Size(36, 36),
        { offset: new kakao.maps.Point(18, 36) }
    );

    // ë¡œê·¸ì¸ íšŸìˆ˜ì œí•œ ê´€ë ¨ì½”ë“œ
    // ì„¸ì…˜/ê¶Œí•œ ê°€ë“œ + ë¯¸í†µê³¼ ì‹œ ì•ˆë‚´ í›„ ë¦¬ë””ë ‰íŠ¸
    if (REQUIRE_AUTH) {
        (async function guardAuthOrRedirect() {
            try {
            const { data: { session } } = await client.auth.getSession();
            if (!session) {
                redirectWithMessage('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            // í—ˆìš© ì„¸ì…˜ì¸ì§€ ì„œë²„(RLS í•¨ìˆ˜)ì—ê²Œ í™•ì¸
            const { data: allowed, error } = await client.rpc('is_session_allowed');
            if (error || allowed !== true) {
                // ì•ˆì „í•˜ê²Œ ì„¸ì…˜ ì¢…ë£Œ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
                await client.auth.signOut();
                redirectWithMessage('í—ˆìš©ëœ ê¸°ê¸° ìˆ˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ë¡œê·¸ì•„ì›ƒ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                return;
            }

            // (ì„ íƒ) ì‹¤ì‹œê°„ ë³€ë™ ëŒ€ì‘: ì„¸ì…˜/í† í° ê°±ì‹  ë•Œë§ˆë‹¤ ë‹¤ì‹œ ì²´í¬
            client.auth.onAuthStateChange(async (_evt, s) => {
                if (!s) {
                redirectWithMessage('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
                }
                const { data: ok } = await client.rpc('is_session_allowed').catch(() => ({ data: false }));
                if (!ok) {
                await client.auth.signOut();
                redirectWithMessage('í—ˆìš©ëœ ê¸°ê¸° ìˆ˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ë¡œê·¸ì•„ì›ƒ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                }
            });
            } catch (e) {
            // ì˜¤ë¥˜ ì‹œë„ ì—­ì‹œ ì•ˆì „í•˜ê²Œ ëŒë ¤ë³´ëƒ„
            await client.auth.signOut().catch(()=>{});
            redirectWithMessage('ì¸ì¦ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
            }
        })();
    }

    // ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘

    // listingì—ì„œ ë‹´ë‹¹ì ì‹ë³„ì í›„ë³´ë¥¼ ë½‘ëŠ”ë‹¤
    function extractAgentKeys(listing) {
        const ids = [listing.staff_profiles_id, listing.staff_id, listing.staffId, listing.agent_id, listing.agentId]
            .filter(v => v !== null && v !== undefined)
            .map(v => String(v));
        const names = [listing.staff_name, listing.agent_name, listing.manager_name]
            .filter(Boolean)
            .map(n => String(n).trim())
            .filter(n => n && n !== '-' && n !== 'ë¯¸ì§€ì •');
        return { ids, names };
    }

    // ë‹´ë‹¹ìì˜ affiliationì„ ì°¾ëŠ”ë‹¤ (id ìš°ì„ , ì—¬ëŸ¬ ë°©ì‹ìœ¼ë¡œ ë„“ê²Œ)
    async function resolveListingAffiliation(listing) {
        // 0) listing ìì²´ì— affiliation ë¹„ìŠ·í•œ í•„ë“œê°€ ìˆìœ¼ë©´ ë°”ë¡œ ì‚¬ìš©
        const directAff =
            listing.affiliation || listing.branch_affiliation || listing.branch || '';
        if (directAff && directAff.trim()) return directAff.trim();

        const { ids, names } = extractAgentKeys(listing);

        // 1) idë“¤ ì¼ê´„ ì¡°íšŒ (ì—¬ëŸ¬ê°œë¥¼ inìœ¼ë¡œ í•œ ë²ˆì—)
        if (ids.length) {
            const { data, error } = await client
            .from('public_staff_view')
            .select('id, affiliation')
            .in('id', ids.map(String));
            if (!error && Array.isArray(data) && data.length) {
            const hit = data.find(r => r?.affiliation);
            if (hit?.affiliation) return String(hit.affiliation).trim();
            }
        }

        // 2) ì´ë¦„ ë„“ì€ ë§¤ì¹­: ê³µë°± ì œê±°/ì§í•¨ ì œê±° + ilike
        const norm = s =>
            String(s)
            .replace(/\s+/g, '')    // ëª¨ë“  ê³µë°± ì œê±°
            .replace(/íŒ€ì¥|ì‹¤ì¥|ê³¼ì¥|ëŒ€ë¦¬|ëŒ€í‘œ|ë‹˜|ì”¨/g, '') // í”í•œ ì§í•¨ ì œê±°(í•„ìš”ì‹œ ì¶”ê°€)
            .trim();

        for (const raw of names) {
            const name = norm(raw);
            if (!name) continue;

            // ì •í™• ì¼ì¹˜ ìš°ì„ 
            {
            const { data, error } = await client
                .from('public_staff_view')
                .select('affiliation')
                .eq('name', raw)             // ìš°ì„  ì›ë¬¸ìœ¼ë¡œ
                .maybeSingle();
            if (!error && data?.affiliation) return String(data.affiliation).trim();
            }

            // ê·¸ ë‹¤ìŒ ilike(ë¶€ë¶„ì¼ì¹˜)
            {
            const { data, error } = await client
                .from('public_staff_view')
                .select('name, affiliation')
                .ilike('name', `%${name}%`)
                .limit(3);
            if (!error && Array.isArray(data) && data.length) {
                const hit = data.find(r => r?.affiliation);
                if (hit?.affiliation) return String(hit.affiliation).trim();
            }
            }
        }

        // ê·¸ë˜ë„ ëª» ì°¾ìœ¼ë©´ null
        return null;
    }


    // affiliationìœ¼ë¡œ branch_info 1ê±´ì„ ê°€ì ¸ì˜¨ë‹¤
    async function fetchBranchInfoByAffiliation(affiliation) {
        if (!affiliation) return null;
        if (branchInfoCache.has(affiliation)) return branchInfoCache.get(affiliation);

        const { data, error } = await client
        .from('branch_info')
        .select('affiliation, office_name, full_address, contact_number, registration_number, representative_name, is_public')
        .ilike('affiliation', affiliation)
        .maybeSingle();

        if (error || !data) return null;
        branchInfoCache.set(affiliation, data);
        return data;
    }

    // ì§€ì  í•„ìˆ˜ í‘œê¸° ì •ë³´
    function buildBranchInfoHTML(row) {
        if (!row) return '';
        const safe = (v) => (v ?? '').toString().trim() || '-';
        return `<div class="mt-4 border-t pt-3">
            <div class="leading-5 text-gray-700"><div>${safe(row.affiliation)}
            </div><div>${safe(row.office_name)}
            </div><div>${safe(row.full_address)}
            </div><div>${safe(row.contact_number)}
            </div><div>${safe(row.registration_number)}
            </div><div>${safe(row.representative_name)}
            </div></div>
        </div>`;
    }

    // ìƒì„¸íŒ¨ë„ì— ì§€ì ì •ë³´ ë¸”ë¡ì„ ì±„ì›Œ ë„£ëŠ”ë‹¤
    async function populateBranchInfoFor(listing) {
        try {
            const aff = await resolveListingAffiliation(listing);
            console.log('[BRANCH] resolved affiliation =', aff, 'from listing=', listing?.agent_name || listing?.staff_name);
            const info = await fetchBranchInfoByAffiliation(aff);
            console.log('[BRANCH] branch_info row =', info);
            const slot = document.getElementById('branch-info-slot');
            if (slot) slot.innerHTML = buildBranchInfoHTML(info);
        } catch (e) {
            console.warn('[branch info] render failed:', e);
        }
    }

    
    // createSignedUrl í˜¸ì¶œ ë˜í¼
    async function _issueSignedUrl(kind, path, w) {
        if (kind === 'thumb') {
            const { data, error } = await client.storage.from(BUCKET)
            .createSignedUrl(path, TTL_THUMB_SEC, { transform: { width: w ?? 220, resize: 'contain', quality: 85 }});
            if (error) throw error;
            return { url: data.signedUrl, ttlSec: TTL_THUMB_SEC };
        }
        if (kind === 'display') {
            const { data, error } = await client.storage.from(BUCKET)
            .createSignedUrl(path, TTL_DISPLAY_SEC, { transform: { width: w ?? 900, quality: 85 }});
            if (error) throw error;
            return { url: data.signedUrl, ttlSec: TTL_DISPLAY_SEC };
        }
        if (kind === 'orig') {
            const { data, error } = await client.storage.from(BUCKET)
            .createSignedUrl(path, TTL_ORIG_SEC);
            if (error) throw error;
            return { url: data.signedUrl, ttlSec: TTL_ORIG_SEC };
        }
        throw new Error('unknown kind');
    }

    // signed URL í—¬í¼ (ìºì‹œ/TTL ìë™ ê´€ë¦¬)
    const signThumb    = (path, w=240) => getSignedUrlAuto('thumb',    path, w);
    const signDisplay  = (path, w=900) => getSignedUrlAuto('display',  path, w);
    const signOriginal = (path)        => getSignedUrlAuto('orig',     path);

    // ë§Œë£Œ ì„ë°• ì‹œ ìë™ ì¬ë°œê¸‰í•´ ì£¼ëŠ” getter
    async function getSignedUrlAuto(kind, path, w) {
        const key = _k(path, kind, w);
        const now = Date.now();
        const cached = _signedUrlCache2.get(key);

        // ì´ë¯¸ ë°œê¸‰ ì¤‘ì´ë©´ ê·¸ í”„ë¼ë¯¸ìŠ¤ë¥¼ ê·¸ëŒ€ë¡œ ëŒ€ê¸°
        if (cached?.inflight) return cached.inflight;

        // ìºì‹œê°€ ìˆê³  ì•„ì§ ì¶©ë¶„íˆ ìœ íš¨í•˜ë©´ ì‚¬ìš©
        if (cached?.url && cached.expireAt && (cached.expireAt - now) > TTL_SKEW_MS) {
            return cached.url;
        }

        // ìƒˆë¡œ ë°œê¸‰(ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€ìš© inflight ì €ì¥)
        const inflight = (async () => {
            const { url, ttlSec } = await _issueSignedUrl(kind, path, w);
            const expireAt = Date.now() + (ttlSec * 1000);
            _signedUrlCache2.set(key, { url, expireAt, inflight: null });
            return url;
        })();

        _signedUrlCache2.set(key, { ...(cached||{}), inflight });
        return inflight;
    }
    

    async function preloadPublicStaffExtensions() {
        try {
            const { data, error } = await client
            .from('public_staff_view')
            .select('name, extension');

            if (error) {
            console.warn('[public_staff_view] ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
            return;
            }

            (data || []).forEach(row => {
            if (row.name) {
                staffPublicMap.set(row.name.trim(), row.extension || '');
            }
            });
        } catch (e) {
            console.warn('[public_staff_view] ì˜ˆì™¸ ë°œìƒ:', e);
        }
    }

    function getExtensionFromAgentName(listing) {
        const name = listing.agent_name?.trim();
        if (!name) return '';
        return staffPublicMap.get(name) || '';
    }


    // â”€â”€ ìˆ«ì/ë¬¸ì ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function escapeHtml(s='') {
        return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }
    function fmtMan(v) {
        if (v === null || v === undefined || v === '') return '';
        const n = Number(v);
        return Number.isFinite(n) ? n.toLocaleString('ko-KR') : String(v);
    }
    function toPyeong(m2) {
        if (m2 === null || m2 === undefined || m2 === '') return '';
        const n = Number(m2);
        if (!Number.isFinite(n)) return '';
        return Math.round(n * 0.3025 * 10) / 10; // ì†Œìˆ˜1ìë¦¬
    }

    // â”€â”€ ë‹´ë‹¹ì extension ë§µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const staffExtMap = new Map(); // id/name ëª¨ë‘ í‚¤ë¡œ ë³´ê´€

    async function preloadStaffExtensions() {
        try {
        const { data, error } = await client
            .from('public_staff_view')
            .select('name, extension');

        if (error) { console.warn('[staff ext] load error:', error); return; }
        (data || []).forEach(s => {
            if (s.name)         staffExtMap.set(s.name, s.extension || '');
        });
        } catch (e) {
        console.warn('[staff ext] exception:', e);
        }
    }

    function getStaffExtensionFor(listing) {
        const keys = [
        listing.staff_id, listing.staffId, listing.agent_id, listing.agentId,
        listing.staff_name, listing.agent_name, listing.manager_name
        ].filter(Boolean);
        for (const k of keys) {
        const ext = staffExtMap.get(String(k));
        if (ext) return ext;
        }
        return '';
    }

    // ğŸ”¹ ì†Œìˆ˜ ì²«ì§¸ìë¦¬ í¬ë§·í„°
    function oneDecimal(v) {
        if (v === null || v === undefined || v === '') return '';
        const n = Number(v);
        return Number.isFinite(n) ? n.toFixed(1) : '';
    }

    // â”€â”€ ì„¤ëª…ë¬¸ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function buildListingDescBlock(listing) {
        const listingId   = listing.listing_id ?? listing.id ?? '';
        const deposit     = fmtMan(listing.deposit_price);
        const monthly     = fmtMan(listing.monthly_rent);
        const areaPy = oneDecimal(listing.area_py ?? toPyeong(listing.area_m2));
        const loc = [
            listing.province, listing.city, listing.district,
            listing.detail_address, listing.building_name
        ].filter(Boolean).join(' ');
        const buildingUsage   = listing.building_usage ?? '';
        const restroom        = listing.restroom ?? '';
        const storeTypeDetail = listing.store_type_detail ?? '';
        const title           = listing.title ?? '';
        const staffExt        = getExtensionFromAgentName(listing);

        const lines = [
            'â”  ë„¤ì´ë²„ì— "ë°±ì–µì§€ë„"ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”',
            'â”‚  ëª¨ë“  ë§¤ë¬¼ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤',
            'â””  www.ë°±ì–µì§€ë„.com',
            '',
            `ğŸŒˆ ë°±ì–µ ë§¤ë¬¼ë²ˆí˜¸ :  ${listingId}`,
            'ìœ„ ë§¤ë¬¼ë²ˆí˜¸ ì•Œë ¤ì£¼ì‹œë©´ ë¹ ë¥´ê²Œ ìƒë‹´ì§„í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤!',
            '',
            'ğŸŒˆ ë§¤ë¬¼ ì •ë³´ ìš”ì•½',
            `- ê¸ˆì•¡ : ë³´ì¦ê¸ˆ ${deposit} ë§Œ / ì›”ì„¸ ${monthly}ë§Œ /  ê¶Œë¦¬(ì „í™”ë¬¸ì˜)`,
            `- ë©´ì  : ì•½ ${areaPy}í‰`,
            `- ìœ„ì¹˜ : ${loc}`,
            `- ìš©ë„ : ${buildingUsage}`,
            `- ë°© : ê±´ì¶•ë¬¼í˜„í™©ë„ìƒ ë°©ì—†ìŒ`,
            `- í™”ì¥ì‹¤ : ${restroom}`,
            `- ì¶”ì²œì—…ì¢… : ${storeTypeDetail}`,
            `- íŠ¹ì§• : ${title}`,
            '',
            'ğŸŒˆ ë°±ì–µ ë¶€ë™ì‚°ì˜ ì•½ì†',
            '- ì‹ ì†, ì •í™•, ì •ì§í•œ ì¤‘ê°œ, ì‹ ë¢°ìˆëŠ” ì¤‘ê°œ, í—ˆìœ„ ë§¤ë¬¼ ZERO',
            '- ì—…ì¢…ê³¼ ì¡°ê±´(ìœ„ì¹˜, ë©´ì , ë³´ì¦ê¸ˆ, ì„ëŒ€ë£Œ, ê¶Œë¦¬ê¸ˆ)ì— ë§ëŠ” ìµœì í™” ë§¤ë¬¼ì„ ì°¾ì•„ ë“œë¦½ë‹ˆë‹¤.',
            '- ê³ ê°ë‹˜ì˜ ì…ì¥ì—ì„œ ë³´ì¦ê¸ˆê³¼ ì„ëŒ€ë£Œ, ê¶Œë¦¬ê¸ˆ ìµœëŒ€í•œ ì¡°ìœ¨ í•´ ë“œë¦½ë‹ˆë‹¤.',
            '- ê³ ê°ë‹˜ í•œë¶„ í•œë¶„ì˜ ì¸ì—°ì„ ì†Œì¤‘í•˜ê²Œ ìƒê°í•©ë‹ˆë‹¤.',
            '',
            `ğŸ“ ì¹œì ˆí•œ ìƒë‹´ ${staffExt}`
        ];

        // í…œí”Œë¦¿ì„ HTMLë¡œ ì£¼ì…í•˜ë¯€ë¡œ XSS ëŒ€ë¹„ ì´ìŠ¤ì¼€ì´í”„
        return lines.map(escapeHtml).join('\n');
    }

    // ì•± ì‹œì‘ ì‹œ í•œ ë²ˆë§Œ í˜¸ì¶œ (ë¡œê·¸ì¸/ì´ˆê¸°í™” ì§í›„ ì ì ˆí•œ ìœ„ì¹˜ì—ì„œ)
    preloadStaffExtensions();
    preloadPublicStaffExtensions();

    // ================== ğŸ§Š ìƒì„¸ ì¸ë„¤ì¼ ì˜ˆì—´(ë””ì½”ë“œ) ==================
    async function prewarmDetailThumbs(listingIds, {
        perListing = 2,         // ë§¤ë¬¼ë‹¹ ëª‡ ì¥ ë¯¸ë¦¬?
        displayWidth = 900,     // ìƒì„¸íŒ¨ë„ í‘œì‹œìš© ë³€í™˜í­
        timeout = 800,          // ë””ì½”ë”© íƒ€ì„ì•„ì›ƒ(ms)
        maxListings = 60        // í•œ ë²ˆì— ì˜ˆì—´í•  ë§¤ë¬¼ ìˆ˜ ìƒí•œ
    } = {}) {
        const ids = [...new Set((listingIds||[]).map(String))].slice(0, maxListings);
        if (!ids.length) return;

        // 1) í•´ë‹¹ ë§¤ë¬¼ë“¤ì˜ ì´ë¯¸ì§€ ëª©ë¡(ëŒ€í‘œ ìš°ì„  â†’ ìˆœì„œ) ê°€ì ¸ì˜¤ê¸°
        const { data: rows, error } = await client
            .from('listing_images')
            .select('listing_id, path, is_primary, order_index')
            .in('listing_id', ids)
            .eq('is_private', false)
            .order('is_primary', { ascending: false })
            .order('order_index', { ascending: true });

        if (error || !rows?.length) return;

        // 2) ë§¤ë¬¼ë³„ ìƒìœ„ Nì¥ë§Œ ì¶”ë¦¬ê¸°
        const pick = [];
        const pickedCount = new Map(); // listing_id -> count
        for (const r of rows) {
            const id = String(r.listing_id);
            const n = pickedCount.get(id) || 0;
            if (n < perListing) {
            pick.push(r.path);
            pickedCount.set(id, n + 1);
            }
        }

        // 3) í‘œì‹œìš© URL ë°œê¸‰(ìºì‹œ ì‚¬ìš©) â†’ ë””ì½”ë”©
        const urls = await Promise.all(
            pick.map(p => signDisplay(p, displayWidth).catch(() => ''))
        );
        const finalUrls = urls.filter(Boolean);
        if (!finalUrls.length) return;

        // 4) ì´ë¯¸ì§€ ë””ì½”ë”© (ì¡°ìš©íˆ, ì§§ì€ íƒ€ì„ì•„ì›ƒ)
        const loaders = finalUrls.map(u => {
            const img = new Image();
            img.decoding = 'async';
            img.loading  = 'eager';
            img.src = u;
            return img.decode ? img.decode().catch(()=>{}) : new Promise(res => {
            img.onload = img.onerror = () => res();
            });
        });

        await Promise.race([
            Promise.allSettled(loaders),
            new Promise(res => setTimeout(res, timeout))
        ]);
    }

    // ============ ğŸ”¥ ëª°ë˜ ì˜ˆì—´ ìœ í‹¸ ============
    // ìºì‹œëœ ì¸ë„¤ì¼ë“¤ì„ ì‹¤ì œë¡œ ë””ì½”ë”©í•´ì„œ ë¸Œë¼ìš°ì € ìºì‹œì— ì˜¬ë ¤ë‘”ë‹¤
    async function ensureThumbsReady(ids, { timeout = 1000 } = {}) {
        const strIds = (ids || []).map(String);
        if (!strIds.length) return;

        await loadPrimaryThumbsBatch(strIds).catch(() => {});

        // âœ… ìºì‹œ ê°ì²´ -> ë¬¸ìì—´ URLë§Œ ì¶”ì¶œ
        const urls = strIds
            .map(id => primaryThumbCache.get(id)?.url)
            .filter(Boolean);

        if (!urls.length) return;

        const loaders = urls.map(u => {
            const img = new Image();
            img.decoding = 'async';
            img.loading  = 'eager';
            img.src = u;
            return img.decode ? img.decode().catch(()=>{}) : new Promise(res => {
            img.onload = img.onerror = () => res();
            });
        });

        await Promise.race([
            Promise.allSettled(loaders),
            new Promise(res => setTimeout(res, timeout))
        ]);
    }


    // í˜„ì¬ í™”ë©´ê³¼ ê´€ë ¨ ë†’ì€ ë§¤ë¬¼ë“¤ ìš°ì„ ìœ¼ë¡œ ì˜ˆì—´ (matched â†’ allListings)
    function tryPrewarmVisibleThumbs() {
        const base = (Array.isArray(matchedListingsCache) && matchedListingsCache.length > 0)
            ? matchedListingsCache
            : Object.values(allListings);

        const ids = [...new Set(
            base.slice(0, 500)             // ê³¼í•œ ë””ì½”ë”© ë°©ì§€
                .map(l => l?.listing_id)
                .filter(Boolean)
        )];

        if (ids.length) {
            ensureThumbsReady(ids, { timeout: 800 }).catch(() => {});
        }
    }

    function redirectWithMessage(msg) {
        const loginUrl = new URL(LOGIN_PAGE, location.origin);
        // ì´ë¯¸ ë¡œê·¸ì¸ í˜ì´ì§€ë©´ ë¦¬ë‹¤ì´ë ‰íŠ¸ ë§ê³  ëª¨ë‹¬ë§Œ ë„ì›€
        if (location.pathname === loginUrl.pathname) {
            try { sessionStorage.removeItem('auth_msg'); } catch (_) {}
            const errorDiv = document.getElementById('login-error');
            if (errorDiv) { errorDiv.textContent = String(msg || ''); errorDiv.classList.remove('hidden'); }
            if (typeof showLogin === 'function') showLogin();
            return;
        }

        try { sessionStorage.setItem('auth_msg', String(msg || '')); } catch (_) {}
        if (location.search) loginUrl.search = location.search;
        location.replace(loginUrl.href);
    }
    
    // ê°œë³„ url ê´€ë ¨ì½”ë“œ
    // === ë”¥ë§í¬ ìœ í‹¸: ?id=12345 ë°©ì‹ ===
    function getListingIdFromURL() {
        const sp = new URLSearchParams(location.search);
        const qId = sp.get('id');
        return qId && /^\d+$/.test(qId) ? qId : null;
    }

    function updateURLForListing(listingId, replace=false) {
        const url = new URL(location.href);
        if (listingId) url.searchParams.set('id', String(listingId));
        else url.searchParams.delete('id');
        const method = replace ? 'replaceState' : 'pushState';
        try { history[method]({}, '', url); } catch (_) {}
    }

    async function openDeepLink(listingId) {
        if (!listingId) return;
        const id = String(listingId);

        // ë¡œì»¬ ìºì‹œì— ì—†ìœ¼ë©´ ë‹¨ê±´ ì¡°íšŒ
        if (!allListings[id]) {
            const table = 'public_baikuk_view';
            const { data, error } = await client
            .from(table).select('*').eq('listing_id', id).maybeSingle();

            if (error || !data) { showToast?.('í•´ë‹¹ ë§¤ë¬¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); return; }

            // building_info ë³‘í•©
            try {
            const key = (data.addr_compare || '').replace(/\s+/g,'').trim();
            if (key) {
                const { data: bi } = await client
                .from('building_info')
                .select('building_name, building_note, addr_compare')
                .eq('addr_compare', key).maybeSingle();
                if (bi) {
                data.building_name = bi.building_name ?? data.building_name ?? '-';
                data.building_note = bi.building_note ?? data.building_note ?? '-';
                }
            }
            } catch (e) {}

            allListings[id] = data;         // â† ë¡œì»¬ ìºì‹œì— ì €ì¥
            window.allListings = allListings; // â† (ì„ íƒ) ìœˆë„ìš°ì™€ë„ ë™ì¼ ê°ì²´ ìœ ì§€
        }

        const l = allListings[id];        // â† ì´ì œ ë¡œì»¬ì—ì„œ ì½ê¸°
        if (map && l?.lat && l?.lng) {
            map.setCenter(new kakao.maps.LatLng(l.lat, l.lng));
            map.setLevel(3);
        }
        showDetailPanel(id);
        updateURLForListing(id, true);
    }


    // ë¸Œë¼ìš°ì € ë’¤/ì• ì´ë™ ëŒ€ì‘
    window.addEventListener('popstate', () => {
    const id = getListingIdFromURL();
    if (id) openDeepLink(id);
    else if (typeof hideDetailPanel === 'function') hideDetailPanel();
    });
    // ê°œë³„ url ê´€ë ¨ì½”ë“œ
    
    function applyButtonStyle(button, isActive) {
        if (isActive) {
            button.style.backgroundColor = HIGHLIGHT_COLOR;
            button.style.color = HIGHLIGHT_TEXT_COLOR;
            button.style.fontWeight = 'bold';
            button.style.borderColor = "#eab308";
        } else {
            button.style.backgroundColor = DEFAULT_BTN_BG;
            button.style.color = DEFAULT_BTN_TEXT;
            button.style.fontWeight = 'normal';
            button.style.borderColor = "#d1d5db";
        }
    }

    function renderFilterButtons() {
        const wrap = document.getElementById('filter-btns-wrap');
        wrap.innerHTML = '';

        filterDefs.forEach(def => {
            const box = document.createElement('div');
            box.className = 'relative';
            
            const btn = document.createElement('button');
            btn.id = `filter-btn-${def.id}`;
            btn.className = "px-2 py-2 border border-gray-300 bg-white rounded-md shadow-sm text-[14px] text-gray-800 font-medium hover:bg-gray-100";
            btn.dataset.defaultLabel = def.label + ' â–¼';
            btn.innerText = def.label + ' â–¼';
            btn.onclick = () => toggleFilterPanel(def.id);

            const panel = document.createElement('div');
            panel.id = `filter-panel-${def.id}`;
            panel.className = 'hidden absolute left-0 mt-1 bg-white border rounded shadow z-50 p-3';
            panel.style.width = `${def.width}px`;
            panel.innerHTML = `
                <div class="flex items-center gap-2">
                    <input id="${def.id}_min" type="number" placeholder="ì´ìƒ" class="w-20 px-2 py-1 border rounded text-sm" />
                    <span class="text-gray-500">~</span>
                    <input id="${def.id}_max" type="number" placeholder="ì´í•˜" class="w-20 px-2 py-1 border rounded text-sm" />
                </div>`;
            
            box.appendChild(btn);
            box.appendChild(panel);
            wrap.appendChild(box);

            const updateAction = () => {
                updateFilterButtonText(def.id);
                updateFilteredListings();
            };
            panel.querySelector(`#${def.id}_min`).addEventListener('input', updateAction);
            panel.querySelector(`#${def.id}_max`).addEventListener('input', updateAction);
        });
    }

    // âœ… Original Style Restored: í´ëŸ¬ìŠ¤í„° í´ë¦­, ë§ˆìš°ìŠ¤ì˜¤ë²„/ì•„ì›ƒ ìŠ¤íƒ€ì¼ì„ ì›ë˜ëŒ€ë¡œ ë³µì›
    function createClusterer(gridSize) {
        if (clusterer) clusterer.clear();
        clusterer = new kakao.maps.MarkerClusterer({
            map: map,
            averageCenter: true,
            minLevel: 1,
            minClusterSize: 1,
            disableClickZoom: true,
            gridSize: gridSize,
            styles: [{
                width: '40px', height: '40px', background: HIGHLIGHT_COLOR,
                border: '2px solid #F2C130', borderRadius: '50%',
                color: '#fff', fontWeight: 'bold', textAlign: 'center', lineHeight: '40px'
            }]
        });

        kakao.maps.event.addListener(clusterer, 'clusterclick', function(cluster) {
            if (selectedClusterEl) {
                selectedClusterEl.style.border = "none";
                selectedClusterEl.style.borderRadius = "50%";
                const prevInner = selectedClusterEl.querySelector('div');
                if (prevInner) {
                    prevInner.style.background = HIGHLIGHT_COLOR;
                    prevInner.style.color = "#fff";
                }
                selectedClusterEl = null;
            }

            const clusterEl = cluster.getClusterMarker().getContent().parentNode;
            if (clusterEl) {
                clusterEl.style.background = "transparent";
                clusterEl.style.border = "2px solid #F2C130";
                clusterEl.style.borderRadius = "50%";

                const inner = clusterEl.querySelector('div');
                if (inner) {
                    inner.style.background = "#ffffff";
                    inner.style.color = "#F2C130";
                    inner.style.borderRadius = "50%";
                }
                selectedClusterEl = clusterEl;
            }
            const listings = cluster.getMarkers().map(mk => allListings[mk.listing_id]).filter(Boolean);
            showListingsInPanel(listings);

            // âœ… í´ë¦­í•œ í´ëŸ¬ìŠ¤í„°ì˜ ë§¤ë¬¼ë“¤ ìƒì„¸ì´ë¯¸ì§€(ëŒ€í‘œ 1~2ì¥) ë¯¸ë¦¬ ë””ì½”ë”©
            prewarmDetailThumbs(listings.map(l => l.listing_id), {
                perListing: 2,        // í•„ìš”ì‹œ 1ë¡œ ì¤„ì´ë©´ ë” ê°€ë²¼ì›€
                displayWidth: 900,
                timeout: 800,
                maxListings: 60       // ë„ˆë¬´ í° í´ëŸ¬ìŠ¤í„°ëŠ” ìƒí•œ
            }).catch(()=>{});
        });
        
        kakao.maps.event.addListener(clusterer, 'clusterover', function(cluster) {
            const el = cluster.getClusterMarker().getContent()?.parentNode;
            if (el) {
                el.style.border = '3px solid white';
                el.style.borderRadius = '50%';
            }
        });

        kakao.maps.event.addListener(clusterer, 'clusterout', function(cluster) {
            const el = cluster.getClusterMarker().getContent()?.parentNode;
            if (el) {
                el.style.border = 'none';
            }
        });
    }

    function renderDealAndCategoryButtons() {
        const btnWrap = document.getElementById('btn-wrap');
        btnWrap.innerHTML = '';
        
        const createButton = (text, collection, clickHandler) => {
            const btn = document.createElement('button');
            const isActive = collection.includes(text);
            btn.textContent = isActive ? 'âœ“ ' + text : text;
            btn.className = "px-3 py-2 rounded-full border text-[13px] font-medium transition";
            btn.onclick = () => clickHandler(text);
            applyButtonStyle(btn, isActive);
            btnWrap.appendChild(btn);
        };
        
        allDealTypes.forEach(type => createButton(type, selectedDealTypes, toggleDealType));
        allCategories.forEach(cat => createButton(cat, selectedCategories, toggleCategory));
    }
    
    function toggleDealType(type) {
        if (selectedDealTypes.includes(type)) {
            if (selectedDealTypes.length > 1) {
                selectedDealTypes = selectedDealTypes.filter(x => x !== type);
            }
        } else {
            selectedDealTypes.push(type);
        }
        renderDealAndCategoryButtons();
        updateFilteredListings();
    }

    function toggleCategory(cat) {
        if (selectedCategories.includes(cat)) {
            selectedCategories = selectedCategories.filter(c => c !== cat);
        } else {
            selectedCategories.push(cat);
        }
        renderDealAndCategoryButtons();
        updateFilteredListings();
    }

    // --- Formatting Helpers ---
    function formatKoreanMoney(value) {
        if (!value && value !== 0) return '-';
        const num = Number(value);
        if (isNaN(num)) return '-';
        if (num >= 10000) {
            const eok = Math.floor(num / 10000);
            const man = num % 10000;
            return `${eok}ì–µ${man > 0 ? ' ' + man.toLocaleString() : ''}`;
        }
        return num.toLocaleString();
    }
    
    function formatDealPrice(l) {
        if (l.deal_type === "ë§¤ë§¤") return formatKoreanMoney(l.sale_price);
        if (l.deal_type === "ì›”ì„¸") return `${formatKoreanMoney(l.deposit_price)} / ${formatKoreanMoney(l.monthly_rent)}`;
        return "";
    }
    
    function formatFloor(floor, total_floors) {
        const floorStr = floor < 0 ? `B${Math.abs(floor)}` : `${floor}`;
        return `${floorStr}${total_floors ? `/${total_floors}ì¸µ` : ''}`;
    }

    function formatValue(type, val) {
        if (val === "" || val == null) return '-';
        const num = Number(val);
        if (isNaN(num)) return '-';
        
        if (['sale', 'deposit', 'rent', 'total_deposit', 'total_rent'].includes(type)) {
            return formatKoreanMoney(val) + (num < 10000 ? 'ë§Œ' : '');
        }
        if (['floor', 'area_py'].includes(type)) {
            return num + filterUnits[type];
        }
        return val;
    }

    // --- UI Update Functions ---
    // ê³ ê°ë·° ìƒì„¸íŒ¨ë„ ì—´ê¸° (ì‚¬ì§„ ë·°ì–´: ì‚¬ì§„ ì—†ìœ¼ë©´ ìë™ ìˆ¨ê¹€)
    async function showDetailPanel(listingId) {
        window.currentDetailListingId = listingId;
        renderMatchedListings?.();

        const listing = allListings[String(listingId)];
        if (!listing) return;

        // ìƒì„¸ í…œí”Œë¦¿ (+ ì´ë¯¸ì§€ ë·°ì–´ ë¸”ë¡ í¬í•¨)
        detailContent.innerHTML = `
            <div class="sticky top-0 z-10 bg-white shadow-md p-2 rounded cursor-pointer whitespace-normal">
            <div class="flex items-start gap-2">
                <div class="w-[61px] h-[26px] flex justify-center items-center border-[2px] border-[rgb(242,193,48)] text-[rgb(0,0,0)] px-1 py-0 rounded text-base font-bold">
                ${listing.listing_id}
                </div>
                <div class="flex-1 text-left font-semibold text-[rgb(80,152,233)] text-base translate-y-[3px] leading-tight">
                ${listing.deal_type} ${formatDealPrice(listing)}
                <span class="text-[13px] text-gray-700 ml-2">
                    ì „ìš© <strong class="font-semibold">${Number(listing.area_py).toFixed(1)}</strong>í‰,
                    <strong class="font-semibold">${formatFloor(listing.floor)}</strong>
                </span>
                </div>
            </div>
            <div class="text-base font-bold text-gray-900 mt-1">${(listing.title || '-')}
            <!-- ì´ë¯¸ì§€ ë·°ì–´: ê¸°ë³¸ì€ ìˆ¨ê¹€. initImageViewerì—ì„œ ì‚¬ì§„ ìˆìœ¼ë©´ ë³´ì—¬ì¤Œ -->
            </div></div><div id="image-viewer-slot"> </div> </div><div class="mb-2 px-4 pt-2">
            <span class="text-lg font-medium whitespace-pre-line leading-relaxed md:leading-7">${buildListingDescBlock(listing)}
            </span></div><div class="px-4 pb-4">
            <table class="table-auto w-full text-sm border-t border-gray-300 mt-2">
                <tbody>
                <tr class="border-b border-gray-300">
                    <td class="w-[7.5rem] py-2 font-semibold text-gray-500 bg-gray-50 border-r border-gray-300 pl-3">ì†Œì¬ì§€</td>
                    <td class="py-2 text-gray-800 pl-3">${listing.province} ${listing.city} ${listing.district}</td>
                </tr>
                <tr class="border-b border-gray-300">
                    <td class="py-2 font-semibold text-gray-500 bg-gray-50 border-r border-gray-300 pl-3">ê³„ì•½/ì „ìš©ë©´ì </td>
                    <td class="py-2 text-gray-800 pl-3 whitespace-nowrap">
                    ${
                        (!listing.supply_area_m2 || listing.supply_area_m2 === '-')
                        ? `${listing.area_m2}ã¡ / ${listing.area_m2}ã¡`
                        : `${listing.supply_area_m2}ã¡ / ${listing.area_m2}ã¡`
                    }
                    </td>
                </tr>
                <tr class="border-b border-gray-300">
                    <td class="py-2 font-semibold text-gray-500 bg-gray-50 border-r border-gray-300 pl-3">í•´ë‹¹ì¸µ/ì´ì¸µ</td>
                    <td class="py-2 text-gray-800 pl-3">${listing.floor} / ${listing.total_floors}</td>
                </tr>
                <tr class="border-b border-gray-300">
                    <td class="py-2 font-semibold text-gray-500 bg-gray-50 border-r border-gray-300 pl-3">ì…ì£¼ê°€ëŠ¥ì¼</td>
                    <td class="py-2 text-gray-800 pl-3">ì¦‰ì‹œì…ì£¼ í˜‘ì˜ê°€ëŠ¥</td>
                </tr>
                <tr class="border-b border-gray-300">
                    <td class="py-2 font-semibold text-gray-500 bg-gray-50 border-r border-gray-300 pl-3">ë°©í–¥</td>
                    <td class="py-2 text-gray-800 pl-3">${listing.direction ?? ''}</td>
                </tr>
                <tr class="border-b border-gray-300">
                    <td class="py-2 font-semibold text-gray-500 bg-gray-50 border-r border-gray-300 pl-3">ì´ì£¼ì°¨ëŒ€ìˆ˜</td>
                    <td class="py-2 text-gray-800 pl-3">${listing.parking ?? ''}</td>
                </tr>
                <tr>
                    <td class="py-2 font-semibold text-gray-500 bg-gray-50 border-r border-gray-300 pl-3">ì‚¬ìš©ìŠ¹ì¸ì¼</td>
                    <td class="py-2 text-gray-800 pl-3">${listing.approved_date ?? ''}</td>
                </tr>
                </tbody>
            </table></div><div id="branch-info-slot" class="px-4 pb-6 text-xs"></div>`;

        // ìŠ¤í¬ë¡¤/í‘œì‹œ
        detailContent.scrollTop = 0;
        detailPanel.classList.remove('hidden');

        // ì´ë¯¸ì§€ ë·°ì–´ ì´ˆê¸° ìƒíƒœëŠ” ìˆ¨ê¹€(ë°©ê¸ˆ í…œí”Œë¦¿ì—ì„œ hiddenìœ¼ë¡œ ë„£ì—ˆìŒ)
        // ì‹¤ì œ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ initImageViewer ì•ˆì—ì„œ ë³´ì—¬ì¤Œ
        // ëŒ€í‘œì‚¬ì§„ì€ ì¦‰ì‹œ, ë‚˜ë¨¸ì§€ëŠ” ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë¯¸ë¦¬ë¶ˆëŸ¬ì˜¤ê¸°
        if (typeof initImageViewerFast === 'function') {
            initImageViewerFast(listingId);
        }

        populateBranchInfoFor(listing);  // ë‹´ë‹¹ì ì†Œì† â†’ branch_info ë¶™ì´ê¸°

        // ê°œë³„ URL ë™ê¸°í™”
        updateURLForListing?.(listingId);
    }
    
    function updateFilterButtonText(type) {
        const min = document.getElementById(`${type}_min`)?.value;
        const max = document.getElementById(`${type}_max`)?.value;
        const btn = document.getElementById(`filter-btn-${type}`);
        if (!btn) return;

        let label = "";
        if (min && max) label = `${formatValue(type, min)}~${formatValue(type, max)}`;
        else if (min) label = `${formatValue(type, min)}~`;
        else if (max) label = `~${formatValue(type, max)}`;
        else label = btn.dataset.defaultLabel;

        btn.textContent = label;
        applyButtonStyle(btn, label !== btn.dataset.defaultLabel);
    }
    
    function showListingsInPanel(listings) {
        matchedListingsCache = listings;
        matchedListingsPage = 1;
        renderMatchedListings();
        infoPanel.classList.remove("hidden");
        infoPanel.scrollTop = 0;
    }

    function renderMatchedListings() {
        if (!Array.isArray(matchedListingsCache)) return;

        const end = matchedListingsPage * PAGE_SIZE;
        const listingsToShow = matchedListingsCache.slice(0, end);

        infoContent.innerHTML = listingsToShow.map(l => {
            const isActive = String(window.currentDetailListingId) === String(l.listing_id);
            const highlightStyle = isActive ? 'background-color: rgba(243,244,246);' : '';
            const logo = 'https://sfinbtiqlfnaaarziixu.supabase.co/storage/v1/object/public/baikuk-images-open/baikuk-simbol.png';

            return `
            <div class="mb-1 pb-1 border-b border-gray-300 text-left" style="${highlightStyle}">
                <div onclick="showDetailPanel(${l.listing_id})" class="cursor-pointer hover:bg-gray-100 transition p-2">
                <div class="flex flex-row items-center gap-3">
                    <div class="relative w-[150px] h-[120px] flex-shrink-0 thumb-box overflow-hidden rounded border">
                        <div class="absolute top-1 left-1 w-[53px] h-[22px] flex items-center justify-center text-[15px] px-1 rounded-md font-semibold z-10"
                            style="background-color:#F2C130;color:#37373d;">
                            ${l.listing_id}
                        </div>
                        <img id="thumb-${l.listing_id}" src="${logo}" alt="ì¸ë„¤ì¼"
                            class="thumb-img-contain rounded no-save" draggable="false" oncontextmenu="return false" />
                        </div>
                        <div class="flex-1 flex flex-col gap-1">
                        <div class="font-bold text-[rgb(80,152,233)] text-base">
                            ${l.deal_type} ${formatDealPrice(l)}
                        </div>
                        <div class="text-sm">
                            ì „ìš© <strong class="font-semibold">${Number(l.area_py).toFixed(1)}</strong>í‰,
                            <strong class="font-semibold">${formatFloor(l.floor, l.total_floors)}</strong>
                        </div>
                        <div class="mt-1">
                            <span class="inline-block text-[14px] text-gray-800 leading-snug">
                            ${escapeHtml(l.title || '')}
                            </span>
                        </div>
                    </div>
                </div>
                </div>
            </div>`;
        }).join('');

        const ids = listingsToShow.map(l => l.listing_id);

        // â‘  ìºì‹œì— ìˆëŠ” ì¸ë„¤ì¼ ì¦‰ì‹œ ì ìš© (ì¬ë Œë” ìˆœê°„ ë¡œê³ ë¡œ ë°”ë€ŒëŠ” í˜„ìƒ ë°©ì§€)
        applyPrimaryThumbsFromCache(ids);

        // â‘¡ ìºì‹œì— ì—†ëŠ” ê²ƒë§Œ ë¹„ë™ê¸°ë¡œ ë°œê¸‰/ì ìš©
        loadPrimaryThumbsBatch(ids).catch(console.warn);
    }



    // --- Data Fetching and Filtering ---
    function getFilterValues() {
        const values = {};
        filterDefs.forEach(def => {
            const id = def.id;
            // Map filter ID to database column name
            const colName = id === 'rent' ? 'monthly_rent' : 
                            id === 'deposit' ? 'deposit_price' :
                            id === 'sale' ? 'sale_price' : id;
            values[`${colName}_min`] = parseFloat(document.getElementById(`${id}_min`)?.value);
            values[`${colName}_max`] = parseFloat(document.getElementById(`${id}_max`)?.value);
        });
        return values;
    }

    function filterListings(listings) {
        const f = getFilterValues();
        return listings.filter(l => {
            if (!selectedDealTypes.includes(l.deal_type)) return false;
            if (selectedCategories.length > 0 && !selectedCategories.includes(l.category)) return false;
            for (const key in f) {
                const isMin = key.endsWith('_min');
                const col = key.replace(/_min|_max/, '');
                if (!isNaN(f[key])) {
                    if (isMin && l[col] < f[key]) return false;
                    if (!isMin && l[col] > f[key]) return false;
                }
            }
            return true;
        });
    }
    
    function updateFilteredListings() {
        const filtered = filterListings(Object.values(allListings));
        const markers = filtered.map(l => allMarkers[l.listing_id]).filter(Boolean);
        
        clusterer.clear();
        clusterer.addMarkers(markers);
        
        matchedListingsCache = filtered;
        matchedListingsPage = 1;
        renderMatchedListings();
        setTimeout(tryPrewarmVisibleThumbs, 0);
    }
    
    async function loadListingsInBounds() {
        if (isLoading) return;
        isLoading = true;

        const bounds = map.getBounds();
        const sw = bounds.getSouthWest();
        const ne = bounds.getNorthEast();
        const tableToQuery = 'public_baikuk_view';

        const { data, error } = await client
            .from(tableToQuery)
            .select('*')
            .gte('lat', sw.getLat())
            .lte('lat', ne.getLat())
            .gte('lng', sw.getLng())
            .lte('lng', ne.getLng())
            .limit(1000);

        isLoading = false;

        if (error) {
            return console.error("Data loading error:", error.message);
        }
        
        if (!data || data.length === 0) {
            clusterer.clear();
            infoContent.innerHTML = '<div class="p-4 text-center text-gray-500">í˜„ì¬ ì§€ë„ì— í‘œì‹œí•  ë§¤ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        data.forEach(l => {
            if (l.listing_id && !allListings[l.listing_id]) {
                allListings[l.listing_id] = l;
            }
        });

        // Create markers for newly loaded listings
        data.forEach(l => {
            if (l.lat && l.lng && !allMarkers[l.listing_id]) {
                const marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(l.lat, l.lng),
                    image: customImage
                });
                marker.listing_id = l.listing_id;
                allMarkers[l.listing_id] = marker;
            }
        });
        
        const level = map.getLevel();
        let gridSize = 50;
        if (level <= 2) gridSize = 10;
        else if (level === 3) gridSize = 30;
        else if (level === 4) gridSize = 40;
        
        createClusterer(gridSize);
        updateFilteredListings();
    }
    
    function resetFilters() {
        filterDefs.forEach(def => {
            document.getElementById(`${def.id}_min`).value = "";
            document.getElementById(`${def.id}_max`).value = "";
            updateFilterButtonText(def.id);
        });
        selectedCategories = ['ìƒê°€'];
        selectedDealTypes = ['ì›”ì„¸'];
        renderDealAndCategoryButtons();
        updateFilteredListings();
    }

    function toggleFilterPanel(type) {
        document.querySelectorAll('[id^="filter-panel-"]').forEach(panel => {
            if (panel.id === `filter-panel-${type}`) {
                panel.classList.toggle('hidden');
            } else {
                panel.classList.add('hidden');
            }
        });
    }

    // --- Auth Functions ---
    const showHide = (id, show) => document.getElementById(id).classList.toggle('hidden', !show);
    const showLogin = () => showHide('login-modal', true);
    const hideLogin = () => showHide('login-modal', false);
    const showLoadingOverlay = () => showHide('loading-overlay', true);
    const hideLoadingOverlay = () => showHide('loading-overlay', false);

    async function login() {
        showLoadingOverlay();

        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value.trim();
        const errorDiv = document.getElementById('login-error');

        try {
            // 1) ë¡œê·¸ì¸
            const { data, error } = await client.auth.signInWithPassword({ email, password });
            if (error) throw error;

            // 2) í˜„ì¬ ì„¸ì…˜ì„ í—ˆìš© ëª©ë¡ì— ë“±ë¡ (ìµœì‹  Nê°œë§Œ ìœ ì§€: í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ì •ë¦¬ë¨)
            //    device_label/uaëŠ” ìš´ì˜ì— í¸í•œ ìˆ˜ì¤€ìœ¼ë¡œë§Œ ë„˜ê²¨ë„ ë©ë‹ˆë‹¤.
            await client.rpc('register_session', {
            device_label: (navigator.platform + ' ' + (navigator.vendor || '')).trim(),
            user_agent: navigator.userAgent
            });

            // (ì„ íƒ) 3) ì˜ˆë°©ì  ì²´í¬: ì´ ì„¸ì…˜ì´ ì‹¤ì œ í—ˆìš© ìƒíƒœì¸ì§€ í™•ì¸
            // register_sessionì´ ì˜¤ë˜ëœ ì„¸ì…˜ì„ ì •ë¦¬í•˜ë¯€ë¡œ ë³´í†µ trueê°€ ë‚˜ì˜µë‹ˆë‹¤.
            const { data: allowed } = await client.rpc('is_session_allowed');
            if (allowed === false) {
            await client.auth.signOut();
            throw new Error('í—ˆìš©ëœ ê¸°ê¸° ìˆ˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ë¡œê·¸ì•„ì›ƒ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
            }

            // 4) ì´ë™
            window.location.href = '/admin';
        } catch (e) {
            // ì˜¤ë¥˜ ì²˜ë¦¬
            errorDiv.textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + (e?.message || e);
            showHide('login-error', true);
        } finally {
            hideLoadingOverlay();
        }
    }


    async function logout() {
        await client.auth.signOut();
        window.location.reload();
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', async () => {
        renderDealAndCategoryButtons();
        renderFilterButtons();

        const { data: { session } } = await client.auth.getSession();
        isLoggedIn = !!session;
        if (isLoggedIn) document.getElementById('logout-btn')?.classList.remove('hidden');

        window.isLoggedIn = !!session;
        if (window.isLoggedIn) document.getElementById('logout-btn')?.classList.remove('hidden');

        const deepId = getListingIdFromURL();

        // ë¡œê·¸ì¸ë˜ì–´ ìˆê³  ?id= ê°€ ìˆìœ¼ë©´ admin.htmlë¡œ ë„˜ê¹€
        if (window.isLoggedIn && deepId) {
            location.replace(`admin.html?id=${deepId}`);
            return;
        }

        await loadListingsInBounds();
        // ğŸ‘‡ ì²« ë¡œë“œ ì§í›„ í•œ ë²ˆ ì˜ˆì—´
        {
            const idsForWarm = Object.values(allListings).slice(0, 500).map(l => l.listing_id);
            ensureThumbsReady(idsForWarm, { timeout: 1000 }).catch(() => {});
        }

        window.renderDealFields?.();

        if (deepId) await openDeepLink(deepId);
        else {
            const listing = allListings?.[window.currentDetailListingId];
            if (listing && typeof renderDealFieldsViewer === 'function') {
            renderDealFieldsViewer(listing);
            }
        }

        // â–¼ ìš°í´ë¦­/ë“œë˜ê·¸ ë°©ì§€: ì¸í¬íŒ¨ë„ ì¸ë„¤ì¼ + ìƒì„¸ 2ì¥ë§Œ
        const protectSelector = '#info-content img.no-save, #image-viewer img.no-save';
        document.addEventListener('contextmenu', (e) => {
            if (e.target.closest(protectSelector)) e.preventDefault();
        });
        document.addEventListener('dragstart', (e) => {
            if (e.target.closest(protectSelector)) e.preventDefault();
        });
    });

    kakao.maps.event.addListener(map, 'idle', () => {
        clearTimeout(mapIdleTimer);
        mapIdleTimer = setTimeout(async () => {
            const before = Object.keys(allListings).length;
            await loadListingsInBounds();       // ìƒˆë¡œ ë³´ì´ëŠ” ë²”ìœ„ ë¡œë“œ
            const after = Object.keys(allListings).length;

            // ìƒˆë¡œ ë¡œë“œí–ˆë“  ì•ˆ í–ˆë“ , í˜„ì¬ ë³´ì´ëŠ”/í•„í„°ëœ ê²ƒ ìœ„ì£¼ë¡œ ì˜ˆì—´
            tryPrewarmVisibleThumbs();
        }, 200);
    });

    kakao.maps.event.addListener(map, 'click', hideDetailPanel);

    document.getElementById('btn-zoom-in').onclick = () => map.setLevel(map.getLevel() - 1);
    document.getElementById('btn-zoom-out').onclick = () => map.setLevel(map.getLevel() + 1);
    
    document.getElementById('btn-current-location').onclick = () => {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                map.setCenter(new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude));
            });
        }
    };
    
    document.getElementById('btn-naver-map').onclick = function () {
        let lat, lng;
        const listing = allListings[window.currentDetailListingId];
        
        if (listing && !detailPanel.classList.contains('hidden')) {
            lat = listing.lat;
            lng = listing.lng;
        } else {
            const center = map.getCenter();
            lat = center.getLat();
            lng = center.getLng();
        }
        window.open(`https://map.naver.com/v5/?c=${lng},${lat},17,0,0,0,d`, '_blank');
    };

    infoPanel.addEventListener('scroll', function () {
        if (this.scrollTop + this.clientHeight >= this.scrollHeight - 50) {
            if (matchedListingsPage * PAGE_SIZE < matchedListingsCache.length) {
                matchedListingsPage++;
                renderMatchedListings();
            }
        }
    });

    window.resetFilters = resetFilters;

    // ì‚¬ì§„ë„£ëŠ”ë¶€ë¶„

    /* ---------- ì›Œí„°ë§ˆí¬ PNG ê²½ë¡œ ---------- */
    async function getWatermarkUrl() {
        const bucket = window.WATERMARK_BUCKET || BUCKET;
        const rawPrefix = (window.WATERMARK_PREFIX ?? '').toString().trim();
        const prefix = rawPrefix.replace(/^\/+|\/+$/g, '');
        const fname  = window.WATERMARK_FILE || 'baikuk-logo-warter-mark.png';
        const path   = prefix ? `${prefix}/${fname}` : fname;

        if (window.WATERMARK_BUCKET_IS_PUBLIC !== false) {
            const { data } = client.storage.from(bucket).getPublicUrl(path);
            return data.publicUrl;
        } else {
            const { data } = await client.storage.from(bucket).createSignedUrl(path, 3600);
            return data?.signedUrl;
        }
    }

    /* ---------- íŒì—… ë¼ì´íŠ¸ê°¤ëŸ¬ë¦¬ (ë‹«ê¸°/ì›Œí„°ë§ˆí¬ í¬í•¨) ---------- */
    function openExternalViewer(items, startIndex = 0, pageTitle = 'ì´ë¯¸ì§€ ë³´ê¸°', listingId = '', watermarkUrl = '') {
        const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
        const html = `<!doctype html>
        <html lang="ko"><head>
        <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
        <title>${esc(pageTitle)}</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lightgallery.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lg-zoom.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lg-thumbnail.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery/css/lg-fullscreen.css">
        <style>
            body{margin:0;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;}
            #gallery{padding:8px;}
            .lg-wm-white{
                position:fixed; inset:0; pointer-events:none; user-select:none;
                opacity:.40; background:#fff; z-index:2147483647;
                -webkit-mask-repeat:no-repeat; mask-repeat:no-repeat;
                -webkit-mask-position:center; mask-position:center;
            }
            /* íŒì—…(ë¼ì´íŠ¸ê°¤ëŸ¬ë¦¬) ì „ì²´í™”ë©´ì—ì„œ ì €ì¥/ë¡±íƒ­/ë“œë˜ê·¸ ìµœì†Œí™” */
            html, body {
                -webkit-user-select: none;
                user-select: none;
                -webkit-touch-callout: none;
            }
            .lg-outer img, .lg-thumb-outer img {
                -webkit-user-drag: none;
            }
        </style></head>
        <body><div id="gallery"></div>
        <script>
        function loadScript(src){return new Promise(r=>{const s=document.createElement('script');s.src=src;s.onload=r;document.head.appendChild(s);});}
        window.__ITEMS__=${JSON.stringify(items)};
        window.__START__=${Number(startIndex)};
        window.__WM_URL__=${JSON.stringify(watermarkUrl||'')};

        const WM_RATIO_NORMAL = 0.55;
        const WM_RATIO_FS = 2.2;
        const WM_MIN = 400, WM_MAX = 6000;

        function isFS(){return !!(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement||
            document.querySelector('.lg-fullscreen-on')||document.querySelector('.lg-outer.lg-fullscreen'));}

        function addWM(){
            let wm = document.querySelector('.lg-wm-white');
            if(!wm){
                wm = document.createElement('div');
                wm.className = 'lg-wm-white';
                document.body.appendChild(wm);   // â† í•µì‹¬: bodyì— ê³ ì • ë¶€ì°©
            }

            if(!window.__WM_URL__){
                wm.style.webkitMaskImage = 'none';
                wm.style.maskImage = 'none';
                return;
            }

            // í˜„ì¬ ë³´ì´ëŠ” ìŠ¬ë¼ì´ë“œì˜ ì´ë¯¸ì§€ ê°€ë¡œí­ìœ¼ë¡œ ì›Œí„°ë§ˆí¬ í¬ê¸° ì‚°ì •
            const img = document.querySelector('.lg-current .lg-image');
            let w = img ? img.getBoundingClientRect().width : window.innerWidth;
            const ratio = isFS() ? WM_RATIO_FS : WM_RATIO_NORMAL;
            const targetW = Math.max(WM_MIN, Math.min(w * ratio, WM_MAX));

            wm.style.webkitMaskImage = 'url(' + window.__WM_URL__ + ')';
            wm.style.maskImage = 'url(' + window.__WM_URL__ + ')';
            wm.style.webkitMaskSize = targetW + 'px auto';
            wm.style.maskSize = targetW + 'px auto';
        }

        (async()=>{
            await loadScript('https://cdn.jsdelivr.net/npm/lightgallery/lightgallery.umd.js');
            await loadScript('https://cdn.jsdelivr.net/npm/lightgallery/plugins/zoom/lg-zoom.umd.js');
            await loadScript('https://cdn.jsdelivr.net/npm/lightgallery/plugins/thumbnail/lg-thumbnail.umd.js');
            await loadScript('https://cdn.jsdelivr.net/npm/lightgallery/plugins/fullscreen/lg-fullscreen.umd.js');

            const dynamicEl = (window.__ITEMS__||[]).map(it=>({src: it.display, thumb: it.thumb, subHtml: it.caption}));
            const index = Math.max(0, Math.min(window.__START__||0, Math.max(0, dynamicEl.length-1)));
            
            const lg = lightGallery(document.getElementById('gallery'), {
            dynamic:true, dynamicEl, index,
            plugins:[lgZoom, lgThumbnail, lgFullscreen], download:false
            });
            lg.openGallery(index);

            // íŒì—… ì „ì²´ì—ì„œ ìš°í´ë¦­/ë“œë˜ê·¸ ë°©ì§€ (ë¼ì´íŠ¸ê°¤ëŸ¬ë¦¬ ì˜ì—­ í•œì •)
            const protectCtx = (e) => {
                // ë¼ì´íŠ¸ê°¤ëŸ¬ë¦¬ ë°”ê¹¥ì€ í†µê³¼, ì•ˆìª½ë§Œ ì°¨ë‹¨
                if (e.target.closest('.lg-outer')) e.preventDefault();
            };
            document.addEventListener('contextmenu', protectCtx, { capture: true });
            document.addEventListener('dragstart', protectCtx, { capture: true });

            // Ctrl+S, Command+S ì €ì¥ ë‹¨ì¶•í‚¤ ë°©ì§€
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
                    e.preventDefault();
                    e.stopPropagation();
                }
            }, true);

            // âœ… ì˜¤í”ˆ ì§í›„ ì¦‰ì‹œ 1íšŒ ì ìš©
            const ensure = () => requestAnimationFrame(addWM);
            ensure();

            ['lgAfterOpen','lgAfterSlide','lgResize','lgContainerResize','lgFullscreenChange']
            .forEach(ev => lg.on(ev, ensure));

            document.addEventListener('fullscreenchange', ensure);
            window.addEventListener('resize', ensure);
        })();
        <\/script></body></html>`;

        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const w = window.open(url, `img-${listingId||'viewer'}`, 'popup=yes,width=1280,height=800,menubar=no,toolbar=no,location=no,status=no,scrollbars=yes,resizable=yes');
        if(!w){ alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.'); URL.revokeObjectURL(url); return; }
        w.focus();
        setTimeout(() => URL.revokeObjectURL(url), 10000);
    }

    // ì¸í¬íŒ¨ë„ì—ë„ ì‚¬ì§„í‘œì‹œ ê´€ë ¨
    // === ì¸ë„¤ì¼ ìºì‹œ (listingId -> signed URL) ===
    const primaryThumbCache = new Map();

    // ìºì‹œëœ ì¸ë„¤ì¼ì„ DOMì— ë°˜ì˜(ë§Œë£Œ ì„ë°•ì‹œ ìë™ ê°±ì‹ )
    async function applyPrimaryThumbsFromCache(listingIds) {
        for (const id of listingIds) {
            const el = document.getElementById(`thumb-${id}`);
            if (!el) continue;
            const cached = primaryThumbCache.get(String(id));
            if (cached?.url && cached?.expireAt && (cached.expireAt - Date.now()) > TTL_SKEW_MS) {
            if (el.src !== cached.url) el.src = cached.url;
            } else {
            // ë§Œë£Œ ì„ë°• ë˜ëŠ” ì—†ìŒ â†’ ì¬ë°œê¸‰
            const row = _firstByListing.get(String(id)); // ì•„ë˜ loadPrimaryThumbsBatchê°€ ì±„ì›€
            if (row?.path) {
                const url = await signThumb(row.path, 240).catch(()=> '');
                if (url) {
                primaryThumbCache.set(String(id), { url, expireAt: Date.now() + TTL_THUMB_SEC*1000 });
                if (el.src !== url) el.src = url;
                }
            }
            }
        }
    }

    // ì¡°íšŒ ê²°ê³¼ë¥¼ ì¬ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì„ì‹œ ë§µ
    let _firstByListing = new Map();

    async function loadPrimaryThumbsBatch(listingIds) {
        const ids = listingIds.map(String);
        // ì¦‰ì‹œ ë°˜ì˜(ìˆìœ¼ë©´)
        await applyPrimaryThumbsFromCache(ids);

        // ì•„ì§ ëŒ€í‘œí–‰ì„ ëª¨ë¥´ë©´ ì§ˆì˜(í•œ ë²ˆë§Œ)
        if (!ids.some(id => !_firstByListing.has(id))) {
            // ëª¨ë‘ ê°–ê³  ìˆìœ¼ë©´ ë„˜ì–´ê°
        } else {
            const { data, error } = await client
            .from('listing_images')
            .select('listing_id, path, is_primary, order_index')
            .in('listing_id', ids)
            .eq('is_private', false)
            .order('is_primary', { ascending: false })
            .order('order_index', { ascending: true });

            if (error) { console.warn('ëŒ€í‘œì‚¬ì§„ ì¡°íšŒ ì‹¤íŒ¨:', error); return; }

            _firstByListing = new Map(_firstByListing); // ìƒˆ ë§µ ë³µì‚¬
            for (const row of (data||[])) {
            const id = String(row.listing_id);
            if (!_firstByListing.has(id)) _firstByListing.set(id, row);
            }
        }

        // ì¸ë„¤ì¼ URL ë°œê¸‰/ê°±ì‹ 
        for (const id of ids) {
            const row = _firstByListing.get(id);
            if (!row?.path) { primaryThumbCache.set(id, { url:'', expireAt: 0 }); continue; }
            const cached = primaryThumbCache.get(id);
            if (!cached?.url || (cached.expireAt - Date.now()) <= TTL_SKEW_MS) {
            const url = await signThumb(row.path, 240).catch(()=> '');
            primaryThumbCache.set(id, { url: url || '', expireAt: Date.now() + TTL_THUMB_SEC*1000 });
            }
        }

        // ìµœì¢… DOM ë°˜ì˜
        const els = ids.map(id => document.getElementById(`thumb-${id}`)).filter(Boolean);
        for (const id of ids) {
            const el = document.getElementById(`thumb-${id}`);
            const cached = primaryThumbCache.get(id);
            if (el && cached?.url && el.src !== cached.url) el.src = cached.url;
        }
    }

    // -------- ìƒì„¸íŒ¨ë„: ëŒ€í‘œ 1ì¥ ì¦‰ì‹œ ë¡œë“œ + ë‚˜ë¨¸ì§€ ë¯¸ë¦¬ë¶ˆëŸ¬ì˜¤ê¸° --------
    async function initImageViewerFast(listingId) {
        const slot = document.getElementById('image-viewer-slot');
        if (!slot || !listingId) return;

        // ìƒˆ ìš”ì²­ í† í°
        const myToken = ++_imgReqToken;

        // 0) ì¼ë‹¨ ë¹„ì›€(ì´ì „ ë·°ì–´ ì œê±°)
        slot.innerHTML = '';

        // 1) ëª©ë¡ë§Œ ë¹ ë¥´ê²Œ ì¡°íšŒ
        const { data: rows, error } = await client
            .from('listing_images')
            .select('path, caption, order_index, is_primary')
            .eq('listing_id', String(listingId))
            .eq('is_private', false)
            .order('is_primary', { ascending: false })
            .order('order_index', { ascending: true });

        // ì¤‘ê°„ì— ë‹¤ë¥¸ ë§¤ë¬¼ë¡œ ë°”ë€Œì—ˆìœ¼ë©´ ì¤‘ë‹¨
        if (myToken !== _imgReqToken) return;

        if (error || !rows?.length) {
            // ì‚¬ì§„ ì—†ìœ¼ë©´ ì•„ë¬´ê²ƒë„ ë Œë”í•˜ì§€ ì•ŠìŒ(ë²ˆì©ì„ ì—†ìŒ)
            return;
        }

        // 2) ì»¨í…Œì´ë„ˆë¥¼ ì•„ì§ DOMì— ë¶™ì´ì§€ ë§ê³  ë©”ëª¨ë¦¬ì—ì„œ êµ¬ì„±
        const wrap = document.createElement('div');
        wrap.id = 'image-viewer';
        wrap.className = 'bg-white';         // hidden ëŒ€ì‹ , ì²˜ìŒì—” ì•„ì˜ˆ ë¶™ì´ì§€ ì•ŠìŒ
        wrap.style.display = 'none';          // ì²« ì´ë¯¸ì§€ decode ëë‚œ ë’¤ ë³´ì´ê²Œ

        wrap.innerHTML = `
            <div class="flex gap-2"><div class="relative overflow-hidden w-1/2 h-[11rem] rounded bg-gray-100 thumb-box"> <img id="image-viewer-main-0" class="thumb-img-cover cursor-pointer no-save" alt="" draggable="false" oncontextmenu="return false" />
                <div id="wm-ov-0" class="wm-white" style="display:none"></div>
            </div><div class="relative overflow-hidden w-1/2 h-[11rem] rounded bg-gray-100 thumb-box"> <img id="image-viewer-main-1" class="thumb-img-cover cursor-pointer no-save hidden" alt="" draggable="false" oncontextmenu="return false" />
                <div id="wm-ov-1" class="wm-white" style="display:none"></div>
            </div> </div>`;

        const img0 = wrap.querySelector('#image-viewer-main-0');
        const img1 = wrap.querySelector('#image-viewer-main-1');
        const ov0  = wrap.querySelector('#wm-ov-0');
        const ov1  = wrap.querySelector('#wm-ov-1');

        const listing = allListings?.[String(listingId)];
        const pageTitle = (listing?.listing_title || listing?.title || `ë§¤ë¬¼ ${listingId} ì´ë¯¸ì§€`).trim();

        // 3) ëŒ€í‘œ 1ì¥ URL ë¨¼ì € ë°œê¸‰
        const first = rows[0];
        const firstUrl = await signDisplay(first.path, 900).catch(()=>'');

        // ì¤‘ê°„ì— ë‹¤ë¥¸ ë§¤ë¬¼ë¡œ ë°”ë€Œì—ˆìœ¼ë©´ ì¤‘ë‹¨
        if (myToken !== _imgReqToken) return;

        // 4) ì²« ì´ë¯¸ì§€ decodeê°€ ëë‚œ ë’¤ì—ë§Œ DOMì— ì‚½ì… -> "í•˜ì–€ ìƒì" ê¹œë¹¡ì„ ì œê±°
        if (firstUrl) {
            img0.src = firstUrl;
            try {
            if (img0.decode) await img0.decode();
            } catch (_) {}

            // ì›Œí„°ë§ˆí¬(ì²« ì¥)
            getWatermarkUrl().then(wm => {
            if (myToken !== _imgReqToken) return;
            if (!wm) return;
            ov0.style.webkitMaskImage = `url('${wm}')`;
            ov0.style.maskImage = `url('${wm}')`;
            ov0.style.display = 'block';
            });

            // ì´ì œì•¼ slotì— í•œ ë²ˆì— ì‚½ì… + í‘œì‹œ
            slot.appendChild(wrap);
            wrap.style.display = ''; // ë³´ì´ê¸°
        } else {
            // ëŒ€í‘œ URL ë°œê¸‰ ì‹¤íŒ¨ ì‹œ, ì•„ì˜ˆ ë·°ì–´ë¥¼ ë§Œë“¤ì§€ ì•ŠìŒ
            return;
        }

        // 5) ë‚˜ë¨¸ì§€ ì „ë¶€ ë³‘ë ¬ ë¯¸ë¦¬ ì¤€ë¹„
        (async () => {
            const items = await Promise.all(rows.map(async (r) => {
            const [display, thumb, full] = await Promise.all([
                signDisplay(r.path, 900),
                signThumb(r.path, 220),
                signOriginal(r.path),
            ]);
            return { display, thumb, full, caption: r.caption || '' };
            })).catch(()=>[]);

            if (myToken !== _imgReqToken) return;

            // ë‘ ë²ˆì§¸ ì¹¸ ì±„ìš°ê¸°
            if (rows[1] && img1) {
            img1.classList.remove('hidden');
            img1.src = items[1]?.display || '';
            getWatermarkUrl().then(wm => {
                if (myToken !== _imgReqToken) return;
                if (wm) {
                ov1.style.webkitMaskImage = `url('${wm}')`;
                ov1.style.maskImage = `url('${wm}')`;
                ov1.style.display = 'block';
                }
            });
            }

            // íŒì—… ê°¤ëŸ¬ë¦¬ ì˜¤í”ˆ (items ì¤€ë¹„ë¨)
            const wmUrl = await getWatermarkUrl().catch(()=> '');
            const openAt = (i) => openExternalViewer(items, i, pageTitle, listingId, wmUrl);
            img0.onclick = () => openAt(0);
            if (!img1.classList.contains('hidden')) img1.onclick = () => openAt(1);
        })();
        }

        // íŒ¨ë„ ë‹«ì„ ë•Œ ìŠ¬ë¡¯ë„ ë¹„ì›Œ ë ˆê±°ì‹œ ì”ìƒ ë°©ì§€
        function hideDetailPanel() {
        const detailPanel = document.getElementById('detail-panel');
        detailPanel.classList.add('hidden');
        window.currentDetailListingId = null;
        renderMatchedListings();
        document.querySelectorAll('[id^="filter-panel-"]').forEach(p => p.classList.add('hidden'));
        const slot = document.getElementById('image-viewer-slot');
        if (slot) slot.innerHTML = '';
        updateURLForListing(null);
    }

    // --- ë¦¬ë””ë ‰íŠ¸ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ(ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ â†’ ëª¨ë‹¬ ì—´ê¸°) ---
    (function showAuthRedirectMessage() {
        try {
            const msg = sessionStorage.getItem('auth_msg');
            if (msg) {
            sessionStorage.removeItem('auth_msg');
            const errorDiv = document.getElementById('login-error');
            if (errorDiv) {
                errorDiv.textContent = msg;
                errorDiv.classList.remove('hidden');
            }
            // ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ ëª¨ë‹¬ ì—´ê¸°
            if (typeof showLogin === 'function') showLogin();
            }
        } catch (_) {}
    })();

    setInterval(async () => {
        if (document.hidden) return; // íƒ­ ë¹„í™œì„±í™” ì‹œ ìŠ¤í‚µ

        // (ê¸°ì¡´ ì¸ë„¤ì¼/ìƒì„¸ ê°±ì‹  ë¡œì§ ê·¸ëŒ€ë¡œ)
        const thumbs = document.querySelectorAll('#info-content img[id^="thumb-"]');
        for (const img of thumbs) {
            const id = img.id.replace('thumb-','');
            const cached = primaryThumbCache.get(String(id));
            if (!cached) continue;
            if ((cached.expireAt - Date.now()) <= TTL_SKEW_MS) {
                await applyPrimaryThumbsFromCache([id]);
            }
        }

        const mains = ['image-viewer-main-0','image-viewer-main-1']
            .map(id => document.getElementById(id)).filter(Boolean);
        for (const img of mains) {
            if (!img.src) continue;
            const currentId = window.currentDetailListingId && String(window.currentDetailListingId);
            if (!currentId) continue;
            try { await initImageViewerFast(currentId); } catch(e) {}
            break;
        }
    }, 180_000);

  </script>
</body>
</html>